<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/"><channel><title>Database on Daemon365</title><link>https://daemon365.dev/categories/database/</link><description>Don't let yourself stop.</description><generator>Hugo -- gohugo.io</generator><language>zh-cn</language><lastBuildDate>Sun, 20 Aug 2023 00:00:00 +0800</lastBuildDate><atom:link href="https://daemon365.dev/categories/database/index.xml" rel="self" type="application/rss+xml"/><item><title>redis主从同步</title><link>https://daemon365.dev/post/database/redis_master_slave_synchronization/</link><pubDate>Sun, 20 Aug 2023 00:00:00 +0800</pubDate><guid>https://daemon365.dev/post/database/redis_master_slave_synchronization/</guid><description>&lt;h2 id="redis主从同步"&gt;redis主从同步&lt;/h2&gt;
&lt;p&gt;&lt;img src="https://daemon365.dev/images/a9aeda50-50ab-4fe3-b94c-572cadf14613.png" alt=""&gt;&lt;/p&gt;
&lt;p&gt;原理：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;从服务器向主服务器发送 SYNC 命令。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;接到 SYNC 命令的主服务器会调用BGSAVE 命令，创建一个 RDB 文件，并使用缓冲区记录接下来执行的所有写命令。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;当主服务器执行完 BGSAVE 命令时，它会向从服务器发送 RDB 文件，而从服务器则会接收并载入这个文件。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;主服务器将缓冲区储存的所有写命令发送给从服务器执行。&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;- 1、在开启主从复制的时候，使用的是RDB方式的，同步主从数据的 2、同步开始之后，通过主库命令传播的方式，主动的复制方式实现 3、2.8以后实现PSYNC的机制，实现断线重连&lt;/p&gt;
&lt;h2 id="环境准备"&gt;环境准备&lt;/h2&gt;
&lt;p&gt;6380.conf&lt;/p&gt;
&lt;pre tabindex="0"&gt;&lt;code&gt;1、环境： 准备两个或两个以上redis实例 mkdir /data/638{0..2} #创建6380 6381 6382文件夹 配置文件示例： vim /data/6380/redis.conf port 6380 daemonize yes pidfile /data/6380/redis.pid loglevel notice logfile &amp;#34;/data/6380/redis.log&amp;#34; dbfilename dump.rdb dir /data/6380 protected-mode no
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;6381.conf&lt;/p&gt;
&lt;pre tabindex="0"&gt;&lt;code&gt;vim /data/6381/redis.conf port 6381 daemonize yes pidfile /data/6381/redis.pid loglevel notice logfile &amp;#34;/data/6381/redis.log&amp;#34; dbfilename dump.rdb dir /data/6381 protected-mode no
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;6382.conf&lt;/p&gt;
&lt;pre tabindex="0"&gt;&lt;code&gt;port 6382 daemonize yes pidfile /data/6382/redis.pid loglevel notice logfile &amp;#34;/data/6382/redis.log&amp;#34; dbfilename dump.rdb dir /data/6382 protected-mode no
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;启动三个redis实例&lt;/p&gt;</description><content:encoded><![CDATA[<h2 id="redis主从同步">redis主从同步</h2>
<p><img src="/images/a9aeda50-50ab-4fe3-b94c-572cadf14613.png" alt=""></p>
<p>原理：</p>
<ol>
<li>
<p>从服务器向主服务器发送 SYNC 命令。</p>
</li>
<li>
<p>接到 SYNC 命令的主服务器会调用BGSAVE 命令，创建一个 RDB 文件，并使用缓冲区记录接下来执行的所有写命令。</p>
</li>
<li>
<p>当主服务器执行完 BGSAVE 命令时，它会向从服务器发送 RDB 文件，而从服务器则会接收并载入这个文件。</p>
</li>
<li>
<p>主服务器将缓冲区储存的所有写命令发送给从服务器执行。</p>
</li>
</ol>
<p>&mdash;&mdash;&mdash;&mdash;- 1、在开启主从复制的时候，使用的是RDB方式的，同步主从数据的 2、同步开始之后，通过主库命令传播的方式，主动的复制方式实现 3、2.8以后实现PSYNC的机制，实现断线重连</p>
<h2 id="环境准备">环境准备</h2>
<p>6380.conf</p>
<pre tabindex="0"><code>1、环境： 准备两个或两个以上redis实例  mkdir /data/638{0..2} #创建6380 6381 6382文件夹  配置文件示例： vim   /data/6380/redis.conf port 6380 daemonize yes pidfile /data/6380/redis.pid loglevel notice logfile &#34;/data/6380/redis.log&#34; dbfilename dump.rdb dir /data/6380 protected-mode no
</code></pre><p>6381.conf</p>
<pre tabindex="0"><code>vim   /data/6381/redis.conf port 6381 daemonize yes pidfile /data/6381/redis.pid loglevel notice logfile &#34;/data/6381/redis.log&#34; dbfilename dump.rdb dir /data/6381 protected-mode no
</code></pre><p>6382.conf</p>
<pre tabindex="0"><code>port 6382 daemonize yes pidfile /data/6382/redis.pid loglevel notice logfile &#34;/data/6382/redis.log&#34; dbfilename dump.rdb dir /data/6382 protected-mode no
</code></pre><p>启动三个redis实例</p>
<pre tabindex="0"><code>redis-server /data/6380/redis.conf redis-server /data/6381/redis.conf redis-server /data/6382/redis.conf
</code></pre><p>主从规划</p>
<pre tabindex="0"><code>主节点：6380 从节点：6381、6382
</code></pre><h2 id="配置主从同步">配置主从同步</h2>
<p>6381/6382命令行</p>
<p>redis-cli -p 6381 SLAVEOF 127.0.0.1 6380 #指明主的地址</p>
<p>redis-cli -p 6382 SLAVEOF 127.0.0.1 6380 #指明主的地址</p>
<p>检查主从状态</p>
<p>从库：</p>
<pre tabindex="0"><code>127.0.0.1:6382&gt; info replication 127.0.0.1:6381&gt; info replication
</code></pre><p>主库：</p>
<pre tabindex="0"><code>127.0.0.1:6380&gt; info replication
</code></pre><h2 id="测试写入数据主库写入数据检查从库数据">测试写入数据，主库写入数据，检查从库数据</h2>
<pre tabindex="0"><code>主 127.0.0.1:6380&gt; set name chaoge   从 127.0.0.1:6381&gt;get name 
</code></pre><h2 id="手动进行主从复制故障切换">手动进行主从复制故障切换</h2>
<pre tabindex="0"><code>#关闭主库6380redis-cli -p 6380 shutdown
</code></pre><p>检查从库主从信息，此时master_link_status:down</p>
<pre tabindex="0"><code>redis-cli -p 6381 info replication redis-cli -p 6382 info replication
</code></pre><p><strong>既然主库挂了，我想要在6381 6382之间选一个新的主库</strong></p>
<p><strong>1.关闭6381的从库身份</strong></p>
<pre tabindex="0"><code>redis-cli -p 6381 info replication slaveof no one
</code></pre><p><strong>2.将6382设为6381的从库</strong></p>
<pre tabindex="0"><code>6382连接到6381： [root@db03 ~]## redis-cli -p 6382 127.0.0.1:6382&gt; SLAVEOF no one 127.0.0.1:6382&gt; SLAVEOF 127.0.0.1 6381
</code></pre><p>3.检查6382，6381的主从信息</p>
]]></content:encoded><category>database</category><category>redis</category></item><item><title>RabbitMQ消息队列</title><link>https://daemon365.dev/post/database/rabbitmq_message_queue/</link><pubDate>Sat, 20 May 2023 00:00:00 +0800</pubDate><guid>https://daemon365.dev/post/database/rabbitmq_message_queue/</guid><description>&lt;h2 id="消息队列"&gt;消息队列&lt;/h2&gt;
&lt;p&gt;本篇文章主要介绍了 RabbitMQ 这种消息队列，从消息队列的概念、应用场景、安装方式到它的核心概念、五种工作模式。在安装的时候推荐使用 Docker 方式进行安装。重点需要理解的就是消息队列的应用场景、核心概念和 RabbitMQ 的五种工作模式，其中用的比较多的就是发布订阅模式、主题模式。&lt;/p&gt;
&lt;p&gt;队列 (Queue) 是一种常见的数据结构，其最大的特性就是先进先出(Firist In First Out)，作为最基础的数据结构，队列应用很广泛，比如我们熟知的 Redis 基础数据类型 List，其底层数据结构就是队列。&lt;/p&gt;
&lt;p&gt;消息队列 (Messaeg Queue) 是一种使用队列 (Queue) 作为底层存储数据结构，可用于解决不同进程与应用之间通讯的分布式消息容器，也称为消息中间件。&lt;/p&gt;
&lt;p&gt;目前使用得比较多的消息队列有 ActiveMQ，RabbitMQ，Kafka，RocketMQ 等。本文主要讲述的是 RabbitMQ，RabbitMQ 是用 Erlang 语言开发的一个实现了 AMQP 协议的消息队列服务器，相比其他同类型的消息队列，最大的特点在保证可观的单机吞吐量的同时，延时方面非常出色。&lt;/p&gt;
&lt;p&gt;RabbitMQ 支持多种客户端，比如：GO、Python、Ruby、.NET、Java、JMS、C、PHP、ActionScript、XMPP、STOMP 等。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;AMQP，即 Advanced Message Queuing Protocol，高级消息队列协议，是应用层协议的一个开放标准，为面向消息的中间件设计，它是一种应用程序之间的通信方法，消息队列在分布式系统开发中应用非常广泛。这里是 AMQP 官网 &lt;a href="https://amqp.org/"&gt;amqp.org&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;消息队列使用广泛，其应用场景有很多，下面我们列举比较常见的四个场景：&lt;/p&gt;
&lt;h3 id="1消息通讯"&gt;1、消息通讯&lt;/h3&gt;
&lt;p&gt;消息队列最主要功能收发消息，其内部有高效的通讯机制，因此非常适合用于消息通讯。&lt;/p&gt;
&lt;p&gt;我们可以基于消息队列开发点对点聊天系统，也可以开发广播系统，用于将消息广播给大量接收者。&lt;/p&gt;
&lt;h3 id="2异步处理"&gt;2、异步处理&lt;/h3&gt;
&lt;p&gt;一般我们写的程序都是顺序执行 (同步执行)，比如一个用户注册函数，其执行顺序如下：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;1、写入用户注册数据。&lt;/li&gt;
&lt;li&gt;2、发送注册邮件。&lt;/li&gt;
&lt;li&gt;3、发送注册成功的短信通知。&lt;/li&gt;
&lt;li&gt;4、更新统计数据。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;按照上面的执行顺序，要全部执行完毕，才能返回成功，但其实在第 1 步执行成功后，其他的步骤完全可以异步执行，我们可以将后面的逻辑发给消息队列，再由其他程序异步执行。使用消息队列进行异步处理，可以更快地返回结果，加快服务器的响应速度，提升了服务器的性能。&lt;/p&gt;
&lt;h3 id="3服务解耦"&gt;3、服务解耦&lt;/h3&gt;
&lt;p&gt;在我们的系统中，应用与应用之间的通讯是很常见的，一般我们应用之间直接调用，比如说应用 A 调用应用 B 的接口，这时候应用之间的关系是强耦合的。&lt;/p&gt;
&lt;p&gt;如果应用 B 处于不可用的状态，那么应用 A 也会受影响。&lt;/p&gt;
&lt;p&gt;在应用 A 与应用 B 之间引入消息队列进行服务解耦，如果应用 B 挂掉，也不会影响应用 A 的使用。&lt;/p&gt;</description><content:encoded><![CDATA[<h2 id="消息队列">消息队列</h2>
<p>本篇文章主要介绍了 RabbitMQ 这种消息队列，从消息队列的概念、应用场景、安装方式到它的核心概念、五种工作模式。在安装的时候推荐使用 Docker 方式进行安装。重点需要理解的就是消息队列的应用场景、核心概念和 RabbitMQ 的五种工作模式，其中用的比较多的就是发布订阅模式、主题模式。</p>
<p>队列 (Queue) 是一种常见的数据结构，其最大的特性就是先进先出(Firist In First Out)，作为最基础的数据结构，队列应用很广泛，比如我们熟知的 Redis 基础数据类型 List，其底层数据结构就是队列。</p>
<p>消息队列 (Messaeg Queue) 是一种使用队列 (Queue) 作为底层存储数据结构，可用于解决不同进程与应用之间通讯的分布式消息容器，也称为消息中间件。</p>
<p>目前使用得比较多的消息队列有 ActiveMQ，RabbitMQ，Kafka，RocketMQ 等。本文主要讲述的是 RabbitMQ，RabbitMQ 是用 Erlang 语言开发的一个实现了 AMQP 协议的消息队列服务器，相比其他同类型的消息队列，最大的特点在保证可观的单机吞吐量的同时，延时方面非常出色。</p>
<p>RabbitMQ 支持多种客户端，比如：GO、Python、Ruby、.NET、Java、JMS、C、PHP、ActionScript、XMPP、STOMP 等。</p>
<blockquote>
<p>AMQP，即 Advanced Message Queuing Protocol，高级消息队列协议，是应用层协议的一个开放标准，为面向消息的中间件设计，它是一种应用程序之间的通信方法，消息队列在分布式系统开发中应用非常广泛。这里是 AMQP 官网 <a href="https://amqp.org/">amqp.org</a></p>
</blockquote>
<p>消息队列使用广泛，其应用场景有很多，下面我们列举比较常见的四个场景：</p>
<h3 id="1消息通讯">1、消息通讯</h3>
<p>消息队列最主要功能收发消息，其内部有高效的通讯机制，因此非常适合用于消息通讯。</p>
<p>我们可以基于消息队列开发点对点聊天系统，也可以开发广播系统，用于将消息广播给大量接收者。</p>
<h3 id="2异步处理">2、异步处理</h3>
<p>一般我们写的程序都是顺序执行 (同步执行)，比如一个用户注册函数，其执行顺序如下：</p>
<ul>
<li>1、写入用户注册数据。</li>
<li>2、发送注册邮件。</li>
<li>3、发送注册成功的短信通知。</li>
<li>4、更新统计数据。</li>
</ul>
<p>按照上面的执行顺序，要全部执行完毕，才能返回成功，但其实在第 1 步执行成功后，其他的步骤完全可以异步执行，我们可以将后面的逻辑发给消息队列，再由其他程序异步执行。使用消息队列进行异步处理，可以更快地返回结果，加快服务器的响应速度，提升了服务器的性能。</p>
<h3 id="3服务解耦">3、服务解耦</h3>
<p>在我们的系统中，应用与应用之间的通讯是很常见的，一般我们应用之间直接调用，比如说应用 A 调用应用 B 的接口，这时候应用之间的关系是强耦合的。</p>
<p>如果应用 B 处于不可用的状态，那么应用 A 也会受影响。</p>
<p>在应用 A 与应用 B 之间引入消息队列进行服务解耦，如果应用 B 挂掉，也不会影响应用 A 的使用。</p>
<h3 id="4流量削峰">4、流量削峰</h3>
<p>对于高并发的系统来说，在访问高峰时，突发的流量就像洪水般向应用系统涌过来，尤其是一些高并发写操作，随时会导致数据库服务器瘫痪，无法继续提供服务。</p>
<p>而引入消息队列则可以减少突发流量对应用系统的冲击。消息队列就像水库一样，拦蓄上游的洪水，削减进入下游河道的洪峰流量，从而达到减免洪水灾害的目的。而在旱季水流量小的时候又可以把水放出来灌溉庄稼。</p>
<p>这方面最常见的例子就是秒杀系统，一般秒杀活动瞬间流量很高，如果流量全部涌向秒杀系统，会压垮秒杀系统，通过引入消息队列，可以有效缓冲突发流量，达到削峰填谷的作用。</p>
<h2 id="安装">安装</h2>
<p>Docker 安装方式如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>docker run -d --name rabbitmq -p 5672:5672 -p 15672:15672 rabbitmq:3-management
</span></span></code></pre></div><p>RabbitMQ 有属于自己的一套核心概念，对这些概念的理解很重要，只有理解了这些核心概念，才有可能建立对 RabbitMQ 的全面理解：</p>
<h2 id="rabbitmq核心概念">RabbitMQ核心概念</h2>
<h3 id="broker">Broker</h3>
<p>Broker 概念比较简单，我们可以把 Broker 理解为一个 RabitMQ Server。</p>
<h3 id="producer-与-consumer">Producer 与 Consumer</h3>
<p>生产者与消费者相对于 RabbitMQ 服务器来说，都是 RabbitMQ 服务器的客户端。</p>
<ul>
<li>生产者 (Producer)：连到 RabbitMQ 服务器，将消息发送到 RabbitMQ 服务器的队列，是消息的发送方。</li>
<li>消费者 (Consumer)：连接到 RabbitMQ 则是为了消费队列中的消息，是消息的接收方。</li>
</ul>
<p>生产者与消费者一般由我们的应用程序充当。</p>
<h3 id="connection">Connection</h3>
<p>Connection 是 RabbitMQ 内部对象之一，用于管理每个到 RabbitMQ 的 TCP 网络连接。</p>
<h3 id="channel">Channel</h3>
<p>Channel 是我们与 RabbitMQ 打交道的最重要的一个接口，我们大部分的业务操作是在 Channel 这个接口中完成的，包括定义 Queue、定义 Exchange、绑定 Queue 与 Exchange、发布消息等。</p>
<h3 id="exchnage">Exchnage</h3>
<p>消息交换机，作用是接收来自生产者的消息，并根据路由键转发消息到所绑定的队列。</p>
<p>生产者发送上的消息，就是先通过 Exchnage 按照绑定 (binding) 规则转发到队列的。</p>
<p>交换机类型 (Exchange Type) 有四种：fanout、direct、topic，headers，其中 headers 并不常用。</p>
<ul>
<li>fanout：这种类型不处理路由键 (RoutingKey)，很像子网广播，每台子网内的主机都获得了一份复制的消息，发布 / 订阅模式就是指使用 fanout 交换机类型，fanout 类型交换机转发消息是最快的。</li>
<li>direct：模式处理路由键，需要路由键完全匹配的队列才能收到消息，路由模式使用的是 direct 类型的交换机。</li>
<li>topic：将路由键和某模式进行匹配。主题模式使用的是 topic 类型的交换机。</li>
</ul>
<blockquote>
<p>路由模式，发布订阅模式，主题模式，这些工作模式我们下面会讲。</p>
</blockquote>
<p><img src="/images/4ec0abac-6b64-4401-b5a0-d538e4121932.png" alt=""></p>
<h3 id="queue">Queue</h3>
<p>Queue 即队列，RabbitMQ 内部用于存储消息的对象，是真正用存储消息的结构，在生产端，生产者的消息最终发送到指定队列，而消费者也是通过订阅某个队列，达到获取消息的目的。</p>
<h3 id="binding">Binding</h3>
<p>Binding 是一种操作，其作用是建立消息从 Exchange 转发到 Queue 的规则，在进行 Exchange 与 Queue 的绑定时，需要指定一个 BindingKey，Binding 操作一般用于 RabbitMQ 的路由工作模式和主题工作模式。</p>
<blockquote>
<p>BindingKey 的概念，下面在讲 RabbitMQ 的工作模式会详细讲解。</p>
</blockquote>
<h3 id="virtual-host">Virtual Host</h3>
<p>Virutal host 也叫虚拟主机，一个 VirtualHost 下面有一组不同 Exchnage 与 Queue，不同的 Virtual host 的 Exchnage 与 Queue 之间互相不影响。应用隔离与权限划分，Virtual host 是 RabbitMQ 中最小颗粒的权限单位划分。</p>
<p>如果要类比的话，我们可以把 Virtual host 比作 MySQL 中的数据库，通常我们在使用 MySQL 时，会为不同的项目指定不同的数据库，同样的，在使用 RabbitMQ 时，我们可以为不同的应用程序指定不同的 Virtual host。</p>
<p><img src="/images/4ee9330b-d0fc-4dc9-bc74-e05fb06d40c7.png" alt=""></p>
<p>请参考：<a href="https://www.rabbitmq.com/getstarted.html">www.rabbitmq.com/getstarted.…</a></p>
<h2 id="简单-simple-模式">简单 (simple) 模式</h2>
<p>simple 模式，是 RabbitMQ 几种模式中最简单的一种模式，其结构如下图所示：</p>
<p><img src="/images/6f7e393f-d4c7-406b-a1c2-221319cadf7f.png" alt=""></p>
<p>从上面的示意图，我们可以看出<code>simple</code>模式有以下几个特征：</p>
<ul>
<li>只有一个生产者、一个消费者和一个队列。</li>
<li>生产者和消费者在发送和接收消息时，只需要指定队列名，而不需要指定发送到哪个 Exchange，RabbitMQ 服务器会自动使用 Virtual host 的默认的 Exchange，默认 Exchange 的 type 为 direct。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 引入amqo包</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;github.com/streadway/amqp&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">const</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">LOGIN</span> <span style="color:#00a8c8">string</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;zhaohaiyu&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">PASSWORD</span> <span style="color:#00a8c8">string</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;zhy.1996&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">HOST</span> <span style="color:#00a8c8">string</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;127.0.0.1&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">PORT</span> <span style="color:#00a8c8">string</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;5672&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">VIRTUALHOST</span> <span style="color:#00a8c8">string</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;/&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">Pushlish</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 创建链接</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">url</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Sprintf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;amqp://%s:%s@%s:%s%s&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">LOGIN</span><span style="color:#111">,</span> <span style="color:#75af00">PASSWORD</span><span style="color:#111">,</span> <span style="color:#75af00">HOST</span><span style="color:#111">,</span> <span style="color:#75af00">PORT</span><span style="color:#111">,</span> <span style="color:#75af00">VIRTUALHOST</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">conn</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">amqp</span><span style="color:#111">.</span><span style="color:#75af00">Dial</span><span style="color:#111">(</span><span style="color:#75af00">url</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">failOnError</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Failed to connect to RabbitMQ&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">conn</span><span style="color:#111">.</span><span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 打开一个通道</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ch</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">conn</span><span style="color:#111">.</span><span style="color:#75af00">Channel</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">failOnError</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Failed to open a channel&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">ch</span><span style="color:#111">.</span><span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 生成一个交换机（交换机不存在的情况下）</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">ch</span><span style="color:#111">.</span><span style="color:#75af00">ExchangeDeclare</span><span style="color:#111">(</span><span style="color:#d88200">&#34;test&#34;</span><span style="color:#111">,</span><span style="color:#d88200">&#34;direct&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">true</span><span style="color:#111">,</span><span style="color:#00a8c8">false</span><span style="color:#111">,</span><span style="color:#00a8c8">false</span><span style="color:#111">,</span> <span style="color:#00a8c8">false</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">failOnError</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Failed to declare an exchange&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 生成一个队列队列（队列不存在的情况下）</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">ch</span><span style="color:#111">.</span><span style="color:#75af00">QueueDeclare</span><span style="color:#111">(</span><span style="color:#d88200">&#34;test1&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">true</span><span style="color:#111">,</span> <span style="color:#00a8c8">false</span><span style="color:#111">,</span> <span style="color:#00a8c8">false</span><span style="color:#111">,</span> <span style="color:#00a8c8">false</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">failOnError</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Failed to declare an queue&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//列队与交换机绑定</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">ch</span><span style="color:#111">.</span><span style="color:#75af00">QueueBind</span><span style="color:#111">(</span><span style="color:#d88200">&#34;test1&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;zhaohaiyu&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;test&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">false</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">failOnError</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Bind queue to exchange failure&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//指定交换机发布消息</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">ch</span><span style="color:#111">.</span><span style="color:#75af00">Publish</span><span style="color:#111">(</span><span style="color:#d88200">&#34;test&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;zhaohaiyu&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">false</span><span style="color:#111">,</span> <span style="color:#00a8c8">false</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">amqp</span><span style="color:#111">.</span><span style="color:#75af00">Publishing</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">ContentType</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;text/plain&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">Body</span><span style="color:#111">:</span>        <span style="color:#111">[]</span><span style="color:#111">byte</span><span style="color:#111">(</span><span style="color:#d88200">&#34;生产者测试1&#34;</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">failOnError</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Message publish failure&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">Get</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 创建链接</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">url</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Sprintf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;amqp://%s:%s@%s:%s%s&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">LOGIN</span><span style="color:#111">,</span> <span style="color:#75af00">PASSWORD</span><span style="color:#111">,</span> <span style="color:#75af00">HOST</span><span style="color:#111">,</span> <span style="color:#75af00">PORT</span><span style="color:#111">,</span> <span style="color:#75af00">VIRTUALHOST</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">conn</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">amqp</span><span style="color:#111">.</span><span style="color:#75af00">Dial</span><span style="color:#111">(</span><span style="color:#75af00">url</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">failOnError</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Failed to connect to RabbitMQ&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">conn</span><span style="color:#111">.</span><span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 打开一个通道</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ch</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">conn</span><span style="color:#111">.</span><span style="color:#75af00">Channel</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">failOnError</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Failed to open a channel&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">ch</span><span style="color:#111">.</span><span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 指定队列获取消息</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">msg</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">ch</span><span style="color:#111">.</span><span style="color:#75af00">Get</span><span style="color:#111">(</span><span style="color:#d88200">&#34;test1&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">true</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">failOnError</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Message empty&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#111">string</span><span style="color:#111">(</span><span style="color:#75af00">msg</span><span style="color:#111">.</span><span style="color:#75af00">Body</span><span style="color:#111">),</span> <span style="color:#75af00">ok</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">failOnError</span><span style="color:#111">(</span><span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span><span style="color:#111">,</span> <span style="color:#75af00">msg</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Fatalf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;%s: %s&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">msg</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Pushlish</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Get</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">结果：产者测试1 true
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span></code></pre></div><h2 id="工作-work-模式">工作 (work) 模式</h2>
<p>在 simple 模式下只有一个生产者和消费者，当生产者生产消息的速度大于消费者的消费速度时，我们可以添加一个或多个消费者来加快消费速度，这种在 simple 模式下增加消费者的模式，称为 work 模式，如下图所示：</p>
<p><img src="/images/21606601-f4d0-4f45-a1e6-f5416d66f646.png" alt=""></p>
<p>work 模式有以下两个特征：</p>
<ul>
<li>可以有多个消费者，但一条消息只能被一个消费者获取。</li>
<li>发送到队列中的消息，由服务器平均分配给不同消费者进行消费</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 引入amqo包</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;github.com/streadway/amqp&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">const</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">LOGIN</span> <span style="color:#00a8c8">string</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;zhaohaiyu&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">PASSWORD</span> <span style="color:#00a8c8">string</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;zhy.1996&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">HOST</span> <span style="color:#00a8c8">string</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;127.0.0.1&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">PORT</span> <span style="color:#00a8c8">string</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;5672&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">VIRTUALHOST</span> <span style="color:#00a8c8">string</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;/&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">Pushlish</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 创建链接</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">url</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Sprintf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;amqp://%s:%s@%s:%s%s&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">LOGIN</span><span style="color:#111">,</span> <span style="color:#75af00">PASSWORD</span><span style="color:#111">,</span> <span style="color:#75af00">HOST</span><span style="color:#111">,</span> <span style="color:#75af00">PORT</span><span style="color:#111">,</span> <span style="color:#75af00">VIRTUALHOST</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">conn</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">amqp</span><span style="color:#111">.</span><span style="color:#75af00">Dial</span><span style="color:#111">(</span><span style="color:#75af00">url</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">failOnError</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Failed to connect to RabbitMQ&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">conn</span><span style="color:#111">.</span><span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 打开一个通道</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ch</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">conn</span><span style="color:#111">.</span><span style="color:#75af00">Channel</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">failOnError</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Failed to open a channel&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">ch</span><span style="color:#111">.</span><span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 生成一个交换机（交换机不存在的情况下）</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">ch</span><span style="color:#111">.</span><span style="color:#75af00">ExchangeDeclare</span><span style="color:#111">(</span><span style="color:#d88200">&#34;test&#34;</span><span style="color:#111">,</span><span style="color:#d88200">&#34;direct&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">true</span><span style="color:#111">,</span><span style="color:#00a8c8">false</span><span style="color:#111">,</span><span style="color:#00a8c8">false</span><span style="color:#111">,</span> <span style="color:#00a8c8">false</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">failOnError</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Failed to declare an exchange&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 生成一个队列队列（队列不存在的情况下）</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">ch</span><span style="color:#111">.</span><span style="color:#75af00">QueueDeclare</span><span style="color:#111">(</span><span style="color:#d88200">&#34;test1&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">true</span><span style="color:#111">,</span> <span style="color:#00a8c8">false</span><span style="color:#111">,</span> <span style="color:#00a8c8">false</span><span style="color:#111">,</span> <span style="color:#00a8c8">false</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">failOnError</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Failed to declare an queue&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//列队与交换机绑定</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">ch</span><span style="color:#111">.</span><span style="color:#75af00">QueueBind</span><span style="color:#111">(</span><span style="color:#d88200">&#34;test1&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;zhaohaiyu&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;test&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">false</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">failOnError</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Bind queue to exchange failure&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//指定交换机发布消息</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Sleep</span><span style="color:#111">(</span><span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Second</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">ch</span><span style="color:#111">.</span><span style="color:#75af00">Publish</span><span style="color:#111">(</span><span style="color:#d88200">&#34;test&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;zhaohaiyu&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">false</span><span style="color:#111">,</span> <span style="color:#00a8c8">false</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">amqp</span><span style="color:#111">.</span><span style="color:#75af00">Publishing</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">ContentType</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;text/plain&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">Body</span><span style="color:#111">:</span>        <span style="color:#111">[]</span><span style="color:#111">byte</span><span style="color:#111">(</span><span style="color:#d88200">&#34;生产者测试1&#34;</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">failOnError</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Message publish failure&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">Get1</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 创建链接</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">url</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Sprintf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;amqp://%s:%s@%s:%s%s&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">LOGIN</span><span style="color:#111">,</span> <span style="color:#75af00">PASSWORD</span><span style="color:#111">,</span> <span style="color:#75af00">HOST</span><span style="color:#111">,</span> <span style="color:#75af00">PORT</span><span style="color:#111">,</span> <span style="color:#75af00">VIRTUALHOST</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">conn</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">amqp</span><span style="color:#111">.</span><span style="color:#75af00">Dial</span><span style="color:#111">(</span><span style="color:#75af00">url</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">failOnError</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Failed to connect to RabbitMQ&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">conn</span><span style="color:#111">.</span><span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 打开一个通道</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ch</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">conn</span><span style="color:#111">.</span><span style="color:#75af00">Channel</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">failOnError</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Failed to open a channel&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">ch</span><span style="color:#111">.</span><span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 指定队列获取消息</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Sleep</span><span style="color:#111">(</span><span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Second</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">msg</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">ch</span><span style="color:#111">.</span><span style="color:#75af00">Get</span><span style="color:#111">(</span><span style="color:#d88200">&#34;test1&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">true</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">failOnError</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Message empty&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Get1&#34;</span><span style="color:#111">,</span> <span style="color:#111">string</span><span style="color:#111">(</span><span style="color:#75af00">msg</span><span style="color:#111">.</span><span style="color:#75af00">Body</span><span style="color:#111">),</span> <span style="color:#75af00">ok</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">Get2</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 创建链接</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">url</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Sprintf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;amqp://%s:%s@%s:%s%s&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">LOGIN</span><span style="color:#111">,</span> <span style="color:#75af00">PASSWORD</span><span style="color:#111">,</span> <span style="color:#75af00">HOST</span><span style="color:#111">,</span> <span style="color:#75af00">PORT</span><span style="color:#111">,</span> <span style="color:#75af00">VIRTUALHOST</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">conn</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">amqp</span><span style="color:#111">.</span><span style="color:#75af00">Dial</span><span style="color:#111">(</span><span style="color:#75af00">url</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">failOnError</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Failed to connect to RabbitMQ&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">conn</span><span style="color:#111">.</span><span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 打开一个通道</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ch</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">conn</span><span style="color:#111">.</span><span style="color:#75af00">Channel</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">failOnError</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Failed to open a channel&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">ch</span><span style="color:#111">.</span><span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 指定队列获取消息</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Sleep</span><span style="color:#111">(</span><span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Second</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">msg</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">ch</span><span style="color:#111">.</span><span style="color:#75af00">Get</span><span style="color:#111">(</span><span style="color:#d88200">&#34;test1&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">true</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">failOnError</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Message empty&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Get2&#34;</span><span style="color:#111">,</span> <span style="color:#111">string</span><span style="color:#111">(</span><span style="color:#75af00">msg</span><span style="color:#111">.</span><span style="color:#75af00">Body</span><span style="color:#111">),</span> <span style="color:#75af00">ok</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">failOnError</span><span style="color:#111">(</span><span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span><span style="color:#111">,</span> <span style="color:#75af00">msg</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Fatalf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;%s: %s&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">msg</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">go</span> <span style="color:#75af00">Pushlish</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">go</span> <span style="color:#75af00">Get1</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">go</span> <span style="color:#75af00">Get2</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Sleep</span><span style="color:#111">(</span><span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Second</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">20</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">结果：Get1  false
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">Get2 生产者测试1 true
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">Get2  false
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">Get1 生产者测试1 true
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">Get1  false
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">Get2 生产者测试1 true
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">Get2  false
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">Get1 生产者测试1 true
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">Get1 生产者测试1 true
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">Get2  false
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">Get2  false
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">Get1 生产者测试1 true
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">Get2  false
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">Get1 生产者测试1 true
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">Get2  false
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">Get1 生产者测试1 true
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">Get1 生产者测试1 true
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">Get2  false
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">Get2  false
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">Get1 生产者测试1 true
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">Get1 生产者测试1 true
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">Get2  false
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">Get1 生产者测试1 true
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">Get2  false
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">Get2  false
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">Get1 生产者测试1 true
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">Get2  false
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">Get1 生产者测试1 true
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">Get1 生产者测试1 true
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">Get2  false
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">Get1 生产者测试1 true
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">Get2  false
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">Get2 生产者测试1 true
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">Get1  false
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">Get2  false
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">Get1 生产者测试1 true
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">Get1 生产者测试1 true
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">Get2  false
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span></code></pre></div><h2 id="发布--订阅-pubsub-模式">发布 / 订阅 (pub/sub) 模式</h2>
<p>work 模式可以将消息转到多个消费者，但每条消息只能由一个消费者获取，如果我们想一条消息可以同时给多个消费者消费呢？</p>
<p>这时候就需要发布 / 订阅模式，其示意图如下所示：</p>
<p><img src="/images/86400d5c-7cc7-4170-ac4a-4aea2aa15fa8.png" alt=""></p>
<p>从上面的示意图我们可以看出来，在发布 / 订阅模式下，需要指定发送到哪个 Exchange 中，上面图中的 X 表示 Exchange。</p>
<ul>
<li>发布 / 订阅模式中，Echange 的 type 为 fanout。</li>
<li>生产者发送消息时，不需要指定具体的队列名，Exchange 会将收到的消息转发到所绑定的队列。</li>
<li>消息被 Exchange 转到多个队列，一条消息可以被多个消费者获取。</li>
</ul>
<p>在上图中，oneQueue 中的消息要么被 CustomerA 获取，要么被 CustomerB 获取。也就是同一条消息，要么是 CustomerA + CustomerC 消费、要么是 CustomerB + CustomerC 消费。</p>
<p>生产者：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;github.com/streadway/amqp&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;strings&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">const</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">LOGIN</span> <span style="color:#00a8c8">string</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;zhaohaiyu&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">PASSWORD</span> <span style="color:#00a8c8">string</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;zhy.1996&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">HOST</span> <span style="color:#00a8c8">string</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;127.0.0.1&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">PORT</span> <span style="color:#00a8c8">string</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;5672&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">VIRTUALHOST</span> <span style="color:#00a8c8">string</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;/&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//url := fmt.Sprintf()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">failOnError</span><span style="color:#111">(</span><span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span><span style="color:#111">,</span> <span style="color:#75af00">msg</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Fatalf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;%s: %s&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">msg</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">conn</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">amqp</span><span style="color:#111">.</span><span style="color:#75af00">Dial</span><span style="color:#111">(</span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Sprintf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;amqp://%s:%s@%s:%s%s&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">LOGIN</span><span style="color:#111">,</span> <span style="color:#75af00">PASSWORD</span><span style="color:#111">,</span> <span style="color:#75af00">HOST</span><span style="color:#111">,</span> <span style="color:#75af00">PORT</span><span style="color:#111">,</span> <span style="color:#75af00">VIRTUALHOST</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">failOnError</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Failed to connect to RabbitMQ&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">conn</span><span style="color:#111">.</span><span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ch</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">conn</span><span style="color:#111">.</span><span style="color:#75af00">Channel</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">failOnError</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Failed to open a channel&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">ch</span><span style="color:#111">.</span><span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">ch</span><span style="color:#111">.</span><span style="color:#75af00">ExchangeDeclare</span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#d88200">&#34;logs&#34;</span><span style="color:#111">,</span>   <span style="color:#75715e">// name</span>
</span></span><span style="display:flex;"><span>		<span style="color:#d88200">&#34;fanout&#34;</span><span style="color:#111">,</span> <span style="color:#75715e">// type</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">true</span><span style="color:#111">,</span>     <span style="color:#75715e">// durable</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">false</span><span style="color:#111">,</span>    <span style="color:#75715e">// auto-deleted</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">false</span><span style="color:#111">,</span>    <span style="color:#75715e">// internal</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">false</span><span style="color:#111">,</span>    <span style="color:#75715e">// no-wait</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">nil</span><span style="color:#111">,</span>      <span style="color:#75715e">// arguments</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">failOnError</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Failed to declare an exchange&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">body</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">bodyFrom</span><span style="color:#111">(</span><span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">Args</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">ch</span><span style="color:#111">.</span><span style="color:#75af00">Publish</span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#d88200">&#34;logs&#34;</span><span style="color:#111">,</span> <span style="color:#75715e">// exchange</span>
</span></span><span style="display:flex;"><span>		<span style="color:#d88200">&#34;&#34;</span><span style="color:#111">,</span>     <span style="color:#75715e">// routing key</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">false</span><span style="color:#111">,</span>  <span style="color:#75715e">// mandatory</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">false</span><span style="color:#111">,</span>  <span style="color:#75715e">// immediate</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">amqp</span><span style="color:#111">.</span><span style="color:#75af00">Publishing</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">ContentType</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;text/plain&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">Body</span><span style="color:#111">:</span>        <span style="color:#111">[]</span><span style="color:#111">byte</span><span style="color:#111">(</span><span style="color:#75af00">body</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">failOnError</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Failed to publish a message&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34; [x] Sent %s&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">body</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">bodyFrom</span><span style="color:#111">(</span><span style="color:#75af00">args</span> <span style="color:#111">[]</span><span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#00a8c8">string</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">var</span> <span style="color:#75af00">s</span> <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#111">(</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">args</span><span style="color:#111">)</span> <span style="color:#111">&lt;</span> <span style="color:#ae81ff">2</span><span style="color:#111">)</span> <span style="color:#f92672">||</span> <span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">Args</span><span style="color:#111">[</span><span style="color:#ae81ff">1</span><span style="color:#111">]</span> <span style="color:#f92672">==</span> <span style="color:#d88200">&#34;&#34;</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">s</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;hello&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">s</span> <span style="color:#111">=</span> <span style="color:#75af00">strings</span><span style="color:#111">.</span><span style="color:#75af00">Join</span><span style="color:#111">(</span><span style="color:#75af00">args</span><span style="color:#111">[</span><span style="color:#ae81ff">1</span><span style="color:#111">:],</span> <span style="color:#d88200">&#34; &#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">s</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>不同的 Exchange 之间互不影响，相同 Exchange，相同队列的情况下，消息均等消费：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;github.com/streadway/amqp&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">const</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">LOGIN</span> <span style="color:#00a8c8">string</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;zhaohaiyu&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">PASSWORD</span> <span style="color:#00a8c8">string</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;zhy.1996&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">HOST</span> <span style="color:#00a8c8">string</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;127.0.0.1&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">PORT</span> <span style="color:#00a8c8">string</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;5672&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">VIRTUALHOST</span> <span style="color:#00a8c8">string</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;/&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">failOnError</span><span style="color:#111">(</span><span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span><span style="color:#111">,</span> <span style="color:#75af00">msg</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Fatalf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;%s: %s&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">msg</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">conn</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">amqp</span><span style="color:#111">.</span><span style="color:#75af00">Dial</span><span style="color:#111">(</span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Sprintf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;amqp://%s:%s@%s:%s%s&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">LOGIN</span><span style="color:#111">,</span> <span style="color:#75af00">PASSWORD</span><span style="color:#111">,</span> <span style="color:#75af00">HOST</span><span style="color:#111">,</span> <span style="color:#75af00">PORT</span><span style="color:#111">,</span> <span style="color:#75af00">VIRTUALHOST</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">failOnError</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Failed to connect to RabbitMQ&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">conn</span><span style="color:#111">.</span><span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ch</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">conn</span><span style="color:#111">.</span><span style="color:#75af00">Channel</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">failOnError</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Failed to open a channel&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">ch</span><span style="color:#111">.</span><span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">ch</span><span style="color:#111">.</span><span style="color:#75af00">ExchangeDeclare</span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#d88200">&#34;logs&#34;</span><span style="color:#111">,</span>   <span style="color:#75715e">// name</span>
</span></span><span style="display:flex;"><span>		<span style="color:#d88200">&#34;fanout&#34;</span><span style="color:#111">,</span> <span style="color:#75715e">// type</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">true</span><span style="color:#111">,</span>     <span style="color:#75715e">// durable</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">false</span><span style="color:#111">,</span>    <span style="color:#75715e">// auto-deleted</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">false</span><span style="color:#111">,</span>    <span style="color:#75715e">// internal</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">false</span><span style="color:#111">,</span>    <span style="color:#75715e">// no-wait</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">nil</span><span style="color:#111">,</span>      <span style="color:#75715e">// arguments</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">failOnError</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Failed to declare an exchange&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">q</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">ch</span><span style="color:#111">.</span><span style="color:#75af00">QueueDeclare</span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#d88200">&#34;&#34;</span><span style="color:#111">,</span>    <span style="color:#75715e">// name</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">false</span><span style="color:#111">,</span> <span style="color:#75715e">// durable</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">false</span><span style="color:#111">,</span> <span style="color:#75715e">// delete when unused</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">true</span><span style="color:#111">,</span>  <span style="color:#75715e">// exclusive</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">false</span><span style="color:#111">,</span> <span style="color:#75715e">// no-wait</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">nil</span><span style="color:#111">,</span>   <span style="color:#75715e">// arguments</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">failOnError</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Failed to declare a queue&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">ch</span><span style="color:#111">.</span><span style="color:#75af00">QueueBind</span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">q</span><span style="color:#111">.</span><span style="color:#75af00">Name</span><span style="color:#111">,</span> <span style="color:#75715e">// queue name</span>
</span></span><span style="display:flex;"><span>		<span style="color:#d88200">&#34;&#34;</span><span style="color:#111">,</span>     <span style="color:#75715e">// routing key</span>
</span></span><span style="display:flex;"><span>		<span style="color:#d88200">&#34;logs&#34;</span><span style="color:#111">,</span> <span style="color:#75715e">// exchange</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">false</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">nil</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">failOnError</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Failed to bind a queue&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">msgs</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">ch</span><span style="color:#111">.</span><span style="color:#75af00">Consume</span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">q</span><span style="color:#111">.</span><span style="color:#75af00">Name</span><span style="color:#111">,</span> <span style="color:#75715e">// queue</span>
</span></span><span style="display:flex;"><span>		<span style="color:#d88200">&#34;&#34;</span><span style="color:#111">,</span>     <span style="color:#75715e">// consumer</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">true</span><span style="color:#111">,</span>   <span style="color:#75715e">// auto-ack</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">false</span><span style="color:#111">,</span>  <span style="color:#75715e">// exclusive</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">false</span><span style="color:#111">,</span>  <span style="color:#75715e">// no-local</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">false</span><span style="color:#111">,</span>  <span style="color:#75715e">// no-wait</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">nil</span><span style="color:#111">,</span>    <span style="color:#75715e">// args</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">failOnError</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Failed to register a consumer&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">forever</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">chan</span> <span style="color:#00a8c8">bool</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">go</span> <span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">for</span> <span style="color:#75af00">d</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">msgs</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34; [x] %s&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">d</span><span style="color:#111">.</span><span style="color:#75af00">Body</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34; [*] Waiting for logs. To exit press CTRL+C&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">&lt;-</span><span style="color:#75af00">forever</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>相同 Exchange，不同队列的情况下，一条消息可以被多个消费者获取。</p>
<h2 id="路由-routing-模式">路由 (routing) 模式</h2>
<p>前面几种模式，消息的目标队列无法由生产者指定，而在路由模式下，消息的目标队列，可以由生产者指定，其示意图如下所示：</p>
<p><img src="/images/3e912744-2919-4a56-b42a-87b67d02d096.png" alt=""></p>
<ul>
<li>路由模式下<code>Exchange</code>的 type 为<code>direct</code>。</li>
<li>消息的目标队列可以由生产者按照<code>routingKey</code>规则指定。</li>
<li>消费者通过<code>BindingKey</code>绑定自己所关心的队列。</li>
<li>一条消息队可以被多个消息者获取。</li>
<li>只有<code>RoutingKey</code>与<code>BidingKey</code>相匹配的队列才会收到消息。</li>
</ul>
<blockquote>
<p><code>RoutingKey</code>用于生产者指定<code>Exchange</code>最终将消息路由到哪个队列，<code>BindingKey</code>用于消费者绑定到某个队列。</p>
</blockquote>
<p>生产者：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;strings&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;github.com/streadway/amqp&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">const</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">LOGIN</span> <span style="color:#00a8c8">string</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;zhaohaiyu&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">PASSWORD</span> <span style="color:#00a8c8">string</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;zhy.1996&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">HOST</span> <span style="color:#00a8c8">string</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;127.0.0.1&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">PORT</span> <span style="color:#00a8c8">string</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;5672&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">VIRTUALHOST</span> <span style="color:#00a8c8">string</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;/&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">failOnError</span><span style="color:#111">(</span><span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span><span style="color:#111">,</span> <span style="color:#75af00">msg</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Fatalf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;%s: %s&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">msg</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">conn</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">amqp</span><span style="color:#111">.</span><span style="color:#75af00">Dial</span><span style="color:#111">(</span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Sprintf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;amqp://%s:%s@%s:%s%s&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">LOGIN</span><span style="color:#111">,</span> <span style="color:#75af00">PASSWORD</span><span style="color:#111">,</span> <span style="color:#75af00">HOST</span><span style="color:#111">,</span> <span style="color:#75af00">PORT</span><span style="color:#111">,</span> <span style="color:#75af00">VIRTUALHOST</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">failOnError</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Failed to connect to RabbitMQ&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">conn</span><span style="color:#111">.</span><span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ch</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">conn</span><span style="color:#111">.</span><span style="color:#75af00">Channel</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">failOnError</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Failed to open a channel&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">ch</span><span style="color:#111">.</span><span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">ch</span><span style="color:#111">.</span><span style="color:#75af00">ExchangeDeclare</span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#d88200">&#34;logs_direct&#34;</span><span style="color:#111">,</span> <span style="color:#75715e">// name</span>
</span></span><span style="display:flex;"><span>		<span style="color:#d88200">&#34;direct&#34;</span><span style="color:#111">,</span>      <span style="color:#75715e">// type</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">true</span><span style="color:#111">,</span>          <span style="color:#75715e">// durable</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">false</span><span style="color:#111">,</span>         <span style="color:#75715e">// auto-deleted</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">false</span><span style="color:#111">,</span>         <span style="color:#75715e">// internal</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">false</span><span style="color:#111">,</span>         <span style="color:#75715e">// no-wait</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">nil</span><span style="color:#111">,</span>           <span style="color:#75715e">// arguments</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">failOnError</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Failed to declare an exchange&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">body</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">bodyFrom</span><span style="color:#111">(</span><span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">Args</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">ch</span><span style="color:#111">.</span><span style="color:#75af00">Publish</span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#d88200">&#34;logs_direct&#34;</span><span style="color:#111">,</span>         <span style="color:#75715e">// exchange</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">severityFrom</span><span style="color:#111">(</span><span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">Args</span><span style="color:#111">),</span> <span style="color:#75715e">// routing key</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">false</span><span style="color:#111">,</span> <span style="color:#75715e">// mandatory</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">false</span><span style="color:#111">,</span> <span style="color:#75715e">// immediate</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">amqp</span><span style="color:#111">.</span><span style="color:#75af00">Publishing</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">ContentType</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;text/plain&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">Body</span><span style="color:#111">:</span>        <span style="color:#111">[]</span><span style="color:#111">byte</span><span style="color:#111">(</span><span style="color:#75af00">body</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">failOnError</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Failed to publish a message&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34; [x] Sent %s&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">body</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">bodyFrom</span><span style="color:#111">(</span><span style="color:#75af00">args</span> <span style="color:#111">[]</span><span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#00a8c8">string</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">var</span> <span style="color:#75af00">s</span> <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#111">(</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">args</span><span style="color:#111">)</span> <span style="color:#111">&lt;</span> <span style="color:#ae81ff">3</span><span style="color:#111">)</span> <span style="color:#f92672">||</span> <span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">Args</span><span style="color:#111">[</span><span style="color:#ae81ff">2</span><span style="color:#111">]</span> <span style="color:#f92672">==</span> <span style="color:#d88200">&#34;&#34;</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">s</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;hello&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">s</span> <span style="color:#111">=</span> <span style="color:#75af00">strings</span><span style="color:#111">.</span><span style="color:#75af00">Join</span><span style="color:#111">(</span><span style="color:#75af00">args</span><span style="color:#111">[</span><span style="color:#ae81ff">2</span><span style="color:#111">:],</span> <span style="color:#d88200">&#34; &#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">s</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">severityFrom</span><span style="color:#111">(</span><span style="color:#75af00">args</span> <span style="color:#111">[]</span><span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#00a8c8">string</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">var</span> <span style="color:#75af00">s</span> <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#111">(</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">args</span><span style="color:#111">)</span> <span style="color:#111">&lt;</span> <span style="color:#ae81ff">2</span><span style="color:#111">)</span> <span style="color:#f92672">||</span> <span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">Args</span><span style="color:#111">[</span><span style="color:#ae81ff">1</span><span style="color:#111">]</span> <span style="color:#f92672">==</span> <span style="color:#d88200">&#34;&#34;</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">s</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;info&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">s</span> <span style="color:#111">=</span> <span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">Args</span><span style="color:#111">[</span><span style="color:#ae81ff">1</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">s</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>消费者：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;github.com/streadway/amqp&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">const</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">LOGIN</span> <span style="color:#00a8c8">string</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;zhaohaiyu&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">PASSWORD</span> <span style="color:#00a8c8">string</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;zhy.1996&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">HOST</span> <span style="color:#00a8c8">string</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;127.0.0.1&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">PORT</span> <span style="color:#00a8c8">string</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;5672&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">VIRTUALHOST</span> <span style="color:#00a8c8">string</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;/&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">failOnError</span><span style="color:#111">(</span><span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span><span style="color:#111">,</span> <span style="color:#75af00">msg</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Fatalf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;%s: %s&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">msg</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">conn</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">amqp</span><span style="color:#111">.</span><span style="color:#75af00">Dial</span><span style="color:#111">(</span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Sprintf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;amqp://%s:%s@%s:%s%s&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">LOGIN</span><span style="color:#111">,</span> <span style="color:#75af00">PASSWORD</span><span style="color:#111">,</span> <span style="color:#75af00">HOST</span><span style="color:#111">,</span> <span style="color:#75af00">PORT</span><span style="color:#111">,</span> <span style="color:#75af00">VIRTUALHOST</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">failOnError</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Failed to connect to RabbitMQ&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">conn</span><span style="color:#111">.</span><span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ch</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">conn</span><span style="color:#111">.</span><span style="color:#75af00">Channel</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">failOnError</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Failed to open a channel&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">ch</span><span style="color:#111">.</span><span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">ch</span><span style="color:#111">.</span><span style="color:#75af00">ExchangeDeclare</span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#d88200">&#34;logs_direct&#34;</span><span style="color:#111">,</span> <span style="color:#75715e">// name</span>
</span></span><span style="display:flex;"><span>		<span style="color:#d88200">&#34;direct&#34;</span><span style="color:#111">,</span>      <span style="color:#75715e">// type</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">true</span><span style="color:#111">,</span>          <span style="color:#75715e">// durable</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">false</span><span style="color:#111">,</span>         <span style="color:#75715e">// auto-deleted</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">false</span><span style="color:#111">,</span>         <span style="color:#75715e">// internal</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">false</span><span style="color:#111">,</span>         <span style="color:#75715e">// no-wait</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">nil</span><span style="color:#111">,</span>           <span style="color:#75715e">// arguments</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">failOnError</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Failed to declare an exchange&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">q</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">ch</span><span style="color:#111">.</span><span style="color:#75af00">QueueDeclare</span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#d88200">&#34;&#34;</span><span style="color:#111">,</span>    <span style="color:#75715e">// name</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">false</span><span style="color:#111">,</span> <span style="color:#75715e">// durable</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">false</span><span style="color:#111">,</span> <span style="color:#75715e">// delete when unused</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">true</span><span style="color:#111">,</span>  <span style="color:#75715e">// exclusive</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">false</span><span style="color:#111">,</span> <span style="color:#75715e">// no-wait</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">nil</span><span style="color:#111">,</span>   <span style="color:#75715e">// arguments</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">failOnError</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Failed to declare a queue&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">Args</span><span style="color:#111">)</span> <span style="color:#111">&lt;</span> <span style="color:#ae81ff">2</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Usage: %s [info] [warning] [error]&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">Args</span><span style="color:#111">[</span><span style="color:#ae81ff">0</span><span style="color:#111">])</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">Exit</span><span style="color:#111">(</span><span style="color:#ae81ff">0</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">s</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">Args</span><span style="color:#111">[</span><span style="color:#ae81ff">1</span><span style="color:#111">:]</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Binding queue %s to exchange %s with routing key %s&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">q</span><span style="color:#111">.</span><span style="color:#75af00">Name</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;logs_direct&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">s</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">ch</span><span style="color:#111">.</span><span style="color:#75af00">QueueBind</span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">q</span><span style="color:#111">.</span><span style="color:#75af00">Name</span><span style="color:#111">,</span>        <span style="color:#75715e">// queue name</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">s</span><span style="color:#111">,</span>             <span style="color:#75715e">// routing key</span>
</span></span><span style="display:flex;"><span>			<span style="color:#d88200">&#34;logs_direct&#34;</span><span style="color:#111">,</span> <span style="color:#75715e">// exchange</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">false</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">nil</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">failOnError</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Failed to bind a queue&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">msgs</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">ch</span><span style="color:#111">.</span><span style="color:#75af00">Consume</span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">q</span><span style="color:#111">.</span><span style="color:#75af00">Name</span><span style="color:#111">,</span> <span style="color:#75715e">// queue</span>
</span></span><span style="display:flex;"><span>		<span style="color:#d88200">&#34;&#34;</span><span style="color:#111">,</span>     <span style="color:#75715e">// consumer</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">true</span><span style="color:#111">,</span>   <span style="color:#75715e">// auto ack</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">false</span><span style="color:#111">,</span>  <span style="color:#75715e">// exclusive</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">false</span><span style="color:#111">,</span>  <span style="color:#75715e">// no local</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">false</span><span style="color:#111">,</span>  <span style="color:#75715e">// no wait</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">nil</span><span style="color:#111">,</span>    <span style="color:#75715e">// args</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">failOnError</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Failed to register a consumer&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">forever</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">chan</span> <span style="color:#00a8c8">bool</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">go</span> <span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">for</span> <span style="color:#75af00">d</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">msgs</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34; [x] %s&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">d</span><span style="color:#111">.</span><span style="color:#75af00">Body</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34; [*] Waiting for logs. To exit press CTRL+C&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">&lt;-</span><span style="color:#75af00">forever</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="主题-topic-模式">主题 (Topic) 模式</h2>
<p>主题模式是在路由模式的基础上，将路由键和某模式进行匹配。其中<code>#</code>表示匹配多个词，<code>*</code>表示匹配一个词，消费者可以通过某种模式的 BindKey 来达到订阅某个主题消息的目的，如示意图如下所示：</p>
<p><img src="/images/f7433c1b-3743-405a-8107-47f918379334.png" alt=""></p>
<ul>
<li>主题模式 Exchange 的 type 取值为 topic。</li>
<li>一条消息可以被多个消费者获取。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;github.com/streadway/amqp&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">const</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">LOGIN</span>       <span style="color:#00a8c8">string</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;zhaohaiyu&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">PASSWORD</span>    <span style="color:#00a8c8">string</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;zhy.1996&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">HOST</span>        <span style="color:#00a8c8">string</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;127.0.0.1&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">PORT</span>        <span style="color:#00a8c8">string</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;5672&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">VIRTUALHOST</span> <span style="color:#00a8c8">string</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;/&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">publish</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">url</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Sprintf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;amqp://%s:%s@%s:%s%s&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">LOGIN</span><span style="color:#111">,</span> <span style="color:#75af00">PASSWORD</span><span style="color:#111">,</span> <span style="color:#75af00">HOST</span><span style="color:#111">,</span> <span style="color:#75af00">PORT</span><span style="color:#111">,</span> <span style="color:#75af00">VIRTUALHOST</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">conn</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">amqp</span><span style="color:#111">.</span><span style="color:#75af00">Dial</span><span style="color:#111">(</span><span style="color:#75af00">url</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">failOnError</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Failed to connect to RabbitMQ&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">conn</span><span style="color:#111">.</span><span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ch</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">conn</span><span style="color:#111">.</span><span style="color:#75af00">Channel</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">failOnError</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Failed to open a channel&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">ch</span><span style="color:#111">.</span><span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">ch</span><span style="color:#111">.</span><span style="color:#75af00">ExchangeDeclare</span><span style="color:#111">(</span><span style="color:#d88200">&#34;testTopic&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">amqp</span><span style="color:#111">.</span><span style="color:#75af00">ExchangeTopic</span><span style="color:#111">,</span> <span style="color:#00a8c8">true</span><span style="color:#111">,</span> <span style="color:#00a8c8">false</span><span style="color:#111">,</span> <span style="color:#00a8c8">false</span><span style="color:#111">,</span> <span style="color:#00a8c8">false</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">failOnError</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Failed to declare an exchange&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span><span style="color:#111">;</span> <span style="color:#75af00">i</span> <span style="color:#111">&lt;</span> <span style="color:#ae81ff">10</span><span style="color:#111">;</span> <span style="color:#75af00">i</span><span style="color:#f92672">++</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">ch</span><span style="color:#111">.</span><span style="color:#75af00">Publish</span><span style="color:#111">(</span><span style="color:#d88200">&#34;testTopic&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;yuemoxi&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">false</span><span style="color:#111">,</span> <span style="color:#00a8c8">false</span><span style="color:#111">,</span> <span style="color:#75af00">amqp</span><span style="color:#111">.</span><span style="color:#75af00">Publishing</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">ContentType</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;text/plain&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">Body</span><span style="color:#111">:</span>        <span style="color:#111">[]</span><span style="color:#111">byte</span><span style="color:#111">(</span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Sprintf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;time:%v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Now</span><span style="color:#111">())),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;发布成功!&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Sleep</span><span style="color:#111">(</span><span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Second</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">get1</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">url</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Sprintf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;amqp://%s:%s@%s:%s%s&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">LOGIN</span><span style="color:#111">,</span> <span style="color:#75af00">PASSWORD</span><span style="color:#111">,</span> <span style="color:#75af00">HOST</span><span style="color:#111">,</span> <span style="color:#75af00">PORT</span><span style="color:#111">,</span> <span style="color:#75af00">VIRTUALHOST</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">conn</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">amqp</span><span style="color:#111">.</span><span style="color:#75af00">Dial</span><span style="color:#111">(</span><span style="color:#75af00">url</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">failOnError</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Failed to connect to RabbitMQ&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">conn</span><span style="color:#111">.</span><span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ch</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">conn</span><span style="color:#111">.</span><span style="color:#75af00">Channel</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">failOnError</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Failed to open a channel&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">ch</span><span style="color:#111">.</span><span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">ch</span><span style="color:#111">.</span><span style="color:#75af00">ExchangeDeclare</span><span style="color:#111">(</span><span style="color:#d88200">&#34;testTopic&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">amqp</span><span style="color:#111">.</span><span style="color:#75af00">ExchangeTopic</span><span style="color:#111">,</span> <span style="color:#00a8c8">true</span><span style="color:#111">,</span> <span style="color:#00a8c8">false</span><span style="color:#111">,</span> <span style="color:#00a8c8">false</span><span style="color:#111">,</span> <span style="color:#00a8c8">false</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">failOnError</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Failed to declare an exchange&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">q</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">ch</span><span style="color:#111">.</span><span style="color:#75af00">QueueDeclare</span><span style="color:#111">(</span><span style="color:#d88200">&#34;testTopic_get1&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">false</span><span style="color:#111">,</span> <span style="color:#00a8c8">false</span><span style="color:#111">,</span> <span style="color:#00a8c8">false</span><span style="color:#111">,</span> <span style="color:#00a8c8">false</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">failOnError</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Failed to declare a queue&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">ch</span><span style="color:#111">.</span><span style="color:#75af00">QueueBind</span><span style="color:#111">(</span><span style="color:#75af00">q</span><span style="color:#111">.</span><span style="color:#75af00">Name</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;yuemox*&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;testTopic&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">false</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">failOnError</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Failed to bind a queue&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">msgs</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">ch</span><span style="color:#111">.</span><span style="color:#75af00">Consume</span><span style="color:#111">(</span><span style="color:#75af00">q</span><span style="color:#111">.</span><span style="color:#75af00">Name</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;get1&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">true</span><span style="color:#111">,</span> <span style="color:#00a8c8">false</span><span style="color:#111">,</span> <span style="color:#00a8c8">false</span><span style="color:#111">,</span> <span style="color:#00a8c8">false</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">failOnError</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Failed to register a consumer&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">msg</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">msgs</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;get1: %s&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">msg</span><span style="color:#111">.</span><span style="color:#75af00">Body</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Sleep</span><span style="color:#111">(</span><span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Millisecond</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">500</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">get2</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">url</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Sprintf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;amqp://%s:%s@%s:%s%s&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">LOGIN</span><span style="color:#111">,</span> <span style="color:#75af00">PASSWORD</span><span style="color:#111">,</span> <span style="color:#75af00">HOST</span><span style="color:#111">,</span> <span style="color:#75af00">PORT</span><span style="color:#111">,</span> <span style="color:#75af00">VIRTUALHOST</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">conn</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">amqp</span><span style="color:#111">.</span><span style="color:#75af00">Dial</span><span style="color:#111">(</span><span style="color:#75af00">url</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">failOnError</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Failed to connect to RabbitMQ&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">conn</span><span style="color:#111">.</span><span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ch</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">conn</span><span style="color:#111">.</span><span style="color:#75af00">Channel</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">failOnError</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Failed to open a channel&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">ch</span><span style="color:#111">.</span><span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">ch</span><span style="color:#111">.</span><span style="color:#75af00">ExchangeDeclare</span><span style="color:#111">(</span><span style="color:#d88200">&#34;testTopic&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">amqp</span><span style="color:#111">.</span><span style="color:#75af00">ExchangeTopic</span><span style="color:#111">,</span> <span style="color:#00a8c8">true</span><span style="color:#111">,</span> <span style="color:#00a8c8">false</span><span style="color:#111">,</span> <span style="color:#00a8c8">false</span><span style="color:#111">,</span> <span style="color:#00a8c8">false</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">failOnError</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Failed to declare an exchange&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">q</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">ch</span><span style="color:#111">.</span><span style="color:#75af00">QueueDeclare</span><span style="color:#111">(</span><span style="color:#d88200">&#34;testTopic_get2&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">false</span><span style="color:#111">,</span> <span style="color:#00a8c8">false</span><span style="color:#111">,</span> <span style="color:#00a8c8">false</span><span style="color:#111">,</span> <span style="color:#00a8c8">false</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">failOnError</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Failed to declare a queue&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">ch</span><span style="color:#111">.</span><span style="color:#75af00">QueueBind</span><span style="color:#111">(</span><span style="color:#75af00">q</span><span style="color:#111">.</span><span style="color:#75af00">Name</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;#&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;testTopic&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">false</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">failOnError</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Failed to bind a queue&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">msgs</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">ch</span><span style="color:#111">.</span><span style="color:#75af00">Consume</span><span style="color:#111">(</span><span style="color:#75af00">q</span><span style="color:#111">.</span><span style="color:#75af00">Name</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;get2&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">true</span><span style="color:#111">,</span> <span style="color:#00a8c8">false</span><span style="color:#111">,</span> <span style="color:#00a8c8">false</span><span style="color:#111">,</span> <span style="color:#00a8c8">false</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">failOnError</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Failed to register a consumer&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">msg</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">msgs</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;get2: %s&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">msg</span><span style="color:#111">.</span><span style="color:#75af00">Body</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Sleep</span><span style="color:#111">(</span><span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Millisecond</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">500</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">failOnError</span><span style="color:#111">(</span><span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span><span style="color:#111">,</span> <span style="color:#75af00">msg</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Fatalf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;%s: %s&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">msg</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">go</span> <span style="color:#75af00">publish</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">go</span> <span style="color:#75af00">get1</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">go</span> <span style="color:#75af00">get2</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Sleep</span><span style="color:#111">(</span><span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Second</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">20</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">结果：
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">发布成功!
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">2021/08/31 22:45:09 get1: time:2021-08-31 22:45:09.017664 +0800 CST m=+0.012626409
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">发布成功!
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">2021/08/31 22:45:10 get2: time:2021-08-31 22:45:10.022005 +0800 CST m=+1.016996649
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">2021/08/31 22:45:10 get1: time:2021-08-31 22:45:10.022005 +0800 CST m=+1.016996649
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">发布成功!
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">2021/08/31 22:45:11 get2: time:2021-08-31 22:45:11.023542 +0800 CST m=+2.018558384
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">2021/08/31 22:45:11 get1: time:2021-08-31 22:45:11.023542 +0800 CST m=+2.018558384
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">发布成功!
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">2021/08/31 22:45:12 get1: time:2021-08-31 22:45:12.028649 +0800 CST m=+3.023687209
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">2021/08/31 22:45:12 get2: time:2021-08-31 22:45:12.028649 +0800 CST m=+3.023687209
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">发布成功!
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">2021/08/31 22:45:13 get2: time:2021-08-31 22:45:13.033497 +0800 CST m=+4.028553608
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">2021/08/31 22:45:13 get1: time:2021-08-31 22:45:13.033497 +0800 CST m=+4.028553608
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">发布成功!
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">2021/08/31 22:45:14 get1: time:2021-08-31 22:45:14.03647 +0800 CST m=+5.031571881
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">2021/08/31 22:45:14 get2: time:2021-08-31 22:45:14.03647 +0800 CST m=+5.031571881
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">发布成功!
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">2021/08/31 22:45:15 get2: time:2021-08-31 22:45:15.036783 +0800 CST m=+6.031867631
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">2021/08/31 22:45:15 get1: time:2021-08-31 22:45:15.036783 +0800 CST m=+6.031867631
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">发布成功!
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">2021/08/31 22:45:16 get2: time:2021-08-31 22:45:16.041189 +0800 CST m=+7.036283180
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">2021/08/31 22:45:16 get1: time:2021-08-31 22:45:16.041189 +0800 CST m=+7.036283180
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">发布成功!
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">2021/08/31 22:45:17 get1: time:2021-08-31 22:45:17.043382 +0800 CST m=+8.038484117
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">2021/08/31 22:45:17 get2: time:2021-08-31 22:45:17.043382 +0800 CST m=+8.038484117
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">发布成功!
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">2021/08/31 22:45:18 get1: time:2021-08-31 22:45:18.04643 +0800 CST m=+9.041536815
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">2021/08/31 22:45:18 get2: time:2021-08-31 22:45:18.04643 +0800 CST m=+9.041536815
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span></code></pre></div><h2 id="延迟队列">延迟队列</h2>
<h3 id="什么是延迟队列">什么是延迟队列</h3>
<p><code>延时队列</code>，首先，它是一种队列，队列意味着内部的元素是<code>有序</code>的，元素出队和入队是有方向性的，元素从一端进入，从另一端取出。</p>
<p>其次，<code>延时队列</code>，最重要的特性就体现在它的<code>延时</code>属性上，跟普通的队列不一样的是，<code>普通队列中的元素总是等着希望被早点取出处理，而延时队列中的元素则是希望被在指定时间得到取出和处理</code>，所以延时队列中的元素是都是带时间属性的，通常来说是需要被处理的消息或者任务。</p>
<p>简单来说，延时队列就是用来存放需要在指定时间被处理的元素的队列。</p>
<h3 id="使用场景">使用场景</h3>
<ol>
<li>订单在十分钟之内未支付则自动取消。</li>
<li>新创建的店铺，如果在十天内都没有上传过商品，则自动发送消息提醒。</li>
<li>账单在一周内未支付，则自动结算。</li>
<li>用户注册成功后，如果三天内没有登陆则进行短信提醒。</li>
<li>用户发起退款，如果三天内没有得到处理则通知相关运营人员。</li>
<li>预定会议后，需要在预定的时间点前十分钟通知各个与会人员参加会议。</li>
</ol>
<h3 id="rabbitmq中的ttl">rabbitMQ中的TTL</h3>
<p>在介绍延时队列之前，还需要先介绍一下RabbitMQ中的一个高级特性——<code>TTL（Time To Live）</code>。</p>
<p><code>TTL</code>是什么呢？<code>TTL</code>是RabbitMQ中一个消息或者队列的属性，表明<code>一条消息或者该队列中的所有消息的最大存活时间</code>，单位是毫秒。换句话说，如果一条消息设置了TTL属性或者进入了设置TTL属性的队列，那么这条消息如果在TTL设置的时间内没有被消费，则会成为“死信”。如果同时配置了队列的TTL和消息的TTL，那么较小的那个值将会被使用。</p>
<h3 id="如何利用rabbitmq实现延迟队列">如何利用rabbitMQ实现延迟队列</h3>
<p>想想看，<code>延时队列</code>，不就是想要消息延迟多久被处理吗，TTL则刚好能让消息在延迟多久之后成为死信，另一方面，成为死信的消息都会被投递到死信队列里，这样只需要消费者一直消费死信队列里的消息就万事大吉了，因为里面的消息都是希望被立即处理的消息。</p>
<p>从下图可以大致看出消息的流向：</p>
<p><img src="/images/47f80fb8-4a5d-4f84-bd2c-21fac99107a0.png" alt=""></p>
<p>生产者生产一条延时消息，根据需要延时时间的不同，利用不同的routingkey将消息路由到不同的延时队列，每个队列都设置了不同的TTL属性，并绑定在同一个死信交换机中，消息过期后，根据routingkey的不同，又会被路由到不同的死信队列中，消费者只需要监听对应的死信队列进行处理即可。</p>
<p><strong>go实现</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;github.com/streadway/amqp&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">const</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">LOGIN</span>       <span style="color:#00a8c8">string</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;zhaohaiyu&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">PASSWORD</span>    <span style="color:#00a8c8">string</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;zhy.1996&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">HOST</span>        <span style="color:#00a8c8">string</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;127.0.0.1&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">PORT</span>        <span style="color:#00a8c8">string</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;5672&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">VIRTUALHOST</span> <span style="color:#00a8c8">string</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;/&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">publish</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">url</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Sprintf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;amqp://%s:%s@%s:%s%s&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">LOGIN</span><span style="color:#111">,</span> <span style="color:#75af00">PASSWORD</span><span style="color:#111">,</span> <span style="color:#75af00">HOST</span><span style="color:#111">,</span> <span style="color:#75af00">PORT</span><span style="color:#111">,</span> <span style="color:#75af00">VIRTUALHOST</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">conn</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">amqp</span><span style="color:#111">.</span><span style="color:#75af00">Dial</span><span style="color:#111">(</span><span style="color:#75af00">url</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">failOnError</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Failed to connect to RabbitMQ&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">conn</span><span style="color:#111">.</span><span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ch</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">conn</span><span style="color:#111">.</span><span style="color:#75af00">Channel</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">failOnError</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Failed to open a channel&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">ch</span><span style="color:#111">.</span><span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">ch</span><span style="color:#111">.</span><span style="color:#75af00">ExchangeDeclare</span><span style="color:#111">(</span><span style="color:#d88200">&#34;testTopic&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">amqp</span><span style="color:#111">.</span><span style="color:#75af00">ExchangeTopic</span><span style="color:#111">,</span> <span style="color:#00a8c8">true</span><span style="color:#111">,</span> <span style="color:#00a8c8">false</span><span style="color:#111">,</span> <span style="color:#00a8c8">false</span><span style="color:#111">,</span> <span style="color:#00a8c8">false</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">failOnError</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Failed to declare an exchange&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span><span style="color:#111">;</span> <span style="color:#75af00">i</span> <span style="color:#111">&lt;</span> <span style="color:#ae81ff">10</span><span style="color:#111">;</span> <span style="color:#75af00">i</span><span style="color:#f92672">++</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">ch</span><span style="color:#111">.</span><span style="color:#75af00">Publish</span><span style="color:#111">(</span><span style="color:#d88200">&#34;testTopic&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;yuemoxi&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">false</span><span style="color:#111">,</span> <span style="color:#00a8c8">false</span><span style="color:#111">,</span> <span style="color:#75af00">amqp</span><span style="color:#111">.</span><span style="color:#75af00">Publishing</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">ContentType</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;text/plain&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">Body</span><span style="color:#111">:</span>        <span style="color:#111">[]</span><span style="color:#111">byte</span><span style="color:#111">(</span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Sprintf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;time:%v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Now</span><span style="color:#111">())),</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">Expiration</span><span style="color:#111">:</span>  <span style="color:#d88200">&#34;600000&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;发布成功!&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Sleep</span><span style="color:#111">(</span><span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Second</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">get2</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">url</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Sprintf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;amqp://%s:%s@%s:%s%s&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">LOGIN</span><span style="color:#111">,</span> <span style="color:#75af00">PASSWORD</span><span style="color:#111">,</span> <span style="color:#75af00">HOST</span><span style="color:#111">,</span> <span style="color:#75af00">PORT</span><span style="color:#111">,</span> <span style="color:#75af00">VIRTUALHOST</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">conn</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">amqp</span><span style="color:#111">.</span><span style="color:#75af00">Dial</span><span style="color:#111">(</span><span style="color:#75af00">url</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">failOnError</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Failed to connect to RabbitMQ&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">conn</span><span style="color:#111">.</span><span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ch</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">conn</span><span style="color:#111">.</span><span style="color:#75af00">Channel</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">failOnError</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Failed to open a channel&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">ch</span><span style="color:#111">.</span><span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">ch</span><span style="color:#111">.</span><span style="color:#75af00">ExchangeDeclare</span><span style="color:#111">(</span><span style="color:#d88200">&#34;testTopic&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">amqp</span><span style="color:#111">.</span><span style="color:#75af00">ExchangeTopic</span><span style="color:#111">,</span> <span style="color:#00a8c8">true</span><span style="color:#111">,</span> <span style="color:#00a8c8">false</span><span style="color:#111">,</span> <span style="color:#00a8c8">false</span><span style="color:#111">,</span> <span style="color:#00a8c8">false</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">failOnError</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Failed to declare an exchange&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">q</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">ch</span><span style="color:#111">.</span><span style="color:#75af00">QueueDeclare</span><span style="color:#111">(</span><span style="color:#d88200">&#34;testTopic_get2&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">false</span><span style="color:#111">,</span> <span style="color:#00a8c8">false</span><span style="color:#111">,</span> <span style="color:#00a8c8">false</span><span style="color:#111">,</span> <span style="color:#00a8c8">false</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">failOnError</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Failed to declare a queue&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//声明延时队列队列，该队列中消息如果过期，就将消息发送到交换器上，交换器就分发消息到普通队列</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">q1</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">ch</span><span style="color:#111">.</span><span style="color:#75af00">QueueDeclare</span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#d88200">&#34;test_delay&#34;</span><span style="color:#111">,</span> <span style="color:#75715e">//队列名</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">true</span><span style="color:#111">,</span>         <span style="color:#75715e">//持久化</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">false</span><span style="color:#111">,</span>        <span style="color:#75715e">//不用时是否自动删除</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">true</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">false</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">amqp</span><span style="color:#111">.</span><span style="color:#75af00">Table</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">//当消息过期时把消息发送到logs这个交换器</span>
</span></span><span style="display:flex;"><span>			<span style="color:#d88200">&#34;x-dead-letter-exchange&#34;</span><span style="color:#111">:</span>    <span style="color:#d88200">&#34;ttlTopic&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#d88200">&#34;x-dead-letter-routing-key&#34;</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;ttlKey&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">},</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">failOnError</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Failed to bind a queue&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">ch</span><span style="color:#111">.</span><span style="color:#75af00">QueueBind</span><span style="color:#111">(</span><span style="color:#75af00">q</span><span style="color:#111">.</span><span style="color:#75af00">Name</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;#&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;testTopic&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">false</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">failOnError</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Failed to bind a queue&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">ch</span><span style="color:#111">.</span><span style="color:#75af00">QueueBind</span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">q1</span><span style="color:#111">.</span><span style="color:#75af00">Name</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#d88200">&#34;ttlKey&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#d88200">&#34;ttlTopic&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">false</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">nil</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">msgs</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">ch</span><span style="color:#111">.</span><span style="color:#75af00">Consume</span><span style="color:#111">(</span><span style="color:#75af00">q</span><span style="color:#111">.</span><span style="color:#75af00">Name</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;get2&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">true</span><span style="color:#111">,</span> <span style="color:#00a8c8">false</span><span style="color:#111">,</span> <span style="color:#00a8c8">false</span><span style="color:#111">,</span> <span style="color:#00a8c8">false</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">failOnError</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Failed to register a consumer&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">msg</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">msgs</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;get2: %s&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">msg</span><span style="color:#111">.</span><span style="color:#75af00">Body</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Sleep</span><span style="color:#111">(</span><span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Millisecond</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">500</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">failOnError</span><span style="color:#111">(</span><span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span><span style="color:#111">,</span> <span style="color:#75af00">msg</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Fatalf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;%s: %s&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">msg</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">go</span> <span style="color:#75af00">publish</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">go</span> <span style="color:#75af00">get2</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Sleep</span><span style="color:#111">(</span><span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Second</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">20</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="参考文章">参考文章</h2>
<ul>
<li><a href="https://juejin.cn/post/6916148736414466061">https://juejin.cn/post/6916148736414466061</a></li>
<li><a href="https://www.rabbitmq.com/getstarted.html">rabbitmq官网</a></li>
<li><a href="https://www.cnblogs.com/mfrank/p/11260355.html">https://www.cnblogs.com/mfrank/p/11260355.html</a></li>
</ul>
]]></content:encoded><category>database</category><category>RabbitMQ</category></item><item><title>redis发布订阅</title><link>https://daemon365.dev/post/database/redis_publish_subscribe/</link><pubDate>Sat, 20 Aug 2022 00:00:00 +0800</pubDate><guid>https://daemon365.dev/post/database/redis_publish_subscribe/</guid><description>&lt;h2 id="什么是发布和订阅"&gt;什么是发布和订阅&lt;/h2&gt;
&lt;p&gt;Redis 发布订阅 (pub/sub) 是一种消息通信模式：发送者 (pub) 发送消息，订阅者 (sub) 接收消息。&lt;/p&gt;
&lt;p&gt;Redis 客户端可以订阅任意数量的频道。&lt;/p&gt;
&lt;h2 id="发布和订阅"&gt;发布和订阅&lt;/h2&gt;
&lt;p&gt;1、客户端可以订阅频道如下图&lt;/p&gt;
&lt;p&gt;&lt;img src="https://daemon365.dev/images/96a0c4ca-666f-475e-8dd0-bfbd37f4dbb6.png" alt=""&gt;&lt;/p&gt;
&lt;p&gt;2、当给这个频道发布消息后，消息就会发送给订阅的客户端&lt;/p&gt;
&lt;p&gt;&lt;img src="https://daemon365.dev/images/0c0ca636-05df-4d97-b2fe-fc3d48fba4aa.png" alt=""&gt;&lt;/p&gt;
&lt;h2 id="发布订阅命令行实现"&gt;发布订阅命令行实现&lt;/h2&gt;
&lt;p&gt;1、 打开一个客户端订阅channel1&lt;/p&gt;
&lt;p&gt;SUBSCRIBE channel1&lt;/p&gt;
&lt;p&gt;&lt;img src="https://daemon365.dev/images/8218b975-9bf5-4f05-afc9-675107cd6362.png" alt=""&gt;&lt;/p&gt;
&lt;p&gt;2、打开另一个客户端，给channel1发布消息hello&lt;/p&gt;
&lt;p&gt;publish channel1 hello&lt;/p&gt;
&lt;p&gt;&lt;img src="https://daemon365.dev/images/3948289f-dcd0-4f46-8b0d-b286f7cee2dd.png" alt=""&gt;&lt;/p&gt;
&lt;p&gt;返回的1是订阅者数量&lt;/p&gt;
&lt;p&gt;3、打开第一个客户端可以看到发送的消息&lt;/p&gt;
&lt;p&gt;&lt;img src="https://daemon365.dev/images/5196ef36-5138-45a4-b6d4-b299b4dc5933.png" alt=""&gt;&lt;/p&gt;
&lt;p&gt;注：发布的消息没有持久化，如果在订阅的客户端收不到hello，只能收到订阅后发布的消息&lt;/p&gt;</description><content:encoded><![CDATA[<h2 id="什么是发布和订阅">什么是发布和订阅</h2>
<p>Redis 发布订阅 (pub/sub) 是一种消息通信模式：发送者 (pub) 发送消息，订阅者 (sub) 接收消息。</p>
<p>Redis 客户端可以订阅任意数量的频道。</p>
<h2 id="发布和订阅">发布和订阅</h2>
<p>1、客户端可以订阅频道如下图</p>
<p><img src="/images/96a0c4ca-666f-475e-8dd0-bfbd37f4dbb6.png" alt=""></p>
<p>2、当给这个频道发布消息后，消息就会发送给订阅的客户端</p>
<p><img src="/images/0c0ca636-05df-4d97-b2fe-fc3d48fba4aa.png" alt=""></p>
<h2 id="发布订阅命令行实现">发布订阅命令行实现</h2>
<p>1、 打开一个客户端订阅channel1</p>
<p>SUBSCRIBE channel1</p>
<p><img src="/images/8218b975-9bf5-4f05-afc9-675107cd6362.png" alt=""></p>
<p>2、打开另一个客户端，给channel1发布消息hello</p>
<p>publish channel1 hello</p>
<p><img src="/images/3948289f-dcd0-4f46-8b0d-b286f7cee2dd.png" alt=""></p>
<p>返回的1是订阅者数量</p>
<p>3、打开第一个客户端可以看到发送的消息</p>
<p><img src="/images/5196ef36-5138-45a4-b6d4-b299b4dc5933.png" alt=""></p>
<p>注：发布的消息没有持久化，如果在订阅的客户端收不到hello，只能收到订阅后发布的消息</p>
]]></content:encoded><category>database</category><category>redis</category></item><item><title>SQL查询语句执行流程</title><link>https://daemon365.dev/post/database/sql_query_statement_execution_process/</link><pubDate>Thu, 21 May 2020 00:00:00 +0800</pubDate><guid>https://daemon365.dev/post/database/sql_query_statement_execution_process/</guid><description>&lt;h2 id="msyql执行流程"&gt;msyql执行流程&lt;/h2&gt;
&lt;p&gt;你有个最简单的表，表里只有一个 ID 字段，在执行下面这个查询语句时：：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-sql" data-lang="sql"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;select&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;from&lt;/span&gt; &lt;span style="color:#111"&gt;T&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;where&lt;/span&gt; &lt;span style="color:#111"&gt;ID&lt;/span&gt;&lt;span style="color:#f92672"&gt;=&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;10&lt;/span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;；&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;我们看到的只是输入一条语句，返回一个结果，却不知道这条语句在 MySQL 内部的执行过程。&lt;/p&gt;
&lt;p&gt;下面我给出的是 MySQL 的基本架构示意图，从中你可以清楚地看到 SQL 语句在 MySQL 的各个功能模块中的执行过程。&lt;/p&gt;
&lt;p&gt;&lt;img src="https://daemon365.dev/images/38d96a46-fa16-4ba4-8387-a766566d030d.png" alt=""&gt;&lt;/p&gt;
&lt;p&gt;大体上，MySQL 分为 Server 层和存储引擎层两部分。&lt;/p&gt;
&lt;p&gt;Server 层包括连接器、查询缓存、分析器、执行器等，以及所有的内置函数（如日期、时间、数学和加密函数等）和跨存储引擎的功能（如存储过程、触发器、视图）。&lt;/p&gt;
&lt;p&gt;存储引擎层负责数据的存储和提取，支持 InnoDB、MyISAM、Memory 等多个存储引擎。MySQL 5.5.5 版本后默认存储存储引擎是 InnoDB。&lt;/p&gt;
&lt;h2 id="连接器"&gt;连接器&lt;/h2&gt;
&lt;ol&gt;
&lt;li&gt;验证账号密码是否正确&lt;/li&gt;
&lt;li&gt;到权限表里面查出你拥有的权限，之后的执行语句，都会依赖这个权限数据。&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id="查询缓存"&gt;查询缓存&lt;/h2&gt;
&lt;p&gt;在建立连接后，就开始执行 select 语句了，执行前首先会查询缓存。&lt;/p&gt;
&lt;p&gt;MySQL 拿到查询请求后，会先查询缓存，看是不是执行过这条语句。执行过的语句及其结果会以 key-value 对的形式保存在一定的内存区域中。key 是查询的语句，value 是查询的结果。如果你的查询能够直接在这个缓存中找到 key，那么这个value 就会被直接返回给客户端。&lt;/p&gt;
&lt;p&gt;如果语句不在查询缓存中，就会继续后面的执行阶段。执行完成后，执行结果会被存入查询缓存中。如果查询命中缓存，MySQL 不需要执行后面的复杂操作，就可以直接返回结果，会提升效率。&lt;/p&gt;
&lt;p&gt;但是查询缓存的失效非常频繁，只要有对一个表的更新，这个表上所有的查询缓存都会被清空。对于更新压力大的数据库来说，查询缓存的命中率会非常低。如果业务中需要有一张静态表，很长时间才会更新一次。比如，一个系统配置表，那这张表上的查询才适合使用查询缓存。MySQL 提供了这种按需使用的方式。可以将参数 query_cache_type 设置成 DEMAND，对于默认的 SQL 语句都将不使用查询缓存。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;MySQL 8.0 版本将查询缓存的功能删除了。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id="分析器"&gt;分析器&lt;/h2&gt;
&lt;p&gt;如果没有命中查询缓存，就要开始真正执行语句了。首先，MySQL 需要知道你要做什么，因此需要对 SQL 语句做解析。&lt;/p&gt;
&lt;p&gt;分析器先会做“词法分析”。你输入的是由多个字符串和空格组成的一条 SQL 语句，MySQL 需要识别出里面的字符串分别是什么，代表什么。MySQL 从你输入的&amp;quot;select&amp;quot;这个关键字识别出来，这是一个查询语句。它也要把字符串“T”识别成“表名 T”，把字符串“ID”识别成“列 ID”。做完了这些识别以后，就要做“语法分析”。根据词法分析的结果，语法分析器会根据语法规则，判断你输入的这个 SQL 语句是否满足 MySQL 语法。&lt;/p&gt;</description><content:encoded><![CDATA[<h2 id="msyql执行流程">msyql执行流程</h2>
<p>你有个最简单的表，表里只有一个 ID 字段，在执行下面这个查询语句时：：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#00a8c8">select</span> <span style="color:#f92672">*</span> <span style="color:#00a8c8">from</span> <span style="color:#111">T</span> <span style="color:#00a8c8">where</span> <span style="color:#111">ID</span><span style="color:#f92672">=</span><span style="color:#ae81ff">10</span><span style="color:#960050;background-color:#1e0010">；</span>
</span></span></code></pre></div><p>我们看到的只是输入一条语句，返回一个结果，却不知道这条语句在 MySQL 内部的执行过程。</p>
<p>下面我给出的是 MySQL 的基本架构示意图，从中你可以清楚地看到 SQL 语句在 MySQL 的各个功能模块中的执行过程。</p>
<p><img src="/images/38d96a46-fa16-4ba4-8387-a766566d030d.png" alt=""></p>
<p>大体上，MySQL 分为 Server 层和存储引擎层两部分。</p>
<p>Server 层包括连接器、查询缓存、分析器、执行器等，以及所有的内置函数（如日期、时间、数学和加密函数等）和跨存储引擎的功能（如存储过程、触发器、视图）。</p>
<p>存储引擎层负责数据的存储和提取，支持 InnoDB、MyISAM、Memory 等多个存储引擎。MySQL 5.5.5 版本后默认存储存储引擎是 InnoDB。</p>
<h2 id="连接器">连接器</h2>
<ol>
<li>验证账号密码是否正确</li>
<li>到权限表里面查出你拥有的权限，之后的执行语句，都会依赖这个权限数据。</li>
</ol>
<h2 id="查询缓存">查询缓存</h2>
<p>在建立连接后，就开始执行 select 语句了，执行前首先会查询缓存。</p>
<p>MySQL 拿到查询请求后，会先查询缓存，看是不是执行过这条语句。执行过的语句及其结果会以 key-value 对的形式保存在一定的内存区域中。key 是查询的语句，value 是查询的结果。如果你的查询能够直接在这个缓存中找到 key，那么这个value 就会被直接返回给客户端。</p>
<p>如果语句不在查询缓存中，就会继续后面的执行阶段。执行完成后，执行结果会被存入查询缓存中。如果查询命中缓存，MySQL 不需要执行后面的复杂操作，就可以直接返回结果，会提升效率。</p>
<p>但是查询缓存的失效非常频繁，只要有对一个表的更新，这个表上所有的查询缓存都会被清空。对于更新压力大的数据库来说，查询缓存的命中率会非常低。如果业务中需要有一张静态表，很长时间才会更新一次。比如，一个系统配置表，那这张表上的查询才适合使用查询缓存。MySQL 提供了这种按需使用的方式。可以将参数 query_cache_type 设置成 DEMAND，对于默认的 SQL 语句都将不使用查询缓存。</p>
<blockquote>
<p>MySQL 8.0 版本将查询缓存的功能删除了。</p>
</blockquote>
<h2 id="分析器">分析器</h2>
<p>如果没有命中查询缓存，就要开始真正执行语句了。首先，MySQL 需要知道你要做什么，因此需要对 SQL 语句做解析。</p>
<p>分析器先会做“词法分析”。你输入的是由多个字符串和空格组成的一条 SQL 语句，MySQL 需要识别出里面的字符串分别是什么，代表什么。MySQL 从你输入的&quot;select&quot;这个关键字识别出来，这是一个查询语句。它也要把字符串“T”识别成“表名 T”，把字符串“ID”识别成“列 ID”。做完了这些识别以后，就要做“语法分析”。根据词法分析的结果，语法分析器会根据语法规则，判断你输入的这个 SQL 语句是否满足 MySQL 语法。</p>
<p>如果你的语句不对，就会收到“You have an error in your SQL syntax”的错误提醒，比如下面这个语句 select 少打了开头的字母“s”。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">elect</span> <span style="color:#f92672">*</span> <span style="color:#00a8c8">from</span> <span style="color:#111">t</span> <span style="color:#00a8c8">where</span> <span style="color:#111">ID</span><span style="color:#f92672">=</span><span style="color:#ae81ff">1</span><span style="color:#111">;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">ERROR 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near &#39;elect * from t where ID=1&#39; at line 1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span></code></pre></div><h2 id="优化器">优化器</h2>
<p>经过了分析器，MySQL 就知道你要做什么了。在开始执行之前，还要先经过优化器的处理。</p>
<p>优化器是在表里面有多个索引的时候，决定使用哪个索引；或者在一个语句有多表关联（join）的时候，决定各个表的连接顺序。比如你执行下面这样的语句，这个语句是执行两个表的 join：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#00a8c8">select</span> <span style="color:#f92672">*</span> <span style="color:#00a8c8">from</span> <span style="color:#111">t1</span> <span style="color:#00a8c8">join</span> <span style="color:#111">t2</span> <span style="color:#00a8c8">using</span><span style="color:#111">(</span><span style="color:#111">ID</span><span style="color:#111">)</span>  <span style="color:#00a8c8">where</span> <span style="color:#111">t1</span><span style="color:#111">.</span><span style="color:#00a8c8">c</span><span style="color:#f92672">=</span><span style="color:#ae81ff">10</span> <span style="color:#00a8c8">and</span> <span style="color:#111">t2</span><span style="color:#111">.</span><span style="color:#111">d</span><span style="color:#f92672">=</span><span style="color:#ae81ff">20</span><span style="color:#111">;</span>
</span></span></code></pre></div><ul>
<li>既可以先从表 t1 里面取出 c=10 的记录的 ID 值，再根据 ID 值关联到表 t2，再判断 t2 里面 d 的值是否等于 20。</li>
<li>也可以先从表 t2 里面取出 d=20 的记录的 ID 值，再根据 ID 值关联到 t1，再判断 t1 里面 c 的值是否等于 10。</li>
</ul>
<h2 id="执行器">执行器</h2>
<p>MySQL 通过分析器知道了你要做什么，通过优化器知道了该怎么做，于是就进入了执行器阶段，开始执行语句。</p>
<p>开始执行的时候，要先判断一下你对这个表 T 有没有执行查询的权限，如果没有，就会返回没有权限的错误，如下所示 (在工程实现上，如果命中查询缓存，会在查询缓存返回结果的时候，做权限验证。查询也会在优化器之前调用 precheck 验证权限)。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#00a8c8">select</span> <span style="color:#f92672">*</span> <span style="color:#00a8c8">from</span> <span style="color:#111">T</span> <span style="color:#00a8c8">where</span> <span style="color:#111">ID</span><span style="color:#f92672">=</span><span style="color:#ae81ff">10</span><span style="color:#111">;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">ERROR 1142 (42000): SELECT command denied to user &#39;b&#39;@&#39;localhost&#39; for table &#39;T&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span></code></pre></div><p>如果有权限，就打开表继续执行。打开表的时候，执行器就会根据表的引擎定义，去使用这个引擎提供的接口。</p>
<p>比如我们这个例子中的表 T 中，ID 字段没有索引，那么执行器的执行流程是这样的：</p>
<ol>
<li>调用 InnoDB 引擎接口取这个表的第一行，判断 ID 值是不是 10，如果不是则跳过，如果是则将这行存在结果集中；</li>
<li>调用引擎接口取“下一行”，重复相同的判断逻辑，直到取到这个表的最后一行。</li>
<li>执行器将上述遍历过程中所有满足条件的行组成的记录集作为结果集返回给客户端。</li>
</ol>
<p>对于有索引的表，第一次调用的是取满足条件的第一行这个接口，之后循环取满足条件的下一行这个接口。</p>
<p>数据库的慢查询日志中有 rows_examined 字段，表示这个语句执行过程中扫描了多少行。这个值就是在执行器每次调用引擎获取数据行的时候累加的。在有些场景下，执行器调用一次，在引擎内部则扫描了多行，因此引擎扫描行数跟 rows_examined 并不是完全相同的。</p>
<h2 id="总结">总结</h2>
<p>主要通过对一个 SQL 语句完整执行过程进行讲解，介绍 MySQL 的逻辑架构，MySQL 主要包括连接器、查询缓存、分析器、优化器、执行器这几个模块。</p>
<h2 id="参考文章">参考文章</h2>
<ul>
<li><a href="https://time.geekbang.org/column/article/68319">https://time.geekbang.org/column/article/68319</a></li>
</ul>
]]></content:encoded><category>database</category><category>mysql</category></item><item><title>mysql索引</title><link>https://daemon365.dev/post/database/mysql_index/</link><pubDate>Mon, 20 Apr 2020 00:00:00 +0800</pubDate><guid>https://daemon365.dev/post/database/mysql_index/</guid><description>&lt;h2 id="什么是索引"&gt;什么是索引&lt;/h2&gt;
&lt;p&gt;一般的应用系统，都是读多写少。而且插入操作和一般的更新操作很少出现性能问题（因为有redo log锁cache缓存）。在生产环境中，我们遇到最多的，也是最容易出问题的，还是一些复杂的查询操作，因此对查询语句的优化显然是重中之重。说起加速查询，就不得不提到索引了。索引的核心思想就是&lt;strong&gt;加速查询&lt;/strong&gt;。&lt;/p&gt;
&lt;h2 id="索引的原理"&gt;索引的原理&lt;/h2&gt;
&lt;h3 id="索引原理"&gt;索引原理&lt;/h3&gt;
&lt;p&gt;索引的目的在于提高查询效率，可以类比字典，如果要查“mysql”这个单词，我们肯定需要定位到m字母，然后从下往下找到y字母，再找到剩下的sql。如果没有索引，那么你可能需要把所有单词看一遍才能找到你想要的，如果我想找到m开头的单词呢？或者ze开头的单词呢？是不是觉得如果没有索引，这个事情根本无法完成？&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;本质都是：通过不断地缩小想要获取数据的范围来筛选出最终想要的结果，同时把随机的事件变成顺序的事件，也就是说，有了这种索引机制，我们可以总是用同一种查找方式来锁定数据。&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;数据库也是一样，但显然要复杂许多，因为不仅面临着等值查询，还有范围查询(&amp;gt;、&amp;lt;、between、in)、模糊查询(like)、并集查询(or)等等。数据库应该选择怎么样的方式来应对所有的问题呢？我们回想字典的例子，能不能把数据分成段，然后分段查询呢？最简单的如果1000条数据，1到100分成第一段，101到200分成第二段，201到300分成第三段……这样查第250条数据，只要找第三段就可以了，一下子去除了90%的无效数据。但如果是1千万的记录呢，分成几段比较好？稍有算法基础的同学会想到搜索树，其平均复杂度是lgN，具有不错的查询性能。但这里我们忽略了一个关键的问题，复杂度模型是基于每次相同的操作成本来考虑的，数据库实现比较复杂，数据保存在磁盘上，而为了提高性能，每次又可以把部分数据读入内存来计算，因为我们知道访问磁盘的成本大概是访问内存的十万倍左右，所以简单的搜索树难以满足复杂的应用场景。&lt;/p&gt;
&lt;h3 id="磁盘io与预读"&gt;磁盘IO与预读&lt;/h3&gt;
&lt;p&gt;考虑到磁盘IO是非常高昂的操作，计算机操作系统做了一些优化，&lt;strong&gt;当一次IO时，不光把当前磁盘地址的数据，而是把相邻的数据也都读取到内存缓冲区内&lt;/strong&gt;，因为局部预读性原理告诉我们，当计算机访问一个地址的数据的时候，与其相邻的数据也会很快被访问到。每一次IO读取的数据我们称之为一页(page)。具体一页有多大数据跟操作系统有关，一般为4k或8k，也就是我们读取一页内的数据时候，实际上才发生了一次IO，这个理论对于索引的数据结构设计非常有帮助。&lt;/p&gt;
&lt;h4 id="索引的数据结构"&gt;索引的数据结构&lt;/h4&gt;
&lt;p&gt;前面讲了生活中索引的例子，索引的基本原理，数据库的复杂性，又讲了操作系统的相关知识，目的就是让大家了解，任何一种数据结构都不是凭空产生的，一定会有它的背景和使用场景，我们现在总结一下，我们需要这种数据结构能够做些什么，其实很简单，那就是：每次查找数据时把磁盘IO次数控制在一个很小的数量级，最好是常数数量级。那么我们就想到如果一个高度可控的多路搜索树是否能满足需求呢？就这样，b+树应运而生。&lt;/p&gt;
&lt;h2 id="详解b树"&gt;详解b+树&lt;/h2&gt;
&lt;p&gt;&lt;img src="https://daemon365.dev/images/d39ac7f7-0a67-4ce3-9d32-e2ae589d0a65.png" alt=""&gt;&lt;/p&gt;
&lt;p&gt;如上图，是一颗b+树，关于b+树的定义可以参见&lt;a href="http://zh.wikipedia.org/wiki/B%2B%E6%A0%91"&gt;B+树&lt;/a&gt;，这里只说一些重点，浅蓝色的块我们称之为一个磁盘块，可以看到每个磁盘块包含几个数据项（深蓝色所示）和指针（黄色所示），如磁盘块1包含数据项17和35，包含指针P1、P2、P3，P1表示小于17的磁盘块，P2表示在17和35之间的磁盘块，P3表示大于35的磁盘块。真实的数据存在于叶子节点即3、5、9、10、13、15、28、29、36、60、75、79、90、99。非叶子节点只不存储真实的数据，只存储指引搜索方向的数据项，如17、35并不真实存在于数据表中。&lt;/p&gt;
&lt;h3 id="b树的查找过程"&gt;b+树的查找过程&lt;/h3&gt;
&lt;p&gt;如图所示，如果要查找数据项29，那么首先会把磁盘块1由磁盘加载到内存，此时发生一次IO，在内存中用二分查找确定29在17和35之间，锁定磁盘块1的P2指针，内存时间因为非常短（相比磁盘的IO）可以忽略不计，通过磁盘块1的P2指针的磁盘地址把磁盘块3由磁盘加载到内存，发生第二次IO，29在26和30之间，锁定磁盘块3的P2指针，通过指针加载磁盘块8到内存，发生第三次IO，同时内存中做二分查找找到29，结束查询，总计三次IO。真实的情况是，3层的b+树可以表示上百万的数据，如果上百万的数据查找只需要三次IO，性能提高将是巨大的，如果没有索引，每个数据项都要发生一次IO，那么总共需要百万次的IO，显然成本非常非常高。&lt;/p&gt;
&lt;h3 id="b树性质"&gt;b+树性质&lt;/h3&gt;
&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;索引字段要尽量的小&lt;/strong&gt;：通过上面的分析，我们知道IO次数取决于b+数的高度h，假设当前数据表的数据为N，每个磁盘块的数据项的数量是m，则有h=㏒(m+1)N，当数据量N一定的情况下，m越大，h越小；而m = 磁盘块的大小 / 数据项的大小，磁盘块的大小也就是一个数据页的大小，是固定的，如果数据项占的空间越小，数据项的数量越多，树的高度越低。这就是为什么每个数据项，即索引字段要尽量的小，比如int占4字节，要比bigint8字节少一半。这也是为什么b+树要求把真实的数据放到叶子节点而不是内层节点，一旦放到内层节点，磁盘块的数据项会大幅度下降，导致树增高。当数据项等于1时将会退化成线性表。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;索引的最左匹配特性&lt;/strong&gt;：当b+树的数据项是复合的数据结构，比如(name,age,sex)的时候，b+数是按照从左到右的顺序来建立搜索树的，比如当(张三,20,F)这样的数据来检索的时候，b+树会优先比较name来确定下一步的所搜方向，如果name相同再依次比较age和sex，最后得到检索的数据；但当(20,F)这样的没有name的数据来的时候，b+树就不知道下一步该查哪个节点，因为建立搜索树的时候name就是第一个比较因子，必须要先根据name来搜索才能知道下一步去哪里查询。比如当(张三,F)这样的数据来检索时，b+树可以用name来指定搜索方向，但下一个字段age的缺失，所以只能把名字等于张三的数据都找到，然后再匹配性别是F的数据了， 这个是非常重要的性质，即索引的最左匹配特性。&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id="聚集索引与辅助索引"&gt;聚集索引与辅助索引&lt;/h2&gt;
&lt;p&gt;&lt;strong&gt;在数据库中，B+树的高度一般都在24层，这也就是说查找某一个键值的行记录时最多只需要24次IO，这倒不错。因为当前一般的机械硬盘每秒至少可以做100次IO，24次的IO意味着查询时间只需要0.02~0.04秒。&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;数据库中的B+树索引可以分为聚集索引（clustered index）和辅助索引（secondary index），&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;聚集索引与辅助索引相同的是：不管是聚集索引还是辅助索引，其内部都是B+树的形式，即高度是平衡的，叶子结点存放着所有的数据。&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;聚集索引与辅助索引不同的是：叶子结点存放的是否是一整行的信息&lt;/strong&gt;&lt;/p&gt;
&lt;h3 id="聚集索引"&gt;聚集索引&lt;/h3&gt;
&lt;ol&gt;
&lt;li&gt;InnoDB存储引擎表示索引组织表，即表中数据按照主键顺序存放。而聚集索引（clustered index）就是按照每张表的主键构造一棵B+树，同时叶子结点存放的即为整张表的行记录数据，也将聚集索引的叶子结点称为数据页。聚集索引的这个特性决定了索引组织表中数据也是索引的一部分。同B+树数据结构一样，每个数据页都通过一个双向链表来进行链接。&lt;/li&gt;
&lt;li&gt;如果未定义主键，MySQL取第一个唯一索引（unique）而且只含非空列（NOT NULL）作为主键，InnoDB使用它作为聚簇索引。&lt;/li&gt;
&lt;li&gt;如果没有这样的列，InnoDB就自己产生一个这样的ID值，它有六个字节，而且是隐藏的，使其作为聚簇索引。&lt;/li&gt;
&lt;li&gt;由于实际的数据页只能按照一棵B+树进行排序，因此每张表只能拥有一个聚集索引。在多少情况下，查询优化器倾向于采用聚集索引。因为聚集索引能够在B+树索引的叶子节点上直接找到数据。此外由于定义了数据的逻辑顺序，聚集索引能够特别快地访问针对范围值得查询。&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;img src="https://daemon365.dev/images/5eb91240-8ec1-42a0-93a9-7b2e2daf0d18.png" alt=""&gt;&lt;/p&gt;
&lt;h4 id="聚集索引的好处"&gt;聚集索引的好处&lt;/h4&gt;
&lt;ol&gt;
&lt;li&gt;它对主键的排序查找和范围查找速度非常快，叶子节点的数据就是用户所要查询的数据。如用户需要查找一张表，查询最后的10位用户信息，由于B+树索引是双向链表，所以用户可以快速找到最后一个数据页，并取出10条记录&lt;/li&gt;
&lt;li&gt;范围查询（range query），即如果要查找主键某一范围内的数据，通过叶子节点的上层中间节点就可以得到页的范围，之后直接读取数据页即可&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id="辅助索引"&gt;辅助索引&lt;/h3&gt;
&lt;ol&gt;
&lt;li&gt;表中除了聚集索引外其他索引都是辅助索引（Secondary Index，也称为非聚集索引），与聚集索引的区别是：辅助索引的叶子节点不包含行记录的全部数据。&lt;/li&gt;
&lt;li&gt;叶子节点除了包含键值以外，每个叶子节点中的索引行中还包含一个书签（bookmark）。该书签用来告诉InnoDB存储引擎去哪里可以找到与索引相对应的行数据。&lt;/li&gt;
&lt;li&gt;由于InnoDB存储引擎是索引组织表，因此InnoDB存储引擎的辅助索引的书签就是相应行数据的聚集索引键。如下图&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;img src="https://daemon365.dev/images/7044a313-fd53-4e99-aaa6-0cd3011ae7bc.png" alt=""&gt;&lt;/p&gt;
&lt;p&gt;辅助索引的存在并不影响数据在聚集索引中的组织，因此每张表上可以有多个辅助索引，但只能有一个聚集索引。当通过辅助索引来寻找数据时，InnoDB存储引擎会遍历辅助索引并通过叶子级别的指针获得只想主键索引的主键，然后再通过主键索引来找到一个完整的行记录。&lt;/p&gt;
&lt;p&gt;举例来说，如果在一棵高度为3的辅助索引树种查找数据，那需要对这个辅助索引树遍历3次找到指定主键，如果聚集索引树的高度同样为3，那么还需要对聚集索引树进行3次查找，最终找到一个完整的行数据所在的页，因此一共需要6次逻辑IO访问才能得到最终的一个数据页。&lt;/p&gt;
&lt;h2 id="mysql索引管理"&gt;MySQL索引管理&lt;/h2&gt;
&lt;h3 id="功能"&gt;功能&lt;/h3&gt;
&lt;ol&gt;
&lt;li&gt;索引的功能就是加速查找&lt;/li&gt;
&lt;li&gt;mysql中的primary key，unique，联合唯一也都是索引，这些索引除了加速查找以外，还有约束的功能&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id="mysql常用的索引"&gt;MySQL常用的索引&lt;/h3&gt;
&lt;p&gt;聚簇索引（主键索引）：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;加速查询&lt;/li&gt;
&lt;li&gt;存储所有数据&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;普通索引INDEX：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;加速查找&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;唯一索引：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;主键索引PRIMARY KEY：加速查找+约束（不为空、不能重复）&lt;/li&gt;
&lt;li&gt;唯一索引UNIQUE:加速查找+约束（不能重复）&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;联合索引：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;加速查找&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-sql" data-lang="sql"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;-&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;PRIMARY&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;KEY&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#111"&gt;id&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt;&lt;span style="color:#111"&gt;name&lt;/span&gt;&lt;span style="color:#111"&gt;):&lt;/span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;联合主键索引&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;-&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;UNIQUE&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#111"&gt;id&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt;&lt;span style="color:#111"&gt;name&lt;/span&gt;&lt;span style="color:#111"&gt;):&lt;/span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;联合唯一索引&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;-&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;INDEX&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#111"&gt;id&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt;&lt;span style="color:#111"&gt;name&lt;/span&gt;&lt;span style="color:#111"&gt;):&lt;/span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;联合普通索引&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;strong&gt;索引建议使用bTree 不建议使用hash索引&lt;/strong&gt;&lt;/p&gt;</description><content:encoded><![CDATA[<h2 id="什么是索引">什么是索引</h2>
<p>一般的应用系统，都是读多写少。而且插入操作和一般的更新操作很少出现性能问题（因为有redo log锁cache缓存）。在生产环境中，我们遇到最多的，也是最容易出问题的，还是一些复杂的查询操作，因此对查询语句的优化显然是重中之重。说起加速查询，就不得不提到索引了。索引的核心思想就是<strong>加速查询</strong>。</p>
<h2 id="索引的原理">索引的原理</h2>
<h3 id="索引原理">索引原理</h3>
<p>索引的目的在于提高查询效率，可以类比字典，如果要查“mysql”这个单词，我们肯定需要定位到m字母，然后从下往下找到y字母，再找到剩下的sql。如果没有索引，那么你可能需要把所有单词看一遍才能找到你想要的，如果我想找到m开头的单词呢？或者ze开头的单词呢？是不是觉得如果没有索引，这个事情根本无法完成？</p>
<p><strong>本质都是：通过不断地缩小想要获取数据的范围来筛选出最终想要的结果，同时把随机的事件变成顺序的事件，也就是说，有了这种索引机制，我们可以总是用同一种查找方式来锁定数据。</strong></p>
<p>数据库也是一样，但显然要复杂许多，因为不仅面临着等值查询，还有范围查询(&gt;、&lt;、between、in)、模糊查询(like)、并集查询(or)等等。数据库应该选择怎么样的方式来应对所有的问题呢？我们回想字典的例子，能不能把数据分成段，然后分段查询呢？最简单的如果1000条数据，1到100分成第一段，101到200分成第二段，201到300分成第三段……这样查第250条数据，只要找第三段就可以了，一下子去除了90%的无效数据。但如果是1千万的记录呢，分成几段比较好？稍有算法基础的同学会想到搜索树，其平均复杂度是lgN，具有不错的查询性能。但这里我们忽略了一个关键的问题，复杂度模型是基于每次相同的操作成本来考虑的，数据库实现比较复杂，数据保存在磁盘上，而为了提高性能，每次又可以把部分数据读入内存来计算，因为我们知道访问磁盘的成本大概是访问内存的十万倍左右，所以简单的搜索树难以满足复杂的应用场景。</p>
<h3 id="磁盘io与预读">磁盘IO与预读</h3>
<p>考虑到磁盘IO是非常高昂的操作，计算机操作系统做了一些优化，<strong>当一次IO时，不光把当前磁盘地址的数据，而是把相邻的数据也都读取到内存缓冲区内</strong>，因为局部预读性原理告诉我们，当计算机访问一个地址的数据的时候，与其相邻的数据也会很快被访问到。每一次IO读取的数据我们称之为一页(page)。具体一页有多大数据跟操作系统有关，一般为4k或8k，也就是我们读取一页内的数据时候，实际上才发生了一次IO，这个理论对于索引的数据结构设计非常有帮助。</p>
<h4 id="索引的数据结构">索引的数据结构</h4>
<p>前面讲了生活中索引的例子，索引的基本原理，数据库的复杂性，又讲了操作系统的相关知识，目的就是让大家了解，任何一种数据结构都不是凭空产生的，一定会有它的背景和使用场景，我们现在总结一下，我们需要这种数据结构能够做些什么，其实很简单，那就是：每次查找数据时把磁盘IO次数控制在一个很小的数量级，最好是常数数量级。那么我们就想到如果一个高度可控的多路搜索树是否能满足需求呢？就这样，b+树应运而生。</p>
<h2 id="详解b树">详解b+树</h2>
<p><img src="/images/d39ac7f7-0a67-4ce3-9d32-e2ae589d0a65.png" alt=""></p>
<p>如上图，是一颗b+树，关于b+树的定义可以参见<a href="http://zh.wikipedia.org/wiki/B%2B%E6%A0%91">B+树</a>，这里只说一些重点，浅蓝色的块我们称之为一个磁盘块，可以看到每个磁盘块包含几个数据项（深蓝色所示）和指针（黄色所示），如磁盘块1包含数据项17和35，包含指针P1、P2、P3，P1表示小于17的磁盘块，P2表示在17和35之间的磁盘块，P3表示大于35的磁盘块。真实的数据存在于叶子节点即3、5、9、10、13、15、28、29、36、60、75、79、90、99。非叶子节点只不存储真实的数据，只存储指引搜索方向的数据项，如17、35并不真实存在于数据表中。</p>
<h3 id="b树的查找过程">b+树的查找过程</h3>
<p>如图所示，如果要查找数据项29，那么首先会把磁盘块1由磁盘加载到内存，此时发生一次IO，在内存中用二分查找确定29在17和35之间，锁定磁盘块1的P2指针，内存时间因为非常短（相比磁盘的IO）可以忽略不计，通过磁盘块1的P2指针的磁盘地址把磁盘块3由磁盘加载到内存，发生第二次IO，29在26和30之间，锁定磁盘块3的P2指针，通过指针加载磁盘块8到内存，发生第三次IO，同时内存中做二分查找找到29，结束查询，总计三次IO。真实的情况是，3层的b+树可以表示上百万的数据，如果上百万的数据查找只需要三次IO，性能提高将是巨大的，如果没有索引，每个数据项都要发生一次IO，那么总共需要百万次的IO，显然成本非常非常高。</p>
<h3 id="b树性质">b+树性质</h3>
<ol>
<li><strong>索引字段要尽量的小</strong>：通过上面的分析，我们知道IO次数取决于b+数的高度h，假设当前数据表的数据为N，每个磁盘块的数据项的数量是m，则有h=㏒(m+1)N，当数据量N一定的情况下，m越大，h越小；而m = 磁盘块的大小 / 数据项的大小，磁盘块的大小也就是一个数据页的大小，是固定的，如果数据项占的空间越小，数据项的数量越多，树的高度越低。这就是为什么每个数据项，即索引字段要尽量的小，比如int占4字节，要比bigint8字节少一半。这也是为什么b+树要求把真实的数据放到叶子节点而不是内层节点，一旦放到内层节点，磁盘块的数据项会大幅度下降，导致树增高。当数据项等于1时将会退化成线性表。</li>
<li><strong>索引的最左匹配特性</strong>：当b+树的数据项是复合的数据结构，比如(name,age,sex)的时候，b+数是按照从左到右的顺序来建立搜索树的，比如当(张三,20,F)这样的数据来检索的时候，b+树会优先比较name来确定下一步的所搜方向，如果name相同再依次比较age和sex，最后得到检索的数据；但当(20,F)这样的没有name的数据来的时候，b+树就不知道下一步该查哪个节点，因为建立搜索树的时候name就是第一个比较因子，必须要先根据name来搜索才能知道下一步去哪里查询。比如当(张三,F)这样的数据来检索时，b+树可以用name来指定搜索方向，但下一个字段age的缺失，所以只能把名字等于张三的数据都找到，然后再匹配性别是F的数据了， 这个是非常重要的性质，即索引的最左匹配特性。</li>
</ol>
<h2 id="聚集索引与辅助索引">聚集索引与辅助索引</h2>
<p><strong>在数据库中，B+树的高度一般都在24层，这也就是说查找某一个键值的行记录时最多只需要24次IO，这倒不错。因为当前一般的机械硬盘每秒至少可以做100次IO，24次的IO意味着查询时间只需要0.02~0.04秒。</strong></p>
<p><strong>数据库中的B+树索引可以分为聚集索引（clustered index）和辅助索引（secondary index），</strong></p>
<p><strong>聚集索引与辅助索引相同的是：不管是聚集索引还是辅助索引，其内部都是B+树的形式，即高度是平衡的，叶子结点存放着所有的数据。</strong></p>
<p><strong>聚集索引与辅助索引不同的是：叶子结点存放的是否是一整行的信息</strong></p>
<h3 id="聚集索引">聚集索引</h3>
<ol>
<li>InnoDB存储引擎表示索引组织表，即表中数据按照主键顺序存放。而聚集索引（clustered index）就是按照每张表的主键构造一棵B+树，同时叶子结点存放的即为整张表的行记录数据，也将聚集索引的叶子结点称为数据页。聚集索引的这个特性决定了索引组织表中数据也是索引的一部分。同B+树数据结构一样，每个数据页都通过一个双向链表来进行链接。</li>
<li>如果未定义主键，MySQL取第一个唯一索引（unique）而且只含非空列（NOT NULL）作为主键，InnoDB使用它作为聚簇索引。</li>
<li>如果没有这样的列，InnoDB就自己产生一个这样的ID值，它有六个字节，而且是隐藏的，使其作为聚簇索引。</li>
<li>由于实际的数据页只能按照一棵B+树进行排序，因此每张表只能拥有一个聚集索引。在多少情况下，查询优化器倾向于采用聚集索引。因为聚集索引能够在B+树索引的叶子节点上直接找到数据。此外由于定义了数据的逻辑顺序，聚集索引能够特别快地访问针对范围值得查询。</li>
</ol>
<p><img src="/images/5eb91240-8ec1-42a0-93a9-7b2e2daf0d18.png" alt=""></p>
<h4 id="聚集索引的好处">聚集索引的好处</h4>
<ol>
<li>它对主键的排序查找和范围查找速度非常快，叶子节点的数据就是用户所要查询的数据。如用户需要查找一张表，查询最后的10位用户信息，由于B+树索引是双向链表，所以用户可以快速找到最后一个数据页，并取出10条记录</li>
<li>范围查询（range query），即如果要查找主键某一范围内的数据，通过叶子节点的上层中间节点就可以得到页的范围，之后直接读取数据页即可</li>
</ol>
<h3 id="辅助索引">辅助索引</h3>
<ol>
<li>表中除了聚集索引外其他索引都是辅助索引（Secondary Index，也称为非聚集索引），与聚集索引的区别是：辅助索引的叶子节点不包含行记录的全部数据。</li>
<li>叶子节点除了包含键值以外，每个叶子节点中的索引行中还包含一个书签（bookmark）。该书签用来告诉InnoDB存储引擎去哪里可以找到与索引相对应的行数据。</li>
<li>由于InnoDB存储引擎是索引组织表，因此InnoDB存储引擎的辅助索引的书签就是相应行数据的聚集索引键。如下图</li>
</ol>
<p><img src="/images/7044a313-fd53-4e99-aaa6-0cd3011ae7bc.png" alt=""></p>
<p>辅助索引的存在并不影响数据在聚集索引中的组织，因此每张表上可以有多个辅助索引，但只能有一个聚集索引。当通过辅助索引来寻找数据时，InnoDB存储引擎会遍历辅助索引并通过叶子级别的指针获得只想主键索引的主键，然后再通过主键索引来找到一个完整的行记录。</p>
<p>举例来说，如果在一棵高度为3的辅助索引树种查找数据，那需要对这个辅助索引树遍历3次找到指定主键，如果聚集索引树的高度同样为3，那么还需要对聚集索引树进行3次查找，最终找到一个完整的行数据所在的页，因此一共需要6次逻辑IO访问才能得到最终的一个数据页。</p>
<h2 id="mysql索引管理">MySQL索引管理</h2>
<h3 id="功能">功能</h3>
<ol>
<li>索引的功能就是加速查找</li>
<li>mysql中的primary key，unique，联合唯一也都是索引，这些索引除了加速查找以外，还有约束的功能</li>
</ol>
<h3 id="mysql常用的索引">MySQL常用的索引</h3>
<p>聚簇索引（主键索引）：</p>
<ul>
<li>加速查询</li>
<li>存储所有数据</li>
</ul>
<p>普通索引INDEX：</p>
<ul>
<li>加速查找</li>
</ul>
<p>唯一索引：</p>
<ul>
<li>主键索引PRIMARY KEY：加速查找+约束（不为空、不能重复）</li>
<li>唯一索引UNIQUE:加速查找+约束（不能重复）</li>
</ul>
<p>联合索引：</p>
<ul>
<li>加速查找</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#f92672">-</span> <span style="color:#00a8c8">PRIMARY</span> <span style="color:#00a8c8">KEY</span><span style="color:#111">(</span><span style="color:#111">id</span><span style="color:#111">,</span><span style="color:#111">name</span><span style="color:#111">):</span><span style="color:#960050;background-color:#1e0010">联合主键索引</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">-</span> <span style="color:#00a8c8">UNIQUE</span><span style="color:#111">(</span><span style="color:#111">id</span><span style="color:#111">,</span><span style="color:#111">name</span><span style="color:#111">):</span><span style="color:#960050;background-color:#1e0010">联合唯一索引</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">-</span> <span style="color:#00a8c8">INDEX</span><span style="color:#111">(</span><span style="color:#111">id</span><span style="color:#111">,</span><span style="color:#111">name</span><span style="color:#111">):</span><span style="color:#960050;background-color:#1e0010">联合普通索引</span>
</span></span></code></pre></div><p><strong>索引建议使用bTree 不建议使用hash索引</strong></p>
<h2 id="创建删除索引的语法">创建/删除索引的语法</h2>
<ul>
<li>创建表时</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">CREATE TABLE 表名 (
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    字段名1  数据类型 [完整性约束条件…],
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    字段名2  数据类型 [完整性约束条件…],
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    [UNIQUE | FULLTEXT | SPATIAL ]   INDEX | KEY
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    [索引名]  (字段名[(长度)]  [ASC |DESC]) 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">);
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">create</span> <span style="color:#00a8c8">table</span> <span style="color:#111">t1</span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">id</span> <span style="color:#111">int</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">name</span> <span style="color:#111">char</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">age</span> <span style="color:#111">int</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">sex</span> <span style="color:#111">enum</span><span style="color:#111">(</span><span style="color:#d88200">&#39;male&#39;</span><span style="color:#111">,</span><span style="color:#d88200">&#39;female&#39;</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">unique</span> <span style="color:#00a8c8">key</span> <span style="color:#111">uni_id</span><span style="color:#111">(</span><span style="color:#111">id</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">index</span> <span style="color:#111">ix_name</span><span style="color:#111">(</span><span style="color:#111">name</span><span style="color:#111">)</span> <span style="color:#f92672">#</span> <span style="color:#111">index没有key</span>
</span></span><span style="display:flex;"><span><span style="color:#111">);</span>
</span></span></code></pre></div><ul>
<li>CREATE在已存在的表上创建索引</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">CREATE  [UNIQUE | FULLTEXT | SPATIAL ]  INDEX  索引名 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	ON 表名 (字段名[(长度)]  [ASC |DESC]) ;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">create</span> <span style="color:#00a8c8">index</span> <span style="color:#111">ix_age</span> <span style="color:#00a8c8">on</span> <span style="color:#111">t1</span><span style="color:#111">(</span><span style="color:#111">age</span><span style="color:#111">);</span>
</span></span></code></pre></div><ul>
<li>ALTER TABLE在已存在的表上创建索引</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">ALTER TABLE 表名 ADD  [UNIQUE | FULLTEXT | SPATIAL ] INDEX
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	索引名 (字段名[(长度)]  [ASC |DESC]) ;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">alter</span> <span style="color:#00a8c8">table</span> <span style="color:#111">t1</span> <span style="color:#00a8c8">add</span> <span style="color:#00a8c8">index</span> <span style="color:#111">ix_sex</span><span style="color:#111">(</span><span style="color:#111">sex</span><span style="color:#111">);</span>
</span></span></code></pre></div><ul>
<li>查看索引</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#00a8c8">show</span> <span style="color:#00a8c8">create</span> <span style="color:#00a8c8">table</span> <span style="color:#111">t1</span><span style="color:#111">;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">| t1    | CREATE TABLE `t1` (
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  `id` int(11) DEFAULT NULL,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  `name` char(1) DEFAULT NULL,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  `age` int(11) DEFAULT NULL,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  `sex` enum(&#39;male&#39;,&#39;female&#39;) DEFAULT NULL,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  UNIQUE KEY `uni_id` (`id`),
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  KEY `ix_name` (`name`),
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  KEY `ix_age` (`age`),
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  KEY `ix_sex` (`sex`)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">) ENGINE=InnoDB DEFAULT CHARSET=latin1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span></code></pre></div><ul>
<li>删除索引</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#00a8c8">DROP</span> <span style="color:#00a8c8">INDEX</span> <span style="color:#960050;background-color:#1e0010">索引名</span> <span style="color:#00a8c8">ON</span> <span style="color:#960050;background-color:#1e0010">表名字</span><span style="color:#111">;</span>
</span></span></code></pre></div><h2 id="查询优化神器---explain命令">查询优化神器 - explain命令</h2>
<p>关于explain命令相信大家并不陌生，具体用法和字段含义可以参考官网<a href="http://dev.mysql.com/doc/refman/5.5/en/explain-output.html">explain-output</a>，这里需要强调rows是核心指标，绝大部分rows小的语句执行一定很快（有例外，下面会讲到）。所以优化语句基本上都是在优化rows。</p>
<h3 id="慢查询优化基本步骤">慢查询优化基本步骤</h3>
<ol start="0">
<li>
<p>先运行看看是否真的很慢，注意设置SQL_NO_CACHE</p>
</li>
<li>
<p>where条件单表查，锁定最小返回记录表。这句话的意思是把查询语句的where都应用到表中返回的记录数最小的表开始查起，单表每个字段分别查询，看哪个字段的区分度最高</p>
</li>
<li>
<p>explain查看执行计划，是否与1预期一致（从锁定记录较少的表开始查询）</p>
</li>
<li>
<p>order by limit 形式的sql语句让排序的表优先查</p>
</li>
<li>
<p>了解业务方使用场景</p>
</li>
<li>
<p>加索引时参照建索引的几大原则</p>
</li>
<li>
<p>观察结果，不符合预期继续从0分析</p>
</li>
</ol>
<h3 id="explain参数">explain参数</h3>
<ol>
<li>
<p><code>select_typec</code>  表示 SELECT 的类型。
常见的取值有</p>
<ul>
<li><code>SIMPLE</code>（简单表，即不使用表连接或者子查询）</li>
<li><code>PRIMARY</code>（主查询，即外层的查询）</li>
<li><code>UNION</code>（<code>UNION</code> 中的第二个或者后面的查询语句）</li>
<li><code>SUBQUERY</code>（子查询中的第一个 <code>SELECT</code>）等。</li>
</ul>
</li>
<li>
<p><code>table</code>  输出结果集的表。</p>
</li>
<li>
<p><code>type</code>  表示表的连接类型，性能由好到差的连接类型如下</p>
<ul>
<li><code>system</code>（表中仅有一行，即常量表）</li>
<li><code>const</code>（单表中最多有一个匹配行，例如 <code>primary key</code> 或者 <code>unique index</code>）</li>
<li><code>eq_ref</code>（对于前面的每一行，在此表中只查询一条记录，简单来说，就是多表连接中使用<code>primary key</code>或者<code>unique index</code>）</li>
<li><code>ref</code>（与<code>eq_ref</code>类似，区别在于不是使用<code>primary key</code> 或者 <code>unique index</code>，而是使用普通的索引）</li>
<li><code>ref_or_null</code>（与 <code>ref</code> 类似，区别在于条件中包含对 <code>NULL</code> 的查询）</li>
<li><code>index_merge</code> (索引合并优化)</li>
<li><code>unique_subquery</code>（in的后面是一个查询主键字段的子查询）</li>
<li><code>index_subquery</code>（与 <code>unique_subquery</code> 类似，区别在于 in 的后面是查询非唯一索引字段的子查询）</li>
<li><code>range</code>（单表中的范围查询）</li>
<li><code>index</code>（对于前面的每一行，都通过查询索引来得到数据）</li>
<li><code>all</code>（对于前面的每一行，都通过全表扫描来得到数据）。</li>
</ul>
</li>
<li>
<p><code>possible_keys</code>  表示查询时，可能使用的索引。</p>
</li>
<li>
<p><code>key</code>  表示实际使用的索引。</p>
</li>
<li>
<p><code>key_len</code>  索引字段的长度。</p>
</li>
<li>
<p><code>rows</code>  扫描行的数量。</p>
</li>
<li>
<p><code>Extra</code>  执行情况的说明和描述。</p>
</li>
</ol>
]]></content:encoded><category>database</category><category>mysql</category></item><item><title>mysql事务</title><link>https://daemon365.dev/post/database/mysql_transaction/</link><pubDate>Fri, 03 Apr 2020 00:00:00 +0800</pubDate><guid>https://daemon365.dev/post/database/mysql_transaction/</guid><description>&lt;h2 id="事务是什么"&gt;事务是什么&lt;/h2&gt;
&lt;p&gt;&lt;strong&gt;事务就是指逻辑上的一组SQL语句操作，组成这组操作的各个SQL语句，执行时要么全成功要么全失败。&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;在 MySQL 中，事务支持是在引擎层实现的。MySQL 是一个支持多引擎的系统，但并不是所有的引擎都支持事务。&lt;/p&gt;
&lt;p&gt;比如 MySQL 原生的 MyISAM 引擎就不支持事务，这也是 MyISAM 被 InnoDB 取代的重要原因之一&lt;/p&gt;
&lt;h2 id="事务的四大特性"&gt;事务的四大特性&lt;/h2&gt;
&lt;ol&gt;
&lt;li&gt;原子性(Atomicity)
&lt;ul&gt;
&lt;li&gt;事务是一个不可分割的单位，事务中的所有SQL等操作要么都发生，要么都不发生。&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;一致性(Consistency)
&lt;ul&gt;
&lt;li&gt;事务发生前和发生后，数据的完整性必须保持一致。&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;隔离性(Isolation)
&lt;ul&gt;
&lt;li&gt;当并发访问数据库时，一个正在执行的事务在执行完毕前，对于其他的会话是不可见的，多个并发事务之间的数据是相互隔离的。也就是其他人的操作在这个事务的执行过程中是看不到这个事务的执行结果的，也就是他们拿到的是这个事务执行之前的内容，等这个事务执行完才能拿到新的数据。&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;持久性(Durability)
&lt;ul&gt;
&lt;li&gt;一个事务一旦被提交，它对数据库中的数据改变就是永久性的。如果出了错误，事务也不允撤销，只能通过&amp;rsquo;补偿性事务&amp;rsquo;。&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id="事务的开启"&gt;事务的开启&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;开启:&lt;/p&gt;
&lt;p&gt;begin/start transaction 执行第一个语句是开启事务&lt;/p&gt;
&lt;p&gt;start transaction with consistent snapshot 直接开启事务&lt;/p&gt;
&lt;p&gt;隐性事务：set autocommit=0，这个命令会将这个线程的自动提交关掉。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;意味着如果你只执行一个 select 语句，这个事务就启动了，而且并不会自动提交。这个事务持续存在直到你主动执行 commit 或 rollback 语句，或者断开连接。&lt;/p&gt;
&lt;p&gt;有些客户端连接框架会默认连接成功后先执行一个 set autocommit=0 的命令。这就导致接下来的查询都在事务中，如果是长连接，就导致了意外的长事务。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;提交:commit&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;回滚:rollback&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="在事务中混合使用存储引擎"&gt;在事务中混合使用存储引擎&lt;/h2&gt;
&lt;p&gt;MySQL服务器层不管理事务，事务是由下层的存储引擎实现的。所以在同一个事务中，使用多种存储引擎是不可靠的。&lt;/p&gt;
&lt;p&gt;如果在事务中混合使用了事务型和非事务型的表（例如innodb和myisam表），在正常提交的情况下不会有什么问题。&lt;/p&gt;
&lt;p&gt;但如果该事务需要回滚，非事务型的表上的变更就无法撤销，这会导致数据库处于不一致的状态，这种情况很难修复，事务的最终结果将无法确定。&lt;/p&gt;
&lt;p&gt;所以，为每张表选择合适的存储引擎非常重要。&lt;/p&gt;
&lt;p&gt;在非事务型的表上执行事务相关操作的时候，MySQL通常不会发出提醒，也不会报错。有时候只有回滚的时候才会发出一个警告：&amp;ldquo;某些非事务型的表上的变更不能被回滚&amp;rdquo;。&lt;/p&gt;
&lt;p&gt;但大多数情况下，对非事务型表的操作都不会有提示。&lt;/p&gt;
&lt;h2 id="脏读-幻读-不可重复读"&gt;脏读 幻读 不可重复读&lt;/h2&gt;
&lt;h3 id="脏读"&gt;脏读&lt;/h3&gt;
&lt;p&gt;所谓脏读是指一个事务中访问到了另外一个事务未提交的数据，如下图：&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;s1&lt;/th&gt;
&lt;th&gt;s2&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;begin&lt;/td&gt;
&lt;td&gt;begin&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;update test set number = 100 where id = 1;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;select number from test where id = 1;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;commit&lt;/td&gt;
&lt;td&gt;commit&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;ul&gt;
&lt;li&gt;如果会话 2 更新 number 为 100，但是在 number 之前，会话 1 希望得到 number，那么会获得的值就是更新前的值。或者如果会话 2 更新了值但是执行了 rollback，而会话 1 拿到的仍是 100。这就是脏读。&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id="不可重复读"&gt;不可重复读&lt;/h3&gt;
&lt;p&gt;一个事务查询同一条记录2次，得到的结果不一致：&lt;/p&gt;</description><content:encoded><![CDATA[<h2 id="事务是什么">事务是什么</h2>
<p><strong>事务就是指逻辑上的一组SQL语句操作，组成这组操作的各个SQL语句，执行时要么全成功要么全失败。</strong></p>
<p>在 MySQL 中，事务支持是在引擎层实现的。MySQL 是一个支持多引擎的系统，但并不是所有的引擎都支持事务。</p>
<p>比如 MySQL 原生的 MyISAM 引擎就不支持事务，这也是 MyISAM 被 InnoDB 取代的重要原因之一</p>
<h2 id="事务的四大特性">事务的四大特性</h2>
<ol>
<li>原子性(Atomicity)
<ul>
<li>事务是一个不可分割的单位，事务中的所有SQL等操作要么都发生，要么都不发生。</li>
</ul>
</li>
<li>一致性(Consistency)
<ul>
<li>事务发生前和发生后，数据的完整性必须保持一致。</li>
</ul>
</li>
<li>隔离性(Isolation)
<ul>
<li>当并发访问数据库时，一个正在执行的事务在执行完毕前，对于其他的会话是不可见的，多个并发事务之间的数据是相互隔离的。也就是其他人的操作在这个事务的执行过程中是看不到这个事务的执行结果的，也就是他们拿到的是这个事务执行之前的内容，等这个事务执行完才能拿到新的数据。</li>
</ul>
</li>
<li>持久性(Durability)
<ul>
<li>一个事务一旦被提交，它对数据库中的数据改变就是永久性的。如果出了错误，事务也不允撤销，只能通过&rsquo;补偿性事务&rsquo;。</li>
</ul>
</li>
</ol>
<h2 id="事务的开启">事务的开启</h2>
<ul>
<li>
<p>开启:</p>
<p>begin/start transaction 执行第一个语句是开启事务</p>
<p>start transaction with consistent snapshot 直接开启事务</p>
<p>隐性事务：set autocommit=0，这个命令会将这个线程的自动提交关掉。</p>
<blockquote>
<p>意味着如果你只执行一个 select 语句，这个事务就启动了，而且并不会自动提交。这个事务持续存在直到你主动执行 commit 或 rollback 语句，或者断开连接。</p>
<p>有些客户端连接框架会默认连接成功后先执行一个 set autocommit=0 的命令。这就导致接下来的查询都在事务中，如果是长连接，就导致了意外的长事务。</p>
</blockquote>
</li>
<li>
<p>提交:commit</p>
</li>
<li>
<p>回滚:rollback</p>
</li>
</ul>
<h2 id="在事务中混合使用存储引擎">在事务中混合使用存储引擎</h2>
<p>MySQL服务器层不管理事务，事务是由下层的存储引擎实现的。所以在同一个事务中，使用多种存储引擎是不可靠的。</p>
<p>如果在事务中混合使用了事务型和非事务型的表（例如innodb和myisam表），在正常提交的情况下不会有什么问题。</p>
<p>但如果该事务需要回滚，非事务型的表上的变更就无法撤销，这会导致数据库处于不一致的状态，这种情况很难修复，事务的最终结果将无法确定。</p>
<p>所以，为每张表选择合适的存储引擎非常重要。</p>
<p>在非事务型的表上执行事务相关操作的时候，MySQL通常不会发出提醒，也不会报错。有时候只有回滚的时候才会发出一个警告：&ldquo;某些非事务型的表上的变更不能被回滚&rdquo;。</p>
<p>但大多数情况下，对非事务型表的操作都不会有提示。</p>
<h2 id="脏读-幻读-不可重复读">脏读 幻读 不可重复读</h2>
<h3 id="脏读">脏读</h3>
<p>所谓脏读是指一个事务中访问到了另外一个事务未提交的数据，如下图：</p>
<table>
  <thead>
      <tr>
          <th>s1</th>
          <th>s2</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>begin</td>
          <td>begin</td>
      </tr>
      <tr>
          <td></td>
          <td>update test set number = 100 where id = 1;</td>
      </tr>
      <tr>
          <td>select number from test where id = 1;</td>
          <td></td>
      </tr>
      <tr>
          <td>commit</td>
          <td>commit</td>
      </tr>
  </tbody>
</table>
<ul>
<li>如果会话 2 更新 number 为 100，但是在 number 之前，会话 1 希望得到 number，那么会获得的值就是更新前的值。或者如果会话 2 更新了值但是执行了 rollback，而会话 1 拿到的仍是 100。这就是脏读。</li>
</ul>
<h3 id="不可重复读">不可重复读</h3>
<p>一个事务查询同一条记录2次，得到的结果不一致：</p>
<table>
  <thead>
      <tr>
          <th>S1</th>
          <th>S2</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>begin</td>
          <td>begin;</td>
      </tr>
      <tr>
          <td>select number from test where id = 1;</td>
          <td></td>
      </tr>
      <tr>
          <td></td>
          <td>update test set number = 200 where id = 1;</td>
      </tr>
      <tr>
          <td></td>
          <td>commit</td>
      </tr>
      <tr>
          <td>select number from test where id = 1;</td>
          <td></td>
      </tr>
      <tr>
          <td>commit;</td>
          <td></td>
      </tr>
  </tbody>
</table>
<ul>
<li>由于在读取中间变更了数据，所以会话 1 事务查询期间的得到的结果就不一样了。</li>
</ul>
<h3 id="幻读">幻读</h3>
<p>一个事务查询2次，得到的记录条数不一致：</p>
<table>
  <thead>
      <tr>
          <th>S1</th>
          <th>S2</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>begin</td>
          <td>begin</td>
      </tr>
      <tr>
          <td>select number from test where id &lt; 5;</td>
          <td></td>
      </tr>
      <tr>
          <td></td>
          <td>insert into test value(2,3);</td>
      </tr>
      <tr>
          <td></td>
          <td>commit</td>
      </tr>
      <tr>
          <td>select number from test where id &lt; 5;</td>
          <td></td>
      </tr>
      <tr>
          <td>commit</td>
          <td></td>
      </tr>
  </tbody>
</table>
<ul>
<li>幻读是不可重复读的一种特殊场景。</li>
</ul>
<h2 id="事务的隔离级别">事务的隔离级别</h2>
<p>MySQL 里有四个隔离级别：</p>
<h3 id="read-uncommitted读未提交">READ UNCOMMITTED（读未提交）</h3>
<p>在read uncommitted级别，事务中的修改 ，即使没有提交，对其他事务也都是可见的。事务可以读取未提交的数据，这也被称为脏读。</p>
<p>这个级别会导致很多问题，从性能上来说，read uncommitted不会比其他的级别好太多，但却缺乏其他级别的很多好处，除非真个有非常必要的理由，在实际应用中一般很少使用。</p>
<h3 id="read-committed提已提交">READ COMMITTED（提已提交）</h3>
<p>大多数数据库系统的默认隔离级别都是READ COMMITTED（但MySQL不是）。</p>
<p>READ COMMITTED满足前面提到的隔离性的简单定义：一个事务开始时，只能看见已经提交的事务所做的修改。</p>
<p>换句话说，一个事务从开始直到提交之前，所做的任何修改对其他事务都是不可见的，这个级别有时候也叫做不可重复读。</p>
<p>不可重复读现象：当事务内相同的记录被检索两次，且两次得到的结果不同时，此现象成为不可重复读。</p>
<h3 id="repeatable-read读可重复读">REPEATABLE READ（读可重复读）</h3>
<p>REPEATABLE READ解决了脏读的问题。该级别保证了在同一个事务中多次读取同样记录的结果是一致的。但是理论上，可重复读隔离级别还是无法解决另外一个幻读的问题。</p>
<p>所谓幻读，指的是当某个事务在读取某个范围内的记录时，另外一个事务又在该范围内插入了新的记录，当之前的事务再次读取该范围的记录时，会产生幻行。</p>
<p>可重复读是MySQL的默认事务隔离级别。</p>
<h3 id="serizlizable可串行化">SERIZLIZABLE（可串行化）</h3>
<p>SERIZLIZABLE是最高的隔离级别。它通过强制事务串行执行，避免了前面说的幻读的问题。</p>
<p>简单来说，SERIZLIZABLE会在读取的每一行数据上都加锁，所以可能导致大量的超时和锁争用的问题。</p>
<p>实际应用中也很少用到这个隔离级别，只有在非常需要确保数据的一致性而且可以接受没有并发的情况下，才考虑采用该级别。</p>
<h4 id="不同事务隔离级别的效果">不同事务隔离级别的效果：</h4>
<table>
  <thead>
      <tr>
          <th>隔离级别</th>
          <th>脏读</th>
          <th>不可重复读</th>
          <th>幻读</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>READ UNCOMMITTED（未提交读）</td>
          <td>✅</td>
          <td>✅</td>
          <td>✅</td>
      </tr>
      <tr>
          <td>READ COMMITTED（提已提交）</td>
          <td>❎</td>
          <td>✅</td>
          <td>✅</td>
      </tr>
      <tr>
          <td>REPEATABLE READ（可重复读）</td>
          <td>❎</td>
          <td>❎</td>
          <td>✅</td>
      </tr>
      <tr>
          <td>SERIZLIZABLE（可串行化）</td>
          <td>❎</td>
          <td>❎</td>
          <td>✅</td>
      </tr>
  </tbody>
</table>
<p>在 InnoDB 中，默认为 Repeatable 级别，InnoDB 中使用一种被称为 next-key locking 的策略来避免幻读（phantom）现象的产生。</p>
<p>隔离级别越高，越能保证数据的完整性和一致性，但是对并发性能的影响也越大。</p>
<h2 id="事务隔离的实现">事务隔离的实现</h2>
<p>隔离级别为默认可重复读</p>
<p>在 MySQL 中，实际上每条记录在更新的时候都会同时记录一条回滚操作。
记录上的最新值，通过回滚操作，都可以得到前一个状态的值。
假设一个值从 1 被按顺序改成了 2、3、4，在回滚日志里面就会有类似下面的记录。</p>
<p><img src="/images/1eb56f59-6331-4a47-bf33-b77144b26b18.png" alt=""></p>
<p>当前值是 4，但是在查询这条记录的时候，不同时刻启动的事务会有不同的 read-view。
如图中看到的，在视图 A、B、C 里面，这一个记录的值分别是 1、2、4，
同一条记录在系统中可以存在多个版本，就是数据库的多版本并发控制（MVCC）。
对于 read-view A，要得到 1，就必须将当前值依次执行图中所有的回滚操作得到。
同时你会发现，
即使现在有另外一个事务正在将 4 改成 5，这个事务跟 read-view A、B、C 对应的事务是不会冲突的</p>
<h2 id="参考文章">参考文章</h2>
<ul>
<li><a href="https://time.geekbang.org/column/article/70562">https://time.geekbang.org/column/article/70562</a></li>
</ul>
]]></content:encoded><category>database</category><category>mysql</category><category>事务</category></item><item><title>mysql 锁</title><link>https://daemon365.dev/post/database/mysql_lock/</link><pubDate>Thu, 02 Apr 2020 00:00:00 +0800</pubDate><guid>https://daemon365.dev/post/database/mysql_lock/</guid><description>&lt;h2 id="mysql中的锁"&gt;MySQL中的锁&lt;/h2&gt;
&lt;p&gt;数据库锁设计的初衷是处理并发问题。作为多用户共享的资源，当出现并发访问的时候，数据库需要合理地控制资源的访问规则。而锁就是用来实现这些访问规则的重要数据结构。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;根据加锁的范围，MySQL 里面的锁大致可以分成全局锁、表级锁和行锁三类&lt;/strong&gt;&lt;/p&gt;
&lt;h2 id="全局锁"&gt;全局锁&lt;/h2&gt;
&lt;p&gt;全局锁就是对整个数据库实例加锁。&lt;/p&gt;
&lt;p&gt;MySQL提供了一个加全局读锁的方法，命令是Flush tables with read lock。当需要让整个库处于只读状态的时候，可以使用这个命令，之后其他线程的以下语句会被阻塞：数据更新语句（数据的增删改）、数据定义语句（包括建表、修改表结构等）和更新类事务的提交语句&lt;/p&gt;
&lt;p&gt;全局锁的典型使用场景是，做全库逻辑备份。也就是把整库每个表都select出来存成文本&lt;/p&gt;
&lt;p&gt;但是让整个库都只读，可能出现以下问题：&lt;/p&gt;
&lt;p&gt;如果在主库上备份，那么在备份期间都不能执行更新，业务基本上就得停摆
如果在从库上备份，那么在备份期间从库不能执行主库同步过来的binlog，会导致主从延迟
在可重复读隔离级别下开启一个事务能够拿到一致性视图&lt;/p&gt;
&lt;p&gt;官方自带的逻辑备份工具是mysqldump。当mysqldump使用参数–single-transaction的时候，导数据之前就会启动一个事务，来确保拿到一致性视图。而由于MVCC的支持，这个过程中数据是可以正常更新的。single-transaction只适用于所有的表使用事务引擎的库&lt;/p&gt;
&lt;p&gt;既然要全库只读，为什么不使用set global readonly=true的方式？&lt;/p&gt;
&lt;p&gt;在有些系统中，readonly的值会被用来做其他逻辑，比如用来判断一个库是主库还是备库。因此修改global变量的方式影响面更大
在异常处理机制上有差异。如果执行Flush tables with read lock命令之后由于客户端发生异常断开，那么MySQL会自动释放这个全局锁，整个库回到可以正常更新的状态。而将整个库设置为readonly之后，如果客户端发生异常，则数据库会一直保持readonly状态，这样会导致整个库长时间处于不可写状态，风险较高&lt;/p&gt;
&lt;h2 id="表级锁"&gt;表级锁&lt;/h2&gt;
&lt;p&gt;&lt;strong&gt;MySQL 里面表级别的锁有两种：一种是表锁，一种是元数据锁（meta data lock，MDL)。&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;表锁的语法是 lock tables … read/write。与 FTWRL 类似，可以用 unlock tables 主动释放锁，也可以在客户端断开的时候自动释放。需要注意，lock tables 语法除了会限制别的线程的读写外，也限定了本线程接下来的操作对象。&lt;/p&gt;
&lt;p&gt;另一类表级的锁是 MDL（metadata lock)。MDL 不需要显式使用，在访问一个表的时候会被自动加上。MDL 的作用是，保证读写的正确性。&lt;/p&gt;
&lt;p&gt;在 MySQL 5.5 版本中引入了 MDL，当对一个表做增删改查操作的时候，加 MDL 读锁；当要对表做结构变更操作的时候，加 MDL 写锁。&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;读锁之间不互斥，因此你可以有多个线程同时对一张表增删改查。&lt;/li&gt;
&lt;li&gt;读写锁之间、写锁之间是互斥的，用来保证变更表结构操作的安全性。因此，如果有两个线程要同时给一个表加字段，其中一个要等另一个执行完才能开始执行。&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;给一个表加字段，或者修改字段，或者加索引，需要扫描全表的数据。在对大表操作的时候，你肯定会特别小心，以免对线上服务造成影响。而实际上，即使是小表，操作不慎也会出问题。&lt;/p&gt;
&lt;p&gt;如果某个表上的查询语句频繁，而且客户端有重试机制，也就是说超时后会再起一个新 session 再请求的话，这个库的线程很快就会爆满。&lt;/p&gt;
&lt;p&gt;事务中的 MDL 锁，在语句执行开始时申请，但是语句结束后并不会马上释放，而会等到整个事务提交后再释放。&lt;/p&gt;
&lt;h2 id="行锁"&gt;行锁&lt;/h2&gt;
&lt;p&gt;MySQL 的行锁是在引擎层由各个引擎自己实现的。但并不是所有的引擎都支持行锁，比如 MyISAM 引擎就不支持行锁。&lt;/p&gt;</description><content:encoded><![CDATA[<h2 id="mysql中的锁">MySQL中的锁</h2>
<p>数据库锁设计的初衷是处理并发问题。作为多用户共享的资源，当出现并发访问的时候，数据库需要合理地控制资源的访问规则。而锁就是用来实现这些访问规则的重要数据结构。</p>
<p><strong>根据加锁的范围，MySQL 里面的锁大致可以分成全局锁、表级锁和行锁三类</strong></p>
<h2 id="全局锁">全局锁</h2>
<p>全局锁就是对整个数据库实例加锁。</p>
<p>MySQL提供了一个加全局读锁的方法，命令是Flush tables with read lock。当需要让整个库处于只读状态的时候，可以使用这个命令，之后其他线程的以下语句会被阻塞：数据更新语句（数据的增删改）、数据定义语句（包括建表、修改表结构等）和更新类事务的提交语句</p>
<p>全局锁的典型使用场景是，做全库逻辑备份。也就是把整库每个表都select出来存成文本</p>
<p>但是让整个库都只读，可能出现以下问题：</p>
<p>如果在主库上备份，那么在备份期间都不能执行更新，业务基本上就得停摆
如果在从库上备份，那么在备份期间从库不能执行主库同步过来的binlog，会导致主从延迟
在可重复读隔离级别下开启一个事务能够拿到一致性视图</p>
<p>官方自带的逻辑备份工具是mysqldump。当mysqldump使用参数–single-transaction的时候，导数据之前就会启动一个事务，来确保拿到一致性视图。而由于MVCC的支持，这个过程中数据是可以正常更新的。single-transaction只适用于所有的表使用事务引擎的库</p>
<p>既然要全库只读，为什么不使用set global readonly=true的方式？</p>
<p>在有些系统中，readonly的值会被用来做其他逻辑，比如用来判断一个库是主库还是备库。因此修改global变量的方式影响面更大
在异常处理机制上有差异。如果执行Flush tables with read lock命令之后由于客户端发生异常断开，那么MySQL会自动释放这个全局锁，整个库回到可以正常更新的状态。而将整个库设置为readonly之后，如果客户端发生异常，则数据库会一直保持readonly状态，这样会导致整个库长时间处于不可写状态，风险较高</p>
<h2 id="表级锁">表级锁</h2>
<p><strong>MySQL 里面表级别的锁有两种：一种是表锁，一种是元数据锁（meta data lock，MDL)。</strong></p>
<p>表锁的语法是 lock tables … read/write。与 FTWRL 类似，可以用 unlock tables 主动释放锁，也可以在客户端断开的时候自动释放。需要注意，lock tables 语法除了会限制别的线程的读写外，也限定了本线程接下来的操作对象。</p>
<p>另一类表级的锁是 MDL（metadata lock)。MDL 不需要显式使用，在访问一个表的时候会被自动加上。MDL 的作用是，保证读写的正确性。</p>
<p>在 MySQL 5.5 版本中引入了 MDL，当对一个表做增删改查操作的时候，加 MDL 读锁；当要对表做结构变更操作的时候，加 MDL 写锁。</p>
<ol>
<li>读锁之间不互斥，因此你可以有多个线程同时对一张表增删改查。</li>
<li>读写锁之间、写锁之间是互斥的，用来保证变更表结构操作的安全性。因此，如果有两个线程要同时给一个表加字段，其中一个要等另一个执行完才能开始执行。</li>
</ol>
<p>给一个表加字段，或者修改字段，或者加索引，需要扫描全表的数据。在对大表操作的时候，你肯定会特别小心，以免对线上服务造成影响。而实际上，即使是小表，操作不慎也会出问题。</p>
<p>如果某个表上的查询语句频繁，而且客户端有重试机制，也就是说超时后会再起一个新 session 再请求的话，这个库的线程很快就会爆满。</p>
<p>事务中的 MDL 锁，在语句执行开始时申请，但是语句结束后并不会马上释放，而会等到整个事务提交后再释放。</p>
<h2 id="行锁">行锁</h2>
<p>MySQL 的行锁是在引擎层由各个引擎自己实现的。但并不是所有的引擎都支持行锁，比如 MyISAM 引擎就不支持行锁。</p>
<p>不支持行锁意味着并发控制只能使用表锁，对于这种引擎的表，同一张表上任何时刻只能有一个更新在执行，这就会影响到业务并发度。InnoDB 是支持行锁的，这也是 MyISAM 被 InnoDB 替代的重要原因之一。</p>
<p>顾名思义，行锁就是针对数据表中行记录的锁。这很好理解，比如事务 A 更新了一行，而这时候事务 B 也要更新同一行，则必须等事务 A 的操作完成后才能进行更新。</p>
<p>当然，数据库中还有一些没那么一目了然的概念和设计，这些概念如果理解和使用不当，容易导致程序出现非预期行为，比如两阶段锁。</p>
<h3 id="两阶段锁">两阶段锁</h3>
<p><img src="/images/79ee43b2-1671-4163-8b3a-65dd040b413f.png" alt=""></p>
<p>这个问题的结论取决于事务 A 在执行完两条 update 语句后，持有哪些锁，以及在什么时候释放。</p>
<p>事务 A 持有的两个记录的行锁，都是在 commit 的时候才释放的。也就是说，在 InnoDB 事务中，行锁是在需要的时候才加上的，但并不是不需要了就立刻释放，而是要等到事务结束时才释放。这个就是两阶段锁协议。如果你的事务中需要锁多个行，要把最可能造成锁冲突、最可能影响并发度的锁尽量往后放。</p>
<h3 id="死锁和死锁检测">死锁和死锁检测</h3>
<p>当并发系统中不同线程出现循环资源依赖，涉及的线程都在等待别的线程释放资源时，就会导致这几个线程都进入无限等待的状态，称为死锁</p>
<p><img src="/images/ddd2a678-52c1-49bd-8dd8-a386f76a04c9.png" alt=""></p>
<p>事务 A 和事务 B 在互相等待对方的资源释放，就是进入了死锁状态。</p>
<p>当出现死锁以后，有两种策略：</p>
<ul>
<li>一种策略是，直接进入等待，直到超时。这个超时时间可以通过参数 innodb_lock_wait_timeout 来设置。</li>
<li>另一种策略是，发起死锁检测，发现死锁后，主动回滚死锁链条中的某一个事务，让其他事务得以继续执行。将参数 innodb_deadlock_detect 设置为 on，表示开启这个逻辑。</li>
</ul>
<p>在 InnoDB 中，innodb_lock_wait_timeout 的默认值是 50s，意味着如果采用第一个策略，当出现死锁以后，第一个被锁住的线程要过 50s 才会超时退出，然后其他线程才有可能继续执行。对于在线服务来说，这个等待时间往往是无法接受的。但是，我们又不可能直接把这个时间设置成一个很小的值，比如 1s。这样当出现死锁的时候，确实很快就可以解开，但如果不是死锁，而是简单的锁等待呢？所以，超时时间设置太短的话，会出现很多误伤。所以，正常情况下我们还是要采用第二种策略，即：主动死锁检测，而且 innodb_deadlock_detect 的默认值本身就是 on。主动死锁检测在发生死锁的时候，是能够快速发现并进行处理的，但是它也是有额外负担的。</p>
<p>你可以想象一下这个过程：每当一个事务被锁的时候，就要看看它所依赖的线程有没有被别人锁住，如此循环，最后判断是否出现了循环等待，也就是死锁。那如果是我们上面说到的所有事务都要更新同一行的场景呢？</p>
<p>每个新来的被堵住的线程，都要判断会不会由于自己的加入导致了死锁，这是一个时间复杂度是 O(n) 的操作。假设有 1000 个并发线程要同时更新同一行，那么死锁检测操作就是 100 万这个量级的。虽然最终检测的结果是没有死锁，但是这期间要消耗大量的 CPU 资源。因此，你就会看到 CPU 利用率很高，但是每秒却执行不了几个事务。</p>
<h2 id="间隙锁">间隙锁</h2>
<p>为了解决幻读问题，InnoDB 只好引入新的锁，也就是间隙锁 (Gap Lock)。</p>
<p>顾名思义，间隙锁，锁的就是两个值之间的空隙。比如文章开头的表 t，初始化插入了 6 个记录，这就产生了 7 个间隙。</p>
<p><img src="/images/23120e22-e778-4a3e-8abd-a1dd6565723f.png" alt=""></p>
<p>这样，当你执行 select * from t where d=5 for update 的时候，就不止是给数据库中已有的 6 个记录加上了行锁，还同时加了 7 个间隙锁。这样就确保了无法再插入新的记录。也就是说这时候，在一行行扫描的过程中，不仅将给行加上了行锁，还给行两边的空隙，也加上了间隙锁。现在你知道了，数据行是可以加上锁的实体，数据行之间的间隙，也是可以加上锁的实体。但是间隙锁跟我们之前碰到过的锁都不太一样。比如行锁，分成读锁和写锁。下图就是这两种类型行锁的冲突关系。</p>
<p><img src="/images/49c036f3-adef-4392-996b-c33e19cb9e22.png" alt=""></p>
<p>也就是说，跟行锁有冲突关系的是“另外一个行锁”。但是间隙锁不一样，跟间隙锁存在冲突关系的，是“往这个间隙中插入一个记录”这个操作。间隙锁之间都不存在冲突关系。</p>
<p>举个例子：</p>
<p><img src="/images/8b1dfc56-e5bd-4eff-a553-750ac9d4f631.png" alt=""></p>
<p>这里 session B 并不会被堵住。因为表 t 里并没有 c=7 这个记录，因此 session A 加的是间隙锁 (5,10)。而 session B 也是在这个间隙加的间隙锁。它们有共同的目标，即：保护这个间隙，不允许插入值。但，它们之间是不冲突的。</p>
<h2 id="next-key-lock">next-key lock</h2>
<p>间隙锁和行锁合称 next-key lock，每个 next-key lock 是前开后闭区间。也就是说，我们的表 t 初始化以后，如果用 select * from t for update 要把整个表所有记录锁起来，就形成了 7 个 next-key lock，分别是 (-∞,0]、(0,5]、(5,10]、(10,15]、(15,20]、(20, 25]、(25, +supremum]。</p>
<blockquote>
<p>备注：这篇文章中，如果没有特别说明，我们把间隙锁记为开区间，把 next-key lock 记为前开后闭区间。</p>
</blockquote>
<p>这个 supremum 从哪儿来的呢？这是因为 +∞是开区间。实现上，InnoDB 给每个索引加了一个不存在的最大值 supremum，这样才符合我们前面说的“都是前开后闭区间”。</p>
<h2 id="参考文章">参考文章</h2>
<ul>
<li><a href="https://time.geekbang.org/column/article/69862">https://time.geekbang.org/column/article/69862</a></li>
</ul>
]]></content:encoded><category>database</category><category>mysql</category></item><item><title>msyql redo log和binlog</title><link>https://daemon365.dev/post/database/msyql_redo_log_and_binlog/</link><pubDate>Wed, 01 Apr 2020 00:00:00 +0800</pubDate><guid>https://daemon365.dev/post/database/msyql_redo_log_and_binlog/</guid><description>&lt;h2 id="更新语句执行流程"&gt;更新语句执行流程&lt;/h2&gt;
&lt;p&gt;下面是这个表的创建语句，这个表有一个主键 ID 和一个整型字段 c：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-sql" data-lang="sql"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;create&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;table&lt;/span&gt; &lt;span style="color:#111"&gt;T&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#111"&gt;ID&lt;/span&gt; &lt;span style="color:#111"&gt;int&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;primary&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;key&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;c&lt;/span&gt; &lt;span style="color:#111"&gt;int&lt;/span&gt;&lt;span style="color:#111"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;如果要将 ID=2 这一行的值加 1，SQL 语句就会这么写：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-sql" data-lang="sql"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;update&lt;/span&gt; &lt;span style="color:#111"&gt;T&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;set&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;c&lt;/span&gt;&lt;span style="color:#f92672"&gt;=&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;c&lt;/span&gt;&lt;span style="color:#f92672"&gt;+&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;1&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;where&lt;/span&gt; &lt;span style="color:#111"&gt;ID&lt;/span&gt;&lt;span style="color:#f92672"&gt;=&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;2&lt;/span&gt;&lt;span style="color:#111"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;前面我有跟你介绍过 SQL 语句基本的执行链路，这里我再把那张图拿过来，你也可以先简单看看这个图回顾下。首先，可以确定的说，查询语句的那一套流程，更新语句也是同样会走一遍。&lt;/p&gt;
&lt;p&gt;&lt;img src="https://daemon365.dev/images/5d8b13b4-c07c-443e-9683-5ca10a60e1dc.png" alt=""&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;通过连接器，客户端与 MySQL 建立连接&lt;/li&gt;
&lt;li&gt;update 语句会把 T 表上的所有查询缓存结果清空&lt;/li&gt;
&lt;li&gt;分析器会通过词法分析和语法分析识别这是一条更新语句&lt;/li&gt;
&lt;li&gt;优化器会决定使用 ID 这个索引（聚簇索引）&lt;/li&gt;
&lt;li&gt;执行器负责具体执行，找到匹配的一行，然后更新&lt;/li&gt;
&lt;li&gt;更新过程中还会涉及 redo log（重做日志）和 binlog（归档日志）的操作&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;其中，这两种日志默认在数据库的 data 目录下，redo log 是 ib_logfile0 格式的，binlog 是 xxx-bin.000001 格式的。&lt;/p&gt;
&lt;p&gt;接下来让我们分别去研究下日志模块中的 redo log 和 binlog。&lt;/p&gt;
&lt;h2 id="日志模块redo-log"&gt;日志模块：redo log&lt;/h2&gt;
&lt;p&gt;在 MySQL 中，如果每一次的更新操作都需要写进磁盘，然后磁盘也要找到对应的那条记录，然后再更新，整个过程 IO 成本、查找成本都很高。为了解决这个问题，MySQL 的设计者就采用了日志（redo log）来提升更新效率。&lt;/p&gt;
&lt;p&gt;而日志和磁盘配合的整个过程，其实就是 MySQL 里的 WAL 技术，WAL 的全称是 Write-Ahead Logging，它的关键点就是先写日志，再写磁盘。&lt;/p&gt;
&lt;p&gt;具体来说，当有一条记录需要更新的时候，InnoDB 引擎就会先把记录写到 redo log（redolog buffer）里面，并更新内存（buffer pool），这个时候更新就算完成了。同时，InnoDB 引擎会在适当的时候（如系统空闲时），将这个操作记录更新到磁盘里面（刷脏页）。&lt;/p&gt;</description><content:encoded><![CDATA[<h2 id="更新语句执行流程">更新语句执行流程</h2>
<p>下面是这个表的创建语句，这个表有一个主键 ID 和一个整型字段 c：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#00a8c8">create</span> <span style="color:#00a8c8">table</span> <span style="color:#111">T</span><span style="color:#111">(</span><span style="color:#111">ID</span> <span style="color:#111">int</span> <span style="color:#00a8c8">primary</span> <span style="color:#00a8c8">key</span><span style="color:#111">,</span> <span style="color:#00a8c8">c</span> <span style="color:#111">int</span><span style="color:#111">);</span>
</span></span></code></pre></div><p>如果要将 ID=2 这一行的值加 1，SQL 语句就会这么写：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#00a8c8">update</span> <span style="color:#111">T</span> <span style="color:#00a8c8">set</span> <span style="color:#00a8c8">c</span><span style="color:#f92672">=</span><span style="color:#00a8c8">c</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span> <span style="color:#00a8c8">where</span> <span style="color:#111">ID</span><span style="color:#f92672">=</span><span style="color:#ae81ff">2</span><span style="color:#111">;</span>
</span></span></code></pre></div><p>前面我有跟你介绍过 SQL 语句基本的执行链路，这里我再把那张图拿过来，你也可以先简单看看这个图回顾下。首先，可以确定的说，查询语句的那一套流程，更新语句也是同样会走一遍。</p>
<p><img src="/images/5d8b13b4-c07c-443e-9683-5ca10a60e1dc.png" alt=""></p>
<ol>
<li>通过连接器，客户端与 MySQL 建立连接</li>
<li>update 语句会把 T 表上的所有查询缓存结果清空</li>
<li>分析器会通过词法分析和语法分析识别这是一条更新语句</li>
<li>优化器会决定使用 ID 这个索引（聚簇索引）</li>
<li>执行器负责具体执行，找到匹配的一行，然后更新</li>
<li>更新过程中还会涉及 redo log（重做日志）和 binlog（归档日志）的操作</li>
</ol>
<p>其中，这两种日志默认在数据库的 data 目录下，redo log 是 ib_logfile0 格式的，binlog 是 xxx-bin.000001 格式的。</p>
<p>接下来让我们分别去研究下日志模块中的 redo log 和 binlog。</p>
<h2 id="日志模块redo-log">日志模块：redo log</h2>
<p>在 MySQL 中，如果每一次的更新操作都需要写进磁盘，然后磁盘也要找到对应的那条记录，然后再更新，整个过程 IO 成本、查找成本都很高。为了解决这个问题，MySQL 的设计者就采用了日志（redo log）来提升更新效率。</p>
<p>而日志和磁盘配合的整个过程，其实就是 MySQL 里的 WAL 技术，WAL 的全称是 Write-Ahead Logging，它的关键点就是先写日志，再写磁盘。</p>
<p>具体来说，当有一条记录需要更新的时候，InnoDB 引擎就会先把记录写到 redo log（redolog buffer）里面，并更新内存（buffer pool），这个时候更新就算完成了。同时，InnoDB 引擎会在适当的时候（如系统空闲时），将这个操作记录更新到磁盘里面（刷脏页）。</p>
<p>redo log 是 InnoDB 存储引擎层的日志，又称重做日志文件，redo log 是循环写的，redo log 不是记录数据页更新之后的状态，而是记录这个页做了什么改动。</p>
<p>redo log 是固定大小的，比如可以配置为一组 4 个文件，每个文件的大小是 1GB，那么日志总共就可以记录 4GB 的操作。从头开始写，写到末尾就又回到开头循环写，如下图所示。</p>
<p><img src="/images/05008dc5-c009-4d58-9a2b-2d981007284d.png" alt=""></p>
<p>图中展示了一组 4 个文件的 redo log 日志，checkpoint 是当前要擦除的位置，擦除记录前需要先把对应的数据落盘（更新内存页，等待刷脏页）。write pos 到 checkpoint 之间的部分可以用来记录新的操作，如果 write pos 和 checkpoint 相遇，说明 redolog 已满，这个时候数据库停止进行数据库更新语句的执行，转而进行 redo log 日志同步到磁盘中。checkpoint 到 write pos 之间的部分等待落盘（先更新内存页，然后等待刷脏页）。</p>
<p>有了 redo log 日志，那么在数据库进行异常重启的时候，可以根据 redo log 日志进行恢复，也就达到了 <strong>crash-safe</strong>。</p>
<p>redo log 用于保证 crash-safe 能力。innodb_flush_log_at_trx_commit 这个参数设置成 1 的时候，表示每次事务的 redo log 都直接持久化到磁盘。这个参数建议设置成 1，这样可以保证 MySQL 异常重启之后数据不丢失。</p>
<h2 id="日志模块binlog">日志模块：binlog</h2>
<p>MySQL 整体来看，其实就有两块：一块是 Server 层，它主要做的是 MySQL 功能层面的事情；还有一块是引擎层，负责存储相关的具体事宜。 redo log 是 InnoDB 引擎特有的日志，而 Server 层也有自己的日志，称为 binlog（归档日志）。</p>
<p><strong>为什么要有两份日志系统？</strong></p>
<p>因为最开始 MySQL 里并没有 InnoDB 引擎。MySQL 自带的引擎是 MyISAM，但是 MyISAM 没有 crash-safe 的能力，binlog 日志只能用于归档。而InnoDB 是另一个公司以插件形式引入 MySQL 的，既然只依靠 binlog 是没有 crash-safe 能力的，所以 InnoDB 使用另外一套日志系统——也就是 redo log 来实现 crash-safe 能力。</p>
<p>redo log 和 binlog 区别：</p>
<ol>
<li>redo log 是 InnoDB 引擎特有的；binlog 是 MySQL 的 Server 层实现的，所有引擎都可以使用。</li>
<li>redo log 是物理日志，记录的是在某个数据页上做了什么修改；binlog 是逻辑日志，记录的是这个语句的原始逻辑。</li>
<li>redo log 是循环写的，空间固定会用完；binlog 是可以追加写入的。追加写是指 binlog 文件写到一定大小后会切换到下一个，并不会覆盖以前的日志。</li>
</ol>
<p>有了对这两个日志的概念性理解后，再来看执行器和 InnoDB 引擎在执行这个 update 语句时的内部流程。</p>
<ol>
<li>执行器先找引擎取 ID=2 这一行。ID 是主键，引擎直接用树搜索找到这一行。如果 ID=2 这一行所在的数据页本来就在内存中，就直接返回给执行器；否则，需要先从磁盘读入内存，然后再返回。</li>
<li>执行器拿到引擎给的行数据，把这个值加上 1，比如原来是 N，现在就是 N+1，得到新的一行数据，再调用引擎接口写入这行新数据。</li>
<li>引擎将这行新数据更新到内存（InnoDB Buffer Pool）中，同时将这个更新操作记录到 redo log 里面，此时 redo log 处于 prepare 状态。然后告知执行器执行完成了，随时可以提交事务。</li>
<li>执行器生成这个操作的 binlog，并把 binlog 写入磁盘。</li>
<li>执行器调用引擎的提交事务接口，引擎把刚刚写入的 redo log 改成提交（commit）状态，更新完成。</li>
</ol>
<p>update 语句的执行流程图，图中浅色框表示是在 InnoDB 内部执行的，深色框表示是在执行器中执行的。</p>
<p><img src="/images/935ffe42-60a8-4ca1-a65b-475486ac3827.png" alt=""></p>
<h2 id="两阶段提交">两阶段提交</h2>
<p>MySQL 使用两阶段提交主要解决 binlog 和 redo log 的数据一致性的问题。</p>
<p>由于 redo log 和 binlog 是两个独立的逻辑，如果不用两阶段提交，要么就是先写完 redo log 再写 binlog，或者采用反过来的顺序。</p>
<p>仍然用前面的 update 语句来做例子。假设当前 ID=2 的行，字段 c 的值是 0，再假设执行 update 语句过程中在写完第一个日志后，第二个日志还没有写完期间发生了 crash，会出现什么情况呢？</p>
<ol>
<li>**先写 redo log 后写 binlog。**假设在 redo log 写完，binlog 还没有写完的时候，MySQL 进程异常重启。由于我们前面说过的，redo log 写完之后，系统即使崩溃，仍然能够把数据恢复回来，所以恢复后这一行 c 的值是 1。但是由于 binlog 没写完就 crash 了，这时候 binlog 里面就没有记录这个语句。因此，之后备份日志的时候，存起来的 binlog 里面就没有这条语句。然后你会发现，如果需要用这个 binlog 来恢复临时库的话，由于这个语句的 binlog 丢失，这个临时库就会少了这一次更新，恢复出来的这一行 c 的值就是 0，与原库的值不同。</li>
<li>**先写 binlog 后写 redo log。**如果在 binlog 写完之后 crash，由于 redo log 还没写，崩溃恢复以后这个事务无效，所以这一行 c 的值是 0。但是 binlog 里面已经记录了“把 c 从 0 改成 1”这个日志。所以，在之后用 binlog 来恢复的时候就多了一个事务出来，恢复出来的这一行 c 的值就是 1，与原库的值不同。</li>
</ol>
<p>简单说，redo log 和 binlog 都可以用于表示事务的提交状态，而两阶段提交就是让这两个状态保持逻辑上的一致。</p>
<h2 id="参考文章">参考文章</h2>
<ul>
<li><a href="https://time.geekbang.org/column/article/68633">https://time.geekbang.org/column/article/68633</a></li>
</ul>
]]></content:encoded><category>database</category><category>mysql</category></item><item><title>MySQL基础数据类型</title><link>https://daemon365.dev/post/database/mysql_basic_data_types/</link><pubDate>Tue, 31 Mar 2020 00:00:00 +0800</pubDate><guid>https://daemon365.dev/post/database/mysql_basic_data_types/</guid><description>&lt;h2 id="数值类型"&gt;数值类型&lt;/h2&gt;
&lt;p&gt;MySQL支持所有标准SQL数值数据类型。&lt;/p&gt;
&lt;p&gt;这些类型包括严格数值数据类型(INTEGER、SMALLINT、DECIMAL和NUMERIC)，以及近似数值数据类型(FLOAT、REAL和DOUBLE PRECISION)。&lt;/p&gt;
&lt;p&gt;关键字INT是INTEGER的同义词，关键字DEC是DECIMAL的同义词。&lt;/p&gt;
&lt;p&gt;BIT数据类型保存位字段值，并且支持MyISAM、MEMORY、InnoDB和BDB表。&lt;/p&gt;
&lt;p&gt;作为SQL标准的扩展，MySQL也支持整数类型TINYINT、MEDIUMINT和BIGINT。下面的表显示了需要的每个整数类型的存储和范围。&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th style="text-align: left"&gt;类型&lt;/th&gt;
&lt;th style="text-align: left"&gt;大小&lt;/th&gt;
&lt;th style="text-align: left"&gt;范围（有符号）&lt;/th&gt;
&lt;th style="text-align: left"&gt;范围（无符号）&lt;/th&gt;
&lt;th style="text-align: left"&gt;用途&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td style="text-align: left"&gt;TINYINT&lt;/td&gt;
&lt;td style="text-align: left"&gt;1 字节&lt;/td&gt;
&lt;td style="text-align: left"&gt;(-128，127)&lt;/td&gt;
&lt;td style="text-align: left"&gt;(0，255)&lt;/td&gt;
&lt;td style="text-align: left"&gt;小整数值&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style="text-align: left"&gt;SMALLINT&lt;/td&gt;
&lt;td style="text-align: left"&gt;2 字节&lt;/td&gt;
&lt;td style="text-align: left"&gt;(-32 768，32 767)&lt;/td&gt;
&lt;td style="text-align: left"&gt;(0，65 535)&lt;/td&gt;
&lt;td style="text-align: left"&gt;大整数值&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style="text-align: left"&gt;MEDIUMINT&lt;/td&gt;
&lt;td style="text-align: left"&gt;3 字节&lt;/td&gt;
&lt;td style="text-align: left"&gt;(-8 388 608，8 388 607)&lt;/td&gt;
&lt;td style="text-align: left"&gt;(0，16 777 215)&lt;/td&gt;
&lt;td style="text-align: left"&gt;大整数值&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style="text-align: left"&gt;INT或INTEGER&lt;/td&gt;
&lt;td style="text-align: left"&gt;4 字节&lt;/td&gt;
&lt;td style="text-align: left"&gt;(-2 147 483 648，2 147 483 647)&lt;/td&gt;
&lt;td style="text-align: left"&gt;(0，4 294 967 295)&lt;/td&gt;
&lt;td style="text-align: left"&gt;大整数值&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style="text-align: left"&gt;BIGINT&lt;/td&gt;
&lt;td style="text-align: left"&gt;8 字节&lt;/td&gt;
&lt;td style="text-align: left"&gt;(-9 233 372 036 854 775 808，9 223 372 036 854 775 807)&lt;/td&gt;
&lt;td style="text-align: left"&gt;(0，18 446 744 073 709 551 615)&lt;/td&gt;
&lt;td style="text-align: left"&gt;极大整数值&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style="text-align: left"&gt;FLOAT&lt;/td&gt;
&lt;td style="text-align: left"&gt;4 字节&lt;/td&gt;
&lt;td style="text-align: left"&gt;(-3.402 823 466 E+38，-1.175 494 351 E-38)，0，(1.175 494 351 E-38，3.402 823 466 351 E+38)&lt;/td&gt;
&lt;td style="text-align: left"&gt;0，(1.175 494 351 E-38，3.402 823 466 E+38)&lt;/td&gt;
&lt;td style="text-align: left"&gt;单精度 浮点数值&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style="text-align: left"&gt;DOUBLE&lt;/td&gt;
&lt;td style="text-align: left"&gt;8 字节&lt;/td&gt;
&lt;td style="text-align: left"&gt;(-1.797 693 134 862 315 7 E+308，-2.225 073 858 507 201 4 E-308)，0，(2.225 073 858 507 201 4 E-308，1.797 693 134 862 315 7 E+308)&lt;/td&gt;
&lt;td style="text-align: left"&gt;0，(2.225 073 858 507 201 4 E-308，1.797 693 134 862 315 7 E+308)&lt;/td&gt;
&lt;td style="text-align: left"&gt;双精度 浮点数值&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style="text-align: left"&gt;DECIMAL&lt;/td&gt;
&lt;td style="text-align: left"&gt;对DECIMAL(M,D) ，如果M&amp;gt;D，为M+2否则为D+2&lt;/td&gt;
&lt;td style="text-align: left"&gt;依赖于M和D的值&lt;/td&gt;
&lt;td style="text-align: left"&gt;依赖于M和D的值&lt;/td&gt;
&lt;td style="text-align: left"&gt;小数值&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;hr&gt;
&lt;h2 id="日期和时间类型"&gt;日期和时间类型&lt;/h2&gt;
&lt;p&gt;表示时间值的日期和时间类型为DATETIME、DATE、TIMESTAMP、TIME和YEAR。&lt;/p&gt;</description><content:encoded><![CDATA[<h2 id="数值类型">数值类型</h2>
<p>MySQL支持所有标准SQL数值数据类型。</p>
<p>这些类型包括严格数值数据类型(INTEGER、SMALLINT、DECIMAL和NUMERIC)，以及近似数值数据类型(FLOAT、REAL和DOUBLE PRECISION)。</p>
<p>关键字INT是INTEGER的同义词，关键字DEC是DECIMAL的同义词。</p>
<p>BIT数据类型保存位字段值，并且支持MyISAM、MEMORY、InnoDB和BDB表。</p>
<p>作为SQL标准的扩展，MySQL也支持整数类型TINYINT、MEDIUMINT和BIGINT。下面的表显示了需要的每个整数类型的存储和范围。</p>
<table>
  <thead>
      <tr>
          <th style="text-align: left">类型</th>
          <th style="text-align: left">大小</th>
          <th style="text-align: left">范围（有符号）</th>
          <th style="text-align: left">范围（无符号）</th>
          <th style="text-align: left">用途</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">TINYINT</td>
          <td style="text-align: left">1 字节</td>
          <td style="text-align: left">(-128，127)</td>
          <td style="text-align: left">(0，255)</td>
          <td style="text-align: left">小整数值</td>
      </tr>
      <tr>
          <td style="text-align: left">SMALLINT</td>
          <td style="text-align: left">2 字节</td>
          <td style="text-align: left">(-32 768，32 767)</td>
          <td style="text-align: left">(0，65 535)</td>
          <td style="text-align: left">大整数值</td>
      </tr>
      <tr>
          <td style="text-align: left">MEDIUMINT</td>
          <td style="text-align: left">3 字节</td>
          <td style="text-align: left">(-8 388 608，8 388 607)</td>
          <td style="text-align: left">(0，16 777 215)</td>
          <td style="text-align: left">大整数值</td>
      </tr>
      <tr>
          <td style="text-align: left">INT或INTEGER</td>
          <td style="text-align: left">4 字节</td>
          <td style="text-align: left">(-2 147 483 648，2 147 483 647)</td>
          <td style="text-align: left">(0，4 294 967 295)</td>
          <td style="text-align: left">大整数值</td>
      </tr>
      <tr>
          <td style="text-align: left">BIGINT</td>
          <td style="text-align: left">8 字节</td>
          <td style="text-align: left">(-9 233 372 036 854 775 808，9 223 372 036 854 775 807)</td>
          <td style="text-align: left">(0，18 446 744 073 709 551 615)</td>
          <td style="text-align: left">极大整数值</td>
      </tr>
      <tr>
          <td style="text-align: left">FLOAT</td>
          <td style="text-align: left">4 字节</td>
          <td style="text-align: left">(-3.402 823 466 E+38，-1.175 494 351 E-38)，0，(1.175 494 351 E-38，3.402 823 466 351 E+38)</td>
          <td style="text-align: left">0，(1.175 494 351 E-38，3.402 823 466 E+38)</td>
          <td style="text-align: left">单精度 浮点数值</td>
      </tr>
      <tr>
          <td style="text-align: left">DOUBLE</td>
          <td style="text-align: left">8 字节</td>
          <td style="text-align: left">(-1.797 693 134 862 315 7 E+308，-2.225 073 858 507 201 4 E-308)，0，(2.225 073 858 507 201 4 E-308，1.797 693 134 862 315 7 E+308)</td>
          <td style="text-align: left">0，(2.225 073 858 507 201 4 E-308，1.797 693 134 862 315 7 E+308)</td>
          <td style="text-align: left">双精度 浮点数值</td>
      </tr>
      <tr>
          <td style="text-align: left">DECIMAL</td>
          <td style="text-align: left">对DECIMAL(M,D) ，如果M&gt;D，为M+2否则为D+2</td>
          <td style="text-align: left">依赖于M和D的值</td>
          <td style="text-align: left">依赖于M和D的值</td>
          <td style="text-align: left">小数值</td>
      </tr>
  </tbody>
</table>
<hr>
<h2 id="日期和时间类型">日期和时间类型</h2>
<p>表示时间值的日期和时间类型为DATETIME、DATE、TIMESTAMP、TIME和YEAR。</p>
<p>每个时间类型有一个有效值范围和一个&quot;零&quot;值，当指定不合法的MySQL不能表示的值时使用&quot;零&quot;值。</p>
<p>TIMESTAMP类型有专有的自动更新特性，将在后面描述。</p>
<table>
  <thead>
      <tr>
          <th style="text-align: left">类型</th>
          <th style="text-align: left">大小 (字节)</th>
          <th style="text-align: left">范围</th>
          <th style="text-align: left">格式</th>
          <th style="text-align: left">用途</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">DATE</td>
          <td style="text-align: left">3</td>
          <td style="text-align: left">1000-01-01/9999-12-31</td>
          <td style="text-align: left">YYYY-MM-DD</td>
          <td style="text-align: left">日期值</td>
      </tr>
      <tr>
          <td style="text-align: left">TIME</td>
          <td style="text-align: left">3</td>
          <td style="text-align: left">&lsquo;-838:59:59&rsquo;/&lsquo;838:59:59&rsquo;</td>
          <td style="text-align: left">HH:MM:SS</td>
          <td style="text-align: left">时间值或持续时间</td>
      </tr>
      <tr>
          <td style="text-align: left">YEAR</td>
          <td style="text-align: left">1</td>
          <td style="text-align: left">1901/2155</td>
          <td style="text-align: left">YYYY</td>
          <td style="text-align: left">年份值</td>
      </tr>
      <tr>
          <td style="text-align: left">DATETIME</td>
          <td style="text-align: left">8</td>
          <td style="text-align: left">1000-01-01 00:00:00/9999-12-31 23:59:59</td>
          <td style="text-align: left">YYYY-MM-DD HH:MM:SS</td>
          <td style="text-align: left">混合日期和时间值</td>
      </tr>
      <tr>
          <td style="text-align: left">TIMESTAMP</td>
          <td style="text-align: left">4</td>
          <td style="text-align: left">1970-01-01 00:00:00/2038结束时间是第 <strong>2147483647</strong> 秒，北京时间 <strong>2038-1-19 11:14:07</strong>，格林尼治时间 2038年1月19日 凌晨 03:14:07</td>
          <td style="text-align: left">YYYYMMDD HHMMSS</td>
          <td style="text-align: left">混合日期和时间值，时间戳</td>
      </tr>
  </tbody>
</table>
<hr>
<h2 id="字符串类型">字符串类型</h2>
<p>字符串类型指CHAR、VARCHAR、BINARY、VARBINARY、BLOB、TEXT、ENUM和SET。该节描述了这些类型如何工作以及如何在查询中使用这些类型。</p>
<table>
  <thead>
      <tr>
          <th style="text-align: left">类型</th>
          <th style="text-align: left">大小</th>
          <th style="text-align: left">用途</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">CHAR</td>
          <td style="text-align: left">0-255字节</td>
          <td style="text-align: left">定长字符串</td>
      </tr>
      <tr>
          <td style="text-align: left">VARCHAR</td>
          <td style="text-align: left">0-65535 字节</td>
          <td style="text-align: left">变长字符串</td>
      </tr>
      <tr>
          <td style="text-align: left">TINYBLOB</td>
          <td style="text-align: left">0-255字节</td>
          <td style="text-align: left">不超过 255 个字符的二进制字符串</td>
      </tr>
      <tr>
          <td style="text-align: left">TINYTEXT</td>
          <td style="text-align: left">0-255字节</td>
          <td style="text-align: left">短文本字符串</td>
      </tr>
      <tr>
          <td style="text-align: left">BLOB</td>
          <td style="text-align: left">0-65 535字节</td>
          <td style="text-align: left">二进制形式的长文本数据</td>
      </tr>
      <tr>
          <td style="text-align: left">TEXT</td>
          <td style="text-align: left">0-65 535字节</td>
          <td style="text-align: left">长文本数据</td>
      </tr>
      <tr>
          <td style="text-align: left">MEDIUMBLOB</td>
          <td style="text-align: left">0-16 777 215字节</td>
          <td style="text-align: left">二进制形式的中等长度文本数据</td>
      </tr>
      <tr>
          <td style="text-align: left">MEDIUMTEXT</td>
          <td style="text-align: left">0-16 777 215字节</td>
          <td style="text-align: left">中等长度文本数据</td>
      </tr>
      <tr>
          <td style="text-align: left">LONGBLOB</td>
          <td style="text-align: left">0-4 294 967 295字节</td>
          <td style="text-align: left">二进制形式的极大文本数据</td>
      </tr>
      <tr>
          <td style="text-align: left">LONGTEXT</td>
          <td style="text-align: left">0-4 294 967 295字节</td>
          <td style="text-align: left">极大文本数据</td>
      </tr>
  </tbody>
</table>
<p>CHAR 和 VARCHAR 类型类似，但它们保存和检索的方式不同。它们的最大长度和是否尾部空格被保留等方面也不同。在存储或检索过程中不进行大小写转换。</p>
<p>BINARY 和 VARBINARY 类似于 CHAR 和 VARCHAR，不同的是它们包含二进制字符串而不要非二进制字符串。也就是说，它们包含字节字符串而不是字符字符串。这说明它们没有字符集，并且排序和比较基于列值字节的数值值。</p>
<p>BLOB 是一个二进制大对象，可以容纳可变数量的数据。有 4 种 BLOB 类型：TINYBLOB、BLOB、MEDIUMBLOB 和 LONGBLOB。它们区别在于可容纳存储范围不同。</p>
<p>有 4 种 TEXT 类型：TINYTEXT、TEXT、MEDIUMTEXT 和 LONGTEXT。对应的这 4 种 BLOB 类型，可存储的最大长度不同，可根据实际情况选择。</p>
<h2 id="文章转自">文章转自</h2>
<ul>
<li><a href="http://www.runoob.com/mysql/mysql-data-types.html">http://www.runoob.com/mysql/mysql-data-types.html</a></li>
</ul>
]]></content:encoded><category>database</category><category>mysql</category></item><item><title>MySQL数据完整性约束</title><link>https://daemon365.dev/post/database/mysql_data_integrity_constraints/</link><pubDate>Tue, 31 Mar 2020 00:00:00 +0800</pubDate><guid>https://daemon365.dev/post/database/mysql_data_integrity_constraints/</guid><description>&lt;h2 id="主键约束"&gt;主键约束&lt;/h2&gt;
&lt;p&gt;主键可以是表中的某一列，也可以是表中的多个列所构成的一个组合；其中，由多个列组合而成的主键也称为复合主键。在MySQL中，主键列必须遵守以下规则。&lt;/p&gt;
&lt;p&gt;（1）每一个表只能定义一个主键。&lt;/p&gt;
&lt;p&gt;（2）唯一性原则。主键的值，也称键值，必须能够唯一表示表中的每一条记录，且不能为NULL。&lt;/p&gt;
&lt;p&gt;（3）最小化规则。复合主键不能包含不必要的多余列。也就是说，当从一个复合主键中删除一列后，如果剩下的列构成的主键仍能满足唯一性原则，那么这个复合主键是不正确的。&lt;/p&gt;
&lt;p&gt;（4）一个列名在复合主键的列表中只能出现一次。&lt;/p&gt;
&lt;p&gt;示例：创建学生信息表tb_student时，将学号（stu_id）字段设置为主键。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-sql" data-lang="sql"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;CREATE&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;TABLE&lt;/span&gt; &lt;span style="color:#111"&gt;tb_student&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;stu_id&lt;/span&gt; &lt;span style="color:#111"&gt;INT&lt;/span&gt; &lt;span style="color:#111"&gt;AUTO_INCREMENT&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;PRIMARY&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;KEY&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;name&lt;/span&gt; &lt;span style="color:#111"&gt;VARCHAR&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;30&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;示例：创建用户信息表tb_student时，将学号（stu_id）和所在班级号（class_id）字段设置为复合主键。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-sql" data-lang="sql"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;CREATE&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;TABLE&lt;/span&gt; &lt;span style="color:#111"&gt;tb_student&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;stu_id&lt;/span&gt; &lt;span style="color:#111"&gt;INT&lt;/span&gt; &lt;span style="color:#111"&gt;AUTO_INCREMENT&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;name&lt;/span&gt; &lt;span style="color:#111"&gt;VARCHAR&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;30&lt;/span&gt;&lt;span style="color:#111"&gt;),&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;class_id&lt;/span&gt; &lt;span style="color:#111"&gt;INT&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;NOT&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;NULL&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;PRIMARY&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;KEY&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#111"&gt;stu_id&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt;&lt;span style="color:#111"&gt;class_id&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;示例：通过修改数据表结构，添加主键约束。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-sql" data-lang="sql"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;ALTER&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;TABLE&lt;/span&gt; &lt;span style="color:#111"&gt;tb_student&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;ADD&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;CONSTRAINT&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;PRIMARY&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;KEY&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#111"&gt;stu_id&lt;/span&gt;&lt;span style="color:#111"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id="唯一约束"&gt;唯一约束&lt;/h2&gt;
&lt;p&gt;唯一约束使用UNIQUE关键字来定义。唯一约束的值必须是唯一的，且不能为空（NULL）。&lt;/p&gt;
&lt;p&gt;在MySQL中，唯一约束与主键之间存在以下两点区别。&lt;/p&gt;
&lt;p&gt;（1）一个表只能创建一个主键，但可以定义多个唯一约束。&lt;/p&gt;
&lt;p&gt;（2）定义主键约束时，系统会自动创建PRIMARY KEY索引，而定义候选键约束时，系统会自动创建UNIQUE索引。&lt;/p&gt;
&lt;p&gt;示例：创建用户信息表tb_student时，将学号（stu_id）和姓名（name）设置为唯一约束。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-sql" data-lang="sql"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;CREATE&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;TABLE&lt;/span&gt; &lt;span style="color:#111"&gt;tb_student&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;stu_id&lt;/span&gt; &lt;span style="color:#111"&gt;INT&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;UNIQUE&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;name&lt;/span&gt; &lt;span style="color:#111"&gt;VARCHAR&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;30&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;UNIQUE&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;示例：创建用户信息表tb_student时，将学号（stu_id）和姓名（name）字段设置为复合唯一约束。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-sql" data-lang="sql"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;CREATE&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;TABLE&lt;/span&gt; &lt;span style="color:#111"&gt;tb_student&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;stu_id&lt;/span&gt; &lt;span style="color:#111"&gt;INT&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;name&lt;/span&gt; &lt;span style="color:#111"&gt;VARCHAR&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;30&lt;/span&gt;&lt;span style="color:#111"&gt;),&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;UNIQUE&lt;/span&gt; &lt;span style="color:#111"&gt;uniq_id_name&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#111"&gt;stu_id&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt;&lt;span style="color:#111"&gt;name&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;示例：通过修改数据表结构，添加唯一约束。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-sql" data-lang="sql"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;ALTER&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;TABLE&lt;/span&gt; &lt;span style="color:#111"&gt;tb_student&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;ADD&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;CONSTRAINT&lt;/span&gt; &lt;span style="color:#111"&gt;uniq_id_name&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;UNIQUE&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#111"&gt;stu_id&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt;&lt;span style="color:#111"&gt;name&lt;/span&gt;&lt;span style="color:#111"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id="外键约束"&gt;外键约束&lt;/h2&gt;
&lt;p&gt;MySQL有两种常用的引擎类型（MyISAM和InnoDB），目前，只用InnoDB引擎类型支持外键约束。&lt;/p&gt;
&lt;p&gt;示例：创建班级信息表（tb_class）和学生信息表（tb_student），并设置学生信息表中班级编号（class_id）字段的外键约束。&lt;/p&gt;
&lt;p&gt;&amp;ndash; 创建班级信息表&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-sql" data-lang="sql"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;CREATE&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;TABLE&lt;/span&gt; &lt;span style="color:#111"&gt;tb_class&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;class_id&lt;/span&gt; &lt;span style="color:#111"&gt;INT&lt;/span&gt; &lt;span style="color:#111"&gt;AUTO_INCREMENT&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;PRIMARY&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;KEY&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;class_name&lt;/span&gt; &lt;span style="color:#111"&gt;VARCHAR&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;30&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;NOT&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;NULL&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&amp;ndash; 创建学生信息表，并设置班级ID的外键约束&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-sql" data-lang="sql"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;CREATE&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;TABLE&lt;/span&gt; &lt;span style="color:#111"&gt;tb_student&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;stu_id&lt;/span&gt; &lt;span style="color:#111"&gt;INT&lt;/span&gt; &lt;span style="color:#111"&gt;AUTO_INCREMENT&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;PRIMARY&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;KEY&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;name&lt;/span&gt; &lt;span style="color:#111"&gt;VARCHAR&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;30&lt;/span&gt;&lt;span style="color:#111"&gt;),&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;class_id&lt;/span&gt; &lt;span style="color:#111"&gt;INT&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;NOT&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;NULL&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;FOREIGN&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;KEY&lt;/span&gt; &lt;span style="color:#111"&gt;fk_class_id&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#111"&gt;class_id&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;REFERENCES&lt;/span&gt; &lt;span style="color:#111"&gt;tb_class&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#111"&gt;class_id&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;示例：通过修改数据表结构，添加外键约束。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-sql" data-lang="sql"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;ALTER&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;TABLE&lt;/span&gt; &lt;span style="color:#111"&gt;tb_student&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;ADD&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;CONSTRAINT&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;FOREIGN&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;KEY&lt;/span&gt; &lt;span style="color:#111"&gt;fk_class_id&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#111"&gt;class_id&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;REFERENCES&lt;/span&gt; &lt;span style="color:#111"&gt;tb_class&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#111"&gt;class_id&lt;/span&gt;&lt;span style="color:#111"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id="非空约束"&gt;非空约束&lt;/h2&gt;
&lt;p&gt;非空约约束就是限制必须为某个列提供值。空值（NULL）是不存在值，它既不是数字0，也不是空字符串，而是不存在、未知的情况。&lt;/p&gt;
&lt;p&gt;示例：创建学生信息表tb_student时，将姓名（name）字段添加为非空约束。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-sql" data-lang="sql"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;CREATE&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;TABLE&lt;/span&gt; &lt;span style="color:#111"&gt;tb_student&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;stu_id&lt;/span&gt; &lt;span style="color:#111"&gt;INT&lt;/span&gt; &lt;span style="color:#111"&gt;AUTO_INCREMENT&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;PRIMARY&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;KEY&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;name&lt;/span&gt; &lt;span style="color:#111"&gt;VARCHAR&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;30&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;NOT&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;NULL&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;示例：通过修改数据表结构，将姓名（name）字段修改为非空。&lt;/p&gt;</description><content:encoded><![CDATA[<h2 id="主键约束">主键约束</h2>
<p>主键可以是表中的某一列，也可以是表中的多个列所构成的一个组合；其中，由多个列组合而成的主键也称为复合主键。在MySQL中，主键列必须遵守以下规则。</p>
<p>（1）每一个表只能定义一个主键。</p>
<p>（2）唯一性原则。主键的值，也称键值，必须能够唯一表示表中的每一条记录，且不能为NULL。</p>
<p>（3）最小化规则。复合主键不能包含不必要的多余列。也就是说，当从一个复合主键中删除一列后，如果剩下的列构成的主键仍能满足唯一性原则，那么这个复合主键是不正确的。</p>
<p>（4）一个列名在复合主键的列表中只能出现一次。</p>
<p>示例：创建学生信息表tb_student时，将学号（stu_id）字段设置为主键。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#00a8c8">CREATE</span> <span style="color:#00a8c8">TABLE</span> <span style="color:#111">tb_student</span>
</span></span><span style="display:flex;"><span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">stu_id</span> <span style="color:#111">INT</span> <span style="color:#111">AUTO_INCREMENT</span> <span style="color:#00a8c8">PRIMARY</span> <span style="color:#00a8c8">KEY</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">name</span> <span style="color:#111">VARCHAR</span><span style="color:#111">(</span><span style="color:#ae81ff">30</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">);</span>
</span></span></code></pre></div><p>示例：创建用户信息表tb_student时，将学号（stu_id）和所在班级号（class_id）字段设置为复合主键。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#00a8c8">CREATE</span> <span style="color:#00a8c8">TABLE</span> <span style="color:#111">tb_student</span>
</span></span><span style="display:flex;"><span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">stu_id</span> <span style="color:#111">INT</span> <span style="color:#111">AUTO_INCREMENT</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">name</span> <span style="color:#111">VARCHAR</span><span style="color:#111">(</span><span style="color:#ae81ff">30</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">class_id</span> <span style="color:#111">INT</span> <span style="color:#00a8c8">NOT</span> <span style="color:#00a8c8">NULL</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">PRIMARY</span> <span style="color:#00a8c8">KEY</span> <span style="color:#111">(</span><span style="color:#111">stu_id</span><span style="color:#111">,</span><span style="color:#111">class_id</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">);</span>
</span></span></code></pre></div><p>示例：通过修改数据表结构，添加主键约束。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#00a8c8">ALTER</span> <span style="color:#00a8c8">TABLE</span> <span style="color:#111">tb_student</span> <span style="color:#00a8c8">ADD</span> <span style="color:#00a8c8">CONSTRAINT</span> <span style="color:#00a8c8">PRIMARY</span> <span style="color:#00a8c8">KEY</span><span style="color:#111">(</span><span style="color:#111">stu_id</span><span style="color:#111">);</span>
</span></span></code></pre></div><h2 id="唯一约束">唯一约束</h2>
<p>唯一约束使用UNIQUE关键字来定义。唯一约束的值必须是唯一的，且不能为空（NULL）。</p>
<p>在MySQL中，唯一约束与主键之间存在以下两点区别。</p>
<p>（1）一个表只能创建一个主键，但可以定义多个唯一约束。</p>
<p>（2）定义主键约束时，系统会自动创建PRIMARY KEY索引，而定义候选键约束时，系统会自动创建UNIQUE索引。</p>
<p>示例：创建用户信息表tb_student时，将学号（stu_id）和姓名（name）设置为唯一约束。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#00a8c8">CREATE</span> <span style="color:#00a8c8">TABLE</span> <span style="color:#111">tb_student</span>
</span></span><span style="display:flex;"><span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">stu_id</span> <span style="color:#111">INT</span> <span style="color:#00a8c8">UNIQUE</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">name</span> <span style="color:#111">VARCHAR</span><span style="color:#111">(</span><span style="color:#ae81ff">30</span><span style="color:#111">)</span> <span style="color:#00a8c8">UNIQUE</span>
</span></span><span style="display:flex;"><span><span style="color:#111">);</span>
</span></span></code></pre></div><p>示例：创建用户信息表tb_student时，将学号（stu_id）和姓名（name）字段设置为复合唯一约束。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#00a8c8">CREATE</span> <span style="color:#00a8c8">TABLE</span> <span style="color:#111">tb_student</span>
</span></span><span style="display:flex;"><span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">stu_id</span> <span style="color:#111">INT</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">name</span> <span style="color:#111">VARCHAR</span><span style="color:#111">(</span><span style="color:#ae81ff">30</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">UNIQUE</span> <span style="color:#111">uniq_id_name</span> <span style="color:#111">(</span><span style="color:#111">stu_id</span><span style="color:#111">,</span><span style="color:#111">name</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">);</span>
</span></span></code></pre></div><p>示例：通过修改数据表结构，添加唯一约束。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#00a8c8">ALTER</span> <span style="color:#00a8c8">TABLE</span> <span style="color:#111">tb_student</span> <span style="color:#00a8c8">ADD</span> <span style="color:#00a8c8">CONSTRAINT</span> <span style="color:#111">uniq_id_name</span> <span style="color:#00a8c8">UNIQUE</span><span style="color:#111">(</span><span style="color:#111">stu_id</span><span style="color:#111">,</span><span style="color:#111">name</span><span style="color:#111">);</span>
</span></span></code></pre></div><h2 id="外键约束">外键约束</h2>
<p>MySQL有两种常用的引擎类型（MyISAM和InnoDB），目前，只用InnoDB引擎类型支持外键约束。</p>
<p>示例：创建班级信息表（tb_class）和学生信息表（tb_student），并设置学生信息表中班级编号（class_id）字段的外键约束。</p>
<p>&ndash; 创建班级信息表</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#00a8c8">CREATE</span> <span style="color:#00a8c8">TABLE</span> <span style="color:#111">tb_class</span>
</span></span><span style="display:flex;"><span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">class_id</span> <span style="color:#111">INT</span> <span style="color:#111">AUTO_INCREMENT</span> <span style="color:#00a8c8">PRIMARY</span> <span style="color:#00a8c8">KEY</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">class_name</span> <span style="color:#111">VARCHAR</span><span style="color:#111">(</span><span style="color:#ae81ff">30</span><span style="color:#111">)</span> <span style="color:#00a8c8">NOT</span> <span style="color:#00a8c8">NULL</span>
</span></span><span style="display:flex;"><span><span style="color:#111">);</span>
</span></span></code></pre></div><p>&ndash; 创建学生信息表，并设置班级ID的外键约束</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#00a8c8">CREATE</span> <span style="color:#00a8c8">TABLE</span> <span style="color:#111">tb_student</span>
</span></span><span style="display:flex;"><span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">stu_id</span> <span style="color:#111">INT</span> <span style="color:#111">AUTO_INCREMENT</span> <span style="color:#00a8c8">PRIMARY</span> <span style="color:#00a8c8">KEY</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">name</span> <span style="color:#111">VARCHAR</span><span style="color:#111">(</span><span style="color:#ae81ff">30</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">class_id</span> <span style="color:#111">INT</span> <span style="color:#00a8c8">NOT</span> <span style="color:#00a8c8">NULL</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">FOREIGN</span> <span style="color:#00a8c8">KEY</span> <span style="color:#111">fk_class_id</span> <span style="color:#111">(</span><span style="color:#111">class_id</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">REFERENCES</span> <span style="color:#111">tb_class</span><span style="color:#111">(</span><span style="color:#111">class_id</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">);</span>
</span></span></code></pre></div><p>示例：通过修改数据表结构，添加外键约束。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#00a8c8">ALTER</span> <span style="color:#00a8c8">TABLE</span> <span style="color:#111">tb_student</span> <span style="color:#00a8c8">ADD</span> <span style="color:#00a8c8">CONSTRAINT</span> <span style="color:#00a8c8">FOREIGN</span> <span style="color:#00a8c8">KEY</span> <span style="color:#111">fk_class_id</span> <span style="color:#111">(</span><span style="color:#111">class_id</span><span style="color:#111">)</span> <span style="color:#00a8c8">REFERENCES</span> <span style="color:#111">tb_class</span><span style="color:#111">(</span><span style="color:#111">class_id</span><span style="color:#111">);</span>
</span></span></code></pre></div><h2 id="非空约束">非空约束</h2>
<p>非空约约束就是限制必须为某个列提供值。空值（NULL）是不存在值，它既不是数字0，也不是空字符串，而是不存在、未知的情况。</p>
<p>示例：创建学生信息表tb_student时，将姓名（name）字段添加为非空约束。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#00a8c8">CREATE</span> <span style="color:#00a8c8">TABLE</span> <span style="color:#111">tb_student</span>
</span></span><span style="display:flex;"><span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">stu_id</span> <span style="color:#111">INT</span> <span style="color:#111">AUTO_INCREMENT</span> <span style="color:#00a8c8">PRIMARY</span> <span style="color:#00a8c8">KEY</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">name</span> <span style="color:#111">VARCHAR</span><span style="color:#111">(</span><span style="color:#ae81ff">30</span><span style="color:#111">)</span> <span style="color:#00a8c8">NOT</span> <span style="color:#00a8c8">NULL</span>
</span></span><span style="display:flex;"><span><span style="color:#111">);</span>
</span></span></code></pre></div><p>示例：通过修改数据表结构，将姓名（name）字段修改为非空。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#00a8c8">ALTER</span> <span style="color:#00a8c8">TABLE</span> <span style="color:#111">tb_student</span> <span style="color:#00a8c8">MODIFY</span> <span style="color:#00a8c8">COLUMN</span> <span style="color:#111">name</span> <span style="color:#111">VARCHAR</span><span style="color:#111">(</span><span style="color:#ae81ff">30</span><span style="color:#111">)</span> <span style="color:#00a8c8">NOT</span> <span style="color:#00a8c8">NULL</span><span style="color:#111">;</span>
</span></span></code></pre></div><h2 id="检查约束">检查约束</h2>
<p>检查约束用来指定某列的可取值的范围，它通过限制输入到列中的值来强制域的完整性。</p>
<p>示例：创建学生信息表tb_student时，将年龄（age）的值设置在7至18之间（不包括18）的数值。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#00a8c8">CREATE</span> <span style="color:#00a8c8">TABLE</span> <span style="color:#111">tb_student</span>
</span></span><span style="display:flex;"><span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">stu_id</span> <span style="color:#111">INT</span> <span style="color:#111">AUTO_INCREMENT</span> <span style="color:#00a8c8">PRIMARY</span> <span style="color:#00a8c8">KEY</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">name</span> <span style="color:#111">VARCHAR</span><span style="color:#111">(</span><span style="color:#ae81ff">30</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">age</span> <span style="color:#111">INT</span> <span style="color:#00a8c8">NOT</span> <span style="color:#00a8c8">NULL</span> <span style="color:#00a8c8">CHECK</span><span style="color:#111">(</span><span style="color:#111">age</span><span style="color:#f92672">&gt;=</span><span style="color:#ae81ff">7</span> <span style="color:#00a8c8">AND</span> <span style="color:#111">age</span><span style="color:#f92672">&lt;</span><span style="color:#ae81ff">18</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">);</span>
</span></span></code></pre></div><p>注意：目前的MySQL版本只是对CHECK约束进行了分析处理，但会被直接忽略，并不会报错。</p>
<h2 id="约束的删除">约束的删除</h2>
<p>删除约束语法：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#00a8c8">ALTER</span> <span style="color:#00a8c8">TABLE</span> <span style="color:#960050;background-color:#1e0010">表名</span> <span style="color:#00a8c8">DROP</span> <span style="color:#111">[</span><span style="color:#00a8c8">FOREIGN</span> <span style="color:#00a8c8">KEY</span><span style="color:#f92672">|</span> <span style="color:#00a8c8">INDEX</span> <span style="color:#960050;background-color:#1e0010">约束名称</span><span style="color:#111">]</span><span style="color:#f92672">|</span><span style="color:#111">[</span><span style="color:#00a8c8">PRIMARY</span> <span style="color:#00a8c8">KEY</span><span style="color:#111">]</span>
</span></span></code></pre></div><p>示例：删除约束。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#00a8c8">CREATE</span> <span style="color:#00a8c8">TABLE</span> <span style="color:#111">tb_student</span>
</span></span><span style="display:flex;"><span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">stu_id</span> <span style="color:#111">INT</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">name</span> <span style="color:#111">VARCHAR</span><span style="color:#111">(</span><span style="color:#ae81ff">30</span><span style="color:#111">)</span> <span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">class_id</span> <span style="color:#111">INT</span> <span style="color:#00a8c8">NOT</span> <span style="color:#00a8c8">NULL</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- 主键约束
</span></span></span><span style="display:flex;"><span><span style="color:#00a8c8">PRIMARY</span> <span style="color:#00a8c8">KEY</span><span style="color:#111">(</span><span style="color:#111">stu_id</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- 外键约束
</span></span></span><span style="display:flex;"><span><span style="color:#00a8c8">FOREIGN</span> <span style="color:#00a8c8">KEY</span> <span style="color:#111">fk_class_id</span> <span style="color:#111">(</span><span style="color:#111">class_id</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">REFERENCES</span> <span style="color:#111">tb_class</span><span style="color:#111">(</span><span style="color:#111">class_id</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- 唯一性约束
</span></span></span><span style="display:flex;"><span><span style="color:#00a8c8">UNIQUE</span> <span style="color:#111">uniq_name</span> <span style="color:#111">(</span><span style="color:#111">name</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">);</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- 删除主键约束
</span></span></span><span style="display:flex;"><span><span style="color:#00a8c8">ALTER</span> <span style="color:#00a8c8">TABLE</span> <span style="color:#111">tb_student</span> <span style="color:#00a8c8">DROP</span> <span style="color:#00a8c8">PRIMARY</span> <span style="color:#00a8c8">KEY</span><span style="color:#111">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- 删除外键约束
</span></span></span><span style="display:flex;"><span><span style="color:#00a8c8">ALTER</span> <span style="color:#00a8c8">TABLE</span> <span style="color:#111">tb_student</span> <span style="color:#00a8c8">DROP</span> <span style="color:#00a8c8">FOREIGN</span> <span style="color:#00a8c8">KEY</span> <span style="color:#111">fk_class_id</span><span style="color:#111">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- 删除唯一性约束
</span></span></span><span style="display:flex;"><span><span style="color:#00a8c8">ALTER</span> <span style="color:#00a8c8">TABLE</span> <span style="color:#111">tb_student</span> <span style="color:#00a8c8">DROP</span> <span style="color:#00a8c8">INDEX</span> <span style="color:#111">uniq_name</span><span style="color:#111">;</span>
</span></span></code></pre></div><h2 id="文章转自">文章转自：</h2>
<p><a href="https://blog.csdn.net/pan_junbiao/article/details/86158117">https://blog.csdn.net/pan_junbiao/article/details/86158117</a></p>
]]></content:encoded><category>database</category><category>mysql</category></item><item><title>redis持久化</title><link>https://daemon365.dev/post/database/redis_persistence/</link><pubDate>Sat, 21 Mar 2020 00:00:00 +0800</pubDate><guid>https://daemon365.dev/post/database/redis_persistence/</guid><description>&lt;p&gt;Redis是一种内存型数据库，一旦服务器进程退出，数据库的数据就会丢失，为了解决这个问题，Redis提供了两种持久化的方案，将内存中的数据保存到磁盘中，避免数据的丢失。&lt;/p&gt;
&lt;h2 id="rdb持久化"&gt;RDB持久化&lt;/h2&gt;
&lt;p&gt;redis提供了RDB持久化的功能，这个功能可以将redis在内存中的的状态保存到硬盘中，它可以&lt;strong&gt;手动执行。&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;也可以再redis.conf中配置，&lt;strong&gt;定期执行&lt;/strong&gt;。&lt;/p&gt;
&lt;p&gt;RDB持久化产生的RDB文件是一个&lt;strong&gt;经过压缩&lt;/strong&gt;的&lt;strong&gt;二进制文件&lt;/strong&gt;，这个文件被保存在硬盘中，redis可以通过这个文件还原数据库当时的状态。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;内存数据保存到磁盘&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;在指定的时间间隔内生成数据集的时间点快照（point-in-time snapshot）&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;优点：速度快，适合做备份，主从复制就是基于RDB持久化功能实现&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;rdb通过再redis中使用save命令触发 rdb&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;ol&gt;
&lt;li&gt;rdb配置参数： &lt;code&gt;dir /data/6379/ dbfilename dbmp.rdb&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;每过900秒 有1个操作就进行持久化 save 900秒 1个修改类的操作 save 300秒 10个操作 save 60秒 10000个操作 &lt;code&gt;save 900 1 save 300 10 save 60 10000&lt;/code&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id="redis持久化之rdb实践"&gt;redis持久化之RDB实践&lt;/h3&gt;
&lt;p&gt;1.启动redis服务端,准备配置文件&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;daemonize yes port &lt;span style="color:#ae81ff"&gt;6379&lt;/span&gt; logfile /data/6379/redis.log dir /data/6379 &lt;span style="color:#75715e"&gt;#定义持久化文件存储位置 &lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;dbfilename dbmp.rdb &lt;span style="color:#75715e"&gt;#rdb持久化文件 &lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;bind&lt;/span&gt; 10.0.0.10 127.0.0.1 &lt;span style="color:#75715e"&gt;#redis绑定地址 &lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;requirepass redhat &lt;span style="color:#75715e"&gt;#redis登录密码 &lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;save &lt;span style="color:#ae81ff"&gt;900&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;1&lt;/span&gt; &lt;span style="color:#75715e"&gt;#rdb机制 每900秒 有1个修改记录 &lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;save &lt;span style="color:#ae81ff"&gt;300&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;10&lt;/span&gt; &lt;span style="color:#75715e"&gt;#每300秒 10个修改记录 &lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;save &lt;span style="color:#ae81ff"&gt;60&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;10000&lt;/span&gt; &lt;span style="color:#75715e"&gt;#每60秒内 10000修改记录&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;2.启动redis服务端&lt;/p&gt;
&lt;p&gt;3.登录redis设置一个key&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;redis-cli -a redhat
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;4.此时检查目录，/data/6379底下没有dbmp.rdb文件&lt;/p&gt;
&lt;p&gt;5.通过save触发持久化，将数据写入RDB文件&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;127.0.0.1:6379&amp;gt; &lt;span style="color:#111"&gt;set&lt;/span&gt; age &lt;span style="color:#ae81ff"&gt;18&lt;/span&gt; OK 127.0.0.1:6379&amp;gt; save OK
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id="aof持久化"&gt;AOF持久化&lt;/h2&gt;
&lt;p&gt;AOF（append-only log file）&lt;/p&gt;</description><content:encoded><![CDATA[<p>Redis是一种内存型数据库，一旦服务器进程退出，数据库的数据就会丢失，为了解决这个问题，Redis提供了两种持久化的方案，将内存中的数据保存到磁盘中，避免数据的丢失。</p>
<h2 id="rdb持久化">RDB持久化</h2>
<p>redis提供了RDB持久化的功能，这个功能可以将redis在内存中的的状态保存到硬盘中，它可以<strong>手动执行。</strong></p>
<p>也可以再redis.conf中配置，<strong>定期执行</strong>。</p>
<p>RDB持久化产生的RDB文件是一个<strong>经过压缩</strong>的<strong>二进制文件</strong>，这个文件被保存在硬盘中，redis可以通过这个文件还原数据库当时的状态。</p>
<ul>
<li>
<p>内存数据保存到磁盘</p>
</li>
<li>
<p>在指定的时间间隔内生成数据集的时间点快照（point-in-time snapshot）</p>
</li>
<li>
<p>优点：速度快，适合做备份，主从复制就是基于RDB持久化功能实现</p>
</li>
<li>
<p>rdb通过再redis中使用save命令触发 rdb</p>
</li>
</ul>
<ol>
<li>rdb配置参数： <code>dir /data/6379/ dbfilename dbmp.rdb</code></li>
<li>每过900秒 有1个操作就进行持久化 save 900秒 1个修改类的操作 save 300秒 10个操作 save 60秒 10000个操作  <code>save 900 1 save 300 10 save 60 10000</code></li>
</ol>
<h3 id="redis持久化之rdb实践">redis持久化之RDB实践</h3>
<p>1.启动redis服务端,准备配置文件</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>daemonize yes port <span style="color:#ae81ff">6379</span> logfile /data/6379/redis.log dir /data/6379    <span style="color:#75715e">#定义持久化文件存储位置 </span>
</span></span><span style="display:flex;"><span>dbfilename dbmp.rdb        <span style="color:#75715e">#rdb持久化文件 </span>
</span></span><span style="display:flex;"><span><span style="color:#111">bind</span> 10.0.0.10 127.0.0.1   <span style="color:#75715e">#redis绑定地址 </span>
</span></span><span style="display:flex;"><span>requirepass redhat         <span style="color:#75715e">#redis登录密码 </span>
</span></span><span style="display:flex;"><span>save <span style="color:#ae81ff">900</span> <span style="color:#ae81ff">1</span>                 <span style="color:#75715e">#rdb机制 每900秒 有1个修改记录 </span>
</span></span><span style="display:flex;"><span>save <span style="color:#ae81ff">300</span> <span style="color:#ae81ff">10</span>                <span style="color:#75715e">#每300秒       10个修改记录 </span>
</span></span><span style="display:flex;"><span>save <span style="color:#ae81ff">60</span> <span style="color:#ae81ff">10000</span>              <span style="color:#75715e">#每60秒内     10000修改记录</span>
</span></span></code></pre></div><p>2.启动redis服务端</p>
<p>3.登录redis设置一个key</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>redis-cli -a redhat
</span></span></code></pre></div><p>4.此时检查目录，/data/6379底下没有dbmp.rdb文件</p>
<p>5.通过save触发持久化，将数据写入RDB文件</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>127.0.0.1:6379&gt; <span style="color:#111">set</span> age <span style="color:#ae81ff">18</span> OK 127.0.0.1:6379&gt; save OK
</span></span></code></pre></div><h2 id="aof持久化">AOF持久化</h2>
<p>AOF（append-only log file）</p>
<ul>
<li>
<p>记录服务器执行的所有变更操作命令（例如set del等），并在服务器启动时，通过重新执行这些命令来还原数据集</p>
</li>
<li>
<p>AOF 文件中的命令全部以redis协议的格式保存，新命令追加到文件末尾。</p>
</li>
<li>
<p>优点：最大程序保证数据不丢</p>
</li>
<li>
<p>缺点：日志记录非常大</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>redis-client   写入数据  &gt;  redis-server   同步命令   &gt;  AOF文件
</span></span></code></pre></div><p>配置参数</p>
<pre tabindex="0"><code>AOF持久化配置，两条参数  
appendonly yes appendfsync always   总是修改类的操作  
everysec   每秒做一次持久化  no     依赖于系统自带的缓存大小机制
</code></pre><h3 id="redis持久化之aof实践">redis持久化之AOF实践</h3>
<p>1.准备aof配置文件 redis.conf</p>
<pre tabindex="0"><code>daemonize yes
port 6379 
logfile /data/6379/redis.log 
dir /data/6379 
dbfilename dbmp.rdb 
requirepass redhat 
save 900 1 
save 300 10 
save 60 10000 
appendonly yes 
appendfsync everysec
</code></pre><p>2.启动redis服务</p>
<pre tabindex="0"><code>redis-server /etc/redis.conf
</code></pre><p>3.检查redis数据目录/data/6379/是否产生了aof文件</p>
<pre tabindex="0"><code>[root@web02 6379]## ls appendonly.aof dbmp.rdb redis.log
</code></pre><p>4.登录redis-cli，写入数据，实时检查aof文件信息</p>
<pre tabindex="0"><code>[root@web02 6379]## tail -f appendonly.aof
</code></pre><p>5.设置新key，检查aof信息，然后关闭redis，检查数据是否持久化</p>
<pre tabindex="0"><code>redis-cli -a redhat shutdown  redis-server /etc/redis.conf  redis-cli -a redhat
</code></pre><h2 id="redis-持久化方式有哪些有什么区别">redis 持久化方式有哪些？有什么区别</h2>
<ul>
<li>
<p>rdb：基于快照的持久化，速度更快，一般用作备份，主从复制也是依赖于rdb持久化功能</p>
</li>
<li>
<p>aof：以追加的方式记录redis操作日志的文件。可以最大程度的保证redis数据安全，类似于mysql的binlog</p>
</li>
</ul>
<h2 id="redis不重启切换rdb备份到aof备份">redis不重启，切换RDB备份到AOF备份</h2>
<h3 id="确保redis版本在22以上">确保redis版本在2.2以上</h3>
<pre tabindex="0"><code>[root@pyyuc /data 22:23:30]#redis-server -v
Redis server v=4.0.10 sha=00000000:0 malloc=jemalloc-4.0.3 bits=64 build=64cb6afcf41664c
</code></pre><p>本文在redis4.0中，通过config set命令，达到不重启redis服务，从RDB持久化切换为AOF</p>
<h3 id="实验环境准备">实验环境准备</h3>
<p>redis.conf服务端配置文件</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#75af00">daemonize yes</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">port 6379</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">logfile /data/6379/redis.log</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">dir /data/6379</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">dbfilename  dbmp.rdb</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">save 900 1                    #rdb机制 每900秒 有1个修改记录</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">save 300 10                    #每300秒        10个修改记录</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">save 60  10000                #每60秒内        10000修改记录</span>
</span></span></code></pre></div><p>启动redis服务端</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#75af00">redis-server redis.conf</span>
</span></span></code></pre></div><p>登录redis-cli插入数据，手动持久化</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>127.0.0.1:6379&gt; <span style="color:#111">set</span> name chaoge
</span></span><span style="display:flex;"><span>OK
</span></span><span style="display:flex;"><span>127.0.0.1:6379&gt; <span style="color:#111">set</span> age <span style="color:#ae81ff">18</span>
</span></span><span style="display:flex;"><span>OK
</span></span><span style="display:flex;"><span>127.0.0.1:6379&gt; <span style="color:#111">set</span> addr shahe
</span></span><span style="display:flex;"><span>OK
</span></span><span style="display:flex;"><span>127.0.0.1:6379&gt; save
</span></span><span style="display:flex;"><span>OK
</span></span></code></pre></div><p>检查RDB文件</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@pyyuc /data 22:34:16<span style="color:#f92672">]</span><span style="color:#75715e">#ls 6379/</span>
</span></span><span style="display:flex;"><span>dbmp.rdb  redis.log
</span></span></code></pre></div><h3 id="备份这个rdb文件保证数据安全">备份这个rdb文件，保证数据安全</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@pyyuc /data/6379 22:35:38<span style="color:#f92672">]</span><span style="color:#75715e">#cp dbmp.rdb /opt/</span>
</span></span></code></pre></div><h3 id="执行命令开启aof持久化">执行命令，开启AOF持久化</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>127.0.0.1:6379&gt; CONFIG <span style="color:#111">set</span> appendonly yes   <span style="color:#75715e">#开启AOF功能</span>
</span></span><span style="display:flex;"><span>OK
</span></span><span style="display:flex;"><span>127.0.0.1:6379&gt; CONFIG SET save <span style="color:#d88200">&#34;&#34;</span>  <span style="color:#75715e">#关闭RDB功能</span>
</span></span><span style="display:flex;"><span>OK
</span></span></code></pre></div><h3 id="确保数据库的key数量正确">确保数据库的key数量正确</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>127.0.0.1:6379&gt; keys *
</span></span><span style="display:flex;"><span>1<span style="color:#f92672">)</span> <span style="color:#d88200">&#34;addr&#34;</span>
</span></span><span style="display:flex;"><span>2<span style="color:#f92672">)</span> <span style="color:#d88200">&#34;age&#34;</span>
</span></span><span style="display:flex;"><span>3<span style="color:#f92672">)</span> <span style="color:#d88200">&#34;name&#34;</span>
</span></span></code></pre></div><h3 id="确保插入新的keyaof文件会记录">确保插入新的key，AOF文件会记录</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>127.0.0.1:6379&gt; <span style="color:#111">set</span> title golang
</span></span><span style="display:flex;"><span>OK
</span></span></code></pre></div><p><strong>此时RDB已经正确切换AOF，注意还得修改redis.conf添加AOF设置，不然重启后，通过config set的配置将丢失</strong></p>
]]></content:encoded><category>database</category><category>redis</category></item><item><title>redis基础</title><link>https://daemon365.dev/post/database/redis_basics/</link><pubDate>Fri, 20 Mar 2020 00:00:00 +0800</pubDate><guid>https://daemon365.dev/post/database/redis_basics/</guid><description>&lt;h2 id="redis介绍"&gt;redis介绍&lt;/h2&gt;
&lt;p&gt;Redis 是完全开源的，遵守 BSD 协议，是一个高性能的 key-value 数据库。&lt;/p&gt;
&lt;p&gt;Redis 与其他 key - value 缓存产品有以下三个特点：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Redis支持数据的持久化，可以将内存中的数据保存在磁盘中，重启的时候可以再次加载进行使用。&lt;/li&gt;
&lt;li&gt;Redis不仅仅支持简单的key-value类型的数据，同时还提供list，set，zset，hash等数据结构的存储。&lt;/li&gt;
&lt;li&gt;Redis支持数据的备份，即master-slave模式的数据备份。&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id="redis的安装"&gt;redis的安装&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;brew install redis&lt;span style="color:#f92672"&gt;(&lt;/span&gt;mac&lt;span style="color:#f92672"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;yum install redis&lt;span style="color:#f92672"&gt;(&lt;/span&gt;centos&lt;span style="color:#f92672"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;apt-get install redis&lt;span style="color:#f92672"&gt;(&lt;/span&gt;ubuntu&lt;span style="color:#f92672"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id="redis的命令网站"&gt;redis的命令网站&lt;/h2&gt;
&lt;p&gt;&lt;a href="http://doc.redisfans.com/"&gt;Redis 命令参考 — Redis 命令参考 (redisfans.com)&lt;/a&gt;&lt;/p&gt;
&lt;h2 id="redis的基本操作"&gt;redis的基本操作&lt;/h2&gt;
&lt;h3 id="redis的五大数据类型"&gt;redis的五大数据类型&lt;/h3&gt;
&lt;p&gt;redis的五大数据类型是: &lt;strong&gt;String(字符串)、Hash(哈希)、List(列表)、Set(集合)、和zset(sorted set:有序集合)&lt;/strong&gt;&lt;/p&gt;
&lt;h3 id="redis键操作"&gt;redis键操作&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;keys *&lt;/code&gt;查看当前库所有key (匹配：keys *1)&lt;/li&gt;
&lt;li&gt;&lt;code&gt;exists key&lt;/code&gt;判断某个key是否存在&lt;/li&gt;
&lt;li&gt;&lt;code&gt;type key&lt;/code&gt; 查看你的key是什么类型&lt;/li&gt;
&lt;li&gt;&lt;code&gt;del key&lt;/code&gt; 删除指定的key数据&lt;/li&gt;
&lt;li&gt;&lt;code&gt;unlink key&lt;/code&gt; 根据value选择非阻塞删除 仅将keys从keyspace元数据中删除，真正的删除会在后续异步操作。&lt;/li&gt;
&lt;li&gt;&lt;code&gt;expire key 10 &lt;/code&gt; 10秒钟：为给定的key设置过期时间&lt;/li&gt;
&lt;li&gt;&lt;code&gt;ttl key&lt;/code&gt; 查看还有多少秒过期，-1表示永不过期，-2表示已过期&lt;/li&gt;
&lt;li&gt;&lt;code&gt;select&lt;/code&gt;命令切换数据库&lt;/li&gt;
&lt;li&gt;&lt;code&gt;dbsize&lt;/code&gt;查看当前数据库的key的数量&lt;/li&gt;
&lt;li&gt;&lt;code&gt;flushdb&lt;/code&gt;清空当前库&lt;/li&gt;
&lt;li&gt;&lt;code&gt;flushall&lt;/code&gt;通杀全部库&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id="字符串string"&gt;字符串(String)&lt;/h3&gt;
&lt;h4 id="简介"&gt;简介&lt;/h4&gt;
&lt;p&gt;String是Redis最基本的类型，你可以理解成与Memcached一模一样的类型，一个key对应一个value。&lt;/p&gt;
&lt;p&gt;String类型是二进制安全的。意味着Redis的string可以包含任何数据。比如jpg图片或者序列化的对象。&lt;/p&gt;</description><content:encoded><![CDATA[<h2 id="redis介绍">redis介绍</h2>
<p>Redis 是完全开源的，遵守 BSD 协议，是一个高性能的 key-value 数据库。</p>
<p>Redis 与其他 key - value 缓存产品有以下三个特点：</p>
<ul>
<li>Redis支持数据的持久化，可以将内存中的数据保存在磁盘中，重启的时候可以再次加载进行使用。</li>
<li>Redis不仅仅支持简单的key-value类型的数据，同时还提供list，set，zset，hash等数据结构的存储。</li>
<li>Redis支持数据的备份，即master-slave模式的数据备份。</li>
</ul>
<h3 id="redis的安装">redis的安装</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>brew install redis<span style="color:#f92672">(</span>mac<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>yum install redis<span style="color:#f92672">(</span>centos<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>apt-get install redis<span style="color:#f92672">(</span>ubuntu<span style="color:#f92672">)</span>
</span></span></code></pre></div><h2 id="redis的命令网站">redis的命令网站</h2>
<p><a href="http://doc.redisfans.com/">Redis 命令参考 — Redis 命令参考 (redisfans.com)</a></p>
<h2 id="redis的基本操作">redis的基本操作</h2>
<h3 id="redis的五大数据类型">redis的五大数据类型</h3>
<p>redis的五大数据类型是: <strong>String(字符串)、Hash(哈希)、List(列表)、Set(集合)、和zset(sorted set:有序集合)</strong></p>
<h3 id="redis键操作">redis键操作</h3>
<ul>
<li><code>keys *</code>查看当前库所有key   (匹配：keys *1)</li>
<li><code>exists key</code>判断某个key是否存在</li>
<li><code>type key</code> 查看你的key是什么类型</li>
<li><code>del key</code>    删除指定的key数据</li>
<li><code>unlink key</code>  根据value选择非阻塞删除   仅将keys从keyspace元数据中删除，真正的删除会在后续异步操作。</li>
<li><code>expire key 10 </code> 10秒钟：为给定的key设置过期时间</li>
<li><code>ttl key</code> 查看还有多少秒过期，-1表示永不过期，-2表示已过期</li>
<li><code>select</code>命令切换数据库</li>
<li><code>dbsize</code>查看当前数据库的key的数量</li>
<li><code>flushdb</code>清空当前库</li>
<li><code>flushall</code>通杀全部库</li>
</ul>
<h3 id="字符串string">字符串(String)</h3>
<h4 id="简介">简介</h4>
<p>String是Redis最基本的类型，你可以理解成与Memcached一模一样的类型，一个key对应一个value。</p>
<p>String类型是二进制安全的。意味着Redis的string可以包含任何数据。比如jpg图片或者序列化的对象。</p>
<p>String类型是Redis最基本的数据类型，一个Redis中字符串value最多可以是512M</p>
<h4 id="常用命令">常用命令</h4>
<ul>
<li><code>set  &lt;key&gt;&lt;value&gt;</code>添加键值对</li>
<li><code>get  &lt;key&gt;</code>查询对应键值</li>
<li><code>append  &lt;key&gt;&lt;value&gt;</code>将给定的<value> 追加到原值的末尾</li>
<li><code>strlen  &lt;key&gt;</code>获得值的长度</li>
<li><code>setnx  &lt;key&gt;&lt;value&gt;</code>只有在 key 不存在时   设置 key 的值</li>
<li><code>incr  &lt;key&gt;  </code>将 key 中储存的数字值增1 只能对数字值操作，如果为空，新增值为1</li>
<li><code>decr  &lt;key&gt;</code> 将 key 中储存的数字值减1  只能对数字值操作，如果为空，新增值为-1</li>
<li><code>incrby / decrby  &lt;key&gt;&lt;步长&gt;</code>将 key 中储存的数字值增减。自定义步长。</li>
</ul>
<h4 id="数据结构">数据结构</h4>
<p>String的数据结构为简单动态字符串(Simple Dynamic String,缩写SDS)。是可以修改的字符串，内部结构实现上类似于Java的ArrayList，采用预分配冗余空间的方式来减少内存的频繁分配.</p>
<p><img src="/images/f5606772-f15c-49ef-9c08-6b7f1e6495ea.png" alt=""></p>
<p>如图中所示，内部为当前字符串实际分配的空间capacity一般要高于实际字符串长度len。当字符串长度小于1M时，扩容都是加倍现有的空间，如果超过1M，扩容时一次只会多扩1M的空间。需要注意的是字符串最大长度为512M。</p>
<h3 id="列表list">列表(List)</h3>
<h4 id="简介-1">简介</h4>
<p>单键多值</p>
<p>Redis 列表是简单的字符串列表，按照插入顺序排序。你可以添加一个元素到列表的头部（左边）或者尾部（右边）。</p>
<p>它的底层实际是个双向链表，对两端的操作性能很高，通过索引下标的操作中间的节点性能会较差。</p>
<p><img src="/images/e7492d9c-c6d9-4de0-83b5-fd6482bc3c51.png" alt=""></p>
<h4 id="常用命令-1">常用命令</h4>
<ul>
<li><code>lpush/rpush  &lt;key&gt;&lt;value1&gt;&lt;value2&gt;&lt;value3&gt; ....</code> 从左边/右边插入一个或多个值。</li>
<li><code>lpop/rpop  &lt;key&gt;</code>从左边/右边吐出一个值。值在键在，值光键亡。</li>
<li><code>rpoplpush  &lt;key1&gt;&lt;key2&gt;</code>从<key1>列表右边吐出一个值，插到<key2>列表左边。</li>
<li><code>lrange &lt;key&gt;&lt;start&gt;&lt;stop&gt;</code>  按照索引下标获得元素(从左到右)</li>
<li><code>lrange mylist 0 -1</code>  0左边第一个，-1右边第一个，（0-1表示获取所有）</li>
<li><code>lindex &lt;key&gt;&lt;index&gt;</code>按照索引下标获得元素(从左到右)</li>
<li><code>llen &lt;key&gt;</code>获得列表长度</li>
<li><code>linsert &lt;key&gt;  before &lt;value&gt;&lt;newvalue&gt;</code>在<value>的后面插入<newvalue>插入值</li>
<li><code>lrem &lt;key&gt;&lt;n&gt;&lt;value&gt;</code>从左边删除n个value(从左到右)</li>
<li><code>lset&lt;key&gt;&lt;index&gt;&lt;value&gt;</code>将列表key下标为index的值替换成value</li>
</ul>
<h4 id="数据结构-1">数据结构</h4>
<p>List的数据结构为快速链表quickList。</p>
<p>首先在列表元素较少的情况下会使用一块连续的内存存储，这个结构是ziplist，也即是压缩列表。它将所有的元素紧挨着一起存储，分配的是一块连续的内存。当数据量比较多的时候才会改成quicklist。因为普通的链表需要的附加指针空间太大，会比较浪费空间。比如这个列表里存的只是int类型的数据，结构上还需要两个额外的指针prev和next。</p>
<p><img src="/images/810b0d87-7a3c-416a-87ac-66ad441e8a0a.png" alt=""></p>
<p>Redis将链表和ziplist结合起来组成了quicklist。也就是将多个ziplist使用双向指针串起来使用。这样既满足了快速的插入删除性能，又不会出现太大的空间冗余。</p>
<h3 id="集合set">集合(Set)</h3>
<h4 id="简介-2">简介</h4>
<p>Redis set对外提供的功能与list类似是一个列表的功能，特殊之处在于set是可以****自动排重****的，当你需要存储一个列表数据，又不希望出现重复数据时，set是一个很好的选择，并且set提供了判断某个成员是否在一个set集合内的重要接口，这个也是list所不能提供的。</p>
<p>Redis的Set是string类型的无序集合。它底层其实是一个value为null的hash表，所以添加，删除，查找的****复杂度都是O(1)****。</p>
<p>一个算法，随着数据的增加，执行时间的长短，如果是O(1)，数据增加，查找数据的时间不变</p>
<h4 id="常用命令-2">常用命令</h4>
<ul>
<li><code>sadd &lt;key&gt;&lt;value1&gt;&lt;value2&gt; ..... </code>将一个或多个 member 元素加入到集合 key 中，已经存在的 member 元素将被忽略</li>
<li><code>smembers &lt;key&gt;</code>取出该集合的所有值。</li>
<li><code>sismember &lt;key&gt;&lt;value&gt;</code>判断集合<key>是否为含有该<value>值，有1，没有0</li>
<li><code>scard&lt;key&gt;</code>返回该集合的元素个数。</li>
<li><code>srem &lt;key&gt;&lt;value1&gt;&lt;value2&gt; ....</code> 删除集合中的某个元素。</li>
<li><code>spop &lt;key&gt;</code><em><strong>*随机从该集合中吐出一个值。*</strong></em></li>
<li><code>srandmember &lt;key&gt;&lt;n&gt;</code>随机从该集合中取出n个值。不会从集合中删除 。</li>
<li><code>smove &lt;source&gt;&lt;destination&gt;</code>value把集合中一个值从一个集合移动到另一个集合</li>
<li><code>sinter &lt;key1&gt;&lt;key2&gt;</code>返回两个集合的交集元素。</li>
<li><code>sunion &lt;key1&gt;&lt;key2&gt;</code>返回两个集合的并集元素。</li>
<li><code>sdiff &lt;key1&gt;&lt;key2&gt;</code>返回两个集合的****差集****元素(key1中的，不包含key2中的)</li>
</ul>
<h4 id="数据结构-2">数据结构</h4>
<p>Set数据结构是dict字典，字典是用哈希表实现的。
Java中HashSet的内部实现使用的是HashMap，只不过所有的value都指向同一个对象。Redis的set结构也是一样，它的内部也使用hash结构，所有的value都指向同一个内部值。</p>
<h3 id="哈希hash">哈希(Hash)</h3>
<h4 id="简介-3">简介</h4>
<p>Redis hash 是一个键值对集合。</p>
<p>Redis hash是一个string类型的field和value的映射表，hash特别适合用于存储对象。</p>
<h4 id="常用命令-3">常用命令</h4>
<ul>
<li><code>hset &lt;key&gt;&lt;field&gt;&lt;value&gt;</code>给<key>集合中的  <field>键赋值<value></li>
<li><code>hget &lt;key1&gt;&lt;field&gt;</code>从<key1>集合<field>取出 value</li>
<li><code>hmset &lt;key1&gt;&lt;field1&gt;&lt;value1&gt;&lt;field2&gt;&lt;value2&gt;... </code>批量设置hash的值</li>
<li><code>hexists&lt;key1&gt;&lt;field&gt;</code>查看哈希表 key 中，给定域 field 是否存在。</li>
<li><code>hkeys &lt;key&gt;</code>列出该hash集合的所有field</li>
<li><code>hvals &lt;key&gt;</code>列出该hash集合的所有value</li>
<li><code>hincrby &lt;key&gt;&lt;field&gt;&lt;increment&gt;</code>为哈希表 key 中的域 field 的值加上增量 1  -1</li>
<li><code>hsetnx &lt;key&gt;&lt;field&gt;&lt;value&gt;</code>将哈希表 key 中的域 field 的值设置为 value ，当且仅当域 field 不存在 .</li>
</ul>
<h4 id="数据结构-3">数据结构</h4>
<p>Hash类型对应的数据结构是两种：ziplist（压缩列表），hashtable（哈希表）。当field-value长度较短且个数较少时，使用ziplist，否则使用hashtable。</p>
<h3 id="有序集合zsetsorted-set">有序集合Zset(sorted set)</h3>
<h4 id="简介-4">简介</h4>
<p>Redis有序集合zset与普通集合set非常相似，是一个没有重复元素的字符串集合。</p>
<p>不同之处是有序集合的每个成员都关联了一个****评分（score）****,这个评分（score）被用来按照从最低分到最高分的方式排序集合中的成员。集合的成员是唯一的，但是评分可以是重复了 。</p>
<p>因为元素是有序的, 所以你也可以很快的根据评分（score）或者次序（position）来获取一个范围的元素。</p>
<p>访问有序集合的中间元素也是非常快的,因此你能够使用有序集合作为一个没有重复成员的智能列表。</p>
<h4 id="常用命令-4">常用命令</h4>
<ul>
<li><code>zadd  &lt;key&gt;&lt;score1&gt;&lt;value1&gt;&lt;score2&gt;&lt;value2&gt;… </code>将一个或多个 member 元素及其 score 值加入到有序集 key 当中。</li>
<li><code>zrange &lt;key&gt;&lt;start&gt;&lt;stop&gt;  [WITHSCORES] </code>   返回有序集 key 中，下标在<start><stop>之间的元素带WITHSCORES，可以让分数一起和值返回到结果集。</li>
<li><code>zrangebyscore key minmax [withscores] [limit offset count]</code> 返回有序集 key 中，所有 score 值介于 min 和 max 之间(包括等于 min 或 max )的成员。有序集成员按 score 值递增(从小到大)次序排列。</li>
<li><code>zrevrangebyscore key maxmin [withscores] [limit offset count] </code>         同上，改为从大到小排列。</li>
<li><code>zincrby &lt;key&gt;&lt;increment&gt;&lt;value&gt;</code>    为元素的score加上增量</li>
<li><code>zrem  &lt;key&gt;&lt;value&gt;</code>删除该集合下，指定值的元素</li>
<li><code>zcount &lt;key&gt;&lt;min&gt;&lt;max&gt;</code>统计该集合，分数区间内的元素个数</li>
<li><code>zrank &lt;key&gt;&lt;value&gt;</code>返回该值在集合中的排名，从0开始。</li>
</ul>
<h4 id="数据结构-4">数据结构</h4>
<p>SortedSet(zset)是Redis提供的一个非常特别的数据结构，一方面它等价于Java的数据结构Map&lt;String, Double&gt;，可以给每一个元素value赋予一个权重score，另一方面它又类似于TreeSet，内部的元素会按照权重score进行排序，可以得到每个元素的名次，还可以通过score的范围来获取元素的列表。</p>
<p>zset底层使用了两个数据结构</p>
<ol>
<li>hash，hash的作用就是关联元素value和权重score，保障元素value的唯一性，可以通过元素value找到相应的score值。</li>
<li>跳跃表，跳跃表的目的在于给元素value排序，根据score的范围获取元素列表。</li>
</ol>
<h2 id="redis新数据类型">Redis新数据类型</h2>
<h3 id="bitmaps">Bitmaps</h3>
<h4 id="简介-5">简介</h4>
<p>现代计算机用二进制（位） 作为信息的基础单位， 1个字节等于8位， 例如“abc”字符串是由3个字节组成， 但实际在计算机存储时将其用二进制表示， “abc”分别对应的ASCII码分别是97、 98、 99， 对应的二进制分别是01100001、 01100010和01100011，如下图</p>
<p><img src="/images/4ba572ec-0cd0-471d-8321-46012e72f259.png" alt=""></p>
<p>合理地使用操作位能够有效地提高内存使用率和开发效率。</p>
<p>Redis提供了Bitmaps这个“数据类型”可以实现对位的操作：</p>
<ol>
<li>Bitmaps本身不是一种数据类型， 实际上它就是字符串（key-value） ， 但是它可以对字符串的位进行操作。</li>
<li>Bitmaps单独提供了一套命令， 所以在Redis中使用Bitmaps和使用字符串的方法不太相同。 可以把Bitmaps想象成一个以位为单位的数组， 数组的每个单元只能存储0和1， 数组的下标在Bitmaps中叫做偏移量。</li>
</ol>
<p><img src="/images/38fcab8e-c732-4d37-9712-712a307f36d1.png" alt=""></p>
<h4 id="命令">命令</h4>
<ol>
<li>setbit</li>
</ol>
<p>（1）格式</p>
<p><code>setbit&lt;key&gt;&lt;offset&gt;&lt;value&gt;</code>设置Bitmaps中某个偏移量的值（0或1）</p>
<p><img src="/images/82e8f396-ad55-40db-b4b5-6dc9201c6e33.png" alt=""></p>
<p>*offset:偏移量从0开始</p>
<p>（2）实例</p>
<p>每个独立用户是否访问过网站存放在Bitmaps中， 将访问的用户记做1， 没有访问的用户记做0， 用偏移量作为用户的id。</p>
<p>设置键的第offset个位的值（从0算起） ， 假设现在有20个用户，userid=1， 6， 11， 15， 19的用户对网站进行了访问， 那么当前Bitmaps初始化结果如图</p>
<p><img src="/images/b881197f-9c5a-44f1-a9ec-2f68364ca122.png" alt=""></p>
<p>unique:users:20201106代表2020-11-06这天的独立访问用户的Bitmaps</p>
<p><img src="/images/906ce509-1af2-45c6-9238-4ba96f69eef0.png" alt=""></p>
<p>注：</p>
<p>很多应用的用户id以一个指定数字（例如10000） 开头， 直接将用户id和Bitmaps的偏移量对应势必会造成一定的浪费， 通常的做法是每次做setbit操作时将用户id减去这个指定数字。</p>
<p>在第一次初始化Bitmaps时， 假如偏移量非常大， 那么整个初始化过程执行会比较慢， 可能会造成Redis的阻塞。</p>
<ol start="2">
<li>getbit</li>
</ol>
<p>（1）格式
getbit<key><offset>获取Bitmaps中某个偏移量的值</p>
<p>获取键的第offset位的值（从0开始算）</p>
<p>（2）实例
获取id=8的用户是否在2020-11-06这天访问过， 返回0说明没有访问过</p>
<p><img src="/images/7585a845-40ec-4482-8c9f-03e904de86f1.png" alt=""></p>
<p>注：因为100根本不存在，所以也是返回0</p>
<ol start="3">
<li>bitcount</li>
</ol>
<p>统计字符串被设置为1的bit数。一般情况下，给定的整个字符串都会被进行计数，通过指定额外的 start 或 end 参数，可以让计数只在特定的位上进行。start 和 end 参数的设置，都可以使用负数值：比如 -1 表示最后一个位，而 -2 表示倒数第二个位，start、end 是指bit组的字节的下标数，二者皆包含。
（1）格式
bitcount<key>[start end] 统计字符串从start字节到end字节比特值为1的数量</p>
<p>（2）实例
计算2022-11-06这天的独立访问用户数量</p>
<p>start和end代表起始和结束字节数， 下面操作计算用户id在第1个字节到第3个字节之间的独立访问用户数， 对应的用户id是11， 15， 19。</p>
<pre tabindex="0"><code>举例： K1 【01000001 01000000  00000000 00100001】，对应【0，1，2，3】
bitcount K1 1 2  ： 统计下标1、2字节组中bit=1的个数，即01000000  00000000
--》bitcount K1 1 2 　　--》1

bitcount K1 1 3  ： 统计下标1、2字节组中bit=1的个数，即01000000  00000000 00100001
--》bitcount K1 1 3　　--》3

bitcount K1 0 -2  ： 统计下标0到下标倒数第2，字节组中bit=1的个数，即01000001  01000000   00000000
--》bitcount K1 0 -2　　--》3
</code></pre><p>注意：redis的setbit设置或清除的是bit位置，而bitcount计算的是byte位置。</p>
<ol start="4">
<li>bitop</li>
</ol>
<p>(1)格式
bitop  and(or/not/xor) <destkey> [key…]</p>
<p><img src="/images/8a7cd908-8bf4-4a7e-8811-9c572487fea9.png" alt=""></p>
<p>bitop是一个复合操作， 它可以做多个Bitmaps的and（交集） 、 or（并集） 、 not（非） 、 xor（异或） 操作并将结果保存在destkey中。</p>
<p>(2)实例</p>
<p>2020-11-04 日访问网站的userid=1,2,5,9。</p>
<p>setbit unique:users:20201104 1 1</p>
<p>setbit unique:users:20201104 2 1</p>
<p>setbit unique:users:20201104 5 1</p>
<p>setbit unique:users:20201104 9 1</p>
<p>2020-11-03 日访问网站的userid=0,1,4,9。</p>
<p>setbit unique:users:20201103 0 1</p>
<p>setbit unique:users:20201103 1 1</p>
<p>setbit unique:users:20201103 4 1</p>
<p>setbit unique:users:20201103 9 1</p>
<p>计算出两天都访问过网站的用户数量</p>
<p>bitop and unique:users:and:20201104_03</p>
<p>unique:users:20201103unique:users:20201104</p>
<p><img src="/images/06377b31-60a0-455e-97c8-7febdf1a07ea.png" alt=""></p>
<p><img src="/images/7ee5ed4d-b2bd-43d4-b7a7-5c26c7562a28.png" alt=""></p>
<p>计算出任意一天都访问过网站的用户数量（例如月活跃就是类似这种） ， 可以使用or求并集</p>
<p><img src="/images/0a8dfb0f-51f5-4caa-a615-0304b5f4bbf9.png" alt=""></p>
<h4 id="bitmaps与set对比">Bitmaps与set对比</h4>
<p>假设网站有1亿用户， 每天独立访问的用户有5千万， 如果每天用集合类型和Bitmaps分别存储活跃用户可以得到表</p>
<table>
  <thead>
      <tr>
          <th>set和Bitmaps存储一天活跃用户对比</th>
          <th></th>
          <th></th>
          <th></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>数据类型</td>
          <td>每个用户id占用空间</td>
          <td>需要存储的用户量</td>
          <td>全部内存量</td>
      </tr>
      <tr>
          <td>集合类型</td>
          <td>64位</td>
          <td>50000000</td>
          <td>64位*50000000 = 400MB</td>
      </tr>
      <tr>
          <td>Bitmaps</td>
          <td>1位</td>
          <td>100000000</td>
          <td>1位*100000000 = 12.5MB</td>
      </tr>
  </tbody>
</table>
<p>很明显， 这种情况下使用Bitmaps能节省很多的内存空间， 尤其是随着时间推移节省的内存还是非常可观的</p>
<table>
  <thead>
      <tr>
          <th>set和Bitmaps存储独立用户空间对比</th>
          <th></th>
          <th></th>
          <th></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>数据类型</td>
          <td>一天</td>
          <td>一个月</td>
          <td>一年</td>
      </tr>
      <tr>
          <td>集合类型</td>
          <td>400MB</td>
          <td>12GB</td>
          <td>144GB</td>
      </tr>
      <tr>
          <td>Bitmaps</td>
          <td>12.5MB</td>
          <td>375MB</td>
          <td>4.5GB</td>
      </tr>
  </tbody>
</table>
<p>但Bitmaps并不是万金油， 假如该网站每天的独立访问用户很少， 例如只有10万（大量的僵尸用户） ， 那么两者的对比如下表所示， 很显然， 这时候使用Bitmaps就不太合适了， 因为基本上大部分位都是0。</p>
<table>
  <thead>
      <tr>
          <th>set和Bitmaps存储一天活跃用户对比（独立用户比较少）</th>
          <th></th>
          <th></th>
          <th></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>数据类型</td>
          <td>每个userid占用空间</td>
          <td>需要存储的用户量</td>
          <td>全部内存量</td>
      </tr>
      <tr>
          <td>集合类型</td>
          <td>64位</td>
          <td>100000</td>
          <td>64位*100000 = 800KB</td>
      </tr>
      <tr>
          <td>Bitmaps</td>
          <td>1位</td>
          <td>100000000</td>
          <td>1位*100000000 = 12.5MB</td>
      </tr>
  </tbody>
</table>
<h3 id="hyperloglog">HyperLogLog</h3>
<h4 id="简介-6">简介</h4>
<p>在工作当中，我们经常会遇到与统计相关的功能需求，比如统计网站PV（PageView页面访问量）,可以使用Redis的incr、incrby轻松实现。
但像UV（UniqueVisitor，独立访客）、独立IP数、搜索记录数等需要去重和计数的问题如何解决？这种求集合中不重复元素个数的问题称为基数问题。
解决基数问题有很多种方案：
（1）数据存储在MySQL表中，使用distinct count计算不重复个数</p>
<p>（2）使用Redis提供的hash、set、bitmaps等数据结构来处理</p>
<p>以上的方案结果精确，但随着数据不断增加，导致占用空间越来越大，对于非常大的数据集是不切实际的。</p>
<p>能否能够降低一定的精度来平衡存储空间？Redis推出了HyperLogLog</p>
<p>Redis HyperLogLog 是用来做基数统计的算法，HyperLogLog 的优点是，在输入元素的数量或者体积非常非常大时，计算基数所需的空间总是固定的、并且是很小的。</p>
<p>在 Redis 里面，每个 HyperLogLog 键只需要花费 12 KB 内存，就可以计算接近 2^64 个不同元素的基数。这和计算基数时，元素越多耗费内存就越多的集合形成鲜明对比。</p>
<p>但是，因为 HyperLogLog 只会根据输入元素来计算基数，而不会储存输入元素本身，所以 HyperLogLog 不能像集合那样，返回输入的各个元素。</p>
<p>什么是基数?</p>
<p>比如数据集 {1, 3, 5, 7, 5, 7, 8}， 那么这个数据集的基数集为 {1, 3, 5 ,7, 8}, 基数(不重复元素)为5。 基数估计就是在误差可接受的范围内，快速计算基数。</p>
<h4 id="命令-1">命令</h4>
<p>1、pfadd</p>
<p>（1）格式</p>
<p>pfadd <key>&lt; element&gt; [element &hellip;]  添加指定元素到 HyperLogLog 中</p>
<p><img src="/images/62e21699-dc0f-46bd-82cb-029f3222fbc7.png" alt=""></p>
<p>（2）实例</p>
<p><img src="/images/c2f7d56a-b3f5-4a35-9b22-d974527449b0.png" alt=""></p>
<p>​	将所有元素添加到指定HyperLogLog数据结构中。如果执行命令后HLL估计的近似基数发生变化，则返回1，否则返回0。</p>
<p>2、pfcount</p>
<p>（1）格式</p>
<p>pfcount<key> [key &hellip;] 计算HLL的近似基数，可以计算多个HLL，比如用HLL存储每天的UV，计算一周的UV可以使用7天的UV合并计算即可</p>
<p><img src="/images/f809026c-fc64-48fe-be04-706e6cc41f44.png" alt=""></p>
<p>（2）实例</p>
<p><img src="/images/f5b58b59-9932-4057-bd8f-60432b157770.png" alt=""></p>
<p>3、pfmerge</p>
<p>（1）格式</p>
<p>pfmerge<destkey><sourcekey> [sourcekey &hellip;]  将一个或多个HLL合并后的结果存储在另一个HLL中，比如每月活跃用户可以使用每天的活跃用户来合并计算可得</p>
<p><img src="/images/631183a5-9ff4-48b7-ac89-fbdd7789d129.png" alt=""></p>
<p>（2）实例</p>
<p><img src="/images/dfd3ee89-78e6-42ce-a229-dc9cefd1cec4.png" alt=""></p>
<h3 id="geospatial">Geospatial</h3>
<h4 id="简介-7">简介</h4>
<p>Redis 3.2 中增加了对GEO类型的支持。GEO，Geographic，地理信息的缩写。该类型，就是元素的2维坐标，在地图上就是经纬度。redis基于该类型，提供了经纬度设置，查询，范围查询，距离查询，经纬度Hash等常见操作。</p>
<h4 id="命令-2">命令</h4>
<p>1、geoadd</p>
<p>（1）格式</p>
<p>geoadd<key>&lt; longitude&gt;<latitude><member> [longitude latitude member&hellip;]  添加地理位置（经度，纬度，名称）</p>
<p><img src="/images/05ef798c-3889-4c03-91d4-90b1f15c9956.png" alt=""></p>
<p>2）实例</p>
<p>geoadd china:city 121.47 31.23 shanghai</p>
<p>geoadd china:city 106.50 29.53 chongqing 114.05 22.52 shenzhen 116.38 39.90 beijing</p>
<p><img src="/images/8ac8b0f3-9cfb-40e5-9cb9-8ef5b49ec1b6.png" alt=""></p>
<p>两极无法直接添加，一般会下载城市数据，直接通过 Java 程序一次性导入。</p>
<p>有效的经度从 -180 度到 180 度。有效的纬度从 -85.05112878 度到 85.05112878 度。</p>
<p>当坐标位置超出指定范围时，该命令将会返回一个错误。</p>
<p>已经添加的数据，是无法再次往里面添加的。</p>
<p>2、geopos</p>
<p>（1）格式</p>
<p>geopos  <key><member> [member&hellip;]  获得指定地区的坐标值</p>
<p><img src="/images/d0233779-9639-4787-8e99-3283ac7e855e.png" alt=""></p>
<p>（2）实例</p>
<p><img src="/images/71ab3c6c-66ca-4a71-b6d2-f16555a3e548.png" alt=""></p>
<p>3、geodist</p>
<p>（1）格式</p>
<p>geodist<key><member1><member2>  [m|km|ft|mi ]  获取两个位置之间的直线距离</p>
<p><img src="/images/ed4cb462-5939-4c09-9392-bd6c6b50dec6.png" alt=""></p>
<p>（2）实例</p>
<p>获取两个位置之间的直线距离</p>
<p><img src="/images/c5817ee3-a137-430a-9734-c3a51179382f.png" alt=""></p>
<p>单位：</p>
<p>m 表示单位为米[默认值]。</p>
<p>km 表示单位为千米。</p>
<p>mi 表示单位为英里。</p>
<p>ft 表示单位为英尺。</p>
<p>如果用户没有显式地指定单位参数， 那么 GEODIST 默认使用米作为单位</p>
<p>4、georadius</p>
<p>（1）格式</p>
<p>georadius<key>&lt; longitude&gt;<latitude>radius m|km|ft|mi  以给定的经纬度为中心，找出某一半径内的元素</p>
<p><img src="/images/63d0253a-d296-4b59-9b3a-0cda8db7167f.png" alt=""></p>
<p>经度 纬度 距离 单位</p>
<p>（2）实例</p>
<p><img src="/images/bd56b575-3eab-442e-aa42-fb8768d47bb1.png" alt=""></p>
]]></content:encoded><category>database</category><category>redis</category></item></channel></rss>