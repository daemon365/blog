<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/"><channel><title>Kratos on Daemon365</title><link>https://daemon365.dev/categories/kratos/</link><description>Don't let yourself stop.</description><generator>Hugo -- gohugo.io</generator><language>zh-cn</language><lastBuildDate>Thu, 29 Jun 2023 00:00:00 +0800</lastBuildDate><atom:link href="https://daemon365.dev/categories/kratos/index.xml" rel="self" type="application/rss+xml"/><item><title>kratos http原理</title><link>https://daemon365.dev/post/kratos/kratos_http_principle/</link><pubDate>Thu, 29 Jun 2023 00:00:00 +0800</pubDate><guid>https://daemon365.dev/post/kratos/kratos_http_principle/</guid><description>&lt;h2 id="概念"&gt;概念&lt;/h2&gt;
&lt;p&gt;&lt;a href="https://github.com/go-kratos/kratos"&gt;kratos&lt;/a&gt; 为了使http协议的逻辑代码和grpc的逻辑代码使用同一份，选择了基于protobuf的IDL文件使用proto插件生成辅助代码的方式。&lt;/p&gt;
&lt;p&gt;protoc http插件的地址为：&lt;a href="https://github.com/go-kratos/kratos/tree/main/cmd/protoc-gen-go-http"&gt;https://github.com/go-kratos/kratos/tree/main/cmd/protoc-gen-go-http&lt;/a&gt;&lt;/p&gt;
&lt;h2 id="示例"&gt;示例&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-protobuf" data-lang="protobuf"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;syntax&lt;/span&gt; &lt;span style="color:#f92672"&gt;=&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;proto3&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;;&lt;/span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt;&lt;span style="color:#f92672"&gt;package&lt;/span&gt; &lt;span style="color:#111"&gt;helloworld&lt;/span&gt;&lt;span style="color:#111"&gt;;&lt;/span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;option&lt;/span&gt; &lt;span style="color:#111"&gt;go_package&lt;/span&gt; &lt;span style="color:#f92672"&gt;=&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;test/helloworld;helloworld&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;;&lt;/span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;option&lt;/span&gt; &lt;span style="color:#111"&gt;java_multiple_files&lt;/span&gt; &lt;span style="color:#f92672"&gt;=&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;true&lt;/span&gt;&lt;span style="color:#111"&gt;;&lt;/span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;option&lt;/span&gt; &lt;span style="color:#111"&gt;java_package&lt;/span&gt; &lt;span style="color:#f92672"&gt;=&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;helloworld&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;;&lt;/span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;import&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;google/api/annotations.proto&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;;&lt;/span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;service&lt;/span&gt; &lt;span style="color:#111"&gt;Greeter&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;rpc&lt;/span&gt; &lt;span style="color:#111"&gt;SayHello&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#111"&gt;HelloRequest&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;returns&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#111"&gt;HelloReply&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;option&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#111"&gt;google.api.http&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#f92672"&gt;=&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt; &lt;span style="color:#111"&gt;post&lt;/span&gt;&lt;span style="color:#f92672"&gt;:&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;/helloworld&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 声明路由
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;&lt;/span&gt; &lt;span style="color:#111"&gt;body&lt;/span&gt;&lt;span style="color:#f92672"&gt;:&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;*&amp;#34;&lt;/span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt; &lt;span style="color:#111"&gt;};&lt;/span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt; &lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;message&lt;/span&gt; &lt;span style="color:#75af00"&gt;HelloRequest&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;string&lt;/span&gt; &lt;span style="color:#111"&gt;name&lt;/span&gt; &lt;span style="color:#f92672"&gt;=&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;1&lt;/span&gt;&lt;span style="color:#111"&gt;;&lt;/span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt; &lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;message&lt;/span&gt; &lt;span style="color:#75af00"&gt;HelloReply&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;string&lt;/span&gt; &lt;span style="color:#111"&gt;msg&lt;/span&gt; &lt;span style="color:#f92672"&gt;=&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;1&lt;/span&gt;&lt;span style="color:#111"&gt;;&lt;/span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;使用&lt;code&gt;kratos proto client xxx&lt;/code&gt; 生成的代码为：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;// Code generated by protoc-gen-go-http. DO NOT EDIT.&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;// versions:&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;// - protoc-gen-go-http v2.4.0&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;// - protoc v3.19.4&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;// source: helloworld/helloworld.proto&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;package&lt;/span&gt; &lt;span style="color:#75af00"&gt;helloworld&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;import&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;context&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;context&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;http&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;github.com/go-kratos/kratos/v2/transport/http&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;binding&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;github.com/go-kratos/kratos/v2/transport/http/binding&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;// This is a compile-time assertion to ensure that this generated file&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;// is compatible with the kratos package it is being compiled against.&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;var&lt;/span&gt; &lt;span style="color:#75af00"&gt;_&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#111"&gt;new&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;context&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Context&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;var&lt;/span&gt; &lt;span style="color:#75af00"&gt;_&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#75af00"&gt;binding&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;EncodeURL&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;const&lt;/span&gt; &lt;span style="color:#75af00"&gt;_&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#75af00"&gt;http&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;SupportPackageIsVersion1&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;const&lt;/span&gt; &lt;span style="color:#75af00"&gt;OperationGreeterSayHello&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;/helloworld.Greeter/SayHello&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;type&lt;/span&gt; &lt;span style="color:#75af00"&gt;GreeterHTTPServer&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;interface&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;SayHello&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;context&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Context&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;HelloRequest&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;HelloReply&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;error&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;RegisterGreeterHTTPServer&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;s&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;http&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Server&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;srv&lt;/span&gt; &lt;span style="color:#75af00"&gt;GreeterHTTPServer&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;r&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;s&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Route&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;/&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;r&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;POST&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;/helloworld&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;_Greeter_SayHello0_HTTP_Handler&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;srv&lt;/span&gt;&lt;span style="color:#111"&gt;))&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;_Greeter_SayHello0_HTTP_Handler&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;srv&lt;/span&gt; &lt;span style="color:#75af00"&gt;GreeterHTTPServer&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;func&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;ctx&lt;/span&gt; &lt;span style="color:#75af00"&gt;http&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Context&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;error&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;func&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;ctx&lt;/span&gt; &lt;span style="color:#75af00"&gt;http&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Context&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;error&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;var&lt;/span&gt; &lt;span style="color:#75af00"&gt;in&lt;/span&gt; &lt;span style="color:#75af00"&gt;HelloRequest&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;ctx&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Bind&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#f92672"&gt;&amp;amp;&lt;/span&gt;&lt;span style="color:#75af00"&gt;in&lt;/span&gt;&lt;span style="color:#111"&gt;);&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;!=&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;http&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;SetOperation&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;ctx&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;OperationGreeterSayHello&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;h&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;ctx&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Middleware&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;ctx&lt;/span&gt; &lt;span style="color:#75af00"&gt;context&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Context&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;req&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;interface&lt;/span&gt;&lt;span style="color:#111"&gt;{})&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;interface&lt;/span&gt;&lt;span style="color:#111"&gt;{},&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;error&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt; &lt;span style="color:#75af00"&gt;srv&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;SayHello&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;ctx&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;req&lt;/span&gt;&lt;span style="color:#111"&gt;.(&lt;/span&gt;&lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;HelloRequest&lt;/span&gt;&lt;span style="color:#111"&gt;))&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;})&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;out&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;h&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;ctx&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#f92672"&gt;&amp;amp;&lt;/span&gt;&lt;span style="color:#75af00"&gt;in&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;!=&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;reply&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;out&lt;/span&gt;&lt;span style="color:#111"&gt;.(&lt;/span&gt;&lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;HelloReply&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt; &lt;span style="color:#75af00"&gt;ctx&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Result&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;200&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;reply&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;type&lt;/span&gt; &lt;span style="color:#75af00"&gt;GreeterHTTPClient&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;interface&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;SayHello&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;ctx&lt;/span&gt; &lt;span style="color:#75af00"&gt;context&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Context&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;req&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;HelloRequest&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;opts&lt;/span&gt; &lt;span style="color:#f92672"&gt;...&lt;/span&gt;&lt;span style="color:#75af00"&gt;http&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;CallOption&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;rsp&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;HelloReply&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;error&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;type&lt;/span&gt; &lt;span style="color:#75af00"&gt;GreeterHTTPClientImpl&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;struct&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;cc&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;http&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Client&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;NewGreeterHTTPClient&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;client&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;http&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Client&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75af00"&gt;GreeterHTTPClient&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt; &lt;span style="color:#f92672"&gt;&amp;amp;&lt;/span&gt;&lt;span style="color:#75af00"&gt;GreeterHTTPClientImpl&lt;/span&gt;&lt;span style="color:#111"&gt;{&lt;/span&gt;&lt;span style="color:#75af00"&gt;client&lt;/span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;c&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;GreeterHTTPClientImpl&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75af00"&gt;SayHello&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;ctx&lt;/span&gt; &lt;span style="color:#75af00"&gt;context&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Context&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;in&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;HelloRequest&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;opts&lt;/span&gt; &lt;span style="color:#f92672"&gt;...&lt;/span&gt;&lt;span style="color:#75af00"&gt;http&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;CallOption&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;HelloReply&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;error&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;var&lt;/span&gt; &lt;span style="color:#75af00"&gt;out&lt;/span&gt; &lt;span style="color:#75af00"&gt;HelloReply&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;pattern&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;/helloworld&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;path&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;binding&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;EncodeURL&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;pattern&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;in&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;false&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;opts&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#111"&gt;append&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;opts&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;http&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Operation&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;OperationGreeterSayHello&lt;/span&gt;&lt;span style="color:#111"&gt;))&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;opts&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#111"&gt;append&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;opts&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;http&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;PathTemplate&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;pattern&lt;/span&gt;&lt;span style="color:#111"&gt;))&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;c&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;cc&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Invoke&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;ctx&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;POST&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;path&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;in&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#f92672"&gt;&amp;amp;&lt;/span&gt;&lt;span style="color:#75af00"&gt;out&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;opts&lt;/span&gt;&lt;span style="color:#f92672"&gt;...&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;!=&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt; &lt;span style="color:#f92672"&gt;&amp;amp;&lt;/span&gt;&lt;span style="color:#75af00"&gt;out&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;开启一个grpc及http服务:&lt;/p&gt;</description><content:encoded><![CDATA[<h2 id="概念">概念</h2>
<p><a href="https://github.com/go-kratos/kratos">kratos</a> 为了使http协议的逻辑代码和grpc的逻辑代码使用同一份，选择了基于protobuf的IDL文件使用proto插件生成辅助代码的方式。</p>
<p>protoc http插件的地址为：<a href="https://github.com/go-kratos/kratos/tree/main/cmd/protoc-gen-go-http">https://github.com/go-kratos/kratos/tree/main/cmd/protoc-gen-go-http</a></p>
<h2 id="示例">示例</h2>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-protobuf" data-lang="protobuf"><span style="display:flex;"><span><span style="color:#111">syntax</span> <span style="color:#f92672">=</span> <span style="color:#d88200">&#34;proto3&#34;</span><span style="color:#111">;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#f92672">package</span> <span style="color:#111">helloworld</span><span style="color:#111">;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#00a8c8">option</span> <span style="color:#111">go_package</span> <span style="color:#f92672">=</span> <span style="color:#d88200">&#34;test/helloworld;helloworld&#34;</span><span style="color:#111">;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#00a8c8">option</span> <span style="color:#111">java_multiple_files</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">true</span><span style="color:#111">;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#00a8c8">option</span> <span style="color:#111">java_package</span> <span style="color:#f92672">=</span> <span style="color:#d88200">&#34;helloworld&#34;</span><span style="color:#111">;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#00a8c8">import</span> <span style="color:#d88200">&#34;google/api/annotations.proto&#34;</span><span style="color:#111">;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#00a8c8">service</span> <span style="color:#111">Greeter</span> <span style="color:#111">{</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>	<span style="color:#00a8c8">rpc</span> <span style="color:#111">SayHello</span> <span style="color:#111">(</span><span style="color:#111">HelloRequest</span><span style="color:#111">)</span> <span style="color:#00a8c8">returns</span> <span style="color:#111">(</span><span style="color:#111">HelloReply</span><span style="color:#111">)</span>  <span style="color:#111">{</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>		  <span style="color:#00a8c8">option</span> <span style="color:#111">(</span><span style="color:#111">google.api.http</span><span style="color:#111">)</span> <span style="color:#f92672">=</span> <span style="color:#111">{</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>			  <span style="color:#111">post</span><span style="color:#f92672">:</span> <span style="color:#d88200">&#34;/helloworld&#34;</span><span style="color:#111">,</span> <span style="color:#75715e">// 声明路由
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			  <span style="color:#111">body</span><span style="color:#f92672">:</span> <span style="color:#d88200">&#34;*&#34;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>		  <span style="color:#111">};</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>	<span style="color:#111">}</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#111">}</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#00a8c8">message</span> <span style="color:#75af00">HelloRequest</span> <span style="color:#111">{</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>	<span style="color:#00a8c8">string</span> <span style="color:#111">name</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span><span style="color:#111">;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#111">}</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#00a8c8">message</span> <span style="color:#75af00">HelloReply</span> <span style="color:#111">{</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>	<span style="color:#00a8c8">string</span> <span style="color:#111">msg</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span><span style="color:#111">;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#111">}</span><span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>使用<code>kratos proto client xxx</code> 生成的代码为：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// Code generated by protoc-gen-go-http. DO NOT EDIT.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// versions:</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// - protoc-gen-go-http v2.4.0</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// - protoc             v3.19.4</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// source: helloworld/helloworld.proto</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">helloworld</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">context</span> <span style="color:#d88200">&#34;context&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">http</span> <span style="color:#d88200">&#34;github.com/go-kratos/kratos/v2/transport/http&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">binding</span> <span style="color:#d88200">&#34;github.com/go-kratos/kratos/v2/transport/http/binding&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// This is a compile-time assertion to ensure that this generated file</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// is compatible with the kratos package it is being compiled against.</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">var</span> <span style="color:#75af00">_</span> <span style="color:#111">=</span> <span style="color:#111">new</span><span style="color:#111">(</span><span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">var</span> <span style="color:#75af00">_</span> <span style="color:#111">=</span> <span style="color:#75af00">binding</span><span style="color:#111">.</span><span style="color:#75af00">EncodeURL</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">const</span> <span style="color:#75af00">_</span> <span style="color:#111">=</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">SupportPackageIsVersion1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">const</span> <span style="color:#75af00">OperationGreeterSayHello</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;/helloworld.Greeter/SayHello&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">GreeterHTTPServer</span> <span style="color:#00a8c8">interface</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">SayHello</span><span style="color:#111">(</span><span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">,</span> <span style="color:#f92672">*</span><span style="color:#75af00">HelloRequest</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">HelloReply</span><span style="color:#111">,</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">RegisterGreeterHTTPServer</span><span style="color:#111">(</span><span style="color:#75af00">s</span> <span style="color:#f92672">*</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Server</span><span style="color:#111">,</span> <span style="color:#75af00">srv</span> <span style="color:#75af00">GreeterHTTPServer</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">Route</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">POST</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/helloworld&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">_Greeter_SayHello0_HTTP_Handler</span><span style="color:#111">(</span><span style="color:#75af00">srv</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">_Greeter_SayHello0_HTTP_Handler</span><span style="color:#111">(</span><span style="color:#75af00">srv</span> <span style="color:#75af00">GreeterHTTPServer</span><span style="color:#111">)</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">var</span> <span style="color:#75af00">in</span> <span style="color:#75af00">HelloRequest</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">ctx</span><span style="color:#111">.</span><span style="color:#75af00">Bind</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">in</span><span style="color:#111">);</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">SetOperation</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">OperationGreeterSayHello</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">h</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">ctx</span><span style="color:#111">.</span><span style="color:#75af00">Middleware</span><span style="color:#111">(</span><span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">,</span> <span style="color:#75af00">req</span> <span style="color:#00a8c8">interface</span><span style="color:#111">{})</span> <span style="color:#111">(</span><span style="color:#00a8c8">interface</span><span style="color:#111">{},</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#75af00">srv</span><span style="color:#111">.</span><span style="color:#75af00">SayHello</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">req</span><span style="color:#111">.(</span><span style="color:#f92672">*</span><span style="color:#75af00">HelloRequest</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">out</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">h</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">in</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">reply</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">out</span><span style="color:#111">.(</span><span style="color:#f92672">*</span><span style="color:#75af00">HelloReply</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">ctx</span><span style="color:#111">.</span><span style="color:#75af00">Result</span><span style="color:#111">(</span><span style="color:#ae81ff">200</span><span style="color:#111">,</span> <span style="color:#75af00">reply</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">GreeterHTTPClient</span> <span style="color:#00a8c8">interface</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">SayHello</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">,</span> <span style="color:#75af00">req</span> <span style="color:#f92672">*</span><span style="color:#75af00">HelloRequest</span><span style="color:#111">,</span> <span style="color:#75af00">opts</span> <span style="color:#f92672">...</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">CallOption</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#75af00">rsp</span> <span style="color:#f92672">*</span><span style="color:#75af00">HelloReply</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">GreeterHTTPClientImpl</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">cc</span> <span style="color:#f92672">*</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Client</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">NewGreeterHTTPClient</span><span style="color:#111">(</span><span style="color:#75af00">client</span> <span style="color:#f92672">*</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Client</span><span style="color:#111">)</span> <span style="color:#75af00">GreeterHTTPClient</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">GreeterHTTPClientImpl</span><span style="color:#111">{</span><span style="color:#75af00">client</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">GreeterHTTPClientImpl</span><span style="color:#111">)</span> <span style="color:#75af00">SayHello</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">,</span> <span style="color:#75af00">in</span> <span style="color:#f92672">*</span><span style="color:#75af00">HelloRequest</span><span style="color:#111">,</span> <span style="color:#75af00">opts</span> <span style="color:#f92672">...</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">CallOption</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">HelloReply</span><span style="color:#111">,</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">var</span> <span style="color:#75af00">out</span> <span style="color:#75af00">HelloReply</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">pattern</span> <span style="color:#f92672">:=</span> <span style="color:#d88200">&#34;/helloworld&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">path</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">binding</span><span style="color:#111">.</span><span style="color:#75af00">EncodeURL</span><span style="color:#111">(</span><span style="color:#75af00">pattern</span><span style="color:#111">,</span> <span style="color:#75af00">in</span><span style="color:#111">,</span> <span style="color:#00a8c8">false</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">opts</span> <span style="color:#111">=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">opts</span><span style="color:#111">,</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Operation</span><span style="color:#111">(</span><span style="color:#75af00">OperationGreeterSayHello</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">opts</span> <span style="color:#111">=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">opts</span><span style="color:#111">,</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">PathTemplate</span><span style="color:#111">(</span><span style="color:#75af00">pattern</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">cc</span><span style="color:#111">.</span><span style="color:#75af00">Invoke</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;POST&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">path</span><span style="color:#111">,</span> <span style="color:#75af00">in</span><span style="color:#111">,</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">out</span><span style="color:#111">,</span> <span style="color:#75af00">opts</span><span style="color:#f92672">...</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">out</span><span style="color:#111">,</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>开启一个grpc及http服务:</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;context&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;test/helloworld&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;github.com/go-kratos/kratos/v2&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;github.com/go-kratos/kratos/v2/middleware/recovery&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;github.com/go-kratos/kratos/v2/transport/grpc&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;github.com/go-kratos/kratos/v2/transport/http&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">server</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">helloworld</span><span style="color:#111">.</span><span style="color:#75af00">UnimplementedGreeterServer</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">s</span> <span style="color:#f92672">*</span><span style="color:#75af00">server</span><span style="color:#111">)</span> <span style="color:#75af00">SayHello</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">,</span> <span style="color:#75af00">in</span> <span style="color:#f92672">*</span><span style="color:#75af00">helloworld</span><span style="color:#111">.</span><span style="color:#75af00">HelloRequest</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">helloworld</span><span style="color:#111">.</span><span style="color:#75af00">HelloReply</span><span style="color:#111">,</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">helloworld</span><span style="color:#111">.</span><span style="color:#75af00">HelloReply</span><span style="color:#111">{</span><span style="color:#75af00">Msg</span><span style="color:#111">:</span> <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Sprintf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Hello %+v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">in</span><span style="color:#111">.</span><span style="color:#75af00">Name</span><span style="color:#111">)},</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">s</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">server</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">httpSrv</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">NewServer</span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Address</span><span style="color:#111">(</span><span style="color:#d88200">&#34;:8000&#34;</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Middleware</span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">recovery</span><span style="color:#111">.</span><span style="color:#75af00">Recovery</span><span style="color:#111">(),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">grpcSrv</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">grpc</span><span style="color:#111">.</span><span style="color:#75af00">NewServer</span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">grpc</span><span style="color:#111">.</span><span style="color:#75af00">Address</span><span style="color:#111">(</span><span style="color:#d88200">&#34;:9000&#34;</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">grpc</span><span style="color:#111">.</span><span style="color:#75af00">Middleware</span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">recovery</span><span style="color:#111">.</span><span style="color:#75af00">Recovery</span><span style="color:#111">(),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">helloworld</span><span style="color:#111">.</span><span style="color:#75af00">RegisterGreeterServer</span><span style="color:#111">(</span><span style="color:#75af00">grpcSrv</span><span style="color:#111">,</span> <span style="color:#75af00">s</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">helloworld</span><span style="color:#111">.</span><span style="color:#75af00">RegisterGreeterHTTPServer</span><span style="color:#111">(</span><span style="color:#75af00">httpSrv</span><span style="color:#111">,</span> <span style="color:#75af00">s</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">app</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">kratos</span><span style="color:#111">.</span><span style="color:#75af00">New</span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">kratos</span><span style="color:#111">.</span><span style="color:#75af00">Name</span><span style="color:#111">(</span><span style="color:#d88200">&#34;test&#34;</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">kratos</span><span style="color:#111">.</span><span style="color:#75af00">Server</span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">httpSrv</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">grpcSrv</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">app</span><span style="color:#111">.</span><span style="color:#75af00">Run</span><span style="color:#111">();</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Fatal</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>http client：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;context&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;test/helloworld&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;github.com/go-kratos/kratos/v2/middleware/recovery&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">transhttp</span> <span style="color:#d88200">&#34;github.com/go-kratos/kratos/v2/transport/http&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">callHTTP</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">callHTTP</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">conn</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">transhttp</span><span style="color:#111">.</span><span style="color:#75af00">NewClient</span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Background</span><span style="color:#111">(),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">transhttp</span><span style="color:#111">.</span><span style="color:#75af00">WithMiddleware</span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">recovery</span><span style="color:#111">.</span><span style="color:#75af00">Recovery</span><span style="color:#111">(),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">transhttp</span><span style="color:#111">.</span><span style="color:#75af00">WithEndpoint</span><span style="color:#111">(</span><span style="color:#d88200">&#34;127.0.0.1:8000&#34;</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">conn</span><span style="color:#111">.</span><span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">client</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">helloworld</span><span style="color:#111">.</span><span style="color:#75af00">NewGreeterHTTPClient</span><span style="color:#111">(</span><span style="color:#75af00">conn</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">reply</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">client</span><span style="color:#111">.</span><span style="color:#75af00">SayHello</span><span style="color:#111">(</span><span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Background</span><span style="color:#111">(),</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">helloworld</span><span style="color:#111">.</span><span style="color:#75af00">HelloRequest</span><span style="color:#111">{</span><span style="color:#75af00">Name</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;kratos&#34;</span><span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Fatal</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;[http] SayHello %s\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">reply</span><span style="color:#111">.</span><span style="color:#75af00">Msg</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="http-server端实现原理">http server端实现原理</h2>
<p>核心流程为下图 ：</p>
<p><img src="/images/4fe2f5ff-fbaf-462f-8fd1-1fcced329791.jpg" alt=""></p>
<p>首先新建一个struct 并实现 http_pb.go种 GreeterHTTPServer interface  的方法，GreeterHTTPServer的命名方式为protobuf文件中的 <code>service</code>+<code>HTTPServer</code>，interface的方法为<code>protobuf</code>中使用<code>google.api.http</code>生命http路由所有的method。</p>
<p>然后使用RegisterGreeterHTTPServer方法把服务注册进去。大体的流程如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">const</span> <span style="color:#75af00">OperationGreeterSayHello</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;/helloworld.Greeter/SayHello&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">RegisterGreeterHTTPServer</span><span style="color:#111">(</span><span style="color:#75af00">s</span> <span style="color:#f92672">*</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Server</span><span style="color:#111">,</span> <span style="color:#75af00">srv</span> <span style="color:#75af00">GreeterHTTPServer</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">Route</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">POST</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/helloworld&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">_Greeter_SayHello0_HTTP_Handler</span><span style="color:#111">(</span><span style="color:#75af00">srv</span><span style="color:#111">))</span> <span style="color:#75715e">// 注册路由</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">_Greeter_SayHello0_HTTP_Handler</span><span style="color:#111">(</span><span style="color:#75af00">srv</span> <span style="color:#75af00">GreeterHTTPServer</span><span style="color:#111">)</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">var</span> <span style="color:#75af00">in</span> <span style="color:#75af00">HelloRequest</span> <span style="color:#75715e">// protobuf 中声明的request</span>
</span></span><span style="display:flex;"><span> 		<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">ctx</span><span style="color:#111">.</span><span style="color:#75af00">Bind</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">in</span><span style="color:#111">);</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span> <span style="color:#75715e">// 把http的参数绑定到 in</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">SetOperation</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">OperationGreeterSayHello</span><span style="color:#111">)</span> <span style="color:#75715e">// 设置Operation 和grpc一值，用于middleware select 等</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">h</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">ctx</span><span style="color:#111">.</span><span style="color:#75af00">Middleware</span><span style="color:#111">(</span><span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">,</span> <span style="color:#75af00">req</span> <span style="color:#00a8c8">interface</span><span style="color:#111">{})</span> <span style="color:#111">(</span><span style="color:#00a8c8">interface</span><span style="color:#111">{},</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#75af00">srv</span><span style="color:#111">.</span><span style="color:#75af00">SayHello</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">req</span><span style="color:#111">.(</span><span style="color:#f92672">*</span><span style="color:#75af00">HelloRequest</span><span style="color:#111">))</span> <span style="color:#75715e">// 这个方法也就是上文提到的GreeterHTTPServer接口的方法，也就是我们自己实现的struct server里的SayHello方法</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">})</span> <span style="color:#75715e">// 使用责任链模式middleware 这里没有任何中间件</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">out</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">h</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">in</span><span style="color:#111">)</span> <span style="color:#75715e">// 执行</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">reply</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">out</span><span style="color:#111">.(</span><span style="color:#f92672">*</span><span style="color:#75af00">HelloReply</span><span style="color:#111">)</span> 
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">ctx</span><span style="color:#111">.</span><span style="color:#75af00">Result</span><span style="color:#111">(</span><span style="color:#ae81ff">200</span><span style="color:#111">,</span> <span style="color:#75af00">reply</span><span style="color:#111">)</span> 
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><blockquote>
<p>什么事责任链模式？</p>
<p><a href="https://haiyux.cc/post/designmode/behavioral/#%E8%B4%A3%E4%BB%BB%E9%93%BE%E6%A8%A1%E5%BC%8F">https://haiyux.cc/post/designmode/behavioral/#责任链模式</a></p>
</blockquote>
<p>上段代码中的POST方法为：</p>
<p>代码在https://github.com/go-kratos/kratos/blob/main/transport/http/router.go#L76</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">r</span> <span style="color:#f92672">*</span><span style="color:#75af00">Router</span><span style="color:#111">)</span> <span style="color:#75af00">POST</span><span style="color:#111">(</span><span style="color:#75af00">path</span> <span style="color:#00a8c8">string</span><span style="color:#111">,</span> <span style="color:#75af00">h</span> <span style="color:#75af00">HandlerFunc</span><span style="color:#111">,</span> <span style="color:#75af00">m</span> <span style="color:#f92672">...</span><span style="color:#75af00">FilterFunc</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">Handle</span><span style="color:#111">(</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">MethodPost</span><span style="color:#111">,</span> <span style="color:#75af00">path</span><span style="color:#111">,</span> <span style="color:#75af00">h</span><span style="color:#111">,</span> <span style="color:#75af00">m</span><span style="color:#f92672">...</span><span style="color:#111">)</span> <span style="color:#75715e">// MethodPost = POST net/http下的常量</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// h 为上段xxx_http_pb.go代码中_Greeter_SayHello0_HTTP_Handler的返回值</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">r</span> <span style="color:#f92672">*</span><span style="color:#75af00">Router</span><span style="color:#111">)</span> <span style="color:#75af00">Handle</span><span style="color:#111">(</span><span style="color:#75af00">method</span><span style="color:#111">,</span> <span style="color:#75af00">relativePath</span> <span style="color:#00a8c8">string</span><span style="color:#111">,</span> <span style="color:#75af00">h</span> <span style="color:#75af00">HandlerFunc</span><span style="color:#111">,</span> <span style="color:#75af00">filters</span> <span style="color:#f92672">...</span><span style="color:#75af00">FilterFunc</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">next</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Handler</span><span style="color:#111">(</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">HandlerFunc</span><span style="color:#111">(</span><span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">res</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">ResponseWriter</span><span style="color:#111">,</span> <span style="color:#75af00">req</span> <span style="color:#f92672">*</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Request</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">ctx</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">pool</span><span style="color:#111">.</span><span style="color:#75af00">Get</span><span style="color:#111">().(</span><span style="color:#75af00">Context</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">ctx</span><span style="color:#111">.</span><span style="color:#75af00">Reset</span><span style="color:#111">(</span><span style="color:#75af00">res</span><span style="color:#111">,</span> <span style="color:#75af00">req</span><span style="color:#111">)</span> <span style="color:#75715e">// 把 net/http的http.ResponseWriter 和*http.Request 设置ctx中</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">h</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">);</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span> <span style="color:#75715e">// 执行h </span>
</span></span><span style="display:flex;"><span>            <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">srv</span><span style="color:#111">.</span><span style="color:#75af00">ene</span><span style="color:#111">(</span><span style="color:#75af00">res</span><span style="color:#111">,</span> <span style="color:#75af00">req</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span> <span style="color:#75715e">// 如果出错了 执行 ene(EncodeErrorFunc)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">ctx</span><span style="color:#111">.</span><span style="color:#75af00">Reset</span><span style="color:#111">(</span><span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">pool</span><span style="color:#111">.</span><span style="color:#75af00">Put</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">next</span> <span style="color:#111">=</span> <span style="color:#75af00">FilterChain</span><span style="color:#111">(</span><span style="color:#75af00">filters</span><span style="color:#f92672">...</span><span style="color:#111">)(</span><span style="color:#75af00">next</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">next</span> <span style="color:#111">=</span> <span style="color:#75af00">FilterChain</span><span style="color:#111">(</span><span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">filters</span><span style="color:#f92672">...</span><span style="color:#111">)(</span><span style="color:#75af00">next</span><span style="color:#111">)</span> <span style="color:#75715e">// 添加filter 责任链模式</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">srv</span><span style="color:#111">.</span><span style="color:#75af00">router</span><span style="color:#111">.</span><span style="color:#75af00">Handle</span><span style="color:#111">(</span><span style="color:#75af00">path</span><span style="color:#111">.</span><span style="color:#75af00">Join</span><span style="color:#111">(</span><span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">prefix</span><span style="color:#111">,</span> <span style="color:#75af00">relativePath</span><span style="color:#111">),</span> <span style="color:#75af00">next</span><span style="color:#111">).</span><span style="color:#75af00">Methods</span><span style="color:#111">(</span><span style="color:#75af00">method</span><span style="color:#111">)</span> <span style="color:#75715e">// router 为 mux的router 把方法注册到路由中</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>当我们访问 <code>path.Join(r.prefix, relativePath)</code>也就是<code>/helloworld</code> 时，会执行上段代码中的<code>next</code>方法，next是一个责任链。</p>
<p>核心为会执行_Greeter_SayHello0_HTTP_Handler方法，</p>
<p>如果没发生错误，执行<code>ctx.Result(200, reply)</code></p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">wrapper</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">router</span> <span style="color:#f92672">*</span><span style="color:#75af00">Router</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">req</span>    <span style="color:#f92672">*</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Request</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">res</span>    <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">ResponseWriter</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">w</span>      <span style="color:#75af00">responseWriter</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">wrapper</span><span style="color:#111">)</span> <span style="color:#75af00">Result</span><span style="color:#111">(</span><span style="color:#75af00">code</span> <span style="color:#00a8c8">int</span><span style="color:#111">,</span> <span style="color:#75af00">v</span> <span style="color:#00a8c8">interface</span><span style="color:#111">{})</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">w</span><span style="color:#111">.</span><span style="color:#75af00">WriteHeader</span><span style="color:#111">(</span><span style="color:#75af00">code</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">router</span><span style="color:#111">.</span><span style="color:#75af00">srv</span><span style="color:#111">.</span><span style="color:#75af00">enc</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">w</span><span style="color:#111">,</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">req</span><span style="color:#111">,</span> <span style="color:#75af00">v</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>enc也就是<code>EncodeResponseFunc</code>, 为kratos预留的返回值函数</p>
<pre tabindex="0"><code>type EncodeResponseFunc func(http.ResponseWriter, *http.Request, interface{}) error
</code></pre><p>kratos提供了默认的EncodeResponseFunc</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">DefaultResponseEncoder</span><span style="color:#111">(</span><span style="color:#75af00">w</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">ResponseWriter</span><span style="color:#111">,</span> <span style="color:#75af00">r</span> <span style="color:#f92672">*</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Request</span><span style="color:#111">,</span> <span style="color:#75af00">v</span> <span style="color:#00a8c8">interface</span><span style="color:#111">{})</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">v</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">rd</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">v</span><span style="color:#111">.(</span><span style="color:#75af00">Redirector</span><span style="color:#111">);</span> <span style="color:#75af00">ok</span> <span style="color:#111">{</span> <span style="color:#75715e">// 检查有无Redirect方法，如果实现了interface 为跳转路由 也就是http的301 302等</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">url</span><span style="color:#111">,</span> <span style="color:#75af00">code</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">rd</span><span style="color:#111">.</span><span style="color:#75af00">Redirect</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Redirect</span><span style="color:#111">(</span><span style="color:#75af00">w</span><span style="color:#111">,</span> <span style="color:#75af00">r</span><span style="color:#111">,</span> <span style="color:#75af00">url</span><span style="color:#111">,</span> <span style="color:#75af00">code</span><span style="color:#111">)</span> <span style="color:#75715e">// 跳转</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">codec</span><span style="color:#111">,</span> <span style="color:#75af00">_</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">CodecForRequest</span><span style="color:#111">(</span><span style="color:#75af00">r</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Accept&#34;</span><span style="color:#111">)</span> <span style="color:#75715e">// 查看需要返回的参数类型 比如json</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">data</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">codec</span><span style="color:#111">.</span><span style="color:#75af00">Marshal</span><span style="color:#111">(</span><span style="color:#75af00">v</span><span style="color:#111">)</span> <span style="color:#75715e">// 把数据Marshal成[]byte</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">w</span><span style="color:#111">.</span><span style="color:#75af00">Header</span><span style="color:#111">().</span><span style="color:#75af00">Set</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Content-Type&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">httputil</span><span style="color:#111">.</span><span style="color:#75af00">ContentType</span><span style="color:#111">(</span><span style="color:#75af00">codec</span><span style="color:#111">.</span><span style="color:#75af00">Name</span><span style="color:#111">()))</span> <span style="color:#75715e">// 设置header</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">w</span><span style="color:#111">.</span><span style="color:#75af00">Write</span><span style="color:#111">(</span><span style="color:#75af00">data</span><span style="color:#111">)</span> <span style="color:#75715e">// 写数据</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>如果没发生错误，执行<code>ene</code>,也就是<code>EncodeErrorFunc</code>, 为kratos预留的错误返回值删除</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">EncodeErrorFunc</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">ResponseWriter</span><span style="color:#111">,</span> <span style="color:#f92672">*</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Request</span><span style="color:#111">,</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span>
</span></span></code></pre></div><p>kratos提供了默认的EncodeErrorFunc</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">DefaultErrorEncoder</span><span style="color:#111">(</span><span style="color:#75af00">w</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">ResponseWriter</span><span style="color:#111">,</span> <span style="color:#75af00">r</span> <span style="color:#f92672">*</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Request</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">se</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">errors</span><span style="color:#111">.</span><span style="color:#75af00">FromError</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span> <span style="color:#75715e">// 把error变成自定义的实现error的结构体</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">codec</span><span style="color:#111">,</span> <span style="color:#75af00">_</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">CodecForRequest</span><span style="color:#111">(</span><span style="color:#75af00">r</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Accept&#34;</span><span style="color:#111">)</span> <span style="color:#75715e">// 查看需要返回的参数类型 比如json</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">body</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">codec</span><span style="color:#111">.</span><span style="color:#75af00">Marshal</span><span style="color:#111">(</span><span style="color:#75af00">se</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">w</span><span style="color:#111">.</span><span style="color:#75af00">WriteHeader</span><span style="color:#111">(</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">StatusInternalServerError</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">w</span><span style="color:#111">.</span><span style="color:#75af00">Header</span><span style="color:#111">().</span><span style="color:#75af00">Set</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Content-Type&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">httputil</span><span style="color:#111">.</span><span style="color:#75af00">ContentType</span><span style="color:#111">(</span><span style="color:#75af00">codec</span><span style="color:#111">.</span><span style="color:#75af00">Name</span><span style="color:#111">()))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">w</span><span style="color:#111">.</span><span style="color:#75af00">WriteHeader</span><span style="color:#111">(</span><span style="color:#111">int</span><span style="color:#111">(</span><span style="color:#75af00">se</span><span style="color:#111">.</span><span style="color:#75af00">Code</span><span style="color:#111">))</span> <span style="color:#75715e">// 写入 error中的code</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">_</span> <span style="color:#111">=</span> <span style="color:#75af00">w</span><span style="color:#111">.</span><span style="color:#75af00">Write</span><span style="color:#111">(</span><span style="color:#75af00">body</span><span style="color:#111">)</span> <span style="color:#75715e">// 返回错误信息</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="http-client端实现原理">http client端实现原理</h2>
<p>在上传的代码中http client的部分为</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">GreeterHTTPClient</span> <span style="color:#00a8c8">interface</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">SayHello</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">,</span> <span style="color:#75af00">req</span> <span style="color:#f92672">*</span><span style="color:#75af00">HelloRequest</span><span style="color:#111">,</span> <span style="color:#75af00">opts</span> <span style="color:#f92672">...</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">CallOption</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#75af00">rsp</span> <span style="color:#f92672">*</span><span style="color:#75af00">HelloReply</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">GreeterHTTPClientImpl</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span> <span style="color:#75715e">// 实现 GreeterHTTPClient 接口</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">cc</span> <span style="color:#f92672">*</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Client</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">NewGreeterHTTPClient</span><span style="color:#111">(</span><span style="color:#75af00">client</span> <span style="color:#f92672">*</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Client</span><span style="color:#111">)</span> <span style="color:#75af00">GreeterHTTPClient</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">GreeterHTTPClientImpl</span><span style="color:#111">{</span><span style="color:#75af00">client</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">GreeterHTTPClientImpl</span><span style="color:#111">)</span> <span style="color:#75af00">SayHello</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">,</span> <span style="color:#75af00">in</span> <span style="color:#f92672">*</span><span style="color:#75af00">HelloRequest</span><span style="color:#111">,</span> <span style="color:#75af00">opts</span> <span style="color:#f92672">...</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">CallOption</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">HelloReply</span><span style="color:#111">,</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">var</span> <span style="color:#75af00">out</span> <span style="color:#75af00">HelloReply</span> <span style="color:#75715e">// 返回值</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">pattern</span> <span style="color:#f92672">:=</span> <span style="color:#d88200">&#34;/helloworld&#34;</span> 
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">path</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">binding</span><span style="color:#111">.</span><span style="color:#75af00">EncodeURL</span><span style="color:#111">(</span><span style="color:#75af00">pattern</span><span style="color:#111">,</span> <span style="color:#75af00">in</span><span style="color:#111">,</span> <span style="color:#00a8c8">false</span><span style="color:#111">)</span> <span style="color:#75715e">// 整理path 传入in 是由于可能有path参数或者query</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">opts</span> <span style="color:#111">=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">opts</span><span style="color:#111">,</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Operation</span><span style="color:#111">(</span><span style="color:#75af00">OperationGreeterSayHello</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">opts</span> <span style="color:#111">=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">opts</span><span style="color:#111">,</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">PathTemplate</span><span style="color:#111">(</span><span style="color:#75af00">pattern</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">cc</span><span style="color:#111">.</span><span style="color:#75af00">Invoke</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;POST&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">path</span><span style="color:#111">,</span> <span style="color:#75af00">in</span><span style="color:#111">,</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">out</span><span style="color:#111">,</span> <span style="color:#75af00">opts</span><span style="color:#f92672">...</span><span style="color:#111">)</span> <span style="color:#75715e">// 访问接口</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">out</span><span style="color:#111">,</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>上段代码中的Invoke方法为：</p>
<p>代码在https://github.com/go-kratos/kratos/blob/main/transport/http/client.go#L192</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">client</span> <span style="color:#f92672">*</span><span style="color:#75af00">Client</span><span style="color:#111">)</span> <span style="color:#75af00">Invoke</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">,</span> <span style="color:#75af00">method</span><span style="color:#111">,</span> <span style="color:#75af00">path</span> <span style="color:#00a8c8">string</span><span style="color:#111">,</span> <span style="color:#75af00">args</span> <span style="color:#00a8c8">interface</span><span style="color:#111">{},</span> <span style="color:#75af00">reply</span> <span style="color:#00a8c8">interface</span><span style="color:#111">{},</span> <span style="color:#75af00">opts</span> <span style="color:#f92672">...</span><span style="color:#75af00">CallOption</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">var</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">contentType</span> <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">body</span>        <span style="color:#75af00">io</span><span style="color:#111">.</span><span style="color:#75af00">Reader</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">c</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">defaultCallInfo</span><span style="color:#111">(</span><span style="color:#75af00">path</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">o</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">opts</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">o</span><span style="color:#111">.</span><span style="color:#75af00">before</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">c</span><span style="color:#111">);</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">args</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">data</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">client</span><span style="color:#111">.</span><span style="color:#75af00">opts</span><span style="color:#111">.</span><span style="color:#75af00">encoder</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">contentType</span><span style="color:#111">,</span> <span style="color:#75af00">args</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">contentType</span> <span style="color:#111">=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">contentType</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">body</span> <span style="color:#111">=</span> <span style="color:#75af00">bytes</span><span style="color:#111">.</span><span style="color:#75af00">NewReader</span><span style="color:#111">(</span><span style="color:#75af00">data</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">url</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Sprintf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;%s://%s%s&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">client</span><span style="color:#111">.</span><span style="color:#75af00">target</span><span style="color:#111">.</span><span style="color:#75af00">Scheme</span><span style="color:#111">,</span> <span style="color:#75af00">client</span><span style="color:#111">.</span><span style="color:#75af00">target</span><span style="color:#111">.</span><span style="color:#75af00">Authority</span><span style="color:#111">,</span> <span style="color:#75af00">path</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">req</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">NewRequest</span><span style="color:#111">(</span><span style="color:#75af00">method</span><span style="color:#111">,</span> <span style="color:#75af00">url</span><span style="color:#111">,</span> <span style="color:#75af00">body</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">contentType</span> <span style="color:#f92672">!=</span> <span style="color:#d88200">&#34;&#34;</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">req</span><span style="color:#111">.</span><span style="color:#75af00">Header</span><span style="color:#111">.</span><span style="color:#75af00">Set</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Content-Type&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">contentType</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">client</span><span style="color:#111">.</span><span style="color:#75af00">opts</span><span style="color:#111">.</span><span style="color:#75af00">userAgent</span> <span style="color:#f92672">!=</span> <span style="color:#d88200">&#34;&#34;</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">req</span><span style="color:#111">.</span><span style="color:#75af00">Header</span><span style="color:#111">.</span><span style="color:#75af00">Set</span><span style="color:#111">(</span><span style="color:#d88200">&#34;User-Agent&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">client</span><span style="color:#111">.</span><span style="color:#75af00">opts</span><span style="color:#111">.</span><span style="color:#75af00">userAgent</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ctx</span> <span style="color:#111">=</span> <span style="color:#75af00">transport</span><span style="color:#111">.</span><span style="color:#75af00">NewClientContext</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">Transport</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">endpoint</span><span style="color:#111">:</span>     <span style="color:#75af00">client</span><span style="color:#111">.</span><span style="color:#75af00">opts</span><span style="color:#111">.</span><span style="color:#75af00">endpoint</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">reqHeader</span><span style="color:#111">:</span>    <span style="color:#75af00">headerCarrier</span><span style="color:#111">(</span><span style="color:#75af00">req</span><span style="color:#111">.</span><span style="color:#75af00">Header</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">operation</span><span style="color:#111">:</span>    <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">operation</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">request</span><span style="color:#111">:</span>      <span style="color:#75af00">req</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">pathTemplate</span><span style="color:#111">:</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">pathTemplate</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">client</span><span style="color:#111">.</span><span style="color:#75af00">invoke</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">req</span><span style="color:#111">,</span> <span style="color:#75af00">args</span><span style="color:#111">,</span> <span style="color:#75af00">reply</span><span style="color:#111">,</span> <span style="color:#75af00">c</span><span style="color:#111">,</span> <span style="color:#75af00">opts</span><span style="color:#f92672">...</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">client</span> <span style="color:#f92672">*</span><span style="color:#75af00">Client</span><span style="color:#111">)</span> <span style="color:#75af00">invoke</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">,</span> <span style="color:#75af00">req</span> <span style="color:#f92672">*</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Request</span><span style="color:#111">,</span> <span style="color:#75af00">args</span> <span style="color:#00a8c8">interface</span><span style="color:#111">{},</span> <span style="color:#75af00">reply</span> <span style="color:#00a8c8">interface</span><span style="color:#111">{},</span> <span style="color:#75af00">c</span> <span style="color:#75af00">callInfo</span><span style="color:#111">,</span> <span style="color:#75af00">opts</span> <span style="color:#f92672">...</span><span style="color:#75af00">CallOption</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">h</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">,</span> <span style="color:#75af00">in</span> <span style="color:#00a8c8">interface</span><span style="color:#111">{})</span> <span style="color:#111">(</span><span style="color:#00a8c8">interface</span><span style="color:#111">{},</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">res</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">client</span><span style="color:#111">.</span><span style="color:#75af00">do</span><span style="color:#111">(</span><span style="color:#75af00">req</span><span style="color:#111">.</span><span style="color:#75af00">WithContext</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">res</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">cs</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">csAttempt</span><span style="color:#111">{</span><span style="color:#75af00">res</span><span style="color:#111">:</span> <span style="color:#75af00">res</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">o</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">opts</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">o</span><span style="color:#111">.</span><span style="color:#75af00">after</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">c</span><span style="color:#111">,</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">cs</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">defer</span> <span style="color:#75af00">res</span><span style="color:#111">.</span><span style="color:#75af00">Body</span><span style="color:#111">.</span><span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">client</span><span style="color:#111">.</span><span style="color:#75af00">opts</span><span style="color:#111">.</span><span style="color:#75af00">decoder</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">res</span><span style="color:#111">,</span> <span style="color:#75af00">reply</span><span style="color:#111">);</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">reply</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">var</span> <span style="color:#75af00">p</span> <span style="color:#75af00">selector</span><span style="color:#111">.</span><span style="color:#75af00">Peer</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ctx</span> <span style="color:#111">=</span> <span style="color:#75af00">selector</span><span style="color:#111">.</span><span style="color:#75af00">NewPeerContext</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">p</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">client</span><span style="color:#111">.</span><span style="color:#75af00">opts</span><span style="color:#111">.</span><span style="color:#75af00">middleware</span><span style="color:#111">)</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">h</span> <span style="color:#111">=</span> <span style="color:#75af00">middleware</span><span style="color:#111">.</span><span style="color:#75af00">Chain</span><span style="color:#111">(</span><span style="color:#75af00">client</span><span style="color:#111">.</span><span style="color:#75af00">opts</span><span style="color:#111">.</span><span style="color:#75af00">middleware</span><span style="color:#f92672">...</span><span style="color:#111">)(</span><span style="color:#75af00">h</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">h</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">args</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div>]]></content:encoded><category>kratos</category><category>go</category><category>kratos</category><category>源码分析</category></item><item><title>Go工程化 - 依赖注入</title><link>https://daemon365.dev/post/kratos/go_engineering___dependency_injection/</link><pubDate>Thu, 30 Sep 2021 00:00:00 +0800</pubDate><guid>https://daemon365.dev/post/kratos/go_engineering___dependency_injection/</guid><description>&lt;p&gt;我们在微服务框架&lt;a href="https://github.com/go-kratos/kratos"&gt;kratos v2&lt;/a&gt;的默认项目模板中&lt;a href="https://github.com/go-kratos/kratos-layout"&gt;kratos-layout&lt;/a&gt;使用了&lt;a href="https://github.com/google/wire"&gt;google/wire&lt;/a&gt;进行依赖注入，也建议开发者在维护项目时使用该工具。&lt;/p&gt;
&lt;p&gt;wire 乍看起来比较违反直觉，导致很多同学不理解为什么要用或不清楚如何用（也包括曾经的我），本文来帮助大家理解 wire 的使用。&lt;/p&gt;
&lt;h2 id="what"&gt;What&lt;/h2&gt;
&lt;p&gt;&lt;a href="https://github.com/google/wire"&gt;wire&lt;/a&gt;是由 google 开源的一个供 Go 语言使用的依赖注入代码生成工具。它能够根据你的代码，生成相应的依赖注入 go 代码。&lt;/p&gt;
&lt;p&gt;而与其它依靠反射实现的依赖注入工具不同的是，wire 能在编译期（准确地说是代码生成时）如果依赖注入有问题，在代码生成时即可报出来，不会拖到运行时才报，更便于 debug。&lt;/p&gt;
&lt;h2 id="why"&gt;Why&lt;/h2&gt;
&lt;h3 id="理解依赖注入"&gt;理解依赖注入&lt;/h3&gt;
&lt;p&gt;什么是依赖注入？为什么要依赖注入？
&lt;del&gt;依赖注入就是 Java 遗毒&lt;/del&gt;（不是）&lt;/p&gt;
&lt;p&gt;&lt;a href="https://zh.wikipedia.org/wiki/%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5"&gt;依赖注入&lt;/a&gt; (Dependency Injection，缩写为 DI)，可以理解为一种代码的构造模式（就是写法），按照这样的方式来写，能够让你的代码更加容易维护。&lt;/p&gt;
&lt;p&gt;对于很多软件设计模式和架构的理念，我们都无法理解他们要绕好大一圈做复杂的体操、用奇怪的方式进行实现的意义。他们通常都只是丢出来一段样例，说这样写就很好很优雅，由于省略掉了这种模式是如何发展出来的推导过程，我们只看到了结果，导致理解起来很困难。那么接下来我们来尝试推导还原一下整个过程，看看代码是如何和为什么演进到依赖注入模式的，以便能够更好理解使用依赖注入的意义。&lt;/p&gt;
&lt;h4 id="依赖是什么"&gt;依赖是什么？&lt;/h4&gt;
&lt;p&gt;这里的依赖是个名词，不是指软件包的依赖（比如那坨塞在 node_modules 里面的东西），而是指软件中某一个模块（对象/实例）所依赖的其它外部模块（对象/实例）。&lt;/p&gt;
&lt;h4 id="注入到哪里"&gt;注入到哪里？&lt;/h4&gt;
&lt;p&gt;被依赖的模块，在创建模块时，被注入到（即当作参数传入）模块的里面。&lt;/p&gt;
&lt;h4 id="不-di-是啥样di-了又样子"&gt;不 DI 是啥样？DI 了又样子？&lt;/h4&gt;
&lt;p&gt;下面用 go 伪代码来做例子，领会精神即可。&lt;/p&gt;
&lt;p&gt;假设个场景，你在打工搞一个 web 应用，它有一个简单接口。最开始的项目代码可能长这个样子：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;#&lt;/span&gt; &lt;span style="color:#75af00"&gt;下面为伪代码&lt;/span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;，&lt;/span&gt;&lt;span style="color:#75af00"&gt;忽略了很多与主题无关的细节&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;type&lt;/span&gt; &lt;span style="color:#75af00"&gt;App&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;struct&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;#&lt;/span&gt; &lt;span style="color:#75af00"&gt;假设这个方法将会匹配并处理&lt;/span&gt; &lt;span style="color:#75af00"&gt;GET&lt;/span&gt; &lt;span style="color:#f92672"&gt;/&lt;/span&gt;&lt;span style="color:#75af00"&gt;biu&lt;/span&gt;&lt;span style="color:#f92672"&gt;/&lt;/span&gt;&lt;span style="color:#111"&gt;&amp;lt;&lt;/span&gt;&lt;span style="color:#75af00"&gt;id&lt;/span&gt;&lt;span style="color:#111"&gt;&amp;gt;&lt;/span&gt; &lt;span style="color:#75af00"&gt;这样的请求&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;a&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;App&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75af00"&gt;GetData&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;id&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;string&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;string&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#960050;background-color:#1e0010"&gt;#&lt;/span&gt; &lt;span style="color:#75af00"&gt;todo&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#75af00"&gt;write&lt;/span&gt; &lt;span style="color:#75af00"&gt;your&lt;/span&gt; &lt;span style="color:#75af00"&gt;data&lt;/span&gt; &lt;span style="color:#75af00"&gt;query&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;some data&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;NewApp&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;App&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt; &lt;span style="color:#f92672"&gt;&amp;amp;&lt;/span&gt;&lt;span style="color:#75af00"&gt;App&lt;/span&gt;&lt;span style="color:#111"&gt;{}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75af00"&gt;app&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;App&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75af00"&gt;app&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Run&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;你要做的是接一个 mysql，从里面把数据按照 id 查出来，返回。
要连 mysql 的话，假设我们已经有了个&lt;code&gt;NewMySQLClient&lt;/code&gt;的方法返回 client 给你，初始化时传个地址进去就能拿到数据库连接，并假设它有个&lt;code&gt;Exec&lt;/code&gt;的方法给你执行参数。&lt;/p&gt;</description><content:encoded><![CDATA[<p>我们在微服务框架<a href="https://github.com/go-kratos/kratos">kratos v2</a>的默认项目模板中<a href="https://github.com/go-kratos/kratos-layout">kratos-layout</a>使用了<a href="https://github.com/google/wire">google/wire</a>进行依赖注入，也建议开发者在维护项目时使用该工具。</p>
<p>wire 乍看起来比较违反直觉，导致很多同学不理解为什么要用或不清楚如何用（也包括曾经的我），本文来帮助大家理解 wire 的使用。</p>
<h2 id="what">What</h2>
<p><a href="https://github.com/google/wire">wire</a>是由 google 开源的一个供 Go 语言使用的依赖注入代码生成工具。它能够根据你的代码，生成相应的依赖注入 go 代码。</p>
<p>而与其它依靠反射实现的依赖注入工具不同的是，wire 能在编译期（准确地说是代码生成时）如果依赖注入有问题，在代码生成时即可报出来，不会拖到运行时才报，更便于 debug。</p>
<h2 id="why">Why</h2>
<h3 id="理解依赖注入">理解依赖注入</h3>
<p>什么是依赖注入？为什么要依赖注入？
<del>依赖注入就是 Java 遗毒</del>（不是）</p>
<p><a href="https://zh.wikipedia.org/wiki/%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5">依赖注入</a> (Dependency Injection，缩写为 DI)，可以理解为一种代码的构造模式（就是写法），按照这样的方式来写，能够让你的代码更加容易维护。</p>
<p>对于很多软件设计模式和架构的理念，我们都无法理解他们要绕好大一圈做复杂的体操、用奇怪的方式进行实现的意义。他们通常都只是丢出来一段样例，说这样写就很好很优雅，由于省略掉了这种模式是如何发展出来的推导过程，我们只看到了结果，导致理解起来很困难。那么接下来我们来尝试推导还原一下整个过程，看看代码是如何和为什么演进到依赖注入模式的，以便能够更好理解使用依赖注入的意义。</p>
<h4 id="依赖是什么">依赖是什么？</h4>
<p>这里的依赖是个名词，不是指软件包的依赖（比如那坨塞在 node_modules 里面的东西），而是指软件中某一个模块（对象/实例）所依赖的其它外部模块（对象/实例）。</p>
<h4 id="注入到哪里">注入到哪里？</h4>
<p>被依赖的模块，在创建模块时，被注入到（即当作参数传入）模块的里面。</p>
<h4 id="不-di-是啥样di-了又样子">不 DI 是啥样？DI 了又样子？</h4>
<p>下面用 go 伪代码来做例子，领会精神即可。</p>
<p>假设个场景，你在打工搞一个 web 应用，它有一个简单接口。最开始的项目代码可能长这个样子：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75af00">下面为伪代码</span><span style="color:#960050;background-color:#1e0010">，</span><span style="color:#75af00">忽略了很多与主题无关的细节</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">App</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75af00">假设这个方法将会匹配并处理</span> <span style="color:#75af00">GET</span> <span style="color:#f92672">/</span><span style="color:#75af00">biu</span><span style="color:#f92672">/</span><span style="color:#111">&lt;</span><span style="color:#75af00">id</span><span style="color:#111">&gt;</span> <span style="color:#75af00">这样的请求</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">a</span> <span style="color:#f92672">*</span><span style="color:#75af00">App</span><span style="color:#111">)</span> <span style="color:#75af00">GetData</span><span style="color:#111">(</span><span style="color:#75af00">id</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#00a8c8">string</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75af00">todo</span><span style="color:#111">:</span> <span style="color:#75af00">write</span> <span style="color:#75af00">your</span> <span style="color:#75af00">data</span> <span style="color:#75af00">query</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#d88200">&#34;some data&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">NewApp</span><span style="color:#111">()</span> <span style="color:#f92672">*</span><span style="color:#75af00">App</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">App</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">app</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">App</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">app</span><span style="color:#111">.</span><span style="color:#75af00">Run</span><span style="color:#111">()</span>
</span></span></code></pre></div><p>你要做的是接一个 mysql，从里面把数据按照 id 查出来，返回。
要连 mysql 的话，假设我们已经有了个<code>NewMySQLClient</code>的方法返回 client 给你，初始化时传个地址进去就能拿到数据库连接，并假设它有个<code>Exec</code>的方法给你执行参数。</p>
<h5 id="不用-di通过全局变量传递依赖实例">不用 DI，通过全局变量传递依赖实例</h5>
<p>一种写法是，在外面全局初始化好 client，然后 App 直接拿来调用。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">var</span> <span style="color:#75af00">mysqlUrl</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;mysql://blabla&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">var</span> <span style="color:#75af00">db</span> <span style="color:#111">=</span> <span style="color:#75af00">NewMySQLClient</span><span style="color:#111">(</span><span style="color:#75af00">mysqlUrl</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">App</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">a</span> <span style="color:#f92672">*</span><span style="color:#75af00">App</span><span style="color:#111">)</span> <span style="color:#75af00">GetData</span><span style="color:#111">(</span><span style="color:#75af00">id</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#00a8c8">string</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">data</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">Exec</span><span style="color:#111">(</span><span style="color:#d88200">&#34;select data from biu where id = ? limit 1&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">id</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#75af00">data</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">NewApp</span><span style="color:#111">()</span> <span style="color:#f92672">*</span><span style="color:#75af00">App</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">App</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">app</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">App</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">app</span><span style="color:#111">.</span><span style="color:#75af00">Run</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>这就是没用依赖注入，app 依赖了全局变量 db，这是比较糟糕的一种做法。db 这个对象游离在全局作用域，暴露给包下的其他模块，比较危险。（设想如果这个包里其他代码在运行时悄悄把你的这个 db 变量替换掉会发生啥）</p>
<h5 id="不用-di在-app-的初始化方法里创建依赖实例">不用 DI，在 App 的初始化方法里创建依赖实例</h5>
<p>另一种方式是这样的：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">App</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">db</span> <span style="color:#f92672">*</span><span style="color:#75af00">MySQLClient</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">a</span> <span style="color:#f92672">*</span><span style="color:#75af00">App</span><span style="color:#111">)</span> <span style="color:#75af00">GetData</span><span style="color:#111">(</span><span style="color:#75af00">id</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#00a8c8">string</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">data</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">a</span><span style="color:#111">.</span><span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">Exec</span><span style="color:#111">(</span><span style="color:#d88200">&#34;select data from biu where id = ? limit 1&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">id</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#75af00">data</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">NewApp</span><span style="color:#111">()</span> <span style="color:#f92672">*</span><span style="color:#75af00">App</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">App</span><span style="color:#111">{</span><span style="color:#75af00">db</span><span style="color:#111">:</span> <span style="color:#75af00">NewMySQLClient</span><span style="color:#111">(</span><span style="color:#75af00">mysqlUrl</span><span style="color:#111">)}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">app</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">NewApp</span><span style="color:#111">(</span><span style="color:#d88200">&#34;mysql://blabla&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">app</span><span style="color:#111">.</span><span style="color:#75af00">Run</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>这种方法稍微好一些，db 被塞到 app 里面了，不会有 app 之外的无关代码碰它，比较安全，但这依然不是依赖注入，而是在内部创建了依赖，接下来你会看到它带来的问题。</p>
<h5 id="老板我们的数据要换个地方存-需要变更实现">老板：我们的数据要换个地方存 （需要变更实现）</h5>
<p>你的老板不知道从哪听说——Redis 贼特么快，要不我们的数据改从 Redis 里读吧。这个时候你的内心有点崩溃，但毕竟要恰饭的，就硬着头皮改上面的代码。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">App</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">ds</span> <span style="color:#f92672">*</span><span style="color:#75af00">RedisClient</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">a</span> <span style="color:#f92672">*</span><span style="color:#75af00">App</span><span style="color:#111">)</span> <span style="color:#75af00">GetData</span><span style="color:#111">(</span><span style="color:#75af00">id</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#00a8c8">string</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">data</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">a</span><span style="color:#111">.</span><span style="color:#75af00">ds</span><span style="color:#111">.</span><span style="color:#75af00">Do</span><span style="color:#111">(</span><span style="color:#d88200">&#34;GET&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;biu_&#34;</span><span style="color:#f92672">+</span><span style="color:#75af00">id</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#75af00">data</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">NewApp</span><span style="color:#111">()</span> <span style="color:#f92672">*</span><span style="color:#75af00">App</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">App</span><span style="color:#111">{</span><span style="color:#75af00">ds</span><span style="color:#111">:</span> <span style="color:#75af00">NewRedisClient</span><span style="color:#111">(</span><span style="color:#75af00">redisAddr</span><span style="color:#111">)}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">app</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">NewApp</span><span style="color:#111">(</span><span style="color:#d88200">&#34;redis://ooo&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">app</span><span style="color:#111">.</span><span style="color:#75af00">Run</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>上面基本进行了 3 处修改：</p>
<ol>
<li>App 初始化方法里改成了初始化 RedisClient</li>
<li>get_data 里取数据时改用 run 方法，并且查询语句也换了</li>
<li>App 实例化时传入的参数改成了 redis 地址</li>
</ol>
<h5 id="老板要不我们再换个地方存我们要加测试需要-mock">老板：要不，我们再换个地方存？/我们要加测试，需要 Mock</h5>
<p>老板的思路总是很广的，又过了两天他又想换成 Postgres 存了；或者让你们给 App 写点测试代码，只测接口里面的逻辑，通常我们不太愿意在旁边再起一个数据库，那么就需要 mock 掉数据源这块东西，让它直接返回数据给请求的 handler 用，来进行针对性的测试。</p>
<p>这种情况怎么办？再改里面的代码？这不科学。</p>
<h5 id="面向接口编程">面向接口编程</h5>
<p>一个很重要的思路就是要<strong>面向接口(interface)编程</strong>，而不是面向具体实现编程。</p>
<p>什么叫面向具体实现编程呢？比如上述的例子里改动的部分：调 mysqlclient 的 exec_sql 执行一条 sql，被改成了：调 redisclient 的 do 执行一句 get 指令。由于每种 client 的接口设计不同，每换一个实现，就得改一遍。</p>
<p>而面向接口编程的思路，则完全不同。我们不要听老板想用啥就马上写代码。首先就得预料到，这个数据源的实现很有可能被更换，因此在一开始就应该做好准备（设计）。</p>
<h6 id="设计接口">设计接口</h6>
<p>Python 里面有个概念叫鸭子类型(duck-typing)，就是如果你叫起来像鸭子，走路像鸭子，游泳像鸭子，那么你就是一只鸭子。这里的叫、走路、游泳就是我们约定的鸭子接口，而你如果完整实现了这些接口，我们可以像对待一个鸭子一样对待你。</p>
<p>在我们上面的例子中，不论是 Mysql 实现还是 Redis 实现，他们都有个共同的功能：用一个 id，查一个数据出来，那么这就是共同的接口。</p>
<p>我们可以约定一个叫 DataSource 的接口，它必须有一个方法叫 GetById，功能是要接收一个 id，返回一个字符串</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">DataSource</span> <span style="color:#00a8c8">interface</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">GetById</span><span style="color:#111">(</span><span style="color:#75af00">id</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>然后我们就可以把各个数据源分别进行封装，按照这个 interface 定义实现接口，这样我们的 App 里处理请求的部分就可以稳定地调用 GetById 这个方法，而底层数据实现只要实现了 DataSource 这个 interface 就能花式替换，不用改 App 内部的代码了。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// 封装个redis</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">redis</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">r</span> <span style="color:#f92672">*</span><span style="color:#75af00">RedisClient</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">NewRedis</span><span style="color:#111">(</span><span style="color:#75af00">addr</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#f92672">*</span><span style="color:#75af00">redis</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">redis</span><span style="color:#111">{</span><span style="color:#75af00">r</span><span style="color:#111">:</span> <span style="color:#75af00">NewRedisClient</span><span style="color:#111">(</span><span style="color:#75af00">addr</span><span style="color:#111">)}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">r</span> <span style="color:#f92672">*</span><span style="color:#75af00">redis</span><span style="color:#111">)</span> <span style="color:#75af00">GetById</span><span style="color:#111">(</span><span style="color:#75af00">id</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#00a8c8">string</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">Do</span><span style="color:#111">(</span><span style="color:#d88200">&#34;GET&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;biu_&#34;</span><span style="color:#f92672">+</span><span style="color:#75af00">id</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 再封装个mysql</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">mysql</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">m</span> <span style="color:#f92672">*</span><span style="color:#75af00">MySQLClient</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">NewMySQL</span><span style="color:#111">(</span><span style="color:#75af00">addr</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#f92672">*</span><span style="color:#75af00">redis</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">mysql</span><span style="color:#111">{</span><span style="color:#75af00">m</span><span style="color:#111">:</span> <span style="color:#75af00">NewMySQLClient</span><span style="color:#111">(</span><span style="color:#75af00">addr</span><span style="color:#111">)}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">m</span> <span style="color:#f92672">*</span><span style="color:#75af00">mysql</span><span style="color:#111">)</span> <span style="color:#75af00">GetById</span><span style="color:#111">(</span><span style="color:#75af00">id</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#00a8c8">string</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">Exec</span><span style="color:#111">(</span><span style="color:#d88200">&#34;select data from biu where id = ? limit 1&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">id</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">App</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">ds</span> <span style="color:#75af00">DataSource</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">NewApp</span><span style="color:#111">(</span><span style="color:#75af00">addr</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#f92672">*</span><span style="color:#75af00">App</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//需要用Mysql的时候</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">App</span><span style="color:#111">{</span><span style="color:#75af00">ds</span><span style="color:#111">:</span> <span style="color:#75af00">NewMySQLClient</span><span style="color:#111">(</span><span style="color:#75af00">addr</span><span style="color:#111">)}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//需要用Redis的时候</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">App</span><span style="color:#111">{</span><span style="color:#75af00">ds</span><span style="color:#111">:</span> <span style="color:#75af00">NewRedisClient</span><span style="color:#111">(</span><span style="color:#75af00">addr</span><span style="color:#111">)}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>由于两种数据源都实现了 DataSource 接口，因此可以直接创建一个塞到 App 里面了，想用哪个用哪个，看着还不错？</p>
<h5 id="等一等好像少了些什么">等一等，好像少了些什么</h5>
<p>addr 作为参数，是不是有点简单？通常初始化一个数据库连接，可能有一堆参数，配在一个 yaml 文件里，需要解析到一个 struct 里面，然后再传给对应的 New 方法。</p>
<p>配置文件可能是这样的：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">redis</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">addr</span><span style="color:#111">:</span> <span style="color:#ae81ff">127.0.0.1</span><span style="color:#111">:</span><span style="color:#ae81ff">6379</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">read_timeout</span><span style="color:#111">:</span> <span style="color:#ae81ff">0.</span><span style="color:#ae81ff">2s</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">write_timeout</span><span style="color:#111">:</span> <span style="color:#ae81ff">0.</span><span style="color:#ae81ff">2s</span>
</span></span></code></pre></div><p>解析结构体是这样的：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">RedisConfig</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Network</span>      <span style="color:#00a8c8">string</span>             <span style="color:#d88200">`json:&#34;network,omitempty&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Addr</span>         <span style="color:#00a8c8">string</span>             <span style="color:#d88200">`json:&#34;addr,omitempty&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ReadTimeout</span>  <span style="color:#f92672">*</span><span style="color:#75af00">duration</span><span style="color:#111">.</span><span style="color:#75af00">Duration</span> <span style="color:#d88200">`json:&#34;read_timeout,omitempty&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">WriteTimeout</span> <span style="color:#f92672">*</span><span style="color:#75af00">duration</span><span style="color:#111">.</span><span style="color:#75af00">Duration</span> <span style="color:#d88200">`json:&#34;write_timeout,omitempty&#34;`</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>结果你的<code>NewApp</code>方法可能就变成了这个德性：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">NewApp</span><span style="color:#111">()</span> <span style="color:#f92672">*</span><span style="color:#75af00">App</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">var</span> <span style="color:#75af00">conf</span> <span style="color:#f92672">*</span><span style="color:#75af00">RedisConfig</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">yamlFile</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">ioutil</span><span style="color:#111">.</span><span style="color:#75af00">ReadFile</span><span style="color:#111">(</span><span style="color:#d88200">&#34;redis_conf.yaml&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">yaml</span><span style="color:#111">.</span><span style="color:#75af00">Unmarshal</span><span style="color:#111">(</span><span style="color:#75af00">yamlFile</span><span style="color:#111">,</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">conf</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">App</span><span style="color:#111">{</span><span style="color:#75af00">ds</span><span style="color:#111">:</span> <span style="color:#75af00">NewRedisClient</span><span style="color:#111">(</span><span style="color:#75af00">conf</span><span style="color:#111">)}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>NewApp 说，停停，你们年轻人不讲武德，我的责任就是创建一个 App 实例，我只需要一个 DataSource 注册进去，至于这个 DataSource 是怎么来的我不想管，这么一坨处理 conf 的代码凭什么要放在我这里，我也不想关心你这配置文件是通过网络请求拿来的还是从本地磁盘读的，我只想把 App 组装好扔出去直接下班。</p>
<h5 id="依赖注入终于可以登场了">依赖注入终于可以登场了</h5>
<p>还记得前面是怎么说依赖注入的吗？被依赖的模块，在创建模块时，被注入到（即当作参数传入）初始化函数里面。通过这种模式，正好可以让 NewApp 早点下班。我们在外面初始化好 NewRedis 或者 NewMysql，得到的 DataSource 直接扔给 NewApp。</p>
<p>也就是这样</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">NewApp</span><span style="color:#111">(</span><span style="color:#75af00">ds</span> <span style="color:#75af00">DataSource</span><span style="color:#111">)</span> <span style="color:#f92672">*</span><span style="color:#75af00">App</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">App</span><span style="color:#111">{</span><span style="color:#75af00">ds</span><span style="color:#111">:</span> <span style="color:#75af00">ds</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>那坨读配置文件初始化 redis 的代码扔到初始化 DataSource 的方法里去</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">NewRedis</span><span style="color:#111">()</span> <span style="color:#75af00">DataSource</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">var</span> <span style="color:#75af00">conf</span> <span style="color:#f92672">*</span><span style="color:#75af00">RedisConfig</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">yamlFile</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">ioutil</span><span style="color:#111">.</span><span style="color:#75af00">ReadFile</span><span style="color:#111">(</span><span style="color:#d88200">&#34;redis_conf.yaml&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">yaml</span><span style="color:#111">.</span><span style="color:#75af00">Unmarshal</span><span style="color:#111">(</span><span style="color:#75af00">yamlFile</span><span style="color:#111">,</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">conf</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">redis</span><span style="color:#111">{</span><span style="color:#75af00">r</span><span style="color:#111">:</span> <span style="color:#75af00">NewRedisClient</span><span style="color:#111">(</span><span style="color:#75af00">conf</span><span style="color:#111">)}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>更进一步，NewRedis 这个方法甚至也不需要关心文件是怎么读的，它的责任只是通过 conf 初始化一个 DataSource 出来，因此你可以继续把读 config 的代码往外抽，把 NewRedis 做成接收一个 conf，输出一个 DataSource</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">GetRedisConf</span><span style="color:#111">()</span> <span style="color:#f92672">*</span><span style="color:#75af00">RedisConfig</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">NewRedis</span><span style="color:#111">(</span><span style="color:#75af00">conf</span> <span style="color:#f92672">*</span><span style="color:#75af00">RedisConfig</span><span style="color:#111">)</span> <span style="color:#75af00">DataSource</span>
</span></span></code></pre></div><p>因为之前整个组装过程是散放在 main 函数下面的，我们把它抽出来搞成一个独立的 initApp 方法。最后你的 App 初始化逻辑就变成了这样</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">initApp</span><span style="color:#111">()</span> <span style="color:#f92672">*</span><span style="color:#75af00">App</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">c</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">GetRedisConf</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">r</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">NewRedis</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">app</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">NewApp</span><span style="color:#111">(</span><span style="color:#75af00">r</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#75af00">app</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">app</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">initApp</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">app</span><span style="color:#111">.</span><span style="color:#75af00">Run</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>然后你可以通过实现 DataSource 的接口，更换前面的读取配置文件的方法，和更换创建 DataSource 的方法，来任意修改你的底层实现（读配置文件的实现，和用哪种 DataSource 来查数据），而不用每次都改一大堆代码。这使得你的代码层次划分得更加清楚，更容易维护了。</p>
<p>这就是依赖注入。</p>
<h5 id="手工依赖注入的问题">手工依赖注入的问题</h5>
<p>上文这一坨代码，把各个实例初始化好，再按照各个初始化方法的需求塞进去，最终构造出 app 的这坨代码，就是注入依赖的过程。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">c</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">GetRedisConf</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">r</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">NewRedis</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">app</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">NewApp</span><span style="color:#111">(</span><span style="color:#75af00">r</span><span style="color:#111">)</span>
</span></span></code></pre></div><p>目前只有一个 DataSource，这样手写注入过程还可以，一旦你要维护的东西多了，比如你的 NewApp 是这样的<code>NewApp(r *Redis, es *ES, us *UserSerivce, db *MySQL) *App</code>然后其中 UserService 是这样的<code>UserService(pg *Postgres, mm *Memcached)</code>，这样形成了多层次的一堆依赖需要注入，徒手去写非常麻烦。</p>
<p>而这部分，就是 wire 这样的依赖注入工具能够起作用的地方了——他的功能只是通过生成代码<strong>帮你注入依赖</strong>，而实际的依赖实例需要你自己创建（初始化）。</p>
<h2 id="how">How</h2>
<p>wire 的主要问题是，<del>看文档学不会</del>。反正我最初看完文档之后是一头雾水——这是啥，这要干啥？但通过我们刚才的推导过程，应该大概理解了为什么要用依赖注入，以及 wire 在这其中起到什么作用——通过生成代码<strong>帮你注入依赖</strong>，而实际的依赖实例需要你自己创建（初始化）。</p>
<p>接下来就比较清楚了。</p>
<p>首先要实现一个<code>wire.go</code>的文件，里面定义好 Injector。</p>
<pre tabindex="0"><code>// +build wireinject

func initApp() (*App) {
	panic(wire.Build(GetRedisConf, NewRedis, SomeProviderSet, NewApp))
}
</code></pre><p>然后分别实现好 Provider。</p>
<p>执行<code>wire</code>命令后
他会扫描整个项目，并帮你生成一个<code>wire_gen.go</code>文件，如果你有什么没有实现好，它会报错出来。</p>
<p><del>你学会了吗？</del></p>
<h3 id="重新理解">重新理解</h3>
<p>等一等，先别放弃治疗，让我们用<del>神奇的中文编程</del>来解释一下要怎么做。</p>
<h4 id="谁参与编译">谁参与编译？</h4>
<p>上面那个<code>initApp</code>方法，官方文档叫它 Injector，由于文件里首行<code>// +build wireinject</code>这句注释，这个 wire.go 文件只会由 wire 读取，在 go 编译器在编译代码时不会去管它，实际会读的是生成的 wire_gen.go 文件。</p>
<p>而 Provider 就是你代码的一部分，肯定会参与到编译过程。</p>
<h4 id="injector-是什么鬼东西">Injector 是什么鬼东西？</h4>
<p>Injector 就是你最终想要的结果——最终的 App 对象的初始化函数，也就是前面那个例子里的<code>initApp</code>方法。</p>
<p>把它理解为你去吃金拱门，进门看到点餐机，噼里啪啦点了一堆，最后打出一张单子。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// +build wireinject</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">来一袋垃圾食品</span><span style="color:#111">()</span> <span style="color:#75af00">一袋垃圾食品</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#75af00">wire</span><span style="color:#111">.</span><span style="color:#75af00">Build</span><span style="color:#111">(</span><span style="color:#75af00">来一份巨无霸套餐</span><span style="color:#111">,</span> <span style="color:#75af00">来一份双层鳕鱼堡套餐</span><span style="color:#111">,</span> <span style="color:#75af00">来一盒麦乐鸡</span><span style="color:#111">,</span> <span style="color:#75af00">垃圾食品打包</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>这就是你点的单子，它不参与编译，实际参与编译的代码是由 wire 帮你生成的。</p>
<h4 id="provider-是什么鬼东西">Provider 是什么鬼东西？</h4>
<p>Provider 就是创建各个依赖的方法，比如前面例子里的 NewRedis 和 NewApp 等。</p>
<p>你可以理解为，这些是金拱门的服务员和后厨要干的事情：
金拱门后厨需要提供这些食品的制作服务——实现这些实例初始化方法。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">来一盒麦乐鸡</span><span style="color:#111">()</span> <span style="color:#75af00">一盒麦乐鸡</span> <span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">垃圾食品打包</span><span style="color:#111">(</span><span style="color:#75af00">一份巨无霸套餐</span><span style="color:#111">,</span> <span style="color:#75af00">一份双层鳕鱼堡套餐</span><span style="color:#111">,</span> <span style="color:#75af00">一盒麦乐鸡</span><span style="color:#111">)</span> <span style="color:#75af00">一袋垃圾食品</span> <span style="color:#111">{}</span>
</span></span></code></pre></div><p>wire 里面还有个 ProviderSet 的概念，就是把一组 Provider 打包，因为通常你点单的时候很懒，不想这样点你的巨无霸套餐：我要一杯可乐，一包薯条，一个巨无霸汉堡；你想直接戳一下就好了，来一份巨无霸套餐。这个套餐就是 ProviderSet，一组约定好的配方，不然你的点单列表（injector 里的 Build）就会变得超级长，这样你很麻烦，服务员看着也很累。</p>
<p>用其中一个套餐举例</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// 先定义套餐内容</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">var</span> <span style="color:#75af00">巨无霸套餐</span> <span style="color:#111">=</span> <span style="color:#75af00">wire</span><span style="color:#111">.</span><span style="color:#75af00">NewSet</span><span style="color:#111">(</span><span style="color:#75af00">来一杯可乐</span><span style="color:#960050;background-color:#1e0010">，</span><span style="color:#75af00">来一包薯条</span><span style="color:#960050;background-color:#1e0010">，</span><span style="color:#75af00">来一个巨无霸汉堡</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 然后实现各个食品的做法</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">来一杯可乐</span><span style="color:#111">()</span> <span style="color:#75af00">一杯可乐</span> <span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">来一包薯条</span><span style="color:#111">()</span> <span style="color:#75af00">一包薯条</span> <span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">来一个巨无霸汉堡</span><span style="color:#111">()</span> <span style="color:#75af00">一个巨无霸汉堡</span> <span style="color:#111">{}</span>
</span></span></code></pre></div><h4 id="wire-工具做了啥">wire 工具做了啥？</h4>
<p>重要的事情说三遍，通过生成代码<strong>帮你注入依赖</strong>。</p>
<p>在金拱门的例子里就是，wire 就是个服务员，它按照你的订单，去叫做相应的同事把各个食物/套餐做好，然后最终按需求打包给你。这个中间协调构建的过程，就是注入依赖。</p>
<p>这样的好处就是，
对于金拱门，假设他们突然换可乐供应商了，直接把<code>来一杯可乐</code>替换掉就行，返回一种新的可乐，而对于顾客不需要有啥改动。
对于顾客来说，点单内容可以变换，比如我今天不想要麦乐鸡了，或者想加点别的，只要改动我的点单(只要金拱门能做得出来)，然后通过 wire 重新去生成即可，不需要关注这个服务员是如何去做这个订单的。</p>
<p>现在你应该大概理解 wire 的用处和好处了。</p>
<h4 id="总结">总结</h4>
<p>让我们从金拱门回来，重新总结一下用 wire 做依赖注入的过程。</p>
<h5 id="1-定义-injector">1. 定义 Injector</h5>
<p>创建<code>wire.go</code>文件，定义下你最终想用的实例初始化函数例如<code>initApp</code>（即 Injector），定好它返回的东西<code>*App</code>，在方法里用<code>panic(wire.Build(NewRedis, SomeProviderSet, NewApp))</code>罗列出它依赖哪些实例的初始化方法（即 Provider）/或者哪些组初始化方法（ProviderSet）</p>
<h5 id="2-定义-providerset如果有的话">2. 定义 ProviderSet（如果有的话）</h5>
<p>ProviderSet 就是一组初始化函数，是为了少写一些代码，能够更清晰的组织各个模块的依赖才出现的。也可以不用，但 Injector 里面的东西就需要写一堆。
像这样 <code>var SomeProviderSet = wire.NewSet(NewES,NewDB)</code>定义 ProviderSet 里面包含哪些 Provider</p>
<h5 id="3-实现各个-provider">3. 实现各个 Provider</h5>
<p>Provider 就是初始化方法，你需要自己实现，比如 NewApp，NewRedis，NewMySQL，GetConfig 等，注意他们们各自的输入输出</p>
<h5 id="4-生成代码">4. 生成代码</h5>
<p>执行 wire 命令生成代码，工具会扫描你的代码，依照你的 Injector 定义来组织各个 Provider 的执行顺序，并自动按照 Provider 们的类型需求来按照顺序执行和安排参数传递，如果有哪些 Provider 的要求没有满足，会在终端报出来，持续修复执行 wire，直到成功生成<code>wire_gen.go</code>文件。接下来就可以正常使用<code>initApp</code>来写你后续的代码了。</p>
<p>如果需要替换实现，对 Injector 进行相应的修改，实现必须的 Provider，重新生成即可。</p>
<p>它生成的代码其实就是类似我们之前需要手写的这个</p>
<pre tabindex="0"><code>func initApp() *App {  // injector
    c := GetRedisConf() // provider
    r := NewRedis(c)  // provider
    app := NewApp(r) // provider
    return app
}
</code></pre><p>由于我们的例子比较简单，通过 wire 生成体现不出优势，但如果我们的软件复杂，有很多层级的依赖，使用 wire 自动生成注入逻辑，无疑更加方便和准确。</p>
<h5 id="5-高级用法">5. 高级用法</h5>
<p>wire 还有更多功能，比如 cleanup, bind 等等，请参考官方文档来使用。</p>
<p>最后，其实多折腾几次，就会使用了，希望本文能对您起到一定程度上的帮助。</p>
<h2 id="文章转自">文章转自</h2>
<ul>
<li><a href="https://go-kratos.dev/blog/go-project-wire">https://go-kratos.dev/blog/go-project-wire</a></li>
</ul>
<hr>
<p><img src="/images/b43c2417-ea24-4e28-b324-c53b433abc6c.png" alt=""></p>
<p><img src="/images/3e44cb72-7234-4f8d-b02b-0ab484c79442.gif" alt=""></p>
]]></content:encoded><category>kratos</category><category>go</category><category>kratos</category><category>wire</category></item><item><title>kratos v2版本命令行工具使用</title><link>https://daemon365.dev/post/kratos/kratos_v2_command_line_tool_usage/</link><pubDate>Sun, 12 Sep 2021 00:00:00 +0800</pubDate><guid>https://daemon365.dev/post/kratos/kratos_v2_command_line_tool_usage/</guid><description>&lt;h2 id="使用"&gt;使用&lt;/h2&gt;
&lt;h3 id="下载"&gt;下载&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;go install github.com/go-kratos/kratos/cmd/kratos/v2@latest
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;查看是否安装成功&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;kratos -v
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;kratos version v2.1.3
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id="升级"&gt;升级&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;kratos upgrade
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id="查看帮助"&gt;查看帮助&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75af00"&gt;kratos&lt;/span&gt; &lt;span style="color:#f92672"&gt;--&lt;/span&gt;&lt;span style="color:#75af00"&gt;help&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre tabindex="0"&gt;&lt;code&gt;Kratos: An elegant toolkit for Go microservices.
Usage:
kratos [command]
Available Commands:
changelog Get a kratos change log
completion generate the autocompletion script for the specified shell
help Help about any command
new Create a service template
proto Generate the proto files
run Run project
upgrade Upgrade the kratos tools
Flags:
-h, --help help for kratos
-v, --version version for kratos
Use &amp;#34;kratos [command] --help&amp;#34; for more information about a command.
&lt;/code&gt;&lt;/pre&gt;&lt;h2 id="new命令"&gt;new命令&lt;/h2&gt;
&lt;p&gt;kratos new 命令为创建一个kratos项目&lt;/p&gt;</description><content:encoded><![CDATA[<h2 id="使用">使用</h2>
<h3 id="下载">下载</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>go install github.com/go-kratos/kratos/cmd/kratos/v2@latest
</span></span></code></pre></div><p>查看是否安装成功</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kratos -v
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kratos version v2.1.3
</span></span></code></pre></div><h3 id="升级">升级</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kratos upgrade
</span></span></code></pre></div><h2 id="查看帮助">查看帮助</h2>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">kratos</span> <span style="color:#f92672">--</span><span style="color:#75af00">help</span>
</span></span></code></pre></div><pre tabindex="0"><code>Kratos: An elegant toolkit for Go microservices.

Usage:
  kratos [command]

Available Commands:
  changelog   Get a kratos change log
  completion  generate the autocompletion script for the specified shell
  help        Help about any command
  new         Create a service template
  proto       Generate the proto files
  run         Run project
  upgrade     Upgrade the kratos tools

Flags:
  -h, --help      help for kratos
  -v, --version   version for kratos

Use &#34;kratos [command] --help&#34; for more information about a command.
</code></pre><h2 id="new命令">new命令</h2>
<p>kratos new 命令为创建一个kratos项目</p>
<p>参数：</p>
<ul>
<li>
<p><code>-r</code> repo地址 默认为<code>https://github.com/go-kratos/kratos-layout</code></p>
</li>
<li>
<p><code>-b</code> git版本 默认为main分支</p>
</li>
<li>
<p><code>-t</code> 超时时间 默认为60s</p>
</li>
<li>
<p>也可添加环境变量<code>KRATOS_LAYOUT_REPO</code> 知道远程repo</p>
</li>
</ul>
<p>创建一个项目</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">kratos</span> <span style="color:#75af00">new</span> <span style="color:#75af00">helloworld</span>
</span></span></code></pre></div><p>因为默认远程仓库地址是 github上的，在国内很容易创建失败，所以要需要设置终端或者git代理（什么是终端代理和git代理可以百度或者google一下）。</p>
<p>当然你也可以使用<code>-r</code> 知道国内仓库 我们提供一个国内镜像<code>https://gitee.com/go-kratos/kratos-layout</code>。</p>
<p>如果嫌弃每次都要<code>-r</code>指定麻烦，也可以把<code>KRATOS_LAYOUT_REPO=https://gitee.com/go-kratos/kratos-layout</code> 加入到path中。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kratos new helloworld -r https://gitee.com/go-kratos/kratos-layout
</span></span></code></pre></div><h2 id="proto命令">proto命令</h2>
<p>proto命令下有 <code>add</code> <code>client</code> 和 <code>server</code>子命令</p>
<h3 id="add">add</h3>
<p><code>kratos proto add</code> 为创建一个proto模板</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kratos proto add api/helloworld/v2/hello.proto
</span></span></code></pre></div><p>在目录<code>api/helloworld/v2</code> 下可以看到生成的文件</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-protobuf" data-lang="protobuf"><span style="display:flex;"><span><span style="color:#111">syntax</span> <span style="color:#f92672">=</span> <span style="color:#d88200">&#34;proto3&#34;</span><span style="color:#111">;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#f92672">package</span> <span style="color:#111">api</span><span style="color:#f92672">.</span><span style="color:#111">helloworld.v2</span><span style="color:#111">;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#00a8c8">option</span> <span style="color:#111">go_package</span> <span style="color:#f92672">=</span> <span style="color:#d88200">&#34;helloworld/api/helloworld/v2;v2&#34;</span><span style="color:#111">;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#00a8c8">option</span> <span style="color:#111">java_multiple_files</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">true</span><span style="color:#111">;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#00a8c8">option</span> <span style="color:#111">java_package</span> <span style="color:#f92672">=</span> <span style="color:#d88200">&#34;api.helloworld.v2&#34;</span><span style="color:#111">;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#00a8c8">service</span> <span style="color:#111">Hello</span> <span style="color:#111">{</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    <span style="color:#00a8c8">rpc</span> <span style="color:#111">CreateHello</span> <span style="color:#111">(</span><span style="color:#111">CreateHelloRequest</span><span style="color:#111">)</span> <span style="color:#00a8c8">returns</span> <span style="color:#111">(</span><span style="color:#111">CreateHelloReply</span><span style="color:#111">);</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    <span style="color:#00a8c8">rpc</span> <span style="color:#111">UpdateHello</span> <span style="color:#111">(</span><span style="color:#111">UpdateHelloRequest</span><span style="color:#111">)</span> <span style="color:#00a8c8">returns</span> <span style="color:#111">(</span><span style="color:#111">UpdateHelloReply</span><span style="color:#111">);</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    <span style="color:#00a8c8">rpc</span> <span style="color:#111">DeleteHello</span> <span style="color:#111">(</span><span style="color:#111">DeleteHelloRequest</span><span style="color:#111">)</span> <span style="color:#00a8c8">returns</span> <span style="color:#111">(</span><span style="color:#111">DeleteHelloReply</span><span style="color:#111">);</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    <span style="color:#00a8c8">rpc</span> <span style="color:#111">GetHello</span> <span style="color:#111">(</span><span style="color:#111">GetHelloRequest</span><span style="color:#111">)</span> <span style="color:#00a8c8">returns</span> <span style="color:#111">(</span><span style="color:#111">GetHelloReply</span><span style="color:#111">);</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    <span style="color:#00a8c8">rpc</span> <span style="color:#111">ListHello</span> <span style="color:#111">(</span><span style="color:#111">ListHelloRequest</span><span style="color:#111">)</span> <span style="color:#00a8c8">returns</span> <span style="color:#111">(</span><span style="color:#111">ListHelloReply</span><span style="color:#111">);</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#111">}</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#00a8c8">message</span> <span style="color:#75af00">CreateHelloRequest</span> <span style="color:#111">{}</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#00a8c8">message</span> <span style="color:#75af00">CreateHelloReply</span> <span style="color:#111">{}</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#00a8c8">message</span> <span style="color:#75af00">UpdateHelloRequest</span> <span style="color:#111">{}</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#00a8c8">message</span> <span style="color:#75af00">UpdateHelloReply</span> <span style="color:#111">{}</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#00a8c8">message</span> <span style="color:#75af00">DeleteHelloRequest</span> <span style="color:#111">{}</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#00a8c8">message</span> <span style="color:#75af00">DeleteHelloReply</span> <span style="color:#111">{}</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#00a8c8">message</span> <span style="color:#75af00">GetHelloRequest</span> <span style="color:#111">{}</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#00a8c8">message</span> <span style="color:#75af00">GetHelloReply</span> <span style="color:#111">{}</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#00a8c8">message</span> <span style="color:#75af00">ListHelloRequest</span> <span style="color:#111">{}</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#00a8c8">message</span> <span style="color:#75af00">ListHelloReply</span> <span style="color:#111">{}</span><span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><h3 id="client">client</h3>
<p><code>kratos proto client</code> 为生成 Proto 代码</p>
<p>使用这个命令需要下载 protobuf 工具 protoc，可以在官网下载对应版本 <a href="https://github.com/protocolbuffers/protobuf/releases">Protobuf release版本</a></p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kratos proto client api/helloworld/v2/
</span></span></code></pre></div><p>这条命令就可以编译<code>api/helloworld/v2/</code>下的所有<code>.proto</code>文件</p>
<p>如果我们需要 import 其他<code>proto</code>文件 可以在命令后面加上<code>protoc</code>的参数</p>
<p>比如</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kratos proto client api/helloworld/v2/ --proto_path<span style="color:#f92672">=</span>api/helloworld/v2
</span></span></code></pre></div><p>默认也会把 <code>./third_party</code> 下import 进来 需要第三方的proto文件 可以放在这里</p>
<h3 id="server">server</h3>
<p><code>kratos proto server</code>为指定proto文件生成简单的service代码</p>
<p>参数：</p>
<ul>
<li><code>-t</code> 生成代码的位置 默认是<code>internal/service</code></li>
</ul>
<p>比如</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kratos proto server api/helloworld/v2/hello.proto -t<span style="color:#f92672">=</span>internal/service/hello
</span></span></code></pre></div><p>生成的代码</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">service</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d88200">&#34;context&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">pb</span> <span style="color:#d88200">&#34;helloworld/api/helloworld/v2&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">HelloService</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">pb</span><span style="color:#111">.</span><span style="color:#75af00">UnimplementedHelloServer</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">NewHelloService</span><span style="color:#111">()</span> <span style="color:#f92672">*</span><span style="color:#75af00">HelloService</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">HelloService</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">s</span> <span style="color:#f92672">*</span><span style="color:#75af00">HelloService</span><span style="color:#111">)</span> <span style="color:#75af00">ListHello</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">,</span> <span style="color:#75af00">req</span> <span style="color:#f92672">*</span><span style="color:#75af00">pb</span><span style="color:#111">.</span><span style="color:#75af00">ListHelloRequest</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">pb</span><span style="color:#111">.</span><span style="color:#75af00">ListHelloReply</span><span style="color:#111">,</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">pb</span><span style="color:#111">.</span><span style="color:#75af00">ListHelloReply</span><span style="color:#111">{},</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="run命令">run命令</h2>
<p>启动服务</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kratos run
</span></span></code></pre></div><h2 id="原文地址">原文地址</h2>
<ul>
<li><a href="https://zhaohaiyu.com/post/microservice/kratos-v2-tool/">kratos v2版本命令行工具使用 - haiyux&rsquo;s blog</a></li>
</ul>
]]></content:encoded><category>kratos</category><category>go</category><category>kratos</category></item><item><title>从kratos分析breaker熔断器源码实现</title><link>https://daemon365.dev/post/kratos/analyzing_the_breaker_fuse_source_code_implementation_from_kratos/</link><pubDate>Sat, 04 Sep 2021 17:55:01 +0800</pubDate><guid>https://daemon365.dev/post/kratos/analyzing_the_breaker_fuse_source_code_implementation_from_kratos/</guid><description>&lt;h2 id="为什么要用熔断"&gt;为什么要用熔断&lt;/h2&gt;
&lt;p&gt;前面我们讲过限流保证服务的可用性，不被突如其来的流量打爆。但是两种情况是限流解决不了的。&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;如果我们服务只能处理1000QPS，但是有10wQPS打过来，服务还是会炸。因为拒绝请求也需要成本。&lt;/li&gt;
&lt;li&gt;服务但是io型的，会把mysql，redis，mq等中间件打挂。&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;所以，我们遵循一个思路，可不可以client端在失败的多的时候就不调用了，直接返回错误呢？&lt;/p&gt;
&lt;h2 id="什么是熔断"&gt;什么是熔断&lt;/h2&gt;
&lt;p&gt;熔断器是为了当依赖的服务已经出现故障时，主动阻止对依赖服务的请求。保证自身服务的正常运行不受依赖服务影响，防止雪崩效应。&lt;/p&gt;
&lt;h2 id="源码分析"&gt;源码分析&lt;/h2&gt;
&lt;h3 id="源码地址"&gt;源码地址&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="https://github.com/go-kratos/aegis/tree/main/circuitbreaker"&gt;https://github.com/go-kratos/aegis/tree/main/circuitbreaker&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id="circuitbreaker-接口"&gt;CircuitBreaker 接口&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;type&lt;/span&gt; &lt;span style="color:#75af00"&gt;CircuitBreaker&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;interface&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;Allow&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;error&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;MarkSuccess&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;MarkFailed&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ol&gt;
&lt;li&gt;Allow()
&lt;ul&gt;
&lt;li&gt;判断熔断器是否允许通过&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;MarkSuccess()
&lt;ul&gt;
&lt;li&gt;熔断器成功的回调&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;MarkFailed()
&lt;ul&gt;
&lt;li&gt;熔断器失败的回调&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id="group-结构体"&gt;Group 结构体&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;type&lt;/span&gt; &lt;span style="color:#75af00"&gt;Group&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;struct&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;mutex&lt;/span&gt; &lt;span style="color:#75af00"&gt;sync&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Mutex&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;val&lt;/span&gt; &lt;span style="color:#75af00"&gt;atomic&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Value&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;New&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;func&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#75af00"&gt;CircuitBreaker&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ol&gt;
&lt;li&gt;&lt;code&gt;mutex&lt;/code&gt;
&lt;ul&gt;
&lt;li&gt;互斥锁，使val这个map不产生数据竞争&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;code&gt;val&lt;/code&gt;
&lt;ul&gt;
&lt;li&gt;map，存储name -&amp;gt; CircuitBreaker&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;code&gt;New&lt;/code&gt;
&lt;ul&gt;
&lt;li&gt;生成一个CircuitBreaker&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;h4 id="get方法"&gt;Get方法&lt;/h4&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;// Get .&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;g&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;Group&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75af00"&gt;Get&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;name&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;string&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75af00"&gt;CircuitBreaker&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;m&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;ok&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;g&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;val&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Load&lt;/span&gt;&lt;span style="color:#111"&gt;().(&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;map&lt;/span&gt;&lt;span style="color:#111"&gt;[&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;string&lt;/span&gt;&lt;span style="color:#111"&gt;]&lt;/span&gt;&lt;span style="color:#75af00"&gt;CircuitBreaker&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;ok&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;breaker&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;ok&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;m&lt;/span&gt;&lt;span style="color:#111"&gt;[&lt;/span&gt;&lt;span style="color:#75af00"&gt;name&lt;/span&gt;&lt;span style="color:#111"&gt;]&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;ok&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt; &lt;span style="color:#75af00"&gt;breaker&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 很具name从val拿出 breaker 如果存在返回&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// slowpath for group don`t have specified name breaker.&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;g&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;mutex&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Lock&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;nm&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#111"&gt;make&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;map&lt;/span&gt;&lt;span style="color:#111"&gt;[&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;string&lt;/span&gt;&lt;span style="color:#111"&gt;]&lt;/span&gt;&lt;span style="color:#75af00"&gt;CircuitBreaker&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#111"&gt;len&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;m&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;&lt;span style="color:#f92672"&gt;+&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;1&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;for&lt;/span&gt; &lt;span style="color:#75af00"&gt;k&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;v&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;range&lt;/span&gt; &lt;span style="color:#75af00"&gt;m&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;nm&lt;/span&gt;&lt;span style="color:#111"&gt;[&lt;/span&gt;&lt;span style="color:#75af00"&gt;k&lt;/span&gt;&lt;span style="color:#111"&gt;]&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#75af00"&gt;v&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;breaker&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;g&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;New&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;nm&lt;/span&gt;&lt;span style="color:#111"&gt;[&lt;/span&gt;&lt;span style="color:#75af00"&gt;name&lt;/span&gt;&lt;span style="color:#111"&gt;]&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#75af00"&gt;breaker&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 如果不存在 生成一个 并放入map 并返回&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;g&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;val&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Store&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;nm&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;g&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;mutex&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Unlock&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt; &lt;span style="color:#75af00"&gt;breaker&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id="breaker-结构体"&gt;Breaker 结构体&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;// Breaker is a sre CircuitBreaker pattern.&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;type&lt;/span&gt; &lt;span style="color:#75af00"&gt;Breaker&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;struct&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;stat&lt;/span&gt; &lt;span style="color:#75af00"&gt;window&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;RollingCounter&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;r&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;rand&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Rand&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// rand.New(...) returns a non thread safe object&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;randLock&lt;/span&gt; &lt;span style="color:#75af00"&gt;sync&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Mutex&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// Reducing the k will make adaptive throttling behave more aggressively,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// Increasing the k will make adaptive throttling behave less aggressively.&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;k&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;float64&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;request&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;int64&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;state&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;int32&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ol&gt;
&lt;li&gt;stat
&lt;ul&gt;
&lt;li&gt;滑动窗口，记录成功失败&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;r
&lt;ul&gt;
&lt;li&gt;随机数&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;randLock
&lt;ul&gt;
&lt;li&gt;读写锁&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;k 成功系数
&lt;ul&gt;
&lt;li&gt;total(总数) = success * k&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;request 请求数
&lt;ul&gt;
&lt;li&gt;当总数 &amp;lt; request时，不判断是否熔断&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;state
&lt;ul&gt;
&lt;li&gt;熔断器状态 打开或者关闭&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id="allow方法"&gt;Allow()方法&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;// Allow request if error returns nil.&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;b&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;Breaker&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75af00"&gt;Allow&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;error&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;success&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;total&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;b&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;summary&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 从活动窗口获取成功数和总数&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;k&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;b&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;k&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt; &lt;span style="color:#111"&gt;float64&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;success&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 根据k成功系数 获取&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// check overflow requests = K * success&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;total&lt;/span&gt; &lt;span style="color:#111"&gt;&amp;lt;&lt;/span&gt; &lt;span style="color:#75af00"&gt;b&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;request&lt;/span&gt; &lt;span style="color:#f92672"&gt;||&lt;/span&gt; &lt;span style="color:#111"&gt;float64&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;total&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#111"&gt;&amp;lt;&lt;/span&gt; &lt;span style="color:#75af00"&gt;k&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 如果总数&amp;lt;request 或者 总数 &amp;lt; k &lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;atomic&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;LoadInt32&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#f92672"&gt;&amp;amp;&lt;/span&gt;&lt;span style="color:#75af00"&gt;b&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;state&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#f92672"&gt;==&lt;/span&gt; &lt;span style="color:#75af00"&gt;StateOpen&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;atomic&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;CompareAndSwapInt32&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#f92672"&gt;&amp;amp;&lt;/span&gt;&lt;span style="color:#75af00"&gt;b&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;state&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;StateOpen&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;StateClosed&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 如果state是打开 关闭&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;atomic&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;LoadInt32&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#f92672"&gt;&amp;amp;&lt;/span&gt;&lt;span style="color:#75af00"&gt;b&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;state&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#f92672"&gt;==&lt;/span&gt; &lt;span style="color:#75af00"&gt;StateClosed&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;atomic&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;CompareAndSwapInt32&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#f92672"&gt;&amp;amp;&lt;/span&gt;&lt;span style="color:#75af00"&gt;b&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;state&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;StateClosed&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;StateOpen&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 如果state是关闭 打开&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;dr&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;math&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Max&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;0&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#111"&gt;float64&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;total&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;&lt;span style="color:#f92672"&gt;-&lt;/span&gt;&lt;span style="color:#75af00"&gt;k&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;&lt;span style="color:#f92672"&gt;/&lt;/span&gt;&lt;span style="color:#111"&gt;float64&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;total&lt;/span&gt;&lt;span style="color:#f92672"&gt;+&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;1&lt;/span&gt;&lt;span style="color:#111"&gt;))&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 获取系数，当k越大 dr越小&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;drop&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;b&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;trueOnProba&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;dr&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// trueOnProba 获取水机数&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// 返回是否&amp;lt;dr&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;drop&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 如果是 拒绝请求&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt; &lt;span style="color:#75af00"&gt;circuitbreaker&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;ErrNotAllowed&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;b&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;Breaker&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75af00"&gt;trueOnProba&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;proba&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;float64&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;truth&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;bool&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;b&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;randLock&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Lock&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;truth&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#75af00"&gt;b&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;r&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Float64&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#111"&gt;&amp;lt;&lt;/span&gt; &lt;span style="color:#75af00"&gt;proba&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;b&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;randLock&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Unlock&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;使用trueOnProba的原因是，当熔断器关闭时，随机让一部分请求通过，当success越大，请求的通过的数量就越多。用这些数据成功与否，放入窗口统计，当成功数达到要求时，就可以关闭熔断器了。&lt;/p&gt;</description><content:encoded><![CDATA[<h2 id="为什么要用熔断">为什么要用熔断</h2>
<p>前面我们讲过限流保证服务的可用性，不被突如其来的流量打爆。但是两种情况是限流解决不了的。</p>
<ol>
<li>如果我们服务只能处理1000QPS，但是有10wQPS打过来，服务还是会炸。因为拒绝请求也需要成本。</li>
<li>服务但是io型的，会把mysql，redis，mq等中间件打挂。</li>
</ol>
<p>所以，我们遵循一个思路，可不可以client端在失败的多的时候就不调用了，直接返回错误呢？</p>
<h2 id="什么是熔断">什么是熔断</h2>
<p>熔断器是为了当依赖的服务已经出现故障时，主动阻止对依赖服务的请求。保证自身服务的正常运行不受依赖服务影响，防止雪崩效应。</p>
<h2 id="源码分析">源码分析</h2>
<h3 id="源码地址">源码地址</h3>
<ul>
<li><a href="https://github.com/go-kratos/aegis/tree/main/circuitbreaker">https://github.com/go-kratos/aegis/tree/main/circuitbreaker</a></li>
</ul>
<h3 id="circuitbreaker-接口">CircuitBreaker 接口</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">CircuitBreaker</span> <span style="color:#00a8c8">interface</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Allow</span><span style="color:#111">()</span> <span style="color:#00a8c8">error</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">MarkSuccess</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">MarkFailed</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><ol>
<li>Allow()
<ul>
<li>判断熔断器是否允许通过</li>
</ul>
</li>
<li>MarkSuccess()
<ul>
<li>熔断器成功的回调</li>
</ul>
</li>
<li>MarkFailed()
<ul>
<li>熔断器失败的回调</li>
</ul>
</li>
</ol>
<h3 id="group-结构体">Group 结构体</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Group</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75af00">mutex</span> <span style="color:#75af00">sync</span><span style="color:#111">.</span><span style="color:#75af00">Mutex</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75af00">val</span>   <span style="color:#75af00">atomic</span><span style="color:#111">.</span><span style="color:#75af00">Value</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#75af00">New</span> <span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#75af00">CircuitBreaker</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><ol>
<li><code>mutex</code>
<ul>
<li>互斥锁，使val这个map不产生数据竞争</li>
</ul>
</li>
<li><code>val</code>
<ul>
<li>map，存储name -&gt; CircuitBreaker</li>
</ul>
</li>
<li><code>New</code>
<ul>
<li>生成一个CircuitBreaker</li>
</ul>
</li>
</ol>
<h4 id="get方法">Get方法</h4>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// Get .</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">g</span> <span style="color:#f92672">*</span><span style="color:#75af00">Group</span><span style="color:#111">)</span> <span style="color:#75af00">Get</span><span style="color:#111">(</span><span style="color:#75af00">name</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#75af00">CircuitBreaker</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">m</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">val</span><span style="color:#111">.</span><span style="color:#75af00">Load</span><span style="color:#111">().(</span><span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#00a8c8">string</span><span style="color:#111">]</span><span style="color:#75af00">CircuitBreaker</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">breaker</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">m</span><span style="color:#111">[</span><span style="color:#75af00">name</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#75af00">breaker</span> <span style="color:#75715e">// 很具name从val拿出 breaker 如果存在返回</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// slowpath for group don`t have specified name breaker.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">mutex</span><span style="color:#111">.</span><span style="color:#75af00">Lock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">nm</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#00a8c8">string</span><span style="color:#111">]</span><span style="color:#75af00">CircuitBreaker</span><span style="color:#111">,</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">m</span><span style="color:#111">)</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">k</span><span style="color:#111">,</span> <span style="color:#75af00">v</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">m</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">nm</span><span style="color:#111">[</span><span style="color:#75af00">k</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#75af00">v</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">breaker</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">New</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">nm</span><span style="color:#111">[</span><span style="color:#75af00">name</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#75af00">breaker</span> <span style="color:#75715e">// 如果不存在 生成一个 并放入map 并返回</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">val</span><span style="color:#111">.</span><span style="color:#75af00">Store</span><span style="color:#111">(</span><span style="color:#75af00">nm</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">mutex</span><span style="color:#111">.</span><span style="color:#75af00">Unlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">breaker</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="breaker-结构体">Breaker 结构体</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// Breaker is a sre CircuitBreaker pattern.</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Breaker</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75af00">stat</span> <span style="color:#75af00">window</span><span style="color:#111">.</span><span style="color:#75af00">RollingCounter</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75af00">r</span>    <span style="color:#f92672">*</span><span style="color:#75af00">rand</span><span style="color:#111">.</span><span style="color:#75af00">Rand</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75715e">// rand.New(...) returns a non thread safe object</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75af00">randLock</span> <span style="color:#75af00">sync</span><span style="color:#111">.</span><span style="color:#75af00">Mutex</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#75715e">// Reducing the k will make adaptive throttling behave more aggressively,</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75715e">// Increasing the k will make adaptive throttling behave less aggressively.</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75af00">k</span>       <span style="color:#00a8c8">float64</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75af00">request</span> <span style="color:#00a8c8">int64</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#75af00">state</span> <span style="color:#00a8c8">int32</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><ol>
<li>stat
<ul>
<li>滑动窗口，记录成功失败</li>
</ul>
</li>
<li>r
<ul>
<li>随机数</li>
</ul>
</li>
<li>randLock
<ul>
<li>读写锁</li>
</ul>
</li>
<li>k 成功系数
<ul>
<li>total(总数) = success * k</li>
</ul>
</li>
<li>request 请求数
<ul>
<li>当总数 &lt; request时，不判断是否熔断</li>
</ul>
</li>
<li>state
<ul>
<li>熔断器状态 打开或者关闭</li>
</ul>
</li>
</ol>
<h3 id="allow方法">Allow()方法</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// Allow request if error returns nil.</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">b</span> <span style="color:#f92672">*</span><span style="color:#75af00">Breaker</span><span style="color:#111">)</span> <span style="color:#75af00">Allow</span><span style="color:#111">()</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">success</span><span style="color:#111">,</span> <span style="color:#75af00">total</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">summary</span><span style="color:#111">()</span> <span style="color:#75715e">// 从活动窗口获取成功数和总数</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">k</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">k</span> <span style="color:#f92672">*</span> <span style="color:#111">float64</span><span style="color:#111">(</span><span style="color:#75af00">success</span><span style="color:#111">)</span> <span style="color:#75715e">// 根据k成功系数 获取</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// check overflow requests = K * success</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">total</span> <span style="color:#111">&lt;</span> <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">request</span> <span style="color:#f92672">||</span> <span style="color:#111">float64</span><span style="color:#111">(</span><span style="color:#75af00">total</span><span style="color:#111">)</span> <span style="color:#111">&lt;</span> <span style="color:#75af00">k</span> <span style="color:#111">{</span> <span style="color:#75715e">// 如果总数&lt;request 或者  总数 &lt; k </span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">atomic</span><span style="color:#111">.</span><span style="color:#75af00">LoadInt32</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">state</span><span style="color:#111">)</span> <span style="color:#f92672">==</span> <span style="color:#75af00">StateOpen</span> <span style="color:#111">{</span> 
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">atomic</span><span style="color:#111">.</span><span style="color:#75af00">CompareAndSwapInt32</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">state</span><span style="color:#111">,</span> <span style="color:#75af00">StateOpen</span><span style="color:#111">,</span> <span style="color:#75af00">StateClosed</span><span style="color:#111">)</span> <span style="color:#75715e">// 如果state是打开 关闭</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">atomic</span><span style="color:#111">.</span><span style="color:#75af00">LoadInt32</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">state</span><span style="color:#111">)</span> <span style="color:#f92672">==</span> <span style="color:#75af00">StateClosed</span> <span style="color:#111">{</span> 
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">atomic</span><span style="color:#111">.</span><span style="color:#75af00">CompareAndSwapInt32</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">state</span><span style="color:#111">,</span> <span style="color:#75af00">StateClosed</span><span style="color:#111">,</span> <span style="color:#75af00">StateOpen</span><span style="color:#111">)</span> <span style="color:#75715e">// 如果state是关闭 打开</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">dr</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">math</span><span style="color:#111">.</span><span style="color:#75af00">Max</span><span style="color:#111">(</span><span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#111">(</span><span style="color:#111">float64</span><span style="color:#111">(</span><span style="color:#75af00">total</span><span style="color:#111">)</span><span style="color:#f92672">-</span><span style="color:#75af00">k</span><span style="color:#111">)</span><span style="color:#f92672">/</span><span style="color:#111">float64</span><span style="color:#111">(</span><span style="color:#75af00">total</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span><span style="color:#111">))</span> <span style="color:#75715e">// 获取系数，当k越大 dr越小</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">drop</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">trueOnProba</span><span style="color:#111">(</span><span style="color:#75af00">dr</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// trueOnProba 获取水机数</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 返回是否&lt;dr</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">drop</span> <span style="color:#111">{</span> <span style="color:#75715e">// 如果是 拒绝请求</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">circuitbreaker</span><span style="color:#111">.</span><span style="color:#75af00">ErrNotAllowed</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">b</span> <span style="color:#f92672">*</span><span style="color:#75af00">Breaker</span><span style="color:#111">)</span> <span style="color:#75af00">trueOnProba</span><span style="color:#111">(</span><span style="color:#75af00">proba</span> <span style="color:#00a8c8">float64</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#75af00">truth</span> <span style="color:#00a8c8">bool</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">randLock</span><span style="color:#111">.</span><span style="color:#75af00">Lock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">truth</span> <span style="color:#111">=</span> <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">Float64</span><span style="color:#111">()</span> <span style="color:#111">&lt;</span> <span style="color:#75af00">proba</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">randLock</span><span style="color:#111">.</span><span style="color:#75af00">Unlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>使用trueOnProba的原因是，当熔断器关闭时，随机让一部分请求通过，当success越大，请求的通过的数量就越多。用这些数据成功与否，放入窗口统计，当成功数达到要求时，就可以关闭熔断器了。</p>
<h3 id="marksuccess以及markfailed方法">MarkSuccess()以及MarkFailed()方法</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// MarkSuccess mark requeest is success.</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">b</span> <span style="color:#f92672">*</span><span style="color:#75af00">Breaker</span><span style="color:#111">)</span> <span style="color:#75af00">MarkSuccess</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">stat</span><span style="color:#111">.</span><span style="color:#75af00">Add</span><span style="color:#111">(</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span> <span style="color:#75715e">// 成功数+1</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// MarkFailed mark request is failed.</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">b</span> <span style="color:#f92672">*</span><span style="color:#75af00">Breaker</span><span style="color:#111">)</span> <span style="color:#75af00">MarkFailed</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// NOTE: when client reject requets locally, continue add counter let the</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// drop ratio higher.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">stat</span><span style="color:#111">.</span><span style="color:#75af00">Add</span><span style="color:#111">(</span><span style="color:#ae81ff">0</span><span style="color:#111">)</span> <span style="color:#75715e">// 失败数+1</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="流程图">流程图</h2>
<p><img src="/images/304df75e-973a-4a9f-8bcd-c1f5315092b4.png" alt=""></p>
<h2 id="原文地址">原文地址</h2>
<ul>
<li><a href="https://zhaohaiyu.com/posts/microservice/breaker/">https://zhaohaiyu.com/posts/microservice/breaker/</a></li>
</ul>
<hr>
<p><img src="/images/5a7a74d9-0f0f-415c-825a-7da85dcbd4d9.png" alt=""></p>
<p><img src="/images/e3bfa05c-c2aa-4ae9-94b2-a8a12aa4bd7e.gif" alt=""></p>
]]></content:encoded><category>kratos</category><category>go</category><category>kratos</category><category>breaker</category><category>源码分析</category></item><item><title>从kratos分析BBR限流源码实现</title><link>https://daemon365.dev/post/kratos/analyzing_the_implementation_of_bbr_current_limiting_source_code_from_kratos/</link><pubDate>Sat, 04 Sep 2021 00:00:00 +0800</pubDate><guid>https://daemon365.dev/post/kratos/analyzing_the_implementation_of_bbr_current_limiting_source_code_from_kratos/</guid><description>&lt;h2 id="什么是自适应限流"&gt;什么是自适应限流&lt;/h2&gt;
&lt;p&gt;自适应限流从整体维度对应用入口流量进行控制，结合应用的 Load、CPU 使用率、总体平均 RT、入口 QPS 和并发线程数等几个维度的监控指标，通过自适应的流控策略，让系统的入口流量和系统的负载达到一个平衡，让系统尽可能跑在最大吞吐量的同时保证系统整体的稳定性。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;核心目标：&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;自动嗅探负载和 qps，减少人工配置&lt;/li&gt;
&lt;li&gt;削顶，保证超载时系统不被拖垮，并能以高水位 qps 继续运行&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="限流规则"&gt;限流规则&lt;/h2&gt;
&lt;p&gt;&lt;img src="https://daemon365.dev/images/fdc8a49d-6a85-4ad6-b266-994260aa8350.png" alt=""&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;计算吞吐量：利特尔法则 &lt;code&gt;L = λ * W&lt;/code&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;如上图所示，如果我们开一个小店，平均每分钟进店 2 个客人(λ)，每位客人从等待到完成交易需要 4 分钟(W)，那我们店里能承载的客人数量就是 2 * 4 = 8 个人&lt;/p&gt;
&lt;p&gt;同理，我们可以将 &lt;code&gt;λ&lt;/code&gt; 当做 QPS， &lt;code&gt;W&lt;/code&gt; 呢是每个请求需要花费的时间，那我们的系统的吞吐就是 &lt;code&gt;L = λ * W&lt;/code&gt; ，所以我们可以使用利特尔法则来计算系统的吞吐量。&lt;/p&gt;
&lt;h3 id="指标介绍"&gt;指标介绍&lt;/h3&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;指标名称&lt;/th&gt;
&lt;th&gt;指标含义&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;cpu&lt;/td&gt;
&lt;td&gt;最近 1s 的 CPU 使用率均值，使用滑动平均计算，采样周期是 250ms&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;inflight&lt;/td&gt;
&lt;td&gt;当前处理中正在处理的请求数量&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;pass&lt;/td&gt;
&lt;td&gt;请求处理成功的量&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;rt&lt;/td&gt;
&lt;td&gt;请求成功的响应耗时&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h3 id="滑动窗口"&gt;滑动窗口&lt;/h3&gt;
&lt;p&gt;在自适应限流保护中，采集到的指标的时效性非常强，系统只需要采集最近一小段时间内的 qps、rt 即可，对于较老的数据，会自动丢弃。为了实现这个效果，kratos 使用了滑动窗口来保存采样数据。&lt;/p&gt;
&lt;p&gt;&lt;img src="https://daemon365.dev/images/d3cc3465-12f9-4400-bc50-8a7af654570c.png" alt=""&gt;&lt;/p&gt;
&lt;p&gt;如上图，展示了一个具有两个桶（bucket）的滑动窗口（rolling window）。整个滑动窗口用来保存最近 1s 的采样数据，每个小的桶用来保存 500ms 的采样数据。 当时间流动之后，过期的桶会自动被新桶的数据覆盖掉，在图中，在 1000-1500ms 时，bucket 1 的数据因为过期而被丢弃，之后 bucket 3 的数据填到了窗口的头部。&lt;/p&gt;</description><content:encoded><![CDATA[<h2 id="什么是自适应限流">什么是自适应限流</h2>
<p>自适应限流从整体维度对应用入口流量进行控制，结合应用的 Load、CPU 使用率、总体平均 RT、入口 QPS 和并发线程数等几个维度的监控指标，通过自适应的流控策略，让系统的入口流量和系统的负载达到一个平衡，让系统尽可能跑在最大吞吐量的同时保证系统整体的稳定性。</p>
<p><strong>核心目标：</strong></p>
<ul>
<li>自动嗅探负载和 qps，减少人工配置</li>
<li>削顶，保证超载时系统不被拖垮，并能以高水位 qps 继续运行</li>
</ul>
<h2 id="限流规则">限流规则</h2>
<p><img src="/images/fdc8a49d-6a85-4ad6-b266-994260aa8350.png" alt=""></p>
<p><strong>计算吞吐量：利特尔法则 <code>L = λ * W</code></strong></p>
<p>如上图所示，如果我们开一个小店，平均每分钟进店 2 个客人(λ)，每位客人从等待到完成交易需要 4 分钟(W)，那我们店里能承载的客人数量就是 2 * 4 = 8 个人</p>
<p>同理，我们可以将 <code>λ</code> 当做 QPS， <code>W</code> 呢是每个请求需要花费的时间，那我们的系统的吞吐就是 <code>L = λ * W</code> ，所以我们可以使用利特尔法则来计算系统的吞吐量。</p>
<h3 id="指标介绍">指标介绍</h3>
<table>
  <thead>
      <tr>
          <th>指标名称</th>
          <th>指标含义</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>cpu</td>
          <td>最近 1s 的 CPU 使用率均值，使用滑动平均计算，采样周期是 250ms</td>
      </tr>
      <tr>
          <td>inflight</td>
          <td>当前处理中正在处理的请求数量</td>
      </tr>
      <tr>
          <td>pass</td>
          <td>请求处理成功的量</td>
      </tr>
      <tr>
          <td>rt</td>
          <td>请求成功的响应耗时</td>
      </tr>
  </tbody>
</table>
<h3 id="滑动窗口">滑动窗口</h3>
<p>在自适应限流保护中，采集到的指标的时效性非常强，系统只需要采集最近一小段时间内的 qps、rt 即可，对于较老的数据，会自动丢弃。为了实现这个效果，kratos 使用了滑动窗口来保存采样数据。</p>
<p><img src="/images/d3cc3465-12f9-4400-bc50-8a7af654570c.png" alt=""></p>
<p>如上图，展示了一个具有两个桶（bucket）的滑动窗口（rolling window）。整个滑动窗口用来保存最近 1s 的采样数据，每个小的桶用来保存 500ms 的采样数据。 当时间流动之后，过期的桶会自动被新桶的数据覆盖掉，在图中，在 1000-1500ms 时，bucket 1 的数据因为过期而被丢弃，之后 bucket 3 的数据填到了窗口的头部。</p>
<h3 id="限流公式">限流公式</h3>
<p>判断是否丢弃当前请求的算法如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">cpu</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">800</span> <span style="color:#75af00">AND</span> <span style="color:#111">(</span><span style="color:#75af00">Now</span> <span style="color:#f92672">-</span> <span style="color:#75af00">PrevDrop</span><span style="color:#111">)</span> <span style="color:#111">&lt;</span> <span style="color:#ae81ff">1</span><span style="color:#75af00">s</span> <span style="color:#75af00">AND</span> <span style="color:#111">(</span><span style="color:#75af00">MaxPass</span> <span style="color:#f92672">*</span> <span style="color:#75af00">MinRt</span> <span style="color:#f92672">*</span> <span style="color:#75af00">windows</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">1000</span><span style="color:#111">)</span> <span style="color:#111">&lt;</span> <span style="color:#75af00">InFlight</span>
</span></span></code></pre></div><p>MaxPass 表示最近 5s 内，单个采样窗口中最大的请求数。 MinRt 表示最近 5s 内，单个采样窗口中最小的响应时间。 windows 表示一秒内采样窗口的数量，默认配置中是 5s 50 个采样，那么 windows 的值为 10。</p>
<h2 id="源码分析">源码分析</h2>
<h2 id="代码地址">代码地址：</h2>
<ul>
<li><a href="https://github.com/go-kratos/aegis/tree/main/ratelimit/bbr">https://github.com/go-kratos/aegis/tree/main/ratelimit/bbr</a></li>
</ul>
<h3 id="bbr-struct">BBR struct</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">BBR</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">cpu</span>             <span style="color:#75af00">cpuGetter</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">passStat</span>        <span style="color:#75af00">window</span><span style="color:#111">.</span><span style="color:#75af00">RollingCounter</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">rtStat</span>          <span style="color:#75af00">window</span><span style="color:#111">.</span><span style="color:#75af00">RollingCounter</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">inFlight</span>        <span style="color:#00a8c8">int64</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">bucketPerSecond</span> <span style="color:#00a8c8">int64</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">bucketSize</span>      <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Duration</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// prevDropTime defines previous start drop since initTime</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">prevDropTime</span> <span style="color:#75af00">atomic</span><span style="color:#111">.</span><span style="color:#75af00">Value</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">maxPASSCache</span> <span style="color:#75af00">atomic</span><span style="color:#111">.</span><span style="color:#75af00">Value</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">minRtCache</span>   <span style="color:#75af00">atomic</span><span style="color:#111">.</span><span style="color:#75af00">Value</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">opts</span> <span style="color:#f92672">*</span><span style="color:#75af00">options</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><ol>
<li><code>cpu</code>
<ul>
<li>cpu的指标函数，CPU的使用率， 这里为了减小误差，把数字扩大化，乘以1000，比赛使用率60%，也就是0.6 cpu的值就为600</li>
</ul>
</li>
<li><code>passStat</code>
<ul>
<li>请求数的采样数据，使用滑动窗口进行统计</li>
</ul>
</li>
<li><code>rtStat</code>
<ul>
<li>响应时间的采样数据，同样使用滑动窗口进行统计</li>
</ul>
</li>
<li><code>inFlight</code>
<ul>
<li>当前系统中的请求数，数据得来方法是：中间件原理在处理前+1，处理handle之后不管成功失败都减去1</li>
</ul>
</li>
<li><code>bucketPerSecond</code>
<ul>
<li>一个 bucket 的时间</li>
</ul>
</li>
<li><code>bucketSize</code>
<ul>
<li>桶的数量</li>
</ul>
</li>
<li><code>prevDropTime</code>
<ul>
<li>上次触发限流时间</li>
</ul>
</li>
<li><code>maxPASSCache</code>
<ul>
<li>单个采样窗口中最大的请求数的缓存数据</li>
</ul>
</li>
<li><code>minRtCache</code>
<ul>
<li>单个采样窗口中最小的响应时间的缓存数据</li>
</ul>
</li>
</ol>
<h2 id="allow接口">Allow接口</h2>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// Allow checks all inbound traffic.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Once overload is detected, it raises limit.ErrLimitExceed error.</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">l</span> <span style="color:#f92672">*</span><span style="color:#75af00">BBR</span><span style="color:#111">)</span> <span style="color:#75af00">Allow</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#00a8c8">func</span><span style="color:#111">(),</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">l</span><span style="color:#111">.</span><span style="color:#75af00">shouldDrop</span><span style="color:#111">()</span> <span style="color:#111">{</span> <span style="color:#75715e">// shouldDrop 判断是否需要限流，如果true表示拒绝 之后重点讲</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">ErrLimitExceed</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">atomic</span><span style="color:#111">.</span><span style="color:#75af00">AddInt64</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">l</span><span style="color:#111">.</span><span style="color:#75af00">inFlight</span><span style="color:#111">,</span> <span style="color:#ae81ff">1</span><span style="color:#111">)</span> <span style="color:#75715e">// 之前说的，正在处理数+1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">stime</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Since</span><span style="color:#111">(</span><span style="color:#75af00">initTime</span><span style="color:#111">)</span> <span style="color:#75715e">// 现在时间减去程序初始化时间 表示程序开始执行时刻</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#111">{</span> <span style="color:#75715e">// allow返回函数 在中间件（拦截器）中handle执行完成后调用</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">rt</span> <span style="color:#f92672">:=</span> <span style="color:#111">int64</span><span style="color:#111">((</span><span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Since</span><span style="color:#111">(</span><span style="color:#75af00">initTime</span><span style="color:#111">)</span> <span style="color:#f92672">-</span> <span style="color:#75af00">stime</span><span style="color:#111">)</span> <span style="color:#f92672">/</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Millisecond</span><span style="color:#111">)</span>  <span style="color:#75715e">// 执行完handle的时间减去stime 表示 程序执行的总时间 单位ms</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">l</span><span style="color:#111">.</span><span style="color:#75af00">rtStat</span><span style="color:#111">.</span><span style="color:#75af00">Add</span><span style="color:#111">(</span><span style="color:#75af00">rt</span><span style="color:#111">)</span> <span style="color:#75715e">// 把处理时间放进采样数据window</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">atomic</span><span style="color:#111">.</span><span style="color:#75af00">AddInt64</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">l</span><span style="color:#111">.</span><span style="color:#75af00">inFlight</span><span style="color:#111">,</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span> <span style="color:#75715e">// 正在处理数-1 便是处理完成</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">l</span><span style="color:#111">.</span><span style="color:#75af00">passStat</span><span style="color:#111">.</span><span style="color:#75af00">Add</span><span style="color:#111">(</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span> <span style="color:#75715e">// 成功了，把通过数的采样数据window加1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">},</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="shoulddrop方法">shouldDrop方法</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">l</span> <span style="color:#f92672">*</span><span style="color:#75af00">BBR</span><span style="color:#111">)</span> <span style="color:#75af00">shouldDrop</span><span style="color:#111">()</span> <span style="color:#00a8c8">bool</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">curTime</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Since</span><span style="color:#111">(</span><span style="color:#75af00">initTime</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">l</span><span style="color:#111">.</span><span style="color:#75af00">cpu</span><span style="color:#111">()</span> <span style="color:#111">&lt;</span> <span style="color:#75af00">l</span><span style="color:#111">.</span><span style="color:#75af00">opts</span><span style="color:#111">.</span><span style="color:#75af00">CPUThreshold</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// current cpu payload below the threshold</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">prevDropTime</span><span style="color:#111">,</span> <span style="color:#75af00">_</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">l</span><span style="color:#111">.</span><span style="color:#75af00">prevDropTime</span><span style="color:#111">.</span><span style="color:#75af00">Load</span><span style="color:#111">().(</span><span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Duration</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">prevDropTime</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// haven&#39;t start drop,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// accept current request</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">false</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">curTime</span><span style="color:#f92672">-</span><span style="color:#75af00">prevDropTime</span> <span style="color:#f92672">&lt;=</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Second</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// just start drop one second ago,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// check current inflight count</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">inFlight</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">atomic</span><span style="color:#111">.</span><span style="color:#75af00">LoadInt64</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">l</span><span style="color:#111">.</span><span style="color:#75af00">inFlight</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#75af00">inFlight</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">inFlight</span> <span style="color:#111">&gt;</span> <span style="color:#75af00">l</span><span style="color:#111">.</span><span style="color:#75af00">maxInFlight</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">l</span><span style="color:#111">.</span><span style="color:#75af00">prevDropTime</span><span style="color:#111">.</span><span style="color:#75af00">Store</span><span style="color:#111">(</span><span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Duration</span><span style="color:#111">(</span><span style="color:#ae81ff">0</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">false</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// current cpu payload exceeds the threshold</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">inFlight</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">atomic</span><span style="color:#111">.</span><span style="color:#75af00">LoadInt64</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">l</span><span style="color:#111">.</span><span style="color:#75af00">inFlight</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">drop</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">inFlight</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">inFlight</span> <span style="color:#111">&gt;</span> <span style="color:#75af00">l</span><span style="color:#111">.</span><span style="color:#75af00">maxInFlight</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">drop</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">prevDrop</span><span style="color:#111">,</span> <span style="color:#75af00">_</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">l</span><span style="color:#111">.</span><span style="color:#75af00">prevDropTime</span><span style="color:#111">.</span><span style="color:#75af00">Load</span><span style="color:#111">().(</span><span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Duration</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">prevDrop</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// already started drop, return directly</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#75af00">drop</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// store start drop time</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">l</span><span style="color:#111">.</span><span style="color:#75af00">prevDropTime</span><span style="color:#111">.</span><span style="color:#75af00">Store</span><span style="color:#111">(</span><span style="color:#75af00">curTime</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">drop</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p><strong>maxInFlight()方法代表过去的负载</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#111">int64</span><span style="color:#111">(</span><span style="color:#75af00">math</span><span style="color:#111">.</span><span style="color:#75af00">Floor</span><span style="color:#111">(</span><span style="color:#111">float64</span><span style="color:#111">(</span><span style="color:#75af00">l</span><span style="color:#111">.</span><span style="color:#75af00">maxPASS</span><span style="color:#111">()</span><span style="color:#f92672">*</span><span style="color:#75af00">l</span><span style="color:#111">.</span><span style="color:#75af00">minRT</span><span style="color:#111">()</span><span style="color:#f92672">*</span><span style="color:#75af00">l</span><span style="color:#111">.</span><span style="color:#75af00">bucketPerSecond</span><span style="color:#111">)</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1000.0</span><span style="color:#111">)</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0.5</span><span style="color:#111">)</span>
</span></span></code></pre></div><p>参考算法：https://github.com/alibaba/Sentinel/wiki/%E7%B3%BB%E7%BB%9F%E8%87%AA%E9%80%82%E5%BA%94%E9%99%90%E6%B5%81</p>
<ul>
<li>maxPass * bucketPerSecond / 1000 为每毫秒处理的请求数</li>
<li>l.minRT() 为 单个采样窗口中最小的响应时间</li>
<li>T ≈ QPS * Avg(RT)</li>
<li><code> + 0.5</code>为向上取整</li>
</ul>
<h3 id="流程图">流程图</h3>
<p><img src="/images/c13f3623-a858-4322-9695-f1db1a4f85a5.png" alt=""></p>
<h2 id="压测报告">压测报告</h2>
<p>场景1，请求以每秒增加1个的速度不停上升，压测效果如下：</p>
<p><img src="/images/fcae1ea8-da01-470a-823d-ab394851b01a.png" alt=""></p>
<p>左测是没有限流的压测效果，右侧是带限流的压测效果。 可以看到，没有限流的场景里，系统在 700qps 时开始抖动，在 1k qps 时被拖垮，几乎没有新的请求能被放行，然而在使用限流之后，系统请求能够稳定在 600 qps 左右，rt 没有暴增，服务也没有被打垮，可见，限流有效的保护了服务。</p>
<h2 id="原文地址">原文地址：</h2>
<ul>
<li><a href="https://zhaohaiyu.com/posts/microservice/overload/">https://zhaohaiyu.com/posts/microservice/overload/</a></li>
</ul>
<p>参考文章：</p>
<ul>
<li><a href="https://v1.go-kratos.dev/#/ratelimit">https://v1.go-kratos.dev/#/ratelimit</a></li>
<li><a href="https://github.com/alibaba/Sentinel/wiki/%E7%B3%BB%E7%BB%9F%E8%87%AA%E9%80%82%E5%BA%94%E9%99%90%E6%B5%81">https://github.com/alibaba/Sentinel/wiki/%E7%B3%BB%E7%BB%9F%E8%87%AA%E9%80%82%E5%BA%94%E9%99%90%E6%B5%81</a></li>
</ul>
<hr>
<p><img src="/images/f3c8339b-cae8-4cde-9f92-dd68eba61462.png" alt=""></p>
<p><img src="/images/cec35d8f-b7d4-4c38-adb3-1fe46b6c7a1b.gif" alt=""></p>
]]></content:encoded><category>kratos</category><category>go</category><category>kratos</category><category>BBR</category><category>源码分析</category></item><item><title>Kratos漫游指南 1 - 概览</title><link>https://daemon365.dev/post/kratos/the_hitchhikers_guide_to_kratos_1___overview/</link><pubDate>Thu, 02 Sep 2021 00:00:00 +0800</pubDate><guid>https://daemon365.dev/post/kratos/the_hitchhikers_guide_to_kratos_1___overview/</guid><description>&lt;p&gt;您好，地球人，欢迎来到Kratos漫游指南。&lt;/p&gt;
&lt;p&gt;对于刚开始研究Kratos框架的开发者来说，目前的文档有些零散，这与我们的模块化设计有一些关系，不过Don&amp;rsquo;t panic，从这篇文章开始，我将试图打破这一现状，漫游指南系列将循序渐进地介绍Kratos框架，理顺框架的使用思路，使您更快上手Kratos。&lt;/p&gt;
&lt;p&gt;同时，这个系列也会逐步整合进官方文档中，同时重新组织整个文档的结构和内容，敬请期待。&lt;/p&gt;
&lt;p&gt;本篇是该系列的第一篇，主要介绍Kratos的整体概况。&lt;/p&gt;
&lt;h2 id="设计哲学"&gt;设计哲学&lt;/h2&gt;
&lt;p&gt;Kratos是一个Go语言实现的微服务框架，说得更准确一点，它更类似于一个使用Go构建微服务的工具箱，开发者可以按照自己的习惯选用或定制其中的的组件，来打造自己的微服务。也正是由于这样的原因，Kratos并不绑定于特定的基础设施，不限定于某种注册中心，或数据库ORM等，所以您可以十分轻松地将任意库集成进项目里，与Kratos共同运作。&lt;/p&gt;
&lt;p&gt;围绕这样的核心设计理念，我们设计了如下的项目生态：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="https://github.com/go-kratos/kratos"&gt;kratos&lt;/a&gt; Kratos框架核心，主要包含了基础的CLI工具，内置的HTTP/gRPC接口生成和服务生命周期管理，提供链路追踪、配置文件、日志、服务发现、监控等组件能力和相关接口定义。&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/go-kratos/kratos/tree/main/contrib"&gt;contrib&lt;/a&gt; 基于上述核心定义的基础接口，对配置文件、日志、服务发现、监控等服务进行具体实现所形成的一系列插件，可以直接使用它们，也可以参考它们的代码，做您需要的服务的适配，从而集成进kratos项目中来。&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/go-kratos/aegis"&gt;aegis&lt;/a&gt; 我们将服务可用性相关的算法：如限流、熔断等算法放在了这个独立的项目里，几乎没有外部依赖，它更不依赖Kratos，您可以在直接在任意项目中使用。您也可以轻松将它集成到Kratos中使用，提高服务的可用性。&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/go-kratos/kratos-layout"&gt;layout&lt;/a&gt; 我们设计的一个默认的项目模板，它包含一个参考了DDD和简洁架构设计的项目结构、Makefile脚本和Dockerfile文件。但这个项目模板不是必需的，您可以任意修改它，或使用自己设计的项目结构，Kratos依然可以正常工作。框架本身不对项目结构做任何假设和限制，您可以按照自己的想法来使用，具有很强的可定制性。&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/go-kratos/gateway"&gt;gateway&lt;/a&gt; 这个是我们刚刚起步，用Go开发的API Gateway，后续您可以使用它来作为您Kratos微服务的网关，用于微服务API的治理，项目正在施工中，欢迎关注。&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="仓库文档和社区"&gt;仓库、文档和社区&lt;/h2&gt;
&lt;p&gt;GitHub仓库：&lt;a href="https://github.com/go-kratos"&gt;https://github.com/go-kratos&lt;/a&gt;
文档：&lt;a href="https://go-kratos.dev/"&gt;https://go-kratos.dev/&lt;/a&gt;
微信群：&lt;a href="https://github.com/go-kratos/kratos/issues/682"&gt;go-kratos 官方微信群&lt;/a&gt;
Discord：&lt;a href="https://discord.com/invite/BWzJsUJ"&gt;go-kratos&lt;/a&gt;&lt;/p&gt;
&lt;h2 id="为什么v2完全重新设计"&gt;为什么v2完全重新设计&lt;/h2&gt;
&lt;p&gt;以前关注过kratos项目的可能知道，Kratos的&lt;a href="https://github.com/go-kratos/kratos/tree/v1.0.x"&gt;v1&lt;/a&gt;版本已经开源了很久，也是个较为完善的框架。那么为什么不直接基于v1继续迭代，而是要推倒重来，推出完全重新设计的v2呢？&lt;/p&gt;
&lt;p&gt;经验源自踩坑。&lt;/p&gt;
&lt;p&gt;在业务不断迭代、项目不断膨胀的情况下，我们发现，过去的框架和项目结构设计，导致代码变更成本逐渐升高，而没有进行合理的抽象，导致更难进行模块的测试，也更难对第三方基础库进行适配和迁移，这在一定程度上拉低了生产力。&lt;/p&gt;
&lt;p&gt;因此，我们参考了大量的DDD和Clean Architecture等业界先进设计理念，重新设计了微服务的项目结构，并且这个结构随着我们的后续研究，会进一步进行迭代，让它成为微服务项目结构的最佳实践。&lt;/p&gt;
&lt;p&gt;没错，新版本的是从kratos-layout开始的。也许刚接触这个项目结构时会觉得不适应，但随着项目迭代，代码复杂度的提高，这个定义良好的结构，将使项目保持优秀的代码可读性、可测试性，以及令人满意的开发效率和可维护性。&lt;/p&gt;
&lt;p&gt;更重要的一点是，这一次我们想面向社区来设计和开发这个框架。让更多的开发者能够使用我们的框架来提高生产力，同时参与到我们的项目中来。&lt;/p&gt;
&lt;p&gt;所以我们把整个框架设计成为一个插座，我们希望整个框架轻量，插件化，可定制。对于几乎每一个微服务相关的功能模块，我们都设计了标准化接口，对于第三方库设计为插件，这样就能迅速把任意基础设施集成到使用Kratos的项目里，因此，无论您的公司使用何种基础设施，有何种规范，您都可以轻松将Kratos定制成与您的开发、生产环境相匹配的样子。&lt;/p&gt;
&lt;p&gt;不破不立，v2是一次从内到外的彻底革新，我们无法在旧版本上修修补补，而是选择重新设计和开发新版本。而目前v2版本也已经在很多生产环境使用，我们也将持续迭代和完善这个框架，同时也更欢迎各位开发者参与进来，一起让它变得更好。&lt;/p&gt;
&lt;h2 id="数据库缓存消息队列"&gt;数据库/缓存/消息队列/&amp;hellip;&lt;/h2&gt;
&lt;p&gt;正如前文提到的，Kratos框架不限制您使用任何第三方库来进行项目开发，因此您可以根据喜好来选择库进行集成。我们也会逐步针对更多被广泛使用的第三方库开发插件。&lt;/p&gt;
&lt;p&gt;这里给出一些被广泛使用的库供参考：&lt;/p&gt;
&lt;p&gt;数据库：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="https://pkg.go.dev/database/sql"&gt;database/sql&lt;/a&gt; 官方库&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/go-gorm/gorm"&gt;gorm&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/ent/ent"&gt;ent&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;缓存：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="https://github.com/go-redis/redis"&gt;go-redis&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/gomodule/redigo"&gt;redigo&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/bradfitz/gomemcache"&gt;gomemcache&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;消息队列：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="https://github.com/Shopify/sarama"&gt;sarama&lt;/a&gt; kafka客户端&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/segmentio/kafka-go"&gt;kafka-go&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;其它更多的优秀go库，可以在&lt;a href="https://github.com/avelino/awesome-go"&gt;awesome-go&lt;/a&gt;这个仓库中找找。&lt;/p&gt;
&lt;h2 id="cli工具"&gt;CLI工具&lt;/h2&gt;
&lt;p&gt;kratos命令目前主要用于从模板创建项目，维护依赖包版本等。具体请参考&lt;a href="https://go-kratos.dev/docs/getting-started/usage"&gt;文档&lt;/a&gt;&lt;/p&gt;
&lt;h2 id="protobuf定义api"&gt;Protobuf定义API&lt;/h2&gt;
&lt;p&gt;Kratos使用Protobuf进行API定义。Protobuf是由Google开发的一种语言中立的数据序列化协议。它有结构定义清晰、可扩展性好、体积小、性能优秀等特点，在众多公司和项目被广泛使用。&lt;/p&gt;
&lt;p&gt;在使用Kratos的项目中，您将使用如下的IDL进行您的接口定义，并且通过&lt;code&gt;protoc&lt;/code&gt;工具生成相应的&lt;code&gt;.pb.go&lt;/code&gt;文件，其中包含根据定义生成的的服务端和客户端代码。随后您就可以在自己的项目内部注册服务端代码使用，或引用客户端代码进行远程调用。&lt;/p&gt;
&lt;p&gt;Kratos默认仅生成gRPC接口的代码，如果需要生成HTTP代码，请在proto文件中使用&lt;code&gt;option (google.api.http)&lt;/code&gt;来添加HTTP部分的定义后再进行生成。默认情况下，HTTP接口将使用JSON作为序列化格式，如果想使用其它序列化格式（form，XML等），请参考文档&lt;a href="https://go-kratos.dev/docs/component/encoding"&gt;序列化&lt;/a&gt;进行相应的配置即可。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-protobuf" data-lang="protobuf"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;syntax&lt;/span&gt; &lt;span style="color:#f92672"&gt;=&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;proto3&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;;&lt;/span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt;&lt;span style="color:#f92672"&gt;package&lt;/span&gt; &lt;span style="color:#111"&gt;helloworld&lt;/span&gt;&lt;span style="color:#f92672"&gt;.&lt;/span&gt;&lt;span style="color:#111"&gt;v1&lt;/span&gt;&lt;span style="color:#111"&gt;;&lt;/span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;import&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;google/api/annotations.proto&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;;&lt;/span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;option&lt;/span&gt; &lt;span style="color:#111"&gt;go_package&lt;/span&gt; &lt;span style="color:#f92672"&gt;=&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;github.com/go-kratos/kratos-layout/api/helloworld/v1;v1&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;;&lt;/span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt;&lt;span style="color:#75715e"&gt;// The greeting service definition.
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;service&lt;/span&gt; &lt;span style="color:#111"&gt;Greeter&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt; &lt;span style="color:#75715e"&gt;// Sends a greeting
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;rpc&lt;/span&gt; &lt;span style="color:#111"&gt;SayHello&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#111"&gt;HelloRequest&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;returns&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#111"&gt;HelloReply&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;option&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#111"&gt;google.api.http&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#f92672"&gt;=&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt; &lt;span style="color:#111"&gt;get&lt;/span&gt;&lt;span style="color:#f92672"&gt;:&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;/helloworld/{name}&amp;#34;&lt;/span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt; &lt;span style="color:#111"&gt;};&lt;/span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt;&lt;span style="color:#75715e"&gt;// The request message containing the user&amp;#39;s name.
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;message&lt;/span&gt; &lt;span style="color:#75af00"&gt;HelloRequest&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;string&lt;/span&gt; &lt;span style="color:#111"&gt;name&lt;/span&gt; &lt;span style="color:#f92672"&gt;=&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;1&lt;/span&gt;&lt;span style="color:#111"&gt;;&lt;/span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt;&lt;span style="color:#75715e"&gt;// The response message containing the greetings
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;message&lt;/span&gt; &lt;span style="color:#75af00"&gt;HelloReply&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;string&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;message&lt;/span&gt; &lt;span style="color:#f92672"&gt;=&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;1&lt;/span&gt;&lt;span style="color:#111"&gt;;&lt;/span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;需要注意，虽然Protobuf定义的API的可靠性更强，但字段结构灵活性相对JSON要弱一些，因此如果您有诸如文件上传接口，或者某些无法对应到proto的JSON结构需要使用，我门还提供了“逃生门”，在我们的Protobuf体系之外定义这些接口，实现为普通的http.Handler并且挂载到路由上，或者用struct来定义您的字段。可以参考我们的&lt;a href="https://github.com/go-kratos/kratos/blob/main/examples/http/upload/main.go"&gt;upload例子&lt;/a&gt;进行实现。&lt;/p&gt;</description><content:encoded><![CDATA[<p>您好，地球人，欢迎来到Kratos漫游指南。</p>
<p>对于刚开始研究Kratos框架的开发者来说，目前的文档有些零散，这与我们的模块化设计有一些关系，不过Don&rsquo;t panic，从这篇文章开始，我将试图打破这一现状，漫游指南系列将循序渐进地介绍Kratos框架，理顺框架的使用思路，使您更快上手Kratos。</p>
<p>同时，这个系列也会逐步整合进官方文档中，同时重新组织整个文档的结构和内容，敬请期待。</p>
<p>本篇是该系列的第一篇，主要介绍Kratos的整体概况。</p>
<h2 id="设计哲学">设计哲学</h2>
<p>Kratos是一个Go语言实现的微服务框架，说得更准确一点，它更类似于一个使用Go构建微服务的工具箱，开发者可以按照自己的习惯选用或定制其中的的组件，来打造自己的微服务。也正是由于这样的原因，Kratos并不绑定于特定的基础设施，不限定于某种注册中心，或数据库ORM等，所以您可以十分轻松地将任意库集成进项目里，与Kratos共同运作。</p>
<p>围绕这样的核心设计理念，我们设计了如下的项目生态：</p>
<ul>
<li><a href="https://github.com/go-kratos/kratos">kratos</a> Kratos框架核心，主要包含了基础的CLI工具，内置的HTTP/gRPC接口生成和服务生命周期管理，提供链路追踪、配置文件、日志、服务发现、监控等组件能力和相关接口定义。</li>
<li><a href="https://github.com/go-kratos/kratos/tree/main/contrib">contrib</a> 基于上述核心定义的基础接口，对配置文件、日志、服务发现、监控等服务进行具体实现所形成的一系列插件，可以直接使用它们，也可以参考它们的代码，做您需要的服务的适配，从而集成进kratos项目中来。</li>
<li><a href="https://github.com/go-kratos/aegis">aegis</a> 我们将服务可用性相关的算法：如限流、熔断等算法放在了这个独立的项目里，几乎没有外部依赖，它更不依赖Kratos，您可以在直接在任意项目中使用。您也可以轻松将它集成到Kratos中使用，提高服务的可用性。</li>
<li><a href="https://github.com/go-kratos/kratos-layout">layout</a> 我们设计的一个默认的项目模板，它包含一个参考了DDD和简洁架构设计的项目结构、Makefile脚本和Dockerfile文件。但这个项目模板不是必需的，您可以任意修改它，或使用自己设计的项目结构，Kratos依然可以正常工作。框架本身不对项目结构做任何假设和限制，您可以按照自己的想法来使用，具有很强的可定制性。</li>
<li><a href="https://github.com/go-kratos/gateway">gateway</a> 这个是我们刚刚起步，用Go开发的API Gateway，后续您可以使用它来作为您Kratos微服务的网关，用于微服务API的治理，项目正在施工中，欢迎关注。</li>
</ul>
<h2 id="仓库文档和社区">仓库、文档和社区</h2>
<p>GitHub仓库：<a href="https://github.com/go-kratos">https://github.com/go-kratos</a>
文档：<a href="https://go-kratos.dev/">https://go-kratos.dev/</a>
微信群：<a href="https://github.com/go-kratos/kratos/issues/682">go-kratos 官方微信群</a>
Discord：<a href="https://discord.com/invite/BWzJsUJ">go-kratos</a></p>
<h2 id="为什么v2完全重新设计">为什么v2完全重新设计</h2>
<p>以前关注过kratos项目的可能知道，Kratos的<a href="https://github.com/go-kratos/kratos/tree/v1.0.x">v1</a>版本已经开源了很久，也是个较为完善的框架。那么为什么不直接基于v1继续迭代，而是要推倒重来，推出完全重新设计的v2呢？</p>
<p>经验源自踩坑。</p>
<p>在业务不断迭代、项目不断膨胀的情况下，我们发现，过去的框架和项目结构设计，导致代码变更成本逐渐升高，而没有进行合理的抽象，导致更难进行模块的测试，也更难对第三方基础库进行适配和迁移，这在一定程度上拉低了生产力。</p>
<p>因此，我们参考了大量的DDD和Clean Architecture等业界先进设计理念，重新设计了微服务的项目结构，并且这个结构随着我们的后续研究，会进一步进行迭代，让它成为微服务项目结构的最佳实践。</p>
<p>没错，新版本的是从kratos-layout开始的。也许刚接触这个项目结构时会觉得不适应，但随着项目迭代，代码复杂度的提高，这个定义良好的结构，将使项目保持优秀的代码可读性、可测试性，以及令人满意的开发效率和可维护性。</p>
<p>更重要的一点是，这一次我们想面向社区来设计和开发这个框架。让更多的开发者能够使用我们的框架来提高生产力，同时参与到我们的项目中来。</p>
<p>所以我们把整个框架设计成为一个插座，我们希望整个框架轻量，插件化，可定制。对于几乎每一个微服务相关的功能模块，我们都设计了标准化接口，对于第三方库设计为插件，这样就能迅速把任意基础设施集成到使用Kratos的项目里，因此，无论您的公司使用何种基础设施，有何种规范，您都可以轻松将Kratos定制成与您的开发、生产环境相匹配的样子。</p>
<p>不破不立，v2是一次从内到外的彻底革新，我们无法在旧版本上修修补补，而是选择重新设计和开发新版本。而目前v2版本也已经在很多生产环境使用，我们也将持续迭代和完善这个框架，同时也更欢迎各位开发者参与进来，一起让它变得更好。</p>
<h2 id="数据库缓存消息队列">数据库/缓存/消息队列/&hellip;</h2>
<p>正如前文提到的，Kratos框架不限制您使用任何第三方库来进行项目开发，因此您可以根据喜好来选择库进行集成。我们也会逐步针对更多被广泛使用的第三方库开发插件。</p>
<p>这里给出一些被广泛使用的库供参考：</p>
<p>数据库：</p>
<ul>
<li><a href="https://pkg.go.dev/database/sql">database/sql</a> 官方库</li>
<li><a href="https://github.com/go-gorm/gorm">gorm</a></li>
<li><a href="https://github.com/ent/ent">ent</a></li>
</ul>
<p>缓存：</p>
<ul>
<li><a href="https://github.com/go-redis/redis">go-redis</a></li>
<li><a href="https://github.com/gomodule/redigo">redigo</a></li>
<li><a href="https://github.com/bradfitz/gomemcache">gomemcache</a></li>
</ul>
<p>消息队列：</p>
<ul>
<li><a href="https://github.com/Shopify/sarama">sarama</a> kafka客户端</li>
<li><a href="https://github.com/segmentio/kafka-go">kafka-go</a></li>
</ul>
<p>其它更多的优秀go库，可以在<a href="https://github.com/avelino/awesome-go">awesome-go</a>这个仓库中找找。</p>
<h2 id="cli工具">CLI工具</h2>
<p>kratos命令目前主要用于从模板创建项目，维护依赖包版本等。具体请参考<a href="https://go-kratos.dev/docs/getting-started/usage">文档</a></p>
<h2 id="protobuf定义api">Protobuf定义API</h2>
<p>Kratos使用Protobuf进行API定义。Protobuf是由Google开发的一种语言中立的数据序列化协议。它有结构定义清晰、可扩展性好、体积小、性能优秀等特点，在众多公司和项目被广泛使用。</p>
<p>在使用Kratos的项目中，您将使用如下的IDL进行您的接口定义，并且通过<code>protoc</code>工具生成相应的<code>.pb.go</code>文件，其中包含根据定义生成的的服务端和客户端代码。随后您就可以在自己的项目内部注册服务端代码使用，或引用客户端代码进行远程调用。</p>
<p>Kratos默认仅生成gRPC接口的代码，如果需要生成HTTP代码，请在proto文件中使用<code>option (google.api.http)</code>来添加HTTP部分的定义后再进行生成。默认情况下，HTTP接口将使用JSON作为序列化格式，如果想使用其它序列化格式（form，XML等），请参考文档<a href="https://go-kratos.dev/docs/component/encoding">序列化</a>进行相应的配置即可。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-protobuf" data-lang="protobuf"><span style="display:flex;"><span><span style="color:#111">syntax</span> <span style="color:#f92672">=</span> <span style="color:#d88200">&#34;proto3&#34;</span><span style="color:#111">;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#f92672">package</span> <span style="color:#111">helloworld</span><span style="color:#f92672">.</span><span style="color:#111">v1</span><span style="color:#111">;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#00a8c8">import</span> <span style="color:#d88200">&#34;google/api/annotations.proto&#34;</span><span style="color:#111">;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#00a8c8">option</span> <span style="color:#111">go_package</span> <span style="color:#f92672">=</span> <span style="color:#d88200">&#34;github.com/go-kratos/kratos-layout/api/helloworld/v1;v1&#34;</span><span style="color:#111">;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e">// The greeting service definition.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#00a8c8">service</span> <span style="color:#111">Greeter</span> <span style="color:#111">{</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#75715e">// Sends a greeting
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#00a8c8">rpc</span> <span style="color:#111">SayHello</span> <span style="color:#111">(</span><span style="color:#111">HelloRequest</span><span style="color:#111">)</span> <span style="color:#00a8c8">returns</span> <span style="color:#111">(</span><span style="color:#111">HelloReply</span><span style="color:#111">)</span>  <span style="color:#111">{</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>        <span style="color:#00a8c8">option</span> <span style="color:#111">(</span><span style="color:#111">google.api.http</span><span style="color:#111">)</span> <span style="color:#f92672">=</span> <span style="color:#111">{</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>            <span style="color:#111">get</span><span style="color:#f92672">:</span> <span style="color:#d88200">&#34;/helloworld/{name}&#34;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>        <span style="color:#111">};</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    <span style="color:#111">}</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#111">}</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e">// The request message containing the user&#39;s name.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#00a8c8">message</span> <span style="color:#75af00">HelloRequest</span> <span style="color:#111">{</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#00a8c8">string</span> <span style="color:#111">name</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span><span style="color:#111">;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#111">}</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e">// The response message containing the greetings
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#00a8c8">message</span> <span style="color:#75af00">HelloReply</span> <span style="color:#111">{</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#00a8c8">string</span> <span style="color:#00a8c8">message</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span><span style="color:#111">;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#111">}</span><span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>需要注意，虽然Protobuf定义的API的可靠性更强，但字段结构灵活性相对JSON要弱一些，因此如果您有诸如文件上传接口，或者某些无法对应到proto的JSON结构需要使用，我门还提供了“逃生门”，在我们的Protobuf体系之外定义这些接口，实现为普通的http.Handler并且挂载到路由上，或者用struct来定义您的字段。可以参考我们的<a href="https://github.com/go-kratos/kratos/blob/main/examples/http/upload/main.go">upload例子</a>进行实现。</p>
<h2 id="元信息传递">元信息传递</h2>
<p>服务之间的API调用，如果有某些元信息需要传递过去，而不是写在payload消息中，可以使用Metadata包进行字段设置和提取，具体细节参考<a href="https://go-kratos.dev/docs/component/metadata">元信息传递文档</a></p>
<h2 id="错误处理">错误处理</h2>
<p>Kratos的<a href="https://github.com/go-kratos/kratos/tree/main/errors">errors</a>模块提供了error的封装。框架也预定义了一系列<a href="https://github.com/go-kratos/kratos/blob/main/errors/types.go">标准错误</a>供使用。</p>
<p>错误处理这一块的设计也经过了很久的讨论才定下来，主要设计理念如下：</p>
<ol>
<li><code>code</code> 语义近似HTTP的Status Code（例如客户端传参数错误用400）同时也作为大类错误，在HTTP接口中的HTTP Code会使用它，好处是网关层可以根据这个code触发相应策略（重试、限流、熔断等）。</li>
<li><code>reason</code> 业务的具体错误码，为可读的字符串，能够表明，在同一个服务中应该唯一。</li>
<li><code>message</code> 用户可读的信息，可以在客户端（App、浏览器等）进行相应的展示给用户看。</li>
<li><code>metadata</code> 为一些附加信息，可以作为补充信息使用。</li>
</ol>
<p>在API返回的错误信息中，以HTTP接口为例，消息结构大概是长这个样子的：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 错误码，跟 http-status 一致，并且在 grpc 中可以转换成 grpc-status
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">&#34;code&#34;</span><span style="color:#111">:</span> <span style="color:#ae81ff">500</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 错误原因，定义为业务判定错误码
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">&#34;reason&#34;</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;USER_NOT_FOUND&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 错误信息，为用户可读的信息，可作为用户提示内容
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">&#34;message&#34;</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;invalid argument error&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 错误元信息，为错误添加附加可扩展信息
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">&#34;metadata&#34;</span><span style="color:#111">:</span> <span style="color:#111">{</span><span style="color:#f92672">&#34;some-key&#34;</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;some-value&#34;</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>在Kratos中您可以使用proto文件定义您的业务错误，并通过工具生成对应的处理逻辑和方法。（如使用layout中提供的<code>make errors</code>指令。）</p>
<p>错误定义：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-protobuf" data-lang="protobuf"><span style="display:flex;"><span><span style="color:#111">syntax</span> <span style="color:#f92672">=</span> <span style="color:#d88200">&#34;proto3&#34;</span><span style="color:#111">;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#f92672">package</span> <span style="color:#111">api</span><span style="color:#f92672">.</span><span style="color:#111">blog.v1</span><span style="color:#111">;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#00a8c8">import</span> <span style="color:#d88200">&#34;errors/errors.proto&#34;</span><span style="color:#111">;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#00a8c8">option</span> <span style="color:#111">go_package</span> <span style="color:#f92672">=</span> <span style="color:#d88200">&#34;github.com/go-kratos/kratos/examples/blog/api/v1;v1&#34;</span><span style="color:#111">;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#00a8c8">enum</span> <span style="color:#111">ErrorReason</span> <span style="color:#111">{</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#75715e">// 设置缺省错误码
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#00a8c8">option</span> <span style="color:#111">(</span><span style="color:#111">errors.default_code</span><span style="color:#111">)</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">500</span><span style="color:#111">;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#75715e">// 为某个枚举单独设置错误码
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#111">USER_NOT_FOUND</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span> <span style="color:#111">[(</span><span style="color:#111">errors.code</span><span style="color:#111">)</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">404</span><span style="color:#111">];</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#111">CONTENT_MISSING</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span> <span style="color:#111">[(</span><span style="color:#111">errors.code</span><span style="color:#111">)</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">400</span><span style="color:#111">];;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#111">}</span><span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>错误创建：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// 通过 errors.New() 响应错误</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">errors</span><span style="color:#111">.</span><span style="color:#75af00">New</span><span style="color:#111">(</span><span style="color:#ae81ff">500</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;USER_NAME_EMPTY&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;user name is empty&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 通过 proto 生成的代码响应错误，并且包名应替换为自己生成代码后的 package name</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">api</span><span style="color:#111">.</span><span style="color:#75af00">ErrorUserNotFound</span><span style="color:#111">(</span><span style="color:#d88200">&#34;user %s not found&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;kratos&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 传递metadata</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">errors</span><span style="color:#111">.</span><span style="color:#75af00">New</span><span style="color:#111">(</span><span style="color:#ae81ff">500</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;USER_NAME_EMPTY&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;user name is empty&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">err</span><span style="color:#111">.</span><span style="color:#75af00">WithMetadata</span><span style="color:#111">(</span><span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#00a8c8">string</span><span style="color:#111">]</span><span style="color:#00a8c8">string</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d88200">&#34;foo&#34;</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;bar&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span><span style="color:#111">})</span>
</span></span></code></pre></div><p>错误断言：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">wrong</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 通过 errors.Is() 断言</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#75af00">errors</span><span style="color:#111">.</span><span style="color:#75af00">Is</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span><span style="color:#75af00">errors</span><span style="color:#111">.</span><span style="color:#75af00">BadRequest</span><span style="color:#111">(</span><span style="color:#d88200">&#34;USER_NAME_EMPTY&#34;</span><span style="color:#111">,</span><span style="color:#d88200">&#34;&#34;</span><span style="color:#111">))</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// do something</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 通过判断 *Error.Reason 和 *Error.Code</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">e</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">errors</span><span style="color:#111">.</span><span style="color:#75af00">FromError</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">if</span>  <span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">Reason</span> <span style="color:#f92672">==</span> <span style="color:#d88200">&#34;USER_NAME_EMPTY&#34;</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">Code</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">500</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// do something</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 通过 proto 生成的代码断言错误，并且包名应替换为自己生成代码后的 package name</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#75af00">api</span><span style="color:#111">.</span><span style="color:#75af00">IsUserNotFound</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// do something</span>
</span></span><span style="display:flex;"><span><span style="color:#111">})</span>
</span></span></code></pre></div><h2 id="配置文件">配置文件</h2>
<p>Kratos提供了统一的接口，支持配置文件的加载和变更订阅。</p>
<p>通过实现<a href="https://github.com/go-kratos/kratos/blob/main/config/source.go">Source 和 Watcher</a>即可实现任意配置源（本地或远程）的配置文件加载和变更订阅。</p>
<p>已经实现了下列插件：</p>
<ul>
<li><a href="https://github.com/go-kratos/kratos/blob/main/config/file/file.go">file</a> 本地文件加载，Kratos内置</li>
<li><a href="https://github.com/go-kratos/kratos/tree/main/contrib/config/apollo">apollo</a></li>
<li><a href="https://github.com/go-kratos/kratos/tree/main/contrib/config/etcd">etcd</a></li>
<li><a href="https://github.com/go-kratos/kratos/tree/main/contrib/config/kubernetes">kubernetes</a></li>
<li><a href="https://github.com/go-kratos/kratos/tree/main/contrib/config/nacos">nacos</a></li>
</ul>
<h2 id="服务注册服务发现">服务注册&amp;服务发现</h2>
<p>Kratos定义了统一的注册接口，通过实现<a href="https://github.com/go-kratos/kratos/blob/main/registry/registry.go">Registrar和Discovery</a>，您可以很轻松地将Kratos接入到您的注册中心中。</p>
<p>您也可以直接使用我们已经实现好的插件：</p>
<ul>
<li><a href="https://github.com/go-kratos/kratos/tree/main/contrib/registry/consul">consul</a></li>
<li><a href="https://github.com/go-kratos/kratos/tree/main/contrib/registry/discovery">discovery</a></li>
<li><a href="https://github.com/go-kratos/kratos/tree/main/contrib/registry/etcd">etcd</a></li>
<li><a href="https://github.com/go-kratos/kratos/tree/main/contrib/registry/kubernetes">kubernetes</a></li>
<li><a href="https://github.com/go-kratos/kratos/tree/main/contrib/registry/nacos">nacos</a></li>
<li><a href="https://github.com/go-kratos/kratos/tree/main/contrib/registry/zookeeper">zookeeper</a></li>
</ul>
<h2 id="日志">日志</h2>
<p>Kratos的日志模块由两部分组成：</p>
<ol>
<li><a href="https://github.com/go-kratos/kratos/blob/main/log/log.go">Logger</a>：底层日志接口，用于快速适配各种日志库到框架中来，仅提供一个最简单的Log方法。</li>
<li><a href="https://github.com/go-kratos/kratos/blob/main/log/helper.go">Helper</a>：高级日志接口，提供了一系列带有日志等级和格式化方法的帮助函数，通常业务逻辑中建议使用这个，能够简化日志代码。</li>
</ol>
<p>我们已经实现好的插件用于适配目前一些日志库，您也可以参考它们的代码来实现自己需要的日志库的适配：</p>
<ul>
<li><a href="https://github.com/go-kratos/kratos/blob/main/log/std.go">std</a> 标准输出，Kratos内置</li>
<li><a href="https://github.com/go-kratos/kratos/tree/main/contrib/log/fluent">fluent</a></li>
<li><a href="https://github.com/go-kratos/kratos/tree/main/contrib/log/zap">zap</a></li>
</ul>
<h2 id="监控">监控</h2>
<p>监控告警方面，您可以通过实现<a href="https://github.com/go-kratos/kratos/blob/main/metrics/metrics.go">metrics相关接口</a>将服务的统计数据上报给监控平台。</p>
<p>也可以直接使用我们已经实现好的插件：</p>
<ul>
<li><a href="https://github.com/go-kratos/kratos/tree/main/contrib/metrics/datadog">datadog</a></li>
<li><a href="https://github.com/go-kratos/kratos/tree/main/contrib/metrics/prometheus">prometheus</a></li>
</ul>
<h2 id="链路追踪">链路追踪</h2>
<p>Kratos使用<a href="https://opentelemetry.io/">OpenTelemetry</a>作为分布式链路追踪所使用的标准，您可以通过对client和server<a href="https://go-kratos.dev/docs/component/middleware/tracing">配置tracing</a>来将服务接入到链路追踪平台（如<a href="https://www.jaegertracing.io/">jaeger</a>等），从而对服务的接口调用关系，耗时，错误等进行追踪。</p>
<h2 id="负载均衡">负载均衡</h2>
<p>Kratos内置了若干种<a href="https://github.com/go-kratos/kratos/tree/main/selector">负载均衡算法</a>，如Weighted round robin（默认）、P2C，Random等，您可以通过<a href="https://go-kratos.dev/docs/component/selector">在client初始化时配置</a>来使用他们。</p>
<h2 id="限流熔断">限流熔断</h2>
<p>Kratos提供了<a href="https://go-kratos.dev/docs/component/middleware/ratelimit">限流ratelimit</a>和<a href="https://go-kratos.dev/docs/component/middleware/circuitbreaker">熔断circuitbreaker</a>中间件，用于微服务出现异常故障时自动对流量进行限制，提升服务的健壮性，避免雪崩。这两个中间件使用的算法，也可以在我们的可用性算法仓库<a href="https://github.com/go-kratos/aegis">aegis</a>中找到，独立于Kratos直接使用。</p>
<h2 id="中间件">中间件</h2>
<p>您可以通过Kratos的middleware机制，统一微服务接口的某些共同逻辑。上面提到的功能插件，您可以通过实现<a href="https://github.com/go-kratos/kratos/blob/main/middleware/middleware.go">Middleware</a>编写Kratos能够使用的中间件。</p>
<p>同时在仓库的<a href="https://github.com/go-kratos/kratos/tree/main/middleware">middleware</a>目录下，我们也提供了一系列中间件供您使用。</p>
<h2 id="插件">插件</h2>
<p>除了上述提到的插件外，我们还提供了一些其它插件，完整的插件列表请参考文档<a href="https://go-kratos.dev/docs/getting-started/plugin">社区插件</a></p>
<h2 id="示例代码">示例代码</h2>
<p>如果您看过文档后，对某些功能的使用仍有疑惑，或者是希望寻找一些用Kratos写项目的灵感，在仓库的<a href="https://github.com/go-kratos/kratos/tree/main/examples">examples</a>目录下我们提供了很多代码供参考。</p>
<p>您也可以通过文档中的<a href="https://go-kratos.dev/docs/getting-started/examples">示例代码清单</a>页面来查阅有哪些示例。</p>
<h2 id="小结">小结</h2>
<p>使用Kratos在一般开发过程中用到大部分常用功能点，在本文已经做了简单介绍，相信您对本框架的情况已经有了大致的了解。限于篇幅原因，无法在一篇文章中涵盖到Kratos的全部细节，比如layout这个相对复杂的项目结构具体是怎么用的，我将在后续的文章中，继续对Kratos的框架设计思想和使用方法做更加详细的介绍，并且会结合具体的项目实例，介绍使用Kratos开发的完整流程。</p>
<h2 id="文章转自">文章转自</h2>
<ul>
<li><a href="https://farer.org/2021/10/20/the-hitchhikers-guide-to-kratos-1-overview/">https://farer.org/2021/10/20/the-hitchhikers-guide-to-kratos-1-overview/</a></li>
</ul>
<hr>
<p><img src="/images/9c138291-3015-4b02-a15c-1457371297ab.png" alt=""></p>
<p><img src="/images/5e3a3a58-380d-4e6c-9e22-c0a0e245d98a.gif" alt=""></p>
]]></content:encoded><category>kratos</category><category>go</category><category>kratos</category></item><item><title>基于 OpenTelemetry 的链路追踪</title><link>https://daemon365.dev/post/kratos/link_tracing_based_on_opentelemetry/</link><pubDate>Mon, 23 Aug 2021 18:11:50 +0800</pubDate><guid>https://daemon365.dev/post/kratos/link_tracing_based_on_opentelemetry/</guid><description>&lt;h2 id="链路追踪的前世今生"&gt;链路追踪的前世今生&lt;/h2&gt;
&lt;blockquote&gt;
&lt;p&gt;分布式跟踪（也称为分布式请求跟踪）是一种用于分析和监控应用程序的方法，尤其是使用微服务架构构建的应用程序。分布式跟踪有助于精确定位故障发生的位置以及导致性能差的原因。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id="起源"&gt;起源&lt;/h3&gt;
&lt;p&gt;链路追踪(Distributed Tracing)　一词最早出现于谷歌发布的论文 &lt;strong&gt;《Dapper, a Large-Scale Distributed Systems Tracing Infrastructure》&lt;/strong&gt; 中,这篇论文对于实现链路追踪,对于后来出现的 Jaeger、Zipkin 等开源分布式追踪项目设计理念仍有很深的影响。&lt;/p&gt;
&lt;p&gt;微服务架构是一个分布式的架构,会有很多个不同的服务。不同的服务之前相互调用,如果出现了错误由于一个请求经过了 N 个服务。随着业务的增加越来越多的服务之间的调用，如果没有一个工具去记录调用链，解决问题的时候就会像下面图片里小猫咪玩的毛线球一样，毫无头绪，无从下手&lt;/p&gt;
&lt;p&gt;&lt;img src="https://daemon365.dev/images/26c28252-3065-4999-8d40-41a67e678b53.png" alt=""&gt;&lt;/p&gt;
&lt;p&gt;所以需要有一个工具能够清楚的了解一个请求经过了哪些服务,顺序是如何,从而能够轻易的定位问题。&lt;/p&gt;
&lt;p&gt;&lt;img src="https://daemon365.dev/images/a4b9b782-7d21-4857-a59f-7b2b5b27b5a6.png" alt=""&gt;&lt;/p&gt;
&lt;h3 id="百家争艳"&gt;百家争艳&lt;/h3&gt;
&lt;p&gt;从谷歌发布 &lt;strong&gt;Dapper&lt;/strong&gt; 后，分布式链路追踪工具越来越多，以下简单列举了一些常用的链路追踪系统&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Skywalking&lt;/li&gt;
&lt;li&gt;阿里 鹰眼&lt;/li&gt;
&lt;li&gt;大众点评 CAT&lt;/li&gt;
&lt;li&gt;Twitter Zipkin&lt;/li&gt;
&lt;li&gt;Naver pinpoint&lt;/li&gt;
&lt;li&gt;Uber Jaeger&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id="争锋相对"&gt;争锋相对？&lt;/h3&gt;
&lt;p&gt;随着链路追踪工具越来越多，开源领域主要分为两派，一派是以 &lt;strong&gt;CNCF技术委员&lt;/strong&gt; 会为主的 &lt;strong&gt;OpenTracing&lt;/strong&gt; 的规范，例如 jaeger zipkin 都是遵循了&lt;strong&gt;OpenTracing&lt;/strong&gt; 的规范。而另一派则是谷歌作为发起者的 &lt;strong&gt;OpenCensus&lt;/strong&gt;，而且谷歌本身还是最早提出链路追踪概念的公司，后期连微软也加入了 &lt;strong&gt;OpenCensus&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src="https://daemon365.dev/images/9d8532dc-9595-4754-80b3-11d9963c2fca.png" alt=""&gt;&lt;/p&gt;
&lt;h3 id="opentelemetry-诞生"&gt;OpenTelemetry 诞生&lt;/h3&gt;
&lt;blockquote&gt;
&lt;p&gt;OpenTelemetric 是一组 API、SDK、模组和集成，专为创建和管理‎‎遥测数据‎‎（如追踪、指标和日志）而设&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;微软加入 &lt;strong&gt;OpenCensus&lt;/strong&gt; 后，直接打破了之前平衡的局面，间接的导致了 &lt;strong&gt;OpenTelemetry&lt;/strong&gt; 的诞生
谷歌和微软下定决心结束江湖之乱，首要的问题是如何整合两个两个社区已有的项目，OpenTelemetry 主要的理念就是，兼容 &lt;strong&gt;OpenCensus&lt;/strong&gt; 和 &lt;strong&gt;OpenTracing&lt;/strong&gt; ，可以让使用者无需改动或者很小的改动就可以接入 &lt;strong&gt;OpenTelemetry&lt;/strong&gt;&lt;/p&gt;
&lt;h2 id="kratos-的链路追踪实践"&gt;Kratos 的链路追踪实践&lt;/h2&gt;
&lt;blockquote&gt;
&lt;p&gt;Kratos 一套轻量级 Go 微服务框架，包含大量微服务相关框架及工具。&lt;/p&gt;</description><content:encoded><![CDATA[<h2 id="链路追踪的前世今生">链路追踪的前世今生</h2>
<blockquote>
<p>分布式跟踪（也称为分布式请求跟踪）是一种用于分析和监控应用程序的方法，尤其是使用微服务架构构建的应用程序。分布式跟踪有助于精确定位故障发生的位置以及导致性能差的原因。</p>
</blockquote>
<h3 id="起源">起源</h3>
<p>链路追踪(Distributed Tracing)　一词最早出现于谷歌发布的论文 <strong>《Dapper, a Large-Scale Distributed Systems Tracing Infrastructure》</strong> 中,这篇论文对于实现链路追踪,对于后来出现的 Jaeger、Zipkin 等开源分布式追踪项目设计理念仍有很深的影响。</p>
<p>微服务架构是一个分布式的架构,会有很多个不同的服务。不同的服务之前相互调用,如果出现了错误由于一个请求经过了 N 个服务。随着业务的增加越来越多的服务之间的调用，如果没有一个工具去记录调用链，解决问题的时候就会像下面图片里小猫咪玩的毛线球一样，毫无头绪，无从下手</p>
<p><img src="/images/26c28252-3065-4999-8d40-41a67e678b53.png" alt=""></p>
<p>所以需要有一个工具能够清楚的了解一个请求经过了哪些服务,顺序是如何,从而能够轻易的定位问题。</p>
<p><img src="/images/a4b9b782-7d21-4857-a59f-7b2b5b27b5a6.png" alt=""></p>
<h3 id="百家争艳">百家争艳</h3>
<p>从谷歌发布 <strong>Dapper</strong> 后，分布式链路追踪工具越来越多，以下简单列举了一些常用的链路追踪系统</p>
<ul>
<li>Skywalking</li>
<li>阿里 鹰眼</li>
<li>大众点评 CAT</li>
<li>Twitter Zipkin</li>
<li>Naver pinpoint</li>
<li>Uber Jaeger</li>
</ul>
<h3 id="争锋相对">争锋相对？</h3>
<p>随着链路追踪工具越来越多，开源领域主要分为两派，一派是以 <strong>CNCF技术委员</strong> 会为主的  <strong>OpenTracing</strong> 的规范，例如 jaeger zipkin 都是遵循了<strong>OpenTracing</strong> 的规范。而另一派则是谷歌作为发起者的 <strong>OpenCensus</strong>，而且谷歌本身还是最早提出链路追踪概念的公司，后期连微软也加入了 <strong>OpenCensus</strong></p>
<p><img src="/images/9d8532dc-9595-4754-80b3-11d9963c2fca.png" alt=""></p>
<h3 id="opentelemetry-诞生">OpenTelemetry 诞生</h3>
<blockquote>
<p>OpenTelemetric 是一组 API、SDK、模组和集成，专为创建和管理‎‎遥测数据‎‎（如追踪、指标和日志）而设</p>
</blockquote>
<p>微软加入 <strong>OpenCensus</strong> 后，直接打破了之前平衡的局面，间接的导致了 <strong>OpenTelemetry</strong> 的诞生
谷歌和微软下定决心结束江湖之乱，首要的问题是如何整合两个两个社区已有的项目，OpenTelemetry 主要的理念就是，兼容 <strong>OpenCensus</strong> 和 <strong>OpenTracing</strong> ，可以让使用者无需改动或者很小的改动就可以接入 <strong>OpenTelemetry</strong></p>
<h2 id="kratos-的链路追踪实践">Kratos 的链路追踪实践</h2>
<blockquote>
<p>Kratos 一套轻量级 Go 微服务框架，包含大量微服务相关框架及工具。</p>
</blockquote>
<h3 id="tracing-中间件">tracing 中间件</h3>
<p>kratos 框架提供的自带中间件中有一个名为 <strong>tracing</strong> 中间件，它基于 <strong>Opentelemetry</strong> 实现了kratos 框架的链路追踪功能，中间件的代码可以从 <strong><a href="https://github.com/go-kratos/kratos/tree/main/middleware/tracing">middleware/tracing</a></strong> 中看到。</p>
<h4 id="实现原理">实现原理</h4>
<p>kratos 的链路追踪中间件由三个文件组成 <strong>carrie.go</strong>,<strong>tracer.go</strong>,<strong>tracing.go</strong>。client和 server 的实现原理基本相同，本文以 server 实现进行原理解析。</p>
<ol>
<li>首先当请求进入时，<strong>tracing</strong> 中间件会被调用,首先调用了 <strong>tracer.go</strong> 中的 <strong>NewTracer</strong> 方法</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// Server returns a new server middleware for OpenTelemetry.</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">Server</span><span style="color:#111">(</span><span style="color:#75af00">opts</span> <span style="color:#f92672">...</span><span style="color:#75af00">Option</span><span style="color:#111">)</span> <span style="color:#75af00">middleware</span><span style="color:#111">.</span><span style="color:#75af00">Middleware</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 调用 tracer.go 中的 NewTracer 传入了一个 SpanKindServer 和配置项</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">tracer</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">NewTracer</span><span style="color:#111">(</span><span style="color:#75af00">trace</span><span style="color:#111">.</span><span style="color:#75af00">SpanKindServer</span><span style="color:#111">,</span> <span style="color:#75af00">opts</span><span style="color:#f92672">...</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// ... 省略代码</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><ol start="2">
<li><strong>tracer.go</strong> 中的 <strong>NewTracer</strong> 方法被调用后会返回一个 <strong>Tracer</strong>,实现如下</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">NewTracer</span><span style="color:#111">(</span><span style="color:#75af00">kind</span> <span style="color:#75af00">trace</span><span style="color:#111">.</span><span style="color:#75af00">SpanKind</span><span style="color:#111">,</span> <span style="color:#75af00">opts</span> <span style="color:#f92672">...</span><span style="color:#75af00">Option</span><span style="color:#111">)</span> <span style="color:#f92672">*</span><span style="color:#75af00">Tracer</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">options</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">options</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">o</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">opts</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">o</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">options</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 判断是否存在 otel 追踪提供者配置，如果存在则设置</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">options</span><span style="color:#111">.</span><span style="color:#75af00">TracerProvider</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">otel</span><span style="color:#111">.</span><span style="color:#75af00">SetTracerProvider</span><span style="color:#111">(</span><span style="color:#75af00">options</span><span style="color:#111">.</span><span style="color:#75af00">TracerProvider</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	判断是否存在 Propagators 设置，如果存在设置则覆盖，不存在则设置一个默认的TextMapPropagator
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	注意如果没有设置默认的TextMapPropagator,链路信息则无法正确的传递
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	*/</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">options</span><span style="color:#111">.</span><span style="color:#75af00">Propagators</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">otel</span><span style="color:#111">.</span><span style="color:#75af00">SetTextMapPropagator</span><span style="color:#111">(</span><span style="color:#75af00">options</span><span style="color:#111">.</span><span style="color:#75af00">Propagators</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>	<span style="color:#75af00">otel</span><span style="color:#111">.</span><span style="color:#75af00">SetTextMapPropagator</span><span style="color:#111">(</span><span style="color:#75af00">propagation</span><span style="color:#111">.</span><span style="color:#75af00">NewCompositeTextMapPropagator</span><span style="color:#111">(</span><span style="color:#75af00">propagation</span><span style="color:#111">.</span><span style="color:#75af00">Baggage</span><span style="color:#111">{},</span> <span style="color:#75af00">propagation</span><span style="color:#111">.</span><span style="color:#75af00">TraceContext</span><span style="color:#111">{}))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">var</span> <span style="color:#75af00">name</span> <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 判断当前中间件的类型，是 server 还是 client</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">kind</span> <span style="color:#f92672">==</span> <span style="color:#75af00">trace</span><span style="color:#111">.</span><span style="color:#75af00">SpanKindServer</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">name</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;server&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#00a8c8">if</span> <span style="color:#75af00">kind</span> <span style="color:#f92672">==</span> <span style="color:#75af00">trace</span><span style="color:#111">.</span><span style="color:#75af00">SpanKindClient</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">name</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;client&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Sprintf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;unsupported span kind: %v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">kind</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 调用 otel包的 Tracer 方法 传入 name 用来创建一个 tracer 实例</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">tracer</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">otel</span><span style="color:#111">.</span><span style="color:#75af00">Tracer</span><span style="color:#111">(</span><span style="color:#75af00">name</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">Tracer</span><span style="color:#111">{</span><span style="color:#75af00">tracer</span><span style="color:#111">:</span> <span style="color:#75af00">tracer</span><span style="color:#111">,</span> <span style="color:#75af00">kind</span><span style="color:#111">:</span> <span style="color:#75af00">kind</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><ol start="3">
<li>判断当前请求类型，处理需要采集的数据，并调用 <strong>tracer.go</strong> 中的 <strong>Start</strong> 方法</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">var</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">component</span> <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">operation</span> <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">carrier</span>   <span style="color:#75af00">propagation</span><span style="color:#111">.</span><span style="color:#75af00">TextMapCarrier</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 判断请求类型</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#75af00">info</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">FromServerContext</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">);</span> <span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// HTTP</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">component</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;HTTP&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 取出请求的地址</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">operation</span> <span style="color:#111">=</span> <span style="color:#75af00">info</span><span style="color:#111">.</span><span style="color:#75af00">Request</span><span style="color:#111">.</span><span style="color:#75af00">RequestURI</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 调用 otel/propagation包中的 HeaderCarrier，会处理 http.Header 以用来满足TextMapCarrier interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// TextMapCarrier 是一个文本映射载体，用于承载信息</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">carrier</span> <span style="color:#111">=</span> <span style="color:#75af00">propagation</span><span style="color:#111">.</span><span style="color:#75af00">HeaderCarrier</span><span style="color:#111">(</span><span style="color:#75af00">info</span><span style="color:#111">.</span><span style="color:#75af00">Request</span><span style="color:#111">.</span><span style="color:#75af00">Header</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// otel.GetTextMapPropagator().Extract() 方法用于将文本映射载体，读取到上下文中</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ctx</span> <span style="color:#111">=</span> <span style="color:#75af00">otel</span><span style="color:#111">.</span><span style="color:#75af00">GetTextMapPropagator</span><span style="color:#111">().</span><span style="color:#75af00">Extract</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">propagation</span><span style="color:#111">.</span><span style="color:#75af00">HeaderCarrier</span><span style="color:#111">(</span><span style="color:#75af00">info</span><span style="color:#111">.</span><span style="color:#75af00">Request</span><span style="color:#111">.</span><span style="color:#75af00">Header</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#00a8c8">if</span> <span style="color:#75af00">info</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">grpc</span><span style="color:#111">.</span><span style="color:#75af00">FromServerContext</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">);</span> <span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Grpc</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">component</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;gRPC&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">operation</span> <span style="color:#111">=</span> <span style="color:#75af00">info</span><span style="color:#111">.</span><span style="color:#75af00">FullMethod</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	// 调用 grpc/metadata包中metadata.FromIncomingContext(ctx)传入 ctx，转换 grpc 的元数据</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">md</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">metadata</span><span style="color:#111">.</span><span style="color:#75af00">FromIncomingContext</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">);</span> <span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 调用carrier.go 中的 MetadataCarrier 将 MD 转换 成文本映射载体</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">carrier</span> <span style="color:#111">=</span> <span style="color:#75af00">MetadataCarrier</span><span style="color:#111">(</span><span style="color:#75af00">md</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 调用 tracer.Start 方法</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">span</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">tracer</span><span style="color:#111">.</span><span style="color:#75af00">Start</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">component</span><span style="color:#111">,</span> <span style="color:#75af00">operation</span><span style="color:#111">,</span> <span style="color:#75af00">carrier</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// ... 省略代码</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><ol start="4">
<li>调用 <strong>tracing.go</strong> 中的 <strong>Start</strong> 方法</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">t</span> <span style="color:#f92672">*</span><span style="color:#75af00">Tracer</span><span style="color:#111">)</span> <span style="color:#75af00">Start</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">,</span> <span style="color:#75af00">component</span> <span style="color:#00a8c8">string</span><span style="color:#111">,</span> <span style="color:#75af00">operation</span> <span style="color:#00a8c8">string</span><span style="color:#111">,</span> <span style="color:#75af00">carrier</span> <span style="color:#75af00">propagation</span><span style="color:#111">.</span><span style="color:#75af00">TextMapCarrier</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">,</span> <span style="color:#75af00">trace</span><span style="color:#111">.</span><span style="color:#75af00">Span</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 判断当前中间件如果是 server则将 carrier 注入到上下文中</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">kind</span> <span style="color:#f92672">==</span> <span style="color:#75af00">trace</span><span style="color:#111">.</span><span style="color:#75af00">SpanKindServer</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">ctx</span> <span style="color:#111">=</span> <span style="color:#75af00">otel</span><span style="color:#111">.</span><span style="color:#75af00">GetTextMapPropagator</span><span style="color:#111">().</span><span style="color:#75af00">Extract</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">carrier</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 调用otel/tracer 包中的 start 方法，用来创建一个 span</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">span</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">tracer</span><span style="color:#111">.</span><span style="color:#75af00">Start</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// tracing.go 中声明的请求路由作为 spanName</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">operation</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 设置 span 的属性，设置了一个 component，component的值为请求类型</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">trace</span><span style="color:#111">.</span><span style="color:#75af00">WithAttributes</span><span style="color:#111">(</span><span style="color:#75af00">attribute</span><span style="color:#111">.</span><span style="color:#75af00">String</span><span style="color:#111">(</span><span style="color:#d88200">&#34;component&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">component</span><span style="color:#111">)),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 设置 span种类</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">trace</span><span style="color:#111">.</span><span style="color:#75af00">WithSpanKind</span><span style="color:#111">(</span><span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">kind</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 判断如果当前中间件是 client 则将 carrier 注入到请求里面</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">kind</span> <span style="color:#f92672">==</span> <span style="color:#75af00">trace</span><span style="color:#111">.</span><span style="color:#75af00">SpanKindClient</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">otel</span><span style="color:#111">.</span><span style="color:#75af00">GetTextMapPropagator</span><span style="color:#111">().</span><span style="color:#75af00">Inject</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">carrier</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">span</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><ol start="5">
<li><strong>defer</strong> 声明了一个闭包方法</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-golang" data-lang="golang"><span style="display:flex;"><span><span style="color:#75715e">// 这个地方要注意，需要使用闭包，因为 defer 的参数是实时计算的如果异常发生，err 会一直为 nil</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// https://github.com/go-kratos/kratos/issues/927</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">defer</span> <span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#111">{</span> <span style="color:#75af00">tracer</span><span style="color:#111">.</span><span style="color:#75af00">End</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">span</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span> <span style="color:#111">}()</span>
</span></span></code></pre></div><ol start="6">
<li>中间件继续执行</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// tracing.go 69行</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">reply</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">handler</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">req</span><span style="color:#111">)</span>
</span></span></code></pre></div><ol start="7">
<li>中间件调用结束 <strong>defer</strong> 中的闭包被调用后执行了 <strong>tracer.go</strong> 中的 <strong>End</strong> 方法</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">t</span> <span style="color:#f92672">*</span><span style="color:#75af00">Tracer</span><span style="color:#111">)</span> <span style="color:#75af00">End</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">,</span> <span style="color:#75af00">span</span> <span style="color:#75af00">trace</span><span style="color:#111">.</span><span style="color:#75af00">Span</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 判断是否有异常发生，如果有则设置一些异常信息</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 记录异常</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">span</span><span style="color:#111">.</span><span style="color:#75af00">RecordError</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 设置span 属性</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">span</span><span style="color:#111">.</span><span style="color:#75af00">SetAttributes</span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 设置事件为异常</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">attribute</span><span style="color:#111">.</span><span style="color:#75af00">String</span><span style="color:#111">(</span><span style="color:#d88200">&#34;event&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;error&#34;</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 设置 message 为 err.Error().</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">attribute</span><span style="color:#111">.</span><span style="color:#75af00">String</span><span style="color:#111">(</span><span style="color:#d88200">&#34;message&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">.</span><span style="color:#75af00">Error</span><span style="color:#111">()),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">//设置了 span 的状态</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">span</span><span style="color:#111">.</span><span style="color:#75af00">SetStatus</span><span style="color:#111">(</span><span style="color:#75af00">codes</span><span style="color:#111">.</span><span style="color:#75af00">Error</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">.</span><span style="color:#75af00">Error</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 如果没有发生异常，span 状态则为 ok</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">span</span><span style="color:#111">.</span><span style="color:#75af00">SetStatus</span><span style="color:#111">(</span><span style="color:#75af00">codes</span><span style="color:#111">.</span><span style="color:#75af00">Ok</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;OK&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 中止 span</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">span</span><span style="color:#111">.</span><span style="color:#75af00">End</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h4 id="如何使用">如何使用</h4>
<p>tracing 中间件的使用示例可以从  <a href="https://github.com/go-kratos/kratos/tree/main/examples/traces">kratos/examples/traces</a> ,该示例简单的实现了跨服务间的链路追踪,以下代码片段包含部分示例代码。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// https://github.com/go-kratos/kratos/blob/7f835db398c9d0332e69b81bad4c652b4b45ae2e/examples/traces/app/message/main.go#L38</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 首先调用otel 库方法，得到一个 TracerProvider</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">tracerProvider</span><span style="color:#111">(</span><span style="color:#75af00">url</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">tracesdk</span><span style="color:#111">.</span><span style="color:#75af00">TracerProvider</span><span style="color:#111">,</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// examples/traces 中使用的是 jaeger，其他方式可以查看 opentelemetry 官方示例</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">exp</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">jaeger</span><span style="color:#111">.</span><span style="color:#75af00">NewRawExporter</span><span style="color:#111">(</span><span style="color:#75af00">jaeger</span><span style="color:#111">.</span><span style="color:#75af00">WithCollectorEndpoint</span><span style="color:#111">(</span><span style="color:#75af00">jaeger</span><span style="color:#111">.</span><span style="color:#75af00">WithEndpoint</span><span style="color:#111">(</span><span style="color:#75af00">url</span><span style="color:#111">)))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">tp</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">tracesdk</span><span style="color:#111">.</span><span style="color:#75af00">NewTracerProvider</span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">tracesdk</span><span style="color:#111">.</span><span style="color:#75af00">WithSampler</span><span style="color:#111">(</span><span style="color:#75af00">tracesdk</span><span style="color:#111">.</span><span style="color:#75af00">AlwaysSample</span><span style="color:#111">()),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 设置 Batcher，注册jaeger导出程序</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">tracesdk</span><span style="color:#111">.</span><span style="color:#75af00">WithBatcher</span><span style="color:#111">(</span><span style="color:#75af00">exp</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 记录一些默认信息</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">tracesdk</span><span style="color:#111">.</span><span style="color:#75af00">WithResource</span><span style="color:#111">(</span><span style="color:#75af00">resource</span><span style="color:#111">.</span><span style="color:#75af00">NewWithAttributes</span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">semconv</span><span style="color:#111">.</span><span style="color:#75af00">ServiceNameKey</span><span style="color:#111">.</span><span style="color:#75af00">String</span><span style="color:#111">(</span><span style="color:#75af00">pb</span><span style="color:#111">.</span><span style="color:#75af00">User_ServiceDesc</span><span style="color:#111">.</span><span style="color:#75af00">ServiceName</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">attribute</span><span style="color:#111">.</span><span style="color:#75af00">String</span><span style="color:#111">(</span><span style="color:#d88200">&#34;environment&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;development&#34;</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">attribute</span><span style="color:#111">.</span><span style="color:#75af00">Int64</span><span style="color:#111">(</span><span style="color:#d88200">&#34;ID&#34;</span><span style="color:#111">,</span> <span style="color:#ae81ff">1</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">)),</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">tp</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h4 id="在-grpcserver-中使用">在 grpc/server 中使用</h4>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// https://github.com/go-kratos/kratos/blob/main/examples/traces/app/message/main.go</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">grpcSrv</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">grpc</span><span style="color:#111">.</span><span style="color:#75af00">NewServer</span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">grpc</span><span style="color:#111">.</span><span style="color:#75af00">Address</span><span style="color:#111">(</span><span style="color:#d88200">&#34;:9000&#34;</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">grpc</span><span style="color:#111">.</span><span style="color:#75af00">Middleware</span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Configuring tracing Middleware</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">tracing</span><span style="color:#111">.</span><span style="color:#75af00">Server</span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">tracing</span><span style="color:#111">.</span><span style="color:#75af00">WithTracerProvider</span><span style="color:#111">(</span><span style="color:#75af00">tp</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">),</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span></code></pre></div><h4 id="在-grpcclient-中使用">在 grpc/client 中使用</h4>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// https://github.com/go-kratos/kratos/blob/149fc0195eb62ee1fbc2728adb92e1bcd1a12c4e/examples/traces/app/user/main.go#L63</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">conn</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">grpc</span><span style="color:#111">.</span><span style="color:#75af00">DialInsecure</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">grpc</span><span style="color:#111">.</span><span style="color:#75af00">WithEndpoint</span><span style="color:#111">(</span><span style="color:#d88200">&#34;127.0.0.1:9000&#34;</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">grpc</span><span style="color:#111">.</span><span style="color:#75af00">WithMiddleware</span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">tracing</span><span style="color:#111">.</span><span style="color:#75af00">Client</span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">tracing</span><span style="color:#111">.</span><span style="color:#75af00">WithTracerProvider</span><span style="color:#111">(</span><span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">tracer</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">tracing</span><span style="color:#111">.</span><span style="color:#75af00">WithPropagators</span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">propagation</span><span style="color:#111">.</span><span style="color:#75af00">NewCompositeTextMapPropagator</span><span style="color:#111">(</span><span style="color:#75af00">propagation</span><span style="color:#111">.</span><span style="color:#75af00">Baggage</span><span style="color:#111">{},</span> <span style="color:#75af00">propagation</span><span style="color:#111">.</span><span style="color:#75af00">TraceContext</span><span style="color:#111">{}),</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">grpc</span><span style="color:#111">.</span><span style="color:#75af00">WithTimeout</span><span style="color:#111">(</span><span style="color:#ae81ff">2</span><span style="color:#f92672">*</span><span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Second</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span></code></pre></div><h4 id="在-httpserver-中使用">在 http/server 中使用</h4>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// https://github.com/go-kratos/kratos/blob/main/examples/traces/app/user/main.go</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">httpSrv</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">NewServer</span><span style="color:#111">(</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Address</span><span style="color:#111">(</span><span style="color:#d88200">&#34;:8000&#34;</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">httpSrv</span><span style="color:#111">.</span><span style="color:#75af00">HandlePrefix</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">pb</span><span style="color:#111">.</span><span style="color:#75af00">NewUserHandler</span><span style="color:#111">(</span><span style="color:#75af00">s</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Middleware</span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Configuring tracing middleware</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">tracing</span><span style="color:#111">.</span><span style="color:#75af00">Server</span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">tracing</span><span style="color:#111">.</span><span style="color:#75af00">WithTracerProvider</span><span style="color:#111">(</span><span style="color:#75af00">tp</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">tracing</span><span style="color:#111">.</span><span style="color:#75af00">WithPropagators</span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">propagation</span><span style="color:#111">.</span><span style="color:#75af00">NewCompositeTextMapPropagator</span><span style="color:#111">(</span><span style="color:#75af00">propagation</span><span style="color:#111">.</span><span style="color:#75af00">Baggage</span><span style="color:#111">{},</span> <span style="color:#75af00">propagation</span><span style="color:#111">.</span><span style="color:#75af00">TraceContext</span><span style="color:#111">{}),</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">),</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span></code></pre></div><h4 id="在-httpclient-中使用">在 http/client 中使用</h4>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">NewClient</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">WithMiddleware</span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">tracing</span><span style="color:#111">.</span><span style="color:#75af00">Client</span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">tracing</span><span style="color:#111">.</span><span style="color:#75af00">WithTracerProvider</span><span style="color:#111">(</span><span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">tracer</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">),</span>
</span></span><span style="display:flex;"><span><span style="color:#111">))</span>
</span></span></code></pre></div><h4 id="如何实现一个其他场景的-tracing">如何实现一个其他场景的 tracing</h4>
<p>我们可以借鉴 <strong>kratos</strong> 的 <strong>tracing</strong> 中间件的代码来实现例如数据库的 <strong>tracing</strong>，如下面的代码片段，作者借鉴了<strong>tracing</strong> 中间件，实现了 <strong>qmgo</strong> 库操作 <strong>MongoDB</strong> 数据库的 <strong>tracing</strong>。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">mongoTracer</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">,</span><span style="color:#75af00">tp</span> <span style="color:#75af00">trace</span><span style="color:#111">.</span><span style="color:#75af00">TracerProvider</span><span style="color:#111">,</span> <span style="color:#75af00">command</span> <span style="color:#00a8c8">interface</span><span style="color:#111">{})</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">var</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">commandName</span> <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">failure</span>     <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">nanos</span>       <span style="color:#00a8c8">int64</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">reply</span>       <span style="color:#75af00">bson</span><span style="color:#111">.</span><span style="color:#75af00">Raw</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">queryId</span>     <span style="color:#00a8c8">int64</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">eventName</span>   <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">otel</span><span style="color:#111">.</span><span style="color:#75af00">SetTracerProvider</span><span style="color:#111">(</span><span style="color:#75af00">tp</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">reply</span> <span style="color:#111">=</span> <span style="color:#75af00">bson</span><span style="color:#111">.</span><span style="color:#75af00">Raw</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">switch</span> <span style="color:#75af00">value</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">command</span><span style="color:#111">.(</span><span style="color:#00a8c8">type</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">case</span> <span style="color:#f92672">*</span><span style="color:#75af00">event</span><span style="color:#111">.</span><span style="color:#75af00">CommandStartedEvent</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">commandName</span> <span style="color:#111">=</span> <span style="color:#75af00">value</span><span style="color:#111">.</span><span style="color:#75af00">CommandName</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">reply</span> <span style="color:#111">=</span> <span style="color:#75af00">value</span><span style="color:#111">.</span><span style="color:#75af00">Command</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">queryId</span> <span style="color:#111">=</span> <span style="color:#75af00">value</span><span style="color:#111">.</span><span style="color:#75af00">RequestID</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">eventName</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;CommandStartedEvent&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">case</span> <span style="color:#f92672">*</span><span style="color:#75af00">event</span><span style="color:#111">.</span><span style="color:#75af00">CommandSucceededEvent</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">commandName</span> <span style="color:#111">=</span> <span style="color:#75af00">value</span><span style="color:#111">.</span><span style="color:#75af00">CommandName</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">nanos</span> <span style="color:#111">=</span> <span style="color:#75af00">value</span><span style="color:#111">.</span><span style="color:#75af00">DurationNanos</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">queryId</span> <span style="color:#111">=</span> <span style="color:#75af00">value</span><span style="color:#111">.</span><span style="color:#75af00">RequestID</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">eventName</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;CommandSucceededEvent&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">case</span> <span style="color:#f92672">*</span><span style="color:#75af00">event</span><span style="color:#111">.</span><span style="color:#75af00">CommandFailedEvent</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">commandName</span> <span style="color:#111">=</span> <span style="color:#75af00">value</span><span style="color:#111">.</span><span style="color:#75af00">CommandName</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">failure</span> <span style="color:#111">=</span> <span style="color:#75af00">value</span><span style="color:#111">.</span><span style="color:#75af00">Failure</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">nanos</span> <span style="color:#111">=</span> <span style="color:#75af00">value</span><span style="color:#111">.</span><span style="color:#75af00">DurationNanos</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">queryId</span> <span style="color:#111">=</span> <span style="color:#75af00">value</span><span style="color:#111">.</span><span style="color:#75af00">RequestID</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">eventName</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;CommandFailedEvent&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">duration</span><span style="color:#111">,</span> <span style="color:#75af00">_</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">ParseDuration</span><span style="color:#111">(</span><span style="color:#75af00">strconv</span><span style="color:#111">.</span><span style="color:#75af00">FormatInt</span><span style="color:#111">(</span><span style="color:#75af00">nanos</span><span style="color:#111">,</span> <span style="color:#ae81ff">10</span><span style="color:#111">)</span> <span style="color:#f92672">+</span> <span style="color:#d88200">&#34;ns&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">tracer</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">otel</span><span style="color:#111">.</span><span style="color:#75af00">Tracer</span><span style="color:#111">(</span><span style="color:#d88200">&#34;mongodb&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">kind</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">trace</span><span style="color:#111">.</span><span style="color:#75af00">SpanKindServer</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">span</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">tracer</span><span style="color:#111">.</span><span style="color:#75af00">Start</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">commandName</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">trace</span><span style="color:#111">.</span><span style="color:#75af00">WithAttributes</span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">attribute</span><span style="color:#111">.</span><span style="color:#75af00">String</span><span style="color:#111">(</span><span style="color:#d88200">&#34;event&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">eventName</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">attribute</span><span style="color:#111">.</span><span style="color:#75af00">String</span><span style="color:#111">(</span><span style="color:#d88200">&#34;command&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">commandName</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">attribute</span><span style="color:#111">.</span><span style="color:#75af00">String</span><span style="color:#111">(</span><span style="color:#d88200">&#34;query&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">reply</span><span style="color:#111">.</span><span style="color:#75af00">String</span><span style="color:#111">()),</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">attribute</span><span style="color:#111">.</span><span style="color:#75af00">Int64</span><span style="color:#111">(</span><span style="color:#d88200">&#34;queryId&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">queryId</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">attribute</span><span style="color:#111">.</span><span style="color:#75af00">String</span><span style="color:#111">(</span><span style="color:#d88200">&#34;ms&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">duration</span><span style="color:#111">.</span><span style="color:#75af00">String</span><span style="color:#111">()),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">trace</span><span style="color:#111">.</span><span style="color:#75af00">WithSpanKind</span><span style="color:#111">(</span><span style="color:#75af00">kind</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">failure</span> <span style="color:#f92672">!=</span> <span style="color:#d88200">&#34;&#34;</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">span</span><span style="color:#111">.</span><span style="color:#75af00">RecordError</span><span style="color:#111">(</span><span style="color:#75af00">errors</span><span style="color:#111">.</span><span style="color:#75af00">New</span><span style="color:#111">(</span><span style="color:#75af00">failure</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">span</span><span style="color:#111">.</span><span style="color:#75af00">End</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="文章转自">文章转自</h2>
<ul>
<li><a href="https://go-kratos.dev/blog/go-kratos-opentelemetry-practice">https://go-kratos.dev/blog/go-kratos-opentelemetry-practice</a></li>
</ul>
<hr>
<p><img src="/images/e229d439-abe8-46dc-ade5-1ed23e0f6e9f.png" alt=""></p>
<p><img src="/images/ff1c163e-73c7-4fe7-b4d5-bb380f48f38c.gif" alt=""></p>
]]></content:encoded><category>kratos</category><category>go</category><category>kratos</category><category>opentelemetry</category></item><item><title>通过 layout 探索 kratos 运行原理</title><link>https://daemon365.dev/post/kratos/explore_the_working_principle_of_kratos_through_layout/</link><pubDate>Fri, 20 Aug 2021 18:11:50 +0800</pubDate><guid>https://daemon365.dev/post/kratos/explore_the_working_principle_of_kratos_through_layout/</guid><description>&lt;h2 id="创建项目"&gt;创建项目&lt;/h2&gt;
&lt;p&gt;首先需要安装好对应的依赖环境，以及工具：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;go
&lt;ul&gt;
&lt;li&gt;&lt;a href="https://studygolang.com/dl"&gt;下载&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;protoc
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;go install google.golang.org/protobuf/cmd/protoc-gen-go@latest&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;protoc-gen-go
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;# 创建项目模板&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;kratos new helloworld
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;cd&lt;/span&gt; helloworld
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;# 拉取项目依赖&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;go mod download
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;# 生成proto模板&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;kratos proto add api/helloworld/helloworld.proto
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;# 生成proto源码&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;kratos proto client api/helloworld/helloworld.proto
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;# 生成server模板&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;kratos proto server api/helloworld/helloworld.proto -t internal/service
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;执行命令后,会在当前目录下生成一个 service 工程,工程骨架如下,具体的工程骨架说明可以访问 &lt;a href="https://go-kratos.dev/docs/intro/layout"&gt;layout&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src="https://daemon365.dev/images/f085a067-3d84-46ce-84ff-4bd9f33e5702.png" alt=""&gt;&lt;/p&gt;
&lt;h2 id="运行项目"&gt;运行项目&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;# 生成所有proto源码、wire等等&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;go generate ./...
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;# 编译成可执行文件&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;go build -o ./bin/ ./...
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;# 运行项目&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;./bin/helloworld -conf ./configs
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;看到如下输出则证明项目启动正常&lt;/p&gt;</description><content:encoded><![CDATA[<h2 id="创建项目">创建项目</h2>
<p>首先需要安装好对应的依赖环境，以及工具：</p>
<ol>
<li>go
<ul>
<li><a href="https://studygolang.com/dl">下载</a></li>
</ul>
</li>
<li>protoc
<ul>
<li><code>go install google.golang.org/protobuf/cmd/protoc-gen-go@latest</code></li>
</ul>
</li>
<li>protoc-gen-go
<ul>
<li><code>go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest</code></li>
</ul>
</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 创建项目模板</span>
</span></span><span style="display:flex;"><span>kratos new helloworld
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">cd</span> helloworld
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 拉取项目依赖</span>
</span></span><span style="display:flex;"><span>go mod download
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 生成proto模板</span>
</span></span><span style="display:flex;"><span>kratos proto add api/helloworld/helloworld.proto
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 生成proto源码</span>
</span></span><span style="display:flex;"><span>kratos proto client api/helloworld/helloworld.proto
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 生成server模板</span>
</span></span><span style="display:flex;"><span>kratos proto server api/helloworld/helloworld.proto -t internal/service
</span></span></code></pre></div><p>执行命令后,会在当前目录下生成一个 service 工程,工程骨架如下,具体的工程骨架说明可以访问 <a href="https://go-kratos.dev/docs/intro/layout">layout</a></p>
<p><img src="/images/f085a067-3d84-46ce-84ff-4bd9f33e5702.png" alt=""></p>
<h2 id="运行项目">运行项目</h2>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 生成所有proto源码、wire等等</span>
</span></span><span style="display:flex;"><span>go generate ./...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 编译成可执行文件</span>
</span></span><span style="display:flex;"><span>go build -o ./bin/ ./...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 运行项目</span>
</span></span><span style="display:flex;"><span>./bin/helloworld -conf ./configs
</span></span></code></pre></div><p>看到如下输出则证明项目启动正常</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#111">level</span><span style="color:#f92672">=</span>INFO <span style="color:#111">module</span><span style="color:#f92672">=</span>app <span style="color:#111">service_id</span><span style="color:#f92672">=</span>7114ad8a-b3bf-11eb-a1b9-f0189850d2cb <span style="color:#111">service_name</span><span style="color:#f92672">=</span>  <span style="color:#111">version</span><span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span><span style="color:#111">level</span><span style="color:#f92672">=</span>INFO <span style="color:#111">module</span><span style="color:#f92672">=</span>transport/grpc <span style="color:#111">msg</span><span style="color:#f92672">=[</span>gRPC<span style="color:#f92672">]</span> server listening on: <span style="color:#f92672">[</span>::<span style="color:#f92672">]</span>:9000
</span></span><span style="display:flex;"><span><span style="color:#111">level</span><span style="color:#f92672">=</span>INFO <span style="color:#111">module</span><span style="color:#f92672">=</span>transport/http <span style="color:#111">msg</span><span style="color:#f92672">=[</span>HTTP<span style="color:#f92672">]</span> server listening on: <span style="color:#f92672">[</span>::<span style="color:#f92672">]</span>:8000 
</span></span></code></pre></div><p>测试接口</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>curl <span style="color:#d88200">&#39;http://127.0.0.1:8000/helloworld/krtaos&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>输出：
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#d88200">&#34;message&#34;</span>: <span style="color:#d88200">&#34;Hello kratos&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h2 id="应用是如何跑起来的">应用是如何跑起来的?</h2>
<p><img src="/images/d25a4d6d-c7b1-4628-932e-8a67215fd7a8.png" alt=""></p>
<p>通过上面的图例👆,我们可以直观观察到应用的调用链,简化来说如下图流程所示👇</p>
<p><img src="/images/cc53e249-fee8-4f8c-8479-ca2e7f22b07f.png" alt=""></p>
<h3 id="1-注入依赖并调用-newapp-方法">1. 注入依赖并调用 newApp() 方法</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// helloword/cmd/main.go</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">flag</span><span style="color:#111">.</span><span style="color:#75af00">Parse</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">logger</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">NewStdLogger</span><span style="color:#111">(</span><span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">Stdout</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 调用 go-kratos/kratos/v2/config,创建 config 实例,并指定了来源和配置解析方法</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">c</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">config</span><span style="color:#111">.</span><span style="color:#75af00">New</span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">config</span><span style="color:#111">.</span><span style="color:#75af00">WithSource</span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">file</span><span style="color:#111">.</span><span style="color:#75af00">NewSource</span><span style="color:#111">(</span><span style="color:#75af00">flagconf</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">config</span><span style="color:#111">.</span><span style="color:#75af00">WithDecoder</span><span style="color:#111">(</span><span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">kv</span> <span style="color:#f92672">*</span><span style="color:#75af00">config</span><span style="color:#111">.</span><span style="color:#75af00">KeyValue</span><span style="color:#111">,</span> <span style="color:#75af00">v</span> <span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#00a8c8">string</span><span style="color:#111">]</span><span style="color:#00a8c8">interface</span><span style="color:#111">{})</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">yaml</span><span style="color:#111">.</span><span style="color:#75af00">Unmarshal</span><span style="color:#111">(</span><span style="color:#75af00">kv</span><span style="color:#111">.</span><span style="color:#75af00">Value</span><span style="color:#111">,</span> <span style="color:#75af00">v</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">Load</span><span style="color:#111">();</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 将配置扫描到,通过 proto 声明的 conf struct 上</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">var</span> <span style="color:#75af00">bc</span> <span style="color:#75af00">conf</span><span style="color:#111">.</span><span style="color:#75af00">Bootstrap</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">Scan</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">bc</span><span style="color:#111">);</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 通过 wire 将依赖注入,并调用 newApp 方法</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">app</span><span style="color:#111">,</span> <span style="color:#75af00">cleanup</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">initApp</span><span style="color:#111">(</span><span style="color:#75af00">bc</span><span style="color:#111">.</span><span style="color:#75af00">Server</span><span style="color:#111">,</span> <span style="color:#75af00">bc</span><span style="color:#111">.</span><span style="color:#75af00">Data</span><span style="color:#111">,</span> <span style="color:#75af00">logger</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 省略代码...</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="2-创建-kratos-实例">2. 创建 kratos 实例</h3>
<p>项目 main.go 的 <strong>newApp()</strong> 方法中,调用了 <strong>go-kratos/kratos/v2/app.go</strong> 中的 <strong>kratos.New()</strong> 方法</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// helloword/cmd/main.go</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">newApp</span><span style="color:#111">(</span><span style="color:#75af00">logger</span> <span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Logger</span><span style="color:#111">,</span> <span style="color:#75af00">hs</span> <span style="color:#f92672">*</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Server</span><span style="color:#111">,</span> <span style="color:#75af00">gs</span> <span style="color:#f92672">*</span><span style="color:#75af00">grpc</span><span style="color:#111">.</span><span style="color:#75af00">Server</span><span style="color:#111">)</span> <span style="color:#f92672">*</span><span style="color:#75af00">kratos</span><span style="color:#111">.</span><span style="color:#75af00">App</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#75af00">kratos</span><span style="color:#111">.</span><span style="color:#75af00">New</span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 配置应用   </span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">kratos</span><span style="color:#111">.</span><span style="color:#75af00">Name</span><span style="color:#111">(</span><span style="color:#75af00">Name</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">kratos</span><span style="color:#111">.</span><span style="color:#75af00">Version</span><span style="color:#111">(</span><span style="color:#75af00">Version</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">kratos</span><span style="color:#111">.</span><span style="color:#75af00">Metadata</span><span style="color:#111">(</span><span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#00a8c8">string</span><span style="color:#111">]</span><span style="color:#00a8c8">string</span><span style="color:#111">{}),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">kratos</span><span style="color:#111">.</span><span style="color:#75af00">Logger</span><span style="color:#111">(</span><span style="color:#75af00">logger</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// kratos.Server() 传入的 http/grpc 服务会通过 buildInstance() 转换成registry.ServiceInstance struct*</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">kratos</span><span style="color:#111">.</span><span style="color:#75af00">Server</span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75af00">hs</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75af00">gs</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>该方法会返回一个 <strong>App struct</strong>,包含 <strong>Run()</strong> 和 <strong>Stop()</strong> 方法</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// go-kratos/kratos/v2/app.go</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">App</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">opts</span>     <span style="color:#75af00">options</span> <span style="color:#75715e">//配置</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">ctx</span>      <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Context</span> <span style="color:#75715e">// 上下文</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">cancel</span>   <span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#75715e">// context 的取消方法</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">instance</span> <span style="color:#f92672">*</span><span style="color:#75af00">registry</span><span style="color:#111">.</span><span style="color:#75af00">ServiceInstance</span> <span style="color:#75715e">//通过 kratos.Server()声明的实例,并通过 buildInstance() 转换后的 *registry.ServiceInstance struct</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">log</span>      <span style="color:#f92672">*</span><span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Helper</span> <span style="color:#75715e">// 日志</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Run executes all OnStart hooks registered with the application&#39;s Lifecycle.</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">a</span> <span style="color:#f92672">*</span><span style="color:#75af00">App</span><span style="color:#111">)</span> <span style="color:#75af00">Run</span><span style="color:#111">()</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 省略代码...</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Stop gracefully stops the application.</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">a</span> <span style="color:#f92672">*</span><span style="color:#75af00">App</span><span style="color:#111">)</span> <span style="color:#75af00">Stop</span><span style="color:#111">()</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 省略代码...</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="3-调用-run-方法">3. 调用 Run() 方法<a href="https://go-kratos.dev/blog/go-layout-operation-process/#3-%E8%B0%83%E7%94%A8-run-%E6%96%B9%E6%B3%95">#</a></h3>
<p>项目在 main 方法中调用了 <strong>kratos.App struct</strong> 的 <strong>Run()</strong> 方法.</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// helloword/cmd/main.go</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 省略代码...</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 启动 Kratos</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">app</span><span style="color:#111">.</span><span style="color:#75af00">Run</span><span style="color:#111">();</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p><strong>Run()</strong> 方法的实现细节</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// go-kratos/kratos/v2/app.go</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">a</span> <span style="color:#f92672">*</span><span style="color:#75af00">App</span><span style="color:#111">)</span> <span style="color:#75af00">Run</span><span style="color:#111">()</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">a</span><span style="color:#111">.</span><span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Infow</span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#d88200">&#34;service_id&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">a</span><span style="color:#111">.</span><span style="color:#75af00">opts</span><span style="color:#111">.</span><span style="color:#75af00">id</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#d88200">&#34;service_name&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">a</span><span style="color:#111">.</span><span style="color:#75af00">opts</span><span style="color:#111">.</span><span style="color:#75af00">name</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#d88200">&#34;version&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">a</span><span style="color:#111">.</span><span style="color:#75af00">opts</span><span style="color:#111">.</span><span style="color:#75af00">version</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">g</span><span style="color:#111">,</span> <span style="color:#75af00">ctx</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">errgroup</span><span style="color:#111">.</span><span style="color:#75af00">WithContext</span><span style="color:#111">(</span><span style="color:#75af00">a</span><span style="color:#111">.</span><span style="color:#75af00">ctx</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 遍历通过 kratos.Server() 声明的服务实例</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">srv</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">a</span><span style="color:#111">.</span><span style="color:#75af00">opts</span><span style="color:#111">.</span><span style="color:#75af00">servers</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">srv</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">srv</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// 执行两个goroutine, 用于处理服务启动和退出</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">Go</span><span style="color:#111">(</span><span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;-</span><span style="color:#75af00">ctx</span><span style="color:#111">.</span><span style="color:#75af00">Done</span><span style="color:#111">()</span> <span style="color:#75715e">// 阻塞,等待调用 cancel 方法</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">return</span> <span style="color:#75af00">srv</span><span style="color:#111">.</span><span style="color:#75af00">Stop</span><span style="color:#111">()</span> <span style="color:#75715e">// 协程退出后,调用实例的停止方法</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">Go</span><span style="color:#111">(</span><span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">return</span> <span style="color:#75af00">srv</span><span style="color:#111">.</span><span style="color:#75af00">Start</span><span style="color:#111">()</span> <span style="color:#75715e">// 调用实例的运行方法</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 判断是否调用 kratos.Registrar() 配置了注册发现中心</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">a</span><span style="color:#111">.</span><span style="color:#75af00">opts</span><span style="color:#111">.</span><span style="color:#75af00">registrar</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 将实例注册到注册中心</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">a</span><span style="color:#111">.</span><span style="color:#75af00">opts</span><span style="color:#111">.</span><span style="color:#75af00">registrar</span><span style="color:#111">.</span><span style="color:#75af00">Register</span><span style="color:#111">(</span><span style="color:#75af00">a</span><span style="color:#111">.</span><span style="color:#75af00">opts</span><span style="color:#111">.</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">a</span><span style="color:#111">.</span><span style="color:#75af00">instance</span><span style="color:#111">);</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> 
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 监听进程退出信号</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">c</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">chan</span> <span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">Signal</span><span style="color:#111">,</span> <span style="color:#ae81ff">1</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">signal</span><span style="color:#111">.</span><span style="color:#75af00">Notify</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">,</span> <span style="color:#75af00">a</span><span style="color:#111">.</span><span style="color:#75af00">opts</span><span style="color:#111">.</span><span style="color:#75af00">sigs</span><span style="color:#f92672">...</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 处理进程退出和 context 退出</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">Go</span><span style="color:#111">(</span><span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">for</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">select</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#75af00">ctx</span><span style="color:#111">.</span><span style="color:#75af00">Done</span><span style="color:#111">():</span>
</span></span><span style="display:flex;"><span>                <span style="color:#00a8c8">return</span> <span style="color:#75af00">ctx</span><span style="color:#111">.</span><span style="color:#75af00">Err</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#75af00">c</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#75715e">// 调用 kratos.App 的停止方法</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75af00">a</span><span style="color:#111">.</span><span style="color:#75af00">Stop</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">Wait</span><span style="color:#111">();</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#111">!</span><span style="color:#75af00">errors</span><span style="color:#111">.</span><span style="color:#75af00">Is</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Canceled</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="4-应用退出">4. 应用退出</h3>
<p>Kratos 实例在启动时,监听了系统的进程退出信号,当收到退出信号时,kratos 会调用 <strong>App struct</strong> 的 <strong>Stop()</strong> 方法</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// go-kratos/kratos/v2/app.go</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">a</span> <span style="color:#f92672">*</span><span style="color:#75af00">App</span><span style="color:#111">)</span> <span style="color:#75af00">Stop</span><span style="color:#111">()</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 判断是否有注册中心配置</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">a</span><span style="color:#111">.</span><span style="color:#75af00">opts</span><span style="color:#111">.</span><span style="color:#75af00">registrar</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 在注册中心中将实例注销</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">a</span><span style="color:#111">.</span><span style="color:#75af00">opts</span><span style="color:#111">.</span><span style="color:#75af00">registrar</span><span style="color:#111">.</span><span style="color:#75af00">Deregister</span><span style="color:#111">(</span><span style="color:#75af00">a</span><span style="color:#111">.</span><span style="color:#75af00">opts</span><span style="color:#111">.</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">a</span><span style="color:#111">.</span><span style="color:#75af00">instance</span><span style="color:#111">);</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 控制 goroutine 的退出,当调用 a.cancel()时,Run()方法中 监听的 &lt;-ctx.Done() 收到消息后,没有阻塞后,方法会调用 server 的 Stop()方法,停止服务</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">a</span><span style="color:#111">.</span><span style="color:#75af00">cancel</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">a</span><span style="color:#111">.</span><span style="color:#75af00">cancel</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="文章转自">文章转自：</h2>
<ul>
<li><a href="https://go-kratos.dev/blog/go-layout-operation-process/">https://go-kratos.dev/blog/go-layout-operation-process/</a></li>
</ul>
<p><img src="/images/5110e166-c292-4b6d-aee8-ac55369b5061.png" alt=""></p>
<p><img src="/images/c25146c6-296d-4c41-b86f-0980a507c28f.gif" alt=""></p>
]]></content:encoded><category>kratos</category><category>go</category><category>kratos</category></item><item><title>kratos 日志库的使用姿势</title><link>https://daemon365.dev/post/kratos/how_to_use_the_log_library/</link><pubDate>Thu, 19 Aug 2021 18:11:50 +0800</pubDate><guid>https://daemon365.dev/post/kratos/how_to_use_the_log_library/</guid><description>&lt;h2 id="什么是日志"&gt;什么是日志&lt;/h2&gt;
&lt;blockquote&gt;
&lt;p&gt;所谓日志（Log）是指系统所指定对象的某些操作和其操作结果按时间有序的集合。log文件就是日志文件，log文件记录了系统和系统的用户之间交互的信息，是自动捕获人与系统终端之间交互的类型、内容或时间的数据收集方法。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;日志是用来记录，用户操作，系统状态，错误信息等等内容的文件，是一个软件系统的重要组成部分。一个良好的日志规范，对于系统运行状态的分析，以及线上问题的解决具有重大的意义。&lt;/p&gt;
&lt;h3 id="日志规范"&gt;日志规范&lt;/h3&gt;
&lt;p&gt;在开发软件打印日志时，需要注意一些问题，举例可能不全，可以自行百度相关文章或查看文章底部文献：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;重要功能日志尽可能的完善。&lt;/li&gt;
&lt;li&gt;不要随意打印无用的日志，过多无用的日志会增加分析日志的难度。&lt;/li&gt;
&lt;li&gt;日志要区分等级 如 debug，warn，info，error 等。&lt;/li&gt;
&lt;li&gt;捕获到未处理错误时最好打印错误堆栈信息&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id="go-语言常用的日志库"&gt;Go 语言常用的日志库&lt;/h3&gt;
&lt;p&gt;Go 语言标准库中就为我们提供了一个日志库 &lt;strong&gt;log&lt;/strong&gt;，除了这个以外还有很多日志库，如 &lt;strong&gt;logrus&lt;/strong&gt;，&lt;strong&gt;glog&lt;/strong&gt;，&lt;strong&gt;logx&lt;/strong&gt;，&lt;strong&gt;Uber&lt;/strong&gt; 的 &lt;strong&gt;zap&lt;/strong&gt; 等等，例如 &lt;strong&gt;zap&lt;/strong&gt; 就有很多的优点：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;高性能&lt;/li&gt;
&lt;li&gt;配置项丰富&lt;/li&gt;
&lt;li&gt;多种日志级别&lt;/li&gt;
&lt;li&gt;支持Hook&lt;/li&gt;
&lt;li&gt;丰富的工具包&lt;/li&gt;
&lt;li&gt;提供了sugar log&lt;/li&gt;
&lt;li&gt;多种日志打印格式&lt;/li&gt;
&lt;li&gt;&amp;hellip;&lt;/li&gt;
&lt;/ul&gt;
&lt;h5 id="简单使用"&gt;简单使用&lt;/h5&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-golang" data-lang="golang"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;package&lt;/span&gt; &lt;span style="color:#75af00"&gt;main&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;import&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;errors&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;go.uber.org/zap&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;var&lt;/span&gt; &lt;span style="color:#75af00"&gt;logger&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;zap&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Logger&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;init&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;logger&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;_&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#75af00"&gt;zap&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;NewProduction&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;main&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;logger&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Error&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;My name is baobao&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;zap&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;String&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;from&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;Hulun Buir&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;),&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;zap&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Error&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;errors&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;New&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;no good&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;)))&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;logger&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Info&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;Worked in the Ministry of national development of China!&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;zap&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;String&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;key&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;eat🍚&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;),&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;zap&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;String&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;key&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;sleep😴&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;))&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;defer&lt;/span&gt; &lt;span style="color:#75af00"&gt;logger&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Sync&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id="kratos-日志库原理解析"&gt;Kratos 日志库原理解析&lt;/h2&gt;
&lt;blockquote&gt;
&lt;p&gt;在私下与 &lt;strong&gt;Tony老师&lt;/strong&gt; 沟通时关于日志库的实现理念时，&lt;strong&gt;Tony老师&lt;/strong&gt; 说：由于目前日志库非常多并且好用，在 &lt;strong&gt;Kratos&lt;/strong&gt; 的日志中，主要考虑以下几个问题：&lt;/p&gt;</description><content:encoded><![CDATA[<h2 id="什么是日志">什么是日志</h2>
<blockquote>
<p>所谓日志（Log）是指系统所指定对象的某些操作和其操作结果按时间有序的集合。log文件就是日志文件，log文件记录了系统和系统的用户之间交互的信息，是自动捕获人与系统终端之间交互的类型、内容或时间的数据收集方法。</p>
</blockquote>
<p>日志是用来记录，用户操作，系统状态，错误信息等等内容的文件，是一个软件系统的重要组成部分。一个良好的日志规范，对于系统运行状态的分析，以及线上问题的解决具有重大的意义。</p>
<h3 id="日志规范">日志规范</h3>
<p>在开发软件打印日志时，需要注意一些问题，举例可能不全，可以自行百度相关文章或查看文章底部文献：</p>
<ul>
<li>重要功能日志尽可能的完善。</li>
<li>不要随意打印无用的日志，过多无用的日志会增加分析日志的难度。</li>
<li>日志要区分等级 如 debug，warn，info，error 等。</li>
<li>捕获到未处理错误时最好打印错误堆栈信息</li>
</ul>
<h3 id="go-语言常用的日志库">Go 语言常用的日志库</h3>
<p>Go 语言标准库中就为我们提供了一个日志库 <strong>log</strong>，除了这个以外还有很多日志库，如 <strong>logrus</strong>，<strong>glog</strong>，<strong>logx</strong>，<strong>Uber</strong> 的 <strong>zap</strong> 等等，例如 <strong>zap</strong> 就有很多的优点：</p>
<ul>
<li>高性能</li>
<li>配置项丰富</li>
<li>多种日志级别</li>
<li>支持Hook</li>
<li>丰富的工具包</li>
<li>提供了sugar log</li>
<li>多种日志打印格式</li>
<li>&hellip;</li>
</ul>
<h5 id="简单使用">简单使用</h5>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-golang" data-lang="golang"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;errors&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;go.uber.org/zap&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">var</span> <span style="color:#75af00">logger</span> <span style="color:#f92672">*</span><span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">Logger</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">init</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">logger</span><span style="color:#111">,</span> <span style="color:#75af00">_</span> <span style="color:#111">=</span> <span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">NewProduction</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">logger</span><span style="color:#111">.</span><span style="color:#75af00">Error</span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#d88200">&#34;My name is baobao&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">String</span><span style="color:#111">(</span><span style="color:#d88200">&#34;from&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Hulun Buir&#34;</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">Error</span><span style="color:#111">(</span><span style="color:#75af00">errors</span><span style="color:#111">.</span><span style="color:#75af00">New</span><span style="color:#111">(</span><span style="color:#d88200">&#34;no good&#34;</span><span style="color:#111">)))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">logger</span><span style="color:#111">.</span><span style="color:#75af00">Info</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Worked in the Ministry of national development of China!&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">String</span><span style="color:#111">(</span><span style="color:#d88200">&#34;key&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;eat🍚&#34;</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">String</span><span style="color:#111">(</span><span style="color:#d88200">&#34;key&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;sleep😴&#34;</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">logger</span><span style="color:#111">.</span><span style="color:#75af00">Sync</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="kratos-日志库原理解析">Kratos 日志库原理解析</h2>
<blockquote>
<p>在私下与 <strong>Tony老师</strong> 沟通时关于日志库的实现理念时，<strong>Tony老师</strong> 说：由于目前日志库非常多并且好用，在 <strong>Kratos</strong> 的日志中，主要考虑以下几个问题：</p>
<ol>
<li>统一日志接口设计</li>
<li>组织结构化日志</li>
<li>并且需要有友好的日志级别使用</li>
<li>支持多输出源对接需求，如log-agent 或者 3rd 日志库</li>
</ol>
</blockquote>
<p><strong>kratos</strong> 的日志库，不强制具体实现方式，只提供适配器，用户可以自行实现日志功能，只需要实现<strong>kratos/log</strong> 的 <strong>Logger interface</strong> 即可接入自己喜欢的日志系统。</p>
<p><strong>kratos</strong> 的日志库，在设计阶段，参考了很多优秀的开源项目和大厂的日志系统实现，经历了多次改动后才呈现给大家。</p>
<h3 id="log库的组成">log库的组成</h3>
<p><strong>kratos</strong> 的 <strong>log</strong> 库主要由以下几个文件组成</p>
<ul>
<li><strong>level.go</strong> 定义日志级别</li>
<li><strong>log.go</strong> 日志核心</li>
<li><strong>helper.go</strong> <strong>log</strong>的<strong>helper</strong></li>
<li><strong>value.go</strong> 实现动态值</li>
</ul>
<h3 id="源码分析">源码分析</h3>
<p><strong>kratos</strong> 的 <strong>log</strong> 库中, 核心部分就是 <strong>log.go</strong> 代码非常简洁，符合 <strong>kratos</strong> 的设计理念。 <strong>log.go</strong> 中声明了 <strong>Logger interface</strong>，用户只需要实现接口，即可引入自己的日志实现，主要代码如下：</p>
<h4 id="loggo"><strong>log.go</strong></h4>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-golang" data-lang="golang"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">log</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;context&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">var</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// DefaultLogger is default logger.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">DefaultLogger</span> <span style="color:#75af00">Logger</span> <span style="color:#111">=</span> <span style="color:#75af00">NewStdLogger</span><span style="color:#111">(</span><span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Writer</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Logger 接口, 后面实现自定义日志库的时候，就是要实现这个接口。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Logger</span> <span style="color:#00a8c8">interface</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Log</span><span style="color:#111">(</span><span style="color:#75af00">level</span> <span style="color:#75af00">Level</span><span style="color:#111">,</span> <span style="color:#75af00">keyvals</span> <span style="color:#f92672">...</span><span style="color:#00a8c8">interface</span><span style="color:#111">{})</span> <span style="color:#00a8c8">error</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">logger</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">logs</span>      <span style="color:#111">[]</span><span style="color:#75af00">Logger</span> <span style="color:#75715e">// logger 数组</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">prefix</span>    <span style="color:#111">[]</span><span style="color:#00a8c8">interface</span><span style="color:#111">{}</span> <span style="color:#75715e">// 一些默认打印的值,例如通过 With 绑定的 Valuer</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">hasValuer</span> <span style="color:#00a8c8">bool</span> <span style="color:#75715e">// 是否包含 Valuer </span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ctx</span>       <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Context</span> <span style="color:#75715e">// 上下文</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">logger</span><span style="color:#111">)</span> <span style="color:#75af00">Log</span><span style="color:#111">(</span><span style="color:#75af00">level</span> <span style="color:#75af00">Level</span><span style="color:#111">,</span> <span style="color:#75af00">keyvals</span> <span style="color:#f92672">...</span><span style="color:#00a8c8">interface</span><span style="color:#111">{})</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">kvs</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">([]</span><span style="color:#00a8c8">interface</span><span style="color:#111">{},</span> <span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">prefix</span><span style="color:#111">)</span><span style="color:#f92672">+</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">keyvals</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">kvs</span> <span style="color:#111">=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">kvs</span><span style="color:#111">,</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">prefix</span><span style="color:#f92672">...</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 判断是否存在 valuer</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">hasValuer</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// 绑定 valuer</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">bindValues</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">kvs</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">kvs</span> <span style="color:#111">=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">kvs</span><span style="color:#111">,</span> <span style="color:#75af00">keyvals</span><span style="color:#f92672">...</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 遍历 logs，调用所有的 logger 进行日志打印。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">l</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">logs</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">l</span><span style="color:#111">.</span><span style="color:#75af00">Log</span><span style="color:#111">(</span><span style="color:#75af00">level</span><span style="color:#111">,</span> <span style="color:#75af00">kvs</span><span style="color:#f92672">...</span><span style="color:#111">);</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// With with logger fields.</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">With</span><span style="color:#111">(</span><span style="color:#75af00">l</span> <span style="color:#75af00">Logger</span><span style="color:#111">,</span> <span style="color:#75af00">kv</span> <span style="color:#f92672">...</span><span style="color:#00a8c8">interface</span><span style="color:#111">{})</span> <span style="color:#75af00">Logger</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 判断是否能 把传入的 logger 断言成 *logger</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">c</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">l</span><span style="color:#111">.(</span><span style="color:#f92672">*</span><span style="color:#75af00">logger</span><span style="color:#111">);</span> <span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 预分配内存,make了一个空间长度为 c.prefix + keyvals长度的 interface数组</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">kvs</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">([]</span><span style="color:#00a8c8">interface</span><span style="color:#111">{},</span> <span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">prefix</span><span style="color:#111">)</span><span style="color:#f92672">+</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">kv</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 处理打印的内容</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">kvs</span> <span style="color:#111">=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">kvs</span><span style="color:#111">,</span> <span style="color:#75af00">kv</span><span style="color:#f92672">...</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">kvs</span> <span style="color:#111">=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">kvs</span><span style="color:#111">,</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">prefix</span><span style="color:#f92672">...</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// containsValuer()用来判断 kvs 里面是否存在 valuer</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">logger</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">logs</span><span style="color:#111">:</span>      <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">logs</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">prefix</span><span style="color:#111">:</span>    <span style="color:#75af00">kvs</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">hasValuer</span><span style="color:#111">:</span> <span style="color:#75af00">containsValuer</span><span style="color:#111">(</span><span style="color:#75af00">kvs</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">ctx</span><span style="color:#111">:</span>       <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">logger</span><span style="color:#111">{</span><span style="color:#75af00">logs</span><span style="color:#111">:</span> <span style="color:#111">[]</span><span style="color:#75af00">Logger</span><span style="color:#111">{</span><span style="color:#75af00">l</span><span style="color:#111">},</span> <span style="color:#75af00">prefix</span><span style="color:#111">:</span> <span style="color:#75af00">kv</span><span style="color:#111">,</span> <span style="color:#75af00">hasValuer</span><span style="color:#111">:</span> <span style="color:#75af00">containsValuer</span><span style="color:#111">(</span><span style="color:#75af00">kv</span><span style="color:#111">)}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// WithContext 绑定 ctx,注意 ctx 必须非空</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">WithContext</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">,</span> <span style="color:#75af00">l</span> <span style="color:#75af00">Logger</span><span style="color:#111">)</span> <span style="color:#75af00">Logger</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">c</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">l</span><span style="color:#111">.(</span><span style="color:#f92672">*</span><span style="color:#75af00">logger</span><span style="color:#111">);</span> <span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">logger</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">logs</span><span style="color:#111">:</span>      <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">logs</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">prefix</span><span style="color:#111">:</span>    <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">prefix</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">hasValuer</span><span style="color:#111">:</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">hasValuer</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">ctx</span><span style="color:#111">:</span>       <span style="color:#75af00">ctx</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">logger</span><span style="color:#111">{</span><span style="color:#75af00">logs</span><span style="color:#111">:</span> <span style="color:#111">[]</span><span style="color:#75af00">Logger</span><span style="color:#111">{</span><span style="color:#75af00">l</span><span style="color:#111">},</span> <span style="color:#75af00">ctx</span><span style="color:#111">:</span> <span style="color:#75af00">ctx</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// MultiLogger 包装多个logger，简单说就是同时使用多个logger打印</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">MultiLogger</span><span style="color:#111">(</span><span style="color:#75af00">logs</span> <span style="color:#f92672">...</span><span style="color:#75af00">Logger</span><span style="color:#111">)</span> <span style="color:#75af00">Logger</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">logger</span><span style="color:#111">{</span><span style="color:#75af00">logs</span><span style="color:#111">:</span> <span style="color:#75af00">logs</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h4 id="valuego">value.go</h4>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-golang" data-lang="golang"><span style="display:flex;"><span><span style="color:#75715e">// 返回 valuer 函数.</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">Value</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">,</span> <span style="color:#75af00">v</span> <span style="color:#00a8c8">interface</span><span style="color:#111">{})</span> <span style="color:#00a8c8">interface</span><span style="color:#111">{}</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">v</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">v</span><span style="color:#111">.(</span><span style="color:#75af00">Valuer</span><span style="color:#111">);</span> <span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">v</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">v</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// ...省略一些内置的 valuer 实现</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 绑定 valuer</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">bindValues</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">,</span> <span style="color:#75af00">keyvals</span> <span style="color:#111">[]</span><span style="color:#00a8c8">interface</span><span style="color:#111">{})</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">1</span><span style="color:#111">;</span> <span style="color:#75af00">i</span> <span style="color:#111">&lt;</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">keyvals</span><span style="color:#111">);</span> <span style="color:#75af00">i</span> <span style="color:#f92672">+=</span> <span style="color:#ae81ff">2</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">v</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">keyvals</span><span style="color:#111">[</span><span style="color:#75af00">i</span><span style="color:#111">].(</span><span style="color:#75af00">Valuer</span><span style="color:#111">);</span> <span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">keyvals</span><span style="color:#111">[</span><span style="color:#75af00">i</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#75af00">v</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 是否包含 valuer</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">containsValuer</span><span style="color:#111">(</span><span style="color:#75af00">keyvals</span> <span style="color:#111">[]</span><span style="color:#00a8c8">interface</span><span style="color:#111">{})</span> <span style="color:#00a8c8">bool</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">1</span><span style="color:#111">;</span> <span style="color:#75af00">i</span> <span style="color:#111">&lt;</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">keyvals</span><span style="color:#111">);</span> <span style="color:#75af00">i</span> <span style="color:#f92672">+=</span> <span style="color:#ae81ff">2</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">keyvals</span><span style="color:#111">[</span><span style="color:#75af00">i</span><span style="color:#111">].(</span><span style="color:#75af00">Valuer</span><span style="color:#111">);</span> <span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">true</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">false</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h4 id="helpergo">helper.go</h4>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-golang" data-lang="golang"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">log</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;context&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Helper is a logger helper.</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Helper</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">logger</span> <span style="color:#75af00">Logger</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 创建一个 logger helper 实例</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">NewHelper</span><span style="color:#111">(</span><span style="color:#75af00">logger</span> <span style="color:#75af00">Logger</span><span style="color:#111">)</span> <span style="color:#f92672">*</span><span style="color:#75af00">Helper</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">Helper</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">logger</span><span style="color:#111">:</span> <span style="color:#75af00">logger</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 通过 WithContext() 返回包含 ctx 的一个日志的帮助类，包含一些定义好的按级别打印日志的方法</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">h</span> <span style="color:#f92672">*</span><span style="color:#75af00">Helper</span><span style="color:#111">)</span> <span style="color:#75af00">WithContext</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#f92672">*</span><span style="color:#75af00">Helper</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">Helper</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">logger</span><span style="color:#111">:</span> <span style="color:#75af00">WithContext</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">logger</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">h</span> <span style="color:#f92672">*</span><span style="color:#75af00">Helper</span><span style="color:#111">)</span> <span style="color:#75af00">Log</span><span style="color:#111">(</span><span style="color:#75af00">level</span> <span style="color:#75af00">Level</span><span style="color:#111">,</span> <span style="color:#75af00">keyvals</span> <span style="color:#f92672">...</span><span style="color:#00a8c8">interface</span><span style="color:#111">{})</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">logger</span><span style="color:#111">.</span><span style="color:#75af00">Log</span><span style="color:#111">(</span><span style="color:#75af00">level</span><span style="color:#111">,</span> <span style="color:#75af00">keyvals</span><span style="color:#f92672">...</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">h</span> <span style="color:#f92672">*</span><span style="color:#75af00">Helper</span><span style="color:#111">)</span> <span style="color:#75af00">Debug</span><span style="color:#111">(</span><span style="color:#75af00">a</span> <span style="color:#f92672">...</span><span style="color:#00a8c8">interface</span><span style="color:#111">{})</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">logger</span><span style="color:#111">.</span><span style="color:#75af00">Log</span><span style="color:#111">(</span><span style="color:#75af00">LevelDebug</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;msg&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Sprint</span><span style="color:#111">(</span><span style="color:#75af00">a</span><span style="color:#f92672">...</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">h</span> <span style="color:#f92672">*</span><span style="color:#75af00">Helper</span><span style="color:#111">)</span> <span style="color:#75af00">Debugf</span><span style="color:#111">(</span><span style="color:#75af00">format</span> <span style="color:#00a8c8">string</span><span style="color:#111">,</span> <span style="color:#75af00">a</span> <span style="color:#f92672">...</span><span style="color:#00a8c8">interface</span><span style="color:#111">{})</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">logger</span><span style="color:#111">.</span><span style="color:#75af00">Log</span><span style="color:#111">(</span><span style="color:#75af00">LevelDebug</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;msg&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Sprintf</span><span style="color:#111">(</span><span style="color:#75af00">format</span><span style="color:#111">,</span> <span style="color:#75af00">a</span><span style="color:#f92672">...</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// ...省略一些重复的方法</span>
</span></span></code></pre></div><h4 id="通过单元测试了解调用逻辑">通过单元测试了解调用逻辑</h4>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-golang" data-lang="golang"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">TestInfo</span><span style="color:#111">(</span><span style="color:#75af00">t</span> <span style="color:#f92672">*</span><span style="color:#75af00">testing</span><span style="color:#111">.</span><span style="color:#75af00">T</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">logger</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">DefaultLogger</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">logger</span> <span style="color:#111">=</span> <span style="color:#75af00">With</span><span style="color:#111">(</span><span style="color:#75af00">logger</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;ts&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">DefaultTimestamp</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;caller&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">DefaultCaller</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">logger</span><span style="color:#111">.</span><span style="color:#75af00">Log</span><span style="color:#111">(</span><span style="color:#75af00">LevelInfo</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;key1&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;value1&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><ol>
<li>单测中首先声明了一个 <strong>logger</strong> ，用的默认的 <strong>DefaultLogger</strong></li>
<li>调用 <strong>log.go</strong> 中的 <strong>With()</strong> 函数， 传入了 <strong>logger</strong> ,和两个动态值， <strong>DefaultTimestamp</strong> 和 <strong>DefaultCaller</strong>。</li>
<li>With方法被调用，判断是否能将参数 <strong>l</strong> 类型转换成 <strong>*logger</strong></li>
<li>如果可以转换，将传入的KV，赋值给 <strong>logger.prefix</strong> 上，然后调用 <strong>value.go</strong> 中的 <strong>containsValuer()</strong> 判断传入的KV中是否存在 Valuer类型的值，将结果赋值给 <strong>context.hasValuer</strong>，最后返回 <strong>Logger</strong> 对象</li>
<li>否则则直接返回一个 <strong>&amp;logger{logs: []Logger{l}, prefix: kv, hasValuer: containsValuer(kv)}</strong></li>
<li>然后打印日志时，<strong>logger struct</strong> 的 <strong>Log</strong> 方法被调用</li>
<li><strong>Log()</strong> 方法首先预分配了 <strong>keyvals</strong> 的空间，然后判断 <strong>hasValuer</strong>，如果为 <strong>true</strong>，则调用 <strong>valuer.go</strong> 中的 <strong>bindValuer()</strong> 并传入了 <strong>ctx</strong> 然后获取 <strong>valuer</strong> 的值<code>if v, ok := v.(Valuer); ok { return v() }</code></li>
</ol>
<p>8.最后遍历 <strong>logger.logs</strong> 打印日志</p>
<h2 id="使用方法">使用方法</h2>
<h3 id="使用-logger-打印日志">使用 Logger 打印日志</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">logger</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">DefaultLogger</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">logger</span><span style="color:#111">.</span><span style="color:#75af00">Log</span><span style="color:#111">(</span><span style="color:#75af00">LevelInfo</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;key1&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;value1&#34;</span><span style="color:#111">)</span>
</span></span></code></pre></div><h3 id="使用-helper-打印日志">使用 Helper 打印日志</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">log</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">NewHelper</span><span style="color:#111">(</span><span style="color:#75af00">DefaultLogger</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Debug</span><span style="color:#111">(</span><span style="color:#d88200">&#34;test debug&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Info</span><span style="color:#111">(</span><span style="color:#d88200">&#34;test info&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Warn</span><span style="color:#111">(</span><span style="color:#d88200">&#34;test warn&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Error</span><span style="color:#111">(</span><span style="color:#d88200">&#34;test error&#34;</span><span style="color:#111">)</span>
</span></span></code></pre></div><h3 id="使用-valuer">使用 valuer</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">logger</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">DefaultLogger</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">logger</span> <span style="color:#111">=</span> <span style="color:#75af00">With</span><span style="color:#111">(</span><span style="color:#75af00">logger</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;ts&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">DefaultTimestamp</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;caller&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">DefaultCaller</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">logger</span><span style="color:#111">.</span><span style="color:#75af00">Log</span><span style="color:#111">(</span><span style="color:#75af00">LevelInfo</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;msg&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;helloworld&#34;</span><span style="color:#111">)</span>
</span></span></code></pre></div><h3 id="同时打印多个-logger">同时打印多个 logger</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">out</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">NewStdLogger</span><span style="color:#111">(</span><span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">Stdout</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">NewStdLogger</span><span style="color:#111">(</span><span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">Stderr</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">l</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">With</span><span style="color:#111">(</span><span style="color:#75af00">MultiLogger</span><span style="color:#111">(</span><span style="color:#75af00">out</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">l</span><span style="color:#111">.</span><span style="color:#75af00">Log</span><span style="color:#111">(</span><span style="color:#75af00">LevelInfo</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;msg&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;test&#34;</span><span style="color:#111">)</span>
</span></span></code></pre></div><h3 id="使用-context">使用 context</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">logger</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">With</span><span style="color:#111">(</span><span style="color:#75af00">NewStdLogger</span><span style="color:#111">(</span><span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">Stdout</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;trace&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">Trace</span><span style="color:#111">(),</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">log</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">NewHelper</span><span style="color:#111">(</span><span style="color:#75af00">logger</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">ctx</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">WithValue</span><span style="color:#111">(</span><span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Background</span><span style="color:#111">(),</span> <span style="color:#d88200">&#34;trace_id&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;2233&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">WithContext</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">).</span><span style="color:#75af00">Info</span><span style="color:#111">(</span><span style="color:#d88200">&#34;got trace!&#34;</span><span style="color:#111">)</span>
</span></span></code></pre></div><h3 id="使用-filter-过滤日志">使用 filter 过滤日志</h3>
<p>如果需要过滤日志中某些不应该被打印明文的字段如 password 等，可以通过 log.NewFilter() 来实现过滤功能。</p>
<h4 id="通过-level-过滤日志">通过 level 过滤日志</h4>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">l</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">NewHelper</span><span style="color:#111">(</span><span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">NewFilter</span><span style="color:#111">(</span><span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">DefaultLogger</span><span style="color:#111">,</span> <span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">FilterLevel</span><span style="color:#111">(</span><span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">LevelWarn</span><span style="color:#111">)))</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">l</span><span style="color:#111">.</span><span style="color:#75af00">Log</span><span style="color:#111">(</span><span style="color:#75af00">LevelDebug</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;msg1&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;te1st debug&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">l</span><span style="color:#111">.</span><span style="color:#75af00">Debug</span><span style="color:#111">(</span><span style="color:#d88200">&#34;test debug&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">l</span><span style="color:#111">.</span><span style="color:#75af00">Debugf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;test %s&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;debug&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">l</span><span style="color:#111">.</span><span style="color:#75af00">Debugw</span><span style="color:#111">(</span><span style="color:#d88200">&#34;log&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;test debug&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">l</span><span style="color:#111">.</span><span style="color:#75af00">Warn</span><span style="color:#111">(</span><span style="color:#d88200">&#34;warn log&#34;</span><span style="color:#111">)</span>
</span></span></code></pre></div><h4 id="通过-key-过滤日志">通过 key 过滤日志</h4>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">l</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">NewHelper</span><span style="color:#111">(</span><span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">NewFilter</span><span style="color:#111">(</span><span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">DefaultLogger</span><span style="color:#111">,</span> <span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">FilterKey</span><span style="color:#111">(</span><span style="color:#d88200">&#34;password&#34;</span><span style="color:#111">)))</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">l</span><span style="color:#111">.</span><span style="color:#75af00">Debugw</span><span style="color:#111">(</span><span style="color:#d88200">&#34;password&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;123456&#34;</span><span style="color:#111">)</span>
</span></span></code></pre></div><h5 id="通过-value-过滤日志">通过 value 过滤日志</h5>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">l</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">NewHelper</span><span style="color:#111">(</span><span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">NewFilter</span><span style="color:#111">(</span><span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">DefaultLogger</span><span style="color:#111">,</span> <span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">FilterValue</span><span style="color:#111">(</span><span style="color:#d88200">&#34;kratos&#34;</span><span style="color:#111">)))</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">l</span><span style="color:#111">.</span><span style="color:#75af00">Debugw</span><span style="color:#111">(</span><span style="color:#d88200">&#34;name&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;kratos&#34;</span><span style="color:#111">)</span>
</span></span></code></pre></div><h4 id="通过-hook-func-过滤日志">通过 hook func 过滤日志</h4>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">l</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">NewHelper</span><span style="color:#111">(</span><span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">NewFilter</span><span style="color:#111">(</span><span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">DefaultLogger</span><span style="color:#111">,</span> <span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">FilterFunc</span><span style="color:#111">(</span><span style="color:#75af00">testFilterFunc</span><span style="color:#111">)))</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">l</span><span style="color:#111">.</span><span style="color:#75af00">Debug</span><span style="color:#111">(</span><span style="color:#d88200">&#34;debug level&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">l</span><span style="color:#111">.</span><span style="color:#75af00">Infow</span><span style="color:#111">(</span><span style="color:#d88200">&#34;password&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;123456&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">testFilterFunc</span><span style="color:#111">(</span><span style="color:#75af00">level</span> <span style="color:#75af00">Level</span><span style="color:#111">,</span> <span style="color:#75af00">keyvals</span> <span style="color:#f92672">...</span><span style="color:#00a8c8">interface</span><span style="color:#111">{})</span> <span style="color:#00a8c8">bool</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">level</span> <span style="color:#f92672">==</span> <span style="color:#75af00">LevelWarn</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">true</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span><span style="color:#111">;</span> <span style="color:#75af00">i</span> <span style="color:#111">&lt;</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">keyvals</span><span style="color:#111">);</span> <span style="color:#75af00">i</span><span style="color:#f92672">++</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">keyvals</span><span style="color:#111">[</span><span style="color:#75af00">i</span><span style="color:#111">]</span> <span style="color:#f92672">==</span> <span style="color:#d88200">&#34;password&#34;</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">keyvals</span><span style="color:#111">[</span><span style="color:#75af00">i</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;***&#34;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">false</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="用-zap-实现-kratos-的日志接口">用 Zap 实现 kratos 的日志接口</h2>
<p>实现的代码十分简单，仅有不到100 行代码，仅供大家参考。</p>
<h3 id="实现">实现</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-golang" data-lang="golang"><span style="display:flex;"><span><span style="color:#75715e">// kratos/examples/log/zap.go</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">logger</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#d88200">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;github.com/go-kratos/kratos/v2/log&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;go.uber.org/zap&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;go.uber.org/zap/zapcore&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;gopkg.in/natefinch/lumberjack.v2&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">var</span> <span style="color:#75af00">_</span> <span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Logger</span> <span style="color:#111">=</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">ZapLogger</span><span style="color:#111">)(</span><span style="color:#00a8c8">nil</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Zap 结构体</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">ZapLogger</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">log</span>  <span style="color:#f92672">*</span><span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">Logger</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Sync</span> <span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#00a8c8">error</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 创建一个 ZapLogger 实例</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">NewZapLogger</span><span style="color:#111">(</span><span style="color:#75af00">encoder</span> <span style="color:#75af00">zapcore</span><span style="color:#111">.</span><span style="color:#75af00">EncoderConfig</span><span style="color:#111">,</span> <span style="color:#75af00">level</span> <span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">AtomicLevel</span><span style="color:#111">,</span> <span style="color:#75af00">opts</span> <span style="color:#f92672">...</span><span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">Option</span><span style="color:#111">)</span> <span style="color:#f92672">*</span><span style="color:#75af00">ZapLogger</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">writeSyncer</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">getLogWriter</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 设置 zapcore</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">core</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">zapcore</span><span style="color:#111">.</span><span style="color:#75af00">NewCore</span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">zapcore</span><span style="color:#111">.</span><span style="color:#75af00">NewConsoleEncoder</span><span style="color:#111">(</span><span style="color:#75af00">encoder</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">zapcore</span><span style="color:#111">.</span><span style="color:#75af00">NewMultiWriteSyncer</span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">zapcore</span><span style="color:#111">.</span><span style="color:#75af00">AddSync</span><span style="color:#111">(</span><span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">Stdout</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">),</span> <span style="color:#75af00">level</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//  new 一个 *zap.Logger</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">zapLogger</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">New</span><span style="color:#111">(</span><span style="color:#75af00">core</span><span style="color:#111">,</span> <span style="color:#75af00">opts</span><span style="color:#f92672">...</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">ZapLogger</span><span style="color:#111">{</span><span style="color:#75af00">log</span><span style="color:#111">:</span> <span style="color:#75af00">zapLogger</span><span style="color:#111">,</span> <span style="color:#75af00">Sync</span><span style="color:#111">:</span> <span style="color:#75af00">zapLogger</span><span style="color:#111">.</span><span style="color:#75af00">Sync</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Log 方法实现了 kratos/log/log.go 中的 Logger interface</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">l</span> <span style="color:#f92672">*</span><span style="color:#75af00">ZapLogger</span><span style="color:#111">)</span> <span style="color:#75af00">Log</span><span style="color:#111">(</span><span style="color:#75af00">level</span> <span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Level</span><span style="color:#111">,</span> <span style="color:#75af00">keyvals</span> <span style="color:#f92672">...</span><span style="color:#00a8c8">interface</span><span style="color:#111">{})</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">keyvals</span><span style="color:#111">)</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">||</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">keyvals</span><span style="color:#111">)</span><span style="color:#f92672">%</span><span style="color:#ae81ff">2</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        	<span style="color:#75af00">l</span><span style="color:#111">.</span><span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Warn</span><span style="color:#111">(</span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Sprint</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Keyvalues must appear in pairs: &#34;</span><span style="color:#111">,</span> <span style="color:#75af00">keyvals</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 按照 KV 传入的时候,使用的 zap.Field</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">var</span> <span style="color:#75af00">data</span> <span style="color:#111">[]</span><span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">Field</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span><span style="color:#111">;</span> <span style="color:#75af00">i</span> <span style="color:#111">&lt;</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">keyvals</span><span style="color:#111">);</span> <span style="color:#75af00">i</span> <span style="color:#f92672">+=</span> <span style="color:#ae81ff">2</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">data</span> <span style="color:#111">=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">data</span><span style="color:#111">,</span> <span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">Any</span><span style="color:#111">(</span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Sprint</span><span style="color:#111">(</span><span style="color:#75af00">keyvals</span><span style="color:#111">[</span><span style="color:#75af00">i</span><span style="color:#111">]),</span> <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Sprint</span><span style="color:#111">(</span><span style="color:#75af00">keyvals</span><span style="color:#111">[</span><span style="color:#75af00">i</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span><span style="color:#111">])))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">switch</span> <span style="color:#75af00">level</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">case</span> <span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">LevelDebug</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">l</span><span style="color:#111">.</span><span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Debug</span><span style="color:#111">(</span><span style="color:#d88200">&#34;&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">data</span><span style="color:#f92672">...</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">case</span> <span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">LevelInfo</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">l</span><span style="color:#111">.</span><span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Info</span><span style="color:#111">(</span><span style="color:#d88200">&#34;&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">data</span><span style="color:#f92672">...</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">case</span> <span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">LevelWarn</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">l</span><span style="color:#111">.</span><span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Warn</span><span style="color:#111">(</span><span style="color:#d88200">&#34;&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">data</span><span style="color:#f92672">...</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">case</span> <span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">LevelError</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">l</span><span style="color:#111">.</span><span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Error</span><span style="color:#111">(</span><span style="color:#d88200">&#34;&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">data</span><span style="color:#f92672">...</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 日志自动切割，采用 lumberjack 实现的</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">getLogWriter</span><span style="color:#111">()</span> <span style="color:#75af00">zapcore</span><span style="color:#111">.</span><span style="color:#75af00">WriteSyncer</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">lumberJackLogger</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">lumberjack</span><span style="color:#111">.</span><span style="color:#75af00">Logger</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">Filename</span><span style="color:#111">:</span>   <span style="color:#d88200">&#34;./test.log&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">MaxSize</span><span style="color:#111">:</span>    <span style="color:#ae81ff">10</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">MaxBackups</span><span style="color:#111">:</span> <span style="color:#ae81ff">5</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">MaxAge</span><span style="color:#111">:</span>     <span style="color:#ae81ff">30</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">Compress</span><span style="color:#111">:</span>   <span style="color:#00a8c8">false</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">zapcore</span><span style="color:#111">.</span><span style="color:#75af00">AddSync</span><span style="color:#111">(</span><span style="color:#75af00">lumberJackLogger</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="使用方法-1">使用方法</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-golang" data-lang="golang"><span style="display:flex;"><span><span style="color:#75715e">// kratos/examples/log/zap_test.go</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">logger</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;testing&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;github.com/go-kratos/kratos/v2/log&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;go.uber.org/zap&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;go.uber.org/zap/zapcore&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">TestZapLogger</span><span style="color:#111">(</span><span style="color:#75af00">t</span> <span style="color:#f92672">*</span><span style="color:#75af00">testing</span><span style="color:#111">.</span><span style="color:#75af00">T</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">encoder</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">zapcore</span><span style="color:#111">.</span><span style="color:#75af00">EncoderConfig</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">TimeKey</span><span style="color:#111">:</span>        <span style="color:#d88200">&#34;t&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">LevelKey</span><span style="color:#111">:</span>       <span style="color:#d88200">&#34;level&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">NameKey</span><span style="color:#111">:</span>        <span style="color:#d88200">&#34;logger&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">CallerKey</span><span style="color:#111">:</span>      <span style="color:#d88200">&#34;caller&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">MessageKey</span><span style="color:#111">:</span>     <span style="color:#d88200">&#34;msg&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">StacktraceKey</span><span style="color:#111">:</span>  <span style="color:#d88200">&#34;stack&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">EncodeTime</span><span style="color:#111">:</span>     <span style="color:#75af00">zapcore</span><span style="color:#111">.</span><span style="color:#75af00">ISO8601TimeEncoder</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">LineEnding</span><span style="color:#111">:</span>     <span style="color:#75af00">zapcore</span><span style="color:#111">.</span><span style="color:#75af00">DefaultLineEnding</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">EncodeLevel</span><span style="color:#111">:</span>    <span style="color:#75af00">zapcore</span><span style="color:#111">.</span><span style="color:#75af00">LowercaseLevelEncoder</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">EncodeDuration</span><span style="color:#111">:</span> <span style="color:#75af00">zapcore</span><span style="color:#111">.</span><span style="color:#75af00">SecondsDurationEncoder</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">EncodeCaller</span><span style="color:#111">:</span>   <span style="color:#75af00">zapcore</span><span style="color:#111">.</span><span style="color:#75af00">FullCallerEncoder</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">logger</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">NewZapLogger</span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">encoder</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">NewAtomicLevelAt</span><span style="color:#111">(</span><span style="color:#75af00">zapcore</span><span style="color:#111">.</span><span style="color:#75af00">DebugLevel</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">AddStacktrace</span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">NewAtomicLevelAt</span><span style="color:#111">(</span><span style="color:#75af00">zapcore</span><span style="color:#111">.</span><span style="color:#75af00">ErrorLevel</span><span style="color:#111">)),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">AddCallerSkip</span><span style="color:#111">(</span><span style="color:#ae81ff">2</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">Development</span><span style="color:#111">(),</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">zlog</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">NewHelper</span><span style="color:#111">(</span><span style="color:#75af00">logger</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">zlog</span><span style="color:#111">.</span><span style="color:#75af00">Infow</span><span style="color:#111">(</span><span style="color:#d88200">&#34;name&#34;</span><span style="color:#111">,</span><span style="color:#d88200">&#34;go 语言进阶&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">logger</span><span style="color:#111">.</span><span style="color:#75af00">Sync</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="参考文献">参考文献</h2>
<ul>
<li>关于 log 库的讨论 <a href="https://github.com/go-kratos/kratos/issues/882">issue</a></li>
<li>Uber 的日志库 Zap <a href="https://github.com/uber-go/zap">uber/zap</a></li>
<li>日志割接库 <a href="https://github.com/natefinch/lumberjack">lumberjack</a></li>
<li>基于 zap 的日志demo <a href="https://github.com/go-kratos/kratos/tree/main/examples/log">log example </a></li>
</ul>
<p><img src="/images/df29de7c-11e2-4f40-94b1-699617bbc438.png" alt=""></p>
]]></content:encoded><category>kratos</category><category>go</category><category>kratos</category></item></channel></rss>