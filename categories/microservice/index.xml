<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/"><channel><title>Microservice on Daemon365</title><link>https://daemon365.dev/categories/microservice/</link><description>Don't let yourself stop.</description><generator>Hugo -- gohugo.io</generator><language>zh-cn</language><lastBuildDate>Sun, 25 Dec 2022 00:00:00 +0800</lastBuildDate><atom:link href="https://daemon365.dev/categories/microservice/index.xml" rel="self" type="application/rss+xml"/><item><title>隔离</title><link>https://daemon365.dev/post/microservice/isolation/</link><pubDate>Sun, 25 Dec 2022 00:00:00 +0800</pubDate><guid>https://daemon365.dev/post/microservice/isolation/</guid><description>&lt;h2 id="什么是隔离"&gt;什么是隔离？&lt;/h2&gt;
&lt;p&gt;隔离，本质上是对系统或资源进行分割，从而实现当系统发生故障时能限定传播范围和影响范围，即发生故障后只有出问题的服务不可用，保证其他服务仍然可用。&lt;/p&gt;
&lt;p&gt;&lt;img src="https://daemon365.dev/images/bc26357f-7699-40e1-b00e-4ca4996b5e85.png" alt=""&gt;&lt;/p&gt;
&lt;h2 id="服务隔离"&gt;服务隔离&lt;/h2&gt;
&lt;h2 id="动静隔离"&gt;动静隔离&lt;/h2&gt;
&lt;p&gt;例如 CDN&lt;/p&gt;
&lt;p&gt;小到 CPU 的 cacheline false sharing、数据库 mysql 表设计中避免 bufferpool 频繁过期，隔离动静表，大到架构设计中的图片、静态资源等缓存加速。本质上都体现的一样的思路，即加速/缓存访问变换频次小的。比如 CDN 场景中，将静态资源和动态 API 分离，也是体现了隔离的思路:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;降低应用服务器负载，静态文件访问负载全部通过CDN。&lt;/li&gt;
&lt;li&gt;对象存储存储费用最低。&lt;/li&gt;
&lt;li&gt;海量存储空间，无需考虑存储架构升级。&lt;/li&gt;
&lt;li&gt;静态CDN带宽加速，延迟低。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img src="https://daemon365.dev/images/583bfe49-86ce-4e4b-b7b1-fef33a6a9ae8.png" alt=""&gt;&lt;/p&gt;
&lt;p&gt;archive: 稿件表，存储稿件的名称、作者、分类、tag、状态等信息，表示稿件的基本信息。 在一个投稿流程中，一旦稿件创建改动的频率比较低。 archive_stat: 稿件统计表，表示稿件的播放、点赞、收藏、投币数量，比较高频的更新。 随着稿件获取流量，稿件被用户所消费，各类计数信息更新比较频繁。 MySQL BufferPool 是用于缓存 DataPage 的，DataPage 可以理解为缓存了表的行，那么如果频繁更新 DataPage 不断会置换，会导致命中率下降的问题，所以我们在表设计中，仍然可以沿用类似的思路，其主表基本更新，在上游 Cache 未命中，透穿到 MySQL，仍然有 BufferPool 的缓存。&lt;/p&gt;
&lt;h3 id="读写隔离"&gt;读写隔离&lt;/h3&gt;
&lt;p&gt;例如主从，除此之外还有常见的 CQRS 模式，分库分表等&lt;/p&gt;
&lt;p&gt;常见的隔离技术，当用于读取操作的服务器出现故障时，写服务器照常可以运作，反之也一样。&lt;/p&gt;
&lt;h2 id="轻重隔离"&gt;轻重隔离&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;核心隔离：例如上面讲到将核心业务独立部署，非核心业务共享资源&lt;/li&gt;
&lt;li&gt;热点隔离：例如上面讲到的 remote cache 到 local cache&lt;/li&gt;
&lt;li&gt;用户隔离：不同的用户可能有不同的级别，例如上面讲到的外部用户和管理员&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="物理隔离"&gt;物理隔离&lt;/h2&gt;
&lt;h3 id="线程"&gt;线程&lt;/h3&gt;
&lt;p&gt;常见的例子就是线程池，这个在 Golang 中一般不用过多考虑，runtime 已经帮我们管理好了&lt;/p&gt;
&lt;p&gt;主要通过线程池进行隔离，也是实现服务隔离的基础。（可将图中隔离媒介换成线程池即可）&lt;/p&gt;
&lt;p&gt;把业务进行分类并交给不同的线程池进行处理，当某个线程池处理一种业务请求发生问题时，不会讲故障扩散和影响到其他线程池，保证服务可用。&lt;/p&gt;
&lt;p&gt;假设系统存在商品服务、用户服务和订单服务3个微服务，通过设置运行时环境得到3个服务一共使用200个线程，客户端调用这3个微服务共享线程池时可能会引发服务雪崩，将线程分别隔离后则不会触发整体雪崩。&lt;/p&gt;
&lt;p&gt;&lt;img src="https://daemon365.dev/images/76ca5d29-3442-44ce-a408-98d5f89de10b.png" alt=""&gt;&lt;/p&gt;
&lt;h3 id="进程"&gt;进程&lt;/h3&gt;
&lt;p&gt;我们现在一般使用容器化服务，跑在 k8s 上这就是一种进程级别的隔离&lt;/p&gt;</description><content:encoded><![CDATA[<h2 id="什么是隔离">什么是隔离？</h2>
<p>隔离，本质上是对系统或资源进行分割，从而实现当系统发生故障时能限定传播范围和影响范围，即发生故障后只有出问题的服务不可用，保证其他服务仍然可用。</p>
<p><img src="/images/bc26357f-7699-40e1-b00e-4ca4996b5e85.png" alt=""></p>
<h2 id="服务隔离">服务隔离</h2>
<h2 id="动静隔离">动静隔离</h2>
<p>例如 CDN</p>
<p>小到 CPU 的 cacheline false sharing、数据库 mysql 表设计中避免 bufferpool 频繁过期，隔离动静表，大到架构设计中的图片、静态资源等缓存加速。本质上都体现的一样的思路，即加速/缓存访问变换频次小的。比如 CDN 场景中，将静态资源和动态 API 分离，也是体现了隔离的思路:</p>
<ul>
<li>降低应用服务器负载，静态文件访问负载全部通过CDN。</li>
<li>对象存储存储费用最低。</li>
<li>海量存储空间，无需考虑存储架构升级。</li>
<li>静态CDN带宽加速，延迟低。</li>
</ul>
<p><img src="/images/583bfe49-86ce-4e4b-b7b1-fef33a6a9ae8.png" alt=""></p>
<p>archive: 稿件表，存储稿件的名称、作者、分类、tag、状态等信息，表示稿件的基本信息。 在一个投稿流程中，一旦稿件创建改动的频率比较低。 archive_stat: 稿件统计表，表示稿件的播放、点赞、收藏、投币数量，比较高频的更新。 随着稿件获取流量，稿件被用户所消费，各类计数信息更新比较频繁。 MySQL BufferPool 是用于缓存 DataPage 的，DataPage 可以理解为缓存了表的行，那么如果频繁更新 DataPage 不断会置换，会导致命中率下降的问题，所以我们在表设计中，仍然可以沿用类似的思路，其主表基本更新，在上游 Cache 未命中，透穿到 MySQL，仍然有 BufferPool 的缓存。</p>
<h3 id="读写隔离">读写隔离</h3>
<p>例如主从，除此之外还有常见的 CQRS 模式，分库分表等</p>
<p>常见的隔离技术，当用于读取操作的服务器出现故障时，写服务器照常可以运作，反之也一样。</p>
<h2 id="轻重隔离">轻重隔离</h2>
<ul>
<li>核心隔离：例如上面讲到将核心业务独立部署，非核心业务共享资源</li>
<li>热点隔离：例如上面讲到的 remote cache 到 local cache</li>
<li>用户隔离：不同的用户可能有不同的级别，例如上面讲到的外部用户和管理员</li>
</ul>
<h2 id="物理隔离">物理隔离</h2>
<h3 id="线程">线程</h3>
<p>常见的例子就是线程池，这个在 Golang 中一般不用过多考虑，runtime 已经帮我们管理好了</p>
<p>主要通过线程池进行隔离，也是实现服务隔离的基础。（可将图中隔离媒介换成线程池即可）</p>
<p>把业务进行分类并交给不同的线程池进行处理，当某个线程池处理一种业务请求发生问题时，不会讲故障扩散和影响到其他线程池，保证服务可用。</p>
<p>假设系统存在商品服务、用户服务和订单服务3个微服务，通过设置运行时环境得到3个服务一共使用200个线程，客户端调用这3个微服务共享线程池时可能会引发服务雪崩，将线程分别隔离后则不会触发整体雪崩。</p>
<p><img src="/images/76ca5d29-3442-44ce-a408-98d5f89de10b.png" alt=""></p>
<h3 id="进程">进程</h3>
<p>我们现在一般使用容器化服务，跑在 k8s 上这就是一种进程级别的隔离</p>
<p>将系统拆分为多个子系统来实现物理隔离，各个子系统运行在独立的容器和JVM中，通过进程隔离使得一个子系统出现问题不会影响其他子系统。</p>
<h3 id="机房">机房</h3>
<p>我们目前在 K8s 的基础上做一些开发，常见的一种做法就是将我们的服务的不同副本尽量的分配在不同的可用区，实际上就是云厂商的不同机房，避免机房停电或者着火之类的影响</p>
<p>如果有条件，对于大型高可用系统，会进行多机房部署，每个机房的服务都有自己的服务分组，本机房的服务应该只调用同机房服务。</p>
<p>当一个机房出现故障，将请求快速切换到其他机房确保服务继续可用。</p>
<h3 id="集群">集群</h3>
<p>非常重要的服务我们可以部署多套，在物理上进行隔离，常见的有异地部署，也可能就部署在同一个区域</p>
<p>将某些服务单独部署成集群，或对于某些服务可以进行分组集群管理，某一个集群出现问题之后就不会影响到其他集群，从而实现隔离。</p>
<p><img src="/images/adca81f8-c0a6-4ce2-9db3-025e103763d1.png" alt=""></p>
<h2 id="参考文章">参考文章</h2>
<ul>
<li><a href="https://blog.csdn.net/xiaofeng10330111/article/details/86772740">https://blog.csdn.net/xiaofeng10330111/article/details/86772740</a></li>
<li><a href="https://lailin.xyz/post/go-training-week6-usability-1-bulkhe.html">https://lailin.xyz/post/go-training-week6-usability-1-bulkhe.html</a></li>
</ul>
]]></content:encoded><category>microservice</category><category>go</category><category>grpc</category></item><item><title>限流</title><link>https://daemon365.dev/post/microservice/current_limitation/</link><pubDate>Sat, 24 Dec 2022 00:00:00 +0800</pubDate><guid>https://daemon365.dev/post/microservice/current_limitation/</guid><description>&lt;h2 id="令牌桶算法"&gt;令牌桶算法&lt;/h2&gt;
&lt;p&gt;是一个存放固定容量令牌的桶，按照固定速率往桶里添加令牌。令牌桶算法的描述如下：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;假设限制2r/s，则按照500毫秒的固定速率往桶中添加令牌。&lt;/li&gt;
&lt;li&gt;桶中最多存放 b 个令牌，当桶满时，新添加的令牌被丢弃或拒绝。&lt;/li&gt;
&lt;li&gt;当一个 n 个字节大小的数据包到达，将从桶中删除n 个令牌，接着数据包被发送到网络上。&lt;/li&gt;
&lt;li&gt;如果桶中的令牌不足 n 个，则不会删除令牌，且该数据包将被限流（要么丢弃，要么缓冲区等待）。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;令牌桶速率限制算法: &lt;code&gt;golang.org/x/time/rate&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src="https://daemon365.dev/images/51a3b153-ddc8-4d86-93e4-5610b49bcf96.png" alt=""&gt;&lt;/p&gt;
&lt;h2 id="漏桶算法"&gt;漏桶算法&lt;/h2&gt;
&lt;p&gt;作为计量工具(The Leaky Bucket Algorithm as a Meter)时，可以用于流量整形(Traffic Shaping)和流量控制(TrafficPolicing)，漏桶算法的描述如下：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;一个固定容量的漏桶，按照常量固定速率流出水滴。&lt;/li&gt;
&lt;li&gt;如果桶是空的，则不需流出水滴。&lt;/li&gt;
&lt;li&gt;可以以任意速率流入水滴到漏桶。&lt;/li&gt;
&lt;li&gt;如果流入水滴超出了桶的容量，则流入的水滴溢出了（被丢弃），而漏桶容量是不变的。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;漏桶率限制算法: go.uber.org/ratelimit&lt;/p&gt;
&lt;p&gt;&lt;img src="https://daemon365.dev/images/3359127c-5aa1-42e5-bb12-c1f59880c50f.png" alt=""&gt;&lt;/p&gt;
&lt;h2 id="过载保护"&gt;过载保护&lt;/h2&gt;
&lt;h3 id="令牌桶与漏桶的缺点"&gt;令牌桶与漏桶的缺点&lt;/h3&gt;
&lt;p&gt;漏斗桶/令牌桶确实能够保护系统不被拖垮, 但不管漏斗桶还是令牌桶, 其防护思路都是设定一个指标, 当超过该指标后就阻止或减少流量的继续进入，当系统负载降低到某一水平后则恢复流量的进入。但其通常都是被动的，其实际效果取决于限流阈值设置是否合理，但往往设置合理不是一件容易的事情。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;集群增加机器或者减少机器限流阈值是否要重新设置?&lt;/li&gt;
&lt;li&gt;设置限流阈值的依据是什么?&lt;/li&gt;
&lt;li&gt;人力运维成本是否过高?&lt;/li&gt;
&lt;li&gt;当调用方反馈429时, 这个时候重新设置限流, 其实流量高峰已经过了重新评估限流是否有意义?&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;这些其实都是采用漏斗桶/令牌桶的缺点, 总体来说就是太被动, 不能快速适应流量变化。
因此我们需要一种自适应的限流算法，即: 过载保护，根据系统当前的负载自动丢弃流量。&lt;/p&gt;
&lt;h3 id="过载保护方法"&gt;过载保护方法&lt;/h3&gt;
&lt;p&gt;计算系统临近过载时的峰值吞吐作为限流的阈值来进行流量控制，达到系统保护。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;服务器临近过载时，主动抛弃一定量的负载，目标是自保。&lt;/li&gt;
&lt;li&gt;在系统稳定的前提下，保持系统的吞吐量。&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id="利特尔法则"&gt;利特尔法则&lt;/h3&gt;
&lt;p&gt;&lt;strong&gt;计算吞吐量：利特尔法则 L = λ * W&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;利特尔法则由麻省理工大学斯隆商学院（MIT Sloan School of Management）的教授 John Little﹐于 1961 年所提出与证明。它是一个有关提前期与在制品关系的简单数学公式，这一法则为精益生产的改善方向指明了道路。 —- &lt;a href="https://wiki.mbalib.com/wiki/%E5%88%A9%E7%89%B9%E5%B0%94%E6%B3%95%E5%88%99"&gt;MBA 智库百科 (mbalib.com)&lt;/a&gt;&lt;/p&gt;</description><content:encoded><![CDATA[<h2 id="令牌桶算法">令牌桶算法</h2>
<p>是一个存放固定容量令牌的桶，按照固定速率往桶里添加令牌。令牌桶算法的描述如下：</p>
<ul>
<li>假设限制2r/s，则按照500毫秒的固定速率往桶中添加令牌。</li>
<li>桶中最多存放 b 个令牌，当桶满时，新添加的令牌被丢弃或拒绝。</li>
<li>当一个 n 个字节大小的数据包到达，将从桶中删除n 个令牌，接着数据包被发送到网络上。</li>
<li>如果桶中的令牌不足 n 个，则不会删除令牌，且该数据包将被限流（要么丢弃，要么缓冲区等待）。</li>
</ul>
<p>令牌桶速率限制算法: <code>golang.org/x/time/rate</code></p>
<p><img src="/images/51a3b153-ddc8-4d86-93e4-5610b49bcf96.png" alt=""></p>
<h2 id="漏桶算法">漏桶算法</h2>
<p>作为计量工具(The Leaky Bucket Algorithm as a Meter)时，可以用于流量整形(Traffic Shaping)和流量控制(TrafficPolicing)，漏桶算法的描述如下：</p>
<ul>
<li>一个固定容量的漏桶，按照常量固定速率流出水滴。</li>
<li>如果桶是空的，则不需流出水滴。</li>
<li>可以以任意速率流入水滴到漏桶。</li>
<li>如果流入水滴超出了桶的容量，则流入的水滴溢出了（被丢弃），而漏桶容量是不变的。</li>
</ul>
<p>漏桶率限制算法: go.uber.org/ratelimit</p>
<p><img src="/images/3359127c-5aa1-42e5-bb12-c1f59880c50f.png" alt=""></p>
<h2 id="过载保护">过载保护</h2>
<h3 id="令牌桶与漏桶的缺点">令牌桶与漏桶的缺点</h3>
<p>漏斗桶/令牌桶确实能够保护系统不被拖垮, 但不管漏斗桶还是令牌桶, 其防护思路都是设定一个指标, 当超过该指标后就阻止或减少流量的继续进入，当系统负载降低到某一水平后则恢复流量的进入。但其通常都是被动的，其实际效果取决于限流阈值设置是否合理，但往往设置合理不是一件容易的事情。</p>
<ul>
<li>集群增加机器或者减少机器限流阈值是否要重新设置?</li>
<li>设置限流阈值的依据是什么?</li>
<li>人力运维成本是否过高?</li>
<li>当调用方反馈429时, 这个时候重新设置限流, 其实流量高峰已经过了重新评估限流是否有意义?</li>
</ul>
<p>这些其实都是采用漏斗桶/令牌桶的缺点, 总体来说就是太被动, 不能快速适应流量变化。
因此我们需要一种自适应的限流算法，即: 过载保护，根据系统当前的负载自动丢弃流量。</p>
<h3 id="过载保护方法">过载保护方法</h3>
<p>计算系统临近过载时的峰值吞吐作为限流的阈值来进行流量控制，达到系统保护。</p>
<ul>
<li>服务器临近过载时，主动抛弃一定量的负载，目标是自保。</li>
<li>在系统稳定的前提下，保持系统的吞吐量。</li>
</ul>
<h3 id="利特尔法则">利特尔法则</h3>
<p><strong>计算吞吐量：利特尔法则 L = λ * W</strong></p>
<p>利特尔法则由麻省理工大学斯隆商学院（MIT Sloan School of Management）的教授 John Little﹐于 1961 年所提出与证明。它是一个有关提前期与在制品关系的简单数学公式，这一法则为精益生产的改善方向指明了道路。 —- <a href="https://wiki.mbalib.com/wiki/%E5%88%A9%E7%89%B9%E5%B0%94%E6%B3%95%E5%88%99">MBA 智库百科 (mbalib.com)</a></p>
<p><img src="/images/90d947b6-d2a4-4179-968e-fab77cca6f69.png" alt=""></p>
<p><img src="/images/f0f01256-91b8-4874-b0db-5e8b375e1e46.png" alt=""></p>
<p>如上图所示，如果我们开一个小店，平均每分钟进店 2 个客人(λ)，每位客人从等待到完成交易需要 4 分钟(W)，那我们店里能承载的客人数量就是 2 * 4 = 8 个人</p>
<p>同理，我们可以将 <code>λ</code> 当做 QPS， <code>W</code> 呢是每个请求需要花费的时间，那我们的系统的吞吐就是 <code>L = λ * W</code> ，所以我们可以使用利特尔法则来计算系统的吞吐量。</p>
<h4 id="什么时候系统的吞吐量就是最大的吞吐量">什么时候系统的吞吐量就是最大的吞吐量？</h4>
<p>首先我们可以通过统计过去一段时间的数据，获取到平均每秒的请求量，也就是 QPS，以及请求的耗时时间，为了避免出现前面 900ms 一个请求都没有最后 100ms 请求特别多的情况，我们可以使用滑动窗口算法来进行统计。</p>
<p>最容易想到的就是我们从系统启动开始，就把这些值给保存下来，然后计算一个吞吐的最大值，用这个来表示我们的最大吞吐量就可以了。但是这样存在一个问题是，我们很多系统其实都不是独占一台机器的，一个物理机上面往往有很多服务，并且一般还存在一些超卖，所以可能第一个小时最大处理能力是 100，但是这台节点上其他服务实例同时都在抢占资源的时候，这个处理能力最多就只能到 80 了</p>
<p>所以我们需要一个数据来做启发阈值，只要这个指标达到了阈值那我们就进入流控当中。常见的选择一般是 CPU、Memory、System Load，这里我们以 CPU 为例</p>
<p>只要我们的 CPU 负载超过 80% 的时候，获取过去 5s 的最大吞吐数据，然后再统计当前系统中的请求数量，只要当前系统中的请求数大于最大吞吐那么我们就丢弃这个请求。</p>
<p>如何计算接近峰值时的系统吞吐？</p>
<ul>
<li>CPU: 使用一个独立的线程采样，每隔 250ms 触发一次。在计算均值时，使用了简单滑动平均去除峰值的影响。</li>
<li>Inflight: 当前服务中正在进行的请求的数量。</li>
<li>Pass&amp;RT: 最近5s，pass 为每100ms采样窗口内成功请求的数量，rt 为单个采样窗口中平均响应时间。</li>
</ul>
<p><img src="/images/6dbc84ba-a083-4c70-b5f6-f0abe8149f03.png" alt=""></p>
<p><img src="/images/4408995c-1d9d-4a95-be14-be8feb329dce.png" alt=""></p>
<ul>
<li>我们使用 CPU 的滑动均值(CPU &gt; 800)作为启发阈值，一旦触发进入到过载保护阶段，算法为：(pass* rt) &lt; inflight</li>
<li>限流效果生效后，CPU 会在临界值(800)附近抖动，如果不使用冷却时间，那么一个短时间的 CPU 下降就可能导致大量请求被放行，严重时会打满 CPU。</li>
<li>在冷却时间后，重新判断阈值(CPU &gt; 800 )，是否持续进入过载保护。</li>
</ul>
<p><img src="/images/0567b758-0a00-4ff5-9a8c-901e38d242f5.png" alt=""></p>
<h2 id="什么是限流">什么是限流</h2>
<p>限流是指在一段时间内，定义某个客户或应用可以接收或处理多少个请求的技术。例如，通过限流，你可以过滤掉产生流量峰值的客户和微服务，或者可以确保你的应用程序在自动扩展(Auto Scaling)失效前都不会出现过载的情况。</p>
<ul>
<li>令牌桶、漏桶 针对单个节点，无法分布式限流。</li>
<li>QPS 限流
<ul>
<li>不同的请求可能需要数量迥异的资源来处理。</li>
<li>某种静态 QPS 限流不是特别准。</li>
</ul>
</li>
<li><strong>给每个用户设置限制</strong>
<ul>
<li>全局过载发生时候，针对某些“异常”进行控制。</li>
<li>一定程度的“超卖”配额。</li>
</ul>
</li>
<li>按照优先级丢弃。</li>
<li>拒绝请求也需要成本。</li>
</ul>
<p><img src="/images/cd9b2488-c5fb-47c4-b40a-4d6d8819c692.png" alt=""></p>
<h2 id="分布式限流">分布式限流</h2>
<p>分布式限流，是为了控制某个应用全局的流量，而非真对单个节点纬度。</p>
<ul>
<li>单个大流量的接口，使用 redis 容易产生热点。</li>
<li>pre-request 模式对性能有一定影响，高频的网络往返。</li>
</ul>
<p>思考：</p>
<ul>
<li>从获取单个 quota 升级成批量 quota。quota: 表示速率，获取后使用令牌桶算法来限制。</li>
</ul>
<p><img src="/images/84f00d9e-14d6-4791-9240-b95f2d60159b.png" alt=""></p>
<ul>
<li>每次心跳后，异步批量获取 quota，可以大大减少请求 redis 的频次，获取完以后本地消费，基于令牌桶拦截。</li>
<li>每次申请的配额需要手动设定静态值略欠灵活，比如每次要20，还是50。</li>
</ul>
<p>如何基于单个节点按需申请，并且避免出现不公平的现象？
初次使用默认值，一旦有过去历史窗口的数据，可以基于历史窗口数据进行 quota 请求。
思考：</p>
<ul>
<li>我们经常面临给一组用户划分稀有资源的问题，他们都享有等价的权利来获取资源，但是其中一些用户实际上只需要比其他用户少的资源。</li>
</ul>
<p><img src="/images/c18c4e61-f29e-41fc-aba7-d254a1e20be7.png" alt=""></p>
<p>那么我们如何来分配资源呢？一种在实际中广泛使用的分享技术称作“最大最小公平分享”(Max-Min Fairness)。
直观上，公平分享分配给每个用户想要的可以满足的最小需求，然后将没有使用的资源均匀的分配给需要‘大资源’的用户。
最大最小公平分配算法的形式化定义如下：</p>
<ul>
<li>资源按照需求递增的顺序进行分配。</li>
<li>不存在用户得到的资源超过自己的需求。</li>
<li>未得到满足的用户等价的分享资源。</li>
</ul>
<p><img src="/images/bc3758b8-71b6-4298-9b43-a988c25f808e.png" alt=""></p>
<p><img src="/images/2f213e58-59a8-48d9-9def-8f1b6d30230c.png" alt=""></p>
<h2 id="限流的重要性">限流的重要性</h2>
<p>每个接口配置阈值，运营工作繁重，最简单的我们配置服务级别 quota，更细粒度的，我们可以根据不同重要性设定 quota，我们引入了重要性(criticality):</p>
<ul>
<li>最重要 CRITICAL_PLUS，为最终的要求预留的类型，拒绝这些请求会造成非常严重的用户可见的问题。</li>
<li>重要 CRITICAL，生产任务发出的默认请求类型。拒绝这些请求也会造成用户可见的问题。但是可能没那么严重。</li>
<li>可丢弃的 SHEDDABLE_PLUS 这些流量可以容忍某种程度的不可用性。这是批量任务发出的请求的默认值。这些请求通常可以过几分钟、几小时后重试。</li>
<li>可丢弃的 SHEDDABLE 这些流量可能会经常遇到部分不可用情况，偶尔会完全不可用。</li>
</ul>
<p>gRPC 系统之间，需要自动传递重要性信息。如果后端接受到请求 A，在处理过程中发出了请求 B 和 C 给其他后端，请求 B 和 C 会使用与 A 相同的重要性属性。</p>
<ul>
<li>全局配额不足时，优先拒绝低优先级的。</li>
<li>全局配额，可以按照重要性分别设置。</li>
<li>过载保护时，低优先级的请求先被拒绝。</li>
</ul>
<h2 id="熔断">熔断</h2>
<p>断路器(Circuit Breakers): 为了限制操作的持续时间，我们可以使用超时，超时可以防止挂起操作并保证系统可以响应。因为我们处于高度动态的环境中，几乎不可能确定在每种情况下都能正常工作的准确的时间限制。断路器以现实世界的电子元件命名，因为它们的行为是都是相同的。断路器在分布式系统中非常有用，因为重复的故障可能会导致雪球效应，并使整个系统崩溃。</p>
<ul>
<li><strong>服务依赖的资源出现大量错误。</strong></li>
<li><strong>某个用户超过资源配额时，后端任务会快速拒绝请求，返回“配额不足”的错误，但是拒绝回复仍然会消耗一定资源。有可能后端忙着不停发送拒绝请求，导致过载。</strong></li>
</ul>
<p><img src="/images/bb7a5dcf-2c93-484a-9d81-58cd9fc37564.png" alt=""></p>
<p>如上图所示，熔断器存在三个状态:</p>
<ol>
<li><strong>关闭(closed)</strong>: 关闭状态下没有触发断路保护，所有的请求都正常通行</li>
<li><strong>打开(open)</strong>: 当错误阈值触发之后，就进入开启状态，这个时候所有的流量都会被节流，不运行通行</li>
<li><strong>半打开(half-open)</strong>: 处于打开状态一段时间之后，会尝试尝试放行一个流量来探测当前 server 端是否可以接收新流量，如果这个没有问题就会进入关闭状态，如果有问题又会回到打开状态</li>
</ol>
<h3 id="google-sre-过载保护算法">Google SRE 过载保护算法</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#111">max</span><span style="color:#111">(</span><span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#111">(</span><span style="color:#75af00">requests</span> <span style="color:#f92672">-</span> <span style="color:#75af00">K</span><span style="color:#f92672">*</span><span style="color:#75af00">accepts</span><span style="color:#111">)</span> <span style="color:#f92672">/</span> <span style="color:#111">(</span><span style="color:#75af00">requests</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span><span style="color:#111">))</span>
</span></span></code></pre></div><p>算法如上所示，这个公式计算的是请求被丢弃的概率[<a href="https://lailin.xyz/post/go-training-week6-6-breaker.html#fn:3">3]</a></p>
<ul>
<li>requests: 一段时间的请求数量</li>
<li>accepts: 成功的请求数量</li>
<li>K: 倍率，K 越小表示越激进，越小表示越容易被丢弃请求</li>
</ul>
<p>这个算法的好处是不会直接一刀切的丢弃所有请求，而是计算出一个概率来进行判断，当成功的请求数量越少，K越小的时候 requests−K∗accepts 的值就越大，计算出的概率也就越大，表示这个请求被丢弃的概率越大</p>
<p><img src="/images/0fb2f1dd-bde2-4ea0-a684-32c6432b0170.png" alt=""></p>
<h2 id="gutter">Gutter</h2>
<p>基于熔断的 gutter kafka ，用于接管自动修复系统运行过程中的负载，这样只需要付出10%的资源就能解决部分系统可用性问题。
我们经常使用 failover 的思路，但是完整的 failover 需要翻倍的机器资源，平常不接受流量时，资源浪费。高负载情况下接管流量又不一定完整能接住。所以这里核心利用熔断的思路，是把抛弃的流量转移到 gutter 集群，如果 gutter 也接受不住的流量，重新回抛到主集群，最大力度来接受。</p>
<p><img src="/images/e4c6bd90-f754-4511-a3dd-b1bf7534b541.png" alt=""></p>
<h2 id="客户端流控">客户端流控</h2>
<p>positive feedback: 用户总是积极重试，访问一个不可达的服务。</p>
<ul>
<li>客户端需要限制请求频次，retry backoff 做一定的请求退让。</li>
<li>可以通过接口级别的error_details，挂载到每个 API 返回的响应里。</li>
</ul>
<p><img src="/images/c77189a6-f8f5-4fd9-b831-a32ef231ad4d.png" alt=""></p>
<p><img src="/images/325019ac-8b8e-4615-abbd-9050afe79c65.png" alt=""></p>
<p><img src="/images/c42b5eb8-1c45-485b-8c33-92c9bd7009e1.png" alt=""></p>
<h2 id="参考文章">参考文章</h2>
<ul>
<li><a href="https://blog.csdn.net/m__l__/article/details/109175787">https://blog.csdn.net/m__l__/article/details/109175787</a></li>
<li><a href="https://lailin.xyz/post/go-training-week6-4-auto-limiter.html">https://lailin.xyz/post/go-training-week6-4-auto-limiter.html</a></li>
<li><a href="https://lailin.xyz/post/go-training-week6-6-breaker.html">https://lailin.xyz/post/go-training-week6-6-breaker.html</a></li>
</ul>
]]></content:encoded><category>microservice</category><category>grpc</category><category>go</category></item><item><title>超时控制</title><link>https://daemon365.dev/post/microservice/timeout_control/</link><pubDate>Fri, 23 Dec 2022 00:00:00 +0800</pubDate><guid>https://daemon365.dev/post/microservice/timeout_control/</guid><description>&lt;h2 id="什么是超时控制"&gt;什么是超时控制？&lt;/h2&gt;
&lt;p&gt;超时控制，使我们的服务之间调用可以快速抛错。比如API接口设置1s超时API调用A服务用了500ms，服务A调用和服务B用了600ms，n那么现在已经超时，还要调用服务C等等，再返回超时错误吗？这回事使服务C后面的链路做了无用功，浪费服务器资源。&lt;/p&gt;
&lt;p&gt;&lt;img src="https://daemon365.dev/images/44cc09fe-c961-4cb6-af02-ea19c60f44c3.png" alt=""&gt;&lt;/p&gt;
&lt;h2 id="grpc的截止时间"&gt;GRPC的截止时间&lt;/h2&gt;
&lt;p&gt;截止时间以请求开始的绝对时间来表示（即使 API 将它们表示为持续时间偏移），并且应 用于多个服务调用。发起请求的应用程序设置截止时间，整个请求链需要在截止时间之前 进行响应。 gRPC API 支持为 RPC 使用截止时间，出于多种原因，在 gRPC 应用程序中使 用截止时间始终是一种最佳实践。由于 gRPC 通信是在网络上发生的，因此在 RPC 和响应 之间会有延迟。另外，在一些特定的场景中， gRPC 服务本身可能要花费更多的时间来响 应，这取决于服务的业务逻辑。如果客户端应用程序在开发时没有指定截止时间，那么它 们会无限期地等待自己所发起的 RPC 请求的响应，而资源都会被正在处理的请求所占用。 这会让服务和客户端都面临资源耗尽的风险，增加服务的延迟，甚至可能导致整个 gRPC 服务崩溃。&lt;/p&gt;
&lt;p&gt;客户端应用程序的截止时间设置为 50 毫秒（截止时间 = 当前时间 + 偏移量）。客户端和 ProductMgt 服务之间的网络延迟为 0 毫秒， ProductMgt 服务的处理延迟为 20 毫秒。 商 品管理服务（ ProductMgt 服务）必须将截止时间的偏移量设置为 30 毫秒。 因为库存服 务（ Inventory 服务）需要 30 毫秒来响应， 所以截止时间的事件会在两个客户端上发生 （ ProductMgt 调用 Inventory 服务和客户端应用程序）。&lt;/p&gt;
&lt;p&gt;ProductMgt 服务的业务逻辑将延迟时间增加了 20 毫秒。 随后， ProductMgt 服务的调用逻 辑触发了超出截止时间的场景，并且传播回客户端应用程序。因此，在使用截止时间时， 要明确它们适用于所有服务场景。&lt;/p&gt;</description><content:encoded><![CDATA[<h2 id="什么是超时控制">什么是超时控制？</h2>
<p>超时控制，使我们的服务之间调用可以快速抛错。比如API接口设置1s超时API调用A服务用了500ms，服务A调用和服务B用了600ms，n那么现在已经超时，还要调用服务C等等，再返回超时错误吗？这回事使服务C后面的链路做了无用功，浪费服务器资源。</p>
<p><img src="/images/44cc09fe-c961-4cb6-af02-ea19c60f44c3.png" alt=""></p>
<h2 id="grpc的截止时间">GRPC的截止时间</h2>
<p>截止时间以请求开始的绝对时间来表示（即使 API 将它们表示为持续时间偏移），并且应 用于多个服务调用。发起请求的应用程序设置截止时间，整个请求链需要在截止时间之前 进行响应。 gRPC API 支持为 RPC 使用截止时间，出于多种原因，在 gRPC 应用程序中使 用截止时间始终是一种最佳实践。由于 gRPC 通信是在网络上发生的，因此在 RPC 和响应 之间会有延迟。另外，在一些特定的场景中， gRPC 服务本身可能要花费更多的时间来响 应，这取决于服务的业务逻辑。如果客户端应用程序在开发时没有指定截止时间，那么它 们会无限期地等待自己所发起的 RPC 请求的响应，而资源都会被正在处理的请求所占用。 这会让服务和客户端都面临资源耗尽的风险，增加服务的延迟，甚至可能导致整个 gRPC 服务崩溃。</p>
<p>客户端应用程序的截止时间设置为 50 毫秒（截止时间 = 当前时间 + 偏移量）。客户端和 ProductMgt 服务之间的网络延迟为 0 毫秒， ProductMgt 服务的处理延迟为 20 毫秒。 商 品管理服务（ ProductMgt 服务）必须将截止时间的偏移量设置为 30 毫秒。 因为库存服 务（ Inventory 服务）需要 30 毫秒来响应， 所以截止时间的事件会在两个客户端上发生 （ ProductMgt 调用 Inventory 服务和客户端应用程序）。</p>
<p>ProductMgt 服务的业务逻辑将延迟时间增加了 20 毫秒。 随后， ProductMgt 服务的调用逻 辑触发了超出截止时间的场景，并且传播回客户端应用程序。因此，在使用截止时间时， 要明确它们适用于所有服务场景。</p>
<p><img src="/images/29faba9a-1bc6-41bc-a376-5868f2bb82b9.png" alt=""></p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">conn</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">grpc</span><span style="color:#111">.</span><span style="color:#75af00">Dial</span><span style="color:#111">(</span><span style="color:#75af00">address</span><span style="color:#111">,</span> <span style="color:#75af00">grpc</span><span style="color:#111">.</span><span style="color:#75af00">WithInsecure</span><span style="color:#111">())</span> 
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Fatalf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;did not connect: %v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span> 
</span></span><span style="display:flex;"><span><span style="color:#111">}</span> 
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">defer</span> <span style="color:#75af00">conn</span><span style="color:#111">.</span><span style="color:#75af00">Close</span><span style="color:#111">()</span> 
</span></span><span style="display:flex;"><span><span style="color:#75af00">client</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">pb</span><span style="color:#111">.</span><span style="color:#75af00">NewOrderManagementClient</span><span style="color:#111">(</span><span style="color:#75af00">conn</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">clientDeadline</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Now</span><span style="color:#111">().</span><span style="color:#75af00">Add</span><span style="color:#111">(</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Duration</span><span style="color:#111">(</span><span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Second</span><span style="color:#111">))</span> 
</span></span><span style="display:flex;"><span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">cancel</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">WithDeadline</span><span style="color:#111">(</span><span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Background</span><span style="color:#111">(),</span> <span style="color:#75af00">clientDeadline</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">defer</span> <span style="color:#75af00">cancel</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 调用方法传入ctx</span>
</span></span></code></pre></div>]]></content:encoded><category>microservice</category><category>grpc</category><category>go</category></item><item><title>微服务架构及raft协议</title><link>https://daemon365.dev/post/microservice/microservice_architecture_and_raft_protocol/</link><pubDate>Sun, 30 May 2021 00:00:00 +0800</pubDate><guid>https://daemon365.dev/post/microservice/microservice_architecture_and_raft_protocol/</guid><description>&lt;h2 id="微服务架构全景图"&gt;微服务架构全景图&lt;/h2&gt;
&lt;p&gt;&lt;img src="https://daemon365.dev/images/7cea65ba-1cb6-4a94-b327-65110aaaeb4b.png" alt=""&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src="https://daemon365.dev/images/936e7894-ae71-41b9-b2d4-032af51c0540.png" alt=""&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src="https://daemon365.dev/images/076f5cc6-d5ac-496e-a4cd-ae74e3756d61.png" alt=""&gt;&lt;/p&gt;
&lt;h2 id="服务注册和发现"&gt;服务注册和发现&lt;/h2&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;Client side implement&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;调用需要维护所有调用服务的地址&lt;/li&gt;
&lt;li&gt;有一定的技术难度，需要rpc框架支持&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Server side implement&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;架构简单&lt;/li&gt;
&lt;li&gt;有单点故障&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;img src="https://daemon365.dev/images/6ce70812-c612-49e4-b60a-50c267b228e1.png" alt=""&gt;&lt;/p&gt;
&lt;h2 id="注册中心"&gt;注册中心&lt;/h2&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;etcd注册中心&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;分布式一致性系统&lt;/li&gt;
&lt;li&gt;基于raft一致性协议&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;etcd使用场景&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;服务注册和发现&lt;/li&gt;
&lt;li&gt;共享配置&lt;/li&gt;
&lt;li&gt;分布式锁&lt;/li&gt;
&lt;li&gt;Leader选举&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id="raft协议详解"&gt;Raft协议详解&lt;/h2&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;应用场景&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;解决分布式系统一致性的问题&lt;/li&gt;
&lt;li&gt;基于复制的&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;工作机制&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;leader选举&lt;/li&gt;
&lt;li&gt;日志复制&lt;/li&gt;
&lt;li&gt;安全性&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id="基本概念"&gt;基本概念&lt;/h2&gt;
&lt;p&gt;raft协议演示：http://www.kailing.pub/raft/index.html&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;角色&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Follower角色&lt;/li&gt;
&lt;li&gt;Leader角色&lt;/li&gt;
&lt;li&gt;Candicate角色&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Term（任期）概念&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;在raft协议中，将时间分成一个个term（任期）&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;img src="https://daemon365.dev/images/51679473-1748-4646-8ec4-7cefac2eb2fc.png" alt=""&gt;&lt;/p&gt;
&lt;h3 id="复制状态机"&gt;复制状态机&lt;/h3&gt;
&lt;p&gt;在一个分布式系统数据库中,如果每个节点的状态一致,每个节点都执行相同的命令序列,那么最终他们会得到一个一致的状态。也就是和说,为了保证整个分布式系统的一致性,我们需要保证每个节点执行相同的命令序列,也就是说每个节点的日志要保持一样。所以说,保证日志复制一致就是Raf等一致性算法的工作了&lt;/p&gt;
&lt;p&gt;&lt;img src="https://daemon365.dev/images/0b0a6a3e-53ac-4eef-97c6-d0b5ad7a295d.png" alt=""&gt;&lt;/p&gt;
&lt;p&gt;这里就涉及 Replicated State Machine(复制状态机),如上图所示。在一个节点上,一致性模块( Consensus Module,也就是分布式共识算法)接收到了来自客户端的命令。然后把接收到的命令写入到日志中,该节点和其他节点通过一致性模块进行通信确保每个日志最终包含相同的命令序列。一旦这些日志的命令被正确复制,每个节点的状态机( State Machine)都会按照相同的序列去执行他们,从而最终得到一致的状态。然后将达成共识的结果返回给客户端,如下图所示。&lt;/p&gt;
&lt;p&gt;&lt;img src="https://daemon365.dev/images/2c70801f-2b50-4c67-9916-9ee72ed66f4f.png" alt=""&gt;&lt;/p&gt;
&lt;h3 id="心跳heartbeats和超时机制timeout"&gt;心跳（heartbeats）和超时机制（timeout）&lt;/h3&gt;
&lt;p&gt;在Ra算法中,有两个 timeout机制来控制领导人选举一个是选举定时器( elation timeou):&lt;/p&gt;
&lt;p&gt;即 Follower等待成为 Candidate状态的等待时间,这个时间被随机设定为150ms-300ms之间&lt;/p&gt;
&lt;p&gt;另一个是 headrbeat timeout:在某个节点成为 Leader以后,它会发送 Append Entries消息给其他节点,这些消息就是通过 heartbeat timeout来传送, Follower接收到 Leader的心跳包的同时也重置选举定时器&lt;/p&gt;</description><content:encoded><![CDATA[<h2 id="微服务架构全景图">微服务架构全景图</h2>
<p><img src="/images/7cea65ba-1cb6-4a94-b327-65110aaaeb4b.png" alt=""></p>
<p><img src="/images/936e7894-ae71-41b9-b2d4-032af51c0540.png" alt=""></p>
<p><img src="/images/076f5cc6-d5ac-496e-a4cd-ae74e3756d61.png" alt=""></p>
<h2 id="服务注册和发现">服务注册和发现</h2>
<ol>
<li>
<p>Client side implement</p>
<ul>
<li>调用需要维护所有调用服务的地址</li>
<li>有一定的技术难度，需要rpc框架支持</li>
</ul>
</li>
<li>
<p>Server side implement</p>
<ul>
<li>架构简单</li>
<li>有单点故障</li>
</ul>
</li>
</ol>
<p><img src="/images/6ce70812-c612-49e4-b60a-50c267b228e1.png" alt=""></p>
<h2 id="注册中心">注册中心</h2>
<ol>
<li>
<p>etcd注册中心</p>
<ul>
<li>分布式一致性系统</li>
<li>基于raft一致性协议</li>
</ul>
</li>
<li>
<p>etcd使用场景</p>
<ul>
<li>服务注册和发现</li>
<li>共享配置</li>
<li>分布式锁</li>
<li>Leader选举</li>
</ul>
</li>
</ol>
<h2 id="raft协议详解">Raft协议详解</h2>
<ol>
<li>
<p>应用场景</p>
<ul>
<li>解决分布式系统一致性的问题</li>
<li>基于复制的</li>
</ul>
</li>
<li>
<p>工作机制</p>
<ul>
<li>leader选举</li>
<li>日志复制</li>
<li>安全性</li>
</ul>
</li>
</ol>
<h2 id="基本概念">基本概念</h2>
<p>raft协议演示：http://www.kailing.pub/raft/index.html</p>
<ol>
<li>
<p>角色</p>
<ul>
<li>Follower角色</li>
<li>Leader角色</li>
<li>Candicate角色</li>
</ul>
</li>
<li>
<p>Term（任期）概念</p>
<ul>
<li>在raft协议中，将时间分成一个个term（任期）</li>
</ul>
</li>
</ol>
<p><img src="/images/51679473-1748-4646-8ec4-7cefac2eb2fc.png" alt=""></p>
<h3 id="复制状态机">复制状态机</h3>
<p>在一个分布式系统数据库中,如果每个节点的状态一致,每个节点都执行相同的命令序列,那么最终他们会得到一个一致的状态。也就是和说,为了保证整个分布式系统的一致性,我们需要保证每个节点执行相同的命令序列,也就是说每个节点的日志要保持一样。所以说,保证日志复制一致就是Raf等一致性算法的工作了</p>
<p><img src="/images/0b0a6a3e-53ac-4eef-97c6-d0b5ad7a295d.png" alt=""></p>
<p>这里就涉及 Replicated State Machine(复制状态机),如上图所示。在一个节点上,一致性模块( Consensus Module,也就是分布式共识算法)接收到了来自客户端的命令。然后把接收到的命令写入到日志中,该节点和其他节点通过一致性模块进行通信确保每个日志最终包含相同的命令序列。一旦这些日志的命令被正确复制,每个节点的状态机( State Machine)都会按照相同的序列去执行他们,从而最终得到一致的状态。然后将达成共识的结果返回给客户端,如下图所示。</p>
<p><img src="/images/2c70801f-2b50-4c67-9916-9ee72ed66f4f.png" alt=""></p>
<h3 id="心跳heartbeats和超时机制timeout">心跳（heartbeats）和超时机制（timeout）</h3>
<p>在Ra算法中,有两个 timeout机制来控制领导人选举一个是选举定时器( elation timeou):</p>
<p>即 Follower等待成为 Candidate状态的等待时间,这个时间被随机设定为150ms-300ms之间</p>
<p>另一个是 headrbeat timeout:在某个节点成为 Leader以后,它会发送 Append Entries消息给其他节点,这些消息就是通过 heartbeat timeout来传送, Follower接收到 Leader的心跳包的同时也重置选举定时器</p>
<h3 id="leader选举">Leader选举</h3>
<h4 id="raft-的选举过程">Raft 的选举过程</h4>
<p>Raft 协议在集群初始状态下是没有 Leader 的, 集群中所有成员均是 Follower，在选举开始期间所有 Follower 均可参与选举，这时所有 Follower 的角色均转变为 Condidate, Leader 由集群中所有的 Condidate 投票选出，最后获得投票最多的 Condidate 获胜，其角色转变为 Leader 并开始其任期，其余落败的 Condidate 角色转变为 Follower 开始服从 Leader 领导。这里有一种意外的情况会选不出 Leader 就是所有 Condidate 均投票给自己，这样无法决出票数多的一方，Raft 算法为了解决这个问题引入了北洋时期袁世凯获选大总统的谋略，即选不出 Leader 不罢休，直到选出为止，一轮选不出 Leader，便令所有 Condidate 随机 sleap（Raft 论文称为 timeout）一段时间，然后马上开始新一轮的选举，这里的随机 sleep 就起了很关键的因素，第一个从 sleap 状态恢复过来的 Condidate 会向所有 Condidate 发出投票给我的申请，这时还没有苏醒的 Condidate 就只能投票给已经苏醒的 Condidate ，因此可以有效解决 Condiadte 均投票给自己的故障，便可快速的决出 Leader。</p>
<p>选举出 Leader 后 Leader 会定期向所有 Follower 发送 heartbeat 来维护其 Leader 地位，如果 Follower 一段时间后未收到 Leader 的心跳则认为 Leader 已经挂掉，便转变自身角色为 Condidate，同时发起新一轮的选举，产生新的 Leader。</p>
<h4 id="raft-的数据一致性策略">Raft 的数据一致性策略</h4>
<p>Raft 协议强依赖 Leader 节点来确保集群数据一致性。即 client 发送过来的数据均先到达 Leader 节点，Leader 接收到数据后，先将数据标记为 uncommitted 状态，随后 Leader 开始向所有 Follower 复制数据并等待响应，在获得集群中大于 N/2 个 Follower 的已成功接收数据完毕的响应后，Leader 将数据的状态标记为 committed，随后向 client 发送数据已接收确认，在向 client 发送出已数据接收后，再向所有 Follower 节点发送通知表明该数据状态为committed。</p>
<h4 id="raft-如何处理-leader-意外的">Raft 如何处理 Leader 意外的？</h4>
<ol>
<li>client 发送数据到达 Leader 之前 Leader 就挂了，因为数据还没有到达集群内部，所以对集群内部数据的一致性没有影响，Leader 挂了之后，集群会进行新的选举产生新的 Leader，之前挂掉的 Leader 重启后作为 Follower 加入集群，并同步 Leader 上的数据。这里最好要求 client 有重试机制在一定时间没有收到 Leader 的数据已接收确认后进行一定次数的重试，并再次向新的 Leader 发送数据来确保业务的流畅性。</li>
<li>client 发送数据到 Leader，数据到达 Leader 后，Leader 还没有开始向 Folloers 复制数据，Leader就挂了，此时数据仍被标记为 uncommited 状态，这时集群会进行新的选举产生新的 Leader，之前挂掉的 Leader 重启后作为 Follower 加入集群，并同步 Leader 上的数据，来保证数据一致性，之前接收到 client 的数据由于是 uncommited 状态所以可能会被丢弃。这里同样最好要求 client 有重试机制通过在一定时间在没有收到 Leader 的数据已接收确认后进行一定次数的重试，再次向新的 Leader 发送数据来确保业务的流畅性。</li>
<li>client 发送数据到 Leader, Leader 接收数据完毕后标记为 uncommited，开始向 Follower复制数据，在复制完毕一小部分 Follower 后 Leader 挂了，此时数据在所有已接收到数据的 Follower 上仍被标记为 uncommitted，但国不可一日无君，此时集群将进行新的选举，而拥有最新数据的 Follower 变换角色为 Condidate，也就意味着 Leader 将在拥有最新数据的 Follower 中产生，新的 Leader 产生后所有节点开始从新 Leader 上同步数据确保数据的一致性，包括之前挂掉后恢复了状态的 老Leader，这时也以 Follower 的身份同步新 Leader 上的数据。</li>
<li>client 发送数据到 Leader，Leader 接收数据完毕后标记为 uncommitted，开始向 Follower 复制数据，在复制完毕所有 Follower 节点或者大部分节点（大于 N/2），并接收到大部分节点接收完毕的响应后，Leader 节点将数据标记为 committed，这时 Leader 挂了，此时已接收到数据的所有 Follower 节点上的数据状态由于还没有接收到 Leader 的 commited 通知，均处于 uncommited 状态。这时集群进行了新的选举，新的 Leader 将在拥有最新数据的节点中产生，新的 Leader 产生后，由于 client 端因老 Leader 挂掉前没有通知其数据已接收，所以会向新的 Leader 发送重试请求，而新的 Leader 上已经存在了这个之前从老 Leader 上同步过来的数据，因此 Raft 集群要求各节点自身实现去重的机制，保证数据的一致性。</li>
<li>集群脑裂的一致性处理，多发于双机房的跨机房模式的集群。假设一个 5 节点的 Raft 集群，其中三个节点在 A 机房，Leader 节点也在 A 机房，两个节点在 B 机房。突然 A、B 两个机房之间因其他故障无法通讯，那么此时 B 机房中的 2 个Follower 因为失去与 Leader 的联系，均转变自身角色为 Condidate。根据 Leader 选举机制，B 机房中产生了一个新的 Leader，这就发生了脑裂即存在 A 机房中的老 Leader 的集群与B机房新 Leader 的集群。Raft 针对这种情况的处理方式是老的 Leader 集群虽然剩下三个节点，但是 Leader 对数据的处理过程还是在按原来 5 个节点进行处理，所以老的 Leader 接收到的数据，在向其他 4 个节点复制数据，由于无法获取超过 N/2 个 Follower 节点的复制完毕数据响应（因为无法连接到 B 机房中的 2个节点），所以 client 在向老 Leader 发送的数据请求均无法成功写入，而 client 向B机房新 Leader 发送的数据，因为是新成立的集群，所以可以成功写入数据，在A、B两个机房恢复网络通讯后，A 机房中的所有节点包括老 Leader 再以 Follower 角色接入这个集群，并同步新 Leader 中的数据，完成数据一致性处理。</li>
</ol>
<p>参考文章: - <a href="https://www.jianshu.com/p/aa77c8f4cb5c">https://www.jianshu.com/p/aa77c8f4cb5c</a></p>
]]></content:encoded><category>microservice</category><category>etcd</category></item><item><title>分布式ID生成器及redis，etcd分布式锁</title><link>https://daemon365.dev/post/microservice/distributed_id_generator_and_redis__etcd_distributed_lock/</link><pubDate>Fri, 30 Apr 2021 00:00:00 +0800</pubDate><guid>https://daemon365.dev/post/microservice/distributed_id_generator_and_redis__etcd_distributed_lock/</guid><description>&lt;h2 id="分布式id生成器"&gt;分布式id生成器&lt;/h2&gt;
&lt;p&gt;有时我们需要能够生成类似MySQL自增ID这样不断增大，同时又不会重复的id。以支持业务中的高并发场景。比较典型的，电商促销时，短时间内会有大量的订单涌入到系统，比如每秒10w+。明星出轨时，会有大量热情的粉丝发微博以表心意，同样会在短时间内产生大量的消息。&lt;/p&gt;
&lt;p&gt;在插入数据库之前，我们需要给这些消息、订单先打上一个ID，然后再插入到我们的数据库。对这个id的要求是希望其中能带有一些时间信息，这样即使我们后端的系统对消息进行了分库分表，也能够以时间顺序对这些消息进行排序。&lt;/p&gt;
&lt;p&gt;&lt;em&gt;Twitter的snowflake算法是这种场景下的一个典型解法。先来看看snowflake是怎么一回事&lt;/em&gt;：&lt;/p&gt;
&lt;p&gt;&lt;img src="https://daemon365.dev/images/d0798666-9a18-403b-bdea-cdabfe94975e.png" alt=""&gt;&lt;/p&gt;
&lt;p&gt;&lt;em&gt;snowflake中的比特位分布&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;首先确定我们的数值是64位，int64类型，被划分为四部分，不含开头的第一个bit，因为这个bit是符号位。用41位来表示收到请求时的时间戳，单位为毫秒，然后五位来表示数据中心的id，然后再五位来表示机器的实例id，最后是12位的循环自增id（到达1111,1111,1111后会归0）。&lt;/p&gt;
&lt;p&gt;这样的机制可以支持我们在同一台机器上，同一毫秒内产生&lt;code&gt;2 ^ 12 = 4096&lt;/code&gt;条消息。一秒共409.6万条消息。从值域上来讲完全够用了。&lt;/p&gt;
&lt;p&gt;数据中心加上实例id共有10位，可以支持我们每数据中心部署32台机器，所有数据中心共1024台实例。&lt;/p&gt;
&lt;p&gt;表示&lt;code&gt;timestamp&lt;/code&gt;的41位，可以支持我们使用69年。当然，我们的时间毫秒计数不会真的从1970年开始记，那样我们的系统跑到&lt;code&gt;2039/9/7 23:47:35&lt;/code&gt;就不能用了，所以这里的&lt;code&gt;timestamp&lt;/code&gt;实际上只是相对于某个时间的增量，比如我们的系统上线是2018-08-01，那么我们可以把这个timestamp当作是从&lt;code&gt;2018-08-01 00:00:00.000&lt;/code&gt;的偏移量。&lt;/p&gt;
&lt;h3 id="worker_id分配"&gt;worker_id分配&lt;/h3&gt;
&lt;p&gt;&lt;code&gt;timestamp&lt;/code&gt;，&lt;code&gt;datacenter_id&lt;/code&gt;，&lt;code&gt;worker_id&lt;/code&gt;和&lt;code&gt;sequence_id&lt;/code&gt;这四个字段中，&lt;code&gt;timestamp&lt;/code&gt;和&lt;code&gt;sequence_id&lt;/code&gt;是由程序在运行期生成的。但&lt;code&gt;datacenter_id&lt;/code&gt;和&lt;code&gt;worker_id&lt;/code&gt;需要我们在部署阶段就能够获取得到，并且一旦程序启动之后，就是不可更改的了（想想，如果可以随意更改，可能被不慎修改，造成最终生成的id有冲突）。&lt;/p&gt;
&lt;p&gt;一般不同数据中心的机器，会提供对应的获取数据中心id的API，所以&lt;code&gt;datacenter_id&lt;/code&gt;我们可以在部署阶段轻松地获取到。而worker_id是我们逻辑上给机器分配的一个id，这个要怎么办呢？比较简单的想法是由能够提供这种自增id功能的工具来支持，比如MySQL:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;mysql&amp;gt; insert into a &lt;span style="color:#f92672"&gt;(&lt;/span&gt;ip&lt;span style="color:#f92672"&gt;)&lt;/span&gt; values&lt;span style="color:#f92672"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;10.1.2.101&amp;#34;&lt;/span&gt;&lt;span style="color:#f92672"&gt;)&lt;/span&gt;&lt;span style="color:#111"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;Query OK, &lt;span style="color:#ae81ff"&gt;1&lt;/span&gt; row affected &lt;span style="color:#f92672"&gt;(&lt;/span&gt;0.00 sec&lt;span style="color:#f92672"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;mysql&amp;gt; &lt;span style="color:#00a8c8"&gt;select&lt;/span&gt; last_insert_id&lt;span style="color:#f92672"&gt;()&lt;/span&gt;&lt;span style="color:#111"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;+------------------+
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;|&lt;/span&gt; last_insert_id&lt;span style="color:#f92672"&gt;()&lt;/span&gt; &lt;span style="color:#111"&gt;|&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;+------------------+
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;|&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;2&lt;/span&gt; &lt;span style="color:#111"&gt;|&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;+------------------+
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#ae81ff"&gt;1&lt;/span&gt; row in &lt;span style="color:#111"&gt;set&lt;/span&gt; &lt;span style="color:#f92672"&gt;(&lt;/span&gt;0.00 sec&lt;span style="color:#f92672"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;从MySQL中获取到&lt;code&gt;worker_id&lt;/code&gt;之后，就把这个&lt;code&gt;worker_id&lt;/code&gt;直接持久化到本地，以避免每次上线时都需要获取新的&lt;code&gt;worker_id&lt;/code&gt;。让单实例的&lt;code&gt;worker_id&lt;/code&gt;可以始终保持不变。&lt;/p&gt;
&lt;p&gt;当然，使用MySQL相当于给我们简单的id生成服务增加了一个外部依赖。依赖越多，我们的服务的可运维性就越差。&lt;/p&gt;
&lt;p&gt;考虑到集群中即使有单个id生成服务的实例挂了，也就是损失一段时间的一部分id，所以我们也可以更简单暴力一些，把&lt;code&gt;worker_id&lt;/code&gt;直接写在worker的配置中，上线时，由部署脚本完成&lt;code&gt;worker_id&lt;/code&gt;字段替换。&lt;/p&gt;
&lt;h3 id="开源实例"&gt;开源实例&lt;/h3&gt;
&lt;h4 id="标准snowflake实现"&gt;标准snowflake实现&lt;/h4&gt;
&lt;p&gt;&lt;code&gt;github.com/bwmarrin/snowflake&lt;/code&gt; 是一个相当轻量化的snowflake的Go实现。其文档对各位使用的定义见&lt;em&gt;图 6-2&lt;/em&gt;所示。&lt;/p&gt;
&lt;p&gt;&lt;img src="https://daemon365.dev/images/ae01d265-414e-4c7a-ab33-bb94ac47b6fb.png" alt=""&gt;&lt;/p&gt;
&lt;p&gt;&lt;em&gt;图 6-2 snowflake库&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;和标准的snowflake完全一致。使用上比较简单：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;package&lt;/span&gt; &lt;span style="color:#75af00"&gt;main&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;import&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;fmt&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;os&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;github.com/bwmarrin/snowflake&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;main&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;n&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;snowflake&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;NewNode&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;1&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;!=&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;err&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;os&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Exit&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;1&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;for&lt;/span&gt; &lt;span style="color:#75af00"&gt;i&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;0&lt;/span&gt;&lt;span style="color:#111"&gt;;&lt;/span&gt; &lt;span style="color:#75af00"&gt;i&lt;/span&gt; &lt;span style="color:#111"&gt;&amp;lt;&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;3&lt;/span&gt;&lt;span style="color:#111"&gt;;&lt;/span&gt; &lt;span style="color:#75af00"&gt;i&lt;/span&gt;&lt;span style="color:#f92672"&gt;++&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;id&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;n&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Generate&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;id&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;id&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;node: &amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;id&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Node&lt;/span&gt;&lt;span style="color:#111"&gt;(),&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;step: &amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;id&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Step&lt;/span&gt;&lt;span style="color:#111"&gt;(),&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;time: &amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;id&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Time&lt;/span&gt;&lt;span style="color:#111"&gt;(),&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;\n&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;当然，这个库也给我们留好了定制的后路，其中预留了一些可定制字段：&lt;/p&gt;</description><content:encoded><![CDATA[<h2 id="分布式id生成器">分布式id生成器</h2>
<p>有时我们需要能够生成类似MySQL自增ID这样不断增大，同时又不会重复的id。以支持业务中的高并发场景。比较典型的，电商促销时，短时间内会有大量的订单涌入到系统，比如每秒10w+。明星出轨时，会有大量热情的粉丝发微博以表心意，同样会在短时间内产生大量的消息。</p>
<p>在插入数据库之前，我们需要给这些消息、订单先打上一个ID，然后再插入到我们的数据库。对这个id的要求是希望其中能带有一些时间信息，这样即使我们后端的系统对消息进行了分库分表，也能够以时间顺序对这些消息进行排序。</p>
<p><em>Twitter的snowflake算法是这种场景下的一个典型解法。先来看看snowflake是怎么一回事</em>：</p>
<p><img src="/images/d0798666-9a18-403b-bdea-cdabfe94975e.png" alt=""></p>
<p><em>snowflake中的比特位分布</em></p>
<p>首先确定我们的数值是64位，int64类型，被划分为四部分，不含开头的第一个bit，因为这个bit是符号位。用41位来表示收到请求时的时间戳，单位为毫秒，然后五位来表示数据中心的id，然后再五位来表示机器的实例id，最后是12位的循环自增id（到达1111,1111,1111后会归0）。</p>
<p>这样的机制可以支持我们在同一台机器上，同一毫秒内产生<code>2 ^ 12 = 4096</code>条消息。一秒共409.6万条消息。从值域上来讲完全够用了。</p>
<p>数据中心加上实例id共有10位，可以支持我们每数据中心部署32台机器，所有数据中心共1024台实例。</p>
<p>表示<code>timestamp</code>的41位，可以支持我们使用69年。当然，我们的时间毫秒计数不会真的从1970年开始记，那样我们的系统跑到<code>2039/9/7 23:47:35</code>就不能用了，所以这里的<code>timestamp</code>实际上只是相对于某个时间的增量，比如我们的系统上线是2018-08-01，那么我们可以把这个timestamp当作是从<code>2018-08-01 00:00:00.000</code>的偏移量。</p>
<h3 id="worker_id分配">worker_id分配</h3>
<p><code>timestamp</code>，<code>datacenter_id</code>，<code>worker_id</code>和<code>sequence_id</code>这四个字段中，<code>timestamp</code>和<code>sequence_id</code>是由程序在运行期生成的。但<code>datacenter_id</code>和<code>worker_id</code>需要我们在部署阶段就能够获取得到，并且一旦程序启动之后，就是不可更改的了（想想，如果可以随意更改，可能被不慎修改，造成最终生成的id有冲突）。</p>
<p>一般不同数据中心的机器，会提供对应的获取数据中心id的API，所以<code>datacenter_id</code>我们可以在部署阶段轻松地获取到。而worker_id是我们逻辑上给机器分配的一个id，这个要怎么办呢？比较简单的想法是由能够提供这种自增id功能的工具来支持，比如MySQL:</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>mysql&gt; insert into a <span style="color:#f92672">(</span>ip<span style="color:#f92672">)</span> values<span style="color:#f92672">(</span><span style="color:#d88200">&#34;10.1.2.101&#34;</span><span style="color:#f92672">)</span><span style="color:#111">;</span>
</span></span><span style="display:flex;"><span>Query OK, <span style="color:#ae81ff">1</span> row affected <span style="color:#f92672">(</span>0.00 sec<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>mysql&gt; <span style="color:#00a8c8">select</span> last_insert_id<span style="color:#f92672">()</span><span style="color:#111">;</span>
</span></span><span style="display:flex;"><span>+------------------+
</span></span><span style="display:flex;"><span><span style="color:#111">|</span> last_insert_id<span style="color:#f92672">()</span> <span style="color:#111">|</span>
</span></span><span style="display:flex;"><span>+------------------+
</span></span><span style="display:flex;"><span><span style="color:#111">|</span>                <span style="color:#ae81ff">2</span> <span style="color:#111">|</span>
</span></span><span style="display:flex;"><span>+------------------+
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span> row in <span style="color:#111">set</span> <span style="color:#f92672">(</span>0.00 sec<span style="color:#f92672">)</span>
</span></span></code></pre></div><p>从MySQL中获取到<code>worker_id</code>之后，就把这个<code>worker_id</code>直接持久化到本地，以避免每次上线时都需要获取新的<code>worker_id</code>。让单实例的<code>worker_id</code>可以始终保持不变。</p>
<p>当然，使用MySQL相当于给我们简单的id生成服务增加了一个外部依赖。依赖越多，我们的服务的可运维性就越差。</p>
<p>考虑到集群中即使有单个id生成服务的实例挂了，也就是损失一段时间的一部分id，所以我们也可以更简单暴力一些，把<code>worker_id</code>直接写在worker的配置中，上线时，由部署脚本完成<code>worker_id</code>字段替换。</p>
<h3 id="开源实例">开源实例</h3>
<h4 id="标准snowflake实现">标准snowflake实现</h4>
<p><code>github.com/bwmarrin/snowflake</code> 是一个相当轻量化的snowflake的Go实现。其文档对各位使用的定义见<em>图 6-2</em>所示。</p>
<p><img src="/images/ae01d265-414e-4c7a-ab33-bb94ac47b6fb.png" alt=""></p>
<p><em>图 6-2 snowflake库</em></p>
<p>和标准的snowflake完全一致。使用上比较简单：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d88200">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#d88200">&#34;github.com/bwmarrin/snowflake&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">n</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">snowflake</span><span style="color:#111">.</span><span style="color:#75af00">NewNode</span><span style="color:#111">(</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">println</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">Exit</span><span style="color:#111">(</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">for</span> <span style="color:#75af00">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span><span style="color:#111">;</span> <span style="color:#75af00">i</span> <span style="color:#111">&lt;</span> <span style="color:#ae81ff">3</span><span style="color:#111">;</span> <span style="color:#75af00">i</span><span style="color:#f92672">++</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">id</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">Generate</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;id&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">id</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>            <span style="color:#d88200">&#34;node: &#34;</span><span style="color:#111">,</span> <span style="color:#75af00">id</span><span style="color:#111">.</span><span style="color:#75af00">Node</span><span style="color:#111">(),</span>
</span></span><span style="display:flex;"><span>            <span style="color:#d88200">&#34;step: &#34;</span><span style="color:#111">,</span> <span style="color:#75af00">id</span><span style="color:#111">.</span><span style="color:#75af00">Step</span><span style="color:#111">(),</span>
</span></span><span style="display:flex;"><span>            <span style="color:#d88200">&#34;time: &#34;</span><span style="color:#111">,</span> <span style="color:#75af00">id</span><span style="color:#111">.</span><span style="color:#75af00">Time</span><span style="color:#111">(),</span>
</span></span><span style="display:flex;"><span>            <span style="color:#d88200">&#34;\n&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>当然，这个库也给我们留好了定制的后路，其中预留了一些可定制字段：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>    <span style="color:#75715e">// Epoch is set to the twitter snowflake epoch of Nov 04 2010 01:42:54 UTC</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// You may customize this to set a different epoch for your application.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">Epoch</span> <span style="color:#00a8c8">int64</span> <span style="color:#111">=</span> <span style="color:#ae81ff">1288834974657</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Number of bits to use for Node</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Remember, you have a total 22 bits to share between Node/Step</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">NodeBits</span> <span style="color:#00a8c8">uint8</span> <span style="color:#111">=</span> <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Number of bits to use for Step</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Remember, you have a total 22 bits to share between Node/Step</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">StepBits</span> <span style="color:#00a8c8">uint8</span> <span style="color:#111">=</span> <span style="color:#ae81ff">12</span>
</span></span></code></pre></div><p><code>Epoch</code>就是本节开头讲的起始时间，<code>NodeBits</code>指的是机器编号的位长，<code>StepBits</code>指的是自增序列的位长。</p>
<h4 id="sonyflake">sonyflake</h4>
<p>sonyflake是Sony公司的一个开源项目，基本思路和snowflake差不多，不过位分配上稍有不同，见<em>图 6-3</em>：</p>
<p><img src="/images/aaed5ffb-d920-4e59-955f-8e52540d5351.png" alt=""></p>
<p><em>图 6-3 sonyflake</em></p>
<p>这里的时间只用了39个bit，但时间的单位变成了10ms，所以理论上比41位表示的时间还要久(174年)。</p>
<p><code>Sequence ID</code>和之前的定义一致，<code>Machine ID</code>其实就是节点id。<code>sonyflake</code>与众不同的地方在于其在启动阶段的配置参数：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">NewSonyflake</span><span style="color:#111">(</span><span style="color:#75af00">st</span> <span style="color:#75af00">Settings</span><span style="color:#111">)</span> <span style="color:#f92672">*</span><span style="color:#75af00">Sonyflake</span>
</span></span></code></pre></div><p><code>Settings</code>数据结构如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Settings</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">StartTime</span>      <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Time</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">MachineID</span>      <span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#111">(</span><span style="color:#00a8c8">uint16</span><span style="color:#111">,</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">CheckMachineID</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#00a8c8">uint16</span><span style="color:#111">)</span> <span style="color:#00a8c8">bool</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p><code>StartTime</code>选项和我们之前的<code>Epoch</code>差不多，如果不设置的话，默认是从<code>2014-09-01 00:00:00 +0000 UTC</code>开始。</p>
<p><code>MachineID</code>可以由用户自定义的函数，如果用户不定义的话，会默认将本机IP的低16位作为<code>machine id</code>。</p>
<p><code>CheckMachineID</code>是由用户提供的检查<code>MachineID</code>是否冲突的函数。这里的设计还是比较巧妙的，如果有另外的中心化存储并支持检查重复的存储，那我们就可以按照自己的想法随意定制这个检查<code>MachineID</code>是否冲突的逻辑。如果公司有现成的Redis集群，那么我们可以很轻松地用Redis的集合类型来检查冲突。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>redis 127.0.0.1:6379&gt; SADD base64_encoding_of_last16bits <span style="color:#111">MzI0Mgo</span><span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">(</span>integer<span style="color:#f92672">)</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>redis 127.0.0.1:6379&gt; SADD base64_encoding_of_last16bits <span style="color:#111">MzI0Mgo</span><span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">(</span>integer<span style="color:#f92672">)</span> <span style="color:#ae81ff">0</span>
</span></span></code></pre></div><p>使用起来也比较简单，有一些逻辑简单的函数就略去实现了：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d88200">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d88200">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#d88200">&#34;github.com/sony/sonyflake&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">getMachineID</span><span style="color:#111">()</span> <span style="color:#111">(</span><span style="color:#00a8c8">uint16</span><span style="color:#111">,</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">var</span> <span style="color:#75af00">machineID</span> <span style="color:#00a8c8">uint16</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">var</span> <span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">machineID</span> <span style="color:#111">=</span> <span style="color:#75af00">readMachineIDFromLocalFile</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">machineID</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">machineID</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">generateMachineID</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">return</span> <span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#75af00">machineID</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">checkMachineID</span><span style="color:#111">(</span><span style="color:#75af00">machineID</span> <span style="color:#00a8c8">uint16</span><span style="color:#111">)</span> <span style="color:#00a8c8">bool</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">saddResult</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">saddMachineIDToRedisSet</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#f92672">||</span> <span style="color:#75af00">saddResult</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#00a8c8">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">saveMachineIDToLocalFile</span><span style="color:#111">(</span><span style="color:#75af00">machineID</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#00a8c8">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#00a8c8">false</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">t</span><span style="color:#111">,</span> <span style="color:#75af00">_</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Parse</span><span style="color:#111">(</span><span style="color:#d88200">&#34;2006-01-02&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;2018-01-01&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">settings</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">sonyflake</span><span style="color:#111">.</span><span style="color:#75af00">Settings</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">StartTime</span><span style="color:#111">:</span>      <span style="color:#75af00">t</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">MachineID</span><span style="color:#111">:</span>      <span style="color:#75af00">getMachineID</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">CheckMachineID</span><span style="color:#111">:</span> <span style="color:#75af00">checkMachineID</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">sf</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">sonyflake</span><span style="color:#111">.</span><span style="color:#75af00">NewSonyflake</span><span style="color:#111">(</span><span style="color:#75af00">settings</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">id</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">sf</span><span style="color:#111">.</span><span style="color:#75af00">NextID</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">Exit</span><span style="color:#111">(</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">id</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="分布式锁">分布式锁</h2>
<p>在单机程序并发或并行修改全局变量时，需要对修改行为加锁以创造临界区。为什么需要加锁呢？我们看看在不加锁的情况下并发计数会发生什么情况：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d88200">&#34;sync&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 全局变量</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">var</span> <span style="color:#75af00">counter</span> <span style="color:#00a8c8">int</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">var</span> <span style="color:#75af00">wg</span> <span style="color:#75af00">sync</span><span style="color:#111">.</span><span style="color:#75af00">WaitGroup</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">for</span> <span style="color:#75af00">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span><span style="color:#111">;</span> <span style="color:#75af00">i</span> <span style="color:#111">&lt;</span> <span style="color:#ae81ff">1000</span><span style="color:#111">;</span> <span style="color:#75af00">i</span><span style="color:#f92672">++</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">wg</span><span style="color:#111">.</span><span style="color:#75af00">Add</span><span style="color:#111">(</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">go</span> <span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">defer</span> <span style="color:#75af00">wg</span><span style="color:#111">.</span><span style="color:#75af00">Done</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75af00">counter</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">wg</span><span style="color:#111">.</span><span style="color:#75af00">Wait</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">println</span><span style="color:#111">(</span><span style="color:#75af00">counter</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>多次运行会得到不同的结果：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>❯❯❯ go run local_lock.go
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">945</span>
</span></span><span style="display:flex;"><span>❯❯❯ go run local_lock.go
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">937</span>
</span></span><span style="display:flex;"><span>❯❯❯ go run local_lock.go
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">959</span>
</span></span></code></pre></div><h3 id="基于redis的setnx">基于Redis的setnx</h3>
<p>在分布式场景下，我们也需要这种“抢占”的逻辑，这时候怎么办呢？我们可以使用Redis提供的<code>setnx</code>命令：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;github.com/go-redis/redis&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;github.com/gofrs/uuid&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 声明一个全局的rdb变量</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">var</span> <span style="color:#75af00">rdb</span> <span style="color:#f92672">*</span><span style="color:#75af00">redis</span><span style="color:#111">.</span><span style="color:#75af00">Client</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 初始化连接</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">initClient</span><span style="color:#111">()</span> <span style="color:#111">(</span><span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">rdb</span> <span style="color:#111">=</span> <span style="color:#75af00">redis</span><span style="color:#111">.</span><span style="color:#75af00">NewClient</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">redis</span><span style="color:#111">.</span><span style="color:#75af00">Options</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">Addr</span><span style="color:#111">:</span>     <span style="color:#d88200">&#34;localhost:6379&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">Password</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;zhy1996&#34;</span><span style="color:#111">,</span> <span style="color:#75715e">// no password set</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">DB</span><span style="color:#111">:</span>       <span style="color:#ae81ff">0</span><span style="color:#111">,</span>         <span style="color:#75715e">// use default DB</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">rdb</span><span style="color:#111">.</span><span style="color:#75af00">Ping</span><span style="color:#111">().</span><span style="color:#75af00">Result</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">var</span> <span style="color:#75af00">unlock_lua</span> <span style="color:#111">=</span> <span style="color:#d88200">`
</span></span></span><span style="display:flex;"><span><span style="color:#d88200">if redis.call(&#34;get&#34;,KEYS[1]) == ARGV[1] then
</span></span></span><span style="display:flex;"><span><span style="color:#d88200">	return redis.call(&#34;del&#34;,KEYS[1])
</span></span></span><span style="display:flex;"><span><span style="color:#d88200">else
</span></span></span><span style="display:flex;"><span><span style="color:#d88200">	return 0
</span></span></span><span style="display:flex;"><span><span style="color:#d88200">end
</span></span></span><span style="display:flex;"><span><span style="color:#d88200">`</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">Lock</span><span style="color:#111">(</span><span style="color:#75af00">key</span><span style="color:#111">,</span> <span style="color:#75af00">value</span> <span style="color:#00a8c8">string</span><span style="color:#111">,</span> <span style="color:#75af00">expiration</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Duration</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#00a8c8">bool</span><span style="color:#111">,</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">is</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">rdb</span><span style="color:#111">.</span><span style="color:#75af00">SetNX</span><span style="color:#111">(</span><span style="color:#75af00">key</span><span style="color:#111">,</span> <span style="color:#75af00">value</span><span style="color:#111">,</span> <span style="color:#75af00">expiration</span><span style="color:#111">).</span><span style="color:#75af00">Result</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">false</span><span style="color:#111">,</span> <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;redis setnx failed&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">is</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">UnLock</span><span style="color:#111">(</span><span style="color:#75af00">key</span><span style="color:#111">,</span> <span style="color:#75af00">value</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#00a8c8">bool</span><span style="color:#111">,</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">res</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">rdb</span><span style="color:#111">.</span><span style="color:#75af00">Eval</span><span style="color:#111">(</span><span style="color:#75af00">unlock_lua</span><span style="color:#111">,</span> <span style="color:#111">[]</span><span style="color:#00a8c8">string</span><span style="color:#111">{</span><span style="color:#75af00">key</span><span style="color:#111">},</span> <span style="color:#75af00">value</span><span style="color:#111">).</span><span style="color:#75af00">Result</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">false</span><span style="color:#111">,</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">v</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">res</span><span style="color:#111">.(</span><span style="color:#00a8c8">int64</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">false</span><span style="color:#111">,</span> <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;lua script return is not int&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">v</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">false</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">true</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">initClient</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ul</span><span style="color:#111">,</span> <span style="color:#75af00">_</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">uuid</span><span style="color:#111">.</span><span style="color:#75af00">NewV4</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">value</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">ul</span><span style="color:#111">.</span><span style="color:#75af00">String</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span><span style="color:#111">;</span> <span style="color:#75af00">i</span> <span style="color:#111">&lt;</span> <span style="color:#ae81ff">10</span><span style="color:#111">;</span> <span style="color:#75af00">i</span><span style="color:#f92672">++</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">is</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">Lock</span><span style="color:#111">(</span><span style="color:#d88200">&#34;lock_1&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">value</span><span style="color:#111">,</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Second</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;是否拿到锁:&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">is</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">res</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">UnLock</span><span style="color:#111">(</span><span style="color:#d88200">&#34;lock_1&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">value</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;解锁:&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">res</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>看看运行结果：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>是否拿到锁: <span style="color:#111">true</span>
</span></span><span style="display:flex;"><span>是否拿到锁: <span style="color:#111">false</span>
</span></span><span style="display:flex;"><span>是否拿到锁: <span style="color:#111">false</span>
</span></span><span style="display:flex;"><span>是否拿到锁: <span style="color:#111">false</span>
</span></span><span style="display:flex;"><span>是否拿到锁: <span style="color:#111">false</span>
</span></span><span style="display:flex;"><span>是否拿到锁: <span style="color:#111">false</span>
</span></span><span style="display:flex;"><span>是否拿到锁: <span style="color:#111">false</span>
</span></span><span style="display:flex;"><span>是否拿到锁: <span style="color:#111">false</span>
</span></span><span style="display:flex;"><span>是否拿到锁: <span style="color:#111">false</span>
</span></span><span style="display:flex;"><span>是否拿到锁: <span style="color:#111">false</span>
</span></span><span style="display:flex;"><span>解锁: <span style="color:#111">true</span>
</span></span></code></pre></div><p>通过代码和执行结果可以看到，我们远程调用<code>setnx</code>实际上和单机的trylock非常相似，如果获取锁失败，那么相关的任务逻辑就不应该继续向前执行。</p>
<p><code>setnx</code>很适合在高并发场景下，用来争抢一些“唯一”的资源。比如交易撮合系统中卖家发起订单，而多个买家会对其进行并发争抢。这种场景我们没有办法依赖具体的时间来判断先后，因为不管是用户设备的时间，还是分布式场景下的各台机器的时间，都是没有办法在合并后保证正确的时序的。哪怕是我们同一个机房的集群，不同的机器的系统时间可能也会有细微的差别。</p>
<p>所以，我们需要依赖于这些请求到达Redis节点的顺序来做正确的抢锁操作。如果用户的网络环境比较差，那也只能自求多福了。</p>
<h3 id="基于etcd">基于etcd</h3>
<p>etcd是分布式系统中，功能上与ZooKeeper类似的组件，这两年越来越火了。上面基于ZooKeeper我们实现了分布式阻塞锁，基于etcd，也可以实现类似的功能：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d88200">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#d88200">&#34;github.com/zieckey/etcdsync&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">m</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">etcdsync</span><span style="color:#111">.</span><span style="color:#75af00">New</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/lock&#34;</span><span style="color:#111">,</span> <span style="color:#ae81ff">10</span><span style="color:#111">,</span> <span style="color:#111">[]</span><span style="color:#00a8c8">string</span><span style="color:#111">{</span><span style="color:#d88200">&#34;http://127.0.0.1:2379&#34;</span><span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">m</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#f92672">||</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;etcdsync.New failed&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">Lock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;etcdsync.Lock failed&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;etcdsync.Lock OK&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Get the lock. Do something here.&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">Unlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;etcdsync.Unlock failed&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;etcdsync.Unlock OK&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>etcd中没有像ZooKeeper那样的Sequence节点。所以其锁实现和基于ZooKeeper实现的有所不同。在上述示例代码中使用的etcdsync的Lock流程是：</p>
<ol>
<li>先检查<code>/lock</code>路径下是否有值，如果有值，说明锁已经被别人抢了</li>
<li>如果没有值，那么写入自己的值。写入成功返回，说明加锁成功。写入时如果节点被其它节点写入过了，那么会导致加锁失败，这时候到 3</li>
<li>watch <code>/lock</code>下的事件，此时陷入阻塞</li>
<li>当<code>/lock</code>路径下发生事件时，当前进程被唤醒。检查发生的事件是否是删除事件（说明锁被持有者主动unlock），或者过期事件（说明锁过期失效）。如果是的话，那么回到 1，走抢锁流程。</li>
</ol>
<p>值得一提的是，在etcdv3的API中官方已经提供了可以直接使用的锁API，读者可以查阅etcd的文档做进一步的学习。</p>
<p>参考文章：《go语言高级编程》</p>
]]></content:encoded><category>microservice</category><category>redis</category><category>etcd</category></item><item><title>thrift的介绍及其使用</title><link>https://daemon365.dev/post/microservice/introduction_and_use_of_thrift/</link><pubDate>Wed, 30 Dec 2020 00:00:00 +0800</pubDate><guid>https://daemon365.dev/post/microservice/introduction_and_use_of_thrift/</guid><description>&lt;h2 id="什么是thrift"&gt;什么是thrift&lt;/h2&gt;
&lt;p&gt;Thrift是Facebook于2007年开发的跨语言的rpc服框架，提供多语言的编译功能，并提供多种服务器工作模式；用户通过Thrift的IDL（接口定义语言）来描述接口函数及数据类型，然后通过Thrift的编译环境生成各种语言类型的接口文件，用户可以根据自己的需要采用不同的语言开发客户端代码和服务器端代码。&lt;/p&gt;
&lt;p&gt;例如，我想开发一个快速计算的RPC服务，它主要通过接口函数getInt对外提供服务，这个RPC服务的getInt函数使用用户传入的参数，经过复杂的计算，计算出一个整形值返回给用户；服务器端使用java语言开发，而调用客户端可以是java、c、python等语言开发的程序，在这种应用场景下，我们只需要使用Thrift的IDL描述一下getInt函数（以.thrift为后缀的文件），然后使用Thrift的多语言编译功能，将这个IDL文件编译成C、java、python几种语言对应的“特定语言接口文件”（每种语言只需要一条简单的命令即可编译完成），这样拿到对应语言的“特定语言接口文件”之后，就可以开发客户端和服务器端的代码了，开发过程中只要接口不变，客户端和服务器端的开发可以独立的进行。&lt;/p&gt;
&lt;p&gt;Thrift为服务器端程序提供了很多的工作模式，例如：线程池模型、非阻塞模型等等，可以根据自己的实际应用场景选择一种工作模式高效地对外提供服务；&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Thrift的官方网站：http://thrift.apache.org/&lt;/strong&gt;&lt;/p&gt;
&lt;h2 id="thrift的协议结构"&gt;thrift的协议结构&lt;/h2&gt;
&lt;p&gt;&lt;img src="https://daemon365.dev/images/db700a52-4aa0-49f2-aa47-2fd759a99b44.png" alt=""&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src="https://daemon365.dev/images/767a4b7a-7cfd-44a0-a616-263a3b3bc501.png" alt=""&gt;&lt;/p&gt;
&lt;p&gt;Thrift是一种c/s的架构体系。TServer主要任务是高效的接受客户端请求，并将请求转发给Processor处理。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;最上层是用户自行实现的业务逻辑代码；&lt;/li&gt;
&lt;li&gt;Processor是由thrift编译器自动生成的代码，它封装了从输入数据流中读数据和向数据流中写数据的操作，它的主要工作是：从连接中读取数据，把处理交给用户实现impl，最后把结果写到连接上。&lt;/li&gt;
&lt;li&gt;TProtocol是用于数据类型解析的，将结构化数据转化为字节流给TTransport进行传输。从TProtocol以下部分是thirft的传输协议和底层I/O通信。&lt;/li&gt;
&lt;li&gt;TTransport是与底层数据传输密切相关的传输层，负责以字节流方式接收和发送消息体，不关注是什么数据类型。&lt;/li&gt;
&lt;li&gt;底层IO负责实际的数据传输，包括socket、文件和压缩数据流等。&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="下载"&gt;下载&lt;/h2&gt;
&lt;p&gt;下载thrift编译软件:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;MacOs:&lt;code&gt;brew install thrift&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;Windows:Thrift官方下载地址：http://thrift.apache.org/download&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;golang下载: &lt;code&gt;go get github.com/apache/thrift/lib/go/thrift&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;python下载: &lt;code&gt;sudo pip install thrift&lt;/code&gt;&lt;/p&gt;
&lt;h2 id="idl文件编写"&gt;IDL文件编写&lt;/h2&gt;
&lt;p&gt;thrift 采用IDL（Interface Definition Language）来定义通用的服务接口，并通过生成不同的语言代理实现来达到跨语言、平台的功能。在thrift的IDL中可以定义以下一些类型：基本数据类型，结构体，容器，异常、服务&lt;/p&gt;
&lt;h3 id="基本类型"&gt;基本类型&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;bool: 布尔值 (true or false), one byte&lt;/li&gt;
&lt;li&gt;byte: 有符号字节&lt;/li&gt;
&lt;li&gt;i16: 16位有符号整型&lt;/li&gt;
&lt;li&gt;i32: 32位有符号整型&lt;/li&gt;
&lt;li&gt;i64: 64位有符号整型&lt;/li&gt;
&lt;li&gt;double: 64位浮点型&lt;/li&gt;
&lt;li&gt;string: Encoding agnostic text or binary string&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;基本类型中基本都是有符号数，因为有些语言没有无符号数，所以Thrift不支持无符号整型。&lt;/p&gt;
&lt;h3 id="特殊类型"&gt;特殊类型&lt;/h3&gt;
&lt;p&gt;binary: Blob (byte array) a sequence of unencoded bytes&lt;/p&gt;</description><content:encoded><![CDATA[<h2 id="什么是thrift">什么是thrift</h2>
<p>Thrift是Facebook于2007年开发的跨语言的rpc服框架，提供多语言的编译功能，并提供多种服务器工作模式；用户通过Thrift的IDL（接口定义语言）来描述接口函数及数据类型，然后通过Thrift的编译环境生成各种语言类型的接口文件，用户可以根据自己的需要采用不同的语言开发客户端代码和服务器端代码。</p>
<p>例如，我想开发一个快速计算的RPC服务，它主要通过接口函数getInt对外提供服务，这个RPC服务的getInt函数使用用户传入的参数，经过复杂的计算，计算出一个整形值返回给用户；服务器端使用java语言开发，而调用客户端可以是java、c、python等语言开发的程序，在这种应用场景下，我们只需要使用Thrift的IDL描述一下getInt函数（以.thrift为后缀的文件），然后使用Thrift的多语言编译功能，将这个IDL文件编译成C、java、python几种语言对应的“特定语言接口文件”（每种语言只需要一条简单的命令即可编译完成），这样拿到对应语言的“特定语言接口文件”之后，就可以开发客户端和服务器端的代码了，开发过程中只要接口不变，客户端和服务器端的开发可以独立的进行。</p>
<p>Thrift为服务器端程序提供了很多的工作模式，例如：线程池模型、非阻塞模型等等，可以根据自己的实际应用场景选择一种工作模式高效地对外提供服务；</p>
<p><strong>Thrift的官方网站：http://thrift.apache.org/</strong></p>
<h2 id="thrift的协议结构">thrift的协议结构</h2>
<p><img src="/images/db700a52-4aa0-49f2-aa47-2fd759a99b44.png" alt=""></p>
<p><img src="/images/767a4b7a-7cfd-44a0-a616-263a3b3bc501.png" alt=""></p>
<p>Thrift是一种c/s的架构体系。TServer主要任务是高效的接受客户端请求，并将请求转发给Processor处理。</p>
<ul>
<li>最上层是用户自行实现的业务逻辑代码；</li>
<li>Processor是由thrift编译器自动生成的代码，它封装了从输入数据流中读数据和向数据流中写数据的操作，它的主要工作是：从连接中读取数据，把处理交给用户实现impl，最后把结果写到连接上。</li>
<li>TProtocol是用于数据类型解析的，将结构化数据转化为字节流给TTransport进行传输。从TProtocol以下部分是thirft的传输协议和底层I/O通信。</li>
<li>TTransport是与底层数据传输密切相关的传输层，负责以字节流方式接收和发送消息体，不关注是什么数据类型。</li>
<li>底层IO负责实际的数据传输，包括socket、文件和压缩数据流等。</li>
</ul>
<h2 id="下载">下载</h2>
<p>下载thrift编译软件:</p>
<ul>
<li>MacOs:<code>brew install thrift</code></li>
<li>Windows:Thrift官方下载地址：http://thrift.apache.org/download</li>
</ul>
<p>golang下载: <code>go get github.com/apache/thrift/lib/go/thrift</code></p>
<p>python下载: <code>sudo pip install thrift</code></p>
<h2 id="idl文件编写">IDL文件编写</h2>
<p>thrift 采用IDL（Interface Definition Language）来定义通用的服务接口，并通过生成不同的语言代理实现来达到跨语言、平台的功能。在thrift的IDL中可以定义以下一些类型：基本数据类型，结构体，容器，异常、服务</p>
<h3 id="基本类型">基本类型</h3>
<ul>
<li>bool: 布尔值 (true or false), one byte</li>
<li>byte: 有符号字节</li>
<li>i16: 16位有符号整型</li>
<li>i32: 32位有符号整型</li>
<li>i64: 64位有符号整型</li>
<li>double: 64位浮点型</li>
<li>string: Encoding agnostic text or binary string</li>
</ul>
<p>基本类型中基本都是有符号数，因为有些语言没有无符号数，所以Thrift不支持无符号整型。</p>
<h3 id="特殊类型">特殊类型</h3>
<p>binary: Blob (byte array) a sequence of unencoded bytes</p>
<p>这是string类型的一种变形，主要是为<a href="http://lib.csdn.net/base/javase">Java</a>使用，目前我主要使用C++的语言，所以java的这个类型没有用过</p>
<h3 id="struct">struct</h3>
<p>thrift中struct是定义为一种对象，和面向对象语言的class差不多.,但是struct有以下一些约束：</p>
<ul>
<li>struct不能继承，但是可以嵌套，不能嵌套自己。</li>
<li>其成员都是有明确类型</li>
<li>成员是被正整数编号过的，其中的编号使不能重复的，这个是为了在传输过程中编码使用。</li>
<li>成员分割符可以是逗号（,）或是分号（;），而且可以混用，但是为了清晰期间，建议在定义中只使用一种，比如C++学习者可以就使用分号（;）。</li>
<li>字段会有optional和required之分和protobuf一样，但是如果不指定则为无类型—可以不填充该值，但是在序列化传输的时候也会序列化进去，optional是不填充则部序列化，required是必须填充也必须序列化。</li>
<li>每个字段可以设置默认值</li>
<li>同一文件可以定义多个struct，也可以定义在不同的文件，进行include引入。</li>
</ul>
<p>数字标签作用非常大，但是随着项目开发的不断发展，也许字段会有变化，但是建议不要轻易修改这些数字标签，修改之后如果没有同步客户端和服务器端会让一方解析出问题。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">struct</span> <span style="color:#75af00">Report</span> <span style="color:#111">{</span>  
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">1</span><span style="color:#111">:</span> <span style="color:#75af00">required</span> <span style="color:#00a8c8">string</span> <span style="color:#75af00">msg</span><span style="color:#111">,</span> <span style="color:#75715e">//改字段必须填写  </span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">2</span><span style="color:#111">:</span> <span style="color:#75af00">optional</span> <span style="color:#75af00">i32</span> <span style="color:#00a8c8">type</span> <span style="color:#111">=</span> <span style="color:#ae81ff">0</span><span style="color:#111">;</span> <span style="color:#75715e">//默认值  </span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">3</span><span style="color:#111">:</span> <span style="color:#75af00">i32</span> <span style="color:#75af00">time</span> <span style="color:#75715e">//默认字段类型为optional </span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>规范的struct定义中的每个域均会使用required或者 optional关键字进行标识。如果required标识的域没有赋值，Thrift将给予提示；如果optional标识的域没有赋值，该域将不会被序列化传输；如果某个optional标识域有缺省值而用户没有重新赋值，则该域的值一直为缺省值；如果某个optional标识域有缺省值或者用户已经重新赋值，而不设置它的__isset为true，也不会被序列化传输。</p>
<h3 id="容器containers">容器（Containers）</h3>
<p>　　Thrift容器与目前流行编程语言的容器类型相对应，有3种可用容器类型：</p>
<ul>
<li>list<t>: 元素类型为t的有序表，容许元素重复。对应c++的vector，java的ArrayList或者其他语言的数组（官方文档说是ordered list不知道如何理解？排序的？c++的vector不排序）</li>
<li>set<t>:元素类型为t的无序表，不容许元素重复。对应c++中的set，java中的HashSet,python中的set，php中没有set，则转换为list类型了</li>
<li>map&lt;t,t&gt;: 键类型为t，值类型为t的kv对，键不容许重复。对用c++中的map, Java的HashMap, PHP 对应 array, Python/Ruby 的dictionary。</li>
</ul>
<p>　　容器中元素类型可以是除了service外的任何合法Thrift类型（包括结构体和异常）。为了最大的兼容性，map的key最好是thrift的基本类型，有些语言不支持复杂类型的key，JSON协议只支持那些基本类型的key。</p>
<p>容器都是同构容器，不失异构容器。</p>
<p>例子</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">struct</span> <span style="color:#75af00">Test</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">1</span><span style="color:#111">:</span> <span style="color:#00a8c8">map</span><span style="color:#111">&lt;</span><span style="color:#75af00">Numberz</span><span style="color:#111">,</span> <span style="color:#75af00">UserId</span><span style="color:#111">&gt;</span> <span style="color:#75af00">user_map</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">2</span><span style="color:#111">:</span> <span style="color:#75af00">set</span><span style="color:#111">&lt;</span><span style="color:#75af00">Numberz</span><span style="color:#111">&gt;</span> <span style="color:#75af00">num_sets</span><span style="color:#111">,</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">3</span><span style="color:#111">:</span> <span style="color:#75af00">list</span><span style="color:#111">&lt;</span><span style="color:#75af00">Stusers</span><span style="color:#111">&gt;</span> <span style="color:#75af00">users</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="枚举enmu">枚举（enmu）</h3>
<p>很多语言都有枚举，意义都一样。比如，当定义一个消息类型时，它只能是预定义的值列表中的一个，可以用枚举实现。说明：</p>
<ul>
<li>编译器默认从0开始赋值</li>
<li>可以赋予某个常量某个整数</li>
<li>允许常量是十六进制整数</li>
<li>末尾没有分号</li>
<li>给常量赋缺省值时，使用常量的全称</li>
</ul>
<p>　　注意，不同于protocal buffer，thrift不支持枚举类嵌套，枚举常量必须是32位的正整数</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">enum</span> <span style="color:#75af00">EnOpType</span> <span style="color:#111">{</span><span style="color:#75af00">CMD_OK</span> <span style="color:#111">=</span> <span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#75715e">// (0)  </span>
</span></span><span style="display:flex;"><span>               <span style="color:#75af00">CMD_NOT_EXIT</span> <span style="color:#111">=</span> <span style="color:#ae81ff">2000</span><span style="color:#111">,</span> <span style="color:#75715e">// (2000) </span>
</span></span><span style="display:flex;"><span>               <span style="color:#75af00">CMD_EXIT</span> <span style="color:#111">=</span> <span style="color:#ae81ff">2001</span><span style="color:#111">,</span> <span style="color:#75715e">// (2001) 　　</span>
</span></span><span style="display:flex;"><span>               <span style="color:#75af00">CMD_ADD</span> <span style="color:#111">=</span> <span style="color:#ae81ff">2002</span> <span style="color:#75715e">// (2002)</span>
</span></span><span style="display:flex;"><span>              <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">struct</span> <span style="color:#75af00">StUser</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">1</span><span style="color:#111">:</span> <span style="color:#75af00">required</span> <span style="color:#75af00">i32</span> <span style="color:#75af00">userId</span><span style="color:#111">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">2</span><span style="color:#111">:</span> <span style="color:#75af00">required</span> <span style="color:#00a8c8">string</span> <span style="color:#75af00">userName</span><span style="color:#111">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">3</span><span style="color:#111">:</span> <span style="color:#75af00">optional</span> <span style="color:#75af00">EnOpType</span> <span style="color:#75af00">cmd_code</span> <span style="color:#111">=</span> <span style="color:#75af00">EnOpType</span><span style="color:#111">.</span><span style="color:#75af00">CMD_OK</span><span style="color:#111">;</span> <span style="color:#75715e">// (0)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">4</span><span style="color:#111">:</span> <span style="color:#75af00">optional</span> <span style="color:#00a8c8">string</span> <span style="color:#75af00">language</span> <span style="color:#111">=</span> <span style="color:#960050;background-color:#1e0010">“</span><span style="color:#75af00">english</span><span style="color:#960050;background-color:#1e0010">”</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="常量定义和类型定义">常量定义和类型定义</h3>
<p>　　Thrift允许定义跨语言使用的常量，复杂的类型和结构体可使用JSON形式表示。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">const</span> <span style="color:#75af00">i32</span> <span style="color:#75af00">INT_CONST</span> <span style="color:#111">=</span> <span style="color:#ae81ff">1234</span><span style="color:#111">;</span> <span style="color:#00a8c8">const</span> <span style="color:#75af00">EnOpType</span> <span style="color:#75af00">myEnOpType</span> <span style="color:#111">=</span> <span style="color:#75af00">EnOpType</span><span style="color:#111">.</span><span style="color:#75af00">CMD_EXIT</span><span style="color:#111">;</span> <span style="color:#75715e">//2001</span>
</span></span></code></pre></div><p>　说明：分号可有可无。支持16进制。　　</p>
<p>Thrift支持C/C++类型定义。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">typedef</span> <span style="color:#75af00">i32</span> <span style="color:#75af00">MyInteger</span> <span style="color:#75715e">// a </span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">typedef</span> <span style="color:#75af00">StUser</span> <span style="color:#75af00">ReU</span> <span style="color:#75715e">// b </span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">typedef</span> <span style="color:#75af00">i64</span> <span style="color:#75af00">UserId</span>
</span></span></code></pre></div><p>　说明：a.末尾没有逗号。b. Struct也可以使用typedef。</p>
<h3 id="异常exceptions">异常（Exceptions）</h3>
<p>　　Thrift结构体在概念上类似于（similar to）C语言结构体类型—将相关属性封装在一起的简便方式。Thrift结构体将会被转换成面向对象语言的类。</p>
<p>　　异常在语法和功能上类似于结构体，差别是异常使用关键字exception，而且异常是继承每种语言的基础异常类。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">exception</span> <span style="color:#75af00">Extest</span> <span style="color:#111">{</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">1</span><span style="color:#111">:</span> <span style="color:#75af00">i32</span> <span style="color:#75af00">errorCode</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">2</span><span style="color:#111">:</span> <span style="color:#00a8c8">string</span> <span style="color:#75af00">message</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">3</span><span style="color:#111">:</span> <span style="color:#75af00">StUser</span> <span style="color:#75af00">userinfo</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="服务services">服务（Services）</h3>
<p>　　服务的定义方法在语义(semantically)上等同于面向对象语言中的接口。Thrift编译器会产生执行这些接口的client和server stub。具体参见下一节。</p>
<p>　　在流行的序列化/反序列化框架（如protocal buffer）中，Thrift是少有的提供多语言间RPC服务的框架。这是Thrift的一大特色。</p>
<p>　　Thrift编译器会根据选择的目标语言为server产生服务接口代码，为client产生stubs。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">service</span> <span style="color:#75af00">SeTest</span> <span style="color:#111">{</span>   <span style="color:#75af00">void</span> <span style="color:#75af00">ping</span><span style="color:#111">(),</span>   <span style="color:#00a8c8">bool</span> <span style="color:#75af00">postTweet</span><span style="color:#111">(</span><span style="color:#ae81ff">1</span><span style="color:#111">:</span> <span style="color:#75af00">StUser</span> <span style="color:#75af00">user</span><span style="color:#111">);</span>   
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">StUser</span> <span style="color:#75af00">searchTweets</span><span style="color:#111">(</span><span style="color:#ae81ff">1</span><span style="color:#111">:</span><span style="color:#00a8c8">string</span> <span style="color:#75af00">name</span><span style="color:#111">);</span>  
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">oneway</span> <span style="color:#75af00">void</span> <span style="color:#75af00">zip</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>　
</span></span></code></pre></div><ul>
<li>首先所有的方法都是纯虚汗数，也就是继承类必须实现这些方法</li>
<li>返回值不是基本类型的都把返回值放到了函数参数中第一个参数，命名_return</li>
<li>所有的参数（除返回值）都是const类型，意味这函数一般参数无法作为返回值携带者。只会有一个返回参数，如果返回值有多个，那只能封装复杂类型作为返回值参数。</li>
<li>oneway的返回值一定是void</li>
<li>当然服务是支持继承。</li>
<li>服务不支持重载</li>
</ul>
<h3 id="名字空间namespace">名字空间（Namespace）</h3>
<p>Thrift中的命名空间类似于C++中的namespace和java中的package，它们提供了一种组织（隔离）代码的简便方式。名字空间也可以用于解决类型定义中的名字冲突。</p>
<p>由于每种语言均有自己的命名空间定义方式（如<a href="http://lib.csdn.net/base/python">Python</a>中有module）, thrift允许开发者针对特定语言定义namespace：</p>
<pre tabindex="0"><code>namespace go com.example.test
namespace py com.example.test  
namespace php com.example.test  
</code></pre><h3 id="注释comment">注释（Comment）</h3>
<p>　　Thrift支持C多行风格和Java/C++单行风格。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">/* 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">* This is a multi-line comment. 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">* Just like in C. 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span> 
</span></span><span style="display:flex;"><span><span style="color:#75715e">// C++/Java style single-line comments work just as well.</span>
</span></span></code></pre></div><h3 id="11includes">11Includes</h3>
<p>　　便于管理、重用和提高模块性/组织性，我们常常分割Thrift定义在不同的文件中。包含文件搜索方式与c++一样。Thrift允许文件包含其它thrift文件，用户需要使用thrift文件名作为前缀访问被包含的对象，如：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">include</span> <span style="color:#d88200">&#34;test.thrift&#34;</span>    
</span></span><span style="display:flex;"><span><span style="color:#f92672">...</span> 
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">struct</span> <span style="color:#75af00">StSearchResult</span> <span style="color:#111">{</span>    
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">1</span><span style="color:#111">:</span> <span style="color:#75af00">in32</span> <span style="color:#75af00">uid</span><span style="color:#111">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">...</span> 
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>thrift文件名要用双引号包含，末尾没有逗号或者分号</p>
<h2 id="thrift支持的传输及服务模型">Thrift支持的传输及服务模型</h2>
<h3 id="支持的传输格式">支持的传输格式：</h3>
<table>
  <thead>
      <tr>
          <th style="text-align: left">参数:</th>
          <th>描述:</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">TBinaryProtocol</td>
          <td>二进制格式</td>
      </tr>
      <tr>
          <td style="text-align: left">TCompactProtocol</td>
          <td>压缩格式</td>
      </tr>
      <tr>
          <td style="text-align: left">TJSONProtocol</td>
          <td>JSON格式</td>
      </tr>
      <tr>
          <td style="text-align: left">TSimpleJSONProtocol</td>
          <td>提供JSON只写协议, 生成的文件很容易通过脚本语言解析</td>
      </tr>
      <tr>
          <td style="text-align: left">TDebugProtocol</td>
          <td>使用易懂的可读的文本格式，以便于debug</td>
      </tr>
  </tbody>
</table>
<h3 id="支持的数据传输方式">支持的数据传输方式：</h3>
<table>
  <thead>
      <tr>
          <th>参数:</th>
          <th>描述:</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>TSocket</td>
          <td>阻塞式socker</td>
      </tr>
      <tr>
          <td>TFramedTransport</td>
          <td>以frame为单位进行传输，非阻塞式服务中使用</td>
      </tr>
      <tr>
          <td>TFileTransport</td>
          <td>以文件形式进行传输</td>
      </tr>
      <tr>
          <td>TMemoryTransport</td>
          <td>将内存用于I/O. java实现时内部实际使用了简单的ByteArrayOutputStream</td>
      </tr>
      <tr>
          <td>TZlibTransport</td>
          <td>使用zlib进行压缩， 与其他传输方式联合使用。当前无java实现</td>
      </tr>
  </tbody>
</table>
<h3 id="支持的服务模型">支持的服务模型：</h3>
<table>
  <thead>
      <tr>
          <th>参数:</th>
          <th>描述:</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>TSimpleServer</td>
          <td>简单的单线程服务模型，常用于测试</td>
      </tr>
      <tr>
          <td>TThreadPoolServer</td>
          <td>多线程服务模型，使用标准的阻塞式IO</td>
      </tr>
      <tr>
          <td>TNonblockingServer</td>
          <td>多线程服务模型，使用非阻塞式IO（需使用TFramedTransport数据传输方式）</td>
      </tr>
  </tbody>
</table>
<h2 id="代码实现">代码实现</h2>
<h3 id="编写thrift文件">编写*.thrift文件</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">namespace</span> <span style="color:#00a8c8">go</span> <span style="color:#75af00">example</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">struct</span> <span style="color:#75af00">Data</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">1</span><span style="color:#111">:</span> <span style="color:#00a8c8">string</span> <span style="color:#75af00">text</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">service</span> <span style="color:#75af00">format_data</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">Data</span> <span style="color:#75af00">do_format</span><span style="color:#111">(</span><span style="color:#ae81ff">1</span><span style="color:#111">:</span><span style="color:#75af00">Data</span> <span style="color:#75af00">data</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>解析成go代码:<code>thrift --out . --gen go example.thrift</code></p>
<p>解析成python代码:<code>thrift --out . --gen py example.thrift</code></p>
<h3 id="golang服务端">golang服务端</h3>
<p>服务端的实现:</p>
<ol>
<li>Handler
<ul>
<li>服务端业务处理逻辑。这里就是业务代码，比如 计算两个字符串 相似度</li>
</ul>
</li>
<li>Processor
<ul>
<li>从Thrift框架 转移到 业务处理逻辑。因此是RPC调用，客户端要把 参数发送给服务端，而这一切由Thrift封装起来了，由Processor将收到的“数据”转交给业务逻辑去处理</li>
</ul>
</li>
<li>Protocol
<ul>
<li>数据的序列化与反序列化。客户端提供的是“字符串”，而数据传输是一个个的字节，因此会用到序列化与反序列化。</li>
</ul>
</li>
<li>Transport
<ul>
<li>传输层的数据传输。</li>
</ul>
</li>
<li>TServer
<ul>
<li>服务端的类型。服务器以何种方式来处理客户端请求</li>
<li>TSimpleServer —— 单线程服务器端使用标准的阻塞式 I/O</li>
<li>TThreadPoolServer —— 多线程服务器端使用标准的阻塞式 I/O</li>
<li>TNonblockingServer —— 多线程服务器端使用非阻塞式 I/O</li>
</ul>
</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">/* server.go */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;context&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;test/example&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;github.com/apache/thrift/lib/go/thrift&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">FormatDataImpl</span> <span style="color:#00a8c8">struct</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">fdi</span> <span style="color:#f92672">*</span><span style="color:#75af00">FormatDataImpl</span><span style="color:#111">)</span> <span style="color:#75af00">DoFormat</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#75af00">r</span> <span style="color:#00a8c8">string</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#d88200">&#34;不好&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">const</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">HOST</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;127.0.0.1&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">PORT</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;8080&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">handler</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">FormatDataImpl</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">processor</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">example</span><span style="color:#111">.</span><span style="color:#75af00">NewFormatDataProcessor</span><span style="color:#111">(</span><span style="color:#75af00">handler</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">serverTransport</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">thrift</span><span style="color:#111">.</span><span style="color:#75af00">NewTServerSocket</span><span style="color:#111">(</span><span style="color:#75af00">HOST</span> <span style="color:#f92672">+</span> <span style="color:#d88200">&#34;:&#34;</span> <span style="color:#f92672">+</span> <span style="color:#75af00">PORT</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Fatalln</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Error:&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">transportFactory</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">thrift</span><span style="color:#111">.</span><span style="color:#75af00">NewTBufferedTransportFactory</span><span style="color:#111">(</span><span style="color:#ae81ff">10000000</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">protocolFactory</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">thrift</span><span style="color:#111">.</span><span style="color:#75af00">NewTBinaryProtocolFactoryDefault</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">server</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">thrift</span><span style="color:#111">.</span><span style="color:#75af00">NewTSimpleServer4</span><span style="color:#111">(</span><span style="color:#75af00">processor</span><span style="color:#111">,</span> <span style="color:#75af00">serverTransport</span><span style="color:#111">,</span> <span style="color:#75af00">transportFactory</span><span style="color:#111">,</span> <span style="color:#75af00">protocolFactory</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Running at:&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">HOST</span><span style="color:#f92672">+</span><span style="color:#d88200">&#34;:&#34;</span><span style="color:#f92672">+</span><span style="color:#75af00">PORT</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">server</span><span style="color:#111">.</span><span style="color:#75af00">Serve</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Fatalln</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Error:&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="python服务端">python服务端</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> <span style="color:#111">thrift.protocol</span> <span style="color:#f92672">import</span> <span style="color:#111">TBinaryProtocol</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> <span style="color:#111">thrift.server</span> <span style="color:#f92672">import</span> <span style="color:#111">TServer</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> <span style="color:#111">thrift.transport</span> <span style="color:#f92672">import</span> <span style="color:#111">TSocket</span><span style="color:#111">,</span> <span style="color:#111">TTransport</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> <span style="color:#111">example</span> <span style="color:#f92672">import</span> <span style="color:#111">format_data</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">__HOST</span> <span style="color:#f92672">=</span> <span style="color:#d88200">&#39;127.0.0.1&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">__PORT</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">8080</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">class</span> <span style="color:#75af00">FormatDataImpl</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">def</span> <span style="color:#75af00">do_format</span><span style="color:#111">(</span><span style="color:#111">self</span><span style="color:#111">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#d88200">&#34;你好&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#111">__name__</span> <span style="color:#f92672">==</span> <span style="color:#d88200">&#39;__main__&#39;</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">handler</span> <span style="color:#f92672">=</span> <span style="color:#111">FormatDataImpl</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">processor</span> <span style="color:#f92672">=</span> <span style="color:#111">format_data</span><span style="color:#f92672">.</span><span style="color:#111">Processor</span><span style="color:#111">(</span><span style="color:#111">handler</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">transport</span> <span style="color:#f92672">=</span> <span style="color:#111">TSocket</span><span style="color:#f92672">.</span><span style="color:#111">TServerSocket</span><span style="color:#111">(</span><span style="color:#d88200">&#39;127.0.0.1&#39;</span><span style="color:#111">,</span> <span style="color:#ae81ff">8080</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">tfactory</span> <span style="color:#f92672">=</span> <span style="color:#111">TTransport</span><span style="color:#f92672">.</span><span style="color:#111">TBufferedTransportFactory</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">pfactory</span> <span style="color:#f92672">=</span> <span style="color:#111">TBinaryProtocol</span><span style="color:#f92672">.</span><span style="color:#111">TBinaryProtocolFactory</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">server</span> <span style="color:#f92672">=</span> <span style="color:#111">TServer</span><span style="color:#f92672">.</span><span style="color:#111">TSimpleServer</span><span style="color:#111">(</span><span style="color:#111">processor</span><span style="color:#111">,</span> <span style="color:#111">transport</span><span style="color:#111">,</span> <span style="color:#111">tfactory</span><span style="color:#111">,</span> <span style="color:#111">pfactory</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">print</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Starting python server...&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">server</span><span style="color:#f92672">.</span><span style="color:#111">serve</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">print</span><span style="color:#111">(</span><span style="color:#d88200">&#34;done!&#34;</span><span style="color:#111">)</span>
</span></span></code></pre></div><h3 id="golang客户端">golang客户端</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;context&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;net&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;test/example&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;github.com/apache/thrift/lib/go/thrift&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">const</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">HOST</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;127.0.0.1&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">PORT</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;8080&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">tSocket</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">thrift</span><span style="color:#111">.</span><span style="color:#75af00">NewTSocket</span><span style="color:#111">(</span><span style="color:#75af00">net</span><span style="color:#111">.</span><span style="color:#75af00">JoinHostPort</span><span style="color:#111">(</span><span style="color:#75af00">HOST</span><span style="color:#111">,</span> <span style="color:#75af00">PORT</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Fatalln</span><span style="color:#111">(</span><span style="color:#d88200">&#34;tSocket error:&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">transport</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">thrift</span><span style="color:#111">.</span><span style="color:#75af00">NewTBufferedTransport</span><span style="color:#111">(</span><span style="color:#75af00">tSocket</span><span style="color:#111">,</span><span style="color:#ae81ff">10000000</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// transport, err := transportFactory.Gwt(tSocket)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// if err != nil {</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 	log.Fatalln(&#34;GetTransport error:&#34;, err)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// }</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">protocolFactory</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">thrift</span><span style="color:#111">.</span><span style="color:#75af00">NewTBinaryProtocolFactoryDefault</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">client</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">example</span><span style="color:#111">.</span><span style="color:#75af00">NewFormatDataClientFactory</span><span style="color:#111">(</span><span style="color:#75af00">transport</span><span style="color:#111">,</span> <span style="color:#75af00">protocolFactory</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">transport</span><span style="color:#111">.</span><span style="color:#75af00">Open</span><span style="color:#111">();</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Fatalln</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Error opening:&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">HOST</span><span style="color:#f92672">+</span><span style="color:#d88200">&#34;:&#34;</span><span style="color:#f92672">+</span><span style="color:#75af00">PORT</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">transport</span><span style="color:#111">.</span><span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// data := example.Data{Text: &#34;hello,world!as赵海宇&#34;}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">d</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">client</span><span style="color:#111">.</span><span style="color:#75af00">DoFormat</span><span style="color:#111">(</span><span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">TODO</span><span style="color:#111">()</span> <span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">d</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>5.python客户端</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> <span style="color:#111">example</span> <span style="color:#f92672">import</span> <span style="color:#111">format_data</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> <span style="color:#111">thrift</span> <span style="color:#f92672">import</span> <span style="color:#111">Thrift</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> <span style="color:#111">thrift.transport</span> <span style="color:#f92672">import</span> <span style="color:#111">TSocket</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> <span style="color:#111">thrift.transport</span> <span style="color:#f92672">import</span> <span style="color:#111">TTransport</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> <span style="color:#111">thrift.protocol</span> <span style="color:#f92672">import</span> <span style="color:#111">TBinaryProtocol</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">try</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Make socket</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">transport</span> <span style="color:#f92672">=</span> <span style="color:#111">TSocket</span><span style="color:#f92672">.</span><span style="color:#111">TSocket</span><span style="color:#111">(</span><span style="color:#d88200">&#39;127.0.0.1&#39;</span><span style="color:#111">,</span> <span style="color:#ae81ff">8080</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Buffering is critical. Raw sockets are very slow</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">transport</span> <span style="color:#f92672">=</span> <span style="color:#111">TTransport</span><span style="color:#f92672">.</span><span style="color:#111">TBufferedTransport</span><span style="color:#111">(</span><span style="color:#111">transport</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Wrap in a protocol</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">protocol</span> <span style="color:#f92672">=</span> <span style="color:#111">TBinaryProtocol</span><span style="color:#f92672">.</span><span style="color:#111">TBinaryProtocol</span><span style="color:#111">(</span><span style="color:#111">transport</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Create a client to use the protocol encoder</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">client</span> <span style="color:#f92672">=</span> <span style="color:#111">format_data</span><span style="color:#f92672">.</span><span style="color:#111">Client</span><span style="color:#111">(</span><span style="color:#111">protocol</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Connect!</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">transport</span><span style="color:#f92672">.</span><span style="color:#111">open</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># data = format_data.Data(text=&#34;sada&#34;)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">d</span> <span style="color:#f92672">=</span> <span style="color:#111">client</span><span style="color:#f92672">.</span><span style="color:#111">do_format</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">print</span><span style="color:#111">(</span><span style="color:#111">d</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">transport</span><span style="color:#f92672">.</span><span style="color:#111">close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">except</span> <span style="color:#111">Thrift</span><span style="color:#f92672">.</span><span style="color:#111">TException</span> <span style="color:#00a8c8">as</span> <span style="color:#111">tx</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">print</span><span style="color:#111">(</span><span style="color:#111">tx</span><span style="color:#f92672">.</span><span style="color:#111">message</span><span style="color:#111">)</span>
</span></span></code></pre></div><h2 id="常见的坑">常见的坑</h2>
<ol>
<li>golang中倒入包路径有<code>github.com/apache/thrift/lib/go/thrift</code>和<code>git.apache.org/thrift.git/lib/go/thrift</code> 要统一用一个,不然会出问题</li>
<li>golang中 thrift的新版实现的结构体多一个<code>ctx context.Context</code>参数.(老版本没有,网上很多的demo代码用新版的thrift会报错)</li>
<li>客户端以及服务端对应好传输及服务模型协议,不同会报错.</li>
</ol>
<p>参考文章:</p>
<ul>
<li><a href="https://www.cnblogs.com/hapjin/p/8075721.html">https://www.cnblogs.com/hapjin/p/8075721.html</a></li>
<li><a href="https://blog.csdn.net/houjixin/article/details/42778335">https://blog.csdn.net/houjixin/article/details/42778335</a></li>
<li><a href="https://www.jianshu.com/p/4723ce380b0e">https://www.jianshu.com/p/4723ce380b0e</a></li>
</ul>
]]></content:encoded><category>microservice</category><category>thrift</category><category>go</category></item><item><title>grpc服务发现与负载均衡</title><link>https://daemon365.dev/post/microservice/grpc_service_discovery_and_load_balancing/</link><pubDate>Sun, 20 Dec 2020 00:00:00 +0800</pubDate><guid>https://daemon365.dev/post/microservice/grpc_service_discovery_and_load_balancing/</guid><description>&lt;h2 id="前言"&gt;前言&lt;/h2&gt;
&lt;p&gt;   在后台服务开发中，高可用性是构建中核心且重要的一环。服务发现（Service discovery）和负载均衡（Load Balance）一直都是我关注的话题。今天来谈一下我在实际中是如何理解及落地的。&lt;/p&gt;
&lt;h2 id="负载均衡--服务发现"&gt;负载均衡 &amp;amp;&amp;amp; 服务发现&lt;/h2&gt;
&lt;h4 id="基础"&gt;基础&lt;/h4&gt;
&lt;p&gt;   负载均衡 ，顾名思义，是通过某种手段将流量 / 请求分配到不通的服务器上去，保证后台的每个服务收到的请求都尽可能保持平衡
   服务发现 ，就是指客户端按照某种约定的方式主动去（注册中心）寻找服务，然后再连接相应的服务
   关于负载均衡的构建与实现，可以看下这几篇文章：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="https://segmentfault.com/a/1190000008672912"&gt;gRPC 服务发现 &amp;amp; 负载均衡&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://grpc.io/blog/loadbalancing/"&gt;gRPC Load Balancing&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/grpc/grpc/blob/master/doc/load-balancing.md"&gt;Load Balancing in gRPC&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id="服务发现概念"&gt;服务发现概念&lt;/h4&gt;
&lt;p&gt;   我们说的服务发现，一般理解为客户端如何发现 (并连接到) 服务，这里一般包含三个组件：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;服务消费者：一般指客户端（可以是简单的 TCP-Client 或者是 RPC-Client ）&lt;/li&gt;
&lt;li&gt;服务提供者：一般指服务提供方，如传统服务，微服务等&lt;/li&gt;
&lt;li&gt;服务注册中心：用来存储（Key-Value）服务提供者的服务，一般以 DNS/HTTP/RPC 等方式对外暴露接口&lt;/li&gt;
&lt;/ol&gt;
&lt;h4 id="负载均衡概念"&gt;负载均衡概念&lt;/h4&gt;
&lt;p&gt;我们把 LB 看作一个组件，根据组件位置的不同，大致上分为三种：&lt;/p&gt;
&lt;h4 id="集中式-lbproxy-model"&gt;集中式 LB（Proxy Model）&lt;/h4&gt;
&lt;p&gt;   独立的 LB, 可以是硬件实现，如 F5，或者是 nginx 这种内置 Proxy-pass 或者 upstream 功能的网关，亦或是 LVS/HAPROXY，之前也使用 &lt;a href="http://core.dpdk.org/doc/quick-start/"&gt;DPDK&lt;/a&gt; 开发过类似的专用网关。&lt;/p&gt;
&lt;p&gt;&lt;img src="https://daemon365.dev/images/600380fe-75ab-44af-9615-c41dd981f499.png" alt=""&gt;&lt;/p&gt;
&lt;h4 id="进程内-lbbalancing-aware-client"&gt;进程内 LB（Balancing-aware Client）&lt;/h4&gt;
&lt;p&gt;   进程内 LB（集成到客户端），此方案将 LB 的功能集成到服务消费方进程里，也被称为软负载或者客户端负载方案。服务提供方启动时，首先将服务地址注册到服务注册表，同时定期报心跳到服务注册表以表明服务的存活状态，相当于健康检查，服务消费方要访问某个服务时，它通过内置的 LB 组件向服务注册表查询，同时缓存并定期刷新目标服务地址列表，然后以某种负载均衡策略选择一个目标服务地址，最后向目标服务发起请求。LB 和服务发现能力被分散到每一个服务消费者的进程内部，同时服务消费方和服务提供方之间是直接调用，没有额外开销，性能比较好。&lt;/p&gt;
&lt;p&gt;&lt;img src="https://daemon365.dev/images/484f3293-3b5e-4606-ade5-7b69ac18f7fb.png" alt=""&gt;&lt;/p&gt;</description><content:encoded><![CDATA[<h2 id="前言">前言</h2>
<p>   在后台服务开发中，高可用性是构建中核心且重要的一环。服务发现（Service discovery）和负载均衡（Load Balance）一直都是我关注的话题。今天来谈一下我在实际中是如何理解及落地的。</p>
<h2 id="负载均衡--服务发现">负载均衡 &amp;&amp; 服务发现</h2>
<h4 id="基础">基础</h4>
<p>   负载均衡 ，顾名思义，是通过某种手段将流量 / 请求分配到不通的服务器上去，保证后台的每个服务收到的请求都尽可能保持平衡
   服务发现 ，就是指客户端按照某种约定的方式主动去（注册中心）寻找服务，然后再连接相应的服务
   关于负载均衡的构建与实现，可以看下这几篇文章：</p>
<ul>
<li><a href="https://segmentfault.com/a/1190000008672912">gRPC 服务发现 &amp; 负载均衡</a></li>
<li><a href="https://grpc.io/blog/loadbalancing/">gRPC Load Balancing</a></li>
<li><a href="https://github.com/grpc/grpc/blob/master/doc/load-balancing.md">Load Balancing in gRPC</a></li>
</ul>
<h4 id="服务发现概念">服务发现概念</h4>
<p>   我们说的服务发现，一般理解为客户端如何发现 (并连接到) 服务，这里一般包含三个组件：</p>
<ol>
<li>服务消费者：一般指客户端（可以是简单的 TCP-Client 或者是 RPC-Client ）</li>
<li>服务提供者：一般指服务提供方，如传统服务，微服务等</li>
<li>服务注册中心：用来存储（Key-Value）服务提供者的服务，一般以 DNS/HTTP/RPC 等方式对外暴露接口</li>
</ol>
<h4 id="负载均衡概念">负载均衡概念</h4>
<p>我们把 LB 看作一个组件，根据组件位置的不同，大致上分为三种：</p>
<h4 id="集中式-lbproxy-model">集中式 LB（Proxy Model）</h4>
<p>   独立的 LB, 可以是硬件实现，如 F5，或者是 nginx 这种内置 Proxy-pass 或者 upstream 功能的网关，亦或是 LVS/HAPROXY，之前也使用 <a href="http://core.dpdk.org/doc/quick-start/">DPDK</a> 开发过类似的专用网关。</p>
<p><img src="/images/600380fe-75ab-44af-9615-c41dd981f499.png" alt=""></p>
<h4 id="进程内-lbbalancing-aware-client">进程内 LB（Balancing-aware Client）</h4>
<p>   进程内 LB（集成到客户端），此方案将 LB 的功能集成到服务消费方进程里，也被称为软负载或者客户端负载方案。服务提供方启动时，首先将服务地址注册到服务注册表，同时定期报心跳到服务注册表以表明服务的存活状态，相当于健康检查，服务消费方要访问某个服务时，它通过内置的 LB 组件向服务注册表查询，同时缓存并定期刷新目标服务地址列表，然后以某种负载均衡策略选择一个目标服务地址，最后向目标服务发起请求。LB 和服务发现能力被分散到每一个服务消费者的进程内部，同时服务消费方和服务提供方之间是直接调用，没有额外开销，性能比较好。</p>
<p><img src="/images/484f3293-3b5e-4606-ade5-7b69ac18f7fb.png" alt=""></p>
<h4 id="独立-lb-进程external-load-balancing-service">独立 LB 进程（External Load Balancing Service）</h4>
<p>   该方案是针对上一种方案的不足而提出的一种折中方案，原理和第二种方案基本类似。不同之处是将 LB 和服务发现功能从进程内移出来，变成主机上的一个独立进程。主机上的一个或者多个服务要访问目标服务时，他们都通过同一主机上的独立 LB 进程做服务发现和负载均衡。该方案也是一种分布式方案没有单点问题，一个 LB 进程挂了只影响该主机上的服务调用方，服务调用方和 LB 之间是进程内调用性能好，同时该方案还简化了服务调用方，不需要为不同语言开发客户库，LB 的升级不需要服务调用方改代码。 公司的 L5 是这种方式，每台机器上都安装了 L5 的 agent，供其他服务调用。该方案主要问题：部署较复杂，环节多，出错调试排查问题不方便。</p>
<p><img src="/images/be553bb2-7a9a-4539-93db-02cd4a2d1ee2.png" alt=""></p>
<h3 id="grpc-内置的方案">gRPC 内置的方案</h3>
<p>  gRPC 的内置方案如下图所示：</p>
<p><img src="/images/4bc0b344-b882-415c-9972-75ad14e35d51.png" alt=""></p>
<p>gRPC 在官网文档中提供了实现 LB 的思路，并在不同语言的 gRPC 代码 API 中已提供了命名解析和负载均衡接口供扩展。默认提供了 DNS-resolver 的实现，接口相当规范，实现起来也不复杂，只需要实现服务注册（Registry）和服务监听 + 解析（Watcher+Resolver）的逻辑就行了，这里简单介绍其基本实现过程：</p>
<ol>
<li>构建注册中心，这里注册中心一般要求具备分布式一致性（满足 CAP 定理的 AP 或 CP）的高可用的组件集群，如 Zookeeper、Consul、Etcd 等</li>
<li>构建 gRPC 服务端的注册逻辑，服务启动后定时向注册中心注册自身的关键信息（一般开启新的 groutine 来完成），至少包含 IP 和端口，其他可选信息，如自身的负载信息（CPU 和 Memory）、当前实时连接数等，这些辅助信息有助于帮助系统更好的执行 LB 算法</li>
<li>gRPC 客户端向注册中心发出服务解析请求，注册中心将请求中关联的所有服务的信息返回给 gRPC 客户端，客户端与所有在线的服务建立起 HTTP2 长连接</li>
<li>gRPC 客户端发起 RPC 调用，根据 LB 均衡器中实现的负载均衡策略（gRPC 中默认提供的算法是 RoundRobin），选择其中一 HTTP2 长连接进行通信，即 LB 策略决定哪个子通道 - 即哪个 gRPC 服务器将接收请求</li>
</ol>
<h2 id="grpc-负载均衡的运行机制">gRPC 负载均衡的运行机制</h2>
<p>gRPC 提供了负载均衡实现的用户侧接口，我们可以非常方便的定制化业务的负载均衡策略，为了理解 gRPC 的负载均衡的实现机制，后续博客中我会分析下 <code>gRPC</code> 实现负载均衡的代码。</p>
<p><img src="/images/c0b8b2f7-eee6-4a7b-8785-331d276a19fd.png" alt=""></p>
<ol>
<li>Resolver
<ul>
<li>解析器，用于从注册中心实时获取当前服务端的列表，同步发送给 Balancer</li>
</ul>
</li>
<li>Balancer
<ul>
<li>平衡器，一是接收从 Resolver 发送的服务端列表，建立并维护（长）连接状态；二是每次当 Client 发起 Rpc 调用时，按照一定算法从连接池中选择一个连接进行 Rpc 调用</li>
</ul>
</li>
<li>Register
<ul>
<li>注册，用于服务端初始化和在线时，将自己信息上报到注册中心，主要信息有 Ip，端口等</li>
</ul>
</li>
</ol>
<h2 id="负载均衡的算法及实现">负载均衡的算法及实现</h2>
<p>在实践中，如何选取负载均衡策略是一个很有趣的话题，例如 Nginx 的 <code>upstream</code> 机制中就有很多经典的 LB 策略，如带权重的轮询 <a href="https://github.com/nginx/nginx/blob/master/src/http/ngx_http_upstream_round_robin.c">Weight-RoundRobin</a>，一般常用的负载均衡方法有如下几种：</p>
<ol>
<li>RoundRobin（轮询）</li>
<li>Weight-RoundRobin（加权轮询）
<ul>
<li>不同的后端服务器可能机器的配置和当前系统的负载并不相同，因此它们的抗压能力也不相同。给配置高、负载低的机器配置更高的权重，而配置低、负载高的机器，给其分配较低的权重，降低其系统负载，加权轮询能很好地处理这一问题，并将请求顺序且按照权重分配到后端。</li>
</ul>
</li>
<li>Random（随机）</li>
<li>Weight-Random（加权随机）
<ul>
<li>通过系统的随机算法，根据后端服务器的列表随机选取其中的一台服务器进行访问</li>
</ul>
</li>
<li>源地址哈希法
<ul>
<li>源地址哈希的思想是根据获取客户端的 IP 地址，通过哈希函数计算得到的一个数值，用该数值对服务器列表的大小进行取模运算，得到的结果便是客服端要访问服务器的序号。采用源地址哈希法进行负载均衡，同一 IP 地址的客户端，当后端服务器列表不变时，它每次都会映射到同一台后端服务器进行访问</li>
</ul>
</li>
<li>最小连接数法
<ul>
<li>最小连接数算法比较灵活和智能，由于后端服务器的配置不尽相同，对于请求的处理有快有慢，它是根据后端服务器当前的连接情况，动态地选取其中当前积压连接数最少的一台服务器来处理当前的请求，尽可能地提高后端服务的利用效率，将负责合理地分流到每一台服务器</li>
</ul>
</li>
<li>一致性哈希算法
<ul>
<li>常见的是 <code>Ketama</code> 算法，该算法是用来解决 <code>cache</code> 失效导致的缓存穿透的问题的，当然也可以适用于 gRPC 长连接的场景</li>
</ul>
</li>
</ol>
<h2 id="grpc-服务治理的优势">gRPC 服务治理的优势</h2>
<p>   在现网环境中，后端服务就是采用了 gRPC 与 Etcd 的服务治理方案，总结下有这么几个优点；</p>
<ul>
<li>采用了 gRPC 实现负载均衡策略，模块之间通信采用长连接方式，避免每次 RPC 调用时新建连接的开销，充分发挥 <code>HTTP2</code> 的优势</li>
<li>扩容和缩容都及其方便，例如扩容，只要部署上服务，运行后，服务成功注册到 Etcd 便大功告成</li>
<li>灵活的自定义的 LB 算法，使得后端压力更为均衡</li>
<li>客户端加入重试逻辑，使得网络抖动情况下，可以通过重试连接上另外一台服务</li>
</ul>
<h2 id="resolver-暴露的三个接口">Resolver 暴露的三个接口</h2>
<p>前文说过，gRPC 内置的服务治理功能，对开发者暴露了服务发现的 <code>interface{}</code>，<code>resolver.Builder</code> 和 <code>resolver.ClientConn</code> 和 <code>resolver.Resolver</code>，<a href="https://github.com/grpc/grpc-go/blob/master/resolver/resolver.go">相关代码</a>。开发者在实例化这三个接口之后，就可以实现从指定的 scheme 中获取服务列表，通知 balancer 并与这些服务端建立 RPC 长连接。</p>
<ol>
<li>resolver.Builder</li>
<li>resolver.ClientConn</li>
<li>resolver.Resolver</li>
</ol>
<ul>
<li>resolver.Builder <code>Builder</code> 用于 gRPC 内部创建 <code>Resolver</code> 接口的实现，但注意内部声明的 <code>Build()</code> 方法将接口 <code>ClientConn</code> 作为参数传入了，在前文的分析中，我们了解到 <code>ClientConn</code><a href="https://github.com/grpc/grpc-go/blob/master/clientconn.go#L459">结库</a> 是非常重要的结构，其成员 <code>conns map[*addrConn]struct{}</code> 中维护了所有从注册中心获取到的服务端列表。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// Builder creates a resolver that will be used to watch name resolution updates.</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Builder</span> <span style="color:#00a8c8">interface</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Build creates a new resolver for the given target.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// gRPC dial calls Build synchronously, and fails if the returned error is</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// not nil.</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">Build</span><span style="color:#111">(</span><span style="color:#75af00">target</span> <span style="color:#75af00">Target</span><span style="color:#111">,</span> <span style="color:#75af00">cc</span> <span style="color:#75af00">ClientConn</span><span style="color:#111">,</span> <span style="color:#75af00">opts</span> <span style="color:#75af00">BuildOption</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#75af00">Resolver</span><span style="color:#111">,</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Scheme returns the scheme supported by this resolver.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Scheme is defined at https://github.com/grpc/grpc/blob/master/doc/naming.md.</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">Scheme</span><span style="color:#111">()</span> <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><ul>
<li><a href="https://github.com/grpc/grpc-go/blob/master/clientconn.go#L459">resolver.ClientConn</a> <code>ClientConn</code> 接口中，<code>UpdateState</code> 方法需要传入 <code>State</code> 结构，<code>NewAddress</code> 方法需要传入 <code>Address</code> 结构，看代码可以发现其中包含了 <code>Addresses []Address // Resolved addresses for the target</code>，可以看出是需要将服务发现得到的 <code>Address</code> 对象列表告诉 <code>ClientConn</code> 的对象。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// ClientConn contains the callbacks for resolver to notify any updates</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// to the gRPC ClientConn.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// This interface is to be implemented by gRPC. Users should not need a</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// brand new implementation of this interface. For the situations like</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// testing, the new implementation should embed this interface. This allows</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// gRPC to add new methods to this interface.</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">ClientConn</span> <span style="color:#00a8c8">interface</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// UpdateState updates the state of the ClientConn appropriately.</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">UpdateState</span><span style="color:#111">(</span><span style="color:#75af00">State</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// NewAddress is called by resolver to notify ClientConn a new list</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// of resolved addresses.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// The address list should be the complete list of resolved addresses.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// Deprecated: Use UpdateState instead.</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">NewAddress</span><span style="color:#111">(</span><span style="color:#75af00">addresses</span> <span style="color:#111">[]</span><span style="color:#75af00">Address</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// NewServiceConfig is called by resolver to notify ClientConn a new</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// service config. The service config should be provided as a json string.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// Deprecated: Use UpdateState instead.</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">NewServiceConfig</span><span style="color:#111">(</span><span style="color:#75af00">serviceConfig</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><ul>
<li>resolver.Resolver <code>Resolver</code> 提供了 <code>ResolveNow</code> 用于被 gRPC 尝试重新进行服务发现</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// Resolver watches for the updates on the specified target.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Updates include address updates and service config updates.</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Resolver</span> <span style="color:#00a8c8">interface</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// ResolveNow will be called by gRPC to try to resolve the target name</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// again. It&#39;s just a hint, resolver can ignore this if it&#39;s not necessary.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// It could be called multiple times concurrently.</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">ResolveNow</span><span style="color:#111">(</span><span style="color:#75af00">ResolveNowOption</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Close closes the resolver.</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="梳理-resolver-过程">梳理 Resolver 过程</h2>
<p>通过这三个接口，再次梳理下 gRPC 的服务发现实现逻辑</p>
<ol>
<li>通过 <code>Builder.Build()</code> 进行 <code>Reslover</code> 的创建，在 <code>Build()</code> 的过程中将服务发现的地址信息丢给 <code>ClientConn</code> 用于内部连接创建（通过 <code>ClientConn.UpdateState()</code> 实现）等逻辑；</li>
<li>当 <code>client</code> 在 <code>Dial</code> 时会根据 <code>target</code> 解析的 <code>scheme</code> 获取对应的 <code>Builder</code>，<a href="https://github.com/grpc/grpc-go/blob/master/clientconn.go#L242">代码位置</a></li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">DialContext</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">,</span> <span style="color:#75af00">target</span> <span style="color:#00a8c8">string</span><span style="color:#111">,</span> <span style="color:#75af00">opts</span> <span style="color:#f92672">...</span><span style="color:#75af00">DialOption</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#75af00">conn</span> <span style="color:#f92672">*</span><span style="color:#75af00">ClientConn</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Determine the resolver to use.</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">cc</span><span style="color:#111">.</span><span style="color:#75af00">parsedTarget</span> <span style="color:#111">=</span> <span style="color:#75af00">parseTarget</span><span style="color:#111">(</span><span style="color:#75af00">cc</span><span style="color:#111">.</span><span style="color:#75af00">target</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">grpclog</span><span style="color:#111">.</span><span style="color:#75af00">Infof</span><span style="color:#111">(</span><span style="color:#d88200">&#34;parsed scheme: %q&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">cc</span><span style="color:#111">.</span><span style="color:#75af00">parsedTarget</span><span style="color:#111">.</span><span style="color:#75af00">Scheme</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">resolverBuilder</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">cc</span><span style="color:#111">.</span><span style="color:#75af00">getResolver</span><span style="color:#111">(</span><span style="color:#75af00">cc</span><span style="color:#111">.</span><span style="color:#75af00">parsedTarget</span><span style="color:#111">.</span><span style="color:#75af00">Scheme</span><span style="color:#111">)</span>		<span style="color:#75715e">// 通过 scheme(名字) 获取对应的 resolver</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#75af00">resolverBuilder</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// If resolver builder is still nil, the parsed target&#39;s scheme is</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// not registered. Fallback to default resolver and set Endpoint to</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// the original target.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">grpclog</span><span style="color:#111">.</span><span style="color:#75af00">Infof</span><span style="color:#111">(</span><span style="color:#d88200">&#34;scheme %q not registered, fallback to default scheme&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">cc</span><span style="color:#111">.</span><span style="color:#75af00">parsedTarget</span><span style="color:#111">.</span><span style="color:#75af00">Scheme</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">cc</span><span style="color:#111">.</span><span style="color:#75af00">parsedTarget</span> <span style="color:#111">=</span> <span style="color:#75af00">resolver</span><span style="color:#111">.</span><span style="color:#75af00">Target</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">Scheme</span><span style="color:#111">:</span>   <span style="color:#75af00">resolver</span><span style="color:#111">.</span><span style="color:#75af00">GetDefaultScheme</span><span style="color:#111">(),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">Endpoint</span><span style="color:#111">:</span> <span style="color:#75af00">target</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">resolverBuilder</span> <span style="color:#111">=</span> <span style="color:#75af00">cc</span><span style="color:#111">.</span><span style="color:#75af00">getResolver</span><span style="color:#111">(</span><span style="color:#75af00">cc</span><span style="color:#111">.</span><span style="color:#75af00">parsedTarget</span><span style="color:#111">.</span><span style="color:#75af00">Scheme</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">resolverBuilder</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;could not get resolver for default scheme: %q&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">cc</span><span style="color:#111">.</span><span style="color:#75af00">parsedTarget</span><span style="color:#111">.</span><span style="color:#75af00">Scheme</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Build the resolver.</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">rWrapper</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">newCCResolverWrapper</span><span style="color:#111">(</span><span style="color:#75af00">cc</span><span style="color:#111">,</span> <span style="color:#75af00">resolverBuilder</span><span style="color:#111">)</span>		<span style="color:#75715e">// 通过 gRPC 提供的 Wrapper，应用我们实现的 resolver 逻辑</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;failed to build resolver: %v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">cc</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">Lock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">cc</span><span style="color:#111">.</span><span style="color:#75af00">resolverWrapper</span> <span style="color:#111">=</span> <span style="color:#75af00">rWrapper</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">cc</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">Unlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><ol start="3">
<li>当 <code>Dial</code> 成功会创建出结构体 <code>ClientConn</code> 的对象 <a href="https://github.com/grpc/grpc-go/blob/master/clientconn.go#L447">官方代码位置</a>(注意不是上面的 <code>ClientConn</code> 接口)，可以看到结构体 <code>ClientConn</code> 内的成员 <code>resolverWrapper</code> 又实现了接口 <code>ClientConn</code> 的方法 <a href="https://github.com/grpc/grpc-go/blob/master/resolver_conn_wrapper.go">官方代码位置</a></li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">DialContext</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">,</span> <span style="color:#75af00">target</span> <span style="color:#00a8c8">string</span><span style="color:#111">,</span> <span style="color:#75af00">opts</span> <span style="color:#f92672">...</span><span style="color:#75af00">DialOption</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#75af00">conn</span> <span style="color:#f92672">*</span><span style="color:#75af00">ClientConn</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 初始化 CC</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">cc</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">ClientConn</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">target</span><span style="color:#111">:</span>            <span style="color:#75af00">target</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">csMgr</span><span style="color:#111">:</span>             <span style="color:#f92672">&amp;</span><span style="color:#75af00">connectivityStateManager</span><span style="color:#111">{},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">conns</span><span style="color:#111">:</span>             <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#f92672">*</span><span style="color:#75af00">addrConn</span><span style="color:#111">]</span><span style="color:#00a8c8">struct</span><span style="color:#111">{}),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">dopts</span><span style="color:#111">:</span>             <span style="color:#75af00">defaultDialOptions</span><span style="color:#111">(),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">blockingpicker</span><span style="color:#111">:</span>    <span style="color:#75af00">newPickerWrapper</span><span style="color:#111">(),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">czData</span><span style="color:#111">:</span>            <span style="color:#111">new</span><span style="color:#111">(</span><span style="color:#75af00">channelzData</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">firstResolveEvent</span><span style="color:#111">:</span> <span style="color:#75af00">grpcsync</span><span style="color:#111">.</span><span style="color:#75af00">NewEvent</span><span style="color:#111">(),</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">return</span> <span style="color:#75af00">cc</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><ol start="4">
<li>当 <code>resolverWrapper</code> 被初始化时就会调用 <code>Build</code> 方法 <a href="https://github.com/grpc/grpc-go/blob/master/resolver_conn_wrapper.go#L89">官方代码位置</a>，其中参数为接口 <code>ClientConn</code> 传入的是 <code>ccResolverWrapper</code></li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// newCCResolverWrapper uses the resolver.Builder to build a Resolver and</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// returns a ccResolverWrapper object which wraps the newly built resolver.</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">newCCResolverWrapper</span><span style="color:#111">(</span><span style="color:#75af00">cc</span> <span style="color:#f92672">*</span><span style="color:#75af00">ClientConn</span><span style="color:#111">,</span> <span style="color:#75af00">rb</span> <span style="color:#75af00">resolver</span><span style="color:#111">.</span><span style="color:#75af00">Builder</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">ccResolverWrapper</span><span style="color:#111">,</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">ccr</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">ccResolverWrapper</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">cc</span><span style="color:#111">:</span>   <span style="color:#75af00">cc</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">done</span><span style="color:#111">:</span> <span style="color:#75af00">grpcsync</span><span style="color:#111">.</span><span style="color:#75af00">NewEvent</span><span style="color:#111">(),</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">var</span> <span style="color:#75af00">credsClone</span> <span style="color:#75af00">credentials</span><span style="color:#111">.</span><span style="color:#75af00">TransportCredentials</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#75af00">creds</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">cc</span><span style="color:#111">.</span><span style="color:#75af00">dopts</span><span style="color:#111">.</span><span style="color:#75af00">copts</span><span style="color:#111">.</span><span style="color:#75af00">TransportCredentials</span><span style="color:#111">;</span> <span style="color:#75af00">creds</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">credsClone</span> <span style="color:#111">=</span> <span style="color:#75af00">creds</span><span style="color:#111">.</span><span style="color:#75af00">Clone</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">rbo</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">resolver</span><span style="color:#111">.</span><span style="color:#75af00">BuildOptions</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">DisableServiceConfig</span><span style="color:#111">:</span> <span style="color:#75af00">cc</span><span style="color:#111">.</span><span style="color:#75af00">dopts</span><span style="color:#111">.</span><span style="color:#75af00">disableServiceConfig</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">DialCreds</span><span style="color:#111">:</span>            <span style="color:#75af00">credsClone</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">CredsBundle</span><span style="color:#111">:</span>          <span style="color:#75af00">cc</span><span style="color:#111">.</span><span style="color:#75af00">dopts</span><span style="color:#111">.</span><span style="color:#75af00">copts</span><span style="color:#111">.</span><span style="color:#75af00">CredsBundle</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">Dialer</span><span style="color:#111">:</span>               <span style="color:#75af00">cc</span><span style="color:#111">.</span><span style="color:#75af00">dopts</span><span style="color:#111">.</span><span style="color:#75af00">copts</span><span style="color:#111">.</span><span style="color:#75af00">Dialer</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">var</span> <span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// We need to hold the lock here while we assign to the ccr.resolver field</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// to guard against a data race caused by the following code path,</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// rb.Build--&gt;ccr.ReportError--&gt;ccr.poll--&gt;ccr.resolveNow, would end up</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// accessing ccr.resolver which is being assigned here.</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">ccr</span><span style="color:#111">.</span><span style="color:#75af00">resolverMu</span><span style="color:#111">.</span><span style="color:#75af00">Lock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">defer</span> <span style="color:#75af00">ccr</span><span style="color:#111">.</span><span style="color:#75af00">resolverMu</span><span style="color:#111">.</span><span style="color:#75af00">Unlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">ccr</span><span style="color:#111">.</span><span style="color:#75af00">resolver</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">rb</span><span style="color:#111">.</span><span style="color:#75af00">Build</span><span style="color:#111">(</span><span style="color:#75af00">cc</span><span style="color:#111">.</span><span style="color:#75af00">parsedTarget</span><span style="color:#111">,</span> <span style="color:#75af00">ccr</span><span style="color:#111">,</span> <span style="color:#75af00">rbo</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">return</span> <span style="color:#75af00">ccr</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><ol start="5">
<li>当用户基于 <code>Builder</code> 的实现进行 <code>UpdateState</code> 调用时，则会触发结构体 <code>ClientConn</code> 的 <code>updateResolverState</code> 方法 <a href="https://github.com/grpc/grpc-go/blob/master/resolver_conn_wrapper.go#L109">官方代码位置</a>，<code>updateResolverState</code> 则会对传入的 <code>Address</code> 进行初始化等逻辑 <a href="https://github.com/grpc/grpc-go/blob/master/clientconn.go#L553">官方代码位置</a></li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">cc</span> <span style="color:#f92672">*</span><span style="color:#75af00">ClientConn</span><span style="color:#111">)</span> <span style="color:#75af00">updateResolverState</span><span style="color:#111">(</span><span style="color:#75af00">s</span> <span style="color:#75af00">resolver</span><span style="color:#111">.</span><span style="color:#75af00">State</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">defer</span> <span style="color:#75af00">cc</span><span style="color:#111">.</span><span style="color:#75af00">firstResolveEvent</span><span style="color:#111">.</span><span style="color:#75af00">Fire</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">cc</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">Lock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Check if the ClientConn is already closed. Some fields (e.g.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// balancerWrapper) are set to nil when closing the ClientConn, and could</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// cause nil pointer panic if we don&#39;t have this check.</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#75af00">cc</span><span style="color:#111">.</span><span style="color:#75af00">conns</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">cc</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">Unlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// May need to apply the initial service config in case the resolver</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// doesn&#39;t support service configs, or doesn&#39;t provide a service config</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// with the new addresses.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">cc</span><span style="color:#111">.</span><span style="color:#75af00">maybeApplyDefaultServiceConfig</span><span style="color:#111">(</span><span style="color:#00a8c8">nil</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">cc</span><span style="color:#111">.</span><span style="color:#75af00">balancerWrapper</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">cc</span><span style="color:#111">.</span><span style="color:#75af00">balancerWrapper</span><span style="color:#111">.</span><span style="color:#75af00">resolverError</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// No addresses are valid with err set; return early.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">cc</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">Unlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#75af00">balancer</span><span style="color:#111">.</span><span style="color:#75af00">ErrBadResolverState</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">var</span> <span style="color:#75af00">ret</span> <span style="color:#00a8c8">error</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#75af00">cc</span><span style="color:#111">.</span><span style="color:#75af00">dopts</span><span style="color:#111">.</span><span style="color:#75af00">disableServiceConfig</span> <span style="color:#f92672">||</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">ServiceConfig</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">cc</span><span style="color:#111">.</span><span style="color:#75af00">maybeApplyDefaultServiceConfig</span><span style="color:#111">(</span><span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">Addresses</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// TODO: do we need to apply a failing LB policy if there is no</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// default, per the error handling design?</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">sc</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">ServiceConfig</span><span style="color:#111">.</span><span style="color:#75af00">Config</span><span style="color:#111">.(</span><span style="color:#f92672">*</span><span style="color:#75af00">ServiceConfig</span><span style="color:#111">);</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">ServiceConfig</span><span style="color:#111">.</span><span style="color:#75af00">Err</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">cc</span><span style="color:#111">.</span><span style="color:#75af00">applyServiceConfigAndBalancer</span><span style="color:#111">(</span><span style="color:#75af00">sc</span><span style="color:#111">,</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">Addresses</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">ret</span> <span style="color:#111">=</span> <span style="color:#75af00">balancer</span><span style="color:#111">.</span><span style="color:#75af00">ErrBadResolverState</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#75af00">cc</span><span style="color:#111">.</span><span style="color:#75af00">balancerWrapper</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">var</span> <span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">if</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">ServiceConfig</span><span style="color:#111">.</span><span style="color:#75af00">Err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">status</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#75af00">codes</span><span style="color:#111">.</span><span style="color:#75af00">Unavailable</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;error parsing service config: %v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">ServiceConfig</span><span style="color:#111">.</span><span style="color:#75af00">Err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">status</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#75af00">codes</span><span style="color:#111">.</span><span style="color:#75af00">Unavailable</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;illegal service config type: %T&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">ServiceConfig</span><span style="color:#111">.</span><span style="color:#75af00">Config</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75af00">cc</span><span style="color:#111">.</span><span style="color:#75af00">blockingpicker</span><span style="color:#111">.</span><span style="color:#75af00">updatePicker</span><span style="color:#111">(</span><span style="color:#75af00">base</span><span style="color:#111">.</span><span style="color:#75af00">NewErrPicker</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75af00">cc</span><span style="color:#111">.</span><span style="color:#75af00">csMgr</span><span style="color:#111">.</span><span style="color:#75af00">updateState</span><span style="color:#111">(</span><span style="color:#75af00">connectivity</span><span style="color:#111">.</span><span style="color:#75af00">TransientFailure</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75af00">cc</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">Unlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">return</span> <span style="color:#75af00">ret</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">var</span> <span style="color:#75af00">balCfg</span> <span style="color:#75af00">serviceconfig</span><span style="color:#111">.</span><span style="color:#75af00">LoadBalancingConfig</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#75af00">cc</span><span style="color:#111">.</span><span style="color:#75af00">dopts</span><span style="color:#111">.</span><span style="color:#75af00">balancerBuilder</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">cc</span><span style="color:#111">.</span><span style="color:#75af00">sc</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">cc</span><span style="color:#111">.</span><span style="color:#75af00">sc</span><span style="color:#111">.</span><span style="color:#75af00">lbConfig</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">balCfg</span> <span style="color:#111">=</span> <span style="color:#75af00">cc</span><span style="color:#111">.</span><span style="color:#75af00">sc</span><span style="color:#111">.</span><span style="color:#75af00">lbConfig</span><span style="color:#111">.</span><span style="color:#75af00">cfg</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">cbn</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">cc</span><span style="color:#111">.</span><span style="color:#75af00">curBalancerName</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">bw</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">cc</span><span style="color:#111">.</span><span style="color:#75af00">balancerWrapper</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">cc</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">Unlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#75af00">cbn</span> <span style="color:#f92672">!=</span> <span style="color:#75af00">grpclbName</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Filter any grpclb addresses since we don&#39;t have the grpclb balancer.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">for</span> <span style="color:#75af00">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span><span style="color:#111">;</span> <span style="color:#75af00">i</span> <span style="color:#111">&lt;</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">Addresses</span><span style="color:#111">);</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">Addresses</span><span style="color:#111">[</span><span style="color:#75af00">i</span><span style="color:#111">].</span><span style="color:#75af00">Type</span> <span style="color:#f92672">==</span> <span style="color:#75af00">resolver</span><span style="color:#111">.</span><span style="color:#75af00">GRPCLB</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">copy</span><span style="color:#111">(</span><span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">Addresses</span><span style="color:#111">[</span><span style="color:#75af00">i</span><span style="color:#111">:],</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">Addresses</span><span style="color:#111">[</span><span style="color:#75af00">i</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span><span style="color:#111">:])</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">Addresses</span> <span style="color:#111">=</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">Addresses</span><span style="color:#111">[:</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">Addresses</span><span style="color:#111">)</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">continue</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">i</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">uccsErr</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">bw</span><span style="color:#111">.</span><span style="color:#75af00">updateClientConnState</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">balancer</span><span style="color:#111">.</span><span style="color:#75af00">ClientConnState</span><span style="color:#111">{</span><span style="color:#75af00">ResolverState</span><span style="color:#111">:</span> <span style="color:#75af00">s</span><span style="color:#111">,</span> <span style="color:#75af00">BalancerConfig</span><span style="color:#111">:</span> <span style="color:#75af00">balCfg</span><span style="color:#111">})</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#75af00">ret</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">ret</span> <span style="color:#111">=</span> <span style="color:#75af00">uccsErr</span> <span style="color:#75715e">// prefer ErrBadResolver state since any other error is</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// currently meaningless to the caller.</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">return</span> <span style="color:#75af00">ret</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><ol start="6">
<li>至此整个服务发现过程就结束了。从中也可以看出 gRPC 官方提供的三个接口还是很灵活的，但也正因为灵活要实现稍微麻烦一些，而 <code>Address</code><a href="https://github.com/grpc/grpc-go/blob/master/resolver/resolver.go#L79">官方代码位置</a> 如果直接被业务拿来用于服务节点信息的描述结构则显得有些过于简单。</li>
</ol>
<p>所以 <code>warden</code> 包装了 gRPC 的整个服务发现实现逻辑，代码分别位于 <code>pkg/naming/naming.go</code> 和 <code>warden/resolver/resolver.go</code>，其中：</p>
<ul>
<li><code>naming.go</code> 内定义了用于描述业务实例的 <code>Instance</code> 结构、用于服务注册的 <code>Registry</code> 接口、用于服务发现的 <code>Resolver</code> 接口</li>
<li><code>resolver.go</code> 内实现了 gRPC 官方的 <code>resolver.Builder</code> 和 <code>resolver.Resolver</code> 接口，但也暴露了 <code>naming.go</code> 内的 <code>naming.Builder</code> 和 <code>naming.Resolver</code> 接口</li>
</ul>
<h2 id="文章转自">文章转自：</h2>
<ul>
<li><a href="https://pandaychen.github.io/2019/07/11/GRPC-SERVICE-DISCOVERY/">基于 gRPC 的服务发现与负载均衡（基础篇） - 熊喵君的博客 | PANDAYCHEN</a></li>
<li><a href="https://pandaychen.github.io/2020/01/03/GRPC-RESOLVER-DEEP-ANALYSIS2-IN-KRATOS/">gRPC 应用篇之 Resolver 接口封装 - 熊喵君的博客 | PANDAYCHEN</a></li>
</ul>
]]></content:encoded><category>microservice</category><category>grpc</category><category>go</category></item><item><title>grpc基础</title><link>https://daemon365.dev/post/microservice/grpc_basics/</link><pubDate>Thu, 10 Dec 2020 00:00:00 +0800</pubDate><guid>https://daemon365.dev/post/microservice/grpc_basics/</guid><description>&lt;h2 id="rpc-框架原理"&gt;RPC 框架原理&lt;/h2&gt;
&lt;p&gt;RPC 框架的目标就是让远程服务调用更加简单、透明，RPC 框架负责屏蔽底层的传输方式（TCP 或者 UDP）、序列化方式（XML/Json/ 二进制）和通信细节。服务调用者可以像调用本地接口一样调用远程的服务提供者，而不需要关心底层通信细节和调用过程。&lt;/p&gt;
&lt;p&gt;&lt;img src="https://daemon365.dev/images/32547781-dc18-4784-b1a3-f6ade97bc87f.png" alt=""&gt;&lt;/p&gt;
&lt;p&gt;业界主流的 RPC 框架整体上分为三类：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;支持多语言的 RPC 框架，比较成熟的有 Google 的 gRPC、facebook的Apache、Thrift；&lt;/li&gt;
&lt;li&gt;只支持特定语言的 RPC 框架，例如新浪微博的 Motan；&lt;/li&gt;
&lt;li&gt;支持服务治理等服务化特性的分布式服务框架，其底层内核仍然是 RPC 框架, 例如阿里的 Dubbo。&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="grpc是什么"&gt;gRPC是什么&lt;/h2&gt;
&lt;p&gt;&lt;a href="http://www.oschina.net/p/grpc-framework"&gt;gRPC&lt;/a&gt; 是一个高性能、开源和通用的 RPC 框架，面向移动和 HTTP/2 设计。目前提供 C、Java 和 Go 语言版本，分别是：grpc, grpc-java, grpc-go. 其中 C 版本支持 C, C++, Node.js, Python, Ruby, Objective-C, PHP 和 C## 支持.&lt;/p&gt;
&lt;p&gt;gRPC 基于 HTTP/2 标准设计，带来诸如双向流、流控、头部压缩、单 TCP 连接上的多复用请求等特。这些特性使得其在移动设备上表现更好，更省电和节省空间占用。&lt;/p&gt;
&lt;h3 id="grc优点"&gt;grc优点&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;多语言：语言中立，支持多种语言。&lt;/li&gt;
&lt;li&gt;轻量级、高性能：序列化支持 PB(Protocol Buffer)和 JSON，PB 是一种语言无关的高性能序列化框架。
可插拔&lt;/li&gt;
&lt;li&gt;IDL：基于文件定义服务，通过 proto3 工具生成指定语言的数据结构、服务端接口以及客户端 Stub。&lt;/li&gt;
&lt;li&gt;移动端：基于标准的 HTTP2 设计，支持双向流、消息头压缩、单 TCP 的多路复用、服务端推送等特性，这些特性使得 gRPC 在移动端设备上更加省电和节省网络流量。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img src="https://daemon365.dev/images/f011b389-3272-4f7f-be74-4eb0f6bb7b94.png" alt=""&gt;&lt;/p&gt;</description><content:encoded><![CDATA[<h2 id="rpc-框架原理">RPC 框架原理</h2>
<p>RPC 框架的目标就是让远程服务调用更加简单、透明，RPC 框架负责屏蔽底层的传输方式（TCP 或者 UDP）、序列化方式（XML/Json/ 二进制）和通信细节。服务调用者可以像调用本地接口一样调用远程的服务提供者，而不需要关心底层通信细节和调用过程。</p>
<p><img src="/images/32547781-dc18-4784-b1a3-f6ade97bc87f.png" alt=""></p>
<p>业界主流的 RPC 框架整体上分为三类：</p>
<ul>
<li>支持多语言的 RPC 框架，比较成熟的有 Google 的 gRPC、facebook的Apache、Thrift；</li>
<li>只支持特定语言的 RPC 框架，例如新浪微博的 Motan；</li>
<li>支持服务治理等服务化特性的分布式服务框架，其底层内核仍然是 RPC 框架, 例如阿里的 Dubbo。</li>
</ul>
<h2 id="grpc是什么">gRPC是什么</h2>
<p><a href="http://www.oschina.net/p/grpc-framework">gRPC</a> 是一个高性能、开源和通用的 RPC 框架，面向移动和 HTTP/2 设计。目前提供 C、Java 和 Go 语言版本，分别是：grpc, grpc-java, grpc-go. 其中 C 版本支持 C, C++, Node.js, Python, Ruby, Objective-C, PHP 和 C## 支持.</p>
<p>gRPC 基于 HTTP/2 标准设计，带来诸如双向流、流控、头部压缩、单 TCP 连接上的多复用请求等特。这些特性使得其在移动设备上表现更好，更省电和节省空间占用。</p>
<h3 id="grc优点">grc优点</h3>
<ul>
<li>多语言：语言中立，支持多种语言。</li>
<li>轻量级、高性能：序列化支持 PB(Protocol Buffer)和 JSON，PB 是一种语言无关的高性能序列化框架。
可插拔</li>
<li>IDL：基于文件定义服务，通过 proto3 工具生成指定语言的数据结构、服务端接口以及客户端 Stub。</li>
<li>移动端：基于标准的 HTTP2 设计，支持双向流、消息头压缩、单 TCP 的多路复用、服务端推送等特性，这些特性使得 gRPC 在移动端设备上更加省电和节省网络流量。</li>
</ul>
<p><img src="/images/f011b389-3272-4f7f-be74-4eb0f6bb7b94.png" alt=""></p>
<h2 id="安全">安全</h2>
<p>HTTP2 规范当使用 TLS 时强制使用 TLS 1.2 及以上的版本，并且在部署上对允许的密码施加一些额外的限制以避免已知的比如需要 SNI 支持的问题。并且期待 HTTP2 与专有的传输安全机制相结合，这些传输机制的规格说明不能提供有意义的建议。</p>
<h2 id="grpc使用">gRPC使用</h2>
<p>使用gRPC， 我们可以一次性的在一个.proto文件中定义服务并使用任何支持它的语言去实现客户端和服务端，反过来，它们可以应用在各种场景中，从Google的服务器到你自己的平板电脑—— gRPC帮你解决了不同语言及环境间通信的复杂性。使用protocol buffers还能获得其他好处，包括高效的序列号，简单的IDL以及容易进行接口更新。总之一句话，使用gRPC能让我们更容易编写跨语言的分布式代码。</p>
<ul>
<li>通过一个 protocol buffers 模式，定义一个简单的带有 Hello World 方法的 RPC 服务。</li>
<li>用你最喜欢的语言(如果可用的话)来创建一个实现了这个接口的服务端。</li>
<li>用你最喜欢的(或者其他你愿意的)语言来访问你的服务端。</li>
</ul>
<h2 id="什么用grpc">什么用grpc</h2>
<ul>
<li>服务而非对象、消息而非引用：促进微服务的系统间粗粒度消息交互设计理念。</li>
<li>负载无关的：不同的服务需要使用不同的消息类型和编码，例如 protocol buffers、JSON、XML 和 Thrift。</li>
<li>流：Streaming API。</li>
<li>阻塞式和非阻塞式：支持异步和同步处理在客户端和服务端间交互的消息序列。</li>
<li>元数据交换：常见的横切关注点，如认证或跟踪，依赖数据交换。</li>
<li>标准化状态码：客户端通常以有限的方式响应 API 调用返回的错误。</li>
</ul>
<h3 id="healthcheck">HealthCheck</h3>
<p>gRPC 有一个标准的健康检测协议，在 gRPC 的所有语言实现中基本都提供了生成代码和用于设置运行状态的功能。</p>
<p>主动健康检查 health check，可以在服务提供者服务不稳定时，被消费者所感知，临时从负载均衡中摘除，减少错误请求。当服务提供者重新稳定后，health check 成功，重新加入到消费者的负载均衡，恢复请求。health check，同样也被用于外挂方式的容器健康检测，或者流量检测(k8s liveness &amp; readiness)。</p>
<p><img src="/images/b0e2261e-65fd-4a25-92bd-faf3e2465848.png" alt=""></p>
<p><img src="/images/2d6258dc-37b5-409b-a46f-b727115925af.png" alt=""></p>
<h2 id="protubuf文件编写">protubuf文件编写</h2>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">syntax</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;proto3&#34;</span><span style="color:#111">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">hello</span><span style="color:#111">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// option go_package = &#34;hello&#34;;</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">option</span> <span style="color:#75af00">go_package</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;/hello&#34;</span><span style="color:#111">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// The greeting service definition.</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">service</span> <span style="color:#75af00">Greeter</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Sends a greeting</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75af00">rpc</span> <span style="color:#75af00">SayHello</span> <span style="color:#111">(</span><span style="color:#75af00">HelloRequest</span><span style="color:#111">)</span> <span style="color:#75af00">returns</span> <span style="color:#111">(</span><span style="color:#75af00">HelloReply</span><span style="color:#111">)</span>  <span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// The request message containing the user&#39;s name.</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">message</span> <span style="color:#75af00">HelloRequest</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#00a8c8">string</span> <span style="color:#75af00">name</span> <span style="color:#111">=</span> <span style="color:#ae81ff">1</span><span style="color:#111">;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// The response message containing the greetings</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">message</span> <span style="color:#75af00">HelloReply</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#00a8c8">string</span> <span style="color:#75af00">message</span> <span style="color:#111">=</span> <span style="color:#ae81ff">1</span><span style="color:#111">;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="golang创建grpc-server">golang创建grpc server</h2>
<p>安装工具包:</p>
<ol>
<li>下载protoc <a href="https://www.zhaohaiyu.com/protobuf/">链接</a></li>
<li><code>go install google.golang.org/protobuf/cmd/protoc-gen-go@latest</code></li>
<li><code>go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest</code></li>
</ol>
<p>执行:</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>protoc --go_out<span style="color:#f92672">=</span>./  --go-grpc_out<span style="color:#f92672">=</span>./  hello.proto
</span></span></code></pre></div><ul>
<li>&ndash;proto_path: 指定了要去哪个目录中搜索import中导入的和要编译为.go的proto文件 (在这没有使用,需要的话可以加上)</li>
<li>&ndash;go_out:指定了生成的go文件的目录，我在这里把go文件放到本目录中</li>
<li>&ndash;go-grpc_out: 指定了生成的go grpc文件的目录，我在这里把go grpc文件放到本目录中</li>
<li>hello.proto， 定义了我要编译的文件是哪个文件。</li>
</ul>
<h3 id="go-server代码">go server代码</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;context&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;errors&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;github.com/zhaohaiyu1996/akit/example/grpc/hello&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;google.golang.org/grpc&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;net&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Server</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">hello</span><span style="color:#111">.</span><span style="color:#75af00">UnimplementedGreeterServer</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// SayHello implements helloworld.GreeterServer</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">s</span> <span style="color:#f92672">*</span><span style="color:#75af00">Server</span><span style="color:#111">)</span> <span style="color:#75af00">SayHello</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">,</span> <span style="color:#75af00">in</span> <span style="color:#f92672">*</span><span style="color:#75af00">hello</span><span style="color:#111">.</span><span style="color:#75af00">HelloRequest</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">hello</span><span style="color:#111">.</span><span style="color:#75af00">HelloReply</span><span style="color:#111">,</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">in</span><span style="color:#111">.</span><span style="color:#75af00">Name</span> <span style="color:#f92672">==</span> <span style="color:#d88200">&#34;error&#34;</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">errors</span><span style="color:#111">.</span><span style="color:#75af00">New</span><span style="color:#111">(</span><span style="color:#d88200">&#34;123&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">in</span><span style="color:#111">.</span><span style="color:#75af00">Name</span> <span style="color:#f92672">==</span> <span style="color:#d88200">&#34;panic&#34;</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#d88200">&#34;grpc panic&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">hello</span><span style="color:#111">.</span><span style="color:#75af00">HelloReply</span><span style="color:#111">{</span><span style="color:#75af00">Message</span><span style="color:#111">:</span> <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Sprintf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Hello %+v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">in</span><span style="color:#111">.</span><span style="color:#75af00">Name</span><span style="color:#111">)},</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Ss</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">*</span><span style="color:#75af00">grpc</span><span style="color:#111">.</span><span style="color:#75af00">Server</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 监听本地的8848端口</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">s</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">Ss</span><span style="color:#111">{</span><span style="color:#75af00">grpc</span><span style="color:#111">.</span><span style="color:#75af00">NewServer</span><span style="color:#111">()}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">hello</span><span style="color:#111">.</span><span style="color:#75af00">RegisterGreeterServer</span><span style="color:#111">(</span><span style="color:#75af00">s</span><span style="color:#111">,</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">Server</span><span style="color:#111">{})</span> <span style="color:#75715e">// 在gRPC服务端注册服务</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">lis</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">net</span><span style="color:#111">.</span><span style="color:#75af00">Listen</span><span style="color:#111">(</span><span style="color:#d88200">&#34;tcp&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;127.0.0.1:8808&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;listen failed: %v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//reflection.Register(s.Server) //在给定的gRPC服务器上注册服务器反射服务</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Serve方法在lis上接受传入连接，为每个连接创建一个ServerTransport和server的goroutine。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 该goroutine读取gRPC请求，然后调用已注册的处理程序来响应它们。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">Serve</span><span style="color:#111">(</span><span style="color:#75af00">lis</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;failed to serve: %v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="golang创建grpc-client">golang创建grpc client</h2>
<p>执行:</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>protoc --go_out<span style="color:#f92672">=</span>./  --go-grpc_out<span style="color:#f92672">=</span>./  hello.proto
</span></span></code></pre></div><h3 id="go-client代码">go client代码</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;context&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;github.com/zhaohaiyu1996/akit/example/grpc/hello&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;google.golang.org/grpc&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 连接服务器</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">conn</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">grpc</span><span style="color:#111">.</span><span style="color:#75af00">Dial</span><span style="color:#111">(</span><span style="color:#d88200">&#34;localhost:8808&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">grpc</span><span style="color:#111">.</span><span style="color:#75af00">WithInsecure</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;connect faild: %v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">conn</span><span style="color:#111">.</span><span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">c</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">hello</span><span style="color:#111">.</span><span style="color:#75af00">NewGreeterClient</span><span style="color:#111">(</span><span style="color:#75af00">conn</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 调用SayHello</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">SayHello</span><span style="color:#111">(</span><span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Background</span><span style="color:#111">(),</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">hello</span><span style="color:#111">.</span><span style="color:#75af00">HelloRequest</span><span style="color:#111">{</span><span style="color:#75af00">Name</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;zhaohaiyu&#34;</span><span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;sayHello failed: %v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">r</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>结果:</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>SayHello: hello ---&gt; zhaohaiyu
</span></span></code></pre></div><h2 id="python创建grpc-client">python创建grpc client</h2>
<p>使用python客户端调用golang服务端的方法</p>
<p>下载依赖:</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#111">pip</span> <span style="color:#111">install</span> <span style="color:#111">grpcio</span>
</span></span><span style="display:flex;"><span><span style="color:#111">pip</span> <span style="color:#111">install</span> <span style="color:#111">protobuf</span>
</span></span><span style="display:flex;"><span><span style="color:#111">pip</span> <span style="color:#111">install</span> <span style="color:#111">grpcio_tools</span>
</span></span></code></pre></div><p>执行:</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>python -m grpc_tools.protoc -I ./ --python_out<span style="color:#f92672">=</span>./ --grpc_python_out<span style="color:#f92672">=</span>./ hello.proto
</span></span></code></pre></div><h3 id="python-client代码">python client代码</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">grpc</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">hello_pb2</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">hello_pb2_grpc</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">def</span> <span style="color:#75af00">run</span><span style="color:#111">():</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">with</span> <span style="color:#111">grpc</span><span style="color:#f92672">.</span><span style="color:#111">insecure_channel</span><span style="color:#111">(</span><span style="color:#d88200">&#39;localhost:8848&#39;</span><span style="color:#111">)</span> <span style="color:#00a8c8">as</span> <span style="color:#111">channel</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">stub</span> <span style="color:#f92672">=</span> <span style="color:#111">hello_pb2_grpc</span><span style="color:#f92672">.</span><span style="color:#111">HelloStub</span><span style="color:#111">(</span><span style="color:#111">channel</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">res</span> <span style="color:#f92672">=</span> <span style="color:#111">stub</span><span style="color:#f92672">.</span><span style="color:#111">SayHello</span><span style="color:#111">(</span><span style="color:#111">hello_pb2</span><span style="color:#f92672">.</span><span style="color:#111">HelloRequest</span><span style="color:#111">(</span><span style="color:#111">name</span><span style="color:#f92672">=</span><span style="color:#d88200">&#34;赵海宇&#34;</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">print</span><span style="color:#111">(</span><span style="color:#111">res</span><span style="color:#f92672">.</span><span style="color:#111">message</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#111">__name__</span> <span style="color:#f92672">==</span> <span style="color:#d88200">&#39;__main__&#39;</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">run</span><span style="color:#111">()</span>
</span></span></code></pre></div><p>结果:</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>python ./main.go
</span></span><span style="display:flex;"><span>hello ---&gt; 赵海宇
</span></span></code></pre></div><h2 id="gprc的haeder">gprc的haeder</h2>
<ul>
<li>grpc是基于http2.0的rpc框架 -</li>
<li>grpc对于http头部传递数据进行了封装 metadata,单独抽象了一个包google.golang.org/grpc/metadata-</li>
<li>type ***p[string][]string其实就是一个map</li>
</ul>
<p>客户端发送方式一:</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// 创建md 并加入ctx</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">md</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">metadata</span><span style="color:#111">.</span><span style="color:#75af00">Pairs</span><span style="color:#111">(</span><span style="color:#d88200">&#34;key1&#34;</span><span style="color:#111">,</span><span style="color:#d88200">&#34;value1&#34;</span><span style="color:#111">,</span><span style="color:#d88200">&#34;key2&#34;</span><span style="color:#111">,</span><span style="color:#d88200">&#34;value2&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ctx</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">metadata</span><span style="color:#111">.</span><span style="color:#75af00">NewOutgoingContext</span><span style="color:#111">(</span><span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Background</span><span style="color:#111">(),</span><span style="color:#75af00">md</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 从ctx中拿出md</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">md</span><span style="color:#111">,</span><span style="color:#75af00">_</span> <span style="color:#111">=</span> <span style="color:#75af00">metadata</span><span style="color:#111">.</span><span style="color:#75af00">FromOutgoingContext</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">newMd</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">metadata</span><span style="color:#111">.</span><span style="color:#75af00">Pairs</span><span style="color:#111">(</span><span style="color:#d88200">&#34;key3&#34;</span><span style="color:#111">,</span><span style="color:#d88200">&#34;value3&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ctx</span> <span style="color:#111">=</span> <span style="color:#75af00">metadata</span><span style="color:#111">.</span><span style="color:#75af00">NewOutgoingContext</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span><span style="color:#75af00">metadata</span><span style="color:#111">.</span><span style="color:#75af00">Join</span><span style="color:#111">(</span><span style="color:#75af00">md</span><span style="color:#111">,</span><span style="color:#75af00">newMd</span><span style="color:#111">))</span>
</span></span></code></pre></div><p>客户端发送方式二:</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">ctx</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Background</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">ctx</span> <span style="color:#111">=</span> <span style="color:#75af00">metadata</span><span style="color:#111">.</span><span style="color:#75af00">AppendToOutgoingContext</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span><span style="color:#d88200">&#34;key1&#34;</span><span style="color:#111">,</span><span style="color:#d88200">&#34;value1&#34;</span><span style="color:#111">,</span><span style="color:#d88200">&#34;key2&#34;</span><span style="color:#111">,</span><span style="color:#d88200">&#34;value2&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">ctx</span> <span style="color:#111">=</span> <span style="color:#75af00">metadata</span><span style="color:#111">.</span><span style="color:#75af00">AppendToOutgoingContext</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span><span style="color:#d88200">&#34;key3&#34;</span><span style="color:#111">,</span><span style="color:#d88200">&#34;value3&#34;</span><span style="color:#111">)</span>
</span></span></code></pre></div><p>服务端接收:</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">md</span><span style="color:#111">,</span><span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">metadata</span><span style="color:#111">.</span><span style="color:#75af00">FromIncomingContext</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">)</span>
</span></span></code></pre></div><p>实例:</p>
<ol>
<li>server:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;net&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">pb</span> <span style="color:#d88200">&#34;test/demo13/server/hello&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;github.com/grpc-ecosystem/grpc-gateway/examples/clients/responsebody&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;github.com/uber/jaeger-client-go/crossdock/client&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;golang.org/x/net/context&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;google.golang.org/grpc&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;google.golang.org/grpc/metadata&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;google.golang.org/grpc/reflection&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">server</span> <span style="color:#00a8c8">struct</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">s</span> <span style="color:#f92672">*</span><span style="color:#75af00">server</span><span style="color:#111">)</span> <span style="color:#75af00">SayHello</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">,</span> <span style="color:#75af00">in</span> <span style="color:#f92672">*</span><span style="color:#75af00">pb</span><span style="color:#111">.</span><span style="color:#75af00">HelloRequest</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">pb</span><span style="color:#111">.</span><span style="color:#75af00">HelloResponse</span><span style="color:#111">,</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">md</span><span style="color:#111">,</span><span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">metadata</span><span style="color:#111">.</span><span style="color:#75af00">FromIncomingContext</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">md</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">pb</span><span style="color:#111">.</span><span style="color:#75af00">HelloResponse</span><span style="color:#111">{</span><span style="color:#75af00">Message</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;hello ---&gt; &#34;</span> <span style="color:#f92672">+</span> <span style="color:#75af00">in</span><span style="color:#111">.</span><span style="color:#75af00">Name</span><span style="color:#111">},</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 监听本地的8848端口</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">lis</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">net</span><span style="color:#111">.</span><span style="color:#75af00">Listen</span><span style="color:#111">(</span><span style="color:#d88200">&#34;tcp&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;localhost:8848&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;listen failed: %v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">s</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">grpc</span><span style="color:#111">.</span><span style="color:#75af00">NewServer</span><span style="color:#111">()</span> <span style="color:#75715e">// 创建gRPC服务器</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">pb</span><span style="color:#111">.</span><span style="color:#75af00">RegisterHelloServer</span><span style="color:#111">(</span><span style="color:#75af00">s</span><span style="color:#111">,</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">server</span><span style="color:#111">{})</span> <span style="color:#75715e">// 在gRPC服务端注册服务</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">reflection</span><span style="color:#111">.</span><span style="color:#75af00">Register</span><span style="color:#111">(</span><span style="color:#75af00">s</span><span style="color:#111">)</span> <span style="color:#75715e">//在给定的gRPC服务器上注册服务器反射服务</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Serve方法在lis上接受传入连接，为每个连接创建一个ServerTransport和server的goroutine。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 该goroutine读取gRPC请求，然后调用已注册的处理程序来响应它们。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">Serve</span><span style="color:#111">(</span><span style="color:#75af00">lis</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;failed to serve: %v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><ol>
<li>client</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;context&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">pb</span> <span style="color:#d88200">&#34;test/demo13/client/hello&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;google.golang.org/grpc&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;google.golang.org/grpc/metadata&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 连接服务器</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">conn</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">grpc</span><span style="color:#111">.</span><span style="color:#75af00">Dial</span><span style="color:#111">(</span><span style="color:#d88200">&#34;localhost:8848&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">grpc</span><span style="color:#111">.</span><span style="color:#75af00">WithInsecure</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;faild to connect: %v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">conn</span><span style="color:#111">.</span><span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">c</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">pb</span><span style="color:#111">.</span><span style="color:#75af00">NewHelloClient</span><span style="color:#111">(</span><span style="color:#75af00">conn</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 调用服务端的SayHello</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ctx</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Background</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ctx</span> <span style="color:#111">=</span> <span style="color:#75af00">metadata</span><span style="color:#111">.</span><span style="color:#75af00">AppendToOutgoingContext</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span><span style="color:#d88200">&#34;zhyyz&#34;</span><span style="color:#111">,</span><span style="color:#d88200">&#34;961119&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">SayHello</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">pb</span><span style="color:#111">.</span><span style="color:#75af00">HelloRequest</span><span style="color:#111">{</span><span style="color:#75af00">Name</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;zhaohaiyu&#34;</span><span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;sayHello failed: %v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;SayHello: %s \n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">Message</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div>]]></content:encoded><category>microservice</category><category>grpc</category><category>go</category></item><item><title>proto buffer</title><link>https://daemon365.dev/post/microservice/protocol_buffer/</link><pubDate>Sun, 01 Dec 2019 00:00:00 +0800</pubDate><guid>https://daemon365.dev/post/microservice/protocol_buffer/</guid><description>&lt;p&gt;protobuf是一种高效的数据格式，平台无关、语言无关、可扩展，可用于 RPC 系统和持续数据存储系统。&lt;/p&gt;
&lt;h2 id="protobuf介绍"&gt;protobuf介绍&lt;/h2&gt;
&lt;p&gt;Protobuf是Protocol Buffer的简称，它是Google公司于2008年开源的一种高效的平台无关、语言无关、可扩展的数据格式，目前Protobuf作为接口规范的描述语言，可以作为Go语言RPC接口的基础工具。&lt;/p&gt;
&lt;h2 id="protobuf使用"&gt;protobuf使用&lt;/h2&gt;
&lt;p&gt;protobuf是一个与语言无关的一个数据协议，所以我们需要先编写IDL文件然后借助专用工具生成指定语言的代码，从而实现数据的序列化与反序列化过程。&lt;/p&gt;
&lt;p&gt;大致开发流程如下： 1. IDL编写 2. 生成指定语言的代码 3. 序列化和反序列化&lt;/p&gt;
&lt;h2 id="protobuf语法"&gt;protobuf语法&lt;/h2&gt;
&lt;p&gt;官网：&lt;a href="https://developers.google.cn/protocol-buffers/docs/proto3"&gt;https://developers.google.cn/protocol-buffers/docs/proto3&lt;/a&gt; (英文)&lt;/p&gt;
&lt;p&gt;三方：&lt;a href="https://colobu.com/2017/03/16/Protobuf3-language-guide"&gt;https://colobu.com/2017/03/16/Protobuf3-language-guide&lt;/a&gt; (中文)&lt;/p&gt;
&lt;h2 id="编译器安装"&gt;编译器安装&lt;/h2&gt;
&lt;h3 id="ptotoc"&gt;ptotoc&lt;/h3&gt;
&lt;p&gt;mac安装：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;brew info protobuf
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;cdn下载：(下载需要的版本)&lt;/p&gt;
&lt;p&gt;&lt;a href="https://repo1.maven.org/maven2/com/google/protobuf/protoc/"&gt;cdn下载链接&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;linux/mac 编译安装&lt;/p&gt;
&lt;p&gt;&lt;a href="https://github.com/protocolbuffers/protobuf/blob/master/src/README.md"&gt;教程&lt;/a&gt;&lt;/p&gt;
&lt;h3 id="protoc-gen-go"&gt;protoc-gen-go&lt;/h3&gt;
&lt;p&gt;安装生成Go语言代码的工具&lt;/p&gt;
&lt;p&gt;两个版本：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;github版本 &lt;code&gt;github.com/golang/protobuf/protoc-gen-go&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;google版本 &lt;code&gt;google.golang.org/protobuf/cmd/protoc-gen-go&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;区别在于前者是旧版本，后者是google接管后的新版本，他们之间的API是不同的，也就是说用于生成的命令，以及生成的文件都是不一样的。&lt;/p&gt;
&lt;p&gt;因为目前的&lt;code&gt;gRPC-go&lt;/code&gt;源码中的example用的是后者的生成方式，为了与时俱进，本文也采取最新的方式。&lt;/p&gt;
&lt;p&gt;安装：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;go install google.golang.org/protobuf/cmd/protoc-gen-go@latest
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id="编写idl代码"&gt;编写IDL代码&lt;/h2&gt;
&lt;p&gt;新建一个名为person.proto的文件具体内容如下：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-protobuf" data-lang="protobuf"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;// 指定使用protobuf版本
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;// 此处使用v3版本
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;&lt;/span&gt;&lt;span style="color:#111"&gt;syntax&lt;/span&gt; &lt;span style="color:#f92672"&gt;=&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;proto3&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;;&lt;/span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt;&lt;span style="color:#75715e"&gt;// 包名，通过protoc生成go文件
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;&lt;/span&gt;&lt;span style="color:#f92672"&gt;package&lt;/span&gt; &lt;span style="color:#111"&gt;address&lt;/span&gt;&lt;span style="color:#111"&gt;;&lt;/span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt;&lt;span style="color:#75715e"&gt;// go的包名 新版protoc-gen-go 必须带&amp;#34;/&amp;#34;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;option&lt;/span&gt; &lt;span style="color:#111"&gt;go_package&lt;/span&gt; &lt;span style="color:#f92672"&gt;=&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;../hello&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;;&lt;/span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt;&lt;span style="color:#75715e"&gt;// 性别类型
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;// 枚举类型第一个字段必须为0
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;enum&lt;/span&gt; &lt;span style="color:#111"&gt;GenderType&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt; &lt;span style="color:#111"&gt;SECRET&lt;/span&gt; &lt;span style="color:#f92672"&gt;=&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;0&lt;/span&gt;&lt;span style="color:#111"&gt;;&lt;/span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt; &lt;span style="color:#111"&gt;FEMALE&lt;/span&gt; &lt;span style="color:#f92672"&gt;=&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;1&lt;/span&gt;&lt;span style="color:#111"&gt;;&lt;/span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt; &lt;span style="color:#111"&gt;MALE&lt;/span&gt; &lt;span style="color:#f92672"&gt;=&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;2&lt;/span&gt;&lt;span style="color:#111"&gt;;&lt;/span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt;&lt;span style="color:#75715e"&gt;// 人
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;message&lt;/span&gt; &lt;span style="color:#75af00"&gt;Person&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;int64&lt;/span&gt; &lt;span style="color:#111"&gt;id&lt;/span&gt; &lt;span style="color:#f92672"&gt;=&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;1&lt;/span&gt;&lt;span style="color:#111"&gt;;&lt;/span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;string&lt;/span&gt; &lt;span style="color:#111"&gt;name&lt;/span&gt; &lt;span style="color:#f92672"&gt;=&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;2&lt;/span&gt;&lt;span style="color:#111"&gt;;&lt;/span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt; &lt;span style="color:#111"&gt;GenderType&lt;/span&gt; &lt;span style="color:#111"&gt;gender&lt;/span&gt; &lt;span style="color:#f92672"&gt;=&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;3&lt;/span&gt;&lt;span style="color:#111"&gt;;&lt;/span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;string&lt;/span&gt; &lt;span style="color:#111"&gt;number&lt;/span&gt; &lt;span style="color:#f92672"&gt;=&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;4&lt;/span&gt;&lt;span style="color:#111"&gt;;&lt;/span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt;&lt;span style="color:#75715e"&gt;// 联系簿
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;message&lt;/span&gt; &lt;span style="color:#75af00"&gt;ContactBook&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;repeated&lt;/span&gt; &lt;span style="color:#111"&gt;Person&lt;/span&gt; &lt;span style="color:#111"&gt;persons&lt;/span&gt; &lt;span style="color:#f92672"&gt;=&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;1&lt;/span&gt;&lt;span style="color:#111"&gt;;&lt;/span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id="生成go语言代码"&gt;生成go语言代码&lt;/h2&gt;
&lt;p&gt;在protobuf_demo/address目录下执行以下命令。&lt;/p&gt;</description><content:encoded><![CDATA[<p>protobuf是一种高效的数据格式，平台无关、语言无关、可扩展，可用于 RPC 系统和持续数据存储系统。</p>
<h2 id="protobuf介绍">protobuf介绍</h2>
<p>Protobuf是Protocol Buffer的简称，它是Google公司于2008年开源的一种高效的平台无关、语言无关、可扩展的数据格式，目前Protobuf作为接口规范的描述语言，可以作为Go语言RPC接口的基础工具。</p>
<h2 id="protobuf使用">protobuf使用</h2>
<p>protobuf是一个与语言无关的一个数据协议，所以我们需要先编写IDL文件然后借助专用工具生成指定语言的代码，从而实现数据的序列化与反序列化过程。</p>
<p>大致开发流程如下： 1. IDL编写 2. 生成指定语言的代码 3. 序列化和反序列化</p>
<h2 id="protobuf语法">protobuf语法</h2>
<p>官网：<a href="https://developers.google.cn/protocol-buffers/docs/proto3">https://developers.google.cn/protocol-buffers/docs/proto3</a> (英文)</p>
<p>三方：<a href="https://colobu.com/2017/03/16/Protobuf3-language-guide">https://colobu.com/2017/03/16/Protobuf3-language-guide</a>  (中文)</p>
<h2 id="编译器安装">编译器安装</h2>
<h3 id="ptotoc">ptotoc</h3>
<p>mac安装：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>brew info protobuf
</span></span></code></pre></div><p>cdn下载：(下载需要的版本)</p>
<p><a href="https://repo1.maven.org/maven2/com/google/protobuf/protoc/">cdn下载链接</a></p>
<p>linux/mac 编译安装</p>
<p><a href="https://github.com/protocolbuffers/protobuf/blob/master/src/README.md">教程</a></p>
<h3 id="protoc-gen-go">protoc-gen-go</h3>
<p>安装生成Go语言代码的工具</p>
<p>两个版本：</p>
<ul>
<li>github版本  <code>github.com/golang/protobuf/protoc-gen-go</code></li>
<li>google版本 <code>google.golang.org/protobuf/cmd/protoc-gen-go</code></li>
</ul>
<p>区别在于前者是旧版本，后者是google接管后的新版本，他们之间的API是不同的，也就是说用于生成的命令，以及生成的文件都是不一样的。</p>
<p>因为目前的<code>gRPC-go</code>源码中的example用的是后者的生成方式，为了与时俱进，本文也采取最新的方式。</p>
<p>安装：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>go install google.golang.org/protobuf/cmd/protoc-gen-go@latest
</span></span><span style="display:flex;"><span>go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest
</span></span></code></pre></div><h2 id="编写idl代码">编写IDL代码</h2>
<p>新建一个名为person.proto的文件具体内容如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-protobuf" data-lang="protobuf"><span style="display:flex;"><span><span style="color:#75715e">// 指定使用protobuf版本
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// 此处使用v3版本
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#111">syntax</span> <span style="color:#f92672">=</span> <span style="color:#d88200">&#34;proto3&#34;</span><span style="color:#111">;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e">// 包名，通过protoc生成go文件
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">package</span> <span style="color:#111">address</span><span style="color:#111">;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e">// go的包名 新版protoc-gen-go 必须带&#34;/&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#00a8c8">option</span> <span style="color:#111">go_package</span> <span style="color:#f92672">=</span> <span style="color:#d88200">&#34;../hello&#34;</span><span style="color:#111">;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e">// 性别类型 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// 枚举类型第一个字段必须为0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#00a8c8">enum</span> <span style="color:#111">GenderType</span> <span style="color:#111">{</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    <span style="color:#111">SECRET</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span><span style="color:#111">;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    <span style="color:#111">FEMALE</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span><span style="color:#111">;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    <span style="color:#111">MALE</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span><span style="color:#111">;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#111">}</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e">// 人
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#00a8c8">message</span> <span style="color:#75af00">Person</span> <span style="color:#111">{</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    <span style="color:#00a8c8">int64</span> <span style="color:#111">id</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span><span style="color:#111">;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    <span style="color:#00a8c8">string</span> <span style="color:#111">name</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span><span style="color:#111">;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    <span style="color:#111">GenderType</span> <span style="color:#111">gender</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span><span style="color:#111">;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    <span style="color:#00a8c8">string</span> <span style="color:#111">number</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span><span style="color:#111">;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#111">}</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e">// 联系簿
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#00a8c8">message</span> <span style="color:#75af00">ContactBook</span> <span style="color:#111">{</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    <span style="color:#00a8c8">repeated</span> <span style="color:#111">Person</span> <span style="color:#111">persons</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span><span style="color:#111">;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#111">}</span><span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><h2 id="生成go语言代码">生成go语言代码</h2>
<p>在protobuf_demo/address目录下执行以下命令。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>protoc --proto_path<span style="color:#f92672">=</span>./  --go_out<span style="color:#f92672">=</span>./ ./person.proto
</span></span></code></pre></div><ul>
<li>&ndash;proto_path: 指定了要去哪个目录中搜索import中导入的和要编译为.go的proto文件</li>
<li>&ndash;go_out:指定了生成的go文件的目录，我在这里把go文件放到本目录中</li>
<li>person.proto， 定义了我要编译的文件是哪个文件。</li>
</ul>
<p>此时在当前目录下会生成一个person.pb.go文件，我们的Go语言代码里就是使用这个文件。 在protobuf_demo/main.go文件中：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;io/ioutil&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;z/test3/person&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;github.com/golang/protobuf/proto&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">var</span> <span style="color:#75af00">cb</span> <span style="color:#75af00">person</span><span style="color:#111">.</span><span style="color:#75af00">ContactBook</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">p1</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">person</span><span style="color:#111">.</span><span style="color:#75af00">Person</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">Name</span><span style="color:#111">:</span>   <span style="color:#d88200">&#34;zhao&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">Gender</span><span style="color:#111">:</span> <span style="color:#75af00">person</span><span style="color:#111">.</span><span style="color:#75af00">GenderType_MALE</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">Number</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;12345678910&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">p1</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">cb</span><span style="color:#111">.</span><span style="color:#75af00">Persons</span> <span style="color:#111">=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">cb</span><span style="color:#111">.</span><span style="color:#75af00">Persons</span><span style="color:#111">,</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">p1</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">data</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">proto</span><span style="color:#111">.</span><span style="color:#75af00">Marshal</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">p1</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;marshal failed,err:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ioutil</span><span style="color:#111">.</span><span style="color:#75af00">WriteFile</span><span style="color:#111">(</span><span style="color:#d88200">&#34;./proto.dat&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">data</span><span style="color:#111">,</span> <span style="color:#ae81ff">0644</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">data2</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">ioutil</span><span style="color:#111">.</span><span style="color:#75af00">ReadFile</span><span style="color:#111">(</span><span style="color:#d88200">&#34;./proto.dat&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;read file failed, err:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">var</span> <span style="color:#75af00">p2</span> <span style="color:#75af00">person</span><span style="color:#111">.</span><span style="color:#75af00">Person</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">proto</span><span style="color:#111">.</span><span style="color:#75af00">Unmarshal</span><span style="color:#111">(</span><span style="color:#75af00">data2</span><span style="color:#111">,</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">p2</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">p2</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>参考文章:<a href="https://www.liwenzhou.com/posts/Go/protobuf/">https://www.liwenzhou.com/posts/Go/protobuf/</a></p>
]]></content:encoded><category>microservice</category><category>go</category><category>protobuf</category></item></channel></rss>