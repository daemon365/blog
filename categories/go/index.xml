<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/"><channel><title>Go on Daemon365</title><link>https://daemon365.dev/categories/go/</link><description>Don't let yourself stop.</description><generator>Hugo -- gohugo.io</generator><language>zh-cn</language><lastBuildDate>Sun, 22 Dec 2024 19:14:55 +0800</lastBuildDate><atom:link href="https://daemon365.dev/categories/go/index.xml" rel="self" type="application/rss+xml"/><item><title>Go channel 原理</title><link>https://daemon365.dev/post/go/go_channel_code/</link><pubDate>Sun, 22 Dec 2024 19:14:55 +0800</pubDate><guid>https://daemon365.dev/post/go/go_channel_code/</guid><description>&lt;h2 id="作用"&gt;作用&lt;/h2&gt;
&lt;ol&gt;
&lt;li&gt;Go 语言的 channel 是一种 goroutine 之间的通信方式，它可以用来传递数据，也可以用来同步 goroutine 的执行。&lt;/li&gt;
&lt;li&gt;chan 是 goroutine 之间的通信桥梁，可以安全地在多个 goroutine 中共享数据。&lt;/li&gt;
&lt;li&gt;使用 chan 实现 goroutine 之间的协作与同步，可用于信号传递、任务完成通知等。&lt;/li&gt;
&lt;li&gt;select 配合 chan，可以同时监听多个 channel，处理任意一个可用 channel 的数据。&lt;/li&gt;
&lt;/ol&gt;</description><content:encoded><![CDATA[<h2 id="作用">作用</h2>
<ol>
<li>Go 语言的 channel 是一种 goroutine 之间的通信方式，它可以用来传递数据，也可以用来同步 goroutine 的执行。</li>
<li>chan 是 goroutine 之间的通信桥梁，可以安全地在多个 goroutine 中共享数据。</li>
<li>使用 chan 实现 goroutine 之间的协作与同步，可用于信号传递、任务完成通知等。</li>
<li>select 配合 chan，可以同时监听多个 channel，处理任意一个可用 channel 的数据。</li>
</ol>
<h2 id="结构">结构</h2>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">hchan</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">qcount</span>   <span style="color:#00a8c8">uint</span>           <span style="color:#75715e">// 队列中的元素个数</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">dataqsiz</span> <span style="color:#00a8c8">uint</span>           <span style="color:#75715e">// 环形队列的容量</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">buf</span>      <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span> <span style="color:#75715e">// 环形队列的指针</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">elemsize</span> <span style="color:#00a8c8">uint16</span>        <span style="color:#75715e">// 元素的大小</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">closed</span>   <span style="color:#00a8c8">uint32</span>         <span style="color:#75715e">// 是否关闭 如果以关闭则不是0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">timer</span>    <span style="color:#f92672">*</span><span style="color:#75af00">timer</span> <span style="color:#75715e">// 为此 channel 提供时间控制的计时器</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">elemtype</span> <span style="color:#f92672">*</span><span style="color:#75af00">_type</span> <span style="color:#75715e">// 元素的类型</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">sendx</span>    <span style="color:#00a8c8">uint</span>   <span style="color:#75715e">// 发送索引，指示下一个发送操作的位置</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">recvx</span>    <span style="color:#00a8c8">uint</span>   <span style="color:#75715e">// 接收索引，指示下一个接收操作的位置</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">recvq</span>    <span style="color:#75af00">waitq</span>  <span style="color:#75715e">// 等待接收的等待队列</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">sendq</span>    <span style="color:#75af00">waitq</span>  <span style="color:#75715e">// 等待发送的等待队列</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 锁</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">lock</span> <span style="color:#75af00">mutex</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p><img src="/images/go_channel_struct.png" alt=""></p>
<p><strong>waitq</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">waitq</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">first</span> <span style="color:#f92672">*</span><span style="color:#75af00">sudog</span> <span style="color:#75715e">// 首指针</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">last</span>  <span style="color:#f92672">*</span><span style="color:#75af00">sudog</span> <span style="color:#75715e">// 尾指针</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p><strong>sudog</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">sudog</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">g</span> <span style="color:#f92672">*</span><span style="color:#75af00">g</span>              <span style="color:#75715e">// goroutine</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">next</span> <span style="color:#f92672">*</span><span style="color:#75af00">sudog</span>       <span style="color:#75715e">// 指向下一个sudog，用于形成链表</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">prev</span> <span style="color:#f92672">*</span><span style="color:#75af00">sudog</span>       <span style="color:#75715e">// 指向上一个sudog，用于形成链表</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">elem</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span> <span style="color:#75715e">// 指向数据元素的指针（可能指向栈上的数据）</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">acquiretime</span> <span style="color:#00a8c8">int64</span> <span style="color:#75715e">// 获取资源的时间</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">releasetime</span> <span style="color:#00a8c8">int64</span> <span style="color:#75715e">// 释放资源的时间</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">ticket</span>      <span style="color:#00a8c8">uint32</span> <span style="color:#75715e">// 票据号码，用于排序和公平性</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">isSelect</span> <span style="color:#00a8c8">bool</span>     <span style="color:#75715e">// 标志是否在select操作中使用此sudog</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">success</span> <span style="color:#00a8c8">bool</span>      <span style="color:#75715e">// 通信是否成功（接收到值或因 channel 关闭被唤醒）</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">waiters</span> <span style="color:#00a8c8">uint16</span>    <span style="color:#75715e">// 等待者数量，仅在列表头部有意义</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">parent</span>   <span style="color:#f92672">*</span><span style="color:#75af00">sudog</span>   <span style="color:#75715e">// 指向父节点的指针，在二叉树结构中使用</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">waitlink</span> <span style="color:#f92672">*</span><span style="color:#75af00">sudog</span>   <span style="color:#75715e">// g的等待链表或semaRoot</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">waittail</span> <span style="color:#f92672">*</span><span style="color:#75af00">sudog</span>   <span style="color:#75715e">// semaRoot的尾部</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">c</span>        <span style="color:#f92672">*</span><span style="color:#75af00">hchan</span>   <span style="color:#75715e">// 指向sudog所等待的 channel </span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="创建">创建</h2>
<p>创建一个 channel:</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">makechan</span><span style="color:#111">(</span><span style="color:#75af00">t</span> <span style="color:#f92672">*</span><span style="color:#75af00">chantype</span><span style="color:#111">,</span> <span style="color:#75af00">size</span> <span style="color:#00a8c8">int</span><span style="color:#111">)</span> <span style="color:#f92672">*</span><span style="color:#75af00">hchan</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 元素类型</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">elem</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">Elem</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 检查大小是否合法</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">elem</span><span style="color:#111">.</span><span style="color:#75af00">Size_</span> <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">&lt;&lt;</span><span style="color:#ae81ff">16</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">throw</span><span style="color:#111">(</span><span style="color:#d88200">&#34;makechan: invalid channel element type&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 是否满足对齐要求</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">hchanSize</span><span style="color:#f92672">%</span><span style="color:#75af00">maxAlign</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">||</span> <span style="color:#75af00">elem</span><span style="color:#111">.</span><span style="color:#75af00">Align_</span> <span style="color:#111">&gt;</span> <span style="color:#75af00">maxAlign</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">throw</span><span style="color:#111">(</span><span style="color:#d88200">&#34;makechan: bad alignment&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 计算内存分配所需大小：`元素大小 * 数量`。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">mem</span><span style="color:#111">,</span> <span style="color:#75af00">overflow</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">math</span><span style="color:#111">.</span><span style="color:#75af00">MulUintptr</span><span style="color:#111">(</span><span style="color:#75af00">elem</span><span style="color:#111">.</span><span style="color:#75af00">Size_</span><span style="color:#111">,</span> <span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">size</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">overflow</span> <span style="color:#f92672">||</span> <span style="color:#75af00">mem</span> <span style="color:#111">&gt;</span> <span style="color:#75af00">maxAlloc</span><span style="color:#f92672">-</span><span style="color:#75af00">hchanSize</span> <span style="color:#f92672">||</span> <span style="color:#75af00">size</span> <span style="color:#111">&lt;</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#75af00">plainError</span><span style="color:#111">(</span><span style="color:#d88200">&#34;makechan: size out of range&#34;</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">var</span> <span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">hchan</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">switch</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">case</span> <span style="color:#75af00">mem</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 队列大小为0 说明是无缓冲的channel 直接分配hchan</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 分配内存 hchanSize 是 hchan 结构体的大小</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">c</span> <span style="color:#111">=</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">hchan</span><span style="color:#111">)(</span><span style="color:#75af00">mallocgc</span><span style="color:#111">(</span><span style="color:#75af00">hchanSize</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#00a8c8">true</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">buf</span> <span style="color:#111">=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">raceaddr</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">case</span> <span style="color:#111">!</span><span style="color:#75af00">elem</span><span style="color:#111">.</span><span style="color:#75af00">Pointers</span><span style="color:#111">():</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 如果元素中不包含指针 则使用一个连续的内存块 结构体和 buf 是连续的</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">c</span> <span style="color:#111">=</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">hchan</span><span style="color:#111">)(</span><span style="color:#75af00">mallocgc</span><span style="color:#111">(</span><span style="color:#75af00">hchanSize</span><span style="color:#f92672">+</span><span style="color:#75af00">mem</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#00a8c8">true</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">buf</span> <span style="color:#111">=</span> <span style="color:#75af00">add</span><span style="color:#111">(</span><span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">),</span> <span style="color:#75af00">hchanSize</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">default</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 如果元素中包含指针 则使用两个内存块</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">c</span> <span style="color:#111">=</span> <span style="color:#111">new</span><span style="color:#111">(</span><span style="color:#75af00">hchan</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">buf</span> <span style="color:#111">=</span> <span style="color:#75af00">mallocgc</span><span style="color:#111">(</span><span style="color:#75af00">mem</span><span style="color:#111">,</span> <span style="color:#75af00">elem</span><span style="color:#111">,</span> <span style="color:#00a8c8">true</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">elemsize</span> <span style="color:#111">=</span> <span style="color:#111">uint16</span><span style="color:#111">(</span><span style="color:#75af00">elem</span><span style="color:#111">.</span><span style="color:#75af00">Size_</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">elemtype</span> <span style="color:#111">=</span> <span style="color:#75af00">elem</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">dataqsiz</span> <span style="color:#111">=</span> <span style="color:#111">uint</span><span style="color:#111">(</span><span style="color:#75af00">size</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">lockInit</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">lock</span><span style="color:#111">,</span> <span style="color:#75af00">lockRankHchan</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">debugChan</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">print</span><span style="color:#111">(</span><span style="color:#d88200">&#34;makechan: chan=&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">c</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;; elemsize=&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">elem</span><span style="color:#111">.</span><span style="color:#75af00">Size_</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;; dataqsiz=&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">size</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;\n&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">c</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">const</span> <span style="color:#75af00">hchanSize</span> <span style="color:#111">=</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Sizeof</span><span style="color:#111">(</span><span style="color:#75af00">hchan</span><span style="color:#111">{})</span> <span style="color:#f92672">+</span> <span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#f92672">-</span><span style="color:#111">int</span><span style="color:#111">(</span><span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Sizeof</span><span style="color:#111">(</span><span style="color:#75af00">hchan</span><span style="color:#111">{}))</span><span style="color:#f92672">&amp;</span><span style="color:#111">(</span><span style="color:#75af00">maxAlign</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">hchan</span><span style="color:#111">)</span> <span style="color:#75af00">raceaddr</span><span style="color:#111">()</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 将对 channel 的读写操作视为发生在这个地址。</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 避免使用 `qcount` 或 `dataqsiz` 的地址，</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 因为内建函数 `len()` 和 `cap()` 会读取这些地址，</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 而我们不希望这些操作与例如 `close()` 之类的操作发生竞争。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">buf</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="写">写</h2>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">chansend1</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">hchan</span><span style="color:#111">,</span> <span style="color:#75af00">elem</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">chansend</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">,</span> <span style="color:#75af00">elem</span><span style="color:#111">,</span> <span style="color:#00a8c8">true</span><span style="color:#111">,</span> <span style="color:#75af00">getcallerpc</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">chansend</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">hchan</span><span style="color:#111">,</span> <span style="color:#75af00">ep</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">,</span> <span style="color:#75af00">block</span> <span style="color:#00a8c8">bool</span><span style="color:#111">,</span> <span style="color:#75af00">callerpc</span> <span style="color:#00a8c8">uintptr</span><span style="color:#111">)</span> <span style="color:#00a8c8">bool</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">c</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">block</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">false</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 如果 channel 为空 挂起当前 goroutine 并报错</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">gopark</span><span style="color:#111">(</span><span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">waitReasonChanSendNilChan</span><span style="color:#111">,</span> <span style="color:#75af00">traceBlockForever</span><span style="color:#111">,</span> <span style="color:#ae81ff">2</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">throw</span><span style="color:#111">(</span><span style="color:#d88200">&#34;unreachable&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ......</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 检查非阻塞模式是否可以直接返回失败结果</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">block</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">closed</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">full</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">false</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">var</span> <span style="color:#75af00">t0</span> <span style="color:#00a8c8">int64</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">blockprofilerate</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">t0</span> <span style="color:#111">=</span> <span style="color:#75af00">cputicks</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">lock</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">lock</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 检查 channel 是否已经关闭</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">closed</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">unlock</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">lock</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#75af00">plainError</span><span style="color:#111">(</span><span style="color:#d88200">&#34;send on closed channel&#34;</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">sg</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">recvq</span><span style="color:#111">.</span><span style="color:#75af00">dequeue</span><span style="color:#111">();</span> <span style="color:#75af00">sg</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 如果有等待接收的 Goroutine，直接将值发送给它，跳过缓冲区</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">send</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">,</span> <span style="color:#75af00">sg</span><span style="color:#111">,</span> <span style="color:#75af00">ep</span><span style="color:#111">,</span> <span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#111">{</span> <span style="color:#75af00">unlock</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">lock</span><span style="color:#111">)</span> <span style="color:#111">},</span> <span style="color:#ae81ff">3</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">true</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">qcount</span> <span style="color:#111">&lt;</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">dataqsiz</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		 <span style="color:#75715e">// 如果通道缓冲区有空间，直接将值写入缓冲区</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">qp</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">chanbuf</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">,</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">sendx</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">raceenabled</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">racenotify</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">,</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">sendx</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">typedmemmove</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">elemtype</span><span style="color:#111">,</span> <span style="color:#75af00">qp</span><span style="color:#111">,</span> <span style="color:#75af00">ep</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">sendx</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">sendx</span> <span style="color:#f92672">==</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">dataqsiz</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">sendx</span> <span style="color:#111">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">qcount</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">unlock</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">lock</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">true</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">block</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 非阻塞模式且无法发送值，返回 false</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">unlock</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">lock</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">false</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 阻塞模式，当前 Goroutine 挂起等待接收者</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">gp</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">getg</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 放入 acquireSudog</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">mysg</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">acquireSudog</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">mysg</span><span style="color:#111">.</span><span style="color:#75af00">releasetime</span> <span style="color:#111">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">t0</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">mysg</span><span style="color:#111">.</span><span style="color:#75af00">releasetime</span> <span style="color:#111">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">mysg</span><span style="color:#111">.</span><span style="color:#75af00">elem</span> <span style="color:#111">=</span> <span style="color:#75af00">ep</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">mysg</span><span style="color:#111">.</span><span style="color:#75af00">waitlink</span> <span style="color:#111">=</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">mysg</span><span style="color:#111">.</span><span style="color:#75af00">g</span> <span style="color:#111">=</span> <span style="color:#75af00">gp</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">mysg</span><span style="color:#111">.</span><span style="color:#75af00">isSelect</span> <span style="color:#111">=</span> <span style="color:#00a8c8">false</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">mysg</span><span style="color:#111">.</span><span style="color:#75af00">c</span> <span style="color:#111">=</span> <span style="color:#75af00">c</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">gp</span><span style="color:#111">.</span><span style="color:#75af00">waiting</span> <span style="color:#111">=</span> <span style="color:#75af00">mysg</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">gp</span><span style="color:#111">.</span><span style="color:#75af00">param</span> <span style="color:#111">=</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">sendq</span><span style="color:#111">.</span><span style="color:#75af00">enqueue</span><span style="color:#111">(</span><span style="color:#75af00">mysg</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">gp</span><span style="color:#111">.</span><span style="color:#75af00">parkingOnChan</span><span style="color:#111">.</span><span style="color:#75af00">Store</span><span style="color:#111">(</span><span style="color:#00a8c8">true</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">gopark</span><span style="color:#111">(</span><span style="color:#75af00">chanparkcommit</span><span style="color:#111">,</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">lock</span><span style="color:#111">),</span> <span style="color:#75af00">waitReasonChanSend</span><span style="color:#111">,</span> <span style="color:#75af00">traceBlockChanSend</span><span style="color:#111">,</span> <span style="color:#ae81ff">2</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 确保发送值在接收者拷贝之前不会被释放</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">KeepAlive</span><span style="color:#111">(</span><span style="color:#75af00">ep</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 唤醒后，检查状态</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">mysg</span> <span style="color:#f92672">!=</span> <span style="color:#75af00">gp</span><span style="color:#111">.</span><span style="color:#75af00">waiting</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">throw</span><span style="color:#111">(</span><span style="color:#d88200">&#34;G waiting list is corrupted&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">gp</span><span style="color:#111">.</span><span style="color:#75af00">waiting</span> <span style="color:#111">=</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">gp</span><span style="color:#111">.</span><span style="color:#75af00">activeStackChans</span> <span style="color:#111">=</span> <span style="color:#00a8c8">false</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">closed</span> <span style="color:#f92672">:=</span> <span style="color:#111">!</span><span style="color:#75af00">mysg</span><span style="color:#111">.</span><span style="color:#75af00">success</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">gp</span><span style="color:#111">.</span><span style="color:#75af00">param</span> <span style="color:#111">=</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">mysg</span><span style="color:#111">.</span><span style="color:#75af00">releasetime</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">blockevent</span><span style="color:#111">(</span><span style="color:#75af00">mysg</span><span style="color:#111">.</span><span style="color:#75af00">releasetime</span><span style="color:#f92672">-</span><span style="color:#75af00">t0</span><span style="color:#111">,</span> <span style="color:#ae81ff">2</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">mysg</span><span style="color:#111">.</span><span style="color:#75af00">c</span> <span style="color:#111">=</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 回收 sudog</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">releaseSudog</span><span style="color:#111">(</span><span style="color:#75af00">mysg</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">closed</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">closed</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">throw</span><span style="color:#111">(</span><span style="color:#d88200">&#34;chansend: spurious wakeup&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#75af00">plainError</span><span style="color:#111">(</span><span style="color:#d88200">&#34;send on closed channel&#34;</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">true</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>所以阻塞写这个主要有三种模式:</p>
<ol>
<li>如果有等待接收的 Goroutine （c.recvq 里面有值），说明 buf 要么满了 要么就没有，直接将值发送给它，跳过缓冲区</li>
<li>如果通道缓冲区有空间，直接将值写入缓冲区</li>
<li>如果缓冲区没有空间，且是阻塞模式，当前 Goroutine 挂起等待接收者</li>
</ol>
<p><img src="/images/go_channel_write.png" alt=""></p>
<h3 id="send">send</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">send</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">hchan</span><span style="color:#111">,</span> <span style="color:#75af00">sg</span> <span style="color:#f92672">*</span><span style="color:#75af00">sudog</span><span style="color:#111">,</span> <span style="color:#75af00">ep</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">,</span> <span style="color:#75af00">unlockf</span> <span style="color:#00a8c8">func</span><span style="color:#111">(),</span> <span style="color:#75af00">skip</span> <span style="color:#00a8c8">int</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ......</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 如果接收者有一个有效的元素指针，则将发送者的数据直接拷贝给接收者</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">sg</span><span style="color:#111">.</span><span style="color:#75af00">elem</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">sendDirect</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">elemtype</span><span style="color:#111">,</span> <span style="color:#75af00">sg</span><span style="color:#111">,</span> <span style="color:#75af00">ep</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">sg</span><span style="color:#111">.</span><span style="color:#75af00">elem</span> <span style="color:#111">=</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">gp</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">sg</span><span style="color:#111">.</span><span style="color:#75af00">g</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">unlockf</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">gp</span><span style="color:#111">.</span><span style="color:#75af00">param</span> <span style="color:#111">=</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">(</span><span style="color:#75af00">sg</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">sg</span><span style="color:#111">.</span><span style="color:#75af00">success</span> <span style="color:#111">=</span> <span style="color:#00a8c8">true</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">sg</span><span style="color:#111">.</span><span style="color:#75af00">releasetime</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">sg</span><span style="color:#111">.</span><span style="color:#75af00">releasetime</span> <span style="color:#111">=</span> <span style="color:#75af00">cputicks</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#75715e">// 唤醒接收者 Goroutine</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">goready</span><span style="color:#111">(</span><span style="color:#75af00">gp</span><span style="color:#111">,</span> <span style="color:#75af00">skip</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">sendDirect</span><span style="color:#111">(</span><span style="color:#75af00">t</span> <span style="color:#f92672">*</span><span style="color:#75af00">_type</span><span style="color:#111">,</span> <span style="color:#75af00">sg</span> <span style="color:#f92672">*</span><span style="color:#75af00">sudog</span><span style="color:#111">,</span> <span style="color:#75af00">src</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 内存拷贝</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">dst</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">sg</span><span style="color:#111">.</span><span style="color:#75af00">elem</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">typeBitsBulkBarrier</span><span style="color:#111">(</span><span style="color:#75af00">t</span><span style="color:#111">,</span> <span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">dst</span><span style="color:#111">),</span> <span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">src</span><span style="color:#111">),</span> <span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">Size_</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">memmove</span><span style="color:#111">(</span><span style="color:#75af00">dst</span><span style="color:#111">,</span> <span style="color:#75af00">src</span><span style="color:#111">,</span> <span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">Size_</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>大致的逻辑为，取出 goroutine 然后把接受的值 COPY 到接受者的内存中，然后唤醒接受者 goroutine。
接受的内存可能是堆也可能是栈，堆还好说，如果是栈，就是在一个栈内直接操作其他的栈了，按理来说，这是不安全的。但是，这是 runtime, 我们已经把 goroutine GoPark 了，保证了它不会执行，所以这里是安全的。当然我们自己写代码时，肯定是不能这么做的。</p>
<h3 id="chanbuf--typedmemmove">chanbuf &amp;&amp; typedmemmove</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">chanbuf</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">hchan</span><span style="color:#111">,</span> <span style="color:#75af00">i</span> <span style="color:#00a8c8">uint</span><span style="color:#111">)</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 在 buf 上加上 i * elemsize 的偏移量</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">add</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">buf</span><span style="color:#111">,</span> <span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">i</span><span style="color:#111">)</span><span style="color:#f92672">*</span><span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">elemsize</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">typedmemmove</span><span style="color:#111">(</span><span style="color:#75af00">typ</span> <span style="color:#f92672">*</span><span style="color:#75af00">abi</span><span style="color:#111">.</span><span style="color:#75af00">Type</span><span style="color:#111">,</span> <span style="color:#75af00">dst</span><span style="color:#111">,</span> <span style="color:#75af00">src</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">dst</span> <span style="color:#f92672">==</span> <span style="color:#75af00">src</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">writeBarrier</span><span style="color:#111">.</span><span style="color:#75af00">enabled</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">typ</span><span style="color:#111">.</span><span style="color:#75af00">Pointers</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 如果写屏障启用且类型包含指针，则需要处理写屏障。</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">bulkBarrierPreWrite</span><span style="color:#111">(</span><span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">dst</span><span style="color:#111">),</span> <span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">src</span><span style="color:#111">),</span> <span style="color:#75af00">typ</span><span style="color:#111">.</span><span style="color:#75af00">PtrBytes</span><span style="color:#111">,</span> <span style="color:#75af00">typ</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 执行内存拷贝</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">memmove</span><span style="color:#111">(</span><span style="color:#75af00">dst</span><span style="color:#111">,</span> <span style="color:#75af00">src</span><span style="color:#111">,</span> <span style="color:#75af00">typ</span><span style="color:#111">.</span><span style="color:#75af00">Size_</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">goexperiment</span><span style="color:#111">.</span><span style="color:#75af00">CgoCheck2</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">cgoCheckMemmove2</span><span style="color:#111">(</span><span style="color:#75af00">typ</span><span style="color:#111">,</span> <span style="color:#75af00">dst</span><span style="color:#111">,</span> <span style="color:#75af00">src</span><span style="color:#111">,</span> <span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#75af00">typ</span><span style="color:#111">.</span><span style="color:#75af00">Size_</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="acquiresudog--releasesudog">acquireSudog &amp; releaseSudog</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-GO" data-lang="GO"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">acquireSudog</span><span style="color:#111">()</span> <span style="color:#f92672">*</span><span style="color:#75af00">sudog</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">mp</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">acquirem</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">pp</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">mp</span><span style="color:#111">.</span><span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">ptr</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 如果 sudog 缓存为空，需要补充缓存</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">pp</span><span style="color:#111">.</span><span style="color:#75af00">sudogcache</span><span style="color:#111">)</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">lock</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">sched</span><span style="color:#111">.</span><span style="color:#75af00">sudoglock</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">for</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">pp</span><span style="color:#111">.</span><span style="color:#75af00">sudogcache</span><span style="color:#111">)</span> <span style="color:#111">&lt;</span> <span style="color:#111">cap</span><span style="color:#111">(</span><span style="color:#75af00">pp</span><span style="color:#111">.</span><span style="color:#75af00">sudogcache</span><span style="color:#111">)</span><span style="color:#f92672">/</span><span style="color:#ae81ff">2</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">sched</span><span style="color:#111">.</span><span style="color:#75af00">sudogcache</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">s</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">sched</span><span style="color:#111">.</span><span style="color:#75af00">sudogcache</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">sched</span><span style="color:#111">.</span><span style="color:#75af00">sudogcache</span> <span style="color:#111">=</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">next</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">next</span> <span style="color:#111">=</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">pp</span><span style="color:#111">.</span><span style="color:#75af00">sudogcache</span> <span style="color:#111">=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">pp</span><span style="color:#111">.</span><span style="color:#75af00">sudogcache</span><span style="color:#111">,</span> <span style="color:#75af00">s</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">unlock</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">sched</span><span style="color:#111">.</span><span style="color:#75af00">sudoglock</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">pp</span><span style="color:#111">.</span><span style="color:#75af00">sudogcache</span><span style="color:#111">)</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">pp</span><span style="color:#111">.</span><span style="color:#75af00">sudogcache</span> <span style="color:#111">=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">pp</span><span style="color:#111">.</span><span style="color:#75af00">sudogcache</span><span style="color:#111">,</span> <span style="color:#111">new</span><span style="color:#111">(</span><span style="color:#75af00">sudog</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 从 P 的缓存中取出一个 sudog</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">n</span> <span style="color:#f92672">:=</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">pp</span><span style="color:#111">.</span><span style="color:#75af00">sudogcache</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">s</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">pp</span><span style="color:#111">.</span><span style="color:#75af00">sudogcache</span><span style="color:#111">[</span><span style="color:#75af00">n</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">pp</span><span style="color:#111">.</span><span style="color:#75af00">sudogcache</span><span style="color:#111">[</span><span style="color:#75af00">n</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">pp</span><span style="color:#111">.</span><span style="color:#75af00">sudogcache</span> <span style="color:#111">=</span> <span style="color:#75af00">pp</span><span style="color:#111">.</span><span style="color:#75af00">sudogcache</span><span style="color:#111">[:</span><span style="color:#75af00">n</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">elem</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">throw</span><span style="color:#111">(</span><span style="color:#d88200">&#34;acquireSudog: found s.elem != nil in cache&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">releasem</span><span style="color:#111">(</span><span style="color:#75af00">mp</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">s</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">releaseSudog</span><span style="color:#111">(</span><span style="color:#75af00">s</span> <span style="color:#f92672">*</span><span style="color:#75af00">sudog</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ......</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75af00">gp</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">getg</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">mp</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">acquirem</span><span style="color:#111">()</span> 
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">pp</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">mp</span><span style="color:#111">.</span><span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">ptr</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">pp</span><span style="color:#111">.</span><span style="color:#75af00">sudogcache</span><span style="color:#111">)</span> <span style="color:#f92672">==</span> <span style="color:#111">cap</span><span style="color:#111">(</span><span style="color:#75af00">pp</span><span style="color:#111">.</span><span style="color:#75af00">sudogcache</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	 <span style="color:#75715e">// 如果本地缓存已满，将部分 sudog 转移到全局缓存</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">var</span> <span style="color:#75af00">first</span><span style="color:#111">,</span> <span style="color:#75af00">last</span> <span style="color:#f92672">*</span><span style="color:#75af00">sudog</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">for</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">pp</span><span style="color:#111">.</span><span style="color:#75af00">sudogcache</span><span style="color:#111">)</span> <span style="color:#111">&gt;</span> <span style="color:#111">cap</span><span style="color:#111">(</span><span style="color:#75af00">pp</span><span style="color:#111">.</span><span style="color:#75af00">sudogcache</span><span style="color:#111">)</span><span style="color:#f92672">/</span><span style="color:#ae81ff">2</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">n</span> <span style="color:#f92672">:=</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">pp</span><span style="color:#111">.</span><span style="color:#75af00">sudogcache</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">p</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">pp</span><span style="color:#111">.</span><span style="color:#75af00">sudogcache</span><span style="color:#111">[</span><span style="color:#75af00">n</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">pp</span><span style="color:#111">.</span><span style="color:#75af00">sudogcache</span><span style="color:#111">[</span><span style="color:#75af00">n</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">pp</span><span style="color:#111">.</span><span style="color:#75af00">sudogcache</span> <span style="color:#111">=</span> <span style="color:#75af00">pp</span><span style="color:#111">.</span><span style="color:#75af00">sudogcache</span><span style="color:#111">[:</span><span style="color:#75af00">n</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">first</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">first</span> <span style="color:#111">=</span> <span style="color:#75af00">p</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">last</span><span style="color:#111">.</span><span style="color:#75af00">next</span> <span style="color:#111">=</span> <span style="color:#75af00">p</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">last</span> <span style="color:#111">=</span> <span style="color:#75af00">p</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">lock</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">sched</span><span style="color:#111">.</span><span style="color:#75af00">sudoglock</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">last</span><span style="color:#111">.</span><span style="color:#75af00">next</span> <span style="color:#111">=</span> <span style="color:#75af00">sched</span><span style="color:#111">.</span><span style="color:#75af00">sudogcache</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">sched</span><span style="color:#111">.</span><span style="color:#75af00">sudogcache</span> <span style="color:#111">=</span> <span style="color:#75af00">first</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">unlock</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">sched</span><span style="color:#111">.</span><span style="color:#75af00">sudoglock</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 将 sudog 放回本地缓存</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">pp</span><span style="color:#111">.</span><span style="color:#75af00">sudogcache</span> <span style="color:#111">=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">pp</span><span style="color:#111">.</span><span style="color:#75af00">sudogcache</span><span style="color:#111">,</span> <span style="color:#75af00">s</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">releasem</span><span style="color:#111">(</span><span style="color:#75af00">mp</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="读">读</h2>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">chanrecv1</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">hchan</span><span style="color:#111">,</span> <span style="color:#75af00">elem</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">chanrecv</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">,</span> <span style="color:#75af00">elem</span><span style="color:#111">,</span> <span style="color:#00a8c8">true</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 带 ok 时 比如 `v, ok := &lt;-ch`</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">chanrecv2</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">hchan</span><span style="color:#111">,</span> <span style="color:#75af00">elem</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#75af00">received</span> <span style="color:#00a8c8">bool</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">received</span> <span style="color:#111">=</span> <span style="color:#75af00">chanrecv</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">,</span> <span style="color:#75af00">elem</span><span style="color:#111">,</span> <span style="color:#00a8c8">true</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">chanrecv</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">hchan</span><span style="color:#111">,</span> <span style="color:#75af00">ep</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">,</span> <span style="color:#75af00">block</span> <span style="color:#00a8c8">bool</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#75af00">selected</span><span style="color:#111">,</span> <span style="color:#75af00">received</span> <span style="color:#00a8c8">bool</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ......</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 非阻塞模式下检查失败条件</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">block</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">empty</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">atomic</span><span style="color:#111">.</span><span style="color:#75af00">Load</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">closed</span><span style="color:#111">)</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>      		<span style="color:#75715e">// 已经没关闭 直接返回 因为这是非阻塞模式而且 buf 为空的情况</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">empty</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">raceenabled</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">raceacquire</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">raceaddr</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">ep</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">typedmemclr</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">elemtype</span><span style="color:#111">,</span> <span style="color:#75af00">ep</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">true</span><span style="color:#111">,</span> <span style="color:#00a8c8">false</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">var</span> <span style="color:#75af00">t0</span> <span style="color:#00a8c8">int64</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">blockprofilerate</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">t0</span> <span style="color:#111">=</span> <span style="color:#75af00">cputicks</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">lock</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">lock</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">closed</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    	<span style="color:#75715e">// 通道已关闭 检查是否有数据</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">qcount</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">raceenabled</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">raceacquire</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">raceaddr</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">unlock</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">lock</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">ep</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 把数据清零 因为通道已经关闭了 </span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">typedmemclr</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">elemtype</span><span style="color:#111">,</span> <span style="color:#75af00">ep</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">true</span><span style="color:#111">,</span> <span style="color:#00a8c8">false</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 通道未关闭，检查是否有等待发送的 Goroutine</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">sg</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">sendq</span><span style="color:#111">.</span><span style="color:#75af00">dequeue</span><span style="color:#111">();</span> <span style="color:#75af00">sg</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 直接从发送队列中取出值</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">recv</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">,</span> <span style="color:#75af00">sg</span><span style="color:#111">,</span> <span style="color:#75af00">ep</span><span style="color:#111">,</span> <span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#111">{</span> <span style="color:#75af00">unlock</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">lock</span><span style="color:#111">)</span> <span style="color:#111">},</span> <span style="color:#ae81ff">3</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">true</span><span style="color:#111">,</span> <span style="color:#00a8c8">true</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  	<span style="color:#75715e">// 如果缓冲区中有数据，从缓冲区接收</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">qcount</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">qp</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">chanbuf</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">,</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">recvx</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">raceenabled</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">racenotify</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">,</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">recvx</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">ep</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>      		<span style="color:#75715e">// 直接 COPY 内存</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">typedmemmove</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">elemtype</span><span style="color:#111">,</span> <span style="color:#75af00">ep</span><span style="color:#111">,</span> <span style="color:#75af00">qp</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">typedmemclr</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">elemtype</span><span style="color:#111">,</span> <span style="color:#75af00">qp</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">recvx</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">recvx</span> <span style="color:#f92672">==</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">dataqsiz</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">recvx</span> <span style="color:#111">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">qcount</span><span style="color:#f92672">--</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">unlock</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">lock</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">true</span><span style="color:#111">,</span> <span style="color:#00a8c8">true</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  	<span style="color:#75715e">// 如果是非阻塞接收，直接返回</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">block</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">unlock</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">lock</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">false</span><span style="color:#111">,</span> <span style="color:#00a8c8">false</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 没有可用的发送方：阻塞在该通道上</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">gp</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">getg</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">mysg</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">acquireSudog</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">mysg</span><span style="color:#111">.</span><span style="color:#75af00">releasetime</span> <span style="color:#111">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">t0</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">mysg</span><span style="color:#111">.</span><span style="color:#75af00">releasetime</span> <span style="color:#111">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">mysg</span><span style="color:#111">.</span><span style="color:#75af00">elem</span> <span style="color:#111">=</span> <span style="color:#75af00">ep</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">mysg</span><span style="color:#111">.</span><span style="color:#75af00">waitlink</span> <span style="color:#111">=</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">gp</span><span style="color:#111">.</span><span style="color:#75af00">waiting</span> <span style="color:#111">=</span> <span style="color:#75af00">mysg</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">mysg</span><span style="color:#111">.</span><span style="color:#75af00">g</span> <span style="color:#111">=</span> <span style="color:#75af00">gp</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">mysg</span><span style="color:#111">.</span><span style="color:#75af00">isSelect</span> <span style="color:#111">=</span> <span style="color:#00a8c8">false</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">mysg</span><span style="color:#111">.</span><span style="color:#75af00">c</span> <span style="color:#111">=</span> <span style="color:#75af00">c</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">gp</span><span style="color:#111">.</span><span style="color:#75af00">param</span> <span style="color:#111">=</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">recvq</span><span style="color:#111">.</span><span style="color:#75af00">enqueue</span><span style="color:#111">(</span><span style="color:#75af00">mysg</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">timer</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">blockTimerChan</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">gp</span><span style="color:#111">.</span><span style="color:#75af00">parkingOnChan</span><span style="color:#111">.</span><span style="color:#75af00">Store</span><span style="color:#111">(</span><span style="color:#00a8c8">true</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">gopark</span><span style="color:#111">(</span><span style="color:#75af00">chanparkcommit</span><span style="color:#111">,</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">lock</span><span style="color:#111">),</span> <span style="color:#75af00">waitReasonChanReceive</span><span style="color:#111">,</span> <span style="color:#75af00">traceBlockChanRecv</span><span style="color:#111">,</span> <span style="color:#ae81ff">2</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// someone woke us up</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">mysg</span> <span style="color:#f92672">!=</span> <span style="color:#75af00">gp</span><span style="color:#111">.</span><span style="color:#75af00">waiting</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">throw</span><span style="color:#111">(</span><span style="color:#d88200">&#34;G waiting list is corrupted&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">timer</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">unblockTimerChan</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">gp</span><span style="color:#111">.</span><span style="color:#75af00">waiting</span> <span style="color:#111">=</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">gp</span><span style="color:#111">.</span><span style="color:#75af00">activeStackChans</span> <span style="color:#111">=</span> <span style="color:#00a8c8">false</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">mysg</span><span style="color:#111">.</span><span style="color:#75af00">releasetime</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">blockevent</span><span style="color:#111">(</span><span style="color:#75af00">mysg</span><span style="color:#111">.</span><span style="color:#75af00">releasetime</span><span style="color:#f92672">-</span><span style="color:#75af00">t0</span><span style="color:#111">,</span> <span style="color:#ae81ff">2</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">success</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">mysg</span><span style="color:#111">.</span><span style="color:#75af00">success</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">gp</span><span style="color:#111">.</span><span style="color:#75af00">param</span> <span style="color:#111">=</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">mysg</span><span style="color:#111">.</span><span style="color:#75af00">c</span> <span style="color:#111">=</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">releaseSudog</span><span style="color:#111">(</span><span style="color:#75af00">mysg</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">true</span><span style="color:#111">,</span> <span style="color:#75af00">success</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>所以读数据（阻塞读）的逻辑为:</p>
<ol>
<li>检查 channel 是否已经关闭 如果关闭了 而且没有数据了 直接返回</li>
<li>如果有等待发送的 Goroutine （c.sendq 里面有值），如果无缓冲chan 直接从goroutine中取值 负责从 buf 取出值 并把数据加入末尾</li>
<li>如果缓冲区中有数据，从缓冲区接收</li>
<li>如果缓冲区没有数据了 挂起 goroutine 并加入 recvq 等待接收者</li>
</ol>
<p><img src="/images/go_channel_read.png" alt=""></p>
<h3 id="recv">recv</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">recv</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">hchan</span><span style="color:#111">,</span> <span style="color:#75af00">sg</span> <span style="color:#f92672">*</span><span style="color:#75af00">sudog</span><span style="color:#111">,</span> <span style="color:#75af00">ep</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">,</span> <span style="color:#75af00">unlockf</span> <span style="color:#00a8c8">func</span><span style="color:#111">(),</span> <span style="color:#75af00">skip</span> <span style="color:#00a8c8">int</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">dataqsiz</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">ep</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 如果是无缓冲通道，直接 Copy 数据</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">recvDirect</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">elemtype</span><span style="color:#111">,</span> <span style="color:#75af00">sg</span><span style="color:#111">,</span> <span style="color:#75af00">ep</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 否则，通道是有缓冲通道。</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 从队列的头部获取数据，同时通知发送方将其数据放到尾部</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">qp</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">chanbuf</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">,</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">recvx</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 从队列复制数据到接收方</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">ep</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">typedmemmove</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">elemtype</span><span style="color:#111">,</span> <span style="color:#75af00">ep</span><span style="color:#111">,</span> <span style="color:#75af00">qp</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 将发送者的数据复制到队列中</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">typedmemmove</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">elemtype</span><span style="color:#111">,</span> <span style="color:#75af00">qp</span><span style="color:#111">,</span> <span style="color:#75af00">sg</span><span style="color:#111">.</span><span style="color:#75af00">elem</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">recvx</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">recvx</span> <span style="color:#f92672">==</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">dataqsiz</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">recvx</span> <span style="color:#111">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">sendx</span> <span style="color:#111">=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">recvx</span> <span style="color:#75715e">// c.sendx = (c.sendx+1) % c.dataqsiz</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">sg</span><span style="color:#111">.</span><span style="color:#75af00">elem</span> <span style="color:#111">=</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">gp</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">sg</span><span style="color:#111">.</span><span style="color:#75af00">g</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">unlockf</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">gp</span><span style="color:#111">.</span><span style="color:#75af00">param</span> <span style="color:#111">=</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">(</span><span style="color:#75af00">sg</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">sg</span><span style="color:#111">.</span><span style="color:#75af00">success</span> <span style="color:#111">=</span> <span style="color:#00a8c8">true</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">sg</span><span style="color:#111">.</span><span style="color:#75af00">releasetime</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">sg</span><span style="color:#111">.</span><span style="color:#75af00">releasetime</span> <span style="color:#111">=</span> <span style="color:#75af00">cputicks</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">goready</span><span style="color:#111">(</span><span style="color:#75af00">gp</span><span style="color:#111">,</span> <span style="color:#75af00">skip</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="关闭">关闭</h2>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">closechan</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">hchan</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 空值检查</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">c</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#75af00">plainError</span><span style="color:#111">(</span><span style="color:#d88200">&#34;close of nil channel&#34;</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">lock</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">lock</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 如果已经关闭了 报错 不能关闭已经关闭的 channel</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">closed</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">unlock</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">lock</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#75af00">plainError</span><span style="color:#111">(</span><span style="color:#d88200">&#34;close of closed channel&#34;</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">raceenabled</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">callerpc</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">getcallerpc</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">racewritepc</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">raceaddr</span><span style="color:#111">(),</span> <span style="color:#75af00">callerpc</span><span style="color:#111">,</span> <span style="color:#75af00">abi</span><span style="color:#111">.</span><span style="color:#75af00">FuncPCABIInternal</span><span style="color:#111">(</span><span style="color:#75af00">closechan</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">racerelease</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">raceaddr</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 设置状态</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">closed</span> <span style="color:#111">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#75715e">// 创建一个 G 列表，用于保存需要唤醒的 Goroutine</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">var</span> <span style="color:#75af00">glist</span> <span style="color:#75af00">gList</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 释放所有的读方</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">sg</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">recvq</span><span style="color:#111">.</span><span style="color:#75af00">dequeue</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">sg</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">break</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">sg</span><span style="color:#111">.</span><span style="color:#75af00">elem</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">typedmemclr</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">elemtype</span><span style="color:#111">,</span> <span style="color:#75af00">sg</span><span style="color:#111">.</span><span style="color:#75af00">elem</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">sg</span><span style="color:#111">.</span><span style="color:#75af00">elem</span> <span style="color:#111">=</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">sg</span><span style="color:#111">.</span><span style="color:#75af00">releasetime</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">sg</span><span style="color:#111">.</span><span style="color:#75af00">releasetime</span> <span style="color:#111">=</span> <span style="color:#75af00">cputicks</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">gp</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">sg</span><span style="color:#111">.</span><span style="color:#75af00">g</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">gp</span><span style="color:#111">.</span><span style="color:#75af00">param</span> <span style="color:#111">=</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">(</span><span style="color:#75af00">sg</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">sg</span><span style="color:#111">.</span><span style="color:#75af00">success</span> <span style="color:#111">=</span> <span style="color:#00a8c8">false</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">raceenabled</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">raceacquireg</span><span style="color:#111">(</span><span style="color:#75af00">gp</span><span style="color:#111">,</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">raceaddr</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">glist</span><span style="color:#111">.</span><span style="color:#75af00">push</span><span style="color:#111">(</span><span style="color:#75af00">gp</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 释放所有的写方 会 panic 因为向已经关闭的 channel 写数据是不允许的</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">sg</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">sendq</span><span style="color:#111">.</span><span style="color:#75af00">dequeue</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">sg</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">break</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">sg</span><span style="color:#111">.</span><span style="color:#75af00">elem</span> <span style="color:#111">=</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">sg</span><span style="color:#111">.</span><span style="color:#75af00">releasetime</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">sg</span><span style="color:#111">.</span><span style="color:#75af00">releasetime</span> <span style="color:#111">=</span> <span style="color:#75af00">cputicks</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">gp</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">sg</span><span style="color:#111">.</span><span style="color:#75af00">g</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">gp</span><span style="color:#111">.</span><span style="color:#75af00">param</span> <span style="color:#111">=</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">(</span><span style="color:#75af00">sg</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">sg</span><span style="color:#111">.</span><span style="color:#75af00">success</span> <span style="color:#111">=</span> <span style="color:#00a8c8">false</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">raceenabled</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">raceacquireg</span><span style="color:#111">(</span><span style="color:#75af00">gp</span><span style="color:#111">,</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">raceaddr</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">glist</span><span style="color:#111">.</span><span style="color:#75af00">push</span><span style="color:#111">(</span><span style="color:#75af00">gp</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">unlock</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">lock</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 唤醒所有的 Goroutine</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#111">!</span><span style="color:#75af00">glist</span><span style="color:#111">.</span><span style="color:#75af00">empty</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">gp</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">glist</span><span style="color:#111">.</span><span style="color:#75af00">pop</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">gp</span><span style="color:#111">.</span><span style="color:#75af00">schedlink</span> <span style="color:#111">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">goready</span><span style="color:#111">(</span><span style="color:#75af00">gp</span><span style="color:#111">,</span> <span style="color:#ae81ff">3</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="非阻塞读写">非阻塞读写</h2>
<p>非阻塞的方式一般用在 <code>select</code> 中。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">selectnbsend</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">hchan</span><span style="color:#111">,</span> <span style="color:#75af00">elem</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#75af00">selected</span> <span style="color:#00a8c8">bool</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">chansend</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">,</span> <span style="color:#75af00">elem</span><span style="color:#111">,</span> <span style="color:#00a8c8">false</span><span style="color:#111">,</span> <span style="color:#75af00">getcallerpc</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">selectnbrecv</span><span style="color:#111">(</span><span style="color:#75af00">elem</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">,</span> <span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">hchan</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#75af00">selected</span><span style="color:#111">,</span> <span style="color:#75af00">received</span> <span style="color:#00a8c8">bool</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">chanrecv</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">,</span> <span style="color:#75af00">elem</span><span style="color:#111">,</span> <span style="color:#00a8c8">false</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><ul>
<li>在阻塞下，需要当前 goroutine 挂起时，非阻塞则不需要，直接返回 flase。</li>
<li>如果能直接读数据，则返回 true。</li>
</ul>
<h2 id="select">select</h2>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">walkSelectCases</span><span style="color:#111">(</span><span style="color:#75af00">cases</span> <span style="color:#111">[]</span><span style="color:#f92672">*</span><span style="color:#75af00">ir</span><span style="color:#111">.</span><span style="color:#75af00">CommClause</span><span style="color:#111">)</span> <span style="color:#111">[]</span><span style="color:#75af00">ir</span><span style="color:#111">.</span><span style="color:#75af00">Node</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ......</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">switch</span> <span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">Op</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">default</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">base</span><span style="color:#111">.</span><span style="color:#75af00">Fatalf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;select %v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">Op</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">case</span> <span style="color:#75af00">ir</span><span style="color:#111">.</span><span style="color:#75af00">OSEND</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// if selectnbsend(c, v) { body } else { default body }</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">n</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">n</span><span style="color:#111">.(</span><span style="color:#f92672">*</span><span style="color:#75af00">ir</span><span style="color:#111">.</span><span style="color:#75af00">SendStmt</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">ch</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">Chan</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">cond</span> <span style="color:#111">=</span> <span style="color:#75af00">mkcall1</span><span style="color:#111">(</span><span style="color:#75af00">chanfn</span><span style="color:#111">(</span><span style="color:#d88200">&#34;selectnbsend&#34;</span><span style="color:#111">,</span> <span style="color:#ae81ff">2</span><span style="color:#111">,</span> <span style="color:#75af00">ch</span><span style="color:#111">.</span><span style="color:#75af00">Type</span><span style="color:#111">()),</span> <span style="color:#75af00">types</span><span style="color:#111">.</span><span style="color:#75af00">Types</span><span style="color:#111">[</span><span style="color:#75af00">types</span><span style="color:#111">.</span><span style="color:#75af00">TBOOL</span><span style="color:#111">],</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">PtrInit</span><span style="color:#111">(),</span> <span style="color:#75af00">ch</span><span style="color:#111">,</span> <span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">Value</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">case</span> <span style="color:#75af00">ir</span><span style="color:#111">.</span><span style="color:#75af00">OSELRECV2</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">n</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">n</span><span style="color:#111">.(</span><span style="color:#f92672">*</span><span style="color:#75af00">ir</span><span style="color:#111">.</span><span style="color:#75af00">AssignListStmt</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">recv</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">Rhs</span><span style="color:#111">[</span><span style="color:#ae81ff">0</span><span style="color:#111">].(</span><span style="color:#f92672">*</span><span style="color:#75af00">ir</span><span style="color:#111">.</span><span style="color:#75af00">UnaryExpr</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">ch</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">recv</span><span style="color:#111">.</span><span style="color:#75af00">X</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">elem</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">Lhs</span><span style="color:#111">[</span><span style="color:#ae81ff">0</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">ir</span><span style="color:#111">.</span><span style="color:#75af00">IsBlank</span><span style="color:#111">(</span><span style="color:#75af00">elem</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">elem</span> <span style="color:#111">=</span> <span style="color:#75af00">typecheck</span><span style="color:#111">.</span><span style="color:#75af00">NodNil</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">cond</span> <span style="color:#111">=</span> <span style="color:#75af00">typecheck</span><span style="color:#111">.</span><span style="color:#75af00">TempAt</span><span style="color:#111">(</span><span style="color:#75af00">base</span><span style="color:#111">.</span><span style="color:#75af00">Pos</span><span style="color:#111">,</span> <span style="color:#75af00">ir</span><span style="color:#111">.</span><span style="color:#75af00">CurFunc</span><span style="color:#111">,</span> <span style="color:#75af00">types</span><span style="color:#111">.</span><span style="color:#75af00">Types</span><span style="color:#111">[</span><span style="color:#75af00">types</span><span style="color:#111">.</span><span style="color:#75af00">TBOOL</span><span style="color:#111">])</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fn</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">chanfn</span><span style="color:#111">(</span><span style="color:#d88200">&#34;selectnbrecv&#34;</span><span style="color:#111">,</span> <span style="color:#ae81ff">2</span><span style="color:#111">,</span> <span style="color:#75af00">ch</span><span style="color:#111">.</span><span style="color:#75af00">Type</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">call</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">mkcall1</span><span style="color:#111">(</span><span style="color:#75af00">fn</span><span style="color:#111">,</span> <span style="color:#75af00">fn</span><span style="color:#111">.</span><span style="color:#75af00">Type</span><span style="color:#111">().</span><span style="color:#75af00">ResultsTuple</span><span style="color:#111">(),</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">PtrInit</span><span style="color:#111">(),</span> <span style="color:#75af00">elem</span><span style="color:#111">,</span> <span style="color:#75af00">ch</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">as</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">ir</span><span style="color:#111">.</span><span style="color:#75af00">NewAssignListStmt</span><span style="color:#111">(</span><span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">Pos</span><span style="color:#111">(),</span> <span style="color:#75af00">ir</span><span style="color:#111">.</span><span style="color:#75af00">OAS2</span><span style="color:#111">,</span> <span style="color:#111">[]</span><span style="color:#75af00">ir</span><span style="color:#111">.</span><span style="color:#75af00">Node</span><span style="color:#111">{</span><span style="color:#75af00">cond</span><span style="color:#111">,</span> <span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">Lhs</span><span style="color:#111">[</span><span style="color:#ae81ff">1</span><span style="color:#111">]},</span> <span style="color:#111">[]</span><span style="color:#75af00">ir</span><span style="color:#111">.</span><span style="color:#75af00">Node</span><span style="color:#111">{</span><span style="color:#75af00">call</span><span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">PtrInit</span><span style="color:#111">().</span><span style="color:#75af00">Append</span><span style="color:#111">(</span><span style="color:#75af00">typecheck</span><span style="color:#111">.</span><span style="color:#75af00">Stmt</span><span style="color:#111">(</span><span style="color:#75af00">as</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ......</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">selectnbsend</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">hchan</span><span style="color:#111">,</span> <span style="color:#75af00">elem</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#75af00">selected</span> <span style="color:#00a8c8">bool</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">chansend</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">,</span> <span style="color:#75af00">elem</span><span style="color:#111">,</span> <span style="color:#00a8c8">false</span><span style="color:#111">,</span> <span style="color:#75af00">getcallerpc</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">selectnbrecv</span><span style="color:#111">(</span><span style="color:#75af00">elem</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">,</span> <span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">hchan</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#75af00">selected</span><span style="color:#111">,</span> <span style="color:#75af00">received</span> <span style="color:#00a8c8">bool</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">chanrecv</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">,</span> <span style="color:#75af00">elem</span><span style="color:#111">,</span> <span style="color:#00a8c8">false</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>改写后就是调用 <code>selectnbsend</code> 非阻塞的从 channel 发送数据，如果成功则返回 true，否则返回 false。失败了就从下个 case 继续执行。</p>]]></content:encoded><category>go</category><category>go</category></item><item><title>Go 垃圾回收原理</title><link>https://daemon365.dev/post/go/go_gc_code/</link><pubDate>Tue, 17 Dec 2024 11:06:10 +0800</pubDate><guid>https://daemon365.dev/post/go/go_gc_code/</guid><description>&lt;p&gt;*** Go 代码基于 v1.23.0 ***&lt;/p&gt;
&lt;h2 id="介绍"&gt;介绍&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="https://daemon365.dev/post/go/golang_gc_garbage_collection_mechanism/"&gt;golang GC 垃圾回收机制&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="触发条件"&gt;触发条件&lt;/h2&gt;
&lt;ol&gt;
&lt;li&gt;用户调用 &lt;code&gt;runtime.GC&lt;/code&gt; 主动触发&lt;/li&gt;
&lt;li&gt;Go 程序检测到距上次 GC 内存分配增长超过一定比例时（默认 100%）触发&lt;/li&gt;
&lt;li&gt;定时触发 （默认 2 min）&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id="定时触发"&gt;定时触发&lt;/h2&gt;
&lt;p&gt;代码在 &lt;code&gt;src/runtime/proc.go&lt;/code&gt; 中&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;init&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;go&lt;/span&gt; &lt;span style="color:#75af00"&gt;forcegchelper&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;forcegchelper&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;forcegc&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;g&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#75af00"&gt;getg&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;lockInit&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#f92672"&gt;&amp;amp;&lt;/span&gt;&lt;span style="color:#75af00"&gt;forcegc&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;lock&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;lockRankForcegc&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;for&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;lock&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#f92672"&gt;&amp;amp;&lt;/span&gt;&lt;span style="color:#75af00"&gt;forcegc&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;lock&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;forcegc&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;idle&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Load&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;throw&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;forcegc: phase error&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;forcegc&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;idle&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Store&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;true&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// 阻塞住 goroutine 当有人解开时 开启 gc&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;goparkunlock&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#f92672"&gt;&amp;amp;&lt;/span&gt;&lt;span style="color:#75af00"&gt;forcegc&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;lock&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;waitReasonForceGCIdle&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;traceBlockSystemGoroutine&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;1&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// this goroutine is explicitly resumed by sysmon&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;debug&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;gctrace&lt;/span&gt; &lt;span style="color:#111"&gt;&amp;gt;&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;0&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;GC forced&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// goroutine 被唤醒了，调用 gcStart 开启 gc&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;gcStart&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;gcTrigger&lt;/span&gt;&lt;span style="color:#111"&gt;{&lt;/span&gt;&lt;span style="color:#75af00"&gt;kind&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#75af00"&gt;gcTriggerTime&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;now&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#75af00"&gt;nanotime&lt;/span&gt;&lt;span style="color:#111"&gt;()})&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;那么唤醒 goroutine 的逻辑代码在哪里呢？在 &lt;code&gt;sysmon&lt;/code&gt; 物理线程中&lt;/p&gt;</description><content:encoded><![CDATA[<p>*** Go 代码基于 v1.23.0 ***</p>
<h2 id="介绍">介绍</h2>
<ul>
<li><a href="https://daemon365.dev/post/go/golang_gc_garbage_collection_mechanism/">golang GC 垃圾回收机制</a></li>
</ul>
<h2 id="触发条件">触发条件</h2>
<ol>
<li>用户调用 <code>runtime.GC</code> 主动触发</li>
<li>Go 程序检测到距上次 GC 内存分配增长超过一定比例时（默认 100%）触发</li>
<li>定时触发 （默认 2 min）</li>
</ol>
<h2 id="定时触发">定时触发</h2>
<p>代码在 <code>src/runtime/proc.go</code> 中</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">init</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">go</span> <span style="color:#75af00">forcegchelper</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">forcegchelper</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">forcegc</span><span style="color:#111">.</span><span style="color:#75af00">g</span> <span style="color:#111">=</span> <span style="color:#75af00">getg</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">lockInit</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">forcegc</span><span style="color:#111">.</span><span style="color:#75af00">lock</span><span style="color:#111">,</span> <span style="color:#75af00">lockRankForcegc</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">lock</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">forcegc</span><span style="color:#111">.</span><span style="color:#75af00">lock</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">forcegc</span><span style="color:#111">.</span><span style="color:#75af00">idle</span><span style="color:#111">.</span><span style="color:#75af00">Load</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">throw</span><span style="color:#111">(</span><span style="color:#d88200">&#34;forcegc: phase error&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">forcegc</span><span style="color:#111">.</span><span style="color:#75af00">idle</span><span style="color:#111">.</span><span style="color:#75af00">Store</span><span style="color:#111">(</span><span style="color:#00a8c8">true</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 阻塞住 goroutine 当有人解开时 开启 gc</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">goparkunlock</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">forcegc</span><span style="color:#111">.</span><span style="color:#75af00">lock</span><span style="color:#111">,</span> <span style="color:#75af00">waitReasonForceGCIdle</span><span style="color:#111">,</span> <span style="color:#75af00">traceBlockSystemGoroutine</span><span style="color:#111">,</span> <span style="color:#ae81ff">1</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// this goroutine is explicitly resumed by sysmon</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">debug</span><span style="color:#111">.</span><span style="color:#75af00">gctrace</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;GC forced&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// goroutine 被唤醒了，调用 gcStart 开启 gc</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">gcStart</span><span style="color:#111">(</span><span style="color:#75af00">gcTrigger</span><span style="color:#111">{</span><span style="color:#75af00">kind</span><span style="color:#111">:</span> <span style="color:#75af00">gcTriggerTime</span><span style="color:#111">,</span> <span style="color:#75af00">now</span><span style="color:#111">:</span> <span style="color:#75af00">nanotime</span><span style="color:#111">()})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>那么唤醒 goroutine 的逻辑代码在哪里呢？在 <code>sysmon</code> 物理线程中</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">sysmon</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ......</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">for</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// ......</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 使用 test 方法判断是否需要触发 gc</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#75af00">t</span> <span style="color:#f92672">:=</span> <span style="color:#111">(</span><span style="color:#75af00">gcTrigger</span><span style="color:#111">{</span><span style="color:#75af00">kind</span><span style="color:#111">:</span> <span style="color:#75af00">gcTriggerTime</span><span style="color:#111">,</span> <span style="color:#75af00">now</span><span style="color:#111">:</span> <span style="color:#75af00">now</span><span style="color:#111">});</span> <span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">test</span><span style="color:#111">()</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">forcegc</span><span style="color:#111">.</span><span style="color:#75af00">idle</span><span style="color:#111">.</span><span style="color:#75af00">Load</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">lock</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">forcegc</span><span style="color:#111">.</span><span style="color:#75af00">lock</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">forcegc</span><span style="color:#111">.</span><span style="color:#75af00">idle</span><span style="color:#111">.</span><span style="color:#75af00">Store</span><span style="color:#111">(</span><span style="color:#00a8c8">false</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 需要 gc 时，把 g 放入 list 中 并使用 injectglist 执行唤醒操作</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">var</span> <span style="color:#75af00">list</span> <span style="color:#75af00">gList</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">list</span><span style="color:#111">.</span><span style="color:#75af00">push</span><span style="color:#111">(</span><span style="color:#75af00">forcegc</span><span style="color:#111">.</span><span style="color:#75af00">g</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">injectglist</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">list</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">unlock</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">forcegc</span><span style="color:#111">.</span><span style="color:#75af00">lock</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// ......</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">injectglist</span><span style="color:#111">(</span><span style="color:#75af00">glist</span> <span style="color:#f92672">*</span><span style="color:#75af00">gList</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ......</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 启动指定数量的空闲M</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">startIdle</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">n</span> <span style="color:#00a8c8">int</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">for</span> <span style="color:#75af00">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span><span style="color:#111">;</span> <span style="color:#75af00">i</span> <span style="color:#111">&lt;</span> <span style="color:#75af00">n</span><span style="color:#111">;</span> <span style="color:#75af00">i</span><span style="color:#f92672">++</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">mp</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">acquirem</span><span style="color:#111">()</span> <span style="color:#75715e">// See comment in startm.</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">lock</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">sched</span><span style="color:#111">.</span><span style="color:#75af00">lock</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">pp</span><span style="color:#111">,</span> <span style="color:#75af00">_</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">pidlegetSpinning</span><span style="color:#111">(</span><span style="color:#ae81ff">0</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">pp</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">unlock</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">sched</span><span style="color:#111">.</span><span style="color:#75af00">lock</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">releasem</span><span style="color:#111">(</span><span style="color:#75af00">mp</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">break</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">startm</span><span style="color:#111">(</span><span style="color:#75af00">pp</span><span style="color:#111">,</span> <span style="color:#00a8c8">false</span><span style="color:#111">,</span> <span style="color:#00a8c8">true</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">unlock</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">sched</span><span style="color:#111">.</span><span style="color:#75af00">lock</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">releasem</span><span style="color:#111">(</span><span style="color:#75af00">mp</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">pp</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">getg</span><span style="color:#111">().</span><span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">ptr</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">pp</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 没有 P 的情况下，直接把 glist 放入全局队列 并启动一些空闲M</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">lock</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">sched</span><span style="color:#111">.</span><span style="color:#75af00">lock</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">globrunqputbatch</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">q</span><span style="color:#111">,</span> <span style="color:#111">int32</span><span style="color:#111">(</span><span style="color:#75af00">qsize</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">unlock</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">sched</span><span style="color:#111">.</span><span style="color:#75af00">lock</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">startIdle</span><span style="color:#111">(</span><span style="color:#75af00">qsize</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 逐个将G放入全局队列，并启动相应的M</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">npidle</span> <span style="color:#f92672">:=</span> <span style="color:#111">int</span><span style="color:#111">(</span><span style="color:#75af00">sched</span><span style="color:#111">.</span><span style="color:#75af00">npidle</span><span style="color:#111">.</span><span style="color:#75af00">Load</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">var</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">globq</span> <span style="color:#75af00">gQueue</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">n</span>     <span style="color:#00a8c8">int</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">n</span> <span style="color:#111">=</span> <span style="color:#ae81ff">0</span><span style="color:#111">;</span> <span style="color:#75af00">n</span> <span style="color:#111">&lt;</span> <span style="color:#75af00">npidle</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#111">!</span><span style="color:#75af00">q</span><span style="color:#111">.</span><span style="color:#75af00">empty</span><span style="color:#111">();</span> <span style="color:#75af00">n</span><span style="color:#f92672">++</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">g</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">q</span><span style="color:#111">.</span><span style="color:#75af00">pop</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">globq</span><span style="color:#111">.</span><span style="color:#75af00">pushBack</span><span style="color:#111">(</span><span style="color:#75af00">g</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">n</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">lock</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">sched</span><span style="color:#111">.</span><span style="color:#75af00">lock</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">globrunqputbatch</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">globq</span><span style="color:#111">,</span> <span style="color:#111">int32</span><span style="color:#111">(</span><span style="color:#75af00">n</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">unlock</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">sched</span><span style="color:#111">.</span><span style="color:#75af00">lock</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">startIdle</span><span style="color:#111">(</span><span style="color:#75af00">n</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">qsize</span> <span style="color:#f92672">-=</span> <span style="color:#75af00">n</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 将剩余的G放入当前P的本地队列。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">q</span><span style="color:#111">.</span><span style="color:#75af00">empty</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">runqputbatch</span><span style="color:#111">(</span><span style="color:#75af00">pp</span><span style="color:#111">,</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">q</span><span style="color:#111">,</span> <span style="color:#75af00">qsize</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 唤醒一个P，以防在添加G到队列后有P变为空闲状态。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">wakep</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="test">test</h3>
<ul>
<li>根据 gcTrigger 的类型检测是否应该触发垃圾收集。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">gcTrigger</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">kind</span> <span style="color:#75af00">gcTriggerKind</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">now</span>  <span style="color:#00a8c8">int64</span>  <span style="color:#75715e">// gcTriggerTime: current time</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">n</span>    <span style="color:#00a8c8">uint32</span> <span style="color:#75715e">// gcTriggerCycle: cycle number to start</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">gcTriggerKind</span> <span style="color:#00a8c8">int</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">const</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">gcTriggerHeap</span> <span style="color:#75af00">gcTriggerKind</span> <span style="color:#111">=</span> <span style="color:#00a8c8">iota</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">gcTriggerTime</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">gcTriggerCycle</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">t</span> <span style="color:#75af00">gcTrigger</span><span style="color:#111">)</span> <span style="color:#75af00">test</span><span style="color:#111">()</span> <span style="color:#00a8c8">bool</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 检查是否禁用了 GC，程序是否处于 panic 状态，或 GC 阶段是否不是关闭状态。 </span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">memstats</span><span style="color:#111">.</span><span style="color:#75af00">enablegc</span> <span style="color:#f92672">||</span> <span style="color:#75af00">panicking</span><span style="color:#111">.</span><span style="color:#75af00">Load</span><span style="color:#111">()</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">||</span> <span style="color:#75af00">gcphase</span> <span style="color:#f92672">!=</span> <span style="color:#75af00">_GCoff</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">false</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">switch</span> <span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">kind</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">case</span> <span style="color:#75af00">gcTriggerHeap</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// heap 内存的方式触发</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">trigger</span><span style="color:#111">,</span> <span style="color:#75af00">_</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">gcController</span><span style="color:#111">.</span><span style="color:#75af00">trigger</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">gcController</span><span style="color:#111">.</span><span style="color:#75af00">heapLive</span><span style="color:#111">.</span><span style="color:#75af00">Load</span><span style="color:#111">()</span> <span style="color:#f92672">&gt;=</span> <span style="color:#75af00">trigger</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">case</span> <span style="color:#75af00">gcTriggerTime</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 定时触发</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">gcController</span><span style="color:#111">.</span><span style="color:#75af00">gcPercent</span><span style="color:#111">.</span><span style="color:#75af00">Load</span><span style="color:#111">()</span> <span style="color:#111">&lt;</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">false</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 如果现在的时间减去上次 gc 的时间大于 forcegcperiod （2min） 就触发</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">lastgc</span> <span style="color:#f92672">:=</span> <span style="color:#111">int64</span><span style="color:#111">(</span><span style="color:#75af00">atomic</span><span style="color:#111">.</span><span style="color:#75af00">Load64</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">memstats</span><span style="color:#111">.</span><span style="color:#75af00">last_gc_nanotime</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">lastgc</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">now</span><span style="color:#f92672">-</span><span style="color:#75af00">lastgc</span> <span style="color:#111">&gt;</span> <span style="color:#75af00">forcegcperiod</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">case</span> <span style="color:#75af00">gcTriggerCycle</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 上次是否执行完毕</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#111">int32</span><span style="color:#111">(</span><span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">n</span><span style="color:#f92672">-</span><span style="color:#75af00">work</span><span style="color:#111">.</span><span style="color:#75af00">cycles</span><span style="color:#111">.</span><span style="color:#75af00">Load</span><span style="color:#111">())</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">true</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="heap-增长触发">Heap 增长触发</h2>
<p><code>mallocgc</code> 不但 malloc 了内存，还会检查是否需要触发 gc</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">mallocgc</span><span style="color:#111">(</span><span style="color:#75af00">size</span> <span style="color:#00a8c8">uintptr</span><span style="color:#111">,</span> <span style="color:#75af00">typ</span> <span style="color:#f92672">*</span><span style="color:#75af00">_type</span><span style="color:#111">,</span> <span style="color:#75af00">needzero</span> <span style="color:#00a8c8">bool</span><span style="color:#111">)</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">assistG</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">deductAssistCredit</span><span style="color:#111">(</span><span style="color:#75af00">size</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">shouldhelpgc</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ......</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">size</span> <span style="color:#f92672">&lt;=</span> <span style="color:#75af00">maxSmallSize</span><span style="color:#f92672">-</span><span style="color:#75af00">mallocHeaderSize</span>  <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// ......</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 如果 mcache 中满了 要向上申请了 shouldhelpgc = true 后续判断</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">v</span><span style="color:#111">,</span> <span style="color:#75af00">span</span><span style="color:#111">,</span> <span style="color:#75af00">shouldhelpgc</span> <span style="color:#111">=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">nextFree</span><span style="color:#111">(</span><span style="color:#75af00">tinySpanClass</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// ......</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 大于 32k </span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">shouldhelpgc</span> <span style="color:#111">=</span> <span style="color:#00a8c8">true</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// ......</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 如果开启了 GC 新对象都标黑</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">gcphase</span> <span style="color:#f92672">!=</span> <span style="color:#75af00">_GCoff</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">gcmarknewobject</span><span style="color:#111">(</span><span style="color:#75af00">span</span><span style="color:#111">,</span> <span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">x</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// test() 看下需不需要 gc</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">shouldhelpgc</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">t</span> <span style="color:#f92672">:=</span> <span style="color:#111">(</span><span style="color:#75af00">gcTrigger</span><span style="color:#111">{</span><span style="color:#75af00">kind</span><span style="color:#111">:</span> <span style="color:#75af00">gcTriggerHeap</span><span style="color:#111">});</span> <span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">test</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">gcStart</span><span style="color:#111">(</span><span style="color:#75af00">t</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">gcmarknewobject</span><span style="color:#111">(</span><span style="color:#75af00">span</span> <span style="color:#f92672">*</span><span style="color:#75af00">mspan</span><span style="color:#111">,</span> <span style="color:#75af00">obj</span> <span style="color:#00a8c8">uintptr</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">span</span><span style="color:#111">.</span><span style="color:#75af00">markBitsForIndex</span><span style="color:#111">(</span><span style="color:#75af00">objIndex</span><span style="color:#111">).</span><span style="color:#75af00">setMarked</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="主动触发">主动触发</h2>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">GC</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ......</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">gcStart</span><span style="color:#111">(</span><span style="color:#75af00">gcTrigger</span><span style="color:#111">{</span><span style="color:#75af00">kind</span><span style="color:#111">:</span> <span style="color:#75af00">gcTriggerCycle</span><span style="color:#111">,</span> <span style="color:#75af00">n</span><span style="color:#111">:</span> <span style="color:#75af00">n</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span><span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ......</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="gcstart">gcStart</h2>
<p>gcStart 为 gc 的标记主流程</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">gcStart</span><span style="color:#111">(</span><span style="color:#75af00">trigger</span> <span style="color:#75af00">gcTrigger</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ......</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 再次检查一下是不是能 GC 如果上次没清扫完，给清扫完</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">trigger</span><span style="color:#111">.</span><span style="color:#75af00">test</span><span style="color:#111">()</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">sweepone</span><span style="color:#111">()</span> <span style="color:#f92672">!=</span> <span style="color:#111">^</span><span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#ae81ff">0</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 上锁</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">semacquire</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">work</span><span style="color:#111">.</span><span style="color:#75af00">startSema</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 加锁了 再次检查一下</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">trigger</span><span style="color:#111">.</span><span style="color:#75af00">test</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">semrelease</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">work</span><span style="color:#111">.</span><span style="color:#75af00">startSema</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ......</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 启动 GC 标记工作线程。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">gcBgMarkStartWorkers</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 重置标记</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">systemstack</span><span style="color:#111">(</span><span style="color:#75af00">gcResetMarkState</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ......</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Stop The World</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">systemstack</span><span style="color:#111">(</span><span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">stw</span> <span style="color:#111">=</span> <span style="color:#75af00">stopTheWorldWithSema</span><span style="color:#111">(</span><span style="color:#75af00">stwGCSweepTerm</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 在开始并发扫描之前完成清扫 </span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">systemstack</span><span style="color:#111">(</span><span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">finishsweep_m</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ......</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 使用多少个核心 GC</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">gcController</span><span style="color:#111">.</span><span style="color:#75af00">startCycle</span><span style="color:#111">(</span><span style="color:#75af00">now</span><span style="color:#111">,</span> <span style="color:#111">int</span><span style="color:#111">(</span><span style="color:#75af00">gomaxprocs</span><span style="color:#111">),</span> <span style="color:#75af00">trigger</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ......</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 进入并发标记阶段并启用写屏障。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">setGCPhase</span><span style="color:#111">(</span><span style="color:#75af00">_GCmark</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 标记所有活跃的 tinyalloc 块。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">gcMarkTinyAllocs</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 开始标记</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">systemstack</span><span style="color:#111">(</span><span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// start the world </span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">now</span> <span style="color:#111">=</span> <span style="color:#75af00">startTheWorldWithSema</span><span style="color:#111">(</span><span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#75af00">stw</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">work</span><span style="color:#111">.</span><span style="color:#75af00">pauseNS</span> <span style="color:#f92672">+=</span> <span style="color:#75af00">now</span> <span style="color:#f92672">-</span> <span style="color:#75af00">stw</span><span style="color:#111">.</span><span style="color:#75af00">startedStopping</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">work</span><span style="color:#111">.</span><span style="color:#75af00">tMark</span> <span style="color:#111">=</span> <span style="color:#75af00">now</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 释放 CPU 限制器</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">gcCPULimiter</span><span style="color:#111">.</span><span style="color:#75af00">finishGCTransition</span><span style="color:#111">(</span><span style="color:#75af00">now</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 在 STW 模式下，在 Gosched() 之前释放 world sema，</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 因为我们稍后需要再次获取它，但在这个 goroutine 变为可运行之前，我们可能会自我死锁。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">semrelease</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">worldsema</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">releasem</span><span style="color:#111">(</span><span style="color:#75af00">mp</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	 <span style="color:#75715e">// 确保在 STW 模式下阻塞，而不是返回到用户代码。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">mode</span> <span style="color:#f92672">!=</span> <span style="color:#75af00">gcBackgroundMode</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">Gosched</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 释放开始信号量</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">semrelease</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">work</span><span style="color:#111">.</span><span style="color:#75af00">startSema</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="gcbgmarkstartworkers">gcBgMarkStartWorkers</h3>
<p>gcBgMarkStartWorkers 启动 P 个数个 goroutine 去做并发标记</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">gcBgMarkStartWorkers</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ......</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">gcBgMarkWorkerCount</span> <span style="color:#111">&lt;</span> <span style="color:#75af00">gomaxprocs</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">go</span> <span style="color:#75af00">gcBgMarkWorker</span><span style="color:#111">(</span><span style="color:#75af00">ready</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">releasem</span><span style="color:#111">(</span><span style="color:#75af00">mp</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">&lt;-</span><span style="color:#75af00">ready</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">incnwait</span> <span style="color:#f92672">==</span> <span style="color:#75af00">work</span><span style="color:#111">.</span><span style="color:#75af00">nproc</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#111">!</span><span style="color:#75af00">gcMarkWorkAvailable</span><span style="color:#111">(</span><span style="color:#00a8c8">nil</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">releasem</span><span style="color:#111">(</span><span style="color:#75af00">node</span><span style="color:#111">.</span><span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">ptr</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">node</span><span style="color:#111">.</span><span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">set</span><span style="color:#111">(</span><span style="color:#00a8c8">nil</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">gcMarkDone</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">gcBgMarkWorker</span><span style="color:#111">(</span><span style="color:#75af00">ready</span> <span style="color:#00a8c8">chan</span> <span style="color:#00a8c8">struct</span><span style="color:#111">{})</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">gp</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">getg</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 把 node 组装成 node</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">node</span> <span style="color:#f92672">:=</span> <span style="color:#111">new</span><span style="color:#111">(</span><span style="color:#75af00">gcBgMarkWorkerNode</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">node</span><span style="color:#111">.</span><span style="color:#75af00">gp</span><span style="color:#111">.</span><span style="color:#75af00">set</span><span style="color:#111">(</span><span style="color:#75af00">gp</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">node</span><span style="color:#111">.</span><span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">set</span><span style="color:#111">(</span><span style="color:#75af00">acquirem</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ready</span> <span style="color:#f92672">&lt;-</span> <span style="color:#00a8c8">struct</span><span style="color:#111">{}{}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 阻塞当前 g 并把 node 传入 gcBgMarkWorkerPool</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">gopark</span><span style="color:#111">(</span><span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">g</span> <span style="color:#f92672">*</span><span style="color:#75af00">g</span><span style="color:#111">,</span> <span style="color:#75af00">nodep</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">)</span> <span style="color:#00a8c8">bool</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">node</span> <span style="color:#f92672">:=</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">gcBgMarkWorkerNode</span><span style="color:#111">)(</span><span style="color:#75af00">nodep</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">mp</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">node</span><span style="color:#111">.</span><span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">ptr</span><span style="color:#111">();</span> <span style="color:#75af00">mp</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">releasem</span><span style="color:#111">(</span><span style="color:#75af00">mp</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">gcBgMarkWorkerPool</span><span style="color:#111">.</span><span style="color:#75af00">push</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">node</span><span style="color:#111">.</span><span style="color:#75af00">node</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">true</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">},</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">(</span><span style="color:#75af00">node</span><span style="color:#111">),</span> <span style="color:#75af00">waitReasonGCWorkerIdle</span><span style="color:#111">,</span> <span style="color:#75af00">traceBlockSystemGoroutine</span><span style="color:#111">,</span> <span style="color:#ae81ff">0</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// ......</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 设置 gc goroutine 使用资源的方式</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">systemstack</span><span style="color:#111">(</span><span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">casGToWaitingForGC</span><span style="color:#111">(</span><span style="color:#75af00">gp</span><span style="color:#111">,</span> <span style="color:#75af00">_Grunning</span><span style="color:#111">,</span> <span style="color:#75af00">waitReasonGCWorkerActive</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// gcDrain(......)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// .....</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">casgstatus</span><span style="color:#111">(</span><span style="color:#75af00">gp</span><span style="color:#111">,</span> <span style="color:#75af00">_Gwaiting</span><span style="color:#111">,</span> <span style="color:#75af00">_Grunning</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// ......</span>
</span></span><span style="display:flex;"><span>		
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="stoptheworldwithsema">stopTheWorldWithSema</h3>
<p>停止所有用户的 goroutine 做一些事情</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">stopTheWorldWithSema</span><span style="color:#111">(</span><span style="color:#75af00">reason</span> <span style="color:#75af00">stwReason</span><span style="color:#111">)</span> <span style="color:#75af00">worldStop</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 加锁 并抢占所有的 goroutine</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">lock</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">sched</span><span style="color:#111">.</span><span style="color:#75af00">lock</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">preemptall</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 将所有 P 设置为 _Pgcstop 状态 （当前 运行中 和空闲）</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">gp</span><span style="color:#111">.</span><span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">ptr</span><span style="color:#111">().</span><span style="color:#75af00">status</span> <span style="color:#111">=</span> <span style="color:#75af00">_Pgcstop</span> 
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">gp</span><span style="color:#111">.</span><span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">ptr</span><span style="color:#111">().</span><span style="color:#75af00">gcStopTime</span> <span style="color:#111">=</span> <span style="color:#75af00">start</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">sched</span><span style="color:#111">.</span><span style="color:#75af00">stopwait</span><span style="color:#f92672">--</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">trace</span> <span style="color:#111">=</span> <span style="color:#75af00">traceAcquire</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">pp</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">allp</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">s</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">pp</span><span style="color:#111">.</span><span style="color:#75af00">status</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">s</span> <span style="color:#f92672">==</span> <span style="color:#75af00">_Psyscall</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">atomic</span><span style="color:#111">.</span><span style="color:#75af00">Cas</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">pp</span><span style="color:#111">.</span><span style="color:#75af00">status</span><span style="color:#111">,</span> <span style="color:#75af00">s</span><span style="color:#111">,</span> <span style="color:#75af00">_Pgcstop</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">trace</span><span style="color:#111">.</span><span style="color:#75af00">ok</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">trace</span><span style="color:#111">.</span><span style="color:#75af00">ProcSteal</span><span style="color:#111">(</span><span style="color:#75af00">pp</span><span style="color:#111">,</span> <span style="color:#00a8c8">false</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">pp</span><span style="color:#111">.</span><span style="color:#75af00">syscalltick</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">pp</span><span style="color:#111">.</span><span style="color:#75af00">gcStopTime</span> <span style="color:#111">=</span> <span style="color:#75af00">nanotime</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">sched</span><span style="color:#111">.</span><span style="color:#75af00">stopwait</span><span style="color:#f92672">--</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">trace</span><span style="color:#111">.</span><span style="color:#75af00">ok</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">traceRelease</span><span style="color:#111">(</span><span style="color:#75af00">trace</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">now</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">nanotime</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">pp</span><span style="color:#111">,</span> <span style="color:#75af00">_</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">pidleget</span><span style="color:#111">(</span><span style="color:#75af00">now</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">pp</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">break</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">pp</span><span style="color:#111">.</span><span style="color:#75af00">status</span> <span style="color:#111">=</span> <span style="color:#75af00">_Pgcstop</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">pp</span><span style="color:#111">.</span><span style="color:#75af00">gcStopTime</span> <span style="color:#111">=</span> <span style="color:#75af00">nanotime</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">sched</span><span style="color:#111">.</span><span style="color:#75af00">stopwait</span><span style="color:#f92672">--</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">wait</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">sched</span><span style="color:#111">.</span><span style="color:#75af00">stopwait</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">unlock</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">sched</span><span style="color:#111">.</span><span style="color:#75af00">lock</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 当前 P 不能被抢占 等待完成</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">wait</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">for</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">notetsleep</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">sched</span><span style="color:#111">.</span><span style="color:#75af00">stopnote</span><span style="color:#111">,</span> <span style="color:#ae81ff">100</span><span style="color:#f92672">*</span><span style="color:#ae81ff">1000</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">noteclear</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">sched</span><span style="color:#111">.</span><span style="color:#75af00">stopnote</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">break</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">preemptall</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ......</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">worldStopped</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">worldStop</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">reason</span><span style="color:#111">:</span>           <span style="color:#75af00">reason</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">startedStopping</span><span style="color:#111">:</span>  <span style="color:#75af00">start</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">finishedStopping</span><span style="color:#111">:</span> <span style="color:#75af00">finish</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">stoppingCPUTime</span><span style="color:#111">:</span>  <span style="color:#75af00">stoppingCPUTime</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="startcycle">startCycle</h3>
<p>设置可以使用多少个核心进行 GC</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">gcControllerState</span><span style="color:#111">)</span> <span style="color:#75af00">startCycle</span><span style="color:#111">(</span><span style="color:#75af00">markStartTime</span> <span style="color:#00a8c8">int64</span><span style="color:#111">,</span> <span style="color:#75af00">procs</span> <span style="color:#00a8c8">int</span><span style="color:#111">,</span> <span style="color:#75af00">trigger</span> <span style="color:#75af00">gcTrigger</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// P * 25% 然后取整</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">totalUtilizationGoal</span> <span style="color:#f92672">:=</span> <span style="color:#111">float64</span><span style="color:#111">(</span><span style="color:#75af00">procs</span><span style="color:#111">)</span> <span style="color:#f92672">*</span> <span style="color:#75af00">gcBackgroundUtilization</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">dedicatedMarkWorkersNeeded</span> <span style="color:#f92672">:=</span> <span style="color:#111">int64</span><span style="color:#111">(</span><span style="color:#75af00">totalUtilizationGoal</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0.5</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">utilError</span> <span style="color:#f92672">:=</span> <span style="color:#111">float64</span><span style="color:#111">(</span><span style="color:#75af00">dedicatedMarkWorkersNeeded</span><span style="color:#111">)</span><span style="color:#f92672">/</span><span style="color:#75af00">totalUtilizationGoal</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">const</span> <span style="color:#75af00">maxUtilError</span> <span style="color:#111">=</span> <span style="color:#ae81ff">0.3</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 如果不能整除 算出时间片</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">utilError</span> <span style="color:#111">&lt;</span> <span style="color:#f92672">-</span><span style="color:#75af00">maxUtilError</span> <span style="color:#f92672">||</span> <span style="color:#75af00">utilError</span> <span style="color:#111">&gt;</span> <span style="color:#75af00">maxUtilError</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#111">float64</span><span style="color:#111">(</span><span style="color:#75af00">dedicatedMarkWorkersNeeded</span><span style="color:#111">)</span> <span style="color:#111">&gt;</span> <span style="color:#75af00">totalUtilizationGoal</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">dedicatedMarkWorkersNeeded</span><span style="color:#f92672">--</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">fractionalUtilizationGoal</span> <span style="color:#111">=</span> <span style="color:#111">(</span><span style="color:#75af00">totalUtilizationGoal</span> <span style="color:#f92672">-</span> <span style="color:#111">float64</span><span style="color:#111">(</span><span style="color:#75af00">dedicatedMarkWorkersNeeded</span><span style="color:#111">))</span> <span style="color:#f92672">/</span> <span style="color:#111">float64</span><span style="color:#111">(</span><span style="color:#75af00">procs</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">fractionalUtilizationGoal</span> <span style="color:#111">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">debug</span><span style="color:#111">.</span><span style="color:#75af00">gcstoptheworld</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">dedicatedMarkWorkersNeeded</span> <span style="color:#111">=</span> <span style="color:#111">int64</span><span style="color:#111">(</span><span style="color:#75af00">procs</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">fractionalUtilizationGoal</span> <span style="color:#111">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="setgcphase">setGCPhase</h3>
<p>开启混合写屏障</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">setGCPhase</span><span style="color:#111">(</span><span style="color:#75af00">x</span> <span style="color:#00a8c8">uint32</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">atomic</span><span style="color:#111">.</span><span style="color:#75af00">Store</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">gcphase</span><span style="color:#111">,</span> <span style="color:#75af00">x</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">writeBarrier</span><span style="color:#111">.</span><span style="color:#75af00">enabled</span> <span style="color:#111">=</span> <span style="color:#75af00">gcphase</span> <span style="color:#f92672">==</span> <span style="color:#75af00">_GCmark</span> <span style="color:#f92672">||</span> <span style="color:#75af00">gcphase</span> <span style="color:#f92672">==</span> <span style="color:#75af00">_GCmarktermination</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><pre tabindex="0"><code class="language-assembly" data-lang="assembly">TEXT gcWriteBarrier&lt;&gt;(SB),NOSPLIT,$112
// ...
CALL	runtime·wbBufFlush(SB)
// ...
</code></pre><div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">wbBufFlush</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 如果当前 M（操作系统线程）正在终止过程中</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">getg</span><span style="color:#111">().</span><span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">dying</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">getg</span><span style="color:#111">().</span><span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">ptr</span><span style="color:#111">().</span><span style="color:#75af00">wbBuf</span><span style="color:#111">.</span><span style="color:#75af00">discard</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">systemstack</span><span style="color:#111">(</span><span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">wbBufFlush1</span><span style="color:#111">(</span><span style="color:#75af00">getg</span><span style="color:#111">().</span><span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">ptr</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">wbBufFlush1</span><span style="color:#111">(</span><span style="color:#75af00">pp</span> <span style="color:#f92672">*</span><span style="color:#75af00">p</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 获取缓冲区中的所有指针</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">start</span> <span style="color:#f92672">:=</span> <span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">pp</span><span style="color:#111">.</span><span style="color:#75af00">wbBuf</span><span style="color:#111">.</span><span style="color:#75af00">buf</span><span style="color:#111">[</span><span style="color:#ae81ff">0</span><span style="color:#111">]))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">n</span> <span style="color:#f92672">:=</span> <span style="color:#111">(</span><span style="color:#75af00">pp</span><span style="color:#111">.</span><span style="color:#75af00">wbBuf</span><span style="color:#111">.</span><span style="color:#75af00">next</span> <span style="color:#f92672">-</span> <span style="color:#75af00">start</span><span style="color:#111">)</span> <span style="color:#f92672">/</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Sizeof</span><span style="color:#111">(</span><span style="color:#75af00">pp</span><span style="color:#111">.</span><span style="color:#75af00">wbBuf</span><span style="color:#111">.</span><span style="color:#75af00">buf</span><span style="color:#111">[</span><span style="color:#ae81ff">0</span><span style="color:#111">])</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ptrs</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">pp</span><span style="color:#111">.</span><span style="color:#75af00">wbBuf</span><span style="color:#111">.</span><span style="color:#75af00">buf</span><span style="color:#111">[:</span><span style="color:#75af00">n</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Poison the buffer to make extra sure nothing is enqueued</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// while we&#39;re processing the buffer.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">pp</span><span style="color:#111">.</span><span style="color:#75af00">wbBuf</span><span style="color:#111">.</span><span style="color:#75af00">next</span> <span style="color:#111">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">useCheckmark</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Slow path for checkmark mode.</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">ptr</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">ptrs</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">shade</span><span style="color:#111">(</span><span style="color:#75af00">ptr</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">pp</span><span style="color:#111">.</span><span style="color:#75af00">wbBuf</span><span style="color:#111">.</span><span style="color:#75af00">reset</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 标记缓冲区中的所有指针，并且只记录被置灰的指针。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 使用缓冲区本身临时记录被置灰的指针。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">gcw</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">pp</span><span style="color:#111">.</span><span style="color:#75af00">gcw</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">pos</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">ptr</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">ptrs</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">ptr</span> <span style="color:#111">&lt;</span> <span style="color:#75af00">minLegalPointer</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">continue</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">obj</span><span style="color:#111">,</span> <span style="color:#75af00">span</span><span style="color:#111">,</span> <span style="color:#75af00">objIndex</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">findObject</span><span style="color:#111">(</span><span style="color:#75af00">ptr</span><span style="color:#111">,</span> <span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#ae81ff">0</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">obj</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">continue</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">mbits</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">span</span><span style="color:#111">.</span><span style="color:#75af00">markBitsForIndex</span><span style="color:#111">(</span><span style="color:#75af00">objIndex</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">mbits</span><span style="color:#111">.</span><span style="color:#75af00">isMarked</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">continue</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">mbits</span><span style="color:#111">.</span><span style="color:#75af00">setMarked</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">arena</span><span style="color:#111">,</span> <span style="color:#75af00">pageIdx</span><span style="color:#111">,</span> <span style="color:#75af00">pageMask</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">pageIndexOf</span><span style="color:#111">(</span><span style="color:#75af00">span</span><span style="color:#111">.</span><span style="color:#75af00">base</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">arena</span><span style="color:#111">.</span><span style="color:#75af00">pageMarks</span><span style="color:#111">[</span><span style="color:#75af00">pageIdx</span><span style="color:#111">]</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">pageMask</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">atomic</span><span style="color:#111">.</span><span style="color:#75af00">Or8</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">arena</span><span style="color:#111">.</span><span style="color:#75af00">pageMarks</span><span style="color:#111">[</span><span style="color:#75af00">pageIdx</span><span style="color:#111">],</span> <span style="color:#75af00">pageMask</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">span</span><span style="color:#111">.</span><span style="color:#75af00">spanclass</span><span style="color:#111">.</span><span style="color:#75af00">noscan</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">gcw</span><span style="color:#111">.</span><span style="color:#75af00">bytesMarked</span> <span style="color:#f92672">+=</span> <span style="color:#111">uint64</span><span style="color:#111">(</span><span style="color:#75af00">span</span><span style="color:#111">.</span><span style="color:#75af00">elemsize</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">continue</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">ptrs</span><span style="color:#111">[</span><span style="color:#75af00">pos</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#75af00">obj</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">pos</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 将被置灰的指针批量放入 gcw 中</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">gcw</span><span style="color:#111">.</span><span style="color:#75af00">putBatch</span><span style="color:#111">(</span><span style="color:#75af00">ptrs</span><span style="color:#111">[:</span><span style="color:#75af00">pos</span><span style="color:#111">])</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">pp</span><span style="color:#111">.</span><span style="color:#75af00">wbBuf</span><span style="color:#111">.</span><span style="color:#75af00">reset</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="gcmarktinyallocs">gcMarkTinyAllocs</h3>
<p>把所有的 tinyalloc 标记为灰色</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">gcMarkTinyAllocs</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">assertWorldStopped</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">p</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">allp</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">c</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">mcache</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">c</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#f92672">||</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">tiny</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">continue</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">span</span><span style="color:#111">,</span> <span style="color:#75af00">objIndex</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">findObject</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">tiny</span><span style="color:#111">,</span> <span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#ae81ff">0</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">gcw</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">gcw</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">greyobject</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">tiny</span><span style="color:#111">,</span> <span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#75af00">span</span><span style="color:#111">,</span> <span style="color:#75af00">gcw</span><span style="color:#111">,</span> <span style="color:#75af00">objIndex</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="starttheworldwithsema">startTheWorldWithSema</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">startTheWorldWithSema</span><span style="color:#111">(</span><span style="color:#75af00">now</span> <span style="color:#00a8c8">int64</span><span style="color:#111">,</span> <span style="color:#75af00">w</span> <span style="color:#75af00">worldStop</span><span style="color:#111">)</span> <span style="color:#00a8c8">int64</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ......</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">worldStarted</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 唤醒所有的 P</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">p1</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">p</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">p1</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">p1</span> <span style="color:#111">=</span> <span style="color:#75af00">p1</span><span style="color:#111">.</span><span style="color:#75af00">link</span><span style="color:#111">.</span><span style="color:#75af00">ptr</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">m</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">mp</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">ptr</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">m</span> <span style="color:#111">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">mp</span><span style="color:#111">.</span><span style="color:#75af00">nextp</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">throw</span><span style="color:#111">(</span><span style="color:#d88200">&#34;startTheWorld: inconsistent mp-&gt;nextp&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">mp</span><span style="color:#111">.</span><span style="color:#75af00">nextp</span><span style="color:#111">.</span><span style="color:#75af00">set</span><span style="color:#111">(</span><span style="color:#75af00">p</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">notewakeup</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">mp</span><span style="color:#111">.</span><span style="color:#75af00">park</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">newm</span><span style="color:#111">(</span><span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">p</span><span style="color:#111">,</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ......</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">now</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="worker-标记">worker 标记</h2>
<p>在 goroutine 调度中会执行 <code>findRunnableGCWorker</code> goroutine 这个就是启动标记 worker 的函数</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">gcControllerState</span><span style="color:#111">)</span> <span style="color:#75af00">findRunnableGCWorker</span><span style="color:#111">(</span><span style="color:#75af00">pp</span> <span style="color:#f92672">*</span><span style="color:#75af00">p</span><span style="color:#111">,</span> <span style="color:#75af00">now</span> <span style="color:#00a8c8">int64</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">g</span><span style="color:#111">,</span> <span style="color:#00a8c8">int64</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ......</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 从 gcBgMarkWorkerPool 拿出 node </span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">node</span> <span style="color:#f92672">:=</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">gcBgMarkWorkerNode</span><span style="color:#111">)(</span><span style="color:#75af00">gcBgMarkWorkerPool</span><span style="color:#111">.</span><span style="color:#75af00">pop</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 开启</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">casgstatus</span><span style="color:#111">(</span><span style="color:#75af00">gp</span><span style="color:#111">,</span> <span style="color:#75af00">_Gwaiting</span><span style="color:#111">,</span> <span style="color:#75af00">_Grunnable</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">gp</span><span style="color:#111">,</span> <span style="color:#75af00">now</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="gcdrain">gcDrain</h2>
<p>gcDrain 是标记的主流程</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">gcDrain</span><span style="color:#111">(</span><span style="color:#75af00">gcw</span> <span style="color:#f92672">*</span><span style="color:#75af00">gcWork</span><span style="color:#111">,</span> <span style="color:#75af00">flags</span> <span style="color:#75af00">gcDrainFlags</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ......</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 标记根对象</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">work</span><span style="color:#111">.</span><span style="color:#75af00">markrootNext</span> <span style="color:#111">&lt;</span> <span style="color:#75af00">work</span><span style="color:#111">.</span><span style="color:#75af00">markrootJobs</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">for</span> <span style="color:#111">!(</span><span style="color:#75af00">gp</span><span style="color:#111">.</span><span style="color:#75af00">preempt</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#111">(</span><span style="color:#75af00">preemptible</span> <span style="color:#f92672">||</span> <span style="color:#75af00">sched</span><span style="color:#111">.</span><span style="color:#75af00">gcwaiting</span><span style="color:#111">.</span><span style="color:#75af00">Load</span><span style="color:#111">()</span> <span style="color:#f92672">||</span> <span style="color:#75af00">pp</span><span style="color:#111">.</span><span style="color:#75af00">runSafePointFn</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span><span style="color:#111">))</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">job</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">atomic</span><span style="color:#111">.</span><span style="color:#75af00">Xadd</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">work</span><span style="color:#111">.</span><span style="color:#75af00">markrootNext</span><span style="color:#111">,</span> <span style="color:#f92672">+</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">job</span> <span style="color:#f92672">&gt;=</span> <span style="color:#75af00">work</span><span style="color:#111">.</span><span style="color:#75af00">markrootJobs</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">break</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">markroot</span><span style="color:#111">(</span><span style="color:#75af00">gcw</span><span style="color:#111">,</span> <span style="color:#75af00">job</span><span style="color:#111">,</span> <span style="color:#75af00">flushBgCredit</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">check</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">check</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">goto</span> <span style="color:#75af00">done</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#111">!(</span><span style="color:#75af00">gp</span><span style="color:#111">.</span><span style="color:#75af00">preempt</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#111">(</span><span style="color:#75af00">preemptible</span> <span style="color:#f92672">||</span> <span style="color:#75af00">sched</span><span style="color:#111">.</span><span style="color:#75af00">gcwaiting</span><span style="color:#111">.</span><span style="color:#75af00">Load</span><span style="color:#111">()</span> <span style="color:#f92672">||</span> <span style="color:#75af00">pp</span><span style="color:#111">.</span><span style="color:#75af00">runSafePointFn</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span><span style="color:#111">))</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">work</span><span style="color:#111">.</span><span style="color:#75af00">full</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">gcw</span><span style="color:#111">.</span><span style="color:#75af00">balance</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 尝试从本地队列中获取对象</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">b</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">gcw</span><span style="color:#111">.</span><span style="color:#75af00">tryGetFast</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">b</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 如果没有从全局队列中获取 加锁</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">b</span> <span style="color:#111">=</span> <span style="color:#75af00">gcw</span><span style="color:#111">.</span><span style="color:#75af00">tryGet</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">b</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// 刷新写屏障缓存</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">wbBufFlush</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">b</span> <span style="color:#111">=</span> <span style="color:#75af00">gcw</span><span style="color:#111">.</span><span style="color:#75af00">tryGet</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">b</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">break</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 清扫对象</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">scanobject</span><span style="color:#111">(</span><span style="color:#75af00">b</span><span style="color:#111">,</span> <span style="color:#75af00">gcw</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// ......</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">done</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 记录积分</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">gcw</span><span style="color:#111">.</span><span style="color:#75af00">heapScanWork</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">gcController</span><span style="color:#111">.</span><span style="color:#75af00">heapScanWork</span><span style="color:#111">.</span><span style="color:#75af00">Add</span><span style="color:#111">(</span><span style="color:#75af00">gcw</span><span style="color:#111">.</span><span style="color:#75af00">heapScanWork</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">flushBgCredit</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">gcFlushBgCredit</span><span style="color:#111">(</span><span style="color:#75af00">gcw</span><span style="color:#111">.</span><span style="color:#75af00">heapScanWork</span> <span style="color:#f92672">-</span> <span style="color:#75af00">initScanWork</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">gcw</span><span style="color:#111">.</span><span style="color:#75af00">heapScanWork</span> <span style="color:#111">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="scanobject">scanobject</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">scanobject</span><span style="color:#111">(</span><span style="color:#75af00">b</span> <span style="color:#00a8c8">uintptr</span><span style="color:#111">,</span> <span style="color:#75af00">gcw</span> <span style="color:#f92672">*</span><span style="color:#75af00">gcWork</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">var</span> <span style="color:#75af00">tp</span> <span style="color:#75af00">typePointers</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">n</span> <span style="color:#111">&gt;</span> <span style="color:#75af00">maxObletBytes</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 大对象分块</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">b</span> <span style="color:#f92672">==</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">base</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">for</span> <span style="color:#75af00">oblet</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">b</span> <span style="color:#f92672">+</span> <span style="color:#75af00">maxObletBytes</span><span style="color:#111">;</span> <span style="color:#75af00">oblet</span> <span style="color:#111">&lt;</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">base</span><span style="color:#111">()</span><span style="color:#f92672">+</span><span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">elemsize</span><span style="color:#111">;</span> <span style="color:#75af00">oblet</span> <span style="color:#f92672">+=</span> <span style="color:#75af00">maxObletBytes</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">gcw</span><span style="color:#111">.</span><span style="color:#75af00">putFast</span><span style="color:#111">(</span><span style="color:#75af00">oblet</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">gcw</span><span style="color:#111">.</span><span style="color:#75af00">put</span><span style="color:#111">(</span><span style="color:#75af00">oblet</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">n</span> <span style="color:#111">=</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">base</span><span style="color:#111">()</span> <span style="color:#f92672">+</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">elemsize</span> <span style="color:#f92672">-</span> <span style="color:#75af00">b</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">n</span> <span style="color:#111">=</span> <span style="color:#111">min</span><span style="color:#111">(</span><span style="color:#75af00">n</span><span style="color:#111">,</span> <span style="color:#75af00">maxObletBytes</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">tp</span> <span style="color:#111">=</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">typePointersOfUnchecked</span><span style="color:#111">(</span><span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">base</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">tp</span> <span style="color:#111">=</span> <span style="color:#75af00">tp</span><span style="color:#111">.</span><span style="color:#75af00">fastForward</span><span style="color:#111">(</span><span style="color:#75af00">b</span><span style="color:#f92672">-</span><span style="color:#75af00">tp</span><span style="color:#111">.</span><span style="color:#75af00">addr</span><span style="color:#111">,</span> <span style="color:#75af00">b</span><span style="color:#f92672">+</span><span style="color:#75af00">n</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">tp</span> <span style="color:#111">=</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">typePointersOfUnchecked</span><span style="color:#111">(</span><span style="color:#75af00">b</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">var</span> <span style="color:#75af00">scanSize</span> <span style="color:#00a8c8">uintptr</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">var</span> <span style="color:#75af00">addr</span> <span style="color:#00a8c8">uintptr</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">tp</span><span style="color:#111">,</span> <span style="color:#75af00">addr</span> <span style="color:#111">=</span> <span style="color:#75af00">tp</span><span style="color:#111">.</span><span style="color:#75af00">nextFast</span><span style="color:#111">();</span> <span style="color:#75af00">addr</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">tp</span><span style="color:#111">,</span> <span style="color:#75af00">addr</span> <span style="color:#111">=</span> <span style="color:#75af00">tp</span><span style="color:#111">.</span><span style="color:#75af00">next</span><span style="color:#111">(</span><span style="color:#75af00">b</span> <span style="color:#f92672">+</span> <span style="color:#75af00">n</span><span style="color:#111">);</span> <span style="color:#75af00">addr</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">break</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">scanSize</span> <span style="color:#111">=</span> <span style="color:#75af00">addr</span> <span style="color:#f92672">-</span> <span style="color:#75af00">b</span> <span style="color:#f92672">+</span> <span style="color:#75af00">goarch</span><span style="color:#111">.</span><span style="color:#75af00">PtrSize</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">obj</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">*</span><span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#00a8c8">uintptr</span><span style="color:#111">)(</span><span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">(</span><span style="color:#75af00">addr</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">obj</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">obj</span><span style="color:#f92672">-</span><span style="color:#75af00">b</span> <span style="color:#f92672">&gt;=</span> <span style="color:#75af00">n</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">obj</span><span style="color:#111">,</span> <span style="color:#75af00">span</span><span style="color:#111">,</span> <span style="color:#75af00">objIndex</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">findObject</span><span style="color:#111">(</span><span style="color:#75af00">obj</span><span style="color:#111">,</span> <span style="color:#75af00">b</span><span style="color:#111">,</span> <span style="color:#75af00">addr</span><span style="color:#f92672">-</span><span style="color:#75af00">b</span><span style="color:#111">);</span> <span style="color:#75af00">obj</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// 设置为灰色</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">greyobject</span><span style="color:#111">(</span><span style="color:#75af00">obj</span><span style="color:#111">,</span> <span style="color:#75af00">b</span><span style="color:#111">,</span> <span style="color:#75af00">addr</span><span style="color:#f92672">-</span><span style="color:#75af00">b</span><span style="color:#111">,</span> <span style="color:#75af00">span</span><span style="color:#111">,</span> <span style="color:#75af00">gcw</span><span style="color:#111">,</span> <span style="color:#75af00">objIndex</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p><strong>greyobject</strong></p>
<p>gcmarkBits 是一个 bitmaps 代表了一个对象是不是可用（gc 过程中）</p>
<ol>
<li>如果 Bit = 1 对象不在 gcw 中 黑色</li>
<li>如果 Bit = 0 对象不在 gcw 中 白色</li>
<li>如果对象在 gcw 中 灰色</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">greyobject</span><span style="color:#111">(</span><span style="color:#75af00">obj</span><span style="color:#111">,</span> <span style="color:#75af00">base</span><span style="color:#111">,</span> <span style="color:#75af00">off</span> <span style="color:#00a8c8">uintptr</span><span style="color:#111">,</span> <span style="color:#75af00">span</span> <span style="color:#f92672">*</span><span style="color:#75af00">mspan</span><span style="color:#111">,</span> <span style="color:#75af00">gcw</span> <span style="color:#f92672">*</span><span style="color:#75af00">gcWork</span><span style="color:#111">,</span> <span style="color:#75af00">objIndex</span> <span style="color:#00a8c8">uintptr</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">mbits</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">span</span><span style="color:#111">.</span><span style="color:#75af00">markBitsForIndex</span><span style="color:#111">(</span><span style="color:#75af00">objIndex</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">useCheckmark</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">mbits</span><span style="color:#111">.</span><span style="color:#75af00">setMarked</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 把对象放入 gcw 中</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">sys</span><span style="color:#111">.</span><span style="color:#75af00">Prefetch</span><span style="color:#111">(</span><span style="color:#75af00">obj</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">gcw</span><span style="color:#111">.</span><span style="color:#75af00">putFast</span><span style="color:#111">(</span><span style="color:#75af00">obj</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">gcw</span><span style="color:#111">.</span><span style="color:#75af00">put</span><span style="color:#111">(</span><span style="color:#75af00">obj</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">s</span> <span style="color:#f92672">*</span><span style="color:#75af00">mspan</span><span style="color:#111">)</span> <span style="color:#75af00">markBitsForIndex</span><span style="color:#111">(</span><span style="color:#75af00">objIndex</span> <span style="color:#00a8c8">uintptr</span><span style="color:#111">)</span> <span style="color:#75af00">markBits</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">bytep</span><span style="color:#111">,</span> <span style="color:#75af00">mask</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">gcmarkBits</span><span style="color:#111">.</span><span style="color:#75af00">bitp</span><span style="color:#111">(</span><span style="color:#75af00">objIndex</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">markBits</span><span style="color:#111">{</span><span style="color:#75af00">bytep</span><span style="color:#111">,</span> <span style="color:#75af00">mask</span><span style="color:#111">,</span> <span style="color:#75af00">objIndex</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">m</span> <span style="color:#75af00">markBits</span><span style="color:#111">)</span> <span style="color:#75af00">setMarked</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">atomic</span><span style="color:#111">.</span><span style="color:#75af00">Or8</span><span style="color:#111">(</span><span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">bytep</span><span style="color:#111">,</span> <span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">mask</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="用户-goroutine-清扫">用户 goroutine 清扫</h2>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">deductAssistCredit</span><span style="color:#111">(</span><span style="color:#75af00">size</span> <span style="color:#00a8c8">uintptr</span><span style="color:#111">)</span> <span style="color:#f92672">*</span><span style="color:#75af00">g</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">var</span> <span style="color:#75af00">assistG</span> <span style="color:#f92672">*</span><span style="color:#75af00">g</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">gcBlackenEnabled</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">assistG</span> <span style="color:#111">=</span> <span style="color:#75af00">getg</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">assistG</span><span style="color:#111">.</span><span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">curg</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">assistG</span> <span style="color:#111">=</span> <span style="color:#75af00">assistG</span><span style="color:#111">.</span><span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">curg</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">assistG</span><span style="color:#111">.</span><span style="color:#75af00">gcAssistBytes</span> <span style="color:#f92672">-=</span> <span style="color:#111">int64</span><span style="color:#111">(</span><span style="color:#75af00">size</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 每个 G 都有自己的积分 当积分小于 0 启动 gc</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">assistG</span><span style="color:#111">.</span><span style="color:#75af00">gcAssistBytes</span> <span style="color:#111">&lt;</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">gcAssistAlloc</span><span style="color:#111">(</span><span style="color:#75af00">assistG</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">assistG</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">gcAssistAlloc</span><span style="color:#111">(</span><span style="color:#75af00">gp</span> <span style="color:#f92672">*</span><span style="color:#75af00">g</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ......</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">retry</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 处理下 assistG 的积分 需不需要启动 gc</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Perform assist work</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">systemstack</span><span style="color:#111">(</span><span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">gcAssistAlloc1</span><span style="color:#111">(</span><span style="color:#75af00">gp</span><span style="color:#111">,</span> <span style="color:#75af00">scanWork</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ......</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">gcAssistAlloc1</span><span style="color:#111">(</span><span style="color:#75af00">gp</span> <span style="color:#f92672">*</span><span style="color:#75af00">g</span><span style="color:#111">,</span> <span style="color:#75af00">scanWork</span> <span style="color:#00a8c8">int64</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ......</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">gcw</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">getg</span><span style="color:#111">().</span><span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">ptr</span><span style="color:#111">().</span><span style="color:#75af00">gcw</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">workDone</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">gcDrainN</span><span style="color:#111">(</span><span style="color:#75af00">gcw</span><span style="color:#111">,</span> <span style="color:#75af00">scanWork</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">casgstatus</span><span style="color:#111">(</span><span style="color:#75af00">gp</span><span style="color:#111">,</span> <span style="color:#75af00">_Gwaiting</span><span style="color:#111">,</span> <span style="color:#75af00">_Grunning</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ......</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="终止标记-gcmarkdone">终止标记 gcMarkDone</h2>
<p>在 gcBgMarkStartWorkers 中执行 gcMarkDone 终止</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">gcMarkDone</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">top</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 清除写屏障的缓存和处理gcw</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">gcMarkDoneFlushed</span> <span style="color:#111">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">forEachP</span><span style="color:#111">(</span><span style="color:#75af00">waitReasonGCMarkTermination</span><span style="color:#111">,</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">pp</span> <span style="color:#f92672">*</span><span style="color:#75af00">p</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">wbBufFlush1</span><span style="color:#111">(</span><span style="color:#75af00">pp</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">pp</span><span style="color:#111">.</span><span style="color:#75af00">gcw</span><span style="color:#111">.</span><span style="color:#75af00">dispose</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">pp</span><span style="color:#111">.</span><span style="color:#75af00">gcw</span><span style="color:#111">.</span><span style="color:#75af00">flushedWork</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">atomic</span><span style="color:#111">.</span><span style="color:#75af00">Xadd</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">gcMarkDoneFlushed</span><span style="color:#111">,</span> <span style="color:#ae81ff">1</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">pp</span><span style="color:#111">.</span><span style="color:#75af00">gcw</span><span style="color:#111">.</span><span style="color:#75af00">flushedWork</span> <span style="color:#111">=</span> <span style="color:#00a8c8">false</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">gcMarkDoneFlushed</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 还有没处理的 跳回去再处理一次</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">semrelease</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">worldsema</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">goto</span> <span style="color:#75af00">top</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Stop The World</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">systemstack</span><span style="color:#111">(</span><span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">stw</span> <span style="color:#111">=</span> <span style="color:#75af00">stopTheWorldWithSema</span><span style="color:#111">(</span><span style="color:#75af00">stwGCMarkTerm</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 清楚写屏障中的缓存 如果还有没处理的 跳回去再处理一次</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">restart</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">false</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">systemstack</span><span style="color:#111">(</span><span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">p</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">allp</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">wbBufFlush1</span><span style="color:#111">(</span><span style="color:#75af00">p</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">gcw</span><span style="color:#111">.</span><span style="color:#75af00">empty</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">restart</span> <span style="color:#111">=</span> <span style="color:#00a8c8">true</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">break</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">restart</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">getg</span><span style="color:#111">().</span><span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">preemptoff</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">systemstack</span><span style="color:#111">(</span><span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">work</span><span style="color:#111">.</span><span style="color:#75af00">cpuStats</span><span style="color:#111">.</span><span style="color:#75af00">accumulateGCPauseTime</span><span style="color:#111">(</span><span style="color:#75af00">nanotime</span><span style="color:#111">()</span><span style="color:#f92672">-</span><span style="color:#75af00">stw</span><span style="color:#111">.</span><span style="color:#75af00">finishedStopping</span><span style="color:#111">,</span> <span style="color:#75af00">work</span><span style="color:#111">.</span><span style="color:#75af00">maxprocs</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">now</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">startTheWorldWithSema</span><span style="color:#111">(</span><span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#75af00">stw</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">work</span><span style="color:#111">.</span><span style="color:#75af00">pauseNS</span> <span style="color:#f92672">+=</span> <span style="color:#75af00">now</span> <span style="color:#f92672">-</span> <span style="color:#75af00">stw</span><span style="color:#111">.</span><span style="color:#75af00">startedStopping</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">semrelease</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">worldsema</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">goto</span> <span style="color:#75af00">top</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 终止标记</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">gcMarkTermination</span><span style="color:#111">(</span><span style="color:#75af00">stw</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="gcmarktermination">gcMarkTermination</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">gcMarkTermination</span><span style="color:#111">(</span><span style="color:#75af00">stw</span> <span style="color:#75af00">worldStop</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 设置 gc 终止阶段</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">setGCPhase</span><span style="color:#111">(</span><span style="color:#75af00">_GCmarktermination</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 修改 gc goroutine 状态</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">casGToWaitingForGC</span><span style="color:#111">(</span><span style="color:#75af00">curgp</span><span style="color:#111">,</span> <span style="color:#75af00">_Grunning</span><span style="color:#111">,</span> <span style="color:#75af00">waitReasonGarbageCollection</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 在 g0 栈上运行 gc。这样做是为了保证我们当前运行的 g 栈不再变化，</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 这有助于减少根集大小（g0 栈不会被扫描，我们也不需要扫描 gc 的内部状态）。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 我们还需要切换到 g0 以便可能的栈缩减。 </span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">systemstack</span><span style="color:#111">(</span><span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">gcMark</span><span style="color:#111">(</span><span style="color:#75af00">startTime</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">var</span> <span style="color:#75af00">stwSwept</span> <span style="color:#00a8c8">bool</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">systemstack</span><span style="color:#111">(</span><span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">work</span><span style="color:#111">.</span><span style="color:#75af00">heap2</span> <span style="color:#111">=</span> <span style="color:#75af00">work</span><span style="color:#111">.</span><span style="color:#75af00">bytesMarked</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">debug</span><span style="color:#111">.</span><span style="color:#75af00">gccheckmark</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// Run a full non-parallel, stop-the-world</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// mark using checkmark bits, to check that we</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// didn&#39;t forget to mark anything during the</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// concurrent mark process.</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">startCheckmarks</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">gcResetMarkState</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">gcw</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">getg</span><span style="color:#111">().</span><span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">ptr</span><span style="color:#111">().</span><span style="color:#75af00">gcw</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">gcDrain</span><span style="color:#111">(</span><span style="color:#75af00">gcw</span><span style="color:#111">,</span> <span style="color:#ae81ff">0</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">wbBufFlush1</span><span style="color:#111">(</span><span style="color:#75af00">getg</span><span style="color:#111">().</span><span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">ptr</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">gcw</span><span style="color:#111">.</span><span style="color:#75af00">dispose</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">endCheckmarks</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 标记完成，我们可以关闭写屏障。</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">setGCPhase</span><span style="color:#111">(</span><span style="color:#75af00">_GCoff</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 开启清扫</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">stwSwept</span> <span style="color:#111">=</span> <span style="color:#75af00">gcSweep</span><span style="color:#111">(</span><span style="color:#75af00">work</span><span style="color:#111">.</span><span style="color:#75af00">mode</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">casgstatus</span><span style="color:#111">(</span><span style="color:#75af00">curgp</span><span style="color:#111">,</span> <span style="color:#75af00">_Gwaiting</span><span style="color:#111">,</span> <span style="color:#75af00">_Grunning</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ......</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">systemstack</span><span style="color:#111">(</span><span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Start The World</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">startTheWorldWithSema</span><span style="color:#111">(</span><span style="color:#75af00">now</span><span style="color:#111">,</span> <span style="color:#75af00">stw</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 确保所有 mcaches 被清空。每个 P 在分配前将清空自己的 mcache，但空闲的 P 可能不会。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 由于这对于扫描所有 spans 是必需的，我们需要确保在开始下一个 GC 周期前，所有 mcaches 都已被清空。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">forEachP</span><span style="color:#111">(</span><span style="color:#75af00">waitReasonFlushProcCaches</span><span style="color:#111">,</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">pp</span> <span style="color:#f92672">*</span><span style="color:#75af00">p</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">pp</span><span style="color:#111">.</span><span style="color:#75af00">mcache</span><span style="color:#111">.</span><span style="color:#75af00">prepareForSweep</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">pp</span><span style="color:#111">.</span><span style="color:#75af00">status</span> <span style="color:#f92672">==</span> <span style="color:#75af00">_Pidle</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">systemstack</span><span style="color:#111">(</span><span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">lock</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">mheap_</span><span style="color:#111">.</span><span style="color:#75af00">lock</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">pp</span><span style="color:#111">.</span><span style="color:#75af00">pcache</span><span style="color:#111">.</span><span style="color:#75af00">flush</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">mheap_</span><span style="color:#111">.</span><span style="color:#75af00">pages</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">unlock</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">mheap_</span><span style="color:#111">.</span><span style="color:#75af00">lock</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">pp</span><span style="color:#111">.</span><span style="color:#75af00">pinnerCache</span> <span style="color:#111">=</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">sl</span><span style="color:#111">.</span><span style="color:#75af00">valid</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Now that we&#39;ve swept stale spans in mcaches, they don&#39;t</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// count against unswept spans.</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">		// Note: this sweepLocker may not be valid if sweeping had</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// already completed during the STW. See the corresponding</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// begin() call that produced sl.</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">sweep</span><span style="color:#111">.</span><span style="color:#75af00">active</span><span style="color:#111">.</span><span style="color:#75af00">end</span><span style="color:#111">(</span><span style="color:#75af00">sl</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="清扫">清扫</h2>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">gcSweep</span><span style="color:#111">(</span><span style="color:#75af00">mode</span> <span style="color:#75af00">gcMode</span><span style="color:#111">)</span> <span style="color:#00a8c8">bool</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ......</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 并发清扫</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">lock</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">sweep</span><span style="color:#111">.</span><span style="color:#75af00">lock</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">sweep</span><span style="color:#111">.</span><span style="color:#75af00">parked</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">sweep</span><span style="color:#111">.</span><span style="color:#75af00">parked</span> <span style="color:#111">=</span> <span style="color:#00a8c8">false</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">ready</span><span style="color:#111">(</span><span style="color:#75af00">sweep</span><span style="color:#111">.</span><span style="color:#75af00">g</span><span style="color:#111">,</span> <span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#00a8c8">true</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">unlock</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">sweep</span><span style="color:#111">.</span><span style="color:#75af00">lock</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">false</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>sweep.g 的创建</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">var</span> <span style="color:#75af00">sweep</span> <span style="color:#75af00">sweepdata</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">sweepdata</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">g</span>      <span style="color:#f92672">*</span><span style="color:#75af00">g</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 在 runtime main 中调用了gcenable()</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">gcenable</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">c</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">chan</span> <span style="color:#00a8c8">int</span><span style="color:#111">,</span> <span style="color:#ae81ff">2</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">go</span> <span style="color:#75af00">bgsweep</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">go</span> <span style="color:#75af00">bgscavenge</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">&lt;-</span><span style="color:#75af00">c</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">&lt;-</span><span style="color:#75af00">c</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">memstats</span><span style="color:#111">.</span><span style="color:#75af00">enablegc</span> <span style="color:#111">=</span> <span style="color:#00a8c8">true</span> 
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="bgscavenge">bgscavenge</h3>
<p>从 OS 申请到 _heap 上的内存 不用了 还回去一些</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">bgscavenge</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#00a8c8">chan</span> <span style="color:#00a8c8">int</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">scavenger</span><span style="color:#111">.</span><span style="color:#75af00">init</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">c</span> <span style="color:#f92672">&lt;-</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 等待</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">scavenger</span><span style="color:#111">.</span><span style="color:#75af00">park</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 执行一次清理 (scavenge) 操作，返回释放的内存量和本次操作的耗时</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">released</span><span style="color:#111">,</span> <span style="color:#75af00">workTime</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">scavenger</span><span style="color:#111">.</span><span style="color:#75af00">run</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 没有释放内存，休眠</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">released</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">scavenger</span><span style="color:#111">.</span><span style="color:#75af00">park</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">continue</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 如果释放了内存，将释放的内存量和耗时记录到统计信息中</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">mheap_</span><span style="color:#111">.</span><span style="color:#75af00">pages</span><span style="color:#111">.</span><span style="color:#75af00">scav</span><span style="color:#111">.</span><span style="color:#75af00">releasedBg</span><span style="color:#111">.</span><span style="color:#75af00">Add</span><span style="color:#111">(</span><span style="color:#75af00">released</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">scavenger</span><span style="color:#111">.</span><span style="color:#75af00">sleep</span><span style="color:#111">(</span><span style="color:#75af00">workTime</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h4 id="scavengerrun">scavenger.run</h4>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">s</span> <span style="color:#f92672">*</span><span style="color:#75af00">scavengerState</span><span style="color:#111">)</span> <span style="color:#75af00">run</span><span style="color:#111">()</span> <span style="color:#111">(</span><span style="color:#75af00">released</span> <span style="color:#00a8c8">uintptr</span><span style="color:#111">,</span> <span style="color:#75af00">worked</span> <span style="color:#00a8c8">float64</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">worked</span> <span style="color:#111">&lt;</span> <span style="color:#75af00">minScavWorkTime</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 如果需要停止，就停止</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">shouldStop</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">break</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">const</span> <span style="color:#75af00">scavengeQuantum</span> <span style="color:#111">=</span> <span style="color:#ae81ff">64</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">r</span><span style="color:#111">,</span> <span style="color:#75af00">duration</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">scavenge</span><span style="color:#111">(</span><span style="color:#75af00">scavengeQuantum</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">const</span> <span style="color:#75af00">approxWorkedNSPerPhysicalPage</span> <span style="color:#111">=</span> <span style="color:#ae81ff">10e3</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">duration</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">worked</span> <span style="color:#f92672">+=</span> <span style="color:#75af00">approxWorkedNSPerPhysicalPage</span> <span style="color:#f92672">*</span> <span style="color:#111">float64</span><span style="color:#111">(</span><span style="color:#75af00">r</span><span style="color:#f92672">/</span><span style="color:#75af00">physPageSize</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">worked</span> <span style="color:#f92672">+=</span> <span style="color:#111">float64</span><span style="color:#111">(</span><span style="color:#75af00">duration</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">released</span> <span style="color:#f92672">+=</span> <span style="color:#75af00">r</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h4 id="sscavenge">s.scavenge</h4>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">scavenge</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">scavenge</span> <span style="color:#111">=</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">n</span> <span style="color:#00a8c8">uintptr</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#00a8c8">uintptr</span><span style="color:#111">,</span> <span style="color:#00a8c8">int64</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">start</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">nanotime</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">r</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">mheap_</span><span style="color:#111">.</span><span style="color:#75af00">pages</span><span style="color:#111">.</span><span style="color:#75af00">scavenge</span><span style="color:#111">(</span><span style="color:#75af00">n</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#00a8c8">false</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">end</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">nanotime</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">start</span> <span style="color:#f92672">&gt;=</span> <span style="color:#75af00">end</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">return</span> <span style="color:#75af00">r</span><span style="color:#111">,</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">scavenge</span><span style="color:#111">.</span><span style="color:#75af00">backgroundTime</span><span style="color:#111">.</span><span style="color:#75af00">Add</span><span style="color:#111">(</span><span style="color:#75af00">end</span> <span style="color:#f92672">-</span> <span style="color:#75af00">start</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#75af00">r</span><span style="color:#111">,</span> <span style="color:#75af00">end</span> <span style="color:#f92672">-</span> <span style="color:#75af00">start</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">p</span> <span style="color:#f92672">*</span><span style="color:#75af00">pageAlloc</span><span style="color:#111">)</span> <span style="color:#75af00">scavenge</span><span style="color:#111">(</span><span style="color:#75af00">nbytes</span> <span style="color:#00a8c8">uintptr</span><span style="color:#111">,</span> <span style="color:#75af00">shouldStop</span> <span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#00a8c8">bool</span><span style="color:#111">,</span> <span style="color:#75af00">force</span> <span style="color:#00a8c8">bool</span><span style="color:#111">)</span> <span style="color:#00a8c8">uintptr</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">released</span> <span style="color:#f92672">:=</span> <span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#ae81ff">0</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">released</span> <span style="color:#111">&lt;</span> <span style="color:#75af00">nbytes</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">ci</span><span style="color:#111">,</span> <span style="color:#75af00">pageIdx</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">scav</span><span style="color:#111">.</span><span style="color:#75af00">index</span><span style="color:#111">.</span><span style="color:#75af00">find</span><span style="color:#111">(</span><span style="color:#75af00">force</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">ci</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">break</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">systemstack</span><span style="color:#111">(</span><span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">released</span> <span style="color:#f92672">+=</span> <span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">scavengeOne</span><span style="color:#111">(</span><span style="color:#75af00">ci</span><span style="color:#111">,</span> <span style="color:#75af00">pageIdx</span><span style="color:#111">,</span> <span style="color:#75af00">nbytes</span><span style="color:#f92672">-</span><span style="color:#75af00">released</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">shouldStop</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">shouldStop</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">break</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">released</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h4 id="scavengeone">scavengeOne</h4>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">p</span> <span style="color:#f92672">*</span><span style="color:#75af00">pageAlloc</span><span style="color:#111">)</span> <span style="color:#75af00">scavengeOne</span><span style="color:#111">(</span><span style="color:#75af00">ci</span> <span style="color:#75af00">chunkIdx</span><span style="color:#111">,</span> <span style="color:#75af00">searchIdx</span> <span style="color:#00a8c8">uint</span><span style="color:#111">,</span> <span style="color:#75af00">max</span> <span style="color:#00a8c8">uintptr</span><span style="color:#111">)</span> <span style="color:#00a8c8">uintptr</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">maxPages</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">max</span> <span style="color:#f92672">/</span> <span style="color:#75af00">pageSize</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">max</span><span style="color:#f92672">%</span><span style="color:#75af00">pageSize</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">maxPages</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">minPages</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">physPageSize</span> <span style="color:#f92672">/</span> <span style="color:#75af00">pageSize</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">minPages</span> <span style="color:#111">&lt;</span> <span style="color:#ae81ff">1</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">minPages</span> <span style="color:#111">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">lock</span><span style="color:#111">(</span><span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">mheapLock</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">summary</span><span style="color:#111">[</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">summary</span><span style="color:#111">)</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">][</span><span style="color:#75af00">ci</span><span style="color:#111">].</span><span style="color:#111">max</span><span style="color:#111">()</span> <span style="color:#f92672">&gt;=</span> <span style="color:#111">uint</span><span style="color:#111">(</span><span style="color:#75af00">minPages</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 找到回收的开始地址 和页数</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">base</span><span style="color:#111">,</span> <span style="color:#75af00">npages</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">chunkOf</span><span style="color:#111">(</span><span style="color:#75af00">ci</span><span style="color:#111">).</span><span style="color:#75af00">findScavengeCandidate</span><span style="color:#111">(</span><span style="color:#75af00">searchIdx</span><span style="color:#111">,</span> <span style="color:#75af00">minPages</span><span style="color:#111">,</span> <span style="color:#75af00">maxPages</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// If we found something, scavenge it and return!</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">npages</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// ......</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">unlock</span><span style="color:#111">(</span><span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">mheapLock</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">test</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// 系统调用</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">sysUnused</span><span style="color:#111">(</span><span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">(</span><span style="color:#75af00">addr</span><span style="color:#111">),</span> <span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">npages</span><span style="color:#111">)</span><span style="color:#f92672">*</span><span style="color:#75af00">pageSize</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// ......</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 更新统计信息</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">lock</span><span style="color:#111">(</span><span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">mheapLock</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">b</span> <span style="color:#f92672">:=</span> <span style="color:#111">(</span><span style="color:#75af00">offAddr</span><span style="color:#111">{</span><span style="color:#75af00">addr</span><span style="color:#111">});</span> <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">lessThan</span><span style="color:#111">(</span><span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">searchAddr</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">searchAddr</span> <span style="color:#111">=</span> <span style="color:#75af00">b</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">chunkOf</span><span style="color:#111">(</span><span style="color:#75af00">ci</span><span style="color:#111">).</span><span style="color:#75af00">free</span><span style="color:#111">(</span><span style="color:#75af00">base</span><span style="color:#111">,</span> <span style="color:#75af00">npages</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">update</span><span style="color:#111">(</span><span style="color:#75af00">addr</span><span style="color:#111">,</span> <span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">npages</span><span style="color:#111">),</span> <span style="color:#00a8c8">true</span><span style="color:#111">,</span> <span style="color:#00a8c8">false</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// Mark the range as scavenged.</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">chunkOf</span><span style="color:#111">(</span><span style="color:#75af00">ci</span><span style="color:#111">).</span><span style="color:#75af00">scavenged</span><span style="color:#111">.</span><span style="color:#75af00">setRange</span><span style="color:#111">(</span><span style="color:#75af00">base</span><span style="color:#111">,</span> <span style="color:#75af00">npages</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">unlock</span><span style="color:#111">(</span><span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">mheapLock</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">npages</span><span style="color:#111">)</span> <span style="color:#f92672">*</span> <span style="color:#75af00">pageSize</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">scav</span><span style="color:#111">.</span><span style="color:#75af00">index</span><span style="color:#111">.</span><span style="color:#75af00">setEmpty</span><span style="color:#111">(</span><span style="color:#75af00">ci</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">unlock</span><span style="color:#111">(</span><span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">mheapLock</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="bgsweep">bgsweep</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">bgsweep</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#00a8c8">chan</span> <span style="color:#00a8c8">int</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">sweep</span><span style="color:#111">.</span><span style="color:#75af00">g</span> <span style="color:#111">=</span> <span style="color:#75af00">getg</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">lockInit</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">sweep</span><span style="color:#111">.</span><span style="color:#75af00">lock</span><span style="color:#111">,</span> <span style="color:#75af00">lockRankSweep</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">lock</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">sweep</span><span style="color:#111">.</span><span style="color:#75af00">lock</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">sweep</span><span style="color:#111">.</span><span style="color:#75af00">parked</span> <span style="color:#111">=</span> <span style="color:#00a8c8">true</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">c</span> <span style="color:#f92672">&lt;-</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 休眠 等待gc 完成 唤醒它</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">goparkunlock</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">sweep</span><span style="color:#111">.</span><span style="color:#75af00">lock</span><span style="color:#111">,</span> <span style="color:#75af00">waitReasonGCSweepWait</span><span style="color:#111">,</span> <span style="color:#75af00">traceBlockGCSweep</span><span style="color:#111">,</span> <span style="color:#ae81ff">1</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 执行一次清扫操作</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">for</span> <span style="color:#75af00">sweepone</span><span style="color:#111">()</span> <span style="color:#f92672">!=</span> <span style="color:#111">^</span><span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#ae81ff">0</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">nSwept</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 每清扫一定数量对象，就尝试让出 CPU</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">nSwept</span><span style="color:#f92672">%</span><span style="color:#75af00">sweepBatchSize</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">goschedIfBusy</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 释放一些写缓冲区</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">for</span> <span style="color:#75af00">freeSomeWbufs</span><span style="color:#111">(</span><span style="color:#00a8c8">true</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">goschedIfBusy</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">lock</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">sweep</span><span style="color:#111">.</span><span style="color:#75af00">lock</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 检查是否完成了所有扫描任务。</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">isSweepDone</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">unlock</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">sweep</span><span style="color:#111">.</span><span style="color:#75af00">lock</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">continue</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">sweep</span><span style="color:#111">.</span><span style="color:#75af00">parked</span> <span style="color:#111">=</span> <span style="color:#00a8c8">true</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 休眠 等待下一次 gc 标记完成唤醒它</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">goparkunlock</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">sweep</span><span style="color:#111">.</span><span style="color:#75af00">lock</span><span style="color:#111">,</span> <span style="color:#75af00">waitReasonGCSweepWait</span><span style="color:#111">,</span> <span style="color:#75af00">traceBlockGCSweep</span><span style="color:#111">,</span> <span style="color:#ae81ff">1</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h4 id="sweepone">sweepone</h4>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">sweepone</span><span style="color:#111">()</span> <span style="color:#00a8c8">uintptr</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">gp</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">getg</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">gp</span><span style="color:#111">.</span><span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">locks</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">sl</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">sweep</span><span style="color:#111">.</span><span style="color:#75af00">active</span><span style="color:#111">.</span><span style="color:#75af00">begin</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">sl</span><span style="color:#111">.</span><span style="color:#75af00">valid</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">gp</span><span style="color:#111">.</span><span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">locks</span><span style="color:#f92672">--</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#111">^</span><span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#ae81ff">0</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Find a span to sweep.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">npages</span> <span style="color:#f92672">:=</span> <span style="color:#111">^</span><span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#ae81ff">0</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">var</span> <span style="color:#75af00">noMoreWork</span> <span style="color:#00a8c8">bool</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 查找 span</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">s</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">mheap_</span><span style="color:#111">.</span><span style="color:#75af00">nextSpanForSweep</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">s</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">noMoreWork</span> <span style="color:#111">=</span> <span style="color:#75af00">sweep</span><span style="color:#111">.</span><span style="color:#75af00">active</span><span style="color:#111">.</span><span style="color:#75af00">markDrained</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">break</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 试着清扫</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">s</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">sl</span><span style="color:#111">.</span><span style="color:#75af00">tryAcquire</span><span style="color:#111">(</span><span style="color:#75af00">s</span><span style="color:#111">);</span> <span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// Sweep the span we found.</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">npages</span> <span style="color:#111">=</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">npages</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">sweep</span><span style="color:#111">(</span><span style="color:#00a8c8">false</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">mheap_</span><span style="color:#111">.</span><span style="color:#75af00">reclaimCredit</span><span style="color:#111">.</span><span style="color:#75af00">Add</span><span style="color:#111">(</span><span style="color:#75af00">npages</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">npages</span> <span style="color:#111">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">break</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">sweep</span><span style="color:#111">.</span><span style="color:#75af00">active</span><span style="color:#111">.</span><span style="color:#75af00">end</span><span style="color:#111">(</span><span style="color:#75af00">sl</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ......</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">gp</span><span style="color:#111">.</span><span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">locks</span><span style="color:#f92672">--</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">npages</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>sweep 主要逻辑是把 刚刚标记过的 gcmarkBits 复制给 allocBits</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">sl</span> <span style="color:#f92672">*</span><span style="color:#75af00">sweepLocked</span><span style="color:#111">)</span> <span style="color:#75af00">sweep</span><span style="color:#111">(</span><span style="color:#75af00">preserve</span> <span style="color:#00a8c8">bool</span><span style="color:#111">)</span> <span style="color:#00a8c8">bool</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ......</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">allocBits</span> <span style="color:#111">=</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">gcmarkBits</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">gcmarkBits</span> <span style="color:#111">=</span> <span style="color:#75af00">newMarkBits</span><span style="color:#111">(</span><span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">nelems</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ......</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h4 id="分配内存">分配内存</h4>
<p>如果我们的 span 标记之后 还没来得及清扫，修改了 allocBits 值，然后再清扫会出问题。go 是怎么解决的呢？</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// 拿 span 的时候会检查 如果没清扫就先清扫一下 再使用内存</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">mcentral</span><span style="color:#111">)</span> <span style="color:#75af00">cacheSpan</span><span style="color:#111">()</span> <span style="color:#f92672">*</span><span style="color:#75af00">mspan</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ......</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">s</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">sl</span><span style="color:#111">.</span><span style="color:#75af00">tryAcquire</span><span style="color:#111">(</span><span style="color:#75af00">s</span><span style="color:#111">);</span> <span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// We got ownership of the span, so let&#39;s sweep it.</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">sweep</span><span style="color:#111">(</span><span style="color:#00a8c8">true</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ......</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">h</span> <span style="color:#f92672">*</span><span style="color:#75af00">mheap</span><span style="color:#111">)</span> <span style="color:#75af00">alloc</span><span style="color:#111">(</span><span style="color:#75af00">npages</span> <span style="color:#00a8c8">uintptr</span><span style="color:#111">,</span> <span style="color:#75af00">spanclass</span> <span style="color:#75af00">spanClass</span><span style="color:#111">)</span> <span style="color:#f92672">*</span><span style="color:#75af00">mspan</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">var</span> <span style="color:#75af00">s</span> <span style="color:#f92672">*</span><span style="color:#75af00">mspan</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">systemstack</span><span style="color:#111">(</span><span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">isSweepDone</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">reclaim</span><span style="color:#111">(</span><span style="color:#75af00">npages</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">s</span> <span style="color:#111">=</span> <span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">allocSpan</span><span style="color:#111">(</span><span style="color:#75af00">npages</span><span style="color:#111">,</span> <span style="color:#75af00">spanAllocHeap</span><span style="color:#111">,</span> <span style="color:#75af00">spanclass</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">s</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">h</span> <span style="color:#f92672">*</span><span style="color:#75af00">mheap</span><span style="color:#111">)</span> <span style="color:#75af00">reclaim</span><span style="color:#111">(</span><span style="color:#75af00">npage</span> <span style="color:#00a8c8">uintptr</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ......</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">nfound</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">reclaimChunk</span><span style="color:#111">(</span><span style="color:#75af00">arenas</span><span style="color:#111">,</span> <span style="color:#75af00">idx</span><span style="color:#111">,</span> <span style="color:#75af00">pagesPerReclaimerChunk</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ......</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">h</span> <span style="color:#f92672">*</span><span style="color:#75af00">mheap</span><span style="color:#111">)</span> <span style="color:#75af00">reclaimChunk</span><span style="color:#111">(</span><span style="color:#75af00">arenas</span> <span style="color:#111">[]</span><span style="color:#f92672">*</span><span style="color:#75af00">pageAlloc</span><span style="color:#111">,</span> <span style="color:#75af00">idx</span><span style="color:#111">,</span> <span style="color:#75af00">npages</span> <span style="color:#00a8c8">uintptr</span><span style="color:#111">)</span> <span style="color:#00a8c8">uintptr</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ......</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">sweep</span><span style="color:#111">(</span><span style="color:#00a8c8">false</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ......</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div>]]></content:encoded><category>go</category><category>go</category></item><item><title>go 内存管理</title><link>https://daemon365.dev/post/go/go_memory_code/</link><pubDate>Tue, 10 Dec 2024 20:55:56 +0800</pubDate><guid>https://daemon365.dev/post/go/go_memory_code/</guid><description>&lt;h2 id="操作系统内存管理"&gt;操作系统内存管理&lt;/h2&gt;
&lt;p&gt;操作系统管理内存的存储单元是页（page），在 linux 中一般是 4KB。而且，操作系统还会使用 &lt;code&gt;虚拟内存&lt;/code&gt; 来管理内存，在用户程序中，我们看到的内存是不是真实的内存，而是虚拟内存。当访问或者修改内存的时候，操作系统会将虚拟内存映射到真实的内存中。申请内存的组件是 Page Table 和 MMU（Memory Management Unit）。因为这个性能很重要，所以在 CPU 中专门有一个 TLB（Translation Lookaside Buffer）来缓存 Page Table 的内容。&lt;/p&gt;
&lt;p&gt;为什么要用虚拟内存？&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;保护内存，每个进程都有自己的虚拟内存，不会相互干扰。防止修改和访问别的进程的内存。&lt;/li&gt;
&lt;li&gt;减少内存碎片，虚拟内存是连续的，而真实的内存是不连续的。&lt;/li&gt;
&lt;li&gt;当内存不够时，可以把虚拟内存映射到硬盘上，这样就可以使用硬盘的空间来扩展内存。&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;img src="https://daemon365.dev/images/virtual_memory.png" alt=""&gt;&lt;/p&gt;
&lt;p&gt;如上图所示，如果直接使用真实的内存，想要连续的内存肯定是申请不到的，这就是内存碎片的问题。而使用虚拟内存，通过 Page 映射的方式，保证内存连续。&lt;/p&gt;
&lt;h2 id="go-内存管理单元"&gt;Go 内存管理单元&lt;/h2&gt;
&lt;h3 id="page"&gt;page&lt;/h3&gt;
&lt;p&gt;在 go 中，管理内存的存储单元也是页（Page）, 每个页的大小是 8KB。Go 内存管理是由 runtime 来管理的，runtime 会维护一个内存池，用来分配和回收内存。这样可以避免频繁的系统调用申请内存，提高性能。&lt;/p&gt;
&lt;h3 id="mspan"&gt;mspan&lt;/h3&gt;
&lt;p&gt;mspan 是 go 内存管理基本单元，一个 mspan 包含一个或者多个 page。go 中有多种 mspan，每种 mspan 给不同的内存大小使用。&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;class&lt;/th&gt;
&lt;th&gt;bytes/obj&lt;/th&gt;
&lt;th&gt;bytes/span&lt;/th&gt;
&lt;th&gt;objects&lt;/th&gt;
&lt;th&gt;tail waste&lt;/th&gt;
&lt;th&gt;max waste&lt;/th&gt;
&lt;th&gt;min align&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;td&gt;8&lt;/td&gt;
&lt;td&gt;8192&lt;/td&gt;
&lt;td&gt;1024&lt;/td&gt;
&lt;td&gt;0&lt;/td&gt;
&lt;td&gt;87.50%&lt;/td&gt;
&lt;td&gt;8&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;2&lt;/td&gt;
&lt;td&gt;16&lt;/td&gt;
&lt;td&gt;8192&lt;/td&gt;
&lt;td&gt;512&lt;/td&gt;
&lt;td&gt;0&lt;/td&gt;
&lt;td&gt;43.75%&lt;/td&gt;
&lt;td&gt;16&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;3&lt;/td&gt;
&lt;td&gt;24&lt;/td&gt;
&lt;td&gt;8192&lt;/td&gt;
&lt;td&gt;341&lt;/td&gt;
&lt;td&gt;8&lt;/td&gt;
&lt;td&gt;29.24%&lt;/td&gt;
&lt;td&gt;8&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;4&lt;/td&gt;
&lt;td&gt;32&lt;/td&gt;
&lt;td&gt;8192&lt;/td&gt;
&lt;td&gt;256&lt;/td&gt;
&lt;td&gt;0&lt;/td&gt;
&lt;td&gt;21.88%&lt;/td&gt;
&lt;td&gt;32&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;5&lt;/td&gt;
&lt;td&gt;48&lt;/td&gt;
&lt;td&gt;8192&lt;/td&gt;
&lt;td&gt;170&lt;/td&gt;
&lt;td&gt;32&lt;/td&gt;
&lt;td&gt;31.52%&lt;/td&gt;
&lt;td&gt;16&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;6&lt;/td&gt;
&lt;td&gt;64&lt;/td&gt;
&lt;td&gt;8192&lt;/td&gt;
&lt;td&gt;128&lt;/td&gt;
&lt;td&gt;0&lt;/td&gt;
&lt;td&gt;23.44%&lt;/td&gt;
&lt;td&gt;64&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;7&lt;/td&gt;
&lt;td&gt;80&lt;/td&gt;
&lt;td&gt;8192&lt;/td&gt;
&lt;td&gt;102&lt;/td&gt;
&lt;td&gt;32&lt;/td&gt;
&lt;td&gt;19.07%&lt;/td&gt;
&lt;td&gt;16&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;8&lt;/td&gt;
&lt;td&gt;96&lt;/td&gt;
&lt;td&gt;8192&lt;/td&gt;
&lt;td&gt;85&lt;/td&gt;
&lt;td&gt;32&lt;/td&gt;
&lt;td&gt;15.95%&lt;/td&gt;
&lt;td&gt;32&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;9&lt;/td&gt;
&lt;td&gt;112&lt;/td&gt;
&lt;td&gt;8192&lt;/td&gt;
&lt;td&gt;73&lt;/td&gt;
&lt;td&gt;16&lt;/td&gt;
&lt;td&gt;13.56%&lt;/td&gt;
&lt;td&gt;16&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&amp;hellip;&lt;/td&gt;
&lt;td&gt;&amp;hellip;&lt;/td&gt;
&lt;td&gt;&amp;hellip;&lt;/td&gt;
&lt;td&gt;&amp;hellip;&lt;/td&gt;
&lt;td&gt;&amp;hellip;&lt;/td&gt;
&lt;td&gt;&amp;hellip;&lt;/td&gt;
&lt;td&gt;&amp;hellip;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;64&lt;/td&gt;
&lt;td&gt;24576&lt;/td&gt;
&lt;td&gt;24576&lt;/td&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;td&gt;0&lt;/td&gt;
&lt;td&gt;11.45%&lt;/td&gt;
&lt;td&gt;8192&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;65&lt;/td&gt;
&lt;td&gt;27264&lt;/td&gt;
&lt;td&gt;81920&lt;/td&gt;
&lt;td&gt;3&lt;/td&gt;
&lt;td&gt;128&lt;/td&gt;
&lt;td&gt;10.00%&lt;/td&gt;
&lt;td&gt;128&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;66&lt;/td&gt;
&lt;td&gt;28672&lt;/td&gt;
&lt;td&gt;57344&lt;/td&gt;
&lt;td&gt;2&lt;/td&gt;
&lt;td&gt;0&lt;/td&gt;
&lt;td&gt;4.91%&lt;/td&gt;
&lt;td&gt;4096&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;67&lt;/td&gt;
&lt;td&gt;32768&lt;/td&gt;
&lt;td&gt;32768&lt;/td&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;td&gt;0&lt;/td&gt;
&lt;td&gt;12.50%&lt;/td&gt;
&lt;td&gt;8192&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;ol&gt;
&lt;li&gt;class 是 mspan 的类型，每种类型对应不同的内存大小。&lt;/li&gt;
&lt;li&gt;obj 是每个对象的大小。&lt;/li&gt;
&lt;li&gt;span 是 mspan 的大小。&lt;/li&gt;
&lt;li&gt;objects 是 mspan 中对象的个数。&lt;/li&gt;
&lt;li&gt;tail waste 是 mspan 中最后一个对象的浪费空间。（不能整除造成的）&lt;/li&gt;
&lt;li&gt;max waste 是 mspan 中最大的浪费空间。（比如第一个中 每个都使用 1 byte，那么就所有都浪费 7 byte,7 / 8 = 87.50%）&lt;/li&gt;
&lt;li&gt;min align 是 mspan 中对象的对齐大小。如果超过这个就会分配下一个 mspan。&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id="数据结构"&gt;数据结构&lt;/h2&gt;
&lt;h3 id="mspan-1"&gt;mspan&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;type&lt;/span&gt; &lt;span style="color:#75af00"&gt;mspan&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;struct&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// 双向链表 下一个 mspan 和 上一个 mspan&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;next&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;mspan&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;prev&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;mspan&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// debug 使用的&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;list&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;mSpanList&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// 起始地址和页数 当 class 太大 要多个页组成 mspan&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;startAddr&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;uintptr&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;npages&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;uintptr&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// 手动管理的空闲对象链表&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;manualFreeList&lt;/span&gt; &lt;span style="color:#75af00"&gt;gclinkptr&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// 下一个空闲对象的地址 如果小于它 就不用检索了 直接从这个地址开始 提高效率&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;freeindex&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;uint16&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// 对象的个数&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;nelems&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;uint16&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// GC 扫描使用的空闲索引&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;freeIndexForScan&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;uint16&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// bitmap 每个 bit 对应一个对象 标记是否使用&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;allocCache&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;uint64&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// ...&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// span 的类型 &lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;spanclass&lt;/span&gt; &lt;span style="color:#75af00"&gt;spanClass&lt;/span&gt; &lt;span style="color:#75715e"&gt;// size class and noscan (uint8)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// ...&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h4 id="spanclass"&gt;spanClass&lt;/h4&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;type&lt;/span&gt; &lt;span style="color:#75af00"&gt;spanClass&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;uint8&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;makeSpanClass&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;sizeclass&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;uint8&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;noscan&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;bool&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75af00"&gt;spanClass&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt; &lt;span style="color:#75af00"&gt;spanClass&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;sizeclass&lt;/span&gt;&lt;span style="color:#f92672"&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;1&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#111"&gt;|&lt;/span&gt; &lt;span style="color:#75af00"&gt;spanClass&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;bool2int&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;noscan&lt;/span&gt;&lt;span style="color:#111"&gt;))&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;//go:nosplit&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;sc&lt;/span&gt; &lt;span style="color:#75af00"&gt;spanClass&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75af00"&gt;sizeclass&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;int8&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt; &lt;span style="color:#111"&gt;int8&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;sc&lt;/span&gt; &lt;span style="color:#f92672"&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;1&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;//go:nosplit&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;sc&lt;/span&gt; &lt;span style="color:#75af00"&gt;spanClass&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75af00"&gt;noscan&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;bool&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt; &lt;span style="color:#75af00"&gt;sc&lt;/span&gt;&lt;span style="color:#f92672"&gt;&amp;amp;&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;1&lt;/span&gt; &lt;span style="color:#f92672"&gt;!=&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;0&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;spanClass 是 unint8 类型，一共有 8 位，前 7 位是 sizeclass，也就是上边 table 中的内容，一共有 &lt;code&gt;(67 + 1) * 2&lt;/code&gt; 种类型, +1 是 0 代表比 67 class 的内存还大。最后一位是 noscan，也就是表示这个对象中是否含有指针，用来给 GC 扫描加速用的（无指针对象就不用继续扫描了），所以要 * 2。&lt;/p&gt;</description><content:encoded><![CDATA[<h2 id="操作系统内存管理">操作系统内存管理</h2>
<p>操作系统管理内存的存储单元是页（page），在 linux 中一般是 4KB。而且，操作系统还会使用 <code>虚拟内存</code> 来管理内存，在用户程序中，我们看到的内存是不是真实的内存，而是虚拟内存。当访问或者修改内存的时候，操作系统会将虚拟内存映射到真实的内存中。申请内存的组件是 Page Table 和 MMU（Memory Management Unit）。因为这个性能很重要，所以在 CPU 中专门有一个 TLB（Translation Lookaside Buffer）来缓存 Page Table 的内容。</p>
<p>为什么要用虚拟内存？</p>
<ol>
<li>保护内存，每个进程都有自己的虚拟内存，不会相互干扰。防止修改和访问别的进程的内存。</li>
<li>减少内存碎片，虚拟内存是连续的，而真实的内存是不连续的。</li>
<li>当内存不够时，可以把虚拟内存映射到硬盘上，这样就可以使用硬盘的空间来扩展内存。</li>
</ol>
<p><img src="/images/virtual_memory.png" alt=""></p>
<p>如上图所示，如果直接使用真实的内存，想要连续的内存肯定是申请不到的，这就是内存碎片的问题。而使用虚拟内存，通过 Page 映射的方式，保证内存连续。</p>
<h2 id="go-内存管理单元">Go 内存管理单元</h2>
<h3 id="page">page</h3>
<p>在 go 中，管理内存的存储单元也是页（Page）, 每个页的大小是 8KB。Go 内存管理是由 runtime 来管理的，runtime 会维护一个内存池，用来分配和回收内存。这样可以避免频繁的系统调用申请内存，提高性能。</p>
<h3 id="mspan">mspan</h3>
<p>mspan 是 go 内存管理基本单元，一个 mspan 包含一个或者多个 page。go 中有多种 mspan，每种 mspan 给不同的内存大小使用。</p>
<table>
  <thead>
      <tr>
          <th>class</th>
          <th>bytes/obj</th>
          <th>bytes/span</th>
          <th>objects</th>
          <th>tail waste</th>
          <th>max waste</th>
          <th>min align</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>1</td>
          <td>8</td>
          <td>8192</td>
          <td>1024</td>
          <td>0</td>
          <td>87.50%</td>
          <td>8</td>
      </tr>
      <tr>
          <td>2</td>
          <td>16</td>
          <td>8192</td>
          <td>512</td>
          <td>0</td>
          <td>43.75%</td>
          <td>16</td>
      </tr>
      <tr>
          <td>3</td>
          <td>24</td>
          <td>8192</td>
          <td>341</td>
          <td>8</td>
          <td>29.24%</td>
          <td>8</td>
      </tr>
      <tr>
          <td>4</td>
          <td>32</td>
          <td>8192</td>
          <td>256</td>
          <td>0</td>
          <td>21.88%</td>
          <td>32</td>
      </tr>
      <tr>
          <td>5</td>
          <td>48</td>
          <td>8192</td>
          <td>170</td>
          <td>32</td>
          <td>31.52%</td>
          <td>16</td>
      </tr>
      <tr>
          <td>6</td>
          <td>64</td>
          <td>8192</td>
          <td>128</td>
          <td>0</td>
          <td>23.44%</td>
          <td>64</td>
      </tr>
      <tr>
          <td>7</td>
          <td>80</td>
          <td>8192</td>
          <td>102</td>
          <td>32</td>
          <td>19.07%</td>
          <td>16</td>
      </tr>
      <tr>
          <td>8</td>
          <td>96</td>
          <td>8192</td>
          <td>85</td>
          <td>32</td>
          <td>15.95%</td>
          <td>32</td>
      </tr>
      <tr>
          <td>9</td>
          <td>112</td>
          <td>8192</td>
          <td>73</td>
          <td>16</td>
          <td>13.56%</td>
          <td>16</td>
      </tr>
      <tr>
          <td>&hellip;</td>
          <td>&hellip;</td>
          <td>&hellip;</td>
          <td>&hellip;</td>
          <td>&hellip;</td>
          <td>&hellip;</td>
          <td>&hellip;</td>
      </tr>
      <tr>
          <td>64</td>
          <td>24576</td>
          <td>24576</td>
          <td>1</td>
          <td>0</td>
          <td>11.45%</td>
          <td>8192</td>
      </tr>
      <tr>
          <td>65</td>
          <td>27264</td>
          <td>81920</td>
          <td>3</td>
          <td>128</td>
          <td>10.00%</td>
          <td>128</td>
      </tr>
      <tr>
          <td>66</td>
          <td>28672</td>
          <td>57344</td>
          <td>2</td>
          <td>0</td>
          <td>4.91%</td>
          <td>4096</td>
      </tr>
      <tr>
          <td>67</td>
          <td>32768</td>
          <td>32768</td>
          <td>1</td>
          <td>0</td>
          <td>12.50%</td>
          <td>8192</td>
      </tr>
  </tbody>
</table>
<ol>
<li>class 是 mspan 的类型，每种类型对应不同的内存大小。</li>
<li>obj 是每个对象的大小。</li>
<li>span 是 mspan 的大小。</li>
<li>objects 是 mspan 中对象的个数。</li>
<li>tail waste 是 mspan 中最后一个对象的浪费空间。（不能整除造成的）</li>
<li>max waste 是 mspan 中最大的浪费空间。（比如第一个中 每个都使用 1 byte，那么就所有都浪费 7 byte,7 / 8 = 87.50%）</li>
<li>min align 是 mspan 中对象的对齐大小。如果超过这个就会分配下一个 mspan。</li>
</ol>
<h2 id="数据结构">数据结构</h2>
<h3 id="mspan-1">mspan</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">mspan</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 双向链表 下一个 mspan 和 上一个 mspan</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">next</span> <span style="color:#f92672">*</span><span style="color:#75af00">mspan</span>    
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">prev</span> <span style="color:#f92672">*</span><span style="color:#75af00">mspan</span>    
</span></span><span style="display:flex;"><span>  	<span style="color:#75715e">// debug 使用的</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">list</span> <span style="color:#f92672">*</span><span style="color:#75af00">mSpanList</span> 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  	<span style="color:#75715e">// 起始地址和页数 当 class 太大 要多个页组成 mspan</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">startAddr</span> <span style="color:#00a8c8">uintptr</span> 
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">npages</span>    <span style="color:#00a8c8">uintptr</span> 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  	<span style="color:#75715e">// 手动管理的空闲对象链表</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">manualFreeList</span> <span style="color:#75af00">gclinkptr</span> 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 下一个空闲对象的地址 如果小于它 就不用检索了 直接从这个地址开始 提高效率</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">freeindex</span> <span style="color:#00a8c8">uint16</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 对象的个数</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">nelems</span> <span style="color:#00a8c8">uint16</span> 
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// GC 扫描使用的空闲索引</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">freeIndexForScan</span> <span style="color:#00a8c8">uint16</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// bitmap 每个 bit 对应一个对象 标记是否使用</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">allocCache</span> <span style="color:#00a8c8">uint64</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ...</span>
</span></span><span style="display:flex;"><span>  	<span style="color:#75715e">// span 的类型 </span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">spanclass</span>             <span style="color:#75af00">spanClass</span>     <span style="color:#75715e">// size class and noscan (uint8)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//  ...</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h4 id="spanclass">spanClass</h4>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">spanClass</span> <span style="color:#00a8c8">uint8</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">makeSpanClass</span><span style="color:#111">(</span><span style="color:#75af00">sizeclass</span> <span style="color:#00a8c8">uint8</span><span style="color:#111">,</span> <span style="color:#75af00">noscan</span> <span style="color:#00a8c8">bool</span><span style="color:#111">)</span> <span style="color:#75af00">spanClass</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">spanClass</span><span style="color:#111">(</span><span style="color:#75af00">sizeclass</span><span style="color:#f92672">&lt;&lt;</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span> <span style="color:#111">|</span> <span style="color:#75af00">spanClass</span><span style="color:#111">(</span><span style="color:#75af00">bool2int</span><span style="color:#111">(</span><span style="color:#75af00">noscan</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//go:nosplit</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">sc</span> <span style="color:#75af00">spanClass</span><span style="color:#111">)</span> <span style="color:#75af00">sizeclass</span><span style="color:#111">()</span> <span style="color:#00a8c8">int8</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#111">int8</span><span style="color:#111">(</span><span style="color:#75af00">sc</span> <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">1</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//go:nosplit</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">sc</span> <span style="color:#75af00">spanClass</span><span style="color:#111">)</span> <span style="color:#75af00">noscan</span><span style="color:#111">()</span> <span style="color:#00a8c8">bool</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">sc</span><span style="color:#f92672">&amp;</span><span style="color:#ae81ff">1</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>spanClass 是 unint8 类型，一共有 8 位，前 7 位是 sizeclass，也就是上边 table 中的内容，一共有 <code>(67 + 1) * 2</code> 种类型, +1 是 0 代表比 67 class 的内存还大。最后一位是 noscan，也就是表示这个对象中是否含有指针，用来给 GC 扫描加速用的（无指针对象就不用继续扫描了），所以要 * 2。</p>
<h4 id="mspan-详解">mspan 详解</h4>
<p><img src="/images/go_memory_mspan.png" alt=""></p>
<p>如果所示</p>
<ul>
<li>mspan 是一个双向链表，如果不够用了，在挂一个就行了。</li>
<li>startAddr 是 mspan 的起始地址，npages 是 page 数量。根据 startAddr + npages * 8KB 就可以得到 mspan 的结束地址。</li>
<li>allocCache 是一个 bitmap，每个 bit 对应一个对象，标记是否使用。使用了 ctz(count trailing zero)。</li>
<li>freeindex 是下一个空闲对象的地址，如果小于它，就不用检索了，直接从这个地址开始，提高效率。</li>
</ul>
<h3 id="mcache">mcache</h3>
<p>mache 是每个 P （processor）的结构体中都有的，是用来缓存的，因为每个 P 同一时间只有一个 goroutine 在执行，所以 mcache 是不需要加锁的。这也是 mcache 的设计初衷，减少锁的竞争，提高性能。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">p</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// ...</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75af00">mcache</span>      <span style="color:#f92672">*</span><span style="color:#75af00">mcache</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// ...</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// 每个 P 的本队缓存</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">mcache</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 不在 gc 的堆中分配</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">_</span> <span style="color:#75af00">sys</span><span style="color:#111">.</span><span style="color:#75af00">NotInHeap</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// The following members are accessed on every malloc,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// so they are grouped here for better caching.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">nextSample</span> <span style="color:#00a8c8">uintptr</span> <span style="color:#75715e">// trigger heap sample after allocating this many bytes</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">scanAlloc</span>  <span style="color:#00a8c8">uintptr</span> <span style="color:#75715e">// bytes of scannable heap allocated</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 微对象分配器（&lt;16B 不含指针）</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">tiny</span>       <span style="color:#00a8c8">uintptr</span> <span style="color:#75715e">// 内存的其实地址</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">tinyoffset</span> <span style="color:#00a8c8">uintptr</span> <span style="color:#75715e">// 偏移量</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">tinyAllocs</span> <span style="color:#00a8c8">uintptr</span> <span style="color:#75715e">// 分配了多少个 tiny 对象</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// span缓存数组，按大小类别索引</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">alloc</span> <span style="color:#111">[</span><span style="color:#75af00">numSpanClasses</span><span style="color:#111">]</span><span style="color:#f92672">*</span><span style="color:#75af00">mspan</span> <span style="color:#75715e">// spans to allocate from, indexed by spanClass</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 用于不同大小的栈内存分配 go 的 堆上分配栈内存</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">stackcache</span> <span style="color:#111">[</span><span style="color:#75af00">_NumStackOrders</span><span style="color:#111">]</span><span style="color:#75af00">stackfreelist</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 控制 mcache 的刷新</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">flushGen</span> <span style="color:#75af00">atomic</span><span style="color:#111">.</span><span style="color:#75af00">Uint32</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="mcentral">mcentral</h3>
<p>mcentral 也是一种缓存，只不过在中心而不是在每个 P 上。mcentral 存在的意义也是减少锁竞争，如果没有 mcentral，那么只要从中心申请 mspan 就需要加锁。现在加上了 mcentral，申请时就需要加特别力度的锁就可以了，比如申请 class = 1 的 mspan 加 class = 1 的锁就可以了，不影响别人申请 class = 2 的 mspan。这样就可以较少锁竞争，提高性能。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">mcentral</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">_</span>         <span style="color:#75af00">sys</span><span style="color:#111">.</span><span style="color:#75af00">NotInHeap</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// mspan 的类别</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">spanclass</span> <span style="color:#75af00">spanClass</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 部分使用的span列表</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 使用两个集合交替角色</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// [0] -&gt; 已清扫的spans</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// [1] -&gt; 未清扫的spans</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">partial</span> <span style="color:#111">[</span><span style="color:#ae81ff">2</span><span style="color:#111">]</span><span style="color:#75af00">spanSet</span> <span style="color:#75715e">// list of spans with a free object</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 完全使用的 mspan</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">full</span>    <span style="color:#111">[</span><span style="color:#ae81ff">2</span><span style="color:#111">]</span><span style="color:#75af00">spanSet</span> <span style="color:#75715e">// list of spans with no free objects</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">spanSet</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// spanSet是一个两级数据结构，由一个可增长的主干（spine）指向固定大小的块组成。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 访问spine不需要锁，但添加块或扩展spine时需要获取spine锁。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	// 因为每个mspan至少覆盖8K的堆内存，且在spanSet中最多占用8字节，</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 所以spine的增长是相当有限的。</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 锁</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">spineLock</span> <span style="color:#75af00">mutex</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 原子指针，指向一个动态数组</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">spine</span>     <span style="color:#75af00">atomicSpanSetSpinePointer</span> <span style="color:#75715e">// *[N]atomic.Pointer[spanSetBlock]</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 当前spine数组中实际使用的长度 原子类型</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">spineLen</span>  <span style="color:#75af00">atomic</span><span style="color:#111">.</span><span style="color:#75af00">Uintptr</span>            <span style="color:#75715e">// Spine array length</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//  spine数组的容量</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">spineCap</span>  <span style="color:#00a8c8">uintptr</span>                   <span style="color:#75715e">// Spine array cap, accessed under spineLock</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// index是spanSet中的头尾指针，被压缩在一个字段中。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// head和tail都表示所有块的逻辑连接中的索引位置，其中head总是在tail之后或等于tail</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// （等于tail时表示集合为空）。这个字段始终通过原子操作访问。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	// head和tail各自的宽度为32位，这意味着在需要重置之前，我们最多支持2^32次push操作。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 如果堆中的每个span都存储在这个集合中，且每个span都是最小尺寸（1个运行时页面，8 KiB），</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 那么大约需要32 TiB大小的堆才会导致无法表示的情况。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 头部索引</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">index</span> <span style="color:#75af00">atomicHeadTailIndex</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">mheap</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">central</span> <span style="color:#111">[</span><span style="color:#75af00">numSpanClasses</span><span style="color:#111">]</span><span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">mcentral</span> <span style="color:#75af00">mcentral</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 填充字节 一般不能整除的时候 末尾的余数就不用了</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">pad</span>      <span style="color:#111">[(</span><span style="color:#75af00">cpu</span><span style="color:#111">.</span><span style="color:#75af00">CacheLinePadSize</span> <span style="color:#f92672">-</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Sizeof</span><span style="color:#111">(</span><span style="color:#75af00">mcentral</span><span style="color:#111">{})</span><span style="color:#f92672">%</span><span style="color:#75af00">cpu</span><span style="color:#111">.</span><span style="color:#75af00">CacheLinePadSize</span><span style="color:#111">)</span> <span style="color:#f92672">%</span> <span style="color:#75af00">cpu</span><span style="color:#111">.</span><span style="color:#75af00">CacheLinePadSize</span><span style="color:#111">]</span><span style="color:#00a8c8">byte</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="mheap">mheap</h3>
<p>mheap 是全局的内存管理器，申请内存是 mcentral 不满足要求的时候，就会从 mheap 中申请，要加全局锁。如果 mheap 还不能满足，就会系统调用从操作系统申请，每次申请的最小单位是 Arena，也就是 64M。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">mheap</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">_</span> <span style="color:#75af00">sys</span><span style="color:#111">.</span><span style="color:#75af00">NotInHeap</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 全局锁</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">lock</span> <span style="color:#75af00">mutex</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// page 分配器 管理所有的page </span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">pages</span> <span style="color:#75af00">pageAlloc</span> 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">sweepgen</span> <span style="color:#00a8c8">uint32</span> <span style="color:#75715e">// sweep 代数 gc时候使用</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 所有的 mspan</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">allspans</span> <span style="color:#111">[]</span><span style="color:#f92672">*</span><span style="color:#75af00">mspan</span> 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 正在使用的 page 数</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">pagesInUse</span>         <span style="color:#75af00">atomic</span><span style="color:#111">.</span><span style="color:#75af00">Uintptr</span> 
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ......</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 用于定位内存地址是哪个 mspan 的</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 二维数组 1 &lt;&lt; arenaL1Bits = 1   1 &lt;&lt; arenaL2Bits = 4194304 </span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">arenas</span> <span style="color:#111">[</span><span style="color:#ae81ff">1</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#75af00">arenaL1Bits</span><span style="color:#111">]</span><span style="color:#f92672">*</span><span style="color:#111">[</span><span style="color:#ae81ff">1</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#75af00">arenaL2Bits</span><span style="color:#111">]</span><span style="color:#f92672">*</span><span style="color:#75af00">heapArena</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">spanalloc</span> <span style="color:#75af00">fixalloc</span>              <span style="color:#75715e">// span 分配器</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">cachealloc</span> <span style="color:#75af00">fixalloc</span>             <span style="color:#75715e">// mcache 分配器</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">specialfinalizeralloc</span> <span style="color:#75af00">fixalloc</span>  <span style="color:#75715e">// finalizer 分配器</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ......</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="heaparena">heapArena</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// A heapArena stores metadata for a heap arena. heapArenas are stored</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// outside of the Go heap and accessed via the mheap_.arenas index.</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">heapArena</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">_</span> <span style="color:#75af00">sys</span><span style="color:#111">.</span><span style="color:#75af00">NotInHeap</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// page 对应的 mspan</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// pagesPerArena 8192 一个 page 8KB 所以一个 heapArena 可以存储 64M 的内存</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">spans</span> <span style="color:#111">[</span><span style="color:#75af00">pagesPerArena</span><span style="color:#111">]</span><span style="color:#f92672">*</span><span style="color:#75af00">mspan</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 标记哪个 page 是在使用的</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// /8 是 uint8 可以表示 8 个 page</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">pageInUse</span> <span style="color:#111">[</span><span style="color:#75af00">pagesPerArena</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">8</span><span style="color:#111">]</span><span style="color:#00a8c8">uint8</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 标记哪些span包含被标记的对象 用于 gc 加速</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">pageMarks</span> <span style="color:#111">[</span><span style="color:#75af00">pagesPerArena</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">8</span><span style="color:#111">]</span><span style="color:#00a8c8">uint8</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 标记哪些span包含特殊对象</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">pageSpecials</span> <span style="color:#111">[</span><span style="color:#75af00">pagesPerArena</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">8</span><span style="color:#111">]</span><span style="color:#00a8c8">uint8</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">checkmarks</span> <span style="color:#f92672">*</span><span style="color:#75af00">checkmarksMap</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// arena中第一个未使用（已归零）页面的起始字节</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">zeroedBase</span> <span style="color:#00a8c8">uintptr</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="pagealloc">pageAlloc</h3>
<p>分配 page 的结构体，是一个 radix tree 的结构，一共有 5 层，每一层都是一个 summary 数组，用于快速查找空闲页面。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">pageAlloc</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 基数树 一共有 summaryLevels=5 层</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 基数树的摘要数组，用于快速查找空闲页面</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">summary</span> <span style="color:#111">[</span><span style="color:#75af00">summaryLevels</span><span style="color:#111">][]</span><span style="color:#75af00">pallocSum</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//  二级页面位图结构 </span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 使用二级结构而不是一个大的扁平数组，是因为在64位平台上总大小可能非常大(O(GiB))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">chunks</span> <span style="color:#111">[</span><span style="color:#ae81ff">1</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#75af00">pallocChunksL1Bits</span><span style="color:#111">]</span><span style="color:#f92672">*</span><span style="color:#111">[</span><span style="color:#ae81ff">1</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#75af00">pallocChunksL2Bits</span><span style="color:#111">]</span><span style="color:#75af00">pallocData</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 搜索起始地址</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">searchAddr</span> <span style="color:#75af00">offAddr</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// start 和 end 表示 pageAlloc 知道的块索引范围</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">start</span><span style="color:#111">,</span> <span style="color:#75af00">end</span> <span style="color:#75af00">chunkIdx</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ......</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">pallocSum</span> <span style="color:#00a8c8">uint64</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//  pallocSum 被划分成几个部分：</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 63位     62-42位    41-21位    20-0位</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// [标志位] [end值]    [max值]    [start值]</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//  1      21位      21位       21位</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">p</span> <span style="color:#75af00">pallocSum</span><span style="color:#111">)</span> <span style="color:#75af00">start</span><span style="color:#111">()</span> <span style="color:#00a8c8">uint</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 检查第63位是否为1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#111">uint64</span><span style="color:#111">(</span><span style="color:#75af00">p</span><span style="color:#111">)</span><span style="color:#f92672">&amp;</span><span style="color:#111">uint64</span><span style="color:#111">(</span><span style="color:#ae81ff">1</span><span style="color:#f92672">&lt;&lt;</span><span style="color:#ae81ff">63</span><span style="color:#111">)</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">maxPackedValue</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 否则，取最低21位</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#111">uint</span><span style="color:#111">(</span><span style="color:#111">uint64</span><span style="color:#111">(</span><span style="color:#75af00">p</span><span style="color:#111">)</span> <span style="color:#f92672">&amp;</span> <span style="color:#111">(</span><span style="color:#75af00">maxPackedValue</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">p</span> <span style="color:#75af00">pallocSum</span><span style="color:#111">)</span> <span style="color:#111">max</span><span style="color:#111">()</span> <span style="color:#00a8c8">uint</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#111">uint64</span><span style="color:#111">(</span><span style="color:#75af00">p</span><span style="color:#111">)</span><span style="color:#f92672">&amp;</span><span style="color:#111">uint64</span><span style="color:#111">(</span><span style="color:#ae81ff">1</span><span style="color:#f92672">&lt;&lt;</span><span style="color:#ae81ff">63</span><span style="color:#111">)</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">maxPackedValue</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 右移21位，然后取21位</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#111">uint</span><span style="color:#111">((</span><span style="color:#111">uint64</span><span style="color:#111">(</span><span style="color:#75af00">p</span><span style="color:#111">)</span> <span style="color:#f92672">&gt;&gt;</span> <span style="color:#75af00">logMaxPackedValue</span><span style="color:#111">)</span> <span style="color:#f92672">&amp;</span> <span style="color:#111">(</span><span style="color:#75af00">maxPackedValue</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">p</span> <span style="color:#75af00">pallocSum</span><span style="color:#111">)</span> <span style="color:#75af00">end</span><span style="color:#111">()</span> <span style="color:#00a8c8">uint</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#111">uint64</span><span style="color:#111">(</span><span style="color:#75af00">p</span><span style="color:#111">)</span><span style="color:#f92672">&amp;</span><span style="color:#111">uint64</span><span style="color:#111">(</span><span style="color:#ae81ff">1</span><span style="color:#f92672">&lt;&lt;</span><span style="color:#ae81ff">63</span><span style="color:#111">)</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">maxPackedValue</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 右移42位，然后取21位</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#111">uint</span><span style="color:#111">((</span><span style="color:#111">uint64</span><span style="color:#111">(</span><span style="color:#75af00">p</span><span style="color:#111">)</span> <span style="color:#f92672">&gt;&gt;</span> <span style="color:#111">(</span><span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> <span style="color:#75af00">logMaxPackedValue</span><span style="color:#111">))</span> <span style="color:#f92672">&amp;</span> <span style="color:#111">(</span><span style="color:#75af00">maxPackedValue</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p><img src="/images/go_page_alloc.png" alt=""></p>
<h2 id="内存分配流程">内存分配流程</h2>
<h3 id="流程">流程</h3>
<p><img src="/images/go_memory_flow.png" alt=""></p>
<p>go 中把 对象分成三类 tiny ，small 和 large。tiny 是小于 16B 的对象，small 是大于等于 16B 小于 32KB 的对象，large 是大于 32KB 的对象。tiny 分配器主要是为了减少内存碎片。</p>
<ol>
<li>如果是 tiny object，直接使用 tiny 分配器分配。如果 tiny 分配器中的空间不够（定长位16B），就从 mchunk 中获取一个新的 16B 的对象作为 tiny 分配器的空间使用。</li>
<li>如果是 small object，根据所属的 class, 从 mcache 获取对应 mspan 中的内存。</li>
<li>如果 mspan 中的内存不够，根据所属的 class 从 mcentral 中获取新的 mspan ，从 mspan 中获取内存。（要 class 力度的锁）</li>
<li>如果 mcentral 中的 mspan 也不够，就从 mheap 中获取对应数量的 page 组装成 mspan，然后从新的 mspan 中获取内存。（全局锁）</li>
<li>如果 mheap 中的 mspan 也不够，就系统调用从操作系统获取新的 Arena。把内存 page 分配好，然后继续第四步。</li>
<li>如果是 large object，直接从第四部开始。</li>
</ol>
<h3 id="mallocgc">mallocgc</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// 在 heap 上分配内存函数 size 对象大小 typ 对象类型 needzero 是否需要清零</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">mallocgc</span><span style="color:#111">(</span><span style="color:#75af00">size</span> <span style="color:#00a8c8">uintptr</span><span style="color:#111">,</span> <span style="color:#75af00">typ</span> <span style="color:#f92672">*</span><span style="color:#75af00">_type</span><span style="color:#111">,</span> <span style="color:#75af00">needzero</span> <span style="color:#00a8c8">bool</span><span style="color:#111">)</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// gc 终止阶段不允许分配 这个是一个检查 正常情况下不会出现</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">gcphase</span> <span style="color:#f92672">==</span> <span style="color:#75af00">_GCmarktermination</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">throw</span><span style="color:#111">(</span><span style="color:#d88200">&#34;mallocgc called with gcphase == _GCmarktermination&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 处理分类为 0 的情况</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">size</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">zerobase</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ......</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Set mp.mallocing to keep from being preempted by GC.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">mp</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">acquirem</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">mp</span><span style="color:#111">.</span><span style="color:#75af00">mallocing</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">throw</span><span style="color:#111">(</span><span style="color:#d88200">&#34;malloc deadlock&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">mp</span><span style="color:#111">.</span><span style="color:#75af00">gsignal</span> <span style="color:#f92672">==</span> <span style="color:#75af00">getg</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">throw</span><span style="color:#111">(</span><span style="color:#d88200">&#34;malloc during signal&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">mp</span><span style="color:#111">.</span><span style="color:#75af00">mallocing</span> <span style="color:#111">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">shouldhelpgc</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">false</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">dataSize</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">userSize</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 获取 M 和 M 所属 P 的 mcache</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">c</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">getMCache</span><span style="color:#111">(</span><span style="color:#75af00">mp</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">c</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">throw</span><span style="color:#111">(</span><span style="color:#d88200">&#34;mallocgc called without a P or outside bootstrapping&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">var</span> <span style="color:#75af00">span</span> <span style="color:#f92672">*</span><span style="color:#75af00">mspan</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">var</span> <span style="color:#75af00">header</span> <span style="color:#f92672">**</span><span style="color:#75af00">_type</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">var</span> <span style="color:#75af00">x</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 对象总是不是含有指针  如果不含有 就不用往下扫描了 用来 gc 加速</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">noscan</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">typ</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#f92672">||</span> <span style="color:#111">!</span><span style="color:#75af00">typ</span><span style="color:#111">.</span><span style="color:#75af00">Pointers</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 是不是小对象 （&lt; 32k - 8）</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">size</span> <span style="color:#f92672">&lt;=</span> <span style="color:#75af00">maxSmallSize</span><span style="color:#f92672">-</span><span style="color:#75af00">mallocHeaderSize</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 如果对象大小小于 16B 且不含有指针 则使用 tiny 分配器</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">noscan</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">size</span> <span style="color:#111">&lt;</span> <span style="color:#75af00">maxTinySize</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">off</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">tinyoffset</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 内存对齐一下</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">size</span><span style="color:#f92672">&amp;</span><span style="color:#ae81ff">7</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">off</span> <span style="color:#111">=</span> <span style="color:#75af00">alignUp</span><span style="color:#111">(</span><span style="color:#75af00">off</span><span style="color:#111">,</span> <span style="color:#ae81ff">8</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#00a8c8">if</span> <span style="color:#75af00">goarch</span><span style="color:#111">.</span><span style="color:#75af00">PtrSize</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">4</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">size</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">12</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">off</span> <span style="color:#111">=</span> <span style="color:#75af00">alignUp</span><span style="color:#111">(</span><span style="color:#75af00">off</span><span style="color:#111">,</span> <span style="color:#ae81ff">8</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#00a8c8">if</span> <span style="color:#75af00">size</span><span style="color:#f92672">&amp;</span><span style="color:#ae81ff">3</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">off</span> <span style="color:#111">=</span> <span style="color:#75af00">alignUp</span><span style="color:#111">(</span><span style="color:#75af00">off</span><span style="color:#111">,</span> <span style="color:#ae81ff">4</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#00a8c8">if</span> <span style="color:#75af00">size</span><span style="color:#f92672">&amp;</span><span style="color:#ae81ff">1</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">off</span> <span style="color:#111">=</span> <span style="color:#75af00">alignUp</span><span style="color:#111">(</span><span style="color:#75af00">off</span><span style="color:#111">,</span> <span style="color:#ae81ff">2</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 如果剩余空间足够 使用 tiny 分配器</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">off</span><span style="color:#f92672">+</span><span style="color:#75af00">size</span> <span style="color:#f92672">&lt;=</span> <span style="color:#75af00">maxTinySize</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">tiny</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">x</span> <span style="color:#111">=</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">tiny</span> <span style="color:#f92672">+</span> <span style="color:#75af00">off</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">tinyoffset</span> <span style="color:#111">=</span> <span style="color:#75af00">off</span> <span style="color:#f92672">+</span> <span style="color:#75af00">size</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">tinyAllocs</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">mp</span><span style="color:#111">.</span><span style="color:#75af00">mallocing</span> <span style="color:#111">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">releasem</span><span style="color:#111">(</span><span style="color:#75af00">mp</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">return</span> <span style="color:#75af00">x</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 重新 分配一个 tiny 使用 </span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">span</span> <span style="color:#111">=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">alloc</span><span style="color:#111">[</span><span style="color:#75af00">tinySpanClass</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">v</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">nextFreeFast</span><span style="color:#111">(</span><span style="color:#75af00">span</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">v</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">v</span><span style="color:#111">,</span> <span style="color:#75af00">span</span><span style="color:#111">,</span> <span style="color:#75af00">shouldhelpgc</span> <span style="color:#111">=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">nextFree</span><span style="color:#111">(</span><span style="color:#75af00">tinySpanClass</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">x</span> <span style="color:#111">=</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">(</span><span style="color:#75af00">v</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#111">[</span><span style="color:#ae81ff">2</span><span style="color:#111">]</span><span style="color:#00a8c8">uint64</span><span style="color:#111">)(</span><span style="color:#75af00">x</span><span style="color:#111">)[</span><span style="color:#ae81ff">0</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#111">[</span><span style="color:#ae81ff">2</span><span style="color:#111">]</span><span style="color:#00a8c8">uint64</span><span style="color:#111">)(</span><span style="color:#75af00">x</span><span style="color:#111">)[</span><span style="color:#ae81ff">1</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">raceenabled</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#111">(</span><span style="color:#75af00">size</span> <span style="color:#111">&lt;</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">tinyoffset</span> <span style="color:#f92672">||</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">tiny</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">tiny</span> <span style="color:#111">=</span> <span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">x</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">tinyoffset</span> <span style="color:#111">=</span> <span style="color:#75af00">size</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">size</span> <span style="color:#111">=</span> <span style="color:#75af00">maxTinySize</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 处理小对象</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 处理对象头部 主要加入一些头部信息帮助 GC 加速</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">hasHeader</span> <span style="color:#f92672">:=</span> <span style="color:#111">!</span><span style="color:#75af00">noscan</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#111">!</span><span style="color:#75af00">heapBitsInSpan</span><span style="color:#111">(</span><span style="color:#75af00">size</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">hasHeader</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">size</span> <span style="color:#f92672">+=</span> <span style="color:#75af00">mallocHeaderSize</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 根据不同的对象大小 使用不同的mspan</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">var</span> <span style="color:#75af00">sizeclass</span> <span style="color:#00a8c8">uint8</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">size</span> <span style="color:#f92672">&lt;=</span> <span style="color:#75af00">smallSizeMax</span><span style="color:#f92672">-</span><span style="color:#ae81ff">8</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">sizeclass</span> <span style="color:#111">=</span> <span style="color:#75af00">size_to_class8</span><span style="color:#111">[</span><span style="color:#75af00">divRoundUp</span><span style="color:#111">(</span><span style="color:#75af00">size</span><span style="color:#111">,</span> <span style="color:#75af00">smallSizeDiv</span><span style="color:#111">)]</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">sizeclass</span> <span style="color:#111">=</span> <span style="color:#75af00">size_to_class128</span><span style="color:#111">[</span><span style="color:#75af00">divRoundUp</span><span style="color:#111">(</span><span style="color:#75af00">size</span><span style="color:#f92672">-</span><span style="color:#75af00">smallSizeMax</span><span style="color:#111">,</span> <span style="color:#75af00">largeSizeDiv</span><span style="color:#111">)]</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">size</span> <span style="color:#111">=</span> <span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">class_to_size</span><span style="color:#111">[</span><span style="color:#75af00">sizeclass</span><span style="color:#111">])</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">spc</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">makeSpanClass</span><span style="color:#111">(</span><span style="color:#75af00">sizeclass</span><span style="color:#111">,</span> <span style="color:#75af00">noscan</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">span</span> <span style="color:#111">=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">alloc</span><span style="color:#111">[</span><span style="color:#75af00">spc</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 使用缓存从 mspan 中获取空闲对象</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">v</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">nextFreeFast</span><span style="color:#111">(</span><span style="color:#75af00">span</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">v</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// 先从本地获取 span 如果本地没获取到 升级到 mcenral 获取</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">v</span><span style="color:#111">,</span> <span style="color:#75af00">span</span><span style="color:#111">,</span> <span style="color:#75af00">shouldhelpgc</span> <span style="color:#111">=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">nextFree</span><span style="color:#111">(</span><span style="color:#75af00">spc</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">x</span> <span style="color:#111">=</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">(</span><span style="color:#75af00">v</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 如果需要清零 处理一下</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">needzero</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">span</span><span style="color:#111">.</span><span style="color:#75af00">needzero</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">memclrNoHeapPointers</span><span style="color:#111">(</span><span style="color:#75af00">x</span><span style="color:#111">,</span> <span style="color:#75af00">size</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 设置头</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">hasHeader</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">header</span> <span style="color:#111">=</span> <span style="color:#111">(</span><span style="color:#f92672">**</span><span style="color:#75af00">_type</span><span style="color:#111">)(</span><span style="color:#75af00">x</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">x</span> <span style="color:#111">=</span> <span style="color:#75af00">add</span><span style="color:#111">(</span><span style="color:#75af00">x</span><span style="color:#111">,</span> <span style="color:#75af00">mallocHeaderSize</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">size</span> <span style="color:#f92672">-=</span> <span style="color:#75af00">mallocHeaderSize</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 大对象分配 直接从 mheap 中获取 class = 0 的 mspan</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">shouldhelpgc</span> <span style="color:#111">=</span> <span style="color:#00a8c8">true</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">span</span> <span style="color:#111">=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">allocLarge</span><span style="color:#111">(</span><span style="color:#75af00">size</span><span style="color:#111">,</span> <span style="color:#75af00">noscan</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">span</span><span style="color:#111">.</span><span style="color:#75af00">freeindex</span> <span style="color:#111">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">span</span><span style="color:#111">.</span><span style="color:#75af00">allocCount</span> <span style="color:#111">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">size</span> <span style="color:#111">=</span> <span style="color:#75af00">span</span><span style="color:#111">.</span><span style="color:#75af00">elemsize</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">x</span> <span style="color:#111">=</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">(</span><span style="color:#75af00">span</span><span style="color:#111">.</span><span style="color:#75af00">base</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">needzero</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">span</span><span style="color:#111">.</span><span style="color:#75af00">needzero</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">delayedZeroing</span> <span style="color:#111">=</span> <span style="color:#00a8c8">true</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">noscan</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// Tell the GC not to look at this yet.</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">span</span><span style="color:#111">.</span><span style="color:#75af00">largeType</span> <span style="color:#111">=</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">header</span> <span style="color:#111">=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">span</span><span style="color:#111">.</span><span style="color:#75af00">largeType</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ......</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">x</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="nextfreefast">nextFreeFast</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">nextFreeFast</span><span style="color:#111">(</span><span style="color:#75af00">s</span> <span style="color:#f92672">*</span><span style="color:#75af00">mspan</span><span style="color:#111">)</span> <span style="color:#75af00">gclinkptr</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 使用 ctz64 (amd64 中是 tzcnt 指令 )  获取末尾的 0（以分配） 的个数 如果是 64 说明没有空闲对象</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">theBit</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">sys</span><span style="color:#111">.</span><span style="color:#75af00">TrailingZeros64</span><span style="color:#111">(</span><span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">allocCache</span><span style="color:#111">)</span> 
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 如果找到了空闲位置（theBit &lt; 64）</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">theBit</span> <span style="color:#111">&lt;</span> <span style="color:#ae81ff">64</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">result</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">freeindex</span> <span style="color:#f92672">+</span> <span style="color:#111">uint16</span><span style="color:#111">(</span><span style="color:#75af00">theBit</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">result</span> <span style="color:#111">&lt;</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">nelems</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">freeidx</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">result</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">freeidx</span><span style="color:#f92672">%</span><span style="color:#ae81ff">64</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">freeidx</span> <span style="color:#f92672">!=</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">nelems</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">return</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 分配了 cache 移动一下</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">allocCache</span> <span style="color:#f92672">&gt;&gt;=</span> <span style="color:#111">uint</span><span style="color:#111">(</span><span style="color:#75af00">theBit</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">freeindex</span> <span style="color:#111">=</span> <span style="color:#75af00">freeidx</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">allocCount</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// result * elemsize：计算对象的偏移量</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// base()：获取span的起始地址</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#75af00">gclinkptr</span><span style="color:#111">(</span><span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">result</span><span style="color:#111">)</span><span style="color:#f92672">*</span><span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">elemsize</span> <span style="color:#f92672">+</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">base</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="nextfree">nextFree</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// nextFree 从 mcache 中获取下一个空闲对象</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">mcache</span><span style="color:#111">)</span> <span style="color:#75af00">nextFree</span><span style="color:#111">(</span><span style="color:#75af00">spc</span> <span style="color:#75af00">spanClass</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#75af00">v</span> <span style="color:#75af00">gclinkptr</span><span style="color:#111">,</span> <span style="color:#75af00">s</span> <span style="color:#f92672">*</span><span style="color:#75af00">mspan</span><span style="color:#111">,</span> <span style="color:#75af00">shouldhelpgc</span> <span style="color:#00a8c8">bool</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">s</span> <span style="color:#111">=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">alloc</span><span style="color:#111">[</span><span style="color:#75af00">spc</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">shouldhelpgc</span> <span style="color:#111">=</span> <span style="color:#00a8c8">false</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 从 mcache 对象空位的偏移量</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">freeIndex</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">nextFreeIndex</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">freeIndex</span> <span style="color:#f92672">==</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">nelems</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// mcache 没有靠你先对象 从 mcentral,mheap 获取</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">refill</span><span style="color:#111">(</span><span style="color:#75af00">spc</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">shouldhelpgc</span> <span style="color:#111">=</span> <span style="color:#00a8c8">true</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">s</span> <span style="color:#111">=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">alloc</span><span style="color:#111">[</span><span style="color:#75af00">spc</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">freeIndex</span> <span style="color:#111">=</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">nextFreeIndex</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">freeIndex</span> <span style="color:#f92672">&gt;=</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">nelems</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">throw</span><span style="color:#111">(</span><span style="color:#d88200">&#34;freeIndex is not valid&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">v</span> <span style="color:#111">=</span> <span style="color:#75af00">gclinkptr</span><span style="color:#111">(</span><span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">freeIndex</span><span style="color:#111">)</span><span style="color:#f92672">*</span><span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">elemsize</span> <span style="color:#f92672">+</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">base</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">allocCount</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">allocCount</span> <span style="color:#111">&gt;</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">nelems</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;s.allocCount=&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">allocCount</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;s.nelems=&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">nelems</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">throw</span><span style="color:#111">(</span><span style="color:#d88200">&#34;s.allocCount &gt; s.nelems&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>一组一组获取空闲对象</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-GO" data-lang="GO"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">s</span> <span style="color:#f92672">*</span><span style="color:#75af00">mspan</span><span style="color:#111">)</span> <span style="color:#75af00">nextFreeIndex</span><span style="color:#111">()</span> <span style="color:#00a8c8">uint16</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">sfreeindex</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">freeindex</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">snelems</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">nelems</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">sfreeindex</span> <span style="color:#f92672">==</span> <span style="color:#75af00">snelems</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">sfreeindex</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">sfreeindex</span> <span style="color:#111">&gt;</span> <span style="color:#75af00">snelems</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">throw</span><span style="color:#111">(</span><span style="color:#d88200">&#34;s.freeindex &gt; s.nelems&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">aCache</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">allocCache</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">bitIndex</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">sys</span><span style="color:#111">.</span><span style="color:#75af00">TrailingZeros64</span><span style="color:#111">(</span><span style="color:#75af00">aCache</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">bitIndex</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">64</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Move index to start of next cached bits.</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">sfreeindex</span> <span style="color:#111">=</span> <span style="color:#111">(</span><span style="color:#75af00">sfreeindex</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">64</span><span style="color:#111">)</span> <span style="color:#f92672">&amp;^</span> <span style="color:#111">(</span><span style="color:#ae81ff">64</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">sfreeindex</span> <span style="color:#f92672">&gt;=</span> <span style="color:#75af00">snelems</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">freeindex</span> <span style="color:#111">=</span> <span style="color:#75af00">snelems</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#75af00">snelems</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">whichByte</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">sfreeindex</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">8</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Refill s.allocCache with the next 64 alloc bits.</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">refillAllocCache</span><span style="color:#111">(</span><span style="color:#75af00">whichByte</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">aCache</span> <span style="color:#111">=</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">allocCache</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">bitIndex</span> <span style="color:#111">=</span> <span style="color:#75af00">sys</span><span style="color:#111">.</span><span style="color:#75af00">TrailingZeros64</span><span style="color:#111">(</span><span style="color:#75af00">aCache</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// nothing available in cached bits</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// grab the next 8 bytes and try again.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">result</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">sfreeindex</span> <span style="color:#f92672">+</span> <span style="color:#111">uint16</span><span style="color:#111">(</span><span style="color:#75af00">bitIndex</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">result</span> <span style="color:#f92672">&gt;=</span> <span style="color:#75af00">snelems</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">freeindex</span> <span style="color:#111">=</span> <span style="color:#75af00">snelems</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">snelems</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">allocCache</span> <span style="color:#f92672">&gt;&gt;=</span> <span style="color:#111">uint</span><span style="color:#111">(</span><span style="color:#75af00">bitIndex</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">sfreeindex</span> <span style="color:#111">=</span> <span style="color:#75af00">result</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">sfreeindex</span><span style="color:#f92672">%</span><span style="color:#ae81ff">64</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">sfreeindex</span> <span style="color:#f92672">!=</span> <span style="color:#75af00">snelems</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">whichByte</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">sfreeindex</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">8</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">refillAllocCache</span><span style="color:#111">(</span><span style="color:#75af00">whichByte</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">freeindex</span> <span style="color:#111">=</span> <span style="color:#75af00">sfreeindex</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">result</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3></h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// 给 mcache 添加一个新的 mspan 一般是申请内存 mcache 中没有空闲对象了</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">mcache</span><span style="color:#111">)</span> <span style="color:#75af00">refill</span><span style="color:#111">(</span><span style="color:#75af00">spc</span> <span style="color:#75af00">spanClass</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">s</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">alloc</span><span style="color:#111">[</span><span style="color:#75af00">spc</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">allocCount</span> <span style="color:#f92672">!=</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">nelems</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">throw</span><span style="color:#111">(</span><span style="color:#d88200">&#34;refill of span with free space remaining&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">s</span> <span style="color:#f92672">!=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">emptymspan</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// ......</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 如果不是空的 而且没有空闲对象 就把这个 span 放到 mcentral 中 mcache 使用不了这个 span 了</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">mheap_</span><span style="color:#111">.</span><span style="color:#75af00">central</span><span style="color:#111">[</span><span style="color:#75af00">spc</span><span style="color:#111">].</span><span style="color:#75af00">mcentral</span><span style="color:#111">.</span><span style="color:#75af00">uncacheSpan</span><span style="color:#111">(</span><span style="color:#75af00">s</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// ......</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 从 mcentral 获取新的 span 如果没有就从 mheap 再没有就系统调用申请内存</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">s</span> <span style="color:#111">=</span> <span style="color:#75af00">mheap_</span><span style="color:#111">.</span><span style="color:#75af00">central</span><span style="color:#111">[</span><span style="color:#75af00">spc</span><span style="color:#111">].</span><span style="color:#75af00">mcentral</span><span style="color:#111">.</span><span style="color:#75af00">cacheSpan</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// .....</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">alloc</span><span style="color:#111">[</span><span style="color:#75af00">spc</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#75af00">s</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p><strong>cacheSpan</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">mcentral</span><span style="color:#111">)</span> <span style="color:#75af00">cacheSpan</span><span style="color:#111">()</span> <span style="color:#f92672">*</span><span style="color:#75af00">mspan</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ......</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 尝试从以清扫的部分获取</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">sg</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">mheap_</span><span style="color:#111">.</span><span style="color:#75af00">sweepgen</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">s</span> <span style="color:#111">=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">partialSwept</span><span style="color:#111">(</span><span style="color:#75af00">sg</span><span style="color:#111">).</span><span style="color:#75af00">pop</span><span style="color:#111">();</span> <span style="color:#75af00">s</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">goto</span> <span style="color:#75af00">havespan</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 如果以清扫的没有 就马上开始主动清扫</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">sl</span> <span style="color:#111">=</span> <span style="color:#75af00">sweep</span><span style="color:#111">.</span><span style="color:#75af00">active</span><span style="color:#111">.</span><span style="color:#75af00">begin</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">sl</span><span style="color:#111">.</span><span style="color:#75af00">valid</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 尝试从未清扫的部分使用的 span 列表中获取 </span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">for</span> <span style="color:#111">;</span> <span style="color:#75af00">spanBudget</span> <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0</span><span style="color:#111">;</span> <span style="color:#75af00">spanBudget</span><span style="color:#f92672">--</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">s</span> <span style="color:#111">=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">partialUnswept</span><span style="color:#111">(</span><span style="color:#75af00">sg</span><span style="color:#111">).</span><span style="color:#75af00">pop</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">s</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">break</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 尝试获取 span </span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">s</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">sl</span><span style="color:#111">.</span><span style="color:#75af00">tryAcquire</span><span style="color:#111">(</span><span style="color:#75af00">s</span><span style="color:#111">);</span> <span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// 清扫它 并使用</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">sweep</span><span style="color:#111">(</span><span style="color:#00a8c8">true</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">sweep</span><span style="color:#111">.</span><span style="color:#75af00">active</span><span style="color:#111">.</span><span style="color:#75af00">end</span><span style="color:#111">(</span><span style="color:#75af00">sl</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">goto</span> <span style="color:#75af00">havespan</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 尝试从未清扫的已满 span 列表中获取</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">for</span> <span style="color:#111">;</span> <span style="color:#75af00">spanBudget</span> <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0</span><span style="color:#111">;</span> <span style="color:#75af00">spanBudget</span><span style="color:#f92672">--</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">s</span> <span style="color:#111">=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">fullUnswept</span><span style="color:#111">(</span><span style="color:#75af00">sg</span><span style="color:#111">).</span><span style="color:#75af00">pop</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">s</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">break</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">s</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">sl</span><span style="color:#111">.</span><span style="color:#75af00">tryAcquire</span><span style="color:#111">(</span><span style="color:#75af00">s</span><span style="color:#111">);</span> <span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">sweep</span><span style="color:#111">(</span><span style="color:#00a8c8">true</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// 清扫之后 看有无可用的 没有就下一个</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">freeIndex</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">nextFreeIndex</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">if</span> <span style="color:#75af00">freeIndex</span> <span style="color:#f92672">!=</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">nelems</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">freeindex</span> <span style="color:#111">=</span> <span style="color:#75af00">freeIndex</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">sweep</span><span style="color:#111">.</span><span style="color:#75af00">active</span><span style="color:#111">.</span><span style="color:#75af00">end</span><span style="color:#111">(</span><span style="color:#75af00">sl</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>					<span style="color:#00a8c8">goto</span> <span style="color:#75af00">havespan</span>
</span></span><span style="display:flex;"><span>				<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">fullSwept</span><span style="color:#111">(</span><span style="color:#75af00">sg</span><span style="color:#111">).</span><span style="color:#75af00">push</span><span style="color:#111">(</span><span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">mspan</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">sweep</span><span style="color:#111">.</span><span style="color:#75af00">active</span><span style="color:#111">.</span><span style="color:#75af00">end</span><span style="color:#111">(</span><span style="color:#75af00">sl</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">trace</span> <span style="color:#111">=</span> <span style="color:#75af00">traceAcquire</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">trace</span><span style="color:#111">.</span><span style="color:#75af00">ok</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">trace</span><span style="color:#111">.</span><span style="color:#75af00">GCSweepDone</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">traceDone</span> <span style="color:#111">=</span> <span style="color:#00a8c8">true</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">traceRelease</span><span style="color:#111">(</span><span style="color:#75af00">trace</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// mcentral 中没有可用的 span 了 从 mheap 中获取</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">s</span> <span style="color:#111">=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">grow</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">s</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 获取到了 span 了 上边会 goto 到这</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">havespan</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ......</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 处理 allocCache 缓存</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">freeByteBase</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">freeindex</span> <span style="color:#f92672">&amp;^</span> <span style="color:#111">(</span><span style="color:#ae81ff">64</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">whichByte</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">freeByteBase</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">8</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">refillAllocCache</span><span style="color:#111">(</span><span style="color:#75af00">whichByte</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">allocCache</span> <span style="color:#f92672">&gt;&gt;=</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">freeindex</span> <span style="color:#f92672">%</span> <span style="color:#ae81ff">64</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">s</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p><strong>grow</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">mcentral</span><span style="color:#111">)</span> <span style="color:#75af00">grow</span><span style="color:#111">()</span> <span style="color:#f92672">*</span><span style="color:#75af00">mspan</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">npages</span> <span style="color:#f92672">:=</span> <span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">class_to_allocnpages</span><span style="color:#111">[</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">spanclass</span><span style="color:#111">.</span><span style="color:#75af00">sizeclass</span><span style="color:#111">()])</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">size</span> <span style="color:#f92672">:=</span> <span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">class_to_size</span><span style="color:#111">[</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">spanclass</span><span style="color:#111">.</span><span style="color:#75af00">sizeclass</span><span style="color:#111">()])</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 申请内存</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">s</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">mheap_</span><span style="color:#111">.</span><span style="color:#75af00">alloc</span><span style="color:#111">(</span><span style="color:#75af00">npages</span><span style="color:#111">,</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">spanclass</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">s</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 计算这个 span 可以容纳多少个对象 和 偏移量等</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">n</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">divideByElemSize</span><span style="color:#111">(</span><span style="color:#75af00">npages</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#75af00">_PageShift</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">limit</span> <span style="color:#111">=</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">base</span><span style="color:#111">()</span> <span style="color:#f92672">+</span> <span style="color:#75af00">size</span><span style="color:#f92672">*</span><span style="color:#75af00">n</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">initHeapBits</span><span style="color:#111">(</span><span style="color:#00a8c8">false</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">s</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">h</span> <span style="color:#f92672">*</span><span style="color:#75af00">mheap</span><span style="color:#111">)</span> <span style="color:#75af00">alloc</span><span style="color:#111">(</span><span style="color:#75af00">npages</span> <span style="color:#00a8c8">uintptr</span><span style="color:#111">,</span> <span style="color:#75af00">spanclass</span> <span style="color:#75af00">spanClass</span><span style="color:#111">)</span> <span style="color:#f92672">*</span><span style="color:#75af00">mspan</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">var</span> <span style="color:#75af00">s</span> <span style="color:#f92672">*</span><span style="color:#75af00">mspan</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">systemstack</span><span style="color:#111">(</span><span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 先清扫一些页 防止一直增长</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">isSweepDone</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">reclaim</span><span style="color:#111">(</span><span style="color:#75af00">npages</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">s</span> <span style="color:#111">=</span> <span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">allocSpan</span><span style="color:#111">(</span><span style="color:#75af00">npages</span><span style="color:#111">,</span> <span style="color:#75af00">spanAllocHeap</span><span style="color:#111">,</span> <span style="color:#75af00">spanclass</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">s</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">h</span> <span style="color:#f92672">*</span><span style="color:#75af00">mheap</span><span style="color:#111">)</span> <span style="color:#75af00">allocSpan</span><span style="color:#111">(</span><span style="color:#75af00">npages</span> <span style="color:#00a8c8">uintptr</span><span style="color:#111">,</span> <span style="color:#75af00">typ</span> <span style="color:#75af00">spanAllocType</span><span style="color:#111">,</span> <span style="color:#75af00">spanclass</span> <span style="color:#75af00">spanClass</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#75af00">s</span> <span style="color:#f92672">*</span><span style="color:#75af00">mspan</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 检查内存对其 ......</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">needPhysPageAlign</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">pp</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">npages</span> <span style="color:#111">&lt;</span> <span style="color:#75af00">pageCachePages</span><span style="color:#f92672">/</span><span style="color:#ae81ff">4</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 尝试从缓存直接获取</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">*</span><span style="color:#75af00">c</span> <span style="color:#111">=</span> <span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">pages</span><span style="color:#111">.</span><span style="color:#75af00">allocToCache</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 加锁</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">lock</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">lock</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">needPhysPageAlign</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Overallocate by a physical page to allow for later alignment.</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">extraPages</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">physPageSize</span> <span style="color:#f92672">/</span> <span style="color:#75af00">pageSize</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 尝试从 pageAlloc 获取页</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">base</span><span style="color:#111">,</span> <span style="color:#75af00">_</span> <span style="color:#111">=</span> <span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">pages</span><span style="color:#111">.</span><span style="color:#75af00">find</span><span style="color:#111">(</span><span style="color:#75af00">npages</span> <span style="color:#f92672">+</span> <span style="color:#75af00">extraPages</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">base</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 尝试分配所需页数</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">base</span><span style="color:#111">,</span> <span style="color:#75af00">scav</span> <span style="color:#111">=</span> <span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">pages</span><span style="color:#111">.</span><span style="color:#75af00">alloc</span><span style="color:#111">(</span><span style="color:#75af00">npages</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">base</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">var</span> <span style="color:#75af00">ok</span> <span style="color:#00a8c8">bool</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 空间不足，尝试扩展</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">growth</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#111">=</span> <span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">grow</span><span style="color:#111">(</span><span style="color:#75af00">npages</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">unlock</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">lock</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">base</span><span style="color:#111">,</span> <span style="color:#75af00">scav</span> <span style="color:#111">=</span> <span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">pages</span><span style="color:#111">.</span><span style="color:#75af00">alloc</span><span style="color:#111">(</span><span style="color:#75af00">npages</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">base</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">throw</span><span style="color:#111">(</span><span style="color:#d88200">&#34;grew heap, but no adequate free space found&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">unlock</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">lock</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">HaveSpan</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ......</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 组装成 mspan</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">initSpan</span><span style="color:#111">(</span><span style="color:#75af00">s</span><span style="color:#111">,</span> <span style="color:#75af00">typ</span><span style="color:#111">,</span> <span style="color:#75af00">spanclass</span><span style="color:#111">,</span> <span style="color:#75af00">base</span><span style="color:#111">,</span> <span style="color:#75af00">npages</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">s</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// 向操作系统申请内存</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">h</span> <span style="color:#f92672">*</span><span style="color:#75af00">mheap</span><span style="color:#111">)</span> <span style="color:#75af00">grow</span><span style="color:#111">(</span><span style="color:#75af00">npage</span> <span style="color:#00a8c8">uintptr</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#00a8c8">uintptr</span><span style="color:#111">,</span> <span style="color:#00a8c8">bool</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 每次申请 4 M</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ask</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">alignUp</span><span style="color:#111">(</span><span style="color:#75af00">npage</span><span style="color:#111">,</span> <span style="color:#75af00">pallocChunkPages</span><span style="color:#111">)</span> <span style="color:#f92672">*</span> <span style="color:#75af00">pageSize</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ......</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">av</span><span style="color:#111">,</span> <span style="color:#75af00">asize</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">sysAlloc</span><span style="color:#111">(</span><span style="color:#75af00">ask</span><span style="color:#111">,</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">arenaHints</span><span style="color:#111">,</span> <span style="color:#00a8c8">true</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ......</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// sysAlloc -&gt; sysReserve -&gt; sysReserveOS</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">sysReserveOS</span><span style="color:#111">(</span><span style="color:#75af00">v</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">,</span> <span style="color:#75af00">n</span> <span style="color:#00a8c8">uintptr</span><span style="color:#111">)</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">p</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">mmap</span><span style="color:#111">(</span><span style="color:#75af00">v</span><span style="color:#111">,</span> <span style="color:#75af00">n</span><span style="color:#111">,</span> <span style="color:#75af00">_PROT_NONE</span><span style="color:#111">,</span> <span style="color:#75af00">_MAP_ANON</span><span style="color:#111">|</span><span style="color:#75af00">_MAP_PRIVATE</span><span style="color:#111">,</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">,</span> <span style="color:#ae81ff">0</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">p</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">mmap</span><span style="color:#111">(</span><span style="color:#75af00">addr</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">,</span> <span style="color:#75af00">n</span> <span style="color:#00a8c8">uintptr</span><span style="color:#111">,</span> <span style="color:#75af00">prot</span><span style="color:#111">,</span> <span style="color:#75af00">flags</span><span style="color:#111">,</span> <span style="color:#75af00">fd</span> <span style="color:#00a8c8">int32</span><span style="color:#111">,</span> <span style="color:#75af00">off</span> <span style="color:#00a8c8">uint32</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">,</span> <span style="color:#00a8c8">int</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ......</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">sysMmap</span><span style="color:#111">(</span><span style="color:#75af00">addr</span><span style="color:#111">,</span> <span style="color:#75af00">n</span><span style="color:#111">,</span> <span style="color:#75af00">prot</span><span style="color:#111">,</span> <span style="color:#75af00">flags</span><span style="color:#111">,</span> <span style="color:#75af00">fd</span><span style="color:#111">,</span> <span style="color:#75af00">off</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="stack-内存">stack 内存</h2>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// newproc1</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#75af00">newg</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">newg</span> <span style="color:#111">=</span> <span style="color:#75af00">malg</span><span style="color:#111">(</span><span style="color:#75af00">stackMin</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">//newproc1 -&gt; malg -&gt; stackalloc</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">stackalloc</span><span style="color:#111">(</span><span style="color:#75af00">n</span> <span style="color:#00a8c8">uint32</span><span style="color:#111">)</span> <span style="color:#75af00">stack</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">thisg</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">getg</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ......</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">var</span> <span style="color:#75af00">v</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 小栈 linux 下是 32k</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">n</span> <span style="color:#111">&lt;</span> <span style="color:#75af00">fixedStack</span><span style="color:#f92672">&lt;&lt;</span><span style="color:#75af00">_NumStackOrders</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">n</span> <span style="color:#111">&lt;</span> <span style="color:#75af00">_StackCacheSize</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">order</span> <span style="color:#f92672">:=</span> <span style="color:#111">uint8</span><span style="color:#111">(</span><span style="color:#ae81ff">0</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">n2</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">n</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">for</span> <span style="color:#75af00">n2</span> <span style="color:#111">&gt;</span> <span style="color:#75af00">fixedStack</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">order</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">n2</span> <span style="color:#f92672">&gt;&gt;=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">var</span> <span style="color:#75af00">x</span> <span style="color:#75af00">gclinkptr</span>
</span></span><span style="display:flex;"><span>		 <span style="color:#75715e">// 以下情况直接从全局池分配：</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 1. 禁用栈缓存</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 2. 没有关联的 P</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 3. 禁用抢占</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">stackNoCache</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">||</span> <span style="color:#75af00">thisg</span><span style="color:#111">.</span><span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">p</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">||</span> <span style="color:#75af00">thisg</span><span style="color:#111">.</span><span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">preemptoff</span> <span style="color:#f92672">!=</span> <span style="color:#d88200">&#34;&#34;</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">lock</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">stackpool</span><span style="color:#111">[</span><span style="color:#75af00">order</span><span style="color:#111">].</span><span style="color:#75af00">item</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">x</span> <span style="color:#111">=</span> <span style="color:#75af00">stackpoolalloc</span><span style="color:#111">(</span><span style="color:#75af00">order</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">unlock</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">stackpool</span><span style="color:#111">[</span><span style="color:#75af00">order</span><span style="color:#111">].</span><span style="color:#75af00">item</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 从 P 的本地缓存分配</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">c</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">thisg</span><span style="color:#111">.</span><span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">ptr</span><span style="color:#111">().</span><span style="color:#75af00">mcache</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">x</span> <span style="color:#111">=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">stackcache</span><span style="color:#111">[</span><span style="color:#75af00">order</span><span style="color:#111">].</span><span style="color:#75af00">list</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 如果本地缓存为空，则重新填充</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">x</span><span style="color:#111">.</span><span style="color:#75af00">ptr</span><span style="color:#111">()</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">stackcacherefill</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">,</span> <span style="color:#75af00">order</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">x</span> <span style="color:#111">=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">stackcache</span><span style="color:#111">[</span><span style="color:#75af00">order</span><span style="color:#111">].</span><span style="color:#75af00">list</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">stackcache</span><span style="color:#111">[</span><span style="color:#75af00">order</span><span style="color:#111">].</span><span style="color:#75af00">list</span> <span style="color:#111">=</span> <span style="color:#75af00">x</span><span style="color:#111">.</span><span style="color:#75af00">ptr</span><span style="color:#111">().</span><span style="color:#75af00">next</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">stackcache</span><span style="color:#111">[</span><span style="color:#75af00">order</span><span style="color:#111">].</span><span style="color:#75af00">size</span> <span style="color:#f92672">-=</span> <span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">n</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">v</span> <span style="color:#111">=</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">(</span><span style="color:#75af00">x</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 大栈</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">var</span> <span style="color:#75af00">s</span> <span style="color:#f92672">*</span><span style="color:#75af00">mspan</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">npage</span> <span style="color:#f92672">:=</span> <span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">n</span><span style="color:#111">)</span> <span style="color:#f92672">&gt;&gt;</span> <span style="color:#75af00">_PageShift</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">log2npage</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">stacklog2</span><span style="color:#111">(</span><span style="color:#75af00">npage</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Try to get a stack from the large stack cache.</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">lock</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">stackLarge</span><span style="color:#111">.</span><span style="color:#75af00">lock</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">stackLarge</span><span style="color:#111">.</span><span style="color:#75af00">free</span><span style="color:#111">[</span><span style="color:#75af00">log2npage</span><span style="color:#111">].</span><span style="color:#75af00">isEmpty</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">s</span> <span style="color:#111">=</span> <span style="color:#75af00">stackLarge</span><span style="color:#111">.</span><span style="color:#75af00">free</span><span style="color:#111">[</span><span style="color:#75af00">log2npage</span><span style="color:#111">].</span><span style="color:#75af00">first</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">stackLarge</span><span style="color:#111">.</span><span style="color:#75af00">free</span><span style="color:#111">[</span><span style="color:#75af00">log2npage</span><span style="color:#111">].</span><span style="color:#75af00">remove</span><span style="color:#111">(</span><span style="color:#75af00">s</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">unlock</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">stackLarge</span><span style="color:#111">.</span><span style="color:#75af00">lock</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">lockWithRankMayAcquire</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">mheap_</span><span style="color:#111">.</span><span style="color:#75af00">lock</span><span style="color:#111">,</span> <span style="color:#75af00">lockRankMheap</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">s</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 从堆中分配新的栈空间</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">s</span> <span style="color:#111">=</span> <span style="color:#75af00">mheap_</span><span style="color:#111">.</span><span style="color:#75af00">allocManual</span><span style="color:#111">(</span><span style="color:#75af00">npage</span><span style="color:#111">,</span> <span style="color:#75af00">spanAllocStack</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">s</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">throw</span><span style="color:#111">(</span><span style="color:#d88200">&#34;out of memory&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">osStackAlloc</span><span style="color:#111">(</span><span style="color:#75af00">s</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">elemsize</span> <span style="color:#111">=</span> <span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">n</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">v</span> <span style="color:#111">=</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">(</span><span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">base</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">stack</span><span style="color:#111">{</span><span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">v</span><span style="color:#111">),</span> <span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">v</span><span style="color:#111">)</span> <span style="color:#f92672">+</span> <span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">n</span><span style="color:#111">)}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p><strong>stackpoolalloc stackpool</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">var</span> <span style="color:#75af00">stackpool</span> <span style="color:#111">[</span><span style="color:#75af00">_NumStackOrders</span><span style="color:#111">]</span><span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">item</span> <span style="color:#75af00">stackpoolItem</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">_</span>    <span style="color:#111">[(</span><span style="color:#75af00">cpu</span><span style="color:#111">.</span><span style="color:#75af00">CacheLinePadSize</span> <span style="color:#f92672">-</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Sizeof</span><span style="color:#111">(</span><span style="color:#75af00">stackpoolItem</span><span style="color:#111">{})</span><span style="color:#f92672">%</span><span style="color:#75af00">cpu</span><span style="color:#111">.</span><span style="color:#75af00">CacheLinePadSize</span><span style="color:#111">)</span> <span style="color:#f92672">%</span> <span style="color:#75af00">cpu</span><span style="color:#111">.</span><span style="color:#75af00">CacheLinePadSize</span><span style="color:#111">]</span><span style="color:#00a8c8">byte</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">stackpoolItem</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">_</span>    <span style="color:#75af00">sys</span><span style="color:#111">.</span><span style="color:#75af00">NotInHeap</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">mu</span>   <span style="color:#75af00">mutex</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">span</span> <span style="color:#75af00">mSpanList</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">stackpoolalloc</span><span style="color:#111">(</span><span style="color:#75af00">order</span> <span style="color:#00a8c8">uint8</span><span style="color:#111">)</span> <span style="color:#75af00">gclinkptr</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">list</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">stackpool</span><span style="color:#111">[</span><span style="color:#75af00">order</span><span style="color:#111">].</span><span style="color:#75af00">item</span><span style="color:#111">.</span><span style="color:#75af00">span</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">s</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">list</span><span style="color:#111">.</span><span style="color:#75af00">first</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">s</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 从 mheap 中申请 class = 0 对应页数的</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">s</span> <span style="color:#111">=</span> <span style="color:#75af00">mheap_</span><span style="color:#111">.</span><span style="color:#75af00">allocManual</span><span style="color:#111">(</span><span style="color:#75af00">_StackCacheSize</span><span style="color:#f92672">&gt;&gt;</span><span style="color:#75af00">_PageShift</span><span style="color:#111">,</span> <span style="color:#75af00">spanAllocStack</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// ...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 分配内存</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">x</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">manualFreeList</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">x</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p><strong>stackcache</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">mcache</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">stackcache</span> <span style="color:#111">[</span><span style="color:#75af00">_NumStackOrders</span><span style="color:#111">]</span><span style="color:#75af00">stackfreelist</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">stackfreelist</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">list</span> <span style="color:#75af00">gclinkptr</span> 
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">size</span> <span style="color:#00a8c8">uintptr</span>  
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">gclinkptr</span> <span style="color:#00a8c8">uintptr</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">p</span> <span style="color:#75af00">gclinkptr</span><span style="color:#111">)</span> <span style="color:#75af00">ptr</span><span style="color:#111">()</span> <span style="color:#f92672">*</span><span style="color:#75af00">gclink</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">gclink</span><span style="color:#111">)(</span><span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">(</span><span style="color:#75af00">p</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p><strong>stackcacherefill</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">stackcacherefill</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">mcache</span><span style="color:#111">,</span> <span style="color:#75af00">order</span> <span style="color:#00a8c8">uint8</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">size</span> <span style="color:#111">&lt;</span> <span style="color:#75af00">_StackCacheSize</span><span style="color:#f92672">/</span><span style="color:#ae81ff">2</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">x</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">stackpoolalloc</span><span style="color:#111">(</span><span style="color:#75af00">order</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">x</span><span style="color:#111">.</span><span style="color:#75af00">ptr</span><span style="color:#111">().</span><span style="color:#75af00">next</span> <span style="color:#111">=</span> <span style="color:#75af00">list</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">list</span> <span style="color:#111">=</span> <span style="color:#75af00">x</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">size</span> <span style="color:#f92672">+=</span> <span style="color:#75af00">fixedStack</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#75af00">order</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">unlock</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">stackpool</span><span style="color:#111">[</span><span style="color:#75af00">order</span><span style="color:#111">].</span><span style="color:#75af00">item</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">stackcache</span><span style="color:#111">[</span><span style="color:#75af00">order</span><span style="color:#111">].</span><span style="color:#75af00">list</span> <span style="color:#111">=</span> <span style="color:#75af00">list</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">stackcache</span><span style="color:#111">[</span><span style="color:#75af00">order</span><span style="color:#111">].</span><span style="color:#75af00">size</span> <span style="color:#111">=</span> <span style="color:#75af00">size</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="回收">回收</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">//Goexit -&gt; goexit1 -&gt; goexit0 -&gt; gdestroy</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">gdestroy</span><span style="color:#111">(</span><span style="color:#75af00">gp</span> <span style="color:#f92672">*</span><span style="color:#75af00">g</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ......</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 修改状态</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">casgstatus</span><span style="color:#111">(</span><span style="color:#75af00">gp</span><span style="color:#111">,</span> <span style="color:#75af00">_Grunning</span><span style="color:#111">,</span> <span style="color:#75af00">_Gdead</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 把 gp 的变量制空 .......</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 把 m 上的 g 制空</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">dropg</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">gfput</span><span style="color:#111">(</span><span style="color:#75af00">pp</span><span style="color:#111">,</span> <span style="color:#75af00">gp</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">gfput</span><span style="color:#111">(</span><span style="color:#75af00">pp</span> <span style="color:#f92672">*</span><span style="color:#75af00">p</span><span style="color:#111">,</span> <span style="color:#75af00">gp</span> <span style="color:#f92672">*</span><span style="color:#75af00">g</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ......</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">stksize</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">gp</span><span style="color:#111">.</span><span style="color:#75af00">stack</span><span style="color:#111">.</span><span style="color:#75af00">hi</span> <span style="color:#f92672">-</span> <span style="color:#75af00">gp</span><span style="color:#111">.</span><span style="color:#75af00">stack</span><span style="color:#111">.</span><span style="color:#75af00">lo</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 如果栈不是默认大小 直接释放掉 只有默认大小才去复用</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">stksize</span> <span style="color:#f92672">!=</span> <span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">startingStackSize</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// non-standard stack size - free it.</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">stackfree</span><span style="color:#111">(</span><span style="color:#75af00">gp</span><span style="color:#111">.</span><span style="color:#75af00">stack</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">gp</span><span style="color:#111">.</span><span style="color:#75af00">stack</span><span style="color:#111">.</span><span style="color:#75af00">lo</span> <span style="color:#111">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">gp</span><span style="color:#111">.</span><span style="color:#75af00">stack</span><span style="color:#111">.</span><span style="color:#75af00">hi</span> <span style="color:#111">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">gp</span><span style="color:#111">.</span><span style="color:#75af00">stackguard0</span> <span style="color:#111">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 将 goroutine 放入空闲队列</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">pp</span><span style="color:#111">.</span><span style="color:#75af00">gFree</span><span style="color:#111">.</span><span style="color:#75af00">push</span><span style="color:#111">(</span><span style="color:#75af00">gp</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">pp</span><span style="color:#111">.</span><span style="color:#75af00">gFree</span><span style="color:#111">.</span><span style="color:#75af00">n</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 如果到达 64 个 goroutine 就把一部分放到全局队列中</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">pp</span><span style="color:#111">.</span><span style="color:#75af00">gFree</span><span style="color:#111">.</span><span style="color:#75af00">n</span> <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">64</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">var</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">inc</span>      <span style="color:#00a8c8">int32</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">stackQ</span>   <span style="color:#75af00">gQueue</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">noStackQ</span> <span style="color:#75af00">gQueue</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">for</span> <span style="color:#75af00">pp</span><span style="color:#111">.</span><span style="color:#75af00">gFree</span><span style="color:#111">.</span><span style="color:#75af00">n</span> <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">32</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">gp</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">pp</span><span style="color:#111">.</span><span style="color:#75af00">gFree</span><span style="color:#111">.</span><span style="color:#75af00">pop</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">pp</span><span style="color:#111">.</span><span style="color:#75af00">gFree</span><span style="color:#111">.</span><span style="color:#75af00">n</span><span style="color:#f92672">--</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">gp</span><span style="color:#111">.</span><span style="color:#75af00">stack</span><span style="color:#111">.</span><span style="color:#75af00">lo</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">noStackQ</span><span style="color:#111">.</span><span style="color:#75af00">push</span><span style="color:#111">(</span><span style="color:#75af00">gp</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">stackQ</span><span style="color:#111">.</span><span style="color:#75af00">push</span><span style="color:#111">(</span><span style="color:#75af00">gp</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">inc</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">lock</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">sched</span><span style="color:#111">.</span><span style="color:#75af00">gFree</span><span style="color:#111">.</span><span style="color:#75af00">lock</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">sched</span><span style="color:#111">.</span><span style="color:#75af00">gFree</span><span style="color:#111">.</span><span style="color:#75af00">noStack</span><span style="color:#111">.</span><span style="color:#75af00">pushAll</span><span style="color:#111">(</span><span style="color:#75af00">noStackQ</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">sched</span><span style="color:#111">.</span><span style="color:#75af00">gFree</span><span style="color:#111">.</span><span style="color:#75af00">stack</span><span style="color:#111">.</span><span style="color:#75af00">pushAll</span><span style="color:#111">(</span><span style="color:#75af00">stackQ</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">sched</span><span style="color:#111">.</span><span style="color:#75af00">gFree</span><span style="color:#111">.</span><span style="color:#75af00">n</span> <span style="color:#f92672">+=</span> <span style="color:#75af00">inc</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">unlock</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">sched</span><span style="color:#111">.</span><span style="color:#75af00">gFree</span><span style="color:#111">.</span><span style="color:#75af00">lock</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p><strong>stackfree</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">stackfree</span><span style="color:#111">(</span><span style="color:#75af00">stk</span> <span style="color:#75af00">stack</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ......</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">n</span> <span style="color:#111">&lt;</span> <span style="color:#75af00">fixedStack</span><span style="color:#f92672">&lt;&lt;</span><span style="color:#75af00">_NumStackOrders</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">n</span> <span style="color:#111">&lt;</span> <span style="color:#75af00">_StackCacheSize</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 小栈（&lt; 32k） 留着复用一下</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">order</span> <span style="color:#f92672">:=</span> <span style="color:#111">uint8</span><span style="color:#111">(</span><span style="color:#ae81ff">0</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">n2</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">n</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">for</span> <span style="color:#75af00">n2</span> <span style="color:#111">&gt;</span> <span style="color:#75af00">fixedStack</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">order</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">n2</span> <span style="color:#f92672">&gt;&gt;=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">x</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">gclinkptr</span><span style="color:#111">(</span><span style="color:#75af00">v</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		 <span style="color:#75715e">// 如果不使用缓存或当前处理器被抢占，使用全局栈池</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">stackNoCache</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">||</span> <span style="color:#75af00">gp</span><span style="color:#111">.</span><span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">p</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">||</span> <span style="color:#75af00">gp</span><span style="color:#111">.</span><span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">preemptoff</span> <span style="color:#f92672">!=</span> <span style="color:#d88200">&#34;&#34;</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">lock</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">stackpool</span><span style="color:#111">[</span><span style="color:#75af00">order</span><span style="color:#111">].</span><span style="color:#75af00">item</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">stackpoolfree</span><span style="color:#111">(</span><span style="color:#75af00">x</span><span style="color:#111">,</span> <span style="color:#75af00">order</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">unlock</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">stackpool</span><span style="color:#111">[</span><span style="color:#75af00">order</span><span style="color:#111">].</span><span style="color:#75af00">item</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 否则，使用本地缓存</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">c</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">gp</span><span style="color:#111">.</span><span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">ptr</span><span style="color:#111">().</span><span style="color:#75af00">mcache</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">stackcache</span><span style="color:#111">[</span><span style="color:#75af00">order</span><span style="color:#111">].</span><span style="color:#75af00">size</span> <span style="color:#f92672">&gt;=</span> <span style="color:#75af00">_StackCacheSize</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">stackcacherelease</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">,</span> <span style="color:#75af00">order</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">x</span><span style="color:#111">.</span><span style="color:#75af00">ptr</span><span style="color:#111">().</span><span style="color:#75af00">next</span> <span style="color:#111">=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">stackcache</span><span style="color:#111">[</span><span style="color:#75af00">order</span><span style="color:#111">].</span><span style="color:#75af00">list</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">stackcache</span><span style="color:#111">[</span><span style="color:#75af00">order</span><span style="color:#111">].</span><span style="color:#75af00">list</span> <span style="color:#111">=</span> <span style="color:#75af00">x</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">stackcache</span><span style="color:#111">[</span><span style="color:#75af00">order</span><span style="color:#111">].</span><span style="color:#75af00">size</span> <span style="color:#f92672">+=</span> <span style="color:#75af00">n</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 如果栈大小不适合缓存，检查其 span 状态并相应处理</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">s</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">spanOfUnchecked</span><span style="color:#111">(</span><span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">v</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">state</span><span style="color:#111">.</span><span style="color:#75af00">get</span><span style="color:#111">()</span> <span style="color:#f92672">!=</span> <span style="color:#75af00">mSpanManual</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">println</span><span style="color:#111">(</span><span style="color:#75af00">hex</span><span style="color:#111">(</span><span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">base</span><span style="color:#111">()),</span> <span style="color:#75af00">v</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">throw</span><span style="color:#111">(</span><span style="color:#d88200">&#34;bad span state&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">gcphase</span> <span style="color:#f92672">==</span> <span style="color:#75af00">_GCoff</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 如果 GC 未运行，立即释放栈</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">osStackFree</span><span style="color:#111">(</span><span style="color:#75af00">s</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">mheap_</span><span style="color:#111">.</span><span style="color:#75af00">freeManual</span><span style="color:#111">(</span><span style="color:#75af00">s</span><span style="color:#111">,</span> <span style="color:#75af00">spanAllocStack</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 如果 GC 运行中，将栈添加到大栈缓存，避免与 GC 竞态</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">log2npage</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">stacklog2</span><span style="color:#111">(</span><span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">npages</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">lock</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">stackLarge</span><span style="color:#111">.</span><span style="color:#75af00">lock</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">stackLarge</span><span style="color:#111">.</span><span style="color:#75af00">free</span><span style="color:#111">[</span><span style="color:#75af00">log2npage</span><span style="color:#111">].</span><span style="color:#75af00">insert</span><span style="color:#111">(</span><span style="color:#75af00">s</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">unlock</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">stackLarge</span><span style="color:#111">.</span><span style="color:#75af00">lock</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div>]]></content:encoded><category>go</category><category>go</category></item><item><title>从源码分析 GMP 调度原理</title><link>https://daemon365.dev/post/go/gmp_code/</link><pubDate>Sat, 07 Dec 2024 14:23:31 +0800</pubDate><guid>https://daemon365.dev/post/go/gmp_code/</guid><description>&lt;p&gt;&lt;strong&gt;本身涉及到的 go 代码 都是基于 go 1.23.0 版本&lt;/strong&gt;&lt;/p&gt;
&lt;h2 id="传统-os-线程"&gt;传统 OS 线程&lt;/h2&gt;
&lt;p&gt;线程是 CPU 的最小调度单位，CPU 通过不断切换线程来实现多任务的并发。这会引发一些问题（对于用户角度）：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;线程的创建和销毁等是昂贵的，因为要不断在用户空间和内核空间切换。&lt;/li&gt;
&lt;li&gt;线程的调度是由操作系统负责的，用户无法控制。而操作系统又可能不知道线程已经 IO 阻塞，导致线程被调度，浪费 CPU 资源。&lt;/li&gt;
&lt;li&gt;线程的栈是很大的，最新版 linux 默认是 8M，会引起内存浪费。&lt;/li&gt;
&lt;li&gt;&amp;hellip;&amp;hellip;&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;所以，最简单的办法就是复用线程，go 中使用的是 M:N 模型，即 M 个 OS 线程对应 N 个 任务。&lt;/p&gt;
&lt;h2 id="gmp-模型"&gt;GMP 模型&lt;/h2&gt;
&lt;ol&gt;
&lt;li&gt;G&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;goroutine, 一个 goroutine 代表一个任务。它有自己的栈空间，默认是 2K，栈空间可以动态增长。方式就是把旧的栈空间复制到新的栈空间，然后释放旧的栈空间。它的栈是在 heap （对于 OS） 上分配的。&lt;/p&gt;
&lt;ol start="2"&gt;
&lt;li&gt;M&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;machine, 一个 M 代表一个 OS 线程。&lt;/p&gt;
&lt;ol start="3"&gt;
&lt;li&gt;P&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;processor, 一个 P 代表一个逻辑处理器，它维护了一个 goroutine 队列。P 会把 goroutine 分配给 M，M 会执行 goroutine。默认的大小为 CPU 核心数。&lt;/p&gt;</description><content:encoded><![CDATA[<p><strong>本身涉及到的 go 代码 都是基于 go 1.23.0 版本</strong></p>
<h2 id="传统-os-线程">传统 OS 线程</h2>
<p>线程是 CPU 的最小调度单位，CPU 通过不断切换线程来实现多任务的并发。这会引发一些问题（对于用户角度）：</p>
<ol>
<li>线程的创建和销毁等是昂贵的，因为要不断在用户空间和内核空间切换。</li>
<li>线程的调度是由操作系统负责的，用户无法控制。而操作系统又可能不知道线程已经 IO 阻塞，导致线程被调度，浪费 CPU 资源。</li>
<li>线程的栈是很大的，最新版 linux 默认是 8M，会引起内存浪费。</li>
<li>&hellip;&hellip;</li>
</ol>
<p>所以，最简单的办法就是复用线程，go 中使用的是 M:N 模型，即 M 个 OS 线程对应 N 个 任务。</p>
<h2 id="gmp-模型">GMP 模型</h2>
<ol>
<li>G</li>
</ol>
<p>goroutine, 一个 goroutine 代表一个任务。它有自己的栈空间，默认是 2K，栈空间可以动态增长。方式就是把旧的栈空间复制到新的栈空间，然后释放旧的栈空间。它的栈是在 heap （对于 OS） 上分配的。</p>
<ol start="2">
<li>M</li>
</ol>
<p>machine, 一个 M 代表一个 OS 线程。</p>
<ol start="3">
<li>P</li>
</ol>
<p>processor, 一个 P 代表一个逻辑处理器，它维护了一个 goroutine 队列。P 会把 goroutine 分配给 M，M 会执行 goroutine。默认的大小为 CPU 核心数。</p>
<p><img src="/images/gmp.png" alt=""></p>
<h2 id="数据结构">数据结构</h2>
<h3 id="g">G</h3>
<p>结构体在 <code>src/runtime/runtime2.go</code> 中定义，主要介绍一些重要的字段：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">g</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// goroutine 的栈 两个地址，分别是栈的起始地址和结束地址</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75af00">stack</span>       <span style="color:#75af00">stack</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 绑定的m</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75af00">m</span>         <span style="color:#f92672">*</span><span style="color:#75af00">m</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// goroutine 被调度走保存的中间状态</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75af00">sched</span>     <span style="color:#75af00">gobuf</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// goroutine 的状态</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75af00">atomicstatus</span> <span style="color:#75af00">atomic</span><span style="color:#111">.</span><span style="color:#75af00">Uint32</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">gobuf</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">sp</span>   <span style="color:#00a8c8">uintptr</span> <span style="color:#75715e">// stack pointer 栈指针</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">pc</span>   <span style="color:#00a8c8">uintptr</span> <span style="color:#75715e">// program counter 程序要从哪里开始执行</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">g</span>    <span style="color:#75af00">guintptr</span> <span style="color:#75715e">// goroutine 的 指针</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ctxt</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span> <span style="color:#75715e">// 保存的上下文</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ret</span>  <span style="color:#00a8c8">uintptr</span> <span style="color:#75715e">// 返回地址</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">lr</span>   <span style="color:#00a8c8">uintptr</span> <span style="color:#75715e">// link register</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">bp</span>   <span style="color:#00a8c8">uintptr</span> <span style="color:#75715e">// base pointer 栈的基地址</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h4 id="goroutine-状态">goroutine 状态</h4>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// defined constants</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">const</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 未初始化</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">_Gidle</span> <span style="color:#111">=</span> <span style="color:#00a8c8">iota</span> <span style="color:#75715e">// 0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 准备好了 可以被 P 调度</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">_Grunnable</span> <span style="color:#75715e">// 1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 正在执行中</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">_Grunning</span> <span style="color:#75715e">// 2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 正在执行系统调用</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">_Gsyscall</span> <span style="color:#75715e">// 3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 正在等待 例如 channel network 等</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">_Gwaiting</span> <span style="color:#75715e">// 4</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 没有被使用 为了兼容性</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">_Gmoribund_unused</span> <span style="color:#75715e">// 5</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 未使用的 goroutine </span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 1. 可能初始化了但是没有被使用 </span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 2. 因为会复用未扩栈的 goroutine 所以也可能上次使用完了 还没继续使用</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">_Gdead</span> <span style="color:#75715e">// 6</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 没有被使用 为了兼容性</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">_Genqueue_unused</span> <span style="color:#75715e">// 7</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 栈扩容中</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">_Gcopystack</span> <span style="color:#75715e">// 8</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 被抢占了 等待到 _Gwaiting </span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">_Gpreempted</span> <span style="color:#75715e">// 9</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 用于 GC 扫描</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">_Gscan</span>          <span style="color:#111">=</span> <span style="color:#ae81ff">0x1000</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">_Gscanrunnable</span>  <span style="color:#111">=</span> <span style="color:#75af00">_Gscan</span> <span style="color:#f92672">+</span> <span style="color:#75af00">_Grunnable</span>  <span style="color:#75715e">// 0x1001</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">_Gscanrunning</span>   <span style="color:#111">=</span> <span style="color:#75af00">_Gscan</span> <span style="color:#f92672">+</span> <span style="color:#75af00">_Grunning</span>   <span style="color:#75715e">// 0x1002</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">_Gscansyscall</span>   <span style="color:#111">=</span> <span style="color:#75af00">_Gscan</span> <span style="color:#f92672">+</span> <span style="color:#75af00">_Gsyscall</span>   <span style="color:#75715e">// 0x1003</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">_Gscanwaiting</span>   <span style="color:#111">=</span> <span style="color:#75af00">_Gscan</span> <span style="color:#f92672">+</span> <span style="color:#75af00">_Gwaiting</span>   <span style="color:#75715e">// 0x1004</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">_Gscanpreempted</span> <span style="color:#111">=</span> <span style="color:#75af00">_Gscan</span> <span style="color:#f92672">+</span> <span style="color:#75af00">_Gpreempted</span> <span style="color:#75715e">// 0x1009</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span></code></pre></div><h4 id="g-的创建">G 的创建</h4>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">malg</span><span style="color:#111">(</span><span style="color:#75af00">stacksize</span> <span style="color:#00a8c8">int32</span><span style="color:#111">)</span> <span style="color:#f92672">*</span><span style="color:#75af00">g</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">newg</span> <span style="color:#f92672">:=</span> <span style="color:#111">new</span><span style="color:#111">(</span><span style="color:#75af00">g</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 分配 runtime 栈</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">stacksize</span> <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">stacksize</span> <span style="color:#111">=</span> <span style="color:#75af00">round2</span><span style="color:#111">(</span><span style="color:#75af00">stackSystem</span> <span style="color:#f92672">+</span> <span style="color:#75af00">stacksize</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">systemstack</span><span style="color:#111">(</span><span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">newg</span><span style="color:#111">.</span><span style="color:#75af00">stack</span> <span style="color:#111">=</span> <span style="color:#75af00">stackalloc</span><span style="color:#111">(</span><span style="color:#111">uint32</span><span style="color:#111">(</span><span style="color:#75af00">stacksize</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">newg</span><span style="color:#111">.</span><span style="color:#75af00">stackguard0</span> <span style="color:#111">=</span> <span style="color:#75af00">newg</span><span style="color:#111">.</span><span style="color:#75af00">stack</span><span style="color:#111">.</span><span style="color:#75af00">lo</span> <span style="color:#f92672">+</span> <span style="color:#75af00">stackGuard</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">newg</span><span style="color:#111">.</span><span style="color:#75af00">stackguard1</span> <span style="color:#111">=</span> <span style="color:#111">^</span><span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#ae81ff">0</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">*</span><span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#00a8c8">uintptr</span><span style="color:#111">)(</span><span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">(</span><span style="color:#75af00">newg</span><span style="color:#111">.</span><span style="color:#75af00">stack</span><span style="color:#111">.</span><span style="color:#75af00">lo</span><span style="color:#111">))</span> <span style="color:#111">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">newg</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>状态流转:</p>
<p><img src="/images/gmp_g_status.png" alt=""></p>
<ol>
<li>如果 groutine 还未初始化，那么状态是 <code>_Gidle</code></li>
<li>初始化完毕是 <code>_Gdead</code></li>
<li>当被调用 go func() 时，状态变为 <code>_Grunnable</code></li>
<li>当被调度到 M 上执行时，状态变为 <code>_Grunning</code></li>
<li>执行完毕后，状态变为 <code>_Gdead</code></li>
<li>如果 goroutine 阻塞，状态变为 <code>_Gwaiting</code> 等待阻塞完毕 状态再变为 <code>_Grunnable</code> 等待调度</li>
<li>如果 goroutine 被抢占 （gc 要 STW 时），状态变为 <code>_Gpreempted</code> 等待变成 <code>_Gwaiting</code></li>
<li>如果发生系统调用，状态变为 <code>_Gsyscall</code> 如果很快完成（10ms） 状态会变为 <code>_Grunning</code> 继续执行 否则会变为 <code>_Grunnable</code> 等待调度</li>
<li>如果发生栈扩容，状态变为 <code>_Gcopystack</code> 等待栈扩容完毕 状态变为 <code>_Grunning</code> 等待调度</li>
</ol>
<h3 id="m">M</h3>
<p>结构体在 <code>src/runtime/runtime2.go</code> 中定义，主要介绍一些重要的字段：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">m</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75af00">g0</span>      <span style="color:#f92672">*</span><span style="color:#75af00">g</span>  
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 寄存器上下文</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75af00">morebuf</span> <span style="color:#75af00">gobuf</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// tls 是线程本地存储 用于存储 M 相关的线程本地数据 包括当前 G 的引用等重要信息</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75af00">tls</span>           <span style="color:#111">[</span><span style="color:#75af00">tlsSlots</span><span style="color:#111">]</span><span style="color:#00a8c8">uintptr</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 现在正在执行的 goroutine</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75af00">curg</span>          <span style="color:#f92672">*</span><span style="color:#75af00">g</span> 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 1. 正常执行： p 有效</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 2. 系统调用前： p -&gt; oldp</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 3. 系统调用中： p == nil</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 4. 系统调用返回： 尝试重新获取 oldp</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">p</span>             <span style="color:#75af00">puintptr</span> 
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">nextp</span>         <span style="color:#75af00">puintptr</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">oldp</span>          <span style="color:#75af00">puintptr</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h4 id="m-的创建">M 的创建</h4>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">newm</span><span style="color:#111">(</span><span style="color:#75af00">fn</span> <span style="color:#00a8c8">func</span><span style="color:#111">(),</span> <span style="color:#75af00">pp</span> <span style="color:#f92672">*</span><span style="color:#75af00">p</span><span style="color:#111">,</span> <span style="color:#75af00">id</span> <span style="color:#00a8c8">int64</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 禁止被抢占</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">acquirem</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 分配 M 结构体 并添加列表中</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">mp</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">allocm</span><span style="color:#111">(</span><span style="color:#75af00">pp</span><span style="color:#111">,</span> <span style="color:#75af00">fn</span><span style="color:#111">,</span> <span style="color:#75af00">id</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 设置 nextP m 会尽量与之绑定</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">mp</span><span style="color:#111">.</span><span style="color:#75af00">nextp</span><span style="color:#111">.</span><span style="color:#75af00">set</span><span style="color:#111">(</span><span style="color:#75af00">pp</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">mp</span><span style="color:#111">.</span><span style="color:#75af00">sigmask</span> <span style="color:#111">=</span> <span style="color:#75af00">initSigmask</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 创建 M</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">newm1</span><span style="color:#111">(</span><span style="color:#75af00">mp</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 释放 m 的锁定状态</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">releasem</span><span style="color:#111">(</span><span style="color:#75af00">getg</span><span style="color:#111">().</span><span style="color:#75af00">m</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">allocm</span><span style="color:#111">(</span><span style="color:#75af00">pp</span> <span style="color:#f92672">*</span><span style="color:#75af00">p</span><span style="color:#111">,</span> <span style="color:#75af00">fn</span> <span style="color:#00a8c8">func</span><span style="color:#111">(),</span> <span style="color:#75af00">id</span> <span style="color:#00a8c8">int64</span><span style="color:#111">)</span> <span style="color:#f92672">*</span><span style="color:#75af00">m</span> <span style="color:#111">{</span>	
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ... 加锁解锁</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 如果当前 M 没有绑定 P，临时借用传入的 P</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">gp</span><span style="color:#111">.</span><span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">p</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">acquirep</span><span style="color:#111">(</span><span style="color:#75af00">pp</span><span style="color:#111">)</span> <span style="color:#75715e">// temporarily borrow p for mallocs in this function</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 处理空闲的 M </span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">sched</span><span style="color:#111">.</span><span style="color:#75af00">freem</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 创建 M</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">mp</span> <span style="color:#f92672">:=</span> <span style="color:#111">new</span><span style="color:#111">(</span><span style="color:#75af00">m</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">mp</span><span style="color:#111">.</span><span style="color:#75af00">mstartfn</span> <span style="color:#111">=</span> <span style="color:#75af00">fn</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">mcommoninit</span><span style="color:#111">(</span><span style="color:#75af00">mp</span><span style="color:#111">,</span> <span style="color:#75af00">id</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 对于 cgo 或者特定的操作系统 使用系统分配的栈 否则使用 go runtime 的栈</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">iscgo</span> <span style="color:#f92672">||</span> <span style="color:#75af00">mStackIsSystemAllocated</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">mp</span><span style="color:#111">.</span><span style="color:#75af00">g0</span> <span style="color:#111">=</span> <span style="color:#75af00">malg</span><span style="color:#111">(</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">mp</span><span style="color:#111">.</span><span style="color:#75af00">g0</span> <span style="color:#111">=</span> <span style="color:#75af00">malg</span><span style="color:#111">(</span><span style="color:#ae81ff">16384</span> <span style="color:#f92672">*</span> <span style="color:#75af00">sys</span><span style="color:#111">.</span><span style="color:#75af00">StackGuardMultiplier</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">mp</span><span style="color:#111">.</span><span style="color:#75af00">g0</span><span style="color:#111">.</span><span style="color:#75af00">m</span> <span style="color:#111">=</span> <span style="color:#75af00">mp</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 清理临时借用的 P</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">pp</span> <span style="color:#f92672">==</span> <span style="color:#75af00">gp</span><span style="color:#111">.</span><span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">ptr</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">releasep</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">mp</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// newm1 -&gt; newosproc </span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">newosproc</span><span style="color:#111">(</span><span style="color:#75af00">mp</span> <span style="color:#f92672">*</span><span style="color:#75af00">m</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 栈顶指针</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">stk</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">(</span><span style="color:#75af00">mp</span><span style="color:#111">.</span><span style="color:#75af00">g0</span><span style="color:#111">.</span><span style="color:#75af00">stack</span><span style="color:#111">.</span><span style="color:#75af00">hi</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 信号屏蔽</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">var</span> <span style="color:#75af00">oset</span> <span style="color:#75af00">sigset</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">sigprocmask</span><span style="color:#111">(</span><span style="color:#75af00">_SIG_SETMASK</span><span style="color:#111">,</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">sigset_all</span><span style="color:#111">,</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">oset</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 重试的系统调用</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ret</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">retryOnEAGAIN</span><span style="color:#111">(</span><span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#00a8c8">int32</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 创建新线程 是汇编代码 可以找去看看</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">r</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">clone</span><span style="color:#111">(</span><span style="color:#75af00">cloneFlags</span><span style="color:#111">,</span> <span style="color:#75af00">stk</span><span style="color:#111">,</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">(</span><span style="color:#75af00">mp</span><span style="color:#111">),</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">(</span><span style="color:#75af00">mp</span><span style="color:#111">.</span><span style="color:#75af00">g0</span><span style="color:#111">),</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">(</span><span style="color:#75af00">abi</span><span style="color:#111">.</span><span style="color:#75af00">FuncPCABI0</span><span style="color:#111">(</span><span style="color:#75af00">mstart</span><span style="color:#111">)))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">r</span> <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#f92672">-</span><span style="color:#75af00">r</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 恢复信号</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">sigprocmask</span><span style="color:#111">(</span><span style="color:#75af00">_SIG_SETMASK</span><span style="color:#111">,</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">oset</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ...</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// mstart 启动 M 是一个汇编代码</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">TEXT</span> <span style="color:#75af00">runtime</span><span style="color:#960050;background-color:#1e0010">·</span><span style="color:#75af00">mstart</span><span style="color:#111">(</span><span style="color:#75af00">SB</span><span style="color:#111">),</span><span style="color:#75af00">NOSPLIT</span><span style="color:#111">|</span><span style="color:#75af00">TOPFRAME</span><span style="color:#111">|</span><span style="color:#75af00">NOFRAME</span><span style="color:#111">,</span><span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">CALL</span>	<span style="color:#75af00">runtime</span><span style="color:#960050;background-color:#1e0010">·</span><span style="color:#75af00">mstart0</span><span style="color:#111">(</span><span style="color:#75af00">SB</span><span style="color:#111">)</span> <span style="color:#75715e">// 调用 mstart0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">RET</span> <span style="color:#75715e">// not reached</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// mstart0 -&gt; mstart1</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">mstart1</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">gp</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">getg</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">gp</span> <span style="color:#f92672">!=</span> <span style="color:#75af00">gp</span><span style="color:#111">.</span><span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">g0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">throw</span><span style="color:#111">(</span><span style="color:#d88200">&#34;bad runtime·mstart&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 保存调度信息</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">gp</span><span style="color:#111">.</span><span style="color:#75af00">sched</span><span style="color:#111">.</span><span style="color:#75af00">g</span> <span style="color:#111">=</span> <span style="color:#75af00">guintptr</span><span style="color:#111">(</span><span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">(</span><span style="color:#75af00">gp</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">gp</span><span style="color:#111">.</span><span style="color:#75af00">sched</span><span style="color:#111">.</span><span style="color:#75af00">pc</span> <span style="color:#111">=</span> <span style="color:#75af00">getcallerpc</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">gp</span><span style="color:#111">.</span><span style="color:#75af00">sched</span><span style="color:#111">.</span><span style="color:#75af00">sp</span> <span style="color:#111">=</span> <span style="color:#75af00">getcallersp</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 初始化</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">asminit</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">minit</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 主线程初始一些东西</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">gp</span><span style="color:#111">.</span><span style="color:#75af00">m</span> <span style="color:#f92672">==</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">m0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">mstartm0</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 调度</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">schedule</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 初始化信号 之后抢占那块会介绍</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 只有主线程需要初始化的原因是 其他线程是 clone 而来 而且包括了 _CLONE_SIGHAND 会继承这些</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">mstartm0</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">initsig</span><span style="color:#111">(</span><span style="color:#00a8c8">false</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>g0： 一个特殊的 g 用于执行调度任务</p>
<p><img src="/images/gmp_g0.png" alt=""></p>
<p>流程大概为用户态的 g -&gt; g0 调度 -&gt; 用户的其他 g</p>
<h3 id="p">P</h3>
<p>结构体在 <code>src/runtime/runtime2.go</code> 中定义，主要介绍一些重要的字段：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">p</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// p 的状态</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">status</span>      <span style="color:#00a8c8">uint32</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 分配内存使用 每个p 都有的目的是少加锁</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75af00">mcache</span>      <span style="color:#f92672">*</span><span style="color:#75af00">mcache</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 定长的 queue 用于存储 goroutine</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75af00">runqhead</span> <span style="color:#00a8c8">uint32</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">runqtail</span> <span style="color:#00a8c8">uint32</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">runq</span>     <span style="color:#111">[</span><span style="color:#ae81ff">256</span><span style="color:#111">]</span><span style="color:#75af00">guintptr</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">//  下个运行的 goroutine 主要用来快速调度 比如从 chan 读取数据，把 g 放到 runnext 中 当完成读取时 直接从 runnext 中取出来执行</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75af00">runnext</span> <span style="color:#75af00">guintptr</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>状态：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">const</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 空闲</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">_Pidle</span> <span style="color:#111">=</span> <span style="color:#00a8c8">iota</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 正在运行中</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">_Prunning</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 正在执行系统调用</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">_Psyscall</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// GC 停止</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">_Pgcstop</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 死亡状态</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">_Pdead</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span></code></pre></div><h4 id="p的创建">P的创建</h4>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// 程序启动</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">TEXT</span> <span style="color:#75af00">main</span><span style="color:#111">(</span><span style="color:#75af00">SB</span><span style="color:#111">),</span><span style="color:#75af00">NOSPLIT</span><span style="color:#111">,</span><span style="color:#960050;background-color:#1e0010">$</span><span style="color:#f92672">-</span><span style="color:#ae81ff">8</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">JMP</span>	<span style="color:#75af00">runtime</span><span style="color:#960050;background-color:#1e0010">·</span><span style="color:#75af00">rt0_go</span><span style="color:#111">(</span><span style="color:#75af00">SB</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">TEXT</span> <span style="color:#75af00">runtime</span><span style="color:#960050;background-color:#1e0010">·</span><span style="color:#75af00">rt0_go</span><span style="color:#111">(</span><span style="color:#75af00">SB</span><span style="color:#111">),</span><span style="color:#75af00">NOSPLIT</span><span style="color:#111">|</span><span style="color:#75af00">NOFRAME</span><span style="color:#111">|</span><span style="color:#75af00">TOPFRAME</span><span style="color:#111">,</span><span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// ...</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">CALL</span>	<span style="color:#75af00">runtime</span><span style="color:#960050;background-color:#1e0010">·</span><span style="color:#75af00">schedinit</span><span style="color:#111">(</span><span style="color:#75af00">SB</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">schedinit</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">procresize</span><span style="color:#111">(</span><span style="color:#75af00">procs</span><span style="color:#111">)</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">throw</span><span style="color:#111">(</span><span style="color:#d88200">&#34;unknown runnable goroutine during bootstrap&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// nprocs 是 process 数 默认是 cpu 个数</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">procresize</span><span style="color:#111">(</span><span style="color:#75af00">nprocs</span> <span style="color:#00a8c8">int32</span><span style="color:#111">)</span> <span style="color:#f92672">*</span><span style="color:#75af00">p</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 扩容 allp 加入未初始化的 P</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">nprocs</span> <span style="color:#111">&gt;</span> <span style="color:#111">int32</span><span style="color:#111">(</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">allp</span><span style="color:#111">))</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 。。。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 初始化所有新建的 P</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">i</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">old</span><span style="color:#111">;</span> <span style="color:#75af00">i</span> <span style="color:#111">&lt;</span> <span style="color:#75af00">nprocs</span><span style="color:#111">;</span> <span style="color:#75af00">i</span><span style="color:#f92672">++</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">pp</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">allp</span><span style="color:#111">[</span><span style="color:#75af00">i</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">pp</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">pp</span> <span style="color:#111">=</span> <span style="color:#111">new</span><span style="color:#111">(</span><span style="color:#75af00">p</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">pp</span><span style="color:#111">.</span><span style="color:#75af00">init</span><span style="color:#111">(</span><span style="color:#75af00">i</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">atomicstorep</span><span style="color:#111">(</span><span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">allp</span><span style="color:#111">[</span><span style="color:#75af00">i</span><span style="color:#111">]),</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">(</span><span style="color:#75af00">pp</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 处理 p 的状态</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">gp</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">getg</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">gp</span><span style="color:#111">.</span><span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">p</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">gp</span><span style="color:#111">.</span><span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">ptr</span><span style="color:#111">().</span><span style="color:#75af00">id</span> <span style="color:#111">&lt;</span> <span style="color:#75af00">nprocs</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// continue to use the current P</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">gp</span><span style="color:#111">.</span><span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">ptr</span><span style="color:#111">().</span><span style="color:#75af00">status</span> <span style="color:#111">=</span> <span style="color:#75af00">_Prunning</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">gp</span><span style="color:#111">.</span><span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">ptr</span><span style="color:#111">().</span><span style="color:#75af00">mcache</span><span style="color:#111">.</span><span style="color:#75af00">prepareForSweep</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// ...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// g.m.p is now set, so we no longer need mcache0 for bootstrapping.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">mcache0</span> <span style="color:#111">=</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 清理多余的 P</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">i</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">nprocs</span><span style="color:#111">;</span> <span style="color:#75af00">i</span> <span style="color:#111">&lt;</span> <span style="color:#75af00">old</span><span style="color:#111">;</span> <span style="color:#75af00">i</span><span style="color:#f92672">++</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">pp</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">allp</span><span style="color:#111">[</span><span style="color:#75af00">i</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">pp</span><span style="color:#111">.</span><span style="color:#75af00">destroy</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// can&#39;t free P itself because it can be referenced by an M in syscall</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 裁剪 allp 切片</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#111">int32</span><span style="color:#111">(</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">allp</span><span style="color:#111">))</span> <span style="color:#f92672">!=</span> <span style="color:#75af00">nprocs</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">lock</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">allpLock</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">allp</span> <span style="color:#111">=</span> <span style="color:#75af00">allp</span><span style="color:#111">[:</span><span style="color:#75af00">nprocs</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">idlepMask</span> <span style="color:#111">=</span> <span style="color:#75af00">idlepMask</span><span style="color:#111">[:</span><span style="color:#75af00">maskWords</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">timerpMask</span> <span style="color:#111">=</span> <span style="color:#75af00">timerpMask</span><span style="color:#111">[:</span><span style="color:#75af00">maskWords</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">unlock</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">allpLock</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 重新分配 P</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">var</span> <span style="color:#75af00">runnablePs</span> <span style="color:#f92672">*</span><span style="color:#75af00">p</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">i</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">nprocs</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span><span style="color:#111">;</span> <span style="color:#75af00">i</span> <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0</span><span style="color:#111">;</span> <span style="color:#75af00">i</span><span style="color:#f92672">--</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">pp</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">allp</span><span style="color:#111">[</span><span style="color:#75af00">i</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">gp</span><span style="color:#111">.</span><span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">ptr</span><span style="color:#111">()</span> <span style="color:#f92672">==</span> <span style="color:#75af00">pp</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">continue</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">pp</span><span style="color:#111">.</span><span style="color:#75af00">status</span> <span style="color:#111">=</span> <span style="color:#75af00">_Pidle</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">runqempty</span><span style="color:#111">(</span><span style="color:#75af00">pp</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">pidleput</span><span style="color:#111">(</span><span style="color:#75af00">pp</span><span style="color:#111">,</span> <span style="color:#75af00">now</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">pp</span><span style="color:#111">.</span><span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">set</span><span style="color:#111">(</span><span style="color:#75af00">mget</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">pp</span><span style="color:#111">.</span><span style="color:#75af00">link</span><span style="color:#111">.</span><span style="color:#75af00">set</span><span style="color:#111">(</span><span style="color:#75af00">runnablePs</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">runnablePs</span> <span style="color:#111">=</span> <span style="color:#75af00">pp</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">stealOrder</span><span style="color:#111">.</span><span style="color:#75af00">reset</span><span style="color:#111">(</span><span style="color:#111">uint32</span><span style="color:#111">(</span><span style="color:#75af00">nprocs</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">var</span> <span style="color:#75af00">int32p</span> <span style="color:#f92672">*</span><span style="color:#00a8c8">int32</span> <span style="color:#111">=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">gomaxprocs</span> <span style="color:#75715e">// make compiler check that gomaxprocs is an int32</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">atomic</span><span style="color:#111">.</span><span style="color:#75af00">Store</span><span style="color:#111">((</span><span style="color:#f92672">*</span><span style="color:#00a8c8">uint32</span><span style="color:#111">)(</span><span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">(</span><span style="color:#75af00">int32p</span><span style="color:#111">)),</span> <span style="color:#111">uint32</span><span style="color:#111">(</span><span style="color:#75af00">nprocs</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">old</span> <span style="color:#f92672">!=</span> <span style="color:#75af00">nprocs</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Notify the limiter that the amount of procs has changed.</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">gcCPULimiter</span><span style="color:#111">.</span><span style="color:#75af00">resetCapacity</span><span style="color:#111">(</span><span style="color:#75af00">now</span><span style="color:#111">,</span> <span style="color:#75af00">nprocs</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">runnablePs</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">pp</span> <span style="color:#f92672">*</span><span style="color:#75af00">p</span><span style="color:#111">)</span> <span style="color:#75af00">init</span><span style="color:#111">(</span><span style="color:#75af00">id</span> <span style="color:#00a8c8">int32</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 分配 cache</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">pp</span><span style="color:#111">.</span><span style="color:#75af00">mcache</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">id</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">mcache0</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">throw</span><span style="color:#111">(</span><span style="color:#d88200">&#34;missing mcache?&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// Use the bootstrap mcache0. Only one P will get</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// mcache0: the one with ID 0.</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">pp</span><span style="color:#111">.</span><span style="color:#75af00">mcache</span> <span style="color:#111">=</span> <span style="color:#75af00">mcache0</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">pp</span><span style="color:#111">.</span><span style="color:#75af00">mcache</span> <span style="color:#111">=</span> <span style="color:#75af00">allocmcache</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ...</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">pp</span> <span style="color:#f92672">*</span><span style="color:#75af00">p</span><span style="color:#111">)</span> <span style="color:#75af00">destroy</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 枷锁 确保 stw</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">assertLockHeld</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">sched</span><span style="color:#111">.</span><span style="color:#75af00">lock</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">assertWorldStopped</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 将本地队列中的 goroutine 移到全局队列</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">pp</span><span style="color:#111">.</span><span style="color:#75af00">runqhead</span> <span style="color:#f92672">!=</span> <span style="color:#75af00">pp</span><span style="color:#111">.</span><span style="color:#75af00">runqtail</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">pp</span><span style="color:#111">.</span><span style="color:#75af00">runqtail</span><span style="color:#f92672">--</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">gp</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">pp</span><span style="color:#111">.</span><span style="color:#75af00">runq</span><span style="color:#111">[</span><span style="color:#75af00">pp</span><span style="color:#111">.</span><span style="color:#75af00">runqtail</span><span style="color:#f92672">%</span><span style="color:#111">uint32</span><span style="color:#111">(</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">pp</span><span style="color:#111">.</span><span style="color:#75af00">runq</span><span style="color:#111">))].</span><span style="color:#75af00">ptr</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">globrunqputhead</span><span style="color:#111">(</span><span style="color:#75af00">gp</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">pp</span><span style="color:#111">.</span><span style="color:#75af00">runnext</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">globrunqputhead</span><span style="color:#111">(</span><span style="color:#75af00">pp</span><span style="color:#111">.</span><span style="color:#75af00">runnext</span><span style="color:#111">.</span><span style="color:#75af00">ptr</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">pp</span><span style="color:#111">.</span><span style="color:#75af00">runnext</span> <span style="color:#111">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 清理 span</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">systemstack</span><span style="color:#111">(</span><span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">for</span> <span style="color:#75af00">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span><span style="color:#111">;</span> <span style="color:#75af00">i</span> <span style="color:#111">&lt;</span> <span style="color:#75af00">pp</span><span style="color:#111">.</span><span style="color:#75af00">mspancache</span><span style="color:#111">.</span><span style="color:#75af00">len</span><span style="color:#111">;</span> <span style="color:#75af00">i</span><span style="color:#f92672">++</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// Safe to call since the world is stopped.</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">mheap_</span><span style="color:#111">.</span><span style="color:#75af00">spanalloc</span><span style="color:#111">.</span><span style="color:#75af00">free</span><span style="color:#111">(</span><span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">(</span><span style="color:#75af00">pp</span><span style="color:#111">.</span><span style="color:#75af00">mspancache</span><span style="color:#111">.</span><span style="color:#75af00">buf</span><span style="color:#111">[</span><span style="color:#75af00">i</span><span style="color:#111">]))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">pp</span><span style="color:#111">.</span><span style="color:#75af00">mspancache</span><span style="color:#111">.</span><span style="color:#75af00">len</span> <span style="color:#111">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">lock</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">mheap_</span><span style="color:#111">.</span><span style="color:#75af00">lock</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">pp</span><span style="color:#111">.</span><span style="color:#75af00">pcache</span><span style="color:#111">.</span><span style="color:#75af00">flush</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">mheap_</span><span style="color:#111">.</span><span style="color:#75af00">pages</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">unlock</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">mheap_</span><span style="color:#111">.</span><span style="color:#75af00">lock</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 释放 mcache</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">freemcache</span><span style="color:#111">(</span><span style="color:#75af00">pp</span><span style="color:#111">.</span><span style="color:#75af00">mcache</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">pp</span><span style="color:#111">.</span><span style="color:#75af00">mcache</span> <span style="color:#111">=</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ...</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="全局队列">全局队列</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">schedt</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 锁</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">lock</span> <span style="color:#75af00">mutex</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// m 相关配置</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">midle</span>        <span style="color:#75af00">muintptr</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// p 相关配置 </span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">pidle</span>        <span style="color:#75af00">puintptr</span> <span style="color:#75715e">// idle p&#39;s</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// g 队列</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">runq</span>     <span style="color:#75af00">gQueue</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">runqsize</span> <span style="color:#00a8c8">int32</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// G 对象池</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">gFree</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">lock</span>    <span style="color:#75af00">mutex</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">stack</span>   <span style="color:#75af00">gList</span> <span style="color:#75715e">// Gs with stacks</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">noStack</span> <span style="color:#75af00">gList</span> <span style="color:#75715e">// Gs without stacks</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">n</span>       <span style="color:#00a8c8">int32</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ...</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>P 的空闲列表： M 获取 P 的时候拿到
M 的空闲列表： 线程的创建于销毁代价是很大的 为了复用性</p>
<h2 id="调度">调度</h2>
<p>go 有三种进行到调度的方式：</p>
<ol>
<li>用户 goroutine 主动执行 runtime.Gosched() 会把当前 goroutine 放到队列中等待调度</li>
<li>用户 goroutine 阻塞，例如 channel 读写，网络 IO 等 会主动调用修改自己状态并切换到 g0 执行调度任务</li>
<li>go runtime 中有个 OS 线程 （名称是 sysmon） 检测到 goroutine 超时（上次执行到现在超过 10ms）那就会给线程发信号 使其切换到 g0 执行调度任务</li>
</ol>
<p><em><strong>为什么 sysmon 使用物理线程而不是 goroutine 呢？</strong></em></p>
<p>因为所有 p 上正在执行的 g 都阻塞住了 比如 <code>for {}</code> 那么其他的 g 永远无法执行了包括负责检测的 sysmon</p>
<h3 id="主动调度">主动调度</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">Gosched</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">checkTimeouts</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">mcall</span><span style="color:#111">(</span><span style="color:#75af00">gosched_m</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="阻塞调度">阻塞调度</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">gopark</span><span style="color:#111">(</span><span style="color:#75af00">unlockf</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">g</span><span style="color:#111">,</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">)</span> <span style="color:#00a8c8">bool</span><span style="color:#111">,</span> <span style="color:#75af00">lock</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">,</span> <span style="color:#75af00">reason</span> <span style="color:#75af00">waitReason</span><span style="color:#111">,</span> <span style="color:#75af00">traceReason</span> <span style="color:#75af00">traceBlockReason</span><span style="color:#111">,</span> <span style="color:#75af00">traceskip</span> <span style="color:#00a8c8">int</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">reason</span> <span style="color:#f92672">!=</span> <span style="color:#75af00">waitReasonSleep</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">checkTimeouts</span><span style="color:#111">()</span> <span style="color:#75715e">// timeouts may expire while two goroutines keep the scheduler busy</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">mp</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">acquirem</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">gp</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">mp</span><span style="color:#111">.</span><span style="color:#75af00">curg</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">status</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">readgstatus</span><span style="color:#111">(</span><span style="color:#75af00">gp</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">status</span> <span style="color:#f92672">!=</span> <span style="color:#75af00">_Grunning</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">status</span> <span style="color:#f92672">!=</span> <span style="color:#75af00">_Gscanrunning</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">throw</span><span style="color:#111">(</span><span style="color:#d88200">&#34;gopark: bad g status&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">mp</span><span style="color:#111">.</span><span style="color:#75af00">waitlock</span> <span style="color:#111">=</span> <span style="color:#75af00">lock</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">mp</span><span style="color:#111">.</span><span style="color:#75af00">waitunlockf</span> <span style="color:#111">=</span> <span style="color:#75af00">unlockf</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">gp</span><span style="color:#111">.</span><span style="color:#75af00">waitreason</span> <span style="color:#111">=</span> <span style="color:#75af00">reason</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">mp</span><span style="color:#111">.</span><span style="color:#75af00">waitTraceBlockReason</span> <span style="color:#111">=</span> <span style="color:#75af00">traceReason</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">mp</span><span style="color:#111">.</span><span style="color:#75af00">waitTraceSkip</span> <span style="color:#111">=</span> <span style="color:#75af00">traceskip</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">releasem</span><span style="color:#111">(</span><span style="color:#75af00">mp</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// can&#39;t do anything that might move the G between Ms here.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">mcall</span><span style="color:#111">(</span><span style="color:#75af00">park_m</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="抢占调度">抢占调度</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// m 在 start 的时候会注册一些信号处理函数</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">initsig</span><span style="color:#111">(</span><span style="color:#75af00">preinit</span> <span style="color:#00a8c8">bool</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">i</span> <span style="color:#f92672">:=</span> <span style="color:#111">uint32</span><span style="color:#111">(</span><span style="color:#ae81ff">0</span><span style="color:#111">);</span> <span style="color:#75af00">i</span> <span style="color:#111">&lt;</span> <span style="color:#75af00">_NSIG</span><span style="color:#111">;</span> <span style="color:#75af00">i</span><span style="color:#f92672">++</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// ...</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">setsig</span><span style="color:#111">(</span><span style="color:#75af00">i</span><span style="color:#111">,</span> <span style="color:#75af00">abi</span><span style="color:#111">.</span><span style="color:#75af00">FuncPCABIInternal</span><span style="color:#111">(</span><span style="color:#75af00">sighandler</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// sighandler -&gt; doSigPreempt -&gt; asyncPreempt （去汇编代码里找） -&gt; asyncPreempt2 </span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">asyncPreempt2</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">gp</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">getg</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">gp</span><span style="color:#111">.</span><span style="color:#75af00">asyncSafePoint</span> <span style="color:#111">=</span> <span style="color:#00a8c8">true</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">gp</span><span style="color:#111">.</span><span style="color:#75af00">preemptStop</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">mcall</span><span style="color:#111">(</span><span style="color:#75af00">preemptPark</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">mcall</span><span style="color:#111">(</span><span style="color:#75af00">gopreempt_m</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">gp</span><span style="color:#111">.</span><span style="color:#75af00">asyncSafePoint</span> <span style="color:#111">=</span> <span style="color:#00a8c8">false</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// sysmon 发信号 </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// sysmon -&gt; retake -&gt; preemptone -&gt; preemptM</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">preemptM</span><span style="color:#111">(</span><span style="color:#75af00">mp</span> <span style="color:#f92672">*</span><span style="color:#75af00">m</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">mp</span><span style="color:#111">.</span><span style="color:#75af00">signalPending</span><span style="color:#111">.</span><span style="color:#75af00">CompareAndSwap</span><span style="color:#111">(</span><span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#ae81ff">1</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// ...</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">signalM</span><span style="color:#111">(</span><span style="color:#75af00">mp</span><span style="color:#111">,</span> <span style="color:#75af00">sigPreempt</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">signalM</span><span style="color:#111">(</span><span style="color:#75af00">mp</span> <span style="color:#f92672">*</span><span style="color:#75af00">m</span><span style="color:#111">,</span> <span style="color:#75af00">sig</span> <span style="color:#00a8c8">int</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">tgkill</span><span style="color:#111">(</span><span style="color:#75af00">getpid</span><span style="color:#111">(),</span> <span style="color:#111">int</span><span style="color:#111">(</span><span style="color:#75af00">mp</span><span style="color:#111">.</span><span style="color:#75af00">procid</span><span style="color:#111">),</span> <span style="color:#75af00">sig</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 代码在在汇编里 就是对线程发送信号 系统调用</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">tgkill</span><span style="color:#111">(</span><span style="color:#75af00">tgid</span><span style="color:#111">,</span> <span style="color:#75af00">tid</span><span style="color:#111">,</span> <span style="color:#75af00">sig</span> <span style="color:#00a8c8">int</span><span style="color:#111">)</span>
</span></span></code></pre></div><h3 id="调度代码">调度代码</h3>
<p>可以看到调度代码都是通过 mcall 调用的，mcall 会切换到 g0 执行调度任务 如果参数的函数不太一样 但是都是处理一些状态信息等，最好都会执行到 schedule 函数。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">schedule</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 核心代码就是选一个 g 去执行</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">gp</span><span style="color:#111">,</span> <span style="color:#75af00">inheritTime</span><span style="color:#111">,</span> <span style="color:#75af00">tryWakeP</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">findRunnable</span><span style="color:#111">()</span> <span style="color:#75715e">// blocks until work is available</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">execute</span><span style="color:#111">(</span><span style="color:#75af00">gp</span><span style="color:#111">,</span> <span style="color:#75af00">inheritTime</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>findRunnable：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">findRunnable</span><span style="color:#111">()</span> <span style="color:#111">(</span><span style="color:#75af00">gp</span> <span style="color:#f92672">*</span><span style="color:#75af00">g</span><span style="color:#111">,</span> <span style="color:#75af00">inheritTime</span><span style="color:#111">,</span> <span style="color:#75af00">tryWakeP</span> <span style="color:#00a8c8">bool</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Try to schedule a GC worker.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">gcBlackenEnabled</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">gp</span><span style="color:#111">,</span> <span style="color:#75af00">tnow</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">gcController</span><span style="color:#111">.</span><span style="color:#75af00">findRunnableGCWorker</span><span style="color:#111">(</span><span style="color:#75af00">pp</span><span style="color:#111">,</span> <span style="color:#75af00">now</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">gp</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#75af00">gp</span><span style="color:#111">,</span> <span style="color:#00a8c8">false</span><span style="color:#111">,</span> <span style="color:#00a8c8">true</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">now</span> <span style="color:#111">=</span> <span style="color:#75af00">tnow</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">pp</span><span style="color:#111">.</span><span style="color:#75af00">schedtick</span><span style="color:#f92672">%</span><span style="color:#ae81ff">61</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">sched</span><span style="color:#111">.</span><span style="color:#75af00">runqsize</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">lock</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">sched</span><span style="color:#111">.</span><span style="color:#75af00">lock</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">gp</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">globrunqget</span><span style="color:#111">(</span><span style="color:#75af00">pp</span><span style="color:#111">,</span> <span style="color:#ae81ff">1</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">unlock</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">sched</span><span style="color:#111">.</span><span style="color:#75af00">lock</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">gp</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#75af00">gp</span><span style="color:#111">,</span> <span style="color:#00a8c8">false</span><span style="color:#111">,</span> <span style="color:#00a8c8">false</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// local runq</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">gp</span><span style="color:#111">,</span> <span style="color:#75af00">inheritTime</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">runqget</span><span style="color:#111">(</span><span style="color:#75af00">pp</span><span style="color:#111">);</span> <span style="color:#75af00">gp</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">gp</span><span style="color:#111">,</span> <span style="color:#75af00">inheritTime</span><span style="color:#111">,</span> <span style="color:#00a8c8">false</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// global runq</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">sched</span><span style="color:#111">.</span><span style="color:#75af00">runqsize</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">lock</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">sched</span><span style="color:#111">.</span><span style="color:#75af00">lock</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">gp</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">globrunqget</span><span style="color:#111">(</span><span style="color:#75af00">pp</span><span style="color:#111">,</span> <span style="color:#ae81ff">0</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">unlock</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">sched</span><span style="color:#111">.</span><span style="color:#75af00">lock</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">gp</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#75af00">gp</span><span style="color:#111">,</span> <span style="color:#00a8c8">false</span><span style="color:#111">,</span> <span style="color:#00a8c8">false</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">netpollinited</span><span style="color:#111">()</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">netpollAnyWaiters</span><span style="color:#111">()</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">sched</span><span style="color:#111">.</span><span style="color:#75af00">lastpoll</span><span style="color:#111">.</span><span style="color:#75af00">Load</span><span style="color:#111">()</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">list</span><span style="color:#111">,</span> <span style="color:#75af00">delta</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">netpoll</span><span style="color:#111">(</span><span style="color:#ae81ff">0</span><span style="color:#111">);</span> <span style="color:#111">!</span><span style="color:#75af00">list</span><span style="color:#111">.</span><span style="color:#75af00">empty</span><span style="color:#111">()</span> <span style="color:#111">{</span> <span style="color:#75715e">// non-blocking</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">gp</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">list</span><span style="color:#111">.</span><span style="color:#75af00">pop</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">injectglist</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">list</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">netpollAdjustWaiters</span><span style="color:#111">(</span><span style="color:#75af00">delta</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">trace</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">traceAcquire</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">casgstatus</span><span style="color:#111">(</span><span style="color:#75af00">gp</span><span style="color:#111">,</span> <span style="color:#75af00">_Gwaiting</span><span style="color:#111">,</span> <span style="color:#75af00">_Grunnable</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">trace</span><span style="color:#111">.</span><span style="color:#75af00">ok</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">trace</span><span style="color:#111">.</span><span style="color:#75af00">GoUnpark</span><span style="color:#111">(</span><span style="color:#75af00">gp</span><span style="color:#111">,</span> <span style="color:#ae81ff">0</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">traceRelease</span><span style="color:#111">(</span><span style="color:#75af00">trace</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#75af00">gp</span><span style="color:#111">,</span> <span style="color:#00a8c8">false</span><span style="color:#111">,</span> <span style="color:#00a8c8">false</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Spinning Ms: steal work from other Ps.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	// Limit the number of spinning Ms to half the number of busy Ps.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// This is necessary to prevent excessive CPU consumption when</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// GOMAXPROCS&gt;&gt;1 but the program parallelism is low.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">mp</span><span style="color:#111">.</span><span style="color:#75af00">spinning</span> <span style="color:#f92672">||</span> <span style="color:#ae81ff">2</span><span style="color:#f92672">*</span><span style="color:#75af00">sched</span><span style="color:#111">.</span><span style="color:#75af00">nmspinning</span><span style="color:#111">.</span><span style="color:#75af00">Load</span><span style="color:#111">()</span> <span style="color:#111">&lt;</span> <span style="color:#75af00">gomaxprocs</span><span style="color:#f92672">-</span><span style="color:#75af00">sched</span><span style="color:#111">.</span><span style="color:#75af00">npidle</span><span style="color:#111">.</span><span style="color:#75af00">Load</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">mp</span><span style="color:#111">.</span><span style="color:#75af00">spinning</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">mp</span><span style="color:#111">.</span><span style="color:#75af00">becomeSpinning</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">gp</span><span style="color:#111">,</span> <span style="color:#75af00">inheritTime</span><span style="color:#111">,</span> <span style="color:#75af00">tnow</span><span style="color:#111">,</span> <span style="color:#75af00">w</span><span style="color:#111">,</span> <span style="color:#75af00">newWork</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">stealWork</span><span style="color:#111">(</span><span style="color:#75af00">now</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">gp</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// Successfully stole.</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#75af00">gp</span><span style="color:#111">,</span> <span style="color:#75af00">inheritTime</span><span style="color:#111">,</span> <span style="color:#00a8c8">false</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">newWork</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// There may be new timer or GC work; restart to</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// discover.</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">goto</span> <span style="color:#75af00">top</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">now</span> <span style="color:#111">=</span> <span style="color:#75af00">tnow</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">w</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#111">(</span><span style="color:#75af00">pollUntil</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">||</span> <span style="color:#75af00">w</span> <span style="color:#111">&lt;</span> <span style="color:#75af00">pollUntil</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// Earlier timer to wait for.</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">pollUntil</span> <span style="color:#111">=</span> <span style="color:#75af00">w</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>简化了一下代码还是很多 价绍一些这个功能吧</p>
<ol>
<li>优先执行 GC worker</li>
<li>每 61 次 从全局队列中获取一个 g 去执行 作用是 防止所有 p 的本地队列谁都非常多 导致全局队列的 g 饿死</li>
<li>从本地队列中获取一个 g 去执行 有限使用 runnext</li>
<li>从全局队列中获取一个 g 去执行 并 load 一些到本地队列</li>
<li>如果有网络 IO 准备好了 就从网络 IO 中获取一个 g 去执行 （go 中网络 epoll_wait 正常情况下使用的非阻塞模式）</li>
<li>从其他的 p 中偷取 g 去执行 （cas 保证数据安全）</li>
</ol>
<p>execute：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">execute</span><span style="color:#111">(</span><span style="color:#75af00">gp</span> <span style="color:#f92672">*</span><span style="color:#75af00">g</span><span style="color:#111">,</span> <span style="color:#75af00">inheritTime</span> <span style="color:#00a8c8">bool</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 修改状态</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">casgstatus</span><span style="color:#111">(</span><span style="color:#75af00">gp</span><span style="color:#111">,</span> <span style="color:#75af00">_Grunnable</span><span style="color:#111">,</span> <span style="color:#75af00">_Grunning</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 执行</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">gogo</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">gp</span><span style="color:#111">.</span><span style="color:#75af00">sched</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>我的 arch 是 amd64 所以代码在 <code>src/runtime/asm_amd64.s</code> 中</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">TEXT</span> <span style="color:#75af00">runtime</span><span style="color:#960050;background-color:#1e0010">·</span><span style="color:#75af00">gogo</span><span style="color:#111">(</span><span style="color:#75af00">SB</span><span style="color:#111">),</span> <span style="color:#75af00">NOSPLIT</span><span style="color:#111">,</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">0</span><span style="color:#f92672">-</span><span style="color:#ae81ff">8</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">MOVQ</span>	<span style="color:#75af00">buf</span><span style="color:#f92672">+</span><span style="color:#ae81ff">0</span><span style="color:#111">(</span><span style="color:#75af00">FP</span><span style="color:#111">),</span> <span style="color:#75af00">BX</span>	  <span style="color:#75715e">// 将 gobuf 指针加载到 BX 寄存器</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">MOVQ</span>	<span style="color:#75af00">gobuf_g</span><span style="color:#111">(</span><span style="color:#75af00">BX</span><span style="color:#111">),</span> <span style="color:#75af00">DX</span>  <span style="color:#75715e">// 将 gobuf 中保存的 g 指针加载到 DX</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">MOVQ</span>	<span style="color:#ae81ff">0</span><span style="color:#111">(</span><span style="color:#75af00">DX</span><span style="color:#111">),</span> <span style="color:#75af00">CX</span>	  <span style="color:#75715e">// 检查 g 不为 nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">JMP</span>	<span style="color:#75af00">gogo</span><span style="color:#111">&lt;&gt;(</span><span style="color:#75af00">SB</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">TEXT</span> <span style="color:#75af00">gogo</span><span style="color:#111">&lt;&gt;(</span><span style="color:#75af00">SB</span><span style="color:#111">),</span> <span style="color:#75af00">NOSPLIT</span><span style="color:#111">,</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">get_tls</span><span style="color:#111">(</span><span style="color:#75af00">CX</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">MOVQ</span>	<span style="color:#75af00">DX</span><span style="color:#111">,</span> <span style="color:#75af00">g</span><span style="color:#111">(</span><span style="color:#75af00">CX</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">MOVQ</span>	<span style="color:#75af00">DX</span><span style="color:#111">,</span> <span style="color:#75af00">R14</span>		<span style="color:#75715e">// set the g register</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 恢复寄存器状态 （sp ret bp ctxt） 执行 </span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">MOVQ</span>	<span style="color:#75af00">gobuf_sp</span><span style="color:#111">(</span><span style="color:#75af00">BX</span><span style="color:#111">),</span> <span style="color:#75af00">SP</span>	<span style="color:#75715e">// restore SP</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">MOVQ</span>	<span style="color:#75af00">gobuf_ret</span><span style="color:#111">(</span><span style="color:#75af00">BX</span><span style="color:#111">),</span> <span style="color:#75af00">AX</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">MOVQ</span>	<span style="color:#75af00">gobuf_ctxt</span><span style="color:#111">(</span><span style="color:#75af00">BX</span><span style="color:#111">),</span> <span style="color:#75af00">DX</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">MOVQ</span>	<span style="color:#75af00">gobuf_bp</span><span style="color:#111">(</span><span style="color:#75af00">BX</span><span style="color:#111">),</span> <span style="color:#75af00">BP</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 加载之后 清空 go 的 gobuf 结构体 为了给 gc 节省压力</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">MOVQ</span>	<span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#75af00">gobuf_sp</span><span style="color:#111">(</span><span style="color:#75af00">BX</span><span style="color:#111">)</span>	
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">MOVQ</span>	<span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#75af00">gobuf_ret</span><span style="color:#111">(</span><span style="color:#75af00">BX</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">MOVQ</span>	<span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#75af00">gobuf_ctxt</span><span style="color:#111">(</span><span style="color:#75af00">BX</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">MOVQ</span>	<span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#75af00">gobuf_bp</span><span style="color:#111">(</span><span style="color:#75af00">BX</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 跳转到保存的 PC （程序执行到哪了） 去执行</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">MOVQ</span>	<span style="color:#75af00">gobuf_pc</span><span style="color:#111">(</span><span style="color:#75af00">BX</span><span style="color:#111">),</span> <span style="color:#75af00">BX</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">JMP</span>	<span style="color:#75af00">BX</span>
</span></span></code></pre></div><h3 id="syscall">syscall</h3>
<p>我的 arch 是 and64 操作系统是 linux 所以代码在 <code>src/runtime/asm_linux_amd64.s</code> 中</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">TEXT</span> <span style="color:#960050;background-color:#1e0010">·</span><span style="color:#75af00">SyscallNoError</span><span style="color:#111">(</span><span style="color:#75af00">SB</span><span style="color:#111">),</span><span style="color:#75af00">NOSPLIT</span><span style="color:#111">,</span><span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">0</span><span style="color:#f92672">-</span><span style="color:#ae81ff">48</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">CALL</span>	<span style="color:#75af00">runtime</span><span style="color:#960050;background-color:#1e0010">·</span><span style="color:#75af00">entersyscall</span><span style="color:#111">(</span><span style="color:#75af00">SB</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">MOVQ</span>	<span style="color:#75af00">a1</span><span style="color:#f92672">+</span><span style="color:#ae81ff">8</span><span style="color:#111">(</span><span style="color:#75af00">FP</span><span style="color:#111">),</span> <span style="color:#75af00">DI</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">MOVQ</span>	<span style="color:#75af00">a2</span><span style="color:#f92672">+</span><span style="color:#ae81ff">16</span><span style="color:#111">(</span><span style="color:#75af00">FP</span><span style="color:#111">),</span> <span style="color:#75af00">SI</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">MOVQ</span>	<span style="color:#75af00">a3</span><span style="color:#f92672">+</span><span style="color:#ae81ff">24</span><span style="color:#111">(</span><span style="color:#75af00">FP</span><span style="color:#111">),</span> <span style="color:#75af00">DX</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">MOVQ</span>	<span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#75af00">R10</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">MOVQ</span>	<span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#75af00">R8</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">MOVQ</span>	<span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#75af00">R9</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">MOVQ</span>	<span style="color:#75af00">trap</span><span style="color:#f92672">+</span><span style="color:#ae81ff">0</span><span style="color:#111">(</span><span style="color:#75af00">FP</span><span style="color:#111">),</span> <span style="color:#75af00">AX</span>	<span style="color:#75715e">// syscall entry</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">SYSCALL</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">MOVQ</span>	<span style="color:#75af00">AX</span><span style="color:#111">,</span> <span style="color:#75af00">r1</span><span style="color:#f92672">+</span><span style="color:#ae81ff">32</span><span style="color:#111">(</span><span style="color:#75af00">FP</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">MOVQ</span>	<span style="color:#75af00">DX</span><span style="color:#111">,</span> <span style="color:#75af00">r2</span><span style="color:#f92672">+</span><span style="color:#ae81ff">40</span><span style="color:#111">(</span><span style="color:#75af00">FP</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">CALL</span>	<span style="color:#75af00">runtime</span><span style="color:#960050;background-color:#1e0010">·</span><span style="color:#75af00">exitsyscall</span><span style="color:#111">(</span><span style="color:#75af00">SB</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">RET</span>
</span></span></code></pre></div><p>系统调用前执行这个函数：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">entersyscall</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fp</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">getcallerfp</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">reentersyscall</span><span style="color:#111">(</span><span style="color:#75af00">getcallerpc</span><span style="color:#111">(),</span> <span style="color:#75af00">getcallersp</span><span style="color:#111">(),</span> <span style="color:#75af00">fp</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">reentersyscall</span><span style="color:#111">(</span><span style="color:#75af00">pc</span><span style="color:#111">,</span> <span style="color:#75af00">sp</span><span style="color:#111">,</span> <span style="color:#75af00">bp</span> <span style="color:#00a8c8">uintptr</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 保存寄存器信息</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">save</span><span style="color:#111">(</span><span style="color:#75af00">pc</span><span style="color:#111">,</span> <span style="color:#75af00">sp</span><span style="color:#111">,</span> <span style="color:#75af00">bp</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">gp</span><span style="color:#111">.</span><span style="color:#75af00">syscallsp</span> <span style="color:#111">=</span> <span style="color:#75af00">sp</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">gp</span><span style="color:#111">.</span><span style="color:#75af00">syscallpc</span> <span style="color:#111">=</span> <span style="color:#75af00">pc</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">gp</span><span style="color:#111">.</span><span style="color:#75af00">syscallbp</span> <span style="color:#111">=</span> <span style="color:#75af00">bp</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 修改 g 状态</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">casgstatus</span><span style="color:#111">(</span><span style="color:#75af00">gp</span><span style="color:#111">,</span> <span style="color:#75af00">_Grunning</span><span style="color:#111">,</span> <span style="color:#75af00">_Gsyscall</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">sched</span><span style="color:#111">.</span><span style="color:#75af00">sysmonwait</span><span style="color:#111">.</span><span style="color:#75af00">Load</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">systemstack</span><span style="color:#111">(</span><span style="color:#75af00">entersyscall_sysmon</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">save</span><span style="color:#111">(</span><span style="color:#75af00">pc</span><span style="color:#111">,</span> <span style="color:#75af00">sp</span><span style="color:#111">,</span> <span style="color:#75af00">bp</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">gp</span><span style="color:#111">.</span><span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">ptr</span><span style="color:#111">().</span><span style="color:#75af00">runSafePointFn</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// runSafePointFn may stack split if run on this stack</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">systemstack</span><span style="color:#111">(</span><span style="color:#75af00">runSafePointFn</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">save</span><span style="color:#111">(</span><span style="color:#75af00">pc</span><span style="color:#111">,</span> <span style="color:#75af00">sp</span><span style="color:#111">,</span> <span style="color:#75af00">bp</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">gp</span><span style="color:#111">.</span><span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">syscalltick</span> <span style="color:#111">=</span> <span style="color:#75af00">gp</span><span style="color:#111">.</span><span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">ptr</span><span style="color:#111">().</span><span style="color:#75af00">syscalltick</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">pp</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">gp</span><span style="color:#111">.</span><span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">ptr</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 解绑 P 和 M 并设置 oldP 为当前 P 等待系统调用之后重新绑定</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">pp</span><span style="color:#111">.</span><span style="color:#75af00">m</span> <span style="color:#111">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">gp</span><span style="color:#111">.</span><span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">oldp</span><span style="color:#111">.</span><span style="color:#75af00">set</span><span style="color:#111">(</span><span style="color:#75af00">pp</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">gp</span><span style="color:#111">.</span><span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">p</span> <span style="color:#111">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 修改 P 的状态为 syscall</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">atomic</span><span style="color:#111">.</span><span style="color:#75af00">Store</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">pp</span><span style="color:#111">.</span><span style="color:#75af00">status</span><span style="color:#111">,</span> <span style="color:#75af00">_Psyscall</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">sched</span><span style="color:#111">.</span><span style="color:#75af00">gcwaiting</span><span style="color:#111">.</span><span style="color:#75af00">Load</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">systemstack</span><span style="color:#111">(</span><span style="color:#75af00">entersyscall_gcwait</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">save</span><span style="color:#111">(</span><span style="color:#75af00">pc</span><span style="color:#111">,</span> <span style="color:#75af00">sp</span><span style="color:#111">,</span> <span style="color:#75af00">bp</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">gp</span><span style="color:#111">.</span><span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">locks</span><span style="color:#f92672">--</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>系统调用后执行这个函数：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">exitsyscall</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 如果之前保存的oldp不为空 那么重新绑定</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">exitsyscallfast</span><span style="color:#111">(</span><span style="color:#75af00">oldp</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 设置状态为 runnable 并重新执行</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">casgstatus</span><span style="color:#111">(</span><span style="color:#75af00">gp</span><span style="color:#111">,</span> <span style="color:#75af00">_Gsyscall</span><span style="color:#111">,</span> <span style="color:#75af00">_Grunning</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">sched</span><span style="color:#111">.</span><span style="color:#75af00">disable</span><span style="color:#111">.</span><span style="color:#75af00">user</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#111">!</span><span style="color:#75af00">schedEnabled</span><span style="color:#111">(</span><span style="color:#75af00">gp</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// Scheduling of this goroutine is disabled.</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">Gosched</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 切换到 g0 执行 exitsyscall0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">mcall</span><span style="color:#111">(</span><span style="color:#75af00">exitsyscall0</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">exitsyscall0</span><span style="color:#111">(</span><span style="color:#75af00">gp</span> <span style="color:#f92672">*</span><span style="color:#75af00">g</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 修改 g 状态到 _Grunnable 让重新可调度</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">casgstatus</span><span style="color:#111">(</span><span style="color:#75af00">gp</span><span style="color:#111">,</span> <span style="color:#75af00">_Gsyscall</span><span style="color:#111">,</span> <span style="color:#75af00">_Grunnable</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 删除 gm 的绑定</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">dropg</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">lock</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">sched</span><span style="color:#111">.</span><span style="color:#75af00">lock</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 找个空闲的 p （状态为 _Gidle） 与 M 绑定</span>
</span></span><span style="display:flex;"><span>  <span style="color:#00a8c8">var</span> <span style="color:#75af00">pp</span> <span style="color:#f92672">*</span><span style="color:#75af00">p</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">schedEnabled</span><span style="color:#111">(</span><span style="color:#75af00">gp</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">pp</span><span style="color:#111">,</span> <span style="color:#75af00">_</span> <span style="color:#111">=</span> <span style="color:#75af00">pidleget</span><span style="color:#111">(</span><span style="color:#ae81ff">0</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">var</span> <span style="color:#75af00">locked</span> <span style="color:#00a8c8">bool</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">pp</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 如果绑定失败了 直接把 g 放到全局队列中</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">globrunqput</span><span style="color:#111">(</span><span style="color:#75af00">gp</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">locked</span> <span style="color:#111">=</span> <span style="color:#75af00">gp</span><span style="color:#111">.</span><span style="color:#75af00">lockedm</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#00a8c8">if</span> <span style="color:#75af00">sched</span><span style="color:#111">.</span><span style="color:#75af00">sysmonwait</span><span style="color:#111">.</span><span style="color:#75af00">Load</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 如果 sysmon 在等待 那么唤醒它</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">sched</span><span style="color:#111">.</span><span style="color:#75af00">sysmonwait</span><span style="color:#111">.</span><span style="color:#75af00">Store</span><span style="color:#111">(</span><span style="color:#00a8c8">false</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">notewakeup</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">sched</span><span style="color:#111">.</span><span style="color:#75af00">sysmonnote</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">unlock</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">sched</span><span style="color:#111">.</span><span style="color:#75af00">lock</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 如果找到 p 了 那么就去执行</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">pp</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">acquirep</span><span style="color:#111">(</span><span style="color:#75af00">pp</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">execute</span><span style="color:#111">(</span><span style="color:#75af00">gp</span><span style="color:#111">,</span> <span style="color:#00a8c8">false</span><span style="color:#111">)</span> <span style="color:#75715e">// Never returns.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">locked</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Wait until another thread schedules gp and so m again.</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">		// N.B. lockedm must be this M, as this g was running on this M</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// before entersyscall.</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">stoplockedm</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">execute</span><span style="color:#111">(</span><span style="color:#75af00">gp</span><span style="color:#111">,</span> <span style="color:#00a8c8">false</span><span style="color:#111">)</span> <span style="color:#75715e">// Never returns.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 如果没有 P 给我这个 M 绑定的话 那么把 M 休眠并加入到 schedlink 队列中  做复用</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">stopm</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 直到有新的 g 被调度到这个 M 上</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">schedule</span><span style="color:#111">()</span> <span style="color:#75715e">// Never returns.</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="goroutine-切换通用寄存器问题">goroutine 切换通用寄存器问题</h2>
<p>我们知道 goroutine 中的 gobuf 中只保存了 sp pc bp 等寄存器信息，但是 goroutine 切换的时候还有其他通用寄存器，如果中间丢失会引起结果不一致。那么 go 中是怎么保存的呢？</p>
<p>goroutine 切换大体有两种情况</p>
<ol>
<li>在编译阶段知道 goroutine 可能交出控制权 比如 读写 channel 等待网络 系统调用等</li>
<li>goroutine 被抢占了 GC 超时等</li>
</ol>
<p>对于第一种方式，在编译阶段知道后续会使用哪个寄存器和知道在哪里可能会交出控制权，就会在后续保存这些寄存器。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">test</span><span style="color:#111">(</span><span style="color:#75af00">a</span> <span style="color:#00a8c8">chan</span> <span style="color:#00a8c8">int</span><span style="color:#111">,</span> <span style="color:#75af00">b</span><span style="color:#111">,</span> <span style="color:#75af00">c</span> <span style="color:#00a8c8">int</span><span style="color:#111">)</span> <span style="color:#00a8c8">int</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">d</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#75af00">a</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">d</span> <span style="color:#f92672">+</span> <span style="color:#75af00">b</span> <span style="color:#f92672">+</span> <span style="color:#75af00">c</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// go tool compile -S main.go 的汇编代码</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">main</span><span style="color:#111">.</span><span style="color:#75af00">test</span> <span style="color:#75af00">STEXT</span> <span style="color:#75af00">size</span><span style="color:#111">=</span><span style="color:#ae81ff">105</span> <span style="color:#75af00">args</span><span style="color:#111">=</span><span style="color:#ae81ff">0x18</span> <span style="color:#75af00">locals</span><span style="color:#111">=</span><span style="color:#ae81ff">0x20</span> <span style="color:#75af00">funcid</span><span style="color:#111">=</span><span style="color:#ae81ff">0x0</span> <span style="color:#75af00">align</span><span style="color:#111">=</span><span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x0000</span> <span style="color:#ae81ff">00000</span> <span style="color:#111">(.</span><span style="color:#f92672">/</span><span style="color:#75af00">main</span><span style="color:#111">.</span><span style="color:#00a8c8">go</span><span style="color:#111">:</span><span style="color:#ae81ff">3</span><span style="color:#111">)</span>	<span style="color:#75af00">TEXT</span>	<span style="color:#75af00">main</span><span style="color:#111">.</span><span style="color:#75af00">test</span><span style="color:#111">(</span><span style="color:#75af00">SB</span><span style="color:#111">),</span> <span style="color:#75af00">ABIInternal</span><span style="color:#111">,</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">32</span><span style="color:#f92672">-</span><span style="color:#ae81ff">24</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 栈检查</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x0000</span> <span style="color:#ae81ff">00000</span> <span style="color:#111">(.</span><span style="color:#f92672">/</span><span style="color:#75af00">main</span><span style="color:#111">.</span><span style="color:#00a8c8">go</span><span style="color:#111">:</span><span style="color:#ae81ff">3</span><span style="color:#111">)</span>	<span style="color:#75af00">CMPQ</span>	<span style="color:#75af00">SP</span><span style="color:#111">,</span> <span style="color:#ae81ff">16</span><span style="color:#111">(</span><span style="color:#75af00">R14</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x0004</span> <span style="color:#ae81ff">00004</span> <span style="color:#111">(.</span><span style="color:#f92672">/</span><span style="color:#75af00">main</span><span style="color:#111">.</span><span style="color:#00a8c8">go</span><span style="color:#111">:</span><span style="color:#ae81ff">3</span><span style="color:#111">)</span>	<span style="color:#75af00">PCDATA</span>	<span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x0004</span> <span style="color:#ae81ff">00004</span> <span style="color:#111">(.</span><span style="color:#f92672">/</span><span style="color:#75af00">main</span><span style="color:#111">.</span><span style="color:#00a8c8">go</span><span style="color:#111">:</span><span style="color:#ae81ff">3</span><span style="color:#111">)</span>	<span style="color:#75af00">JLS</span>	<span style="color:#ae81ff">68</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x0006</span> <span style="color:#ae81ff">00006</span> <span style="color:#111">(.</span><span style="color:#f92672">/</span><span style="color:#75af00">main</span><span style="color:#111">.</span><span style="color:#00a8c8">go</span><span style="color:#111">:</span><span style="color:#ae81ff">3</span><span style="color:#111">)</span>	<span style="color:#75af00">PCDATA</span>	<span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x0006</span> <span style="color:#ae81ff">00006</span> <span style="color:#111">(.</span><span style="color:#f92672">/</span><span style="color:#75af00">main</span><span style="color:#111">.</span><span style="color:#00a8c8">go</span><span style="color:#111">:</span><span style="color:#ae81ff">3</span><span style="color:#111">)</span>	<span style="color:#75af00">PUSHQ</span>	<span style="color:#75af00">BP</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x0007</span> <span style="color:#ae81ff">00007</span> <span style="color:#111">(.</span><span style="color:#f92672">/</span><span style="color:#75af00">main</span><span style="color:#111">.</span><span style="color:#00a8c8">go</span><span style="color:#111">:</span><span style="color:#ae81ff">3</span><span style="color:#111">)</span>	<span style="color:#75af00">MOVQ</span>	<span style="color:#75af00">SP</span><span style="color:#111">,</span> <span style="color:#75af00">BP</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x000a</span> <span style="color:#ae81ff">00010</span> <span style="color:#111">(.</span><span style="color:#f92672">/</span><span style="color:#75af00">main</span><span style="color:#111">.</span><span style="color:#00a8c8">go</span><span style="color:#111">:</span><span style="color:#ae81ff">3</span><span style="color:#111">)</span>	<span style="color:#75af00">SUBQ</span>	<span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">24</span><span style="color:#111">,</span> <span style="color:#75af00">SP</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 调试使用的</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x000e</span> <span style="color:#ae81ff">00014</span> <span style="color:#111">(.</span><span style="color:#f92672">/</span><span style="color:#75af00">main</span><span style="color:#111">.</span><span style="color:#00a8c8">go</span><span style="color:#111">:</span><span style="color:#ae81ff">3</span><span style="color:#111">)</span>	<span style="color:#75af00">FUNCDATA</span>	<span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#75af00">gclocals</span><span style="color:#960050;background-color:#1e0010">·</span><span style="color:#75af00">wgcWObbY2HYnK2SU</span><span style="color:#f92672">/</span><span style="color:#75af00">U22lA</span><span style="color:#f92672">==</span><span style="color:#111">(</span><span style="color:#75af00">SB</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x000e</span> <span style="color:#ae81ff">00014</span> <span style="color:#111">(.</span><span style="color:#f92672">/</span><span style="color:#75af00">main</span><span style="color:#111">.</span><span style="color:#00a8c8">go</span><span style="color:#111">:</span><span style="color:#ae81ff">3</span><span style="color:#111">)</span>	<span style="color:#75af00">FUNCDATA</span>	<span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">1</span><span style="color:#111">,</span> <span style="color:#75af00">gclocals</span><span style="color:#960050;background-color:#1e0010">·</span><span style="color:#75af00">J5F</span><span style="color:#f92672">+</span><span style="color:#ae81ff">7</span><span style="color:#75af00">Qw7O7ve2QcWC7DpeQ</span><span style="color:#f92672">==</span><span style="color:#111">(</span><span style="color:#75af00">SB</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x000e</span> <span style="color:#ae81ff">00014</span> <span style="color:#111">(.</span><span style="color:#f92672">/</span><span style="color:#75af00">main</span><span style="color:#111">.</span><span style="color:#00a8c8">go</span><span style="color:#111">:</span><span style="color:#ae81ff">3</span><span style="color:#111">)</span>	<span style="color:#75af00">FUNCDATA</span>	<span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">5</span><span style="color:#111">,</span> <span style="color:#75af00">main</span><span style="color:#111">.</span><span style="color:#75af00">test</span><span style="color:#111">.</span><span style="color:#75af00">arginfo1</span><span style="color:#111">(</span><span style="color:#75af00">SB</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x000e</span> <span style="color:#ae81ff">00014</span> <span style="color:#111">(.</span><span style="color:#f92672">/</span><span style="color:#75af00">main</span><span style="color:#111">.</span><span style="color:#00a8c8">go</span><span style="color:#111">:</span><span style="color:#ae81ff">3</span><span style="color:#111">)</span>	<span style="color:#75af00">FUNCDATA</span>	<span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">6</span><span style="color:#111">,</span> <span style="color:#75af00">main</span><span style="color:#111">.</span><span style="color:#75af00">test</span><span style="color:#111">.</span><span style="color:#75af00">argliveinfo</span><span style="color:#111">(</span><span style="color:#75af00">SB</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x000e</span> <span style="color:#ae81ff">00014</span> <span style="color:#111">(.</span><span style="color:#f92672">/</span><span style="color:#75af00">main</span><span style="color:#111">.</span><span style="color:#00a8c8">go</span><span style="color:#111">:</span><span style="color:#ae81ff">3</span><span style="color:#111">)</span>	<span style="color:#75af00">PCDATA</span>	<span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">3</span><span style="color:#111">,</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 把 BX CX 保存到栈中</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x000e</span> <span style="color:#ae81ff">00014</span> <span style="color:#111">(.</span><span style="color:#f92672">/</span><span style="color:#75af00">main</span><span style="color:#111">.</span><span style="color:#00a8c8">go</span><span style="color:#111">:</span><span style="color:#ae81ff">5</span><span style="color:#111">)</span>	<span style="color:#75af00">MOVQ</span>	<span style="color:#75af00">BX</span><span style="color:#111">,</span> <span style="color:#75af00">main</span><span style="color:#111">.</span><span style="color:#75af00">b</span><span style="color:#f92672">+</span><span style="color:#ae81ff">48</span><span style="color:#111">(</span><span style="color:#75af00">SP</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x0013</span> <span style="color:#ae81ff">0001</span><span style="color:#ae81ff">9</span> <span style="color:#111">(.</span><span style="color:#f92672">/</span><span style="color:#75af00">main</span><span style="color:#111">.</span><span style="color:#00a8c8">go</span><span style="color:#111">:</span><span style="color:#ae81ff">5</span><span style="color:#111">)</span>	<span style="color:#75af00">MOVQ</span>	<span style="color:#75af00">CX</span><span style="color:#111">,</span> <span style="color:#75af00">main</span><span style="color:#111">.</span><span style="color:#75af00">c</span><span style="color:#f92672">+</span><span style="color:#ae81ff">56</span><span style="color:#111">(</span><span style="color:#75af00">SP</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x0018</span> <span style="color:#ae81ff">00024</span> <span style="color:#111">(.</span><span style="color:#f92672">/</span><span style="color:#75af00">main</span><span style="color:#111">.</span><span style="color:#00a8c8">go</span><span style="color:#111">:</span><span style="color:#ae81ff">5</span><span style="color:#111">)</span>	<span style="color:#75af00">PCDATA</span>	<span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">3</span><span style="color:#111">,</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 初始化临时变量 并 chanrecv1 接受 chan 数据</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x0018</span> <span style="color:#ae81ff">00024</span> <span style="color:#111">(.</span><span style="color:#f92672">/</span><span style="color:#75af00">main</span><span style="color:#111">.</span><span style="color:#00a8c8">go</span><span style="color:#111">:</span><span style="color:#ae81ff">4</span><span style="color:#111">)</span>	<span style="color:#75af00">MOVQ</span>	<span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#75af00">main</span><span style="color:#111">..</span><span style="color:#75af00">autotmp_5</span><span style="color:#f92672">+</span><span style="color:#ae81ff">16</span><span style="color:#111">(</span><span style="color:#75af00">SP</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x0021</span> <span style="color:#ae81ff">00033</span> <span style="color:#111">(.</span><span style="color:#f92672">/</span><span style="color:#75af00">main</span><span style="color:#111">.</span><span style="color:#00a8c8">go</span><span style="color:#111">:</span><span style="color:#ae81ff">4</span><span style="color:#111">)</span>	<span style="color:#75af00">LEAQ</span>	<span style="color:#75af00">main</span><span style="color:#111">..</span><span style="color:#75af00">autotmp_5</span><span style="color:#f92672">+</span><span style="color:#ae81ff">16</span><span style="color:#111">(</span><span style="color:#75af00">SP</span><span style="color:#111">),</span> <span style="color:#75af00">BX</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x0026</span> <span style="color:#ae81ff">0003</span><span style="color:#ae81ff">8</span> <span style="color:#111">(.</span><span style="color:#f92672">/</span><span style="color:#75af00">main</span><span style="color:#111">.</span><span style="color:#00a8c8">go</span><span style="color:#111">:</span><span style="color:#ae81ff">4</span><span style="color:#111">)</span>	<span style="color:#75af00">PCDATA</span>	<span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">1</span><span style="color:#111">,</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x0026</span> <span style="color:#ae81ff">0003</span><span style="color:#ae81ff">8</span> <span style="color:#111">(.</span><span style="color:#f92672">/</span><span style="color:#75af00">main</span><span style="color:#111">.</span><span style="color:#00a8c8">go</span><span style="color:#111">:</span><span style="color:#ae81ff">4</span><span style="color:#111">)</span>	<span style="color:#75af00">CALL</span>	<span style="color:#75af00">runtime</span><span style="color:#111">.</span><span style="color:#75af00">chanrecv1</span><span style="color:#111">(</span><span style="color:#75af00">SB</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 恢复接受 chan 之前入栈的寄存器 </span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x002b</span> <span style="color:#ae81ff">00043</span> <span style="color:#111">(.</span><span style="color:#f92672">/</span><span style="color:#75af00">main</span><span style="color:#111">.</span><span style="color:#00a8c8">go</span><span style="color:#111">:</span><span style="color:#ae81ff">5</span><span style="color:#111">)</span>	<span style="color:#75af00">MOVQ</span>	<span style="color:#75af00">main</span><span style="color:#111">.</span><span style="color:#75af00">b</span><span style="color:#f92672">+</span><span style="color:#ae81ff">48</span><span style="color:#111">(</span><span style="color:#75af00">SP</span><span style="color:#111">),</span> <span style="color:#75af00">CX</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x0030</span> <span style="color:#ae81ff">0004</span><span style="color:#ae81ff">8</span> <span style="color:#111">(.</span><span style="color:#f92672">/</span><span style="color:#75af00">main</span><span style="color:#111">.</span><span style="color:#00a8c8">go</span><span style="color:#111">:</span><span style="color:#ae81ff">5</span><span style="color:#111">)</span>	<span style="color:#75af00">ADDQ</span>	<span style="color:#75af00">main</span><span style="color:#111">..</span><span style="color:#75af00">autotmp_5</span><span style="color:#f92672">+</span><span style="color:#ae81ff">16</span><span style="color:#111">(</span><span style="color:#75af00">SP</span><span style="color:#111">),</span> <span style="color:#75af00">CX</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x0035</span> <span style="color:#ae81ff">00053</span> <span style="color:#111">(.</span><span style="color:#f92672">/</span><span style="color:#75af00">main</span><span style="color:#111">.</span><span style="color:#00a8c8">go</span><span style="color:#111">:</span><span style="color:#ae81ff">5</span><span style="color:#111">)</span>	<span style="color:#75af00">MOVQ</span>	<span style="color:#75af00">main</span><span style="color:#111">.</span><span style="color:#75af00">c</span><span style="color:#f92672">+</span><span style="color:#ae81ff">56</span><span style="color:#111">(</span><span style="color:#75af00">SP</span><span style="color:#111">),</span> <span style="color:#75af00">DX</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x003a</span> <span style="color:#ae81ff">0005</span><span style="color:#ae81ff">8</span> <span style="color:#111">(.</span><span style="color:#f92672">/</span><span style="color:#75af00">main</span><span style="color:#111">.</span><span style="color:#00a8c8">go</span><span style="color:#111">:</span><span style="color:#ae81ff">5</span><span style="color:#111">)</span>	<span style="color:#75af00">LEAQ</span>	<span style="color:#111">(</span><span style="color:#75af00">DX</span><span style="color:#111">)(</span><span style="color:#75af00">CX</span><span style="color:#f92672">*</span><span style="color:#ae81ff">1</span><span style="color:#111">),</span> <span style="color:#75af00">AX</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x003e</span> <span style="color:#ae81ff">00062</span> <span style="color:#111">(.</span><span style="color:#f92672">/</span><span style="color:#75af00">main</span><span style="color:#111">.</span><span style="color:#00a8c8">go</span><span style="color:#111">:</span><span style="color:#ae81ff">5</span><span style="color:#111">)</span>	<span style="color:#75af00">ADDQ</span>	<span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">24</span><span style="color:#111">,</span> <span style="color:#75af00">SP</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x0042</span> <span style="color:#ae81ff">00066</span> <span style="color:#111">(.</span><span style="color:#f92672">/</span><span style="color:#75af00">main</span><span style="color:#111">.</span><span style="color:#00a8c8">go</span><span style="color:#111">:</span><span style="color:#ae81ff">5</span><span style="color:#111">)</span>	<span style="color:#75af00">POPQ</span>	<span style="color:#75af00">BP</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x0043</span> <span style="color:#ae81ff">00067</span> <span style="color:#111">(.</span><span style="color:#f92672">/</span><span style="color:#75af00">main</span><span style="color:#111">.</span><span style="color:#00a8c8">go</span><span style="color:#111">:</span><span style="color:#ae81ff">5</span><span style="color:#111">)</span>	<span style="color:#75af00">RET</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x0044</span> <span style="color:#ae81ff">0006</span><span style="color:#ae81ff">8</span> <span style="color:#111">(.</span><span style="color:#f92672">/</span><span style="color:#75af00">main</span><span style="color:#111">.</span><span style="color:#00a8c8">go</span><span style="color:#111">:</span><span style="color:#ae81ff">5</span><span style="color:#111">)</span>	<span style="color:#75af00">NOP</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 处理扩容栈相关的代码</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x0044</span> <span style="color:#ae81ff">0006</span><span style="color:#ae81ff">8</span> <span style="color:#111">(.</span><span style="color:#f92672">/</span><span style="color:#75af00">main</span><span style="color:#111">.</span><span style="color:#00a8c8">go</span><span style="color:#111">:</span><span style="color:#ae81ff">3</span><span style="color:#111">)</span>	<span style="color:#75af00">PCDATA</span>	<span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">1</span><span style="color:#111">,</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x0044</span> <span style="color:#ae81ff">0006</span><span style="color:#ae81ff">8</span> <span style="color:#111">(.</span><span style="color:#f92672">/</span><span style="color:#75af00">main</span><span style="color:#111">.</span><span style="color:#00a8c8">go</span><span style="color:#111">:</span><span style="color:#ae81ff">3</span><span style="color:#111">)</span>	<span style="color:#75af00">PCDATA</span>	<span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x0044</span> <span style="color:#ae81ff">0006</span><span style="color:#ae81ff">8</span> <span style="color:#111">(.</span><span style="color:#f92672">/</span><span style="color:#75af00">main</span><span style="color:#111">.</span><span style="color:#00a8c8">go</span><span style="color:#111">:</span><span style="color:#ae81ff">3</span><span style="color:#111">)</span>	<span style="color:#75af00">MOVQ</span>	<span style="color:#75af00">AX</span><span style="color:#111">,</span> <span style="color:#ae81ff">8</span><span style="color:#111">(</span><span style="color:#75af00">SP</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x0049</span> <span style="color:#ae81ff">00073</span> <span style="color:#111">(.</span><span style="color:#f92672">/</span><span style="color:#75af00">main</span><span style="color:#111">.</span><span style="color:#00a8c8">go</span><span style="color:#111">:</span><span style="color:#ae81ff">3</span><span style="color:#111">)</span>	<span style="color:#75af00">MOVQ</span>	<span style="color:#75af00">BX</span><span style="color:#111">,</span> <span style="color:#ae81ff">16</span><span style="color:#111">(</span><span style="color:#75af00">SP</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x004e</span> <span style="color:#ae81ff">0007</span><span style="color:#ae81ff">8</span> <span style="color:#111">(.</span><span style="color:#f92672">/</span><span style="color:#75af00">main</span><span style="color:#111">.</span><span style="color:#00a8c8">go</span><span style="color:#111">:</span><span style="color:#ae81ff">3</span><span style="color:#111">)</span>	<span style="color:#75af00">MOVQ</span>	<span style="color:#75af00">CX</span><span style="color:#111">,</span> <span style="color:#ae81ff">24</span><span style="color:#111">(</span><span style="color:#75af00">SP</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x0053</span> <span style="color:#ae81ff">000</span><span style="color:#ae81ff">83</span> <span style="color:#111">(.</span><span style="color:#f92672">/</span><span style="color:#75af00">main</span><span style="color:#111">.</span><span style="color:#00a8c8">go</span><span style="color:#111">:</span><span style="color:#ae81ff">3</span><span style="color:#111">)</span>	<span style="color:#75af00">CALL</span>	<span style="color:#75af00">runtime</span><span style="color:#111">.</span><span style="color:#75af00">morestack_noctxt</span><span style="color:#111">(</span><span style="color:#75af00">SB</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x0058</span> <span style="color:#ae81ff">000</span><span style="color:#ae81ff">88</span> <span style="color:#111">(.</span><span style="color:#f92672">/</span><span style="color:#75af00">main</span><span style="color:#111">.</span><span style="color:#00a8c8">go</span><span style="color:#111">:</span><span style="color:#ae81ff">3</span><span style="color:#111">)</span>	<span style="color:#75af00">PCDATA</span>	<span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x0058</span> <span style="color:#ae81ff">000</span><span style="color:#ae81ff">88</span> <span style="color:#111">(.</span><span style="color:#f92672">/</span><span style="color:#75af00">main</span><span style="color:#111">.</span><span style="color:#00a8c8">go</span><span style="color:#111">:</span><span style="color:#ae81ff">3</span><span style="color:#111">)</span>	<span style="color:#75af00">MOVQ</span>	<span style="color:#ae81ff">8</span><span style="color:#111">(</span><span style="color:#75af00">SP</span><span style="color:#111">),</span> <span style="color:#75af00">AX</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x005d</span> <span style="color:#ae81ff">000</span><span style="color:#ae81ff">93</span> <span style="color:#111">(.</span><span style="color:#f92672">/</span><span style="color:#75af00">main</span><span style="color:#111">.</span><span style="color:#00a8c8">go</span><span style="color:#111">:</span><span style="color:#ae81ff">3</span><span style="color:#111">)</span>	<span style="color:#75af00">MOVQ</span>	<span style="color:#ae81ff">16</span><span style="color:#111">(</span><span style="color:#75af00">SP</span><span style="color:#111">),</span> <span style="color:#75af00">BX</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x0062</span> <span style="color:#ae81ff">000</span><span style="color:#ae81ff">98</span> <span style="color:#111">(.</span><span style="color:#f92672">/</span><span style="color:#75af00">main</span><span style="color:#111">.</span><span style="color:#00a8c8">go</span><span style="color:#111">:</span><span style="color:#ae81ff">3</span><span style="color:#111">)</span>	<span style="color:#75af00">MOVQ</span>	<span style="color:#ae81ff">24</span><span style="color:#111">(</span><span style="color:#75af00">SP</span><span style="color:#111">),</span> <span style="color:#75af00">CX</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x0067</span> <span style="color:#ae81ff">00103</span> <span style="color:#111">(.</span><span style="color:#f92672">/</span><span style="color:#75af00">main</span><span style="color:#111">.</span><span style="color:#00a8c8">go</span><span style="color:#111">:</span><span style="color:#ae81ff">3</span><span style="color:#111">)</span>	<span style="color:#75af00">JMP</span>	<span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">test2</span><span style="color:#111">(</span><span style="color:#75af00">a</span> <span style="color:#00a8c8">int</span><span style="color:#111">,</span> <span style="color:#75af00">b</span><span style="color:#111">,</span> <span style="color:#75af00">c</span> <span style="color:#00a8c8">int</span><span style="color:#111">)</span> <span style="color:#00a8c8">int</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">a</span> <span style="color:#f92672">+</span> <span style="color:#75af00">b</span> <span style="color:#f92672">+</span> <span style="color:#75af00">c</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">main</span><span style="color:#111">.</span><span style="color:#75af00">test2</span> <span style="color:#75af00">STEXT</span> <span style="color:#75af00">nosplit</span> <span style="color:#75af00">size</span><span style="color:#111">=</span><span style="color:#ae81ff">9</span> <span style="color:#75af00">args</span><span style="color:#111">=</span><span style="color:#ae81ff">0x18</span> <span style="color:#75af00">locals</span><span style="color:#111">=</span><span style="color:#ae81ff">0x0</span> <span style="color:#75af00">funcid</span><span style="color:#111">=</span><span style="color:#ae81ff">0x0</span> <span style="color:#75af00">align</span><span style="color:#111">=</span><span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x0000</span> <span style="color:#ae81ff">00000</span> <span style="color:#111">(</span><span style="color:#f92672">/</span><span style="color:#75af00">home</span><span style="color:#f92672">/</span><span style="color:#75af00">zhy</span><span style="color:#f92672">/</span><span style="color:#75af00">code</span><span style="color:#f92672">/</span><span style="color:#75af00">test1</span><span style="color:#f92672">/</span><span style="color:#75af00">main</span><span style="color:#111">.</span><span style="color:#00a8c8">go</span><span style="color:#111">:</span><span style="color:#ae81ff">8</span><span style="color:#111">)</span>	<span style="color:#75af00">TEXT</span>	<span style="color:#75af00">main</span><span style="color:#111">.</span><span style="color:#75af00">test2</span><span style="color:#111">(</span><span style="color:#75af00">SB</span><span style="color:#111">),</span> <span style="color:#75af00">NOSPLIT</span><span style="color:#111">|</span><span style="color:#75af00">NOFRAME</span><span style="color:#111">|</span><span style="color:#75af00">ABIInternal</span><span style="color:#111">,</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">0</span><span style="color:#f92672">-</span><span style="color:#ae81ff">24</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x0000</span> <span style="color:#ae81ff">00000</span> <span style="color:#111">(</span><span style="color:#f92672">/</span><span style="color:#75af00">home</span><span style="color:#f92672">/</span><span style="color:#75af00">zhy</span><span style="color:#f92672">/</span><span style="color:#75af00">code</span><span style="color:#f92672">/</span><span style="color:#75af00">test1</span><span style="color:#f92672">/</span><span style="color:#75af00">main</span><span style="color:#111">.</span><span style="color:#00a8c8">go</span><span style="color:#111">:</span><span style="color:#ae81ff">8</span><span style="color:#111">)</span>	<span style="color:#75af00">FUNCDATA</span>	<span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#75af00">gclocals</span><span style="color:#960050;background-color:#1e0010">·</span><span style="color:#75af00">g2BeySu</span><span style="color:#f92672">+</span><span style="color:#75af00">wFnoycgXfElmcg</span><span style="color:#f92672">==</span><span style="color:#111">(</span><span style="color:#75af00">SB</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x0000</span> <span style="color:#ae81ff">00000</span> <span style="color:#111">(</span><span style="color:#f92672">/</span><span style="color:#75af00">home</span><span style="color:#f92672">/</span><span style="color:#75af00">zhy</span><span style="color:#f92672">/</span><span style="color:#75af00">code</span><span style="color:#f92672">/</span><span style="color:#75af00">test1</span><span style="color:#f92672">/</span><span style="color:#75af00">main</span><span style="color:#111">.</span><span style="color:#00a8c8">go</span><span style="color:#111">:</span><span style="color:#ae81ff">8</span><span style="color:#111">)</span>	<span style="color:#75af00">FUNCDATA</span>	<span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">1</span><span style="color:#111">,</span> <span style="color:#75af00">gclocals</span><span style="color:#960050;background-color:#1e0010">·</span><span style="color:#75af00">g2BeySu</span><span style="color:#f92672">+</span><span style="color:#75af00">wFnoycgXfElmcg</span><span style="color:#f92672">==</span><span style="color:#111">(</span><span style="color:#75af00">SB</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x0000</span> <span style="color:#ae81ff">00000</span> <span style="color:#111">(</span><span style="color:#f92672">/</span><span style="color:#75af00">home</span><span style="color:#f92672">/</span><span style="color:#75af00">zhy</span><span style="color:#f92672">/</span><span style="color:#75af00">code</span><span style="color:#f92672">/</span><span style="color:#75af00">test1</span><span style="color:#f92672">/</span><span style="color:#75af00">main</span><span style="color:#111">.</span><span style="color:#00a8c8">go</span><span style="color:#111">:</span><span style="color:#ae81ff">8</span><span style="color:#111">)</span>	<span style="color:#75af00">FUNCDATA</span>	<span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">5</span><span style="color:#111">,</span> <span style="color:#75af00">main</span><span style="color:#111">.</span><span style="color:#75af00">test2</span><span style="color:#111">.</span><span style="color:#75af00">arginfo1</span><span style="color:#111">(</span><span style="color:#75af00">SB</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x0000</span> <span style="color:#ae81ff">00000</span> <span style="color:#111">(</span><span style="color:#f92672">/</span><span style="color:#75af00">home</span><span style="color:#f92672">/</span><span style="color:#75af00">zhy</span><span style="color:#f92672">/</span><span style="color:#75af00">code</span><span style="color:#f92672">/</span><span style="color:#75af00">test1</span><span style="color:#f92672">/</span><span style="color:#75af00">main</span><span style="color:#111">.</span><span style="color:#00a8c8">go</span><span style="color:#111">:</span><span style="color:#ae81ff">8</span><span style="color:#111">)</span>	<span style="color:#75af00">FUNCDATA</span>	<span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">6</span><span style="color:#111">,</span> <span style="color:#75af00">main</span><span style="color:#111">.</span><span style="color:#75af00">test2</span><span style="color:#111">.</span><span style="color:#75af00">argliveinfo</span><span style="color:#111">(</span><span style="color:#75af00">SB</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x0000</span> <span style="color:#ae81ff">00000</span> <span style="color:#111">(</span><span style="color:#f92672">/</span><span style="color:#75af00">home</span><span style="color:#f92672">/</span><span style="color:#75af00">zhy</span><span style="color:#f92672">/</span><span style="color:#75af00">code</span><span style="color:#f92672">/</span><span style="color:#75af00">test1</span><span style="color:#f92672">/</span><span style="color:#75af00">main</span><span style="color:#111">.</span><span style="color:#00a8c8">go</span><span style="color:#111">:</span><span style="color:#ae81ff">8</span><span style="color:#111">)</span>	<span style="color:#75af00">PCDATA</span>	<span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">3</span><span style="color:#111">,</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x0000</span> <span style="color:#ae81ff">00000</span> <span style="color:#111">(</span><span style="color:#f92672">/</span><span style="color:#75af00">home</span><span style="color:#f92672">/</span><span style="color:#75af00">zhy</span><span style="color:#f92672">/</span><span style="color:#75af00">code</span><span style="color:#f92672">/</span><span style="color:#75af00">test1</span><span style="color:#f92672">/</span><span style="color:#75af00">main</span><span style="color:#111">.</span><span style="color:#00a8c8">go</span><span style="color:#111">:</span><span style="color:#ae81ff">9</span><span style="color:#111">)</span>	<span style="color:#75af00">LEAQ</span>	<span style="color:#111">(</span><span style="color:#75af00">BX</span><span style="color:#111">)(</span><span style="color:#75af00">AX</span><span style="color:#f92672">*</span><span style="color:#ae81ff">1</span><span style="color:#111">),</span> <span style="color:#75af00">DX</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x0004</span> <span style="color:#ae81ff">00004</span> <span style="color:#111">(</span><span style="color:#f92672">/</span><span style="color:#75af00">home</span><span style="color:#f92672">/</span><span style="color:#75af00">zhy</span><span style="color:#f92672">/</span><span style="color:#75af00">code</span><span style="color:#f92672">/</span><span style="color:#75af00">test1</span><span style="color:#f92672">/</span><span style="color:#75af00">main</span><span style="color:#111">.</span><span style="color:#00a8c8">go</span><span style="color:#111">:</span><span style="color:#ae81ff">9</span><span style="color:#111">)</span>	<span style="color:#75af00">LEAQ</span>	<span style="color:#111">(</span><span style="color:#75af00">CX</span><span style="color:#111">)(</span><span style="color:#75af00">DX</span><span style="color:#f92672">*</span><span style="color:#ae81ff">1</span><span style="color:#111">),</span> <span style="color:#75af00">AX</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">0x0008</span> <span style="color:#ae81ff">0000</span><span style="color:#ae81ff">8</span> <span style="color:#111">(</span><span style="color:#f92672">/</span><span style="color:#75af00">home</span><span style="color:#f92672">/</span><span style="color:#75af00">zhy</span><span style="color:#f92672">/</span><span style="color:#75af00">code</span><span style="color:#f92672">/</span><span style="color:#75af00">test1</span><span style="color:#f92672">/</span><span style="color:#75af00">main</span><span style="color:#111">.</span><span style="color:#00a8c8">go</span><span style="color:#111">:</span><span style="color:#ae81ff">9</span><span style="color:#111">)</span>	<span style="color:#75af00">RET</span>
</span></span></code></pre></div><p><em><strong>从上方可以看到 test2 函数没有保存 BX CX 寄存器，因为编译器知道这个函数不会交出控制权，所以不需要保存这些寄存器。如果调用函数不做参数入栈的话，只用寄存器的话性能会更好。</strong></em></p>
<p>那如果是抢占呢，编译阶段肯定是不知道会在哪被抢占的，是怎么恢复要使用的寄存器呢？</p>
<p>处理信号的逻辑：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">doSigPreempt</span><span style="color:#111">(</span><span style="color:#75af00">gp</span> <span style="color:#f92672">*</span><span style="color:#75af00">g</span><span style="color:#111">,</span> <span style="color:#75af00">ctxt</span> <span style="color:#f92672">*</span><span style="color:#75af00">sigctxt</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Check if this G wants to be preempted and is safe to</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// preempt.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">wantAsyncPreempt</span><span style="color:#111">(</span><span style="color:#75af00">gp</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">ok</span><span style="color:#111">,</span> <span style="color:#75af00">newpc</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">isAsyncSafePoint</span><span style="color:#111">(</span><span style="color:#75af00">gp</span><span style="color:#111">,</span> <span style="color:#75af00">ctxt</span><span style="color:#111">.</span><span style="color:#75af00">sigpc</span><span style="color:#111">(),</span> <span style="color:#75af00">ctxt</span><span style="color:#111">.</span><span style="color:#75af00">sigsp</span><span style="color:#111">(),</span> <span style="color:#75af00">ctxt</span><span style="color:#111">.</span><span style="color:#75af00">siglr</span><span style="color:#111">());</span> <span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// Adjust the PC and inject a call to asyncPreempt.</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">ctxt</span><span style="color:#111">.</span><span style="color:#75af00">pushCall</span><span style="color:#111">(</span><span style="color:#75af00">abi</span><span style="color:#111">.</span><span style="color:#75af00">FuncPCABI0</span><span style="color:#111">(</span><span style="color:#75af00">asyncPreempt</span><span style="color:#111">),</span> <span style="color:#75af00">newpc</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>代码在 <code>src/runtime/preempt_amd64.go</code> 中</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">TEXT</span> <span style="color:#960050;background-color:#1e0010">·</span><span style="color:#75af00">asyncPreempt</span><span style="color:#111">(</span><span style="color:#75af00">SB</span><span style="color:#111">),</span><span style="color:#75af00">NOSPLIT</span><span style="color:#111">|</span><span style="color:#75af00">NOFRAME</span><span style="color:#111">,</span><span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">0</span><span style="color:#f92672">-</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">PUSHQ</span> <span style="color:#75af00">BP</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">MOVQ</span> <span style="color:#75af00">SP</span><span style="color:#111">,</span> <span style="color:#75af00">BP</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Save flags before clobbering them</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">PUSHFQ</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// obj doesn&#39;t understand ADD/SUB on SP, but does understand ADJSP</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ADJSP</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">368</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// But vet doesn&#39;t know ADJSP, so suppress vet stack checking</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">NOP</span> <span style="color:#75af00">SP</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">MOVQ</span> <span style="color:#75af00">AX</span><span style="color:#111">,</span> <span style="color:#ae81ff">0</span><span style="color:#111">(</span><span style="color:#75af00">SP</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">MOVQ</span> <span style="color:#75af00">CX</span><span style="color:#111">,</span> <span style="color:#ae81ff">8</span><span style="color:#111">(</span><span style="color:#75af00">SP</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">MOVQ</span> <span style="color:#75af00">DX</span><span style="color:#111">,</span> <span style="color:#ae81ff">16</span><span style="color:#111">(</span><span style="color:#75af00">SP</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">MOVQ</span> <span style="color:#75af00">BX</span><span style="color:#111">,</span> <span style="color:#ae81ff">24</span><span style="color:#111">(</span><span style="color:#75af00">SP</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">MOVQ</span> <span style="color:#75af00">SI</span><span style="color:#111">,</span> <span style="color:#ae81ff">32</span><span style="color:#111">(</span><span style="color:#75af00">SP</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">MOVQ</span> <span style="color:#75af00">DI</span><span style="color:#111">,</span> <span style="color:#ae81ff">40</span><span style="color:#111">(</span><span style="color:#75af00">SP</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">MOVQ</span> <span style="color:#75af00">R8</span><span style="color:#111">,</span> <span style="color:#ae81ff">48</span><span style="color:#111">(</span><span style="color:#75af00">SP</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">MOVQ</span> <span style="color:#75af00">R9</span><span style="color:#111">,</span> <span style="color:#ae81ff">56</span><span style="color:#111">(</span><span style="color:#75af00">SP</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">MOVQ</span> <span style="color:#75af00">R10</span><span style="color:#111">,</span> <span style="color:#ae81ff">64</span><span style="color:#111">(</span><span style="color:#75af00">SP</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">MOVQ</span> <span style="color:#75af00">R11</span><span style="color:#111">,</span> <span style="color:#ae81ff">72</span><span style="color:#111">(</span><span style="color:#75af00">SP</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">MOVQ</span> <span style="color:#75af00">R12</span><span style="color:#111">,</span> <span style="color:#ae81ff">80</span><span style="color:#111">(</span><span style="color:#75af00">SP</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">MOVQ</span> <span style="color:#75af00">R13</span><span style="color:#111">,</span> <span style="color:#ae81ff">88</span><span style="color:#111">(</span><span style="color:#75af00">SP</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">MOVQ</span> <span style="color:#75af00">R14</span><span style="color:#111">,</span> <span style="color:#ae81ff">96</span><span style="color:#111">(</span><span style="color:#75af00">SP</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">MOVQ</span> <span style="color:#75af00">R15</span><span style="color:#111">,</span> <span style="color:#ae81ff">104</span><span style="color:#111">(</span><span style="color:#75af00">SP</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#75af00">ifdef</span> <span style="color:#75af00">GOOS_darwin</span>
</span></span><span style="display:flex;"><span>	<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#75af00">ifndef</span> <span style="color:#75af00">hasAVX</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">CMPB</span> <span style="color:#75af00">internal</span><span style="color:#960050;background-color:#1e0010">∕</span><span style="color:#75af00">cpu</span><span style="color:#960050;background-color:#1e0010">·</span><span style="color:#75af00">X86</span><span style="color:#f92672">+</span><span style="color:#75af00">const_offsetX86HasAVX</span><span style="color:#111">(</span><span style="color:#75af00">SB</span><span style="color:#111">),</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">JE</span> <span style="color:#ae81ff">2</span><span style="color:#111">(</span><span style="color:#75af00">PC</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#75af00">endif</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">VZEROUPPER</span>
</span></span><span style="display:flex;"><span>	<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#75af00">endif</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">MOVUPS</span> <span style="color:#75af00">X0</span><span style="color:#111">,</span> <span style="color:#ae81ff">112</span><span style="color:#111">(</span><span style="color:#75af00">SP</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">MOVUPS</span> <span style="color:#75af00">X1</span><span style="color:#111">,</span> <span style="color:#ae81ff">128</span><span style="color:#111">(</span><span style="color:#75af00">SP</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">MOVUPS</span> <span style="color:#75af00">X2</span><span style="color:#111">,</span> <span style="color:#ae81ff">144</span><span style="color:#111">(</span><span style="color:#75af00">SP</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">MOVUPS</span> <span style="color:#75af00">X3</span><span style="color:#111">,</span> <span style="color:#ae81ff">160</span><span style="color:#111">(</span><span style="color:#75af00">SP</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">MOVUPS</span> <span style="color:#75af00">X4</span><span style="color:#111">,</span> <span style="color:#ae81ff">176</span><span style="color:#111">(</span><span style="color:#75af00">SP</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">MOVUPS</span> <span style="color:#75af00">X5</span><span style="color:#111">,</span> <span style="color:#ae81ff">192</span><span style="color:#111">(</span><span style="color:#75af00">SP</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">MOVUPS</span> <span style="color:#75af00">X6</span><span style="color:#111">,</span> <span style="color:#ae81ff">208</span><span style="color:#111">(</span><span style="color:#75af00">SP</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">MOVUPS</span> <span style="color:#75af00">X7</span><span style="color:#111">,</span> <span style="color:#ae81ff">224</span><span style="color:#111">(</span><span style="color:#75af00">SP</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">MOVUPS</span> <span style="color:#75af00">X8</span><span style="color:#111">,</span> <span style="color:#ae81ff">240</span><span style="color:#111">(</span><span style="color:#75af00">SP</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">MOVUPS</span> <span style="color:#75af00">X9</span><span style="color:#111">,</span> <span style="color:#ae81ff">256</span><span style="color:#111">(</span><span style="color:#75af00">SP</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">MOVUPS</span> <span style="color:#75af00">X10</span><span style="color:#111">,</span> <span style="color:#ae81ff">272</span><span style="color:#111">(</span><span style="color:#75af00">SP</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">MOVUPS</span> <span style="color:#75af00">X11</span><span style="color:#111">,</span> <span style="color:#ae81ff">288</span><span style="color:#111">(</span><span style="color:#75af00">SP</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">MOVUPS</span> <span style="color:#75af00">X12</span><span style="color:#111">,</span> <span style="color:#ae81ff">304</span><span style="color:#111">(</span><span style="color:#75af00">SP</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">MOVUPS</span> <span style="color:#75af00">X13</span><span style="color:#111">,</span> <span style="color:#ae81ff">320</span><span style="color:#111">(</span><span style="color:#75af00">SP</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">MOVUPS</span> <span style="color:#75af00">X14</span><span style="color:#111">,</span> <span style="color:#ae81ff">336</span><span style="color:#111">(</span><span style="color:#75af00">SP</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">MOVUPS</span> <span style="color:#75af00">X15</span><span style="color:#111">,</span> <span style="color:#ae81ff">352</span><span style="color:#111">(</span><span style="color:#75af00">SP</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">CALL</span> <span style="color:#960050;background-color:#1e0010">·</span><span style="color:#75af00">asyncPreempt2</span><span style="color:#111">(</span><span style="color:#75af00">SB</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">MOVUPS</span> <span style="color:#ae81ff">352</span><span style="color:#111">(</span><span style="color:#75af00">SP</span><span style="color:#111">),</span> <span style="color:#75af00">X15</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">MOVUPS</span> <span style="color:#ae81ff">336</span><span style="color:#111">(</span><span style="color:#75af00">SP</span><span style="color:#111">),</span> <span style="color:#75af00">X14</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">MOVUPS</span> <span style="color:#ae81ff">320</span><span style="color:#111">(</span><span style="color:#75af00">SP</span><span style="color:#111">),</span> <span style="color:#75af00">X13</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">MOVUPS</span> <span style="color:#ae81ff">304</span><span style="color:#111">(</span><span style="color:#75af00">SP</span><span style="color:#111">),</span> <span style="color:#75af00">X12</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">MOVUPS</span> <span style="color:#ae81ff">288</span><span style="color:#111">(</span><span style="color:#75af00">SP</span><span style="color:#111">),</span> <span style="color:#75af00">X11</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">MOVUPS</span> <span style="color:#ae81ff">272</span><span style="color:#111">(</span><span style="color:#75af00">SP</span><span style="color:#111">),</span> <span style="color:#75af00">X10</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">MOVUPS</span> <span style="color:#ae81ff">256</span><span style="color:#111">(</span><span style="color:#75af00">SP</span><span style="color:#111">),</span> <span style="color:#75af00">X9</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">MOVUPS</span> <span style="color:#ae81ff">240</span><span style="color:#111">(</span><span style="color:#75af00">SP</span><span style="color:#111">),</span> <span style="color:#75af00">X8</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">MOVUPS</span> <span style="color:#ae81ff">224</span><span style="color:#111">(</span><span style="color:#75af00">SP</span><span style="color:#111">),</span> <span style="color:#75af00">X7</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">MOVUPS</span> <span style="color:#ae81ff">208</span><span style="color:#111">(</span><span style="color:#75af00">SP</span><span style="color:#111">),</span> <span style="color:#75af00">X6</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">MOVUPS</span> <span style="color:#ae81ff">192</span><span style="color:#111">(</span><span style="color:#75af00">SP</span><span style="color:#111">),</span> <span style="color:#75af00">X5</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">MOVUPS</span> <span style="color:#ae81ff">176</span><span style="color:#111">(</span><span style="color:#75af00">SP</span><span style="color:#111">),</span> <span style="color:#75af00">X4</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">MOVUPS</span> <span style="color:#ae81ff">160</span><span style="color:#111">(</span><span style="color:#75af00">SP</span><span style="color:#111">),</span> <span style="color:#75af00">X3</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">MOVUPS</span> <span style="color:#ae81ff">144</span><span style="color:#111">(</span><span style="color:#75af00">SP</span><span style="color:#111">),</span> <span style="color:#75af00">X2</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">MOVUPS</span> <span style="color:#ae81ff">128</span><span style="color:#111">(</span><span style="color:#75af00">SP</span><span style="color:#111">),</span> <span style="color:#75af00">X1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">MOVUPS</span> <span style="color:#ae81ff">112</span><span style="color:#111">(</span><span style="color:#75af00">SP</span><span style="color:#111">),</span> <span style="color:#75af00">X0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">MOVQ</span> <span style="color:#ae81ff">104</span><span style="color:#111">(</span><span style="color:#75af00">SP</span><span style="color:#111">),</span> <span style="color:#75af00">R15</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">MOVQ</span> <span style="color:#ae81ff">96</span><span style="color:#111">(</span><span style="color:#75af00">SP</span><span style="color:#111">),</span> <span style="color:#75af00">R14</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">MOVQ</span> <span style="color:#ae81ff">88</span><span style="color:#111">(</span><span style="color:#75af00">SP</span><span style="color:#111">),</span> <span style="color:#75af00">R13</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">MOVQ</span> <span style="color:#ae81ff">80</span><span style="color:#111">(</span><span style="color:#75af00">SP</span><span style="color:#111">),</span> <span style="color:#75af00">R12</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">MOVQ</span> <span style="color:#ae81ff">72</span><span style="color:#111">(</span><span style="color:#75af00">SP</span><span style="color:#111">),</span> <span style="color:#75af00">R11</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">MOVQ</span> <span style="color:#ae81ff">64</span><span style="color:#111">(</span><span style="color:#75af00">SP</span><span style="color:#111">),</span> <span style="color:#75af00">R10</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">MOVQ</span> <span style="color:#ae81ff">56</span><span style="color:#111">(</span><span style="color:#75af00">SP</span><span style="color:#111">),</span> <span style="color:#75af00">R9</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">MOVQ</span> <span style="color:#ae81ff">48</span><span style="color:#111">(</span><span style="color:#75af00">SP</span><span style="color:#111">),</span> <span style="color:#75af00">R8</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">MOVQ</span> <span style="color:#ae81ff">40</span><span style="color:#111">(</span><span style="color:#75af00">SP</span><span style="color:#111">),</span> <span style="color:#75af00">DI</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">MOVQ</span> <span style="color:#ae81ff">32</span><span style="color:#111">(</span><span style="color:#75af00">SP</span><span style="color:#111">),</span> <span style="color:#75af00">SI</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">MOVQ</span> <span style="color:#ae81ff">24</span><span style="color:#111">(</span><span style="color:#75af00">SP</span><span style="color:#111">),</span> <span style="color:#75af00">BX</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">MOVQ</span> <span style="color:#ae81ff">16</span><span style="color:#111">(</span><span style="color:#75af00">SP</span><span style="color:#111">),</span> <span style="color:#75af00">DX</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">MOVQ</span> <span style="color:#ae81ff">8</span><span style="color:#111">(</span><span style="color:#75af00">SP</span><span style="color:#111">),</span> <span style="color:#75af00">CX</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">MOVQ</span> <span style="color:#ae81ff">0</span><span style="color:#111">(</span><span style="color:#75af00">SP</span><span style="color:#111">),</span> <span style="color:#75af00">AX</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ADJSP</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#f92672">-</span><span style="color:#ae81ff">368</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">POPFQ</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">POPQ</span> <span style="color:#75af00">BP</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">RET</span>
</span></span></code></pre></div><p>这段汇编代码很简单，把各种寄存器保存到栈中，然后调用 asyncPreempt2 函数，这个函数会恢复这些寋存器。然后把 BP 弹回去，最后 RET 返回。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">asyncPreempt2</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">gp</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">getg</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">gp</span><span style="color:#111">.</span><span style="color:#75af00">asyncSafePoint</span> <span style="color:#111">=</span> <span style="color:#00a8c8">true</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">gp</span><span style="color:#111">.</span><span style="color:#75af00">preemptStop</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">mcall</span><span style="color:#111">(</span><span style="color:#75af00">preemptPark</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">mcall</span><span style="color:#111">(</span><span style="color:#75af00">gopreempt_m</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">gp</span><span style="color:#111">.</span><span style="color:#75af00">asyncSafePoint</span> <span style="color:#111">=</span> <span style="color:#00a8c8">false</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>这个代码就是开始交给 g0 去执行调度任务，当 goroutine 回来可以继续执行的时候，会执行恢复寄存器的代码。</p>
<p><img src="/images/gmp_preempt.png" alt=""></p>
<h2 id="g0-和-sysmon-stack">G0 和 sysmon stack</h2>
<p>G0 和 sysmon 使用的是 OS 栈还是 runtime 自己维护的栈呢？</p>
<p>我们看下代码：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// sysmon</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#75af00">haveSysmon</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">systemstack</span><span style="color:#111">(</span><span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">newm</span><span style="color:#111">(</span><span style="color:#75af00">sysmon</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// newm -&gt; allocm</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">allocm</span><span style="color:#111">(</span><span style="color:#75af00">pp</span> <span style="color:#f92672">*</span><span style="color:#75af00">p</span><span style="color:#111">,</span> <span style="color:#75af00">fn</span> <span style="color:#00a8c8">func</span><span style="color:#111">(),</span> <span style="color:#75af00">id</span> <span style="color:#00a8c8">int64</span><span style="color:#111">)</span> <span style="color:#f92672">*</span><span style="color:#75af00">m</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ... </span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">iscgo</span> <span style="color:#f92672">||</span> <span style="color:#75af00">mStackIsSystemAllocated</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">mp</span><span style="color:#111">.</span><span style="color:#75af00">g0</span> <span style="color:#111">=</span> <span style="color:#75af00">malg</span><span style="color:#111">(</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">mp</span><span style="color:#111">.</span><span style="color:#75af00">g0</span> <span style="color:#111">=</span> <span style="color:#75af00">malg</span><span style="color:#111">(</span><span style="color:#ae81ff">16384</span> <span style="color:#f92672">*</span> <span style="color:#75af00">sys</span><span style="color:#111">.</span><span style="color:#75af00">StackGuardMultiplier</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ...</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>可以看到，sysmon 或者普通的线程都是在 allocm 中创建的栈 上边介绍过了，<code>malg(-1)</code> 是 OS stack，<code>malg(16384 * sys.StackGuardMultiplier)</code> 是 runtime 自己维护的 16K 栈。</p>
<p>首先 sysmon 和 G0 都一定不是 CGO，根据操作系统来判断是不是 OS stack，linux 是 runtime 自己维护的栈。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">mStackIsSystemAllocated</span><span style="color:#111">()</span> <span style="color:#00a8c8">bool</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">switch</span> <span style="color:#75af00">GOOS</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">case</span> <span style="color:#d88200">&#34;aix&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;darwin&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;plan9&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;illumos&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;ios&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;solaris&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;windows&#34;</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">true</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">case</span> <span style="color:#d88200">&#34;openbsd&#34;</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">GOARCH</span> <span style="color:#f92672">!=</span> <span style="color:#d88200">&#34;mips64&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">false</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div>]]></content:encoded><category>go</category></item><item><title>行为模式</title><link>https://daemon365.dev/post/go/behavioral_patterns/</link><pubDate>Mon, 25 Sep 2023 00:00:00 +0800</pubDate><guid>https://daemon365.dev/post/go/behavioral_patterns/</guid><description>&lt;h2 id="责任链模式"&gt;责任链模式&lt;/h2&gt;
&lt;p&gt;&lt;strong&gt;责任链模式&lt;/strong&gt;是一种行为设计模式， 允许你将请求沿着处理者链进行发送。 收到请求后， 每个处理者均可对请求进行处理， 或将其传递给链上的下个处理者。比如 &lt;code&gt;kratos&lt;/code&gt;,&lt;code&gt;gin&lt;/code&gt;等开源库的中间件实现。&lt;/p&gt;
&lt;h3 id="代码实现"&gt;代码实现&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;package&lt;/span&gt; &lt;span style="color:#75af00"&gt;main&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;import&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;context&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;fmt&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;type&lt;/span&gt; &lt;span style="color:#75af00"&gt;Handler&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;func&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;ctx&lt;/span&gt; &lt;span style="color:#75af00"&gt;context&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Context&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;req&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;interface&lt;/span&gt;&lt;span style="color:#111"&gt;{})&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;resp&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;interface&lt;/span&gt;&lt;span style="color:#111"&gt;{},&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;error&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;type&lt;/span&gt; &lt;span style="color:#75af00"&gt;Middleware&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;func&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;next&lt;/span&gt; &lt;span style="color:#75af00"&gt;Handler&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75af00"&gt;Handler&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;Chain&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;middlewares&lt;/span&gt; &lt;span style="color:#f92672"&gt;...&lt;/span&gt;&lt;span style="color:#75af00"&gt;Middleware&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75af00"&gt;Middleware&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;func&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;next&lt;/span&gt; &lt;span style="color:#75af00"&gt;Handler&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75af00"&gt;Handler&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;for&lt;/span&gt; &lt;span style="color:#75af00"&gt;i&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#111"&gt;len&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;middlewares&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#f92672"&gt;-&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;1&lt;/span&gt;&lt;span style="color:#111"&gt;;&lt;/span&gt; &lt;span style="color:#75af00"&gt;i&lt;/span&gt; &lt;span style="color:#f92672"&gt;&amp;gt;=&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;0&lt;/span&gt;&lt;span style="color:#111"&gt;;&lt;/span&gt; &lt;span style="color:#75af00"&gt;i&lt;/span&gt;&lt;span style="color:#f92672"&gt;--&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;next&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#75af00"&gt;middlewares&lt;/span&gt;&lt;span style="color:#111"&gt;[&lt;/span&gt;&lt;span style="color:#75af00"&gt;i&lt;/span&gt;&lt;span style="color:#111"&gt;](&lt;/span&gt;&lt;span style="color:#75af00"&gt;next&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt; &lt;span style="color:#75af00"&gt;next&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;main&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;c&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;Chain&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;next&lt;/span&gt; &lt;span style="color:#75af00"&gt;Handler&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75af00"&gt;Handler&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;func&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;ctx&lt;/span&gt; &lt;span style="color:#75af00"&gt;context&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Context&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;req&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;interface&lt;/span&gt;&lt;span style="color:#111"&gt;{})&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;resp&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;interface&lt;/span&gt;&lt;span style="color:#111"&gt;{},&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;error&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;handler 1 before&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;resp&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#75af00"&gt;next&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;ctx&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;req&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;handler 1 after&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt; &lt;span style="color:#75af00"&gt;resp&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;},&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;func&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;next&lt;/span&gt; &lt;span style="color:#75af00"&gt;Handler&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75af00"&gt;Handler&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;func&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;ctx&lt;/span&gt; &lt;span style="color:#75af00"&gt;context&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Context&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;req&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;interface&lt;/span&gt;&lt;span style="color:#111"&gt;{})&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;resp&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;interface&lt;/span&gt;&lt;span style="color:#111"&gt;{},&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;error&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;handler 2 before&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;resp&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#75af00"&gt;next&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;ctx&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;req&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;handler 2 after&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt; &lt;span style="color:#75af00"&gt;resp&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;})&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;resp&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;c&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;ctx&lt;/span&gt; &lt;span style="color:#75af00"&gt;context&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Context&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;req&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;interface&lt;/span&gt;&lt;span style="color:#111"&gt;{})&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;resp&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;interface&lt;/span&gt;&lt;span style="color:#111"&gt;{},&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;error&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;handler req:&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;req&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt; &lt;span style="color:#75af00"&gt;req&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;})(&lt;/span&gt;&lt;span style="color:#75af00"&gt;context&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Background&lt;/span&gt;&lt;span style="color:#111"&gt;(),&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;hello&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;resp&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;/*
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;handler 1 before
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;handler 2 before
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;handler req: hello
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;handler 2 after
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;handler 1 after
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;hello &amp;lt;nil&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;*/&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id="观察者模式"&gt;观察者模式&lt;/h2&gt;
&lt;p&gt;观察者模式用于触发联动。一个对象的改变会触发其它观察者的相关动作，而此对象无需关心连动对象的具体实现。&lt;/p&gt;</description><content:encoded><![CDATA[<h2 id="责任链模式">责任链模式</h2>
<p><strong>责任链模式</strong>是一种行为设计模式， 允许你将请求沿着处理者链进行发送。 收到请求后， 每个处理者均可对请求进行处理， 或将其传递给链上的下个处理者。比如 <code>kratos</code>,<code>gin</code>等开源库的中间件实现。</p>
<h3 id="代码实现">代码实现</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;context&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Handler</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">,</span> <span style="color:#75af00">req</span> <span style="color:#00a8c8">interface</span><span style="color:#111">{})</span> <span style="color:#111">(</span><span style="color:#75af00">resp</span> <span style="color:#00a8c8">interface</span><span style="color:#111">{},</span> <span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Middleware</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">next</span> <span style="color:#75af00">Handler</span><span style="color:#111">)</span> <span style="color:#75af00">Handler</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">Chain</span><span style="color:#111">(</span><span style="color:#75af00">middlewares</span> <span style="color:#f92672">...</span><span style="color:#75af00">Middleware</span><span style="color:#111">)</span> <span style="color:#75af00">Middleware</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">next</span> <span style="color:#75af00">Handler</span><span style="color:#111">)</span> <span style="color:#75af00">Handler</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">for</span> <span style="color:#75af00">i</span> <span style="color:#f92672">:=</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">middlewares</span><span style="color:#111">)</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span><span style="color:#111">;</span> <span style="color:#75af00">i</span> <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0</span><span style="color:#111">;</span> <span style="color:#75af00">i</span><span style="color:#f92672">--</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">next</span> <span style="color:#111">=</span> <span style="color:#75af00">middlewares</span><span style="color:#111">[</span><span style="color:#75af00">i</span><span style="color:#111">](</span><span style="color:#75af00">next</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">next</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">c</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">Chain</span><span style="color:#111">(</span><span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">next</span> <span style="color:#75af00">Handler</span><span style="color:#111">)</span> <span style="color:#75af00">Handler</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">,</span> <span style="color:#75af00">req</span> <span style="color:#00a8c8">interface</span><span style="color:#111">{})</span> <span style="color:#111">(</span><span style="color:#75af00">resp</span> <span style="color:#00a8c8">interface</span><span style="color:#111">{},</span> <span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;handler 1 before&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">resp</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">next</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">req</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;handler 1 after&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#75af00">resp</span><span style="color:#111">,</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">},</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">next</span> <span style="color:#75af00">Handler</span><span style="color:#111">)</span> <span style="color:#75af00">Handler</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">,</span> <span style="color:#75af00">req</span> <span style="color:#00a8c8">interface</span><span style="color:#111">{})</span> <span style="color:#111">(</span><span style="color:#75af00">resp</span> <span style="color:#00a8c8">interface</span><span style="color:#111">{},</span> <span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;handler 2 before&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">resp</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">next</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">req</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;handler 2 after&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#75af00">resp</span><span style="color:#111">,</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">resp</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">c</span><span style="color:#111">(</span><span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">,</span> <span style="color:#75af00">req</span> <span style="color:#00a8c8">interface</span><span style="color:#111">{})</span> <span style="color:#111">(</span><span style="color:#75af00">resp</span> <span style="color:#00a8c8">interface</span><span style="color:#111">{},</span> <span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;handler req:&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">req</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">req</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})(</span><span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Background</span><span style="color:#111">(),</span> <span style="color:#d88200">&#34;hello&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">resp</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">handler 1 before
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">handler 2 before
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">handler req: hello
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">handler 2 after
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">handler 1 after
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">hello &lt;nil&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span></code></pre></div><h2 id="观察者模式">观察者模式</h2>
<p>观察者模式用于触发联动。一个对象的改变会触发其它观察者的相关动作，而此对象无需关心连动对象的具体实现。</p>
<h3 id="代码实现-1">代码实现</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">subject</span> <span style="color:#00a8c8">interface</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">register</span><span style="color:#111">(</span><span style="color:#75af00">Observer</span> <span style="color:#75af00">observer</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">deregister</span><span style="color:#111">(</span><span style="color:#75af00">Observer</span> <span style="color:#75af00">observer</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">notifyAll</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">observer</span> <span style="color:#00a8c8">interface</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">update</span><span style="color:#111">(</span><span style="color:#00a8c8">string</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">getID</span><span style="color:#111">()</span> <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">item</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">observerList</span> <span style="color:#111">[]</span><span style="color:#75af00">observer</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">name</span>         <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">inStock</span>      <span style="color:#00a8c8">bool</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">newItem</span><span style="color:#111">(</span><span style="color:#75af00">name</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#f92672">*</span><span style="color:#75af00">item</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">item</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">name</span><span style="color:#111">:</span> <span style="color:#75af00">name</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">i</span> <span style="color:#f92672">*</span><span style="color:#75af00">item</span><span style="color:#111">)</span> <span style="color:#75af00">updateAvailability</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Item %s is now in stock\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">i</span><span style="color:#111">.</span><span style="color:#75af00">name</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">i</span><span style="color:#111">.</span><span style="color:#75af00">inStock</span> <span style="color:#111">=</span> <span style="color:#00a8c8">true</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">i</span><span style="color:#111">.</span><span style="color:#75af00">notifyAll</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">i</span> <span style="color:#f92672">*</span><span style="color:#75af00">item</span><span style="color:#111">)</span> <span style="color:#75af00">register</span><span style="color:#111">(</span><span style="color:#75af00">o</span> <span style="color:#75af00">observer</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">i</span><span style="color:#111">.</span><span style="color:#75af00">observerList</span> <span style="color:#111">=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">i</span><span style="color:#111">.</span><span style="color:#75af00">observerList</span><span style="color:#111">,</span> <span style="color:#75af00">o</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">i</span> <span style="color:#f92672">*</span><span style="color:#75af00">item</span><span style="color:#111">)</span> <span style="color:#75af00">deregister</span><span style="color:#111">(</span><span style="color:#75af00">o</span> <span style="color:#75af00">observer</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">i</span><span style="color:#111">.</span><span style="color:#75af00">observerList</span> <span style="color:#111">=</span> <span style="color:#75af00">removeFromslice</span><span style="color:#111">(</span><span style="color:#75af00">i</span><span style="color:#111">.</span><span style="color:#75af00">observerList</span><span style="color:#111">,</span> <span style="color:#75af00">o</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">i</span> <span style="color:#f92672">*</span><span style="color:#75af00">item</span><span style="color:#111">)</span> <span style="color:#75af00">notifyAll</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">observer</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">i</span><span style="color:#111">.</span><span style="color:#75af00">observerList</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">observer</span><span style="color:#111">.</span><span style="color:#75af00">update</span><span style="color:#111">(</span><span style="color:#75af00">i</span><span style="color:#111">.</span><span style="color:#75af00">name</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">removeFromslice</span><span style="color:#111">(</span><span style="color:#75af00">observerList</span> <span style="color:#111">[]</span><span style="color:#75af00">observer</span><span style="color:#111">,</span> <span style="color:#75af00">observerToRemove</span> <span style="color:#75af00">observer</span><span style="color:#111">)</span> <span style="color:#111">[]</span><span style="color:#75af00">observer</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">observerListLength</span> <span style="color:#f92672">:=</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">observerList</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">i</span><span style="color:#111">,</span> <span style="color:#75af00">observer</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">observerList</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">observerToRemove</span><span style="color:#111">.</span><span style="color:#75af00">getID</span><span style="color:#111">()</span> <span style="color:#f92672">==</span> <span style="color:#75af00">observer</span><span style="color:#111">.</span><span style="color:#75af00">getID</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">observerList</span><span style="color:#111">[</span><span style="color:#75af00">observerListLength</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">],</span> <span style="color:#75af00">observerList</span><span style="color:#111">[</span><span style="color:#75af00">i</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#75af00">observerList</span><span style="color:#111">[</span><span style="color:#75af00">i</span><span style="color:#111">],</span> <span style="color:#75af00">observerList</span><span style="color:#111">[</span><span style="color:#75af00">observerListLength</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#75af00">observerList</span><span style="color:#111">[:</span><span style="color:#75af00">observerListLength</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">observerList</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">customer</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">id</span> <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">customer</span><span style="color:#111">)</span> <span style="color:#75af00">update</span><span style="color:#111">(</span><span style="color:#75af00">itemName</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Sending email to customer %s for item %s\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">id</span><span style="color:#111">,</span> <span style="color:#75af00">itemName</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">customer</span><span style="color:#111">)</span> <span style="color:#75af00">getID</span><span style="color:#111">()</span> <span style="color:#00a8c8">string</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">id</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">shirtItem</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">newItem</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Nike Shirt&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">observerFirst</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">customer</span><span style="color:#111">{</span><span style="color:#75af00">id</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;abc@gmail.com&#34;</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">observerSecond</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">customer</span><span style="color:#111">{</span><span style="color:#75af00">id</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;xyz@gmail.com&#34;</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">shirtItem</span><span style="color:#111">.</span><span style="color:#75af00">register</span><span style="color:#111">(</span><span style="color:#75af00">observerFirst</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">shirtItem</span><span style="color:#111">.</span><span style="color:#75af00">register</span><span style="color:#111">(</span><span style="color:#75af00">observerSecond</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">shirtItem</span><span style="color:#111">.</span><span style="color:#75af00">updateAvailability</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">Item Nike Shirt is now in stock
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">Sending email to customer abc@gmail.com for item Nike Shirt
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">Sending email to customer xyz@gmail.com for item Nike Shirt
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span></code></pre></div><h2 id="模板方法模式">模板方法模式</h2>
<p>模版方法模式使用继承机制，把通用步骤和通用方法放到父类中，把具体实现延迟到子类中实现。使得实现符合开闭原则。</p>
<p>如实例代码中通用步骤在父类中实现（<code>准备</code>、<code>下载</code>、<code>保存</code>、<code>收尾</code>）下载和保存的具体实现留到子类中，并且提供 <code>保存</code>方法的默认实现。</p>
<p>因为Golang不提供继承机制，需要使用匿名组合模拟实现继承。</p>
<p>此处需要注意：因为父类需要调用子类方法，所以子类需要匿名组合父类的同时，父类需要持有子类的引用。</p>
<h3 id="代码实现-2">代码实现</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Downloader</span> <span style="color:#00a8c8">interface</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Download</span><span style="color:#111">(</span><span style="color:#75af00">uri</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">template</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">implement</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">uri</span> <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">implement</span> <span style="color:#00a8c8">interface</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">download</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">save</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">newTemplate</span><span style="color:#111">(</span><span style="color:#75af00">impl</span> <span style="color:#75af00">implement</span><span style="color:#111">)</span> <span style="color:#f92672">*</span><span style="color:#75af00">template</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">template</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">implement</span><span style="color:#111">:</span> <span style="color:#75af00">impl</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">t</span> <span style="color:#f92672">*</span><span style="color:#75af00">template</span><span style="color:#111">)</span> <span style="color:#75af00">Download</span><span style="color:#111">(</span><span style="color:#75af00">uri</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">uri</span> <span style="color:#111">=</span> <span style="color:#75af00">uri</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Print</span><span style="color:#111">(</span><span style="color:#d88200">&#34;prepare downloading\n&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">implement</span><span style="color:#111">.</span><span style="color:#75af00">download</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">implement</span><span style="color:#111">.</span><span style="color:#75af00">save</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Print</span><span style="color:#111">(</span><span style="color:#d88200">&#34;finish downloading\n&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">t</span> <span style="color:#f92672">*</span><span style="color:#75af00">template</span><span style="color:#111">)</span> <span style="color:#75af00">save</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Print</span><span style="color:#111">(</span><span style="color:#d88200">&#34;default save\n&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">HTTPDownloader</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">*</span><span style="color:#75af00">template</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">NewHTTPDownloader</span><span style="color:#111">()</span> <span style="color:#75af00">Downloader</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">downloader</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">HTTPDownloader</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">template</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">newTemplate</span><span style="color:#111">(</span><span style="color:#75af00">downloader</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">downloader</span><span style="color:#111">.</span><span style="color:#75af00">template</span> <span style="color:#111">=</span> <span style="color:#75af00">template</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">downloader</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">d</span> <span style="color:#f92672">*</span><span style="color:#75af00">HTTPDownloader</span><span style="color:#111">)</span> <span style="color:#75af00">download</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;download %s via http\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">d</span><span style="color:#111">.</span><span style="color:#75af00">uri</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">HTTPDownloader</span><span style="color:#111">)</span> <span style="color:#75af00">save</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;http save\n&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">FTPDownloader</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">*</span><span style="color:#75af00">template</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">NewFTPDownloader</span><span style="color:#111">()</span> <span style="color:#75af00">Downloader</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">downloader</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">FTPDownloader</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">template</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">newTemplate</span><span style="color:#111">(</span><span style="color:#75af00">downloader</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">downloader</span><span style="color:#111">.</span><span style="color:#75af00">template</span> <span style="color:#111">=</span> <span style="color:#75af00">template</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">downloader</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">d</span> <span style="color:#f92672">*</span><span style="color:#75af00">FTPDownloader</span><span style="color:#111">)</span> <span style="color:#75af00">download</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;download %s via ftp\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">d</span><span style="color:#111">.</span><span style="color:#75af00">uri</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">downloader</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">NewHTTPDownloader</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">downloader</span><span style="color:#111">.</span><span style="color:#75af00">Download</span><span style="color:#111">(</span><span style="color:#d88200">&#34;http://example.com/abc.zip&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">downloader</span> <span style="color:#111">=</span> <span style="color:#75af00">NewFTPDownloader</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">downloader</span><span style="color:#111">.</span><span style="color:#75af00">Download</span><span style="color:#111">(</span><span style="color:#d88200">&#34;ftp://example.com/abc.zip&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">prepare downloading
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">download http://example.com/abc.zip via http
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">http save
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">finish downloading
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">prepare downloading
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">download ftp://example.com/abc.zip via ftp
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">default save
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">finish downloading
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span></code></pre></div><h2 id="命令模式">命令模式</h2>
<p><strong>命令模式</strong>是一种行为设计模式， 它可将请求转换为一个包含与请求相关的所有信息的独立对象。 该转换让你能根据不同的请求将方法参数化、 延迟请求执行或将其放入队列中， 且能实现可撤销操作。</p>
<p>命令模式本质是把某个对象的方法调用封装到对象中，方便传递、存储、调用。</p>
<p>示例中把主板单中的启动(start)方法和重启(reboot)方法封装为命令对象，再传递到主机(box)对象中。于两个按钮进行绑定：</p>
<ul>
<li>第一个机箱(box1)设置按钮1(button1) 为开机按钮2(button2)为重启。</li>
<li>第二个机箱(box1)设置按钮2(button2) 为开机按钮1(button1)为重启。</li>
</ul>
<p>从而得到配置灵活性。</p>
<p>除了配置灵活外，使用命令模式还可以用作：</p>
<ul>
<li>批处理</li>
<li>任务队列</li>
<li>undo, redo</li>
</ul>
<p>等把具体命令封装到对象中使用的场合</p>
<h3 id="代码实现-3">代码实现</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">command</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Command</span> <span style="color:#00a8c8">interface</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Execute</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">StartCommand</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">mb</span> <span style="color:#f92672">*</span><span style="color:#75af00">MotherBoard</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">NewStartCommand</span><span style="color:#111">(</span><span style="color:#75af00">mb</span> <span style="color:#f92672">*</span><span style="color:#75af00">MotherBoard</span><span style="color:#111">)</span> <span style="color:#f92672">*</span><span style="color:#75af00">StartCommand</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">StartCommand</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">mb</span><span style="color:#111">:</span> <span style="color:#75af00">mb</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">StartCommand</span><span style="color:#111">)</span> <span style="color:#75af00">Execute</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">mb</span><span style="color:#111">.</span><span style="color:#75af00">Start</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">RebootCommand</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">mb</span> <span style="color:#f92672">*</span><span style="color:#75af00">MotherBoard</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">NewRebootCommand</span><span style="color:#111">(</span><span style="color:#75af00">mb</span> <span style="color:#f92672">*</span><span style="color:#75af00">MotherBoard</span><span style="color:#111">)</span> <span style="color:#f92672">*</span><span style="color:#75af00">RebootCommand</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">RebootCommand</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">mb</span><span style="color:#111">:</span> <span style="color:#75af00">mb</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">RebootCommand</span><span style="color:#111">)</span> <span style="color:#75af00">Execute</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">mb</span><span style="color:#111">.</span><span style="color:#75af00">Reboot</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">MotherBoard</span> <span style="color:#00a8c8">struct</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">MotherBoard</span><span style="color:#111">)</span> <span style="color:#75af00">Start</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Print</span><span style="color:#111">(</span><span style="color:#d88200">&#34;system starting\n&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">MotherBoard</span><span style="color:#111">)</span> <span style="color:#75af00">Reboot</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Print</span><span style="color:#111">(</span><span style="color:#d88200">&#34;system rebooting\n&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Box</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">button1</span> <span style="color:#75af00">Command</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">button2</span> <span style="color:#75af00">Command</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">NewBox</span><span style="color:#111">(</span><span style="color:#75af00">button1</span><span style="color:#111">,</span> <span style="color:#75af00">button2</span> <span style="color:#75af00">Command</span><span style="color:#111">)</span> <span style="color:#f92672">*</span><span style="color:#75af00">Box</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">Box</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">button1</span><span style="color:#111">:</span> <span style="color:#75af00">button1</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">button2</span><span style="color:#111">:</span> <span style="color:#75af00">button2</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">b</span> <span style="color:#f92672">*</span><span style="color:#75af00">Box</span><span style="color:#111">)</span> <span style="color:#75af00">PressButton1</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">button1</span><span style="color:#111">.</span><span style="color:#75af00">Execute</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">b</span> <span style="color:#f92672">*</span><span style="color:#75af00">Box</span><span style="color:#111">)</span> <span style="color:#75af00">PressButton2</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">button2</span><span style="color:#111">.</span><span style="color:#75af00">Execute</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="策略模式">策略模式</h2>
<p>它能让你定义一系列算法， 并将每种算法分别放入独立的类中， 以使算法的对象能够相互替换。</p>
<h3 id="代码实现-4">代码实现</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Payment</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">context</span>  <span style="color:#f92672">*</span><span style="color:#75af00">PaymentContext</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">strategy</span> <span style="color:#75af00">PaymentStrategy</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">PaymentContext</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Name</span><span style="color:#111">,</span> <span style="color:#75af00">CardID</span> <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Money</span>        <span style="color:#00a8c8">int</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">NewPayment</span><span style="color:#111">(</span><span style="color:#75af00">name</span><span style="color:#111">,</span> <span style="color:#75af00">cardid</span> <span style="color:#00a8c8">string</span><span style="color:#111">,</span> <span style="color:#75af00">money</span> <span style="color:#00a8c8">int</span><span style="color:#111">,</span> <span style="color:#75af00">strategy</span> <span style="color:#75af00">PaymentStrategy</span><span style="color:#111">)</span> <span style="color:#f92672">*</span><span style="color:#75af00">Payment</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">Payment</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">context</span><span style="color:#111">:</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">PaymentContext</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">Name</span><span style="color:#111">:</span>   <span style="color:#75af00">name</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">CardID</span><span style="color:#111">:</span> <span style="color:#75af00">cardid</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">Money</span><span style="color:#111">:</span>  <span style="color:#75af00">money</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">strategy</span><span style="color:#111">:</span> <span style="color:#75af00">strategy</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">p</span> <span style="color:#f92672">*</span><span style="color:#75af00">Payment</span><span style="color:#111">)</span> <span style="color:#75af00">Pay</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">strategy</span><span style="color:#111">.</span><span style="color:#75af00">Pay</span><span style="color:#111">(</span><span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">context</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">PaymentStrategy</span> <span style="color:#00a8c8">interface</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Pay</span><span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">PaymentContext</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Cash</span> <span style="color:#00a8c8">struct</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">Cash</span><span style="color:#111">)</span> <span style="color:#75af00">Pay</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span> <span style="color:#f92672">*</span><span style="color:#75af00">PaymentContext</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Pay $%d to %s by cash\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">ctx</span><span style="color:#111">.</span><span style="color:#75af00">Money</span><span style="color:#111">,</span> <span style="color:#75af00">ctx</span><span style="color:#111">.</span><span style="color:#75af00">Name</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Bank</span> <span style="color:#00a8c8">struct</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">Bank</span><span style="color:#111">)</span> <span style="color:#75af00">Pay</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span> <span style="color:#f92672">*</span><span style="color:#75af00">PaymentContext</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Pay $%d to %s by bank account %s\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">ctx</span><span style="color:#111">.</span><span style="color:#75af00">Money</span><span style="color:#111">,</span> <span style="color:#75af00">ctx</span><span style="color:#111">.</span><span style="color:#75af00">Name</span><span style="color:#111">,</span> <span style="color:#75af00">ctx</span><span style="color:#111">.</span><span style="color:#75af00">CardID</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">payment</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">NewPayment</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Ada&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;&#34;</span><span style="color:#111">,</span> <span style="color:#ae81ff">123</span><span style="color:#111">,</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">Cash</span><span style="color:#111">{})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">payment</span><span style="color:#111">.</span><span style="color:#75af00">Pay</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">payment</span> <span style="color:#111">=</span> <span style="color:#75af00">NewPayment</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Bob&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;0002&#34;</span><span style="color:#111">,</span> <span style="color:#ae81ff">888</span><span style="color:#111">,</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">Bank</span><span style="color:#111">{})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">payment</span><span style="color:#111">.</span><span style="color:#75af00">Pay</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">Pay $123 to Ada by cash
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">Pay $888 to Bob by bank account 0002
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span></code></pre></div><h2 id="状态模式">状态模式</h2>
<p>让你能在一个对象的内部状态变化时改变其行为， 使其看上去就像改变了自身所属的类一样。</p>
<h3 id="代码实现-5">代码实现</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Machine 状态机</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Machine</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">state</span> <span style="color:#75af00">IState</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// SetState 更新状态</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">m</span> <span style="color:#f92672">*</span><span style="color:#75af00">Machine</span><span style="color:#111">)</span> <span style="color:#75af00">SetState</span><span style="color:#111">(</span><span style="color:#75af00">state</span> <span style="color:#75af00">IState</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">state</span> <span style="color:#111">=</span> <span style="color:#75af00">state</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// GetStateName 获取当前状态</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">m</span> <span style="color:#f92672">*</span><span style="color:#75af00">Machine</span><span style="color:#111">)</span> <span style="color:#75af00">GetStateName</span><span style="color:#111">()</span> <span style="color:#00a8c8">string</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">state</span><span style="color:#111">.</span><span style="color:#75af00">GetName</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">m</span> <span style="color:#f92672">*</span><span style="color:#75af00">Machine</span><span style="color:#111">)</span> <span style="color:#75af00">Approval</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">state</span><span style="color:#111">.</span><span style="color:#75af00">Approval</span><span style="color:#111">(</span><span style="color:#75af00">m</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">m</span> <span style="color:#f92672">*</span><span style="color:#75af00">Machine</span><span style="color:#111">)</span> <span style="color:#75af00">Reject</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">state</span><span style="color:#111">.</span><span style="color:#75af00">Reject</span><span style="color:#111">(</span><span style="color:#75af00">m</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// IState 状态</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">IState</span> <span style="color:#00a8c8">interface</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 审批通过</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Approval</span><span style="color:#111">(</span><span style="color:#75af00">m</span> <span style="color:#f92672">*</span><span style="color:#75af00">Machine</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 驳回</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Reject</span><span style="color:#111">(</span><span style="color:#75af00">m</span> <span style="color:#f92672">*</span><span style="color:#75af00">Machine</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 获取当前状态名称</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">GetName</span><span style="color:#111">()</span> <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// leaderApproveState 直属领导审批</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">leaderApproveState</span> <span style="color:#00a8c8">struct</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Approval 获取状态名字</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">leaderApproveState</span><span style="color:#111">)</span> <span style="color:#75af00">Approval</span><span style="color:#111">(</span><span style="color:#75af00">m</span> <span style="color:#f92672">*</span><span style="color:#75af00">Machine</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;leader 审批成功&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">SetState</span><span style="color:#111">(</span><span style="color:#75af00">GetFinanceApproveState</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// GetName 获取状态名字</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">leaderApproveState</span><span style="color:#111">)</span> <span style="color:#75af00">GetName</span><span style="color:#111">()</span> <span style="color:#00a8c8">string</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#d88200">&#34;LeaderApproveState&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Reject 获取状态名字</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">leaderApproveState</span><span style="color:#111">)</span> <span style="color:#75af00">Reject</span><span style="color:#111">(</span><span style="color:#75af00">m</span> <span style="color:#f92672">*</span><span style="color:#75af00">Machine</span><span style="color:#111">)</span> <span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">GetLeaderApproveState</span><span style="color:#111">()</span> <span style="color:#75af00">IState</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">leaderApproveState</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// financeApproveState 财务审批</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">financeApproveState</span> <span style="color:#00a8c8">struct</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Approval 审批通过</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">f</span> <span style="color:#75af00">financeApproveState</span><span style="color:#111">)</span> <span style="color:#75af00">Approval</span><span style="color:#111">(</span><span style="color:#75af00">m</span> <span style="color:#f92672">*</span><span style="color:#75af00">Machine</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;财务审批成功&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;出发打款操作&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 拒绝</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">f</span> <span style="color:#75af00">financeApproveState</span><span style="color:#111">)</span> <span style="color:#75af00">Reject</span><span style="color:#111">(</span><span style="color:#75af00">m</span> <span style="color:#f92672">*</span><span style="color:#75af00">Machine</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">SetState</span><span style="color:#111">(</span><span style="color:#75af00">GetLeaderApproveState</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// GetName 获取名字</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">f</span> <span style="color:#75af00">financeApproveState</span><span style="color:#111">)</span> <span style="color:#75af00">GetName</span><span style="color:#111">()</span> <span style="color:#00a8c8">string</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#d88200">&#34;FinanceApproveState&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// GetFinanceApproveState GetFinanceApproveState</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">GetFinanceApproveState</span><span style="color:#111">()</span> <span style="color:#75af00">IState</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">financeApproveState</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">m</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">Machine</span><span style="color:#111">{</span><span style="color:#75af00">state</span><span style="color:#111">:</span> <span style="color:#75af00">GetLeaderApproveState</span><span style="color:#111">()}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;LeaderApproveState&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">GetStateName</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">Approval</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;FinanceApproveState&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">GetStateName</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">Reject</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;LeaderApproveState&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">GetStateName</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">Approval</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;FinanceApproveState&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">GetStateName</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">Approval</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">LeaderApproveState LeaderApproveState
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">leader 审批成功
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">FinanceApproveState FinanceApproveState
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">LeaderApproveState LeaderApproveState
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">leader 审批成功
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">FinanceApproveState FinanceApproveState
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">财务审批成功
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">出发打款操作
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span></code></pre></div><h2 id="迭代器模式">迭代器模式</h2>
<p>让你能在不暴露集合底层表现形式 （列表、 栈和树等） 的情况下遍历集合中所有的元素。</p>
<h3 id="代码实现-6">代码实现</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">collection</span> <span style="color:#00a8c8">interface</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">createIterator</span><span style="color:#111">()</span> <span style="color:#75af00">iterator</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">userCollection</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">users</span> <span style="color:#111">[]</span><span style="color:#f92672">*</span><span style="color:#75af00">user</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">u</span> <span style="color:#f92672">*</span><span style="color:#75af00">userCollection</span><span style="color:#111">)</span> <span style="color:#75af00">createIterator</span><span style="color:#111">()</span> <span style="color:#75af00">iterator</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">userIterator</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">users</span><span style="color:#111">:</span> <span style="color:#75af00">u</span><span style="color:#111">.</span><span style="color:#75af00">users</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">iterator</span> <span style="color:#00a8c8">interface</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">hasNext</span><span style="color:#111">()</span> <span style="color:#00a8c8">bool</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">getNext</span><span style="color:#111">()</span> <span style="color:#f92672">*</span><span style="color:#75af00">user</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">userIterator</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">index</span> <span style="color:#00a8c8">int</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">users</span> <span style="color:#111">[]</span><span style="color:#f92672">*</span><span style="color:#75af00">user</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">u</span> <span style="color:#f92672">*</span><span style="color:#75af00">userIterator</span><span style="color:#111">)</span> <span style="color:#75af00">hasNext</span><span style="color:#111">()</span> <span style="color:#00a8c8">bool</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">u</span><span style="color:#111">.</span><span style="color:#75af00">index</span> <span style="color:#111">&lt;</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">u</span><span style="color:#111">.</span><span style="color:#75af00">users</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">true</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">false</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">u</span> <span style="color:#f92672">*</span><span style="color:#75af00">userIterator</span><span style="color:#111">)</span> <span style="color:#75af00">getNext</span><span style="color:#111">()</span> <span style="color:#f92672">*</span><span style="color:#75af00">user</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">u</span><span style="color:#111">.</span><span style="color:#75af00">hasNext</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">user</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">u</span><span style="color:#111">.</span><span style="color:#75af00">users</span><span style="color:#111">[</span><span style="color:#75af00">u</span><span style="color:#111">.</span><span style="color:#75af00">index</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">u</span><span style="color:#111">.</span><span style="color:#75af00">index</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">user</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">user</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">name</span> <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">age</span>  <span style="color:#00a8c8">int</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">user1</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">user</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">name</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;a&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">age</span><span style="color:#111">:</span>  <span style="color:#ae81ff">30</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">user2</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">user</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">name</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;b&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">age</span><span style="color:#111">:</span>  <span style="color:#ae81ff">20</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">userCollection</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">userCollection</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">users</span><span style="color:#111">:</span> <span style="color:#111">[]</span><span style="color:#f92672">*</span><span style="color:#75af00">user</span><span style="color:#111">{</span><span style="color:#75af00">user1</span><span style="color:#111">,</span> <span style="color:#75af00">user2</span><span style="color:#111">},</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">iterator</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">userCollection</span><span style="color:#111">.</span><span style="color:#75af00">createIterator</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">iterator</span><span style="color:#111">.</span><span style="color:#75af00">hasNext</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">user</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">iterator</span><span style="color:#111">.</span><span style="color:#75af00">getNext</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;User is %+v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">user</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">User is &amp;{name:a age:30}
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">User is &amp;{name:b age:20}
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span></code></pre></div><h2 id="访问者模式">访问者模式</h2>
<p>访问者模式可以给一系列对象透明的添加功能，并且把相关代码封装到一个类中。</p>
<p>对象只要预留访问者接口<code>Accept</code>则后期为对象添加功能的时候就不需要改动对象。</p>
<h3 id="代码实现-7">代码实现</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Customer</span> <span style="color:#00a8c8">interface</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Accept</span><span style="color:#111">(</span><span style="color:#75af00">Visitor</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Visitor</span> <span style="color:#00a8c8">interface</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Visit</span><span style="color:#111">(</span><span style="color:#75af00">Customer</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">EnterpriseCustomer</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">name</span> <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">CustomerCol</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">customers</span> <span style="color:#111">[]</span><span style="color:#75af00">Customer</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">CustomerCol</span><span style="color:#111">)</span> <span style="color:#75af00">Add</span><span style="color:#111">(</span><span style="color:#75af00">customer</span> <span style="color:#75af00">Customer</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">customers</span> <span style="color:#111">=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">customers</span><span style="color:#111">,</span> <span style="color:#75af00">customer</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">CustomerCol</span><span style="color:#111">)</span> <span style="color:#75af00">Accept</span><span style="color:#111">(</span><span style="color:#75af00">visitor</span> <span style="color:#75af00">Visitor</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">customer</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">customers</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">customer</span><span style="color:#111">.</span><span style="color:#75af00">Accept</span><span style="color:#111">(</span><span style="color:#75af00">visitor</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">NewEnterpriseCustomer</span><span style="color:#111">(</span><span style="color:#75af00">name</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#f92672">*</span><span style="color:#75af00">EnterpriseCustomer</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">EnterpriseCustomer</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">name</span><span style="color:#111">:</span> <span style="color:#75af00">name</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">EnterpriseCustomer</span><span style="color:#111">)</span> <span style="color:#75af00">Accept</span><span style="color:#111">(</span><span style="color:#75af00">visitor</span> <span style="color:#75af00">Visitor</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">visitor</span><span style="color:#111">.</span><span style="color:#75af00">Visit</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">IndividualCustomer</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">name</span> <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">NewIndividualCustomer</span><span style="color:#111">(</span><span style="color:#75af00">name</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#f92672">*</span><span style="color:#75af00">IndividualCustomer</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">IndividualCustomer</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">name</span><span style="color:#111">:</span> <span style="color:#75af00">name</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">IndividualCustomer</span><span style="color:#111">)</span> <span style="color:#75af00">Accept</span><span style="color:#111">(</span><span style="color:#75af00">visitor</span> <span style="color:#75af00">Visitor</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">visitor</span><span style="color:#111">.</span><span style="color:#75af00">Visit</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">ServiceRequestVisitor</span> <span style="color:#00a8c8">struct</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">ServiceRequestVisitor</span><span style="color:#111">)</span> <span style="color:#75af00">Visit</span><span style="color:#111">(</span><span style="color:#75af00">customer</span> <span style="color:#75af00">Customer</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">switch</span> <span style="color:#75af00">c</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">customer</span><span style="color:#111">.(</span><span style="color:#00a8c8">type</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">case</span> <span style="color:#f92672">*</span><span style="color:#75af00">EnterpriseCustomer</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;serving enterprise customer %s\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">name</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">case</span> <span style="color:#f92672">*</span><span style="color:#75af00">IndividualCustomer</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;serving individual customer %s\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">name</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// only for enterprise</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">AnalysisVisitor</span> <span style="color:#00a8c8">struct</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">AnalysisVisitor</span><span style="color:#111">)</span> <span style="color:#75af00">Visit</span><span style="color:#111">(</span><span style="color:#75af00">customer</span> <span style="color:#75af00">Customer</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">switch</span> <span style="color:#75af00">c</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">customer</span><span style="color:#111">.(</span><span style="color:#00a8c8">type</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">case</span> <span style="color:#f92672">*</span><span style="color:#75af00">EnterpriseCustomer</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;analysis enterprise customer %s\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">name</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">c</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">CustomerCol</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">Add</span><span style="color:#111">(</span><span style="color:#75af00">NewEnterpriseCustomer</span><span style="color:#111">(</span><span style="color:#d88200">&#34;A company&#34;</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">Add</span><span style="color:#111">(</span><span style="color:#75af00">NewEnterpriseCustomer</span><span style="color:#111">(</span><span style="color:#d88200">&#34;B company&#34;</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">Add</span><span style="color:#111">(</span><span style="color:#75af00">NewIndividualCustomer</span><span style="color:#111">(</span><span style="color:#d88200">&#34;bob&#34;</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">Accept</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">ServiceRequestVisitor</span><span style="color:#111">{})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">c</span> <span style="color:#111">=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">CustomerCol</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">Add</span><span style="color:#111">(</span><span style="color:#75af00">NewEnterpriseCustomer</span><span style="color:#111">(</span><span style="color:#d88200">&#34;A company&#34;</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">Add</span><span style="color:#111">(</span><span style="color:#75af00">NewIndividualCustomer</span><span style="color:#111">(</span><span style="color:#d88200">&#34;bob&#34;</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">Add</span><span style="color:#111">(</span><span style="color:#75af00">NewEnterpriseCustomer</span><span style="color:#111">(</span><span style="color:#d88200">&#34;B company&#34;</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">Accept</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">AnalysisVisitor</span><span style="color:#111">{})</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">serving enterprise customer A company
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">serving enterprise customer B company
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">serving individual customer bob
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">analysis enterprise customer A company
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">analysis enterprise customer B company
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span></code></pre></div><h2 id="备忘录模式">备忘录模式</h2>
<p>备忘录模式用于保存程序内部状态到外部，又不希望暴露内部状态的情形。</p>
<p>程序内部状态使用窄接口传递给外部进行存储，从而不暴露程序实现细节。</p>
<p>备忘录模式同时可以离线保存内部状态，如保存到数据库，文件等。</p>
<h3 id="代码实现-8">代码实现</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Memento</span> <span style="color:#00a8c8">interface</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Game</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">hp</span><span style="color:#111">,</span> <span style="color:#75af00">mp</span> <span style="color:#00a8c8">int</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">gameMemento</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">hp</span><span style="color:#111">,</span> <span style="color:#75af00">mp</span> <span style="color:#00a8c8">int</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">g</span> <span style="color:#f92672">*</span><span style="color:#75af00">Game</span><span style="color:#111">)</span> <span style="color:#75af00">Play</span><span style="color:#111">(</span><span style="color:#75af00">mpDelta</span><span style="color:#111">,</span> <span style="color:#75af00">hpDelta</span> <span style="color:#00a8c8">int</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">mp</span> <span style="color:#f92672">+=</span> <span style="color:#75af00">mpDelta</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">hp</span> <span style="color:#f92672">+=</span> <span style="color:#75af00">hpDelta</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">g</span> <span style="color:#f92672">*</span><span style="color:#75af00">Game</span><span style="color:#111">)</span> <span style="color:#75af00">Save</span><span style="color:#111">()</span> <span style="color:#75af00">Memento</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">gameMemento</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">hp</span><span style="color:#111">:</span> <span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">hp</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">mp</span><span style="color:#111">:</span> <span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">mp</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">g</span> <span style="color:#f92672">*</span><span style="color:#75af00">Game</span><span style="color:#111">)</span> <span style="color:#75af00">Load</span><span style="color:#111">(</span><span style="color:#75af00">m</span> <span style="color:#75af00">Memento</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">gm</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">m</span><span style="color:#111">.(</span><span style="color:#f92672">*</span><span style="color:#75af00">gameMemento</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">mp</span> <span style="color:#111">=</span> <span style="color:#75af00">gm</span><span style="color:#111">.</span><span style="color:#75af00">mp</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">hp</span> <span style="color:#111">=</span> <span style="color:#75af00">gm</span><span style="color:#111">.</span><span style="color:#75af00">hp</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">g</span> <span style="color:#f92672">*</span><span style="color:#75af00">Game</span><span style="color:#111">)</span> <span style="color:#75af00">Status</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Current HP:%d, MP:%d\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">hp</span><span style="color:#111">,</span> <span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">mp</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">game</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">Game</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">hp</span><span style="color:#111">:</span> <span style="color:#ae81ff">10</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">mp</span><span style="color:#111">:</span> <span style="color:#ae81ff">10</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">game</span><span style="color:#111">.</span><span style="color:#75af00">Status</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">progress</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">game</span><span style="color:#111">.</span><span style="color:#75af00">Save</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">game</span><span style="color:#111">.</span><span style="color:#75af00">Play</span><span style="color:#111">(</span><span style="color:#f92672">-</span><span style="color:#ae81ff">2</span><span style="color:#111">,</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">3</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">game</span><span style="color:#111">.</span><span style="color:#75af00">Status</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">game</span><span style="color:#111">.</span><span style="color:#75af00">Load</span><span style="color:#111">(</span><span style="color:#75af00">progress</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">game</span><span style="color:#111">.</span><span style="color:#75af00">Status</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">Current HP:10, MP:10
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">Current HP:7, MP:8
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">Current HP:10, MP:10
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span></code></pre></div><h2 id="解释器模式">解释器模式</h2>
<p>解释器模式定义一套语言文法，并设计该语言解释器，使用户能使用特定文法控制解释器行为。</p>
<p>解释器模式的意义在于，它分离多种复杂功能的实现，每个功能只需关注自身的解释。</p>
<p>对于调用者不用关心内部的解释器的工作，只需要用简单的方式组合命令就可以。</p>
<h3 id="代码实现-9">代码实现</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;strconv&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;strings&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Node</span> <span style="color:#00a8c8">interface</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Interpret</span><span style="color:#111">()</span> <span style="color:#00a8c8">int</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">ValNode</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">val</span> <span style="color:#00a8c8">int</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">n</span> <span style="color:#f92672">*</span><span style="color:#75af00">ValNode</span><span style="color:#111">)</span> <span style="color:#75af00">Interpret</span><span style="color:#111">()</span> <span style="color:#00a8c8">int</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">val</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">AddNode</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">left</span><span style="color:#111">,</span> <span style="color:#75af00">right</span> <span style="color:#75af00">Node</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">n</span> <span style="color:#f92672">*</span><span style="color:#75af00">AddNode</span><span style="color:#111">)</span> <span style="color:#75af00">Interpret</span><span style="color:#111">()</span> <span style="color:#00a8c8">int</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">left</span><span style="color:#111">.</span><span style="color:#75af00">Interpret</span><span style="color:#111">()</span> <span style="color:#f92672">+</span> <span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">right</span><span style="color:#111">.</span><span style="color:#75af00">Interpret</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">MinNode</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">left</span><span style="color:#111">,</span> <span style="color:#75af00">right</span> <span style="color:#75af00">Node</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">n</span> <span style="color:#f92672">*</span><span style="color:#75af00">MinNode</span><span style="color:#111">)</span> <span style="color:#75af00">Interpret</span><span style="color:#111">()</span> <span style="color:#00a8c8">int</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">left</span><span style="color:#111">.</span><span style="color:#75af00">Interpret</span><span style="color:#111">()</span> <span style="color:#f92672">-</span> <span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">right</span><span style="color:#111">.</span><span style="color:#75af00">Interpret</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Parser</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">exp</span>   <span style="color:#111">[]</span><span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">index</span> <span style="color:#00a8c8">int</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">prev</span>  <span style="color:#75af00">Node</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">p</span> <span style="color:#f92672">*</span><span style="color:#75af00">Parser</span><span style="color:#111">)</span> <span style="color:#75af00">Parse</span><span style="color:#111">(</span><span style="color:#75af00">exp</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">exp</span> <span style="color:#111">=</span> <span style="color:#75af00">strings</span><span style="color:#111">.</span><span style="color:#75af00">Split</span><span style="color:#111">(</span><span style="color:#75af00">exp</span><span style="color:#111">,</span> <span style="color:#d88200">&#34; &#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">index</span> <span style="color:#f92672">&gt;=</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">exp</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">switch</span> <span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">exp</span><span style="color:#111">[</span><span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">index</span><span style="color:#111">]</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">case</span> <span style="color:#d88200">&#34;+&#34;</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">prev</span> <span style="color:#111">=</span> <span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">newAddNode</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">case</span> <span style="color:#d88200">&#34;-&#34;</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">prev</span> <span style="color:#111">=</span> <span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">newMinNode</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">default</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">prev</span> <span style="color:#111">=</span> <span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">newValNode</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">p</span> <span style="color:#f92672">*</span><span style="color:#75af00">Parser</span><span style="color:#111">)</span> <span style="color:#75af00">newAddNode</span><span style="color:#111">()</span> <span style="color:#75af00">Node</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">index</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">AddNode</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">left</span><span style="color:#111">:</span>  <span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">prev</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">right</span><span style="color:#111">:</span> <span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">newValNode</span><span style="color:#111">(),</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">p</span> <span style="color:#f92672">*</span><span style="color:#75af00">Parser</span><span style="color:#111">)</span> <span style="color:#75af00">newMinNode</span><span style="color:#111">()</span> <span style="color:#75af00">Node</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">index</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">MinNode</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">left</span><span style="color:#111">:</span>  <span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">prev</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">right</span><span style="color:#111">:</span> <span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">newValNode</span><span style="color:#111">(),</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">p</span> <span style="color:#f92672">*</span><span style="color:#75af00">Parser</span><span style="color:#111">)</span> <span style="color:#75af00">newValNode</span><span style="color:#111">()</span> <span style="color:#75af00">Node</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">v</span><span style="color:#111">,</span> <span style="color:#75af00">_</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">strconv</span><span style="color:#111">.</span><span style="color:#75af00">Atoi</span><span style="color:#111">(</span><span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">exp</span><span style="color:#111">[</span><span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">index</span><span style="color:#111">])</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">index</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">ValNode</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">val</span><span style="color:#111">:</span> <span style="color:#75af00">v</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">p</span> <span style="color:#f92672">*</span><span style="color:#75af00">Parser</span><span style="color:#111">)</span> <span style="color:#75af00">Result</span><span style="color:#111">()</span> <span style="color:#75af00">Node</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">prev</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">p</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">Parser</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">Parse</span><span style="color:#111">(</span><span style="color:#d88200">&#34;1 + 2 + 3 - 4 + 5 - 6&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">res</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">Result</span><span style="color:#111">().</span><span style="color:#75af00">Interpret</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">expect</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">res</span> <span style="color:#f92672">!=</span> <span style="color:#75af00">expect</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">res</span><span style="color:#111">,</span><span style="color:#75af00">expect</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="中介模式">中介模式</h2>
<p>中介者模式封装对象之间互交，使依赖变的简单，并且使复杂互交简单化，封装在中介者中。</p>
<p>例子中的中介者使用单例模式生成中介者。</p>
<p>中介者的change使用switch判断类型。</p>
<h3 id="代码实现-10">代码实现</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;strings&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">CDDriver</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Data</span> <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">CDDriver</span><span style="color:#111">)</span> <span style="color:#75af00">ReadData</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">Data</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;music,image&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;CDDriver: reading data %s\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">Data</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">GetMediatorInstance</span><span style="color:#111">().</span><span style="color:#75af00">changed</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">CPU</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Video</span> <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Sound</span> <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">CPU</span><span style="color:#111">)</span> <span style="color:#75af00">Process</span><span style="color:#111">(</span><span style="color:#75af00">data</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">sp</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">strings</span><span style="color:#111">.</span><span style="color:#75af00">Split</span><span style="color:#111">(</span><span style="color:#75af00">data</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;,&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">Sound</span> <span style="color:#111">=</span> <span style="color:#75af00">sp</span><span style="color:#111">[</span><span style="color:#ae81ff">0</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">Video</span> <span style="color:#111">=</span> <span style="color:#75af00">sp</span><span style="color:#111">[</span><span style="color:#ae81ff">1</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;CPU: split data with Sound %s, Video %s\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">Sound</span><span style="color:#111">,</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">Video</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">GetMediatorInstance</span><span style="color:#111">().</span><span style="color:#75af00">changed</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">VideoCard</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Data</span> <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">v</span> <span style="color:#f92672">*</span><span style="color:#75af00">VideoCard</span><span style="color:#111">)</span> <span style="color:#75af00">Display</span><span style="color:#111">(</span><span style="color:#75af00">data</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">v</span><span style="color:#111">.</span><span style="color:#75af00">Data</span> <span style="color:#111">=</span> <span style="color:#75af00">data</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;VideoCard: display %s\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">v</span><span style="color:#111">.</span><span style="color:#75af00">Data</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">GetMediatorInstance</span><span style="color:#111">().</span><span style="color:#75af00">changed</span><span style="color:#111">(</span><span style="color:#75af00">v</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">SoundCard</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Data</span> <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">s</span> <span style="color:#f92672">*</span><span style="color:#75af00">SoundCard</span><span style="color:#111">)</span> <span style="color:#75af00">Play</span><span style="color:#111">(</span><span style="color:#75af00">data</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">Data</span> <span style="color:#111">=</span> <span style="color:#75af00">data</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;SoundCard: play %s\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">Data</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">GetMediatorInstance</span><span style="color:#111">().</span><span style="color:#75af00">changed</span><span style="color:#111">(</span><span style="color:#75af00">s</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Mediator</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">CD</span>    <span style="color:#f92672">*</span><span style="color:#75af00">CDDriver</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">CPU</span>   <span style="color:#f92672">*</span><span style="color:#75af00">CPU</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Video</span> <span style="color:#f92672">*</span><span style="color:#75af00">VideoCard</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Sound</span> <span style="color:#f92672">*</span><span style="color:#75af00">SoundCard</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">var</span> <span style="color:#75af00">mediator</span> <span style="color:#f92672">*</span><span style="color:#75af00">Mediator</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">GetMediatorInstance</span><span style="color:#111">()</span> <span style="color:#f92672">*</span><span style="color:#75af00">Mediator</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">mediator</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">mediator</span> <span style="color:#111">=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">Mediator</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">mediator</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">m</span> <span style="color:#f92672">*</span><span style="color:#75af00">Mediator</span><span style="color:#111">)</span> <span style="color:#75af00">changed</span><span style="color:#111">(</span><span style="color:#75af00">i</span> <span style="color:#00a8c8">interface</span><span style="color:#111">{})</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">switch</span> <span style="color:#75af00">inst</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">i</span><span style="color:#111">.(</span><span style="color:#00a8c8">type</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">case</span> <span style="color:#f92672">*</span><span style="color:#75af00">CDDriver</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">CPU</span><span style="color:#111">.</span><span style="color:#75af00">Process</span><span style="color:#111">(</span><span style="color:#75af00">inst</span><span style="color:#111">.</span><span style="color:#75af00">Data</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">case</span> <span style="color:#f92672">*</span><span style="color:#75af00">CPU</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">Sound</span><span style="color:#111">.</span><span style="color:#75af00">Play</span><span style="color:#111">(</span><span style="color:#75af00">inst</span><span style="color:#111">.</span><span style="color:#75af00">Sound</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">Video</span><span style="color:#111">.</span><span style="color:#75af00">Display</span><span style="color:#111">(</span><span style="color:#75af00">inst</span><span style="color:#111">.</span><span style="color:#75af00">Video</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">mediator</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">GetMediatorInstance</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">mediator</span><span style="color:#111">.</span><span style="color:#75af00">CD</span> <span style="color:#111">=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">CDDriver</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">mediator</span><span style="color:#111">.</span><span style="color:#75af00">CPU</span> <span style="color:#111">=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">CPU</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">mediator</span><span style="color:#111">.</span><span style="color:#75af00">Video</span> <span style="color:#111">=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">VideoCard</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">mediator</span><span style="color:#111">.</span><span style="color:#75af00">Sound</span> <span style="color:#111">=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">SoundCard</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//Tiggle</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">mediator</span><span style="color:#111">.</span><span style="color:#75af00">CD</span><span style="color:#111">.</span><span style="color:#75af00">ReadData</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;%#v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">mediator</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">CDDriver: reading data music,image
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">CPU: split data with Sound music, Video image
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">SoundCard: play music
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">VideoCard: display image
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">&amp;main.Mediator{CD:(*main.CDDriver)(0xc000010250), CPU:(*main.CPU)(0xc000060040), Video:(*main.VideoCard)(0xc000010260), Sound:(*main.SoundCard)(0xc000010270)}
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span></code></pre></div><h2 id="references">References</h2>
<p><a href="https://github.com/senghoo/golang-design-pattern">https://github.com/senghoo/golang-design-pattern</a></p>
<p><a href="https://refactoringguru.cn/design-patterns">https://refactoringguru.cn/design-patterns</a></p>
<p><a href="https://lailin.xyz/post/singleton.html">https://lailin.xyz/post/singleton.html</a></p>
]]></content:encoded><category>go</category><category>go</category><category>设计模式</category></item><item><title>结构型模式</title><link>https://daemon365.dev/post/go/structural_patterns/</link><pubDate>Sun, 24 Sep 2023 00:00:00 +0800</pubDate><guid>https://daemon365.dev/post/go/structural_patterns/</guid><description>&lt;h2 id="适配器模式"&gt;适配器模式&lt;/h2&gt;
&lt;p&gt;适配器模式用于转换一种接口适配另一种接口。比如，现在有个借口是对&lt;code&gt;json&lt;/code&gt;字符串进行分析等，现在有一些&lt;code&gt;yaml&lt;/code&gt;文件也要分析，这时候我我们就应该给&lt;code&gt;yaml&lt;/code&gt;字符串就个适配器，转换成&lt;code&gt;json&lt;/code&gt;字符串，然后就行分析。&lt;/p&gt;
&lt;h3 id="代码实现"&gt;代码实现&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;package&lt;/span&gt; &lt;span style="color:#75af00"&gt;main&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;import&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;fmt&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;github.com/ghodss/yaml&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;type&lt;/span&gt; &lt;span style="color:#75af00"&gt;Analysis&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;interface&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;Analyze&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;string&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;error&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;type&lt;/span&gt; &lt;span style="color:#75af00"&gt;JsonAnalysis&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;struct&lt;/span&gt;&lt;span style="color:#111"&gt;{}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;JsonAnalysis&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75af00"&gt;Analyze&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;jsonStr&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;string&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;error&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// 函数逻辑&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;jsonStr&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;type&lt;/span&gt; &lt;span style="color:#75af00"&gt;yamlAnalysis&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;struct&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;ja&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;JsonAnalysis&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;y&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;yamlAnalysis&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75af00"&gt;Analyze&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;yamlStr&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;string&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;error&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;bs&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;yaml&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;YAMLToJSON&lt;/span&gt;&lt;span style="color:#111"&gt;([]&lt;/span&gt;&lt;span style="color:#111"&gt;byte&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;yamlStr&lt;/span&gt;&lt;span style="color:#111"&gt;))&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;!=&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt; &lt;span style="color:#75af00"&gt;y&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;ja&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Analyze&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#111"&gt;string&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;bs&lt;/span&gt;&lt;span style="color:#111"&gt;))&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;main&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;ja&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#f92672"&gt;&amp;amp;&lt;/span&gt;&lt;span style="color:#75af00"&gt;JsonAnalysis&lt;/span&gt;&lt;span style="color:#111"&gt;{}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;ja&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Analyze&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;{\&amp;#34;name\&amp;#34;:\&amp;#34;zhy\&amp;#34;,\&amp;#34;age\&amp;#34;:18}&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;!=&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;err&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;ya&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#f92672"&gt;&amp;amp;&lt;/span&gt;&lt;span style="color:#75af00"&gt;yamlAnalysis&lt;/span&gt;&lt;span style="color:#111"&gt;{&lt;/span&gt;&lt;span style="color:#75af00"&gt;ja&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#75af00"&gt;ja&lt;/span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#75af00"&gt;ya&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Analyze&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;name: you\nage: 88&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;!=&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;err&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;/*
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;{&amp;#34;name&amp;#34;:&amp;#34;zhy&amp;#34;,&amp;#34;age&amp;#34;:18}
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;{&amp;#34;age&amp;#34;:88,&amp;#34;name&amp;#34;:&amp;#34;you&amp;#34;}
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;*/&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id="桥接模式"&gt;桥接模式&lt;/h2&gt;
&lt;p&gt;桥接模式分离抽象部分和实现部分。使得两部分独立扩展。&lt;/p&gt;
&lt;p&gt;桥接模式类似于策略模式，区别在于策略模式封装一系列算法使得算法可以互相替换。&lt;/p&gt;
&lt;p&gt;策略模式使抽象部分和实现部分分离，可以独立变化。&lt;/p&gt;
&lt;p&gt;比如要发消息，可以发很多种方式，微信、qq、email、短信等等，也可以发很多类型，日常、紧急等的。这时我们可以把发送的的方法做抽象，把类型做实现。&lt;/p&gt;
&lt;h3 id="代码实现-1"&gt;代码实现&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;package&lt;/span&gt; &lt;span style="color:#75af00"&gt;main&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;import&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;fmt&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;type&lt;/span&gt; &lt;span style="color:#75af00"&gt;Message&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;interface&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;SendMessage&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;s&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;string&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;error&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;type&lt;/span&gt; &lt;span style="color:#75af00"&gt;MessageMethod&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;interface&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;Send&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;string&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;error&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;type&lt;/span&gt; &lt;span style="color:#75af00"&gt;qq&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;struct&lt;/span&gt;&lt;span style="color:#111"&gt;{}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;qq&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75af00"&gt;Send&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;s&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;string&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;error&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;send qq:&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;s&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;type&lt;/span&gt; &lt;span style="color:#75af00"&gt;weixin&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;struct&lt;/span&gt;&lt;span style="color:#111"&gt;{}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;weixin&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75af00"&gt;Send&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;s&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;string&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;error&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;send weixin:&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;s&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;type&lt;/span&gt; &lt;span style="color:#75af00"&gt;email&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;struct&lt;/span&gt;&lt;span style="color:#111"&gt;{}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;email&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75af00"&gt;Send&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;s&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;string&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;error&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;send email:&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;s&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;type&lt;/span&gt; &lt;span style="color:#75af00"&gt;InfoMessage&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;struct&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;method&lt;/span&gt; &lt;span style="color:#75af00"&gt;MessageMethod&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;i&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;InfoMessage&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75af00"&gt;SendMessage&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;s&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;string&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;error&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;s&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;info message: &amp;#34;&lt;/span&gt; &lt;span style="color:#f92672"&gt;+&lt;/span&gt; &lt;span style="color:#75af00"&gt;s&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt; &lt;span style="color:#75af00"&gt;i&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;method&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Send&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;s&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;type&lt;/span&gt; &lt;span style="color:#75af00"&gt;UrgencyMessage&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;struct&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;method&lt;/span&gt; &lt;span style="color:#75af00"&gt;MessageMethod&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;u&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;UrgencyMessage&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75af00"&gt;SendMessage&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;s&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;string&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;error&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;s&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;urgency message: &amp;#34;&lt;/span&gt; &lt;span style="color:#f92672"&gt;+&lt;/span&gt; &lt;span style="color:#75af00"&gt;s&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt; &lt;span style="color:#75af00"&gt;u&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;method&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Send&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;s&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;main&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;qq&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#111"&gt;new&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;qq&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;weixin&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#111"&gt;new&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;weixin&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;email&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#111"&gt;new&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;email&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;info&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#111"&gt;new&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;InfoMessage&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;info&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;method&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#75af00"&gt;qq&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;info&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;SendMessage&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;hello&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;info&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;method&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#75af00"&gt;weixin&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;info&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;SendMessage&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;hello&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;info&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;method&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#75af00"&gt;email&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;info&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;SendMessage&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;hello&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;urgency&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#111"&gt;new&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;UrgencyMessage&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;urgency&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;method&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#75af00"&gt;qq&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;urgency&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;SendMessage&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;hello&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;urgency&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;method&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#75af00"&gt;weixin&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;urgency&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;SendMessage&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;hello&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;urgency&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;method&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#75af00"&gt;email&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;urgency&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;SendMessage&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;hello&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;/*
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;send qq: info message: hello
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;send weixin: info message: hello
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;send email: info message: hello
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;send qq: urgency message: hello
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;send weixin: urgency message: hello
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;send email: urgency message: hello
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;*/&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id="装饰器模式"&gt;装饰器模式&lt;/h2&gt;
&lt;p&gt;装饰模式使用对象组合的方式动态改变或增加对象行为。Go语言借助于匿名组合和非入侵式接口可以很方便实现装饰模式。使用匿名组合，在装饰器中不必显式定义转调原对象方法。&lt;/p&gt;</description><content:encoded><![CDATA[<h2 id="适配器模式">适配器模式</h2>
<p>适配器模式用于转换一种接口适配另一种接口。比如，现在有个借口是对<code>json</code>字符串进行分析等，现在有一些<code>yaml</code>文件也要分析，这时候我我们就应该给<code>yaml</code>字符串就个适配器，转换成<code>json</code>字符串，然后就行分析。</p>
<h3 id="代码实现">代码实现</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;github.com/ghodss/yaml&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Analysis</span> <span style="color:#00a8c8">interface</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Analyze</span><span style="color:#111">(</span><span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">JsonAnalysis</span> <span style="color:#00a8c8">struct</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">JsonAnalysis</span><span style="color:#111">)</span> <span style="color:#75af00">Analyze</span><span style="color:#111">(</span><span style="color:#75af00">jsonStr</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 函数逻辑</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">jsonStr</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">yamlAnalysis</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ja</span> <span style="color:#f92672">*</span><span style="color:#75af00">JsonAnalysis</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">y</span> <span style="color:#f92672">*</span><span style="color:#75af00">yamlAnalysis</span><span style="color:#111">)</span> <span style="color:#75af00">Analyze</span><span style="color:#111">(</span><span style="color:#75af00">yamlStr</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">bs</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">yaml</span><span style="color:#111">.</span><span style="color:#75af00">YAMLToJSON</span><span style="color:#111">([]</span><span style="color:#111">byte</span><span style="color:#111">(</span><span style="color:#75af00">yamlStr</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">y</span><span style="color:#111">.</span><span style="color:#75af00">ja</span><span style="color:#111">.</span><span style="color:#75af00">Analyze</span><span style="color:#111">(</span><span style="color:#111">string</span><span style="color:#111">(</span><span style="color:#75af00">bs</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ja</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">JsonAnalysis</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">ja</span><span style="color:#111">.</span><span style="color:#75af00">Analyze</span><span style="color:#111">(</span><span style="color:#d88200">&#34;{\&#34;name\&#34;:\&#34;zhy\&#34;,\&#34;age\&#34;:18}&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ya</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">yamlAnalysis</span><span style="color:#111">{</span><span style="color:#75af00">ja</span><span style="color:#111">:</span> <span style="color:#75af00">ja</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">ya</span><span style="color:#111">.</span><span style="color:#75af00">Analyze</span><span style="color:#111">(</span><span style="color:#d88200">&#34;name: you\nage: 88&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">{&#34;name&#34;:&#34;zhy&#34;,&#34;age&#34;:18}
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">{&#34;age&#34;:88,&#34;name&#34;:&#34;you&#34;}
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span></code></pre></div><h2 id="桥接模式">桥接模式</h2>
<p>桥接模式分离抽象部分和实现部分。使得两部分独立扩展。</p>
<p>桥接模式类似于策略模式，区别在于策略模式封装一系列算法使得算法可以互相替换。</p>
<p>策略模式使抽象部分和实现部分分离，可以独立变化。</p>
<p>比如要发消息，可以发很多种方式，微信、qq、email、短信等等，也可以发很多类型，日常、紧急等的。这时我们可以把发送的的方法做抽象，把类型做实现。</p>
<h3 id="代码实现-1">代码实现</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Message</span> <span style="color:#00a8c8">interface</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">SendMessage</span><span style="color:#111">(</span><span style="color:#75af00">s</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">MessageMethod</span> <span style="color:#00a8c8">interface</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Send</span><span style="color:#111">(</span><span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">qq</span> <span style="color:#00a8c8">struct</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">qq</span><span style="color:#111">)</span> <span style="color:#75af00">Send</span><span style="color:#111">(</span><span style="color:#75af00">s</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;send qq:&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">s</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">weixin</span> <span style="color:#00a8c8">struct</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">weixin</span><span style="color:#111">)</span> <span style="color:#75af00">Send</span><span style="color:#111">(</span><span style="color:#75af00">s</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;send weixin:&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">s</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">email</span> <span style="color:#00a8c8">struct</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">email</span><span style="color:#111">)</span> <span style="color:#75af00">Send</span><span style="color:#111">(</span><span style="color:#75af00">s</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;send email:&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">s</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">InfoMessage</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">method</span> <span style="color:#75af00">MessageMethod</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">i</span> <span style="color:#f92672">*</span><span style="color:#75af00">InfoMessage</span><span style="color:#111">)</span> <span style="color:#75af00">SendMessage</span><span style="color:#111">(</span><span style="color:#75af00">s</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">s</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;info message: &#34;</span> <span style="color:#f92672">+</span> <span style="color:#75af00">s</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">i</span><span style="color:#111">.</span><span style="color:#75af00">method</span><span style="color:#111">.</span><span style="color:#75af00">Send</span><span style="color:#111">(</span><span style="color:#75af00">s</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">UrgencyMessage</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">method</span> <span style="color:#75af00">MessageMethod</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">u</span> <span style="color:#f92672">*</span><span style="color:#75af00">UrgencyMessage</span><span style="color:#111">)</span> <span style="color:#75af00">SendMessage</span><span style="color:#111">(</span><span style="color:#75af00">s</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">s</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;urgency message: &#34;</span> <span style="color:#f92672">+</span> <span style="color:#75af00">s</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">u</span><span style="color:#111">.</span><span style="color:#75af00">method</span><span style="color:#111">.</span><span style="color:#75af00">Send</span><span style="color:#111">(</span><span style="color:#75af00">s</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">qq</span> <span style="color:#f92672">:=</span> <span style="color:#111">new</span><span style="color:#111">(</span><span style="color:#75af00">qq</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">weixin</span> <span style="color:#f92672">:=</span> <span style="color:#111">new</span><span style="color:#111">(</span><span style="color:#75af00">weixin</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">email</span> <span style="color:#f92672">:=</span> <span style="color:#111">new</span><span style="color:#111">(</span><span style="color:#75af00">email</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">info</span> <span style="color:#f92672">:=</span> <span style="color:#111">new</span><span style="color:#111">(</span><span style="color:#75af00">InfoMessage</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">info</span><span style="color:#111">.</span><span style="color:#75af00">method</span> <span style="color:#111">=</span> <span style="color:#75af00">qq</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">info</span><span style="color:#111">.</span><span style="color:#75af00">SendMessage</span><span style="color:#111">(</span><span style="color:#d88200">&#34;hello&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">info</span><span style="color:#111">.</span><span style="color:#75af00">method</span> <span style="color:#111">=</span> <span style="color:#75af00">weixin</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">info</span><span style="color:#111">.</span><span style="color:#75af00">SendMessage</span><span style="color:#111">(</span><span style="color:#d88200">&#34;hello&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">info</span><span style="color:#111">.</span><span style="color:#75af00">method</span> <span style="color:#111">=</span> <span style="color:#75af00">email</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">info</span><span style="color:#111">.</span><span style="color:#75af00">SendMessage</span><span style="color:#111">(</span><span style="color:#d88200">&#34;hello&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">urgency</span> <span style="color:#f92672">:=</span> <span style="color:#111">new</span><span style="color:#111">(</span><span style="color:#75af00">UrgencyMessage</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">urgency</span><span style="color:#111">.</span><span style="color:#75af00">method</span> <span style="color:#111">=</span> <span style="color:#75af00">qq</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">urgency</span><span style="color:#111">.</span><span style="color:#75af00">SendMessage</span><span style="color:#111">(</span><span style="color:#d88200">&#34;hello&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">urgency</span><span style="color:#111">.</span><span style="color:#75af00">method</span> <span style="color:#111">=</span> <span style="color:#75af00">weixin</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">urgency</span><span style="color:#111">.</span><span style="color:#75af00">SendMessage</span><span style="color:#111">(</span><span style="color:#d88200">&#34;hello&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">urgency</span><span style="color:#111">.</span><span style="color:#75af00">method</span> <span style="color:#111">=</span> <span style="color:#75af00">email</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">urgency</span><span style="color:#111">.</span><span style="color:#75af00">SendMessage</span><span style="color:#111">(</span><span style="color:#d88200">&#34;hello&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">send qq: info message: hello
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">send weixin: info message: hello
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">send email: info message: hello
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">send qq: urgency message: hello
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">send weixin: urgency message: hello
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">send email: urgency message: hello
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span></code></pre></div><h2 id="装饰器模式">装饰器模式</h2>
<p>装饰模式使用对象组合的方式动态改变或增加对象行为。Go语言借助于匿名组合和非入侵式接口可以很方便实现装饰模式。使用匿名组合，在装饰器中不必显式定义转调原对象方法。</p>
<h3 id="代码实现-2">代码实现</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Component</span> <span style="color:#00a8c8">interface</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Calc</span><span style="color:#111">()</span> <span style="color:#00a8c8">int</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">ConcreteComponent</span> <span style="color:#00a8c8">struct</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">ConcreteComponent</span><span style="color:#111">)</span> <span style="color:#75af00">Calc</span><span style="color:#111">()</span> <span style="color:#00a8c8">int</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">MulDecorator</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Component</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">num</span> <span style="color:#00a8c8">int</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">WarpMulDecorator</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#75af00">Component</span><span style="color:#111">,</span> <span style="color:#75af00">num</span> <span style="color:#00a8c8">int</span><span style="color:#111">)</span> <span style="color:#75af00">Component</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">MulDecorator</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">Component</span><span style="color:#111">:</span> <span style="color:#75af00">c</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">num</span><span style="color:#111">:</span>       <span style="color:#75af00">num</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">d</span> <span style="color:#f92672">*</span><span style="color:#75af00">MulDecorator</span><span style="color:#111">)</span> <span style="color:#75af00">Calc</span><span style="color:#111">()</span> <span style="color:#00a8c8">int</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">d</span><span style="color:#111">.</span><span style="color:#75af00">Component</span><span style="color:#111">.</span><span style="color:#75af00">Calc</span><span style="color:#111">()</span> <span style="color:#f92672">*</span> <span style="color:#75af00">d</span><span style="color:#111">.</span><span style="color:#75af00">num</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">AddDecorator</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Component</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">num</span> <span style="color:#00a8c8">int</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">WarpAddDecorator</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#75af00">Component</span><span style="color:#111">,</span> <span style="color:#75af00">num</span> <span style="color:#00a8c8">int</span><span style="color:#111">)</span> <span style="color:#75af00">Component</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">AddDecorator</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">Component</span><span style="color:#111">:</span> <span style="color:#75af00">c</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">num</span><span style="color:#111">:</span>       <span style="color:#75af00">num</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">d</span> <span style="color:#f92672">*</span><span style="color:#75af00">AddDecorator</span><span style="color:#111">)</span> <span style="color:#75af00">Calc</span><span style="color:#111">()</span> <span style="color:#00a8c8">int</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">d</span><span style="color:#111">.</span><span style="color:#75af00">Component</span><span style="color:#111">.</span><span style="color:#75af00">Calc</span><span style="color:#111">()</span> <span style="color:#f92672">+</span> <span style="color:#75af00">d</span><span style="color:#111">.</span><span style="color:#75af00">num</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">c</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">ConcreteComponent</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">md</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">WarpMulDecorator</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">,</span> <span style="color:#ae81ff">2</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ad</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">WarpAddDecorator</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">,</span> <span style="color:#ae81ff">3</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">md</span><span style="color:#111">.</span><span style="color:#75af00">Calc</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">ad</span><span style="color:#111">.</span><span style="color:#75af00">Calc</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">20
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">13
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span></code></pre></div><h2 id="代理模式">代理模式</h2>
<p>代理模式用于延迟处理操作或者在进行实际操作前后进行其它处理。比如在限流中间件中</p>
<h3 id="代码实现-3">代码实现</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;errors&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;sync&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Serve</span> <span style="color:#00a8c8">interface</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">handle</span><span style="color:#111">(</span><span style="color:#75af00">name</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#00a8c8">string</span><span style="color:#111">,</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">server</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">lock</span>              <span style="color:#75af00">sync</span><span style="color:#111">.</span><span style="color:#75af00">RWMutex</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">serve</span>             <span style="color:#75af00">Serve</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">maxAllowedRequest</span> <span style="color:#00a8c8">int</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">rateLimiter</span>       <span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#00a8c8">string</span><span style="color:#111">]</span><span style="color:#00a8c8">int</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">s</span> <span style="color:#f92672">*</span><span style="color:#75af00">server</span><span style="color:#111">)</span> <span style="color:#75af00">getService</span><span style="color:#111">(</span><span style="color:#75af00">name</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#00a8c8">string</span><span style="color:#111">,</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">lock</span><span style="color:#111">.</span><span style="color:#75af00">RLock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">nowNumber</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">rateLimiter</span><span style="color:#111">[</span><span style="color:#75af00">name</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">lock</span><span style="color:#111">.</span><span style="color:#75af00">RUnlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">nowNumber</span> <span style="color:#f92672">&gt;=</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">maxAllowedRequest</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#d88200">&#34;&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">errors</span><span style="color:#111">.</span><span style="color:#75af00">New</span><span style="color:#111">(</span><span style="color:#d88200">&#34;rate limit&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 更新计数器</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">lock</span><span style="color:#111">.</span><span style="color:#75af00">Lock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">rateLimiter</span><span style="color:#111">[</span><span style="color:#75af00">name</span><span style="color:#111">]</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">lock</span><span style="color:#111">.</span><span style="color:#75af00">Unlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">str</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">serve</span><span style="color:#111">.</span><span style="color:#75af00">handle</span><span style="color:#111">(</span><span style="color:#75af00">name</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 执行后减少计数器</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">lock</span><span style="color:#111">.</span><span style="color:#75af00">Lock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">rateLimiter</span><span style="color:#111">[</span><span style="color:#75af00">name</span><span style="color:#111">]</span><span style="color:#f92672">--</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">lock</span><span style="color:#111">.</span><span style="color:#75af00">Unlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#d88200">&#34;&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">str</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">hand</span> <span style="color:#00a8c8">struct</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">h</span> <span style="color:#f92672">*</span><span style="color:#75af00">hand</span><span style="color:#111">)</span> <span style="color:#75af00">handle</span><span style="color:#111">(</span><span style="color:#75af00">name</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#00a8c8">string</span><span style="color:#111">,</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Sleep</span><span style="color:#111">(</span><span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Microsecond</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">500</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Sprintf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;hello %s&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">name</span><span style="color:#111">),</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">wg</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">sync</span><span style="color:#111">.</span><span style="color:#75af00">WaitGroup</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">wg</span><span style="color:#111">.</span><span style="color:#75af00">Add</span><span style="color:#111">(</span><span style="color:#ae81ff">20</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">s</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">server</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">serve</span><span style="color:#111">:</span>             <span style="color:#f92672">&amp;</span><span style="color:#75af00">hand</span><span style="color:#111">{},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">maxAllowedRequest</span><span style="color:#111">:</span> <span style="color:#ae81ff">10</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">rateLimiter</span><span style="color:#111">:</span>       <span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#00a8c8">string</span><span style="color:#111">]</span><span style="color:#00a8c8">int</span><span style="color:#111">{},</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span><span style="color:#111">;</span> <span style="color:#75af00">i</span> <span style="color:#111">&lt;</span> <span style="color:#ae81ff">20</span><span style="color:#111">;</span> <span style="color:#75af00">i</span><span style="color:#f92672">++</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">go</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">i</span> <span style="color:#00a8c8">int</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">defer</span> <span style="color:#75af00">wg</span><span style="color:#111">.</span><span style="color:#75af00">Done</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">res</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">getService</span><span style="color:#111">(</span><span style="color:#d88200">&#34;world&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">i</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;error:&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">i</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;success:&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">res</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}(</span><span style="color:#75af00">i</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">wg</span><span style="color:#111">.</span><span style="color:#75af00">Wait</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">15 error: rate limit
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">18 error: rate limit
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">10 error: rate limit
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">4 error: rate limit
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">7 error: rate limit
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">6 error: rate limit
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">16 error: rate limit
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">9 error: rate limit
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">11 error: rate limit
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">17 error: rate limit
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">14 success: hello world
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">19 success: hello world
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">13 success: hello world
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">2 success: hello world
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">12 success: hello world
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">1 success: hello world
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">3 success: hello world
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">8 success: hello world
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">5 success: hello world
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">0 success: hello world
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span></code></pre></div><h2 id="组合模式">组合模式</h2>
<p>组合模式统一对象和对象集，使得使用相同接口使用对象和对象集。</p>
<p>组合模式常用于树状结构，用于统一叶子节点和树节点的访问，并且可以用于应用某一操作到所有子节点。</p>
<p>比如要搜索文件夹下的所有文件名</p>
<h3 id="代码实现-4">代码实现</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">component</span> <span style="color:#00a8c8">interface</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">search</span><span style="color:#111">(</span><span style="color:#00a8c8">string</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">file</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">name</span> <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">f</span> <span style="color:#f92672">*</span><span style="color:#75af00">file</span><span style="color:#111">)</span> <span style="color:#75af00">search</span><span style="color:#111">(</span><span style="color:#75af00">keyword</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Searching for keyword %s in file %s\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">keyword</span><span style="color:#111">,</span> <span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">name</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">f</span> <span style="color:#f92672">*</span><span style="color:#75af00">file</span><span style="color:#111">)</span> <span style="color:#75af00">getName</span><span style="color:#111">()</span> <span style="color:#00a8c8">string</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">name</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">folder</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">components</span> <span style="color:#111">[]</span><span style="color:#75af00">component</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">name</span>       <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">f</span> <span style="color:#f92672">*</span><span style="color:#75af00">folder</span><span style="color:#111">)</span> <span style="color:#75af00">search</span><span style="color:#111">(</span><span style="color:#75af00">keyword</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Serching recursively for keyword %s in folder %s\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">keyword</span><span style="color:#111">,</span> <span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">name</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">composite</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">components</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">composite</span><span style="color:#111">.</span><span style="color:#75af00">search</span><span style="color:#111">(</span><span style="color:#75af00">keyword</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">f</span> <span style="color:#f92672">*</span><span style="color:#75af00">folder</span><span style="color:#111">)</span> <span style="color:#75af00">add</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#75af00">component</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">components</span> <span style="color:#111">=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">components</span><span style="color:#111">,</span> <span style="color:#75af00">c</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">file1</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">file</span><span style="color:#111">{</span><span style="color:#75af00">name</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;File1&#34;</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">file2</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">file</span><span style="color:#111">{</span><span style="color:#75af00">name</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;File2&#34;</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">file3</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">file</span><span style="color:#111">{</span><span style="color:#75af00">name</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;File3&#34;</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">folder1</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">folder</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">name</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;Folder1&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">folder1</span><span style="color:#111">.</span><span style="color:#75af00">add</span><span style="color:#111">(</span><span style="color:#75af00">file1</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">folder2</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">folder</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">name</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;Folder2&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">folder2</span><span style="color:#111">.</span><span style="color:#75af00">add</span><span style="color:#111">(</span><span style="color:#75af00">file2</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">folder2</span><span style="color:#111">.</span><span style="color:#75af00">add</span><span style="color:#111">(</span><span style="color:#75af00">file3</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">folder2</span><span style="color:#111">.</span><span style="color:#75af00">add</span><span style="color:#111">(</span><span style="color:#75af00">folder1</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">folder2</span><span style="color:#111">.</span><span style="color:#75af00">search</span><span style="color:#111">(</span><span style="color:#d88200">&#34;rose&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">Serching recursively for keyword rose in folder Folder2
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">Searching for keyword rose in file File2
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">Searching for keyword rose in file File3
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">Serching recursively for keyword rose in folder Folder1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">Searching for keyword rose in file File1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span></code></pre></div><h2 id="外观模式">外观模式</h2>
<p>API 为facade 模块的外观接口，大部分代码使用此接口简化对facade类的访问。</p>
<p>facade模块同时暴露了a和b 两个Module 的NewXXX和interface，其它代码如果需要使用细节功能时可以直接调用。</p>
<h3 id="代码实现-5">代码实现</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">NewAPI</span><span style="color:#111">()</span> <span style="color:#75af00">API</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">apiImpl</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">a</span><span style="color:#111">:</span> <span style="color:#75af00">NewAModuleAPI</span><span style="color:#111">(),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">b</span><span style="color:#111">:</span> <span style="color:#75af00">NewBModuleAPI</span><span style="color:#111">(),</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//API is facade interface of facade package</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">API</span> <span style="color:#00a8c8">interface</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Test</span><span style="color:#111">()</span> <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//facade implement</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">apiImpl</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">a</span> <span style="color:#75af00">AModuleAPI</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">b</span> <span style="color:#75af00">BModuleAPI</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">a</span> <span style="color:#f92672">*</span><span style="color:#75af00">apiImpl</span><span style="color:#111">)</span> <span style="color:#75af00">Test</span><span style="color:#111">()</span> <span style="color:#00a8c8">string</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">aRet</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">a</span><span style="color:#111">.</span><span style="color:#75af00">a</span><span style="color:#111">.</span><span style="color:#75af00">TestA</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">bRet</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">a</span><span style="color:#111">.</span><span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">TestB</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Sprintf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;%s\n%s&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">aRet</span><span style="color:#111">,</span> <span style="color:#75af00">bRet</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//NewAModuleAPI return new AModuleAPI</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">NewAModuleAPI</span><span style="color:#111">()</span> <span style="color:#75af00">AModuleAPI</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">aModuleImpl</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//AModuleAPI ...</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">AModuleAPI</span> <span style="color:#00a8c8">interface</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">TestA</span><span style="color:#111">()</span> <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">aModuleImpl</span> <span style="color:#00a8c8">struct</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">aModuleImpl</span><span style="color:#111">)</span> <span style="color:#75af00">TestA</span><span style="color:#111">()</span> <span style="color:#00a8c8">string</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#d88200">&#34;A module running&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//NewBModuleAPI return new BModuleAPI</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">NewBModuleAPI</span><span style="color:#111">()</span> <span style="color:#75af00">BModuleAPI</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">bModuleImpl</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//BModuleAPI ...</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">BModuleAPI</span> <span style="color:#00a8c8">interface</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">TestB</span><span style="color:#111">()</span> <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">bModuleImpl</span> <span style="color:#00a8c8">struct</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">bModuleImpl</span><span style="color:#111">)</span> <span style="color:#75af00">TestB</span><span style="color:#111">()</span> <span style="color:#00a8c8">string</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#d88200">&#34;B module running&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">api</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">NewAPI</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">api</span><span style="color:#111">.</span><span style="color:#75af00">Test</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">A module running
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">B module running
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span></code></pre></div><h2 id="享元模式">享元模式</h2>
<p>享元模式从对象中剥离出不发生改变且多个实例需要的重复数据，独立出一个享元，使多个对象共享，从而节省内存以及减少对象数量。</p>
<h3 id="代码实现-6">代码实现</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">ImageFlyweightFactory</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">maps</span> <span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#00a8c8">string</span><span style="color:#111">]</span><span style="color:#f92672">*</span><span style="color:#75af00">ImageFlyweight</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">var</span> <span style="color:#75af00">imageFactory</span> <span style="color:#f92672">*</span><span style="color:#75af00">ImageFlyweightFactory</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">GetImageFlyweightFactory</span><span style="color:#111">()</span> <span style="color:#f92672">*</span><span style="color:#75af00">ImageFlyweightFactory</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">imageFactory</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">imageFactory</span> <span style="color:#111">=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">ImageFlyweightFactory</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">maps</span><span style="color:#111">:</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#00a8c8">string</span><span style="color:#111">]</span><span style="color:#f92672">*</span><span style="color:#75af00">ImageFlyweight</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">imageFactory</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">f</span> <span style="color:#f92672">*</span><span style="color:#75af00">ImageFlyweightFactory</span><span style="color:#111">)</span> <span style="color:#75af00">Get</span><span style="color:#111">(</span><span style="color:#75af00">filename</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#f92672">*</span><span style="color:#75af00">ImageFlyweight</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">image</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">maps</span><span style="color:#111">[</span><span style="color:#75af00">filename</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">image</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">image</span> <span style="color:#111">=</span> <span style="color:#75af00">NewImageFlyweight</span><span style="color:#111">(</span><span style="color:#75af00">filename</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">maps</span><span style="color:#111">[</span><span style="color:#75af00">filename</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#75af00">image</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">image</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">ImageFlyweight</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">data</span> <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">NewImageFlyweight</span><span style="color:#111">(</span><span style="color:#75af00">filename</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#f92672">*</span><span style="color:#75af00">ImageFlyweight</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Load image file</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">data</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Sprintf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;image data %s&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">filename</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">ImageFlyweight</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">data</span><span style="color:#111">:</span> <span style="color:#75af00">data</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">i</span> <span style="color:#f92672">*</span><span style="color:#75af00">ImageFlyweight</span><span style="color:#111">)</span> <span style="color:#75af00">Data</span><span style="color:#111">()</span> <span style="color:#00a8c8">string</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">i</span><span style="color:#111">.</span><span style="color:#75af00">data</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">ImageViewer</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">*</span><span style="color:#75af00">ImageFlyweight</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">NewImageViewer</span><span style="color:#111">(</span><span style="color:#75af00">filename</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#f92672">*</span><span style="color:#75af00">ImageViewer</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">image</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">GetImageFlyweightFactory</span><span style="color:#111">().</span><span style="color:#75af00">Get</span><span style="color:#111">(</span><span style="color:#75af00">filename</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">ImageViewer</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">ImageFlyweight</span><span style="color:#111">:</span> <span style="color:#75af00">image</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">i</span> <span style="color:#f92672">*</span><span style="color:#75af00">ImageViewer</span><span style="color:#111">)</span> <span style="color:#75af00">Display</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Display: %s\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">i</span><span style="color:#111">.</span><span style="color:#75af00">Data</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="references">References</h2>
<p><a href="https://github.com/senghoo/golang-design-pattern">https://github.com/senghoo/golang-design-pattern</a></p>
<p><a href="https://refactoringguru.cn/design-patterns">https://refactoringguru.cn/design-patterns</a></p>
<p><a href="https://lailin.xyz/post/singleton.html">https://lailin.xyz/post/singleton.html</a></p>
]]></content:encoded><category>go</category><category>go</category><category>设计模式</category></item><item><title>创建者模式</title><link>https://daemon365.dev/post/go/creator_mode/</link><pubDate>Sat, 23 Sep 2023 00:00:00 +0800</pubDate><guid>https://daemon365.dev/post/go/creator_mode/</guid><description>&lt;h2 id="单例模式"&gt;单例模式&lt;/h2&gt;
&lt;h3 id="为什么要用单例模式"&gt;为什么要用单例模式&lt;/h3&gt;
&lt;p&gt;&lt;strong&gt;保证一个对象只有一个实例&lt;/strong&gt; ，减少内存开销。比如一些可以复用一个连接的网络，比如&lt;code&gt;http2 client&lt;/code&gt;等，而且可以减少网络开销。&lt;/p&gt;
&lt;h3 id="为什么不用个全局变量控制"&gt;为什么不用个全局变量控制&lt;/h3&gt;
&lt;p&gt;因为任何代码都有可能覆盖掉那些变量的内容， 从而引发程序崩溃。&lt;/p&gt;
&lt;h3 id="代码实现"&gt;代码实现&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;package&lt;/span&gt; &lt;span style="color:#75af00"&gt;main&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;import&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;fmt&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;sync&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;type&lt;/span&gt; &lt;span style="color:#75af00"&gt;Single&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;struct&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;var&lt;/span&gt; &lt;span style="color:#75af00"&gt;single&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;Single&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;var&lt;/span&gt; &lt;span style="color:#75af00"&gt;once&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#f92672"&gt;&amp;amp;&lt;/span&gt;&lt;span style="color:#75af00"&gt;sync&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Once&lt;/span&gt;&lt;span style="color:#111"&gt;{}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;NewSingle&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;Single&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;once&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Do&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;single&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#f92672"&gt;&amp;amp;&lt;/span&gt;&lt;span style="color:#75af00"&gt;Single&lt;/span&gt;&lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// 初始化&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;})&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt; &lt;span style="color:#75af00"&gt;single&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;main&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;for&lt;/span&gt; &lt;span style="color:#75af00"&gt;i&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;0&lt;/span&gt;&lt;span style="color:#111"&gt;;&lt;/span&gt; &lt;span style="color:#75af00"&gt;i&lt;/span&gt; &lt;span style="color:#111"&gt;&amp;lt;&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;1000&lt;/span&gt;&lt;span style="color:#111"&gt;;&lt;/span&gt; &lt;span style="color:#75af00"&gt;i&lt;/span&gt;&lt;span style="color:#f92672"&gt;++&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;s&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;NewSingle&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Printf&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;create %d,address %p\n&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;i&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;s&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;/*
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;结果：
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;create 0,address 0x1164fe0
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;create 1,address 0x1164fe0
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;create 2,address 0x1164fe0
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;create 3,address 0x1164fe0
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;create 4,address 0x1164fe0
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;create 5,address 0x1164fe0
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;create 6,address 0x1164fe0
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;create 7,address 0x1164fe0
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;create 8,address 0x1164fe0
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;...
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;*/&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id="工厂模式"&gt;工厂模式&lt;/h2&gt;
&lt;p&gt;我们在创建对象时不会对客户端暴露创建逻辑，并且是通过使用一个共同的接口来指向新创建的对象。比如电脑支持&lt;code&gt;intel cpu&lt;/code&gt;，现在要支持&lt;code&gt;amd cpu&lt;/code&gt;，我们就可以让所有&lt;code&gt;cpu&lt;/code&gt;实现接口。&lt;/p&gt;</description><content:encoded><![CDATA[<h2 id="单例模式">单例模式</h2>
<h3 id="为什么要用单例模式">为什么要用单例模式</h3>
<p><strong>保证一个对象只有一个实例</strong> ，减少内存开销。比如一些可以复用一个连接的网络，比如<code>http2 client</code>等，而且可以减少网络开销。</p>
<h3 id="为什么不用个全局变量控制">为什么不用个全局变量控制</h3>
<p>因为任何代码都有可能覆盖掉那些变量的内容， 从而引发程序崩溃。</p>
<h3 id="代码实现">代码实现</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;sync&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Single</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">var</span> <span style="color:#75af00">single</span> <span style="color:#f92672">*</span><span style="color:#75af00">Single</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">var</span> <span style="color:#75af00">once</span> <span style="color:#111">=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">sync</span><span style="color:#111">.</span><span style="color:#75af00">Once</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">NewSingle</span><span style="color:#111">()</span> <span style="color:#f92672">*</span><span style="color:#75af00">Single</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">once</span><span style="color:#111">.</span><span style="color:#75af00">Do</span><span style="color:#111">(</span><span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">single</span> <span style="color:#111">=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">Single</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 初始化</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">single</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span><span style="color:#111">;</span> <span style="color:#75af00">i</span> <span style="color:#111">&lt;</span> <span style="color:#ae81ff">1000</span><span style="color:#111">;</span> <span style="color:#75af00">i</span><span style="color:#f92672">++</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">s</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">NewSingle</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;create %d,address %p\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">i</span><span style="color:#111">,</span> <span style="color:#75af00">s</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">结果：
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">create 0,address 0x1164fe0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">create 1,address 0x1164fe0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">create 2,address 0x1164fe0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">create 3,address 0x1164fe0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">create 4,address 0x1164fe0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">create 5,address 0x1164fe0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">create 6,address 0x1164fe0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">create 7,address 0x1164fe0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">create 8,address 0x1164fe0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span></code></pre></div><h2 id="工厂模式">工厂模式</h2>
<p>我们在创建对象时不会对客户端暴露创建逻辑，并且是通过使用一个共同的接口来指向新创建的对象。比如电脑支持<code>intel cpu</code>，现在要支持<code>amd cpu</code>，我们就可以让所有<code>cpu</code>实现接口。</p>
<h3 id="简单工厂模式">简单工厂模式</h3>
<p>实现简单，不适合复杂场景</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;errors&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 工厂接口</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">CpuFactory</span> <span style="color:#00a8c8">interface</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Run</span><span style="color:#111">()</span> <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">IntelCpu</span> <span style="color:#00a8c8">struct</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">IntelCpu</span><span style="color:#111">)</span> <span style="color:#75af00">Run</span><span style="color:#111">()</span> <span style="color:#00a8c8">string</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#d88200">&#34;intel cpu is running&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">AmdCpu</span> <span style="color:#00a8c8">struct</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">AmdCpu</span><span style="color:#111">)</span> <span style="color:#75af00">Run</span><span style="color:#111">()</span> <span style="color:#00a8c8">string</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#d88200">&#34;amd cpu is running&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">NewCpu</span><span style="color:#111">(</span><span style="color:#75af00">name</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#75af00">CpuFactory</span><span style="color:#111">,</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">switch</span> <span style="color:#75af00">name</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">case</span> <span style="color:#d88200">&#34;intel&#34;</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">IntelCpu</span><span style="color:#111">{},</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">case</span> <span style="color:#d88200">&#34;amd&#34;</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">AmdCpu</span><span style="color:#111">{},</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">default</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">errors</span><span style="color:#111">.</span><span style="color:#75af00">New</span><span style="color:#111">(</span><span style="color:#d88200">&#34;no such cpu&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">c1</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">NewCpu</span><span style="color:#111">(</span><span style="color:#d88200">&#34;intel&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">c1</span><span style="color:#111">.</span><span style="color:#75af00">Run</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">c2</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">NewCpu</span><span style="color:#111">(</span><span style="color:#d88200">&#34;amd&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">c2</span><span style="color:#111">.</span><span style="color:#75af00">Run</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">NewCpu</span><span style="color:#111">(</span><span style="color:#d88200">&#34;other&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">结果：
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">intel cpu is running
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">amd cpu is running
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">no such cpu
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span></code></pre></div><h3 id="工厂方法模式">工厂方法模式</h3>
<p>大部分时候，我们创建对象要创建很多逻辑，比如初始化变量，从远端请求<code>config</code>等等。这是我们需要每次<code>struct</code>提供个创建方法。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;errors&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 工厂接口</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">CpuFactory</span> <span style="color:#00a8c8">interface</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Run</span><span style="color:#111">()</span> <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">IntelCpu</span> <span style="color:#00a8c8">struct</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">IntelCpu</span><span style="color:#111">)</span> <span style="color:#75af00">Run</span><span style="color:#111">()</span> <span style="color:#00a8c8">string</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#d88200">&#34;intel cpu is running&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">NewIntelCpu</span><span style="color:#111">()</span> <span style="color:#f92672">*</span><span style="color:#75af00">IntelCpu</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 做创建逻辑</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">IntelCpu</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">AmdCpu</span> <span style="color:#00a8c8">struct</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">AmdCpu</span><span style="color:#111">)</span> <span style="color:#75af00">Run</span><span style="color:#111">()</span> <span style="color:#00a8c8">string</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#d88200">&#34;amd cpu is running&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">NewAmdCpu</span><span style="color:#111">()</span> <span style="color:#f92672">*</span><span style="color:#75af00">AmdCpu</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 做创建逻辑</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">AmdCpu</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">NewCpu</span><span style="color:#111">(</span><span style="color:#75af00">name</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#75af00">CpuFactory</span><span style="color:#111">,</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">switch</span> <span style="color:#75af00">name</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">case</span> <span style="color:#d88200">&#34;intel&#34;</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">NewIntelCpu</span><span style="color:#111">(),</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">case</span> <span style="color:#d88200">&#34;amd&#34;</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">NewAmdCpu</span><span style="color:#111">(),</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">default</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">errors</span><span style="color:#111">.</span><span style="color:#75af00">New</span><span style="color:#111">(</span><span style="color:#d88200">&#34;no such cpu&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">c1</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">NewCpu</span><span style="color:#111">(</span><span style="color:#d88200">&#34;intel&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">c1</span><span style="color:#111">.</span><span style="color:#75af00">Run</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">c2</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">NewCpu</span><span style="color:#111">(</span><span style="color:#d88200">&#34;amd&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">c2</span><span style="color:#111">.</span><span style="color:#75af00">Run</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">NewCpu</span><span style="color:#111">(</span><span style="color:#d88200">&#34;other&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">结果：
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">intel cpu is running
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">amd cpu is running
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">no such cpu
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span></code></pre></div><h3 id="抽象工厂模式">抽象工厂模式</h3>
<p>抽象工厂模式则是针对的多个产品等级结构， 我们可以将一种产品等级想象为一个产品族，所谓的产品族，是指位于不同产品等级结构中功能相关联的产品组成的家族。用于复杂场景，比如<code>amd</code>和<code>intel</code>都生成<code>cpu</code>和<code>gpu</code></p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 抽象工厂接口</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">ElementAbstractFactory</span> <span style="color:#00a8c8">interface</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">CreateCpu</span><span style="color:#111">()</span> <span style="color:#75af00">Cpu</span> <span style="color:#75715e">// cpu</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">CreateGpu</span><span style="color:#111">()</span> <span style="color:#75af00">Gpu</span> <span style="color:#75715e">// Gpu</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">GetElementAbstractFactory</span><span style="color:#111">(</span><span style="color:#75af00">brand</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#75af00">ElementAbstractFactory</span><span style="color:#111">,</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">brand</span> <span style="color:#f92672">==</span> <span style="color:#d88200">&#34;intel&#34;</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">intel</span><span style="color:#111">{},</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">brand</span> <span style="color:#f92672">==</span> <span style="color:#d88200">&#34;amd&#34;</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">amd</span><span style="color:#111">{},</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Wrong brand type passed&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// cpu 具体工厂</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Cpu</span> <span style="color:#00a8c8">interface</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Run</span><span style="color:#111">()</span> <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Gpu</span> <span style="color:#00a8c8">interface</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Graphics</span><span style="color:#111">()</span> <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">intel</span> <span style="color:#00a8c8">struct</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">intel</span><span style="color:#111">)</span> <span style="color:#75af00">CreateCpu</span><span style="color:#111">()</span> <span style="color:#75af00">Cpu</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">intelCpu</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">intel</span><span style="color:#111">)</span> <span style="color:#75af00">CreateGpu</span><span style="color:#111">()</span> <span style="color:#75af00">Gpu</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">intelGpu</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">intelCpu</span> <span style="color:#00a8c8">struct</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">intelCpu</span><span style="color:#111">)</span> <span style="color:#75af00">Run</span><span style="color:#111">()</span> <span style="color:#00a8c8">string</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#d88200">&#34;intel cpu is running&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">intelGpu</span> <span style="color:#00a8c8">struct</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">intelGpu</span><span style="color:#111">)</span> <span style="color:#75af00">Graphics</span><span style="color:#111">()</span> <span style="color:#00a8c8">string</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#d88200">&#34;intel gpu is working on graphics&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">amd</span> <span style="color:#00a8c8">struct</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">amd</span><span style="color:#111">)</span> <span style="color:#75af00">CreateCpu</span><span style="color:#111">()</span> <span style="color:#75af00">Cpu</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">amdCpu</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">amd</span><span style="color:#111">)</span> <span style="color:#75af00">CreateGpu</span><span style="color:#111">()</span> <span style="color:#75af00">Gpu</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">amdGpu</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">amdCpu</span> <span style="color:#00a8c8">struct</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">amdCpu</span><span style="color:#111">)</span> <span style="color:#75af00">Run</span><span style="color:#111">()</span> <span style="color:#00a8c8">string</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#d88200">&#34;amd cpu is running&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">amdGpu</span> <span style="color:#00a8c8">struct</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">amdGpu</span><span style="color:#111">)</span> <span style="color:#75af00">Graphics</span><span style="color:#111">()</span> <span style="color:#00a8c8">string</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#d88200">&#34;amd gpu is working on graphics&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">e</span><span style="color:#111">,</span> <span style="color:#75af00">_</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">GetElementAbstractFactory</span><span style="color:#111">(</span><span style="color:#d88200">&#34;intel&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">cpu</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">CreateCpu</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">gpu</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">CreateGpu</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">cpu</span><span style="color:#111">.</span><span style="color:#75af00">Run</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">gpu</span><span style="color:#111">.</span><span style="color:#75af00">Graphics</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">e2</span><span style="color:#111">,</span> <span style="color:#75af00">_</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">GetElementAbstractFactory</span><span style="color:#111">(</span><span style="color:#d88200">&#34;amd&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">cpu2</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">e2</span><span style="color:#111">.</span><span style="color:#75af00">CreateCpu</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">gpu2</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">e2</span><span style="color:#111">.</span><span style="color:#75af00">CreateGpu</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">cpu2</span><span style="color:#111">.</span><span style="color:#75af00">Run</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">gpu2</span><span style="color:#111">.</span><span style="color:#75af00">Graphics</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">intel cpu is running
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">intel gpu is working on graphics
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">amd cpu is running
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">amd gpu is working on graphics
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span></code></pre></div><h2 id="生成器模式">生成器模式</h2>
<p>在对其进行构造时需要对诸多成员变量和嵌套对象进行繁复的初始化工作。 这些初始化代码通常深藏于一个包含众多参数且让人基本看不懂的构造函数中； 甚至还有更糟糕的情况， 那就是这些代码散落在客户端代码的多个位置。比如在<code>go</code>中，就可以利用指针传递完成初始化。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Computer 是生成器接口</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Computer</span> <span style="color:#00a8c8">interface</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Cpu</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Gpu</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Director</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">builder</span> <span style="color:#75af00">Computer</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// NewDirector ...</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">NewDirector</span><span style="color:#111">(</span><span style="color:#75af00">builder</span> <span style="color:#75af00">Computer</span><span style="color:#111">)</span> <span style="color:#f92672">*</span><span style="color:#75af00">Director</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">Director</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">builder</span><span style="color:#111">:</span> <span style="color:#75af00">builder</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Construct Product</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">d</span> <span style="color:#f92672">*</span><span style="color:#75af00">Director</span><span style="color:#111">)</span> <span style="color:#75af00">Construct</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">d</span><span style="color:#111">.</span><span style="color:#75af00">builder</span><span style="color:#111">.</span><span style="color:#75af00">Cpu</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">d</span><span style="color:#111">.</span><span style="color:#75af00">builder</span><span style="color:#111">.</span><span style="color:#75af00">Gpu</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Computer1</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">cpu</span> <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">gpu</span> <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">Computer1</span><span style="color:#111">)</span> <span style="color:#75af00">Cpu</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">cpu</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;intel&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">Computer1</span><span style="color:#111">)</span> <span style="color:#75af00">Gpu</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">gpu</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;nvida&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Computer2</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">cpu</span> <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">gpu</span> <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">Computer2</span><span style="color:#111">)</span> <span style="color:#75af00">Cpu</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">cpu</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;amd&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">Computer2</span><span style="color:#111">)</span> <span style="color:#75af00">Gpu</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">gpu</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;amd&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">c1</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">Computer1</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">d</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">NewDirector</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">c1</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;%+v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">c1</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">d</span><span style="color:#111">.</span><span style="color:#75af00">Construct</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;%+v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">c1</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">c2</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">Computer2</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">d2</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">NewDirector</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">c2</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;%+v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">c2</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">d2</span><span style="color:#111">.</span><span style="color:#75af00">Construct</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;%+v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">c2</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">{cpu: gpu:}
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">{cpu:intel gpu:nvida}
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">{cpu: gpu:}
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">{cpu:amd gpu:amd}
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span></code></pre></div><h2 id="原型模式">原型模式</h2>
<p>原型模式使对象能复制自身，并且暴露到接口中，使客户端面向接口编程时，不知道接口实际对象的情况下生成新的对象。</p>
<p>原型模式配合原型管理器使用，使得客户端在不知道具体类的情况下，通过接口管理器得到新的实例，并且包含部分预设定配置。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//Cloneable 是原型对象需要实现的接口</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Cloneable</span> <span style="color:#00a8c8">interface</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Clone</span><span style="color:#111">()</span> <span style="color:#75af00">Cloneable</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">PrototypeManager</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">prototypes</span> <span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#00a8c8">string</span><span style="color:#111">]</span><span style="color:#75af00">Cloneable</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">NewPrototypeManager</span><span style="color:#111">()</span> <span style="color:#f92672">*</span><span style="color:#75af00">PrototypeManager</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">PrototypeManager</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">prototypes</span><span style="color:#111">:</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#00a8c8">string</span><span style="color:#111">]</span><span style="color:#75af00">Cloneable</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">p</span> <span style="color:#f92672">*</span><span style="color:#75af00">PrototypeManager</span><span style="color:#111">)</span> <span style="color:#75af00">Get</span><span style="color:#111">(</span><span style="color:#75af00">name</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#75af00">Cloneable</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">prototypes</span><span style="color:#111">[</span><span style="color:#75af00">name</span><span style="color:#111">].</span><span style="color:#75af00">Clone</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">p</span> <span style="color:#f92672">*</span><span style="color:#75af00">PrototypeManager</span><span style="color:#111">)</span> <span style="color:#75af00">Set</span><span style="color:#111">(</span><span style="color:#75af00">name</span> <span style="color:#00a8c8">string</span><span style="color:#111">,</span> <span style="color:#75af00">prototype</span> <span style="color:#75af00">Cloneable</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">prototypes</span><span style="color:#111">[</span><span style="color:#75af00">name</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#75af00">prototype</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="references">References</h2>
<p><a href="https://github.com/senghoo/golang-design-pattern">https://github.com/senghoo/golang-design-pattern</a></p>
<p><a href="https://refactoringguru.cn/design-patterns">https://refactoringguru.cn/design-patterns</a></p>
<p><a href="https://lailin.xyz/post/singleton.html">https://lailin.xyz/post/singleton.html</a></p>
]]></content:encoded><category>go</category><category>go</category><category>设计模式</category></item><item><title>golang操作etcd</title><link>https://daemon365.dev/post/go/golang_operates_etcd/</link><pubDate>Sun, 08 Jan 2023 20:56:00 +0800</pubDate><guid>https://daemon365.dev/post/go/golang_operates_etcd/</guid><description>&lt;p&gt;etcd是近几年比较火热的一个开源的、分布式的键值对数据存储系统，提供共享配置、服务的注册和发现，本文主要介绍etcd的安装和使用。&lt;/p&gt;
&lt;h2 id="etcd介绍"&gt;etcd介绍&lt;/h2&gt;
&lt;p&gt;&lt;a href="https://etcd.io/"&gt;etcd&lt;/a&gt;是使用Go语言开发的一个开源的、高可用的分布式key-value存储系统，可以用于配置共享和服务的注册和发现。&lt;/p&gt;
&lt;p&gt;类似项目有zookeeper和consul。&lt;/p&gt;
&lt;p&gt;etcd具有以下特点：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;完全复制：集群中的每个节点都可以使用完整的存档&lt;/li&gt;
&lt;li&gt;高可用性：Etcd可用于避免硬件的单点故障或网络问题&lt;/li&gt;
&lt;li&gt;一致性：每次读取都会返回跨多主机的最新写入&lt;/li&gt;
&lt;li&gt;简单：包括一个定义良好、面向用户的API（gRPC）&lt;/li&gt;
&lt;li&gt;安全：实现了带有可选的客户端证书身份验证的自动化TLS&lt;/li&gt;
&lt;li&gt;快速：每秒10000次写入的基准速度&lt;/li&gt;
&lt;li&gt;可靠：使用Raft算法实现了强一致、高可用的服务存储目录&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="etcd应用场景"&gt;etcd应用场景&lt;/h2&gt;
&lt;h3 id="服务发现"&gt;服务发现&lt;/h3&gt;
&lt;p&gt;服务发现要解决的也是分布式系统中最常见的问题之一，即在同一个分布式集群中的进程或服务，要如何才能找到对方并建立连接。本质上来说，服务发现就是想要了解集群中是否有进程在监听 udp 或 tcp 端口，并且通过名字就可以查找和连接。&lt;/p&gt;
&lt;h3 id="配置中心"&gt;配置中心&lt;/h3&gt;
&lt;p&gt;将一些配置信息放到 etcd 上进行集中管理。&lt;/p&gt;
&lt;p&gt;这类场景的使用方式通常是这样：应用在启动的时候主动从 etcd 获取一次配置信息，同时，在 etcd 节点上注册一个 Watcher 并等待，以后每次配置有更新的时候，etcd 都会实时通知订阅者，以此达到获取最新配置信息的目的。&lt;/p&gt;
&lt;h3 id="分布式锁"&gt;分布式锁&lt;/h3&gt;
&lt;p&gt;因为 etcd 使用 Raft 算法保持了数据的强一致性，某次操作存储到集群中的值必然是全局一致的，所以很容易实现分布式锁。锁服务有两种使用方式，一是保持独占，二是控制时序。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;保持独占即所有获取锁的用户最终只有一个可以得到&lt;/strong&gt;。etcd 为此提供了一套实现分布式锁原子操作 CAS（CompareAndSwap）的 API。通过设置prevExist值，可以保证在多个节点同时去创建某个目录时，只有一个成功。而创建成功的用户就可以认为是获得了锁。&lt;/li&gt;
&lt;li&gt;控制时序，即所有想要获得锁的用户都会被安排执行，但是&lt;strong&gt;获得锁的顺序也是全局唯一的，同时决定了执行顺序&lt;/strong&gt;。etcd 为此也提供了一套 API（自动创建有序键），对一个目录建值时指定为POST动作，这样 etcd 会自动在目录下生成一个当前最大的值为键，存储这个新的值（客户端编号）。同时还可以使用 API 按顺序列出所有当前目录下的键值。此时这些键的值就是客户端的时序，而这些键中存储的值可以是代表客户端的编号。&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="为什么用-etcd-而不用zookeeper"&gt;为什么用 etcd 而不用ZooKeeper？&lt;/h2&gt;
&lt;p&gt;etcd 实现的这些功能，ZooKeeper都能实现。那么为什么要用 etcd 而非直接使用ZooKeeper呢？&lt;/p&gt;
&lt;h3 id="为什么不选择zookeeper"&gt;为什么不选择ZooKeeper？&lt;/h3&gt;
&lt;ol&gt;
&lt;li&gt;部署维护复杂，其使用的Paxos强一致性算法复杂难懂。官方只提供了Java和C两种语言的接口。&lt;/li&gt;
&lt;li&gt;使用Java编写引入大量的依赖。运维人员维护起来比较麻烦。&lt;/li&gt;
&lt;li&gt;最近几年发展缓慢，不如etcd和consul等后起之秀。&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id="为什么选择etcd"&gt;为什么选择etcd？&lt;/h3&gt;
&lt;ol&gt;
&lt;li&gt;简单。使用 Go 语言编写部署简单；支持HTTP/JSON API,使用简单；使用 Raft 算法保证强一致性让用户易于理解。&lt;/li&gt;
&lt;li&gt;etcd 默认数据一更新就进行持久化。&lt;/li&gt;
&lt;li&gt;etcd 支持 SSL 客户端安全认证。&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;最后，etcd 作为一个年轻的项目，正在高速迭代和开发中，这既是一个优点，也是一个缺点。优点是它的未来具有无限的可能性，缺点是无法得到大项目长时间使用的检验。然而，目前CoreOS、Kubernetes和CloudFoundry等知名项目均在生产环境中使用了etcd，所以总的来说，etcd值得你去尝试。&lt;/p&gt;</description><content:encoded><![CDATA[<p>etcd是近几年比较火热的一个开源的、分布式的键值对数据存储系统，提供共享配置、服务的注册和发现，本文主要介绍etcd的安装和使用。</p>
<h2 id="etcd介绍">etcd介绍</h2>
<p><a href="https://etcd.io/">etcd</a>是使用Go语言开发的一个开源的、高可用的分布式key-value存储系统，可以用于配置共享和服务的注册和发现。</p>
<p>类似项目有zookeeper和consul。</p>
<p>etcd具有以下特点：</p>
<ul>
<li>完全复制：集群中的每个节点都可以使用完整的存档</li>
<li>高可用性：Etcd可用于避免硬件的单点故障或网络问题</li>
<li>一致性：每次读取都会返回跨多主机的最新写入</li>
<li>简单：包括一个定义良好、面向用户的API（gRPC）</li>
<li>安全：实现了带有可选的客户端证书身份验证的自动化TLS</li>
<li>快速：每秒10000次写入的基准速度</li>
<li>可靠：使用Raft算法实现了强一致、高可用的服务存储目录</li>
</ul>
<h2 id="etcd应用场景">etcd应用场景</h2>
<h3 id="服务发现">服务发现</h3>
<p>服务发现要解决的也是分布式系统中最常见的问题之一，即在同一个分布式集群中的进程或服务，要如何才能找到对方并建立连接。本质上来说，服务发现就是想要了解集群中是否有进程在监听 udp 或 tcp 端口，并且通过名字就可以查找和连接。</p>
<h3 id="配置中心">配置中心</h3>
<p>将一些配置信息放到 etcd 上进行集中管理。</p>
<p>这类场景的使用方式通常是这样：应用在启动的时候主动从 etcd 获取一次配置信息，同时，在 etcd 节点上注册一个 Watcher 并等待，以后每次配置有更新的时候，etcd 都会实时通知订阅者，以此达到获取最新配置信息的目的。</p>
<h3 id="分布式锁">分布式锁</h3>
<p>因为 etcd 使用 Raft 算法保持了数据的强一致性，某次操作存储到集群中的值必然是全局一致的，所以很容易实现分布式锁。锁服务有两种使用方式，一是保持独占，二是控制时序。</p>
<ul>
<li><strong>保持独占即所有获取锁的用户最终只有一个可以得到</strong>。etcd 为此提供了一套实现分布式锁原子操作 CAS（CompareAndSwap）的 API。通过设置prevExist值，可以保证在多个节点同时去创建某个目录时，只有一个成功。而创建成功的用户就可以认为是获得了锁。</li>
<li>控制时序，即所有想要获得锁的用户都会被安排执行，但是<strong>获得锁的顺序也是全局唯一的，同时决定了执行顺序</strong>。etcd 为此也提供了一套 API（自动创建有序键），对一个目录建值时指定为POST动作，这样 etcd 会自动在目录下生成一个当前最大的值为键，存储这个新的值（客户端编号）。同时还可以使用 API 按顺序列出所有当前目录下的键值。此时这些键的值就是客户端的时序，而这些键中存储的值可以是代表客户端的编号。</li>
</ul>
<h2 id="为什么用-etcd-而不用zookeeper">为什么用 etcd 而不用ZooKeeper？</h2>
<p>etcd 实现的这些功能，ZooKeeper都能实现。那么为什么要用 etcd 而非直接使用ZooKeeper呢？</p>
<h3 id="为什么不选择zookeeper">为什么不选择ZooKeeper？</h3>
<ol>
<li>部署维护复杂，其使用的Paxos强一致性算法复杂难懂。官方只提供了Java和C两种语言的接口。</li>
<li>使用Java编写引入大量的依赖。运维人员维护起来比较麻烦。</li>
<li>最近几年发展缓慢，不如etcd和consul等后起之秀。</li>
</ol>
<h3 id="为什么选择etcd">为什么选择etcd？</h3>
<ol>
<li>简单。使用 Go 语言编写部署简单；支持HTTP/JSON API,使用简单；使用 Raft 算法保证强一致性让用户易于理解。</li>
<li>etcd 默认数据一更新就进行持久化。</li>
<li>etcd 支持 SSL 客户端安全认证。</li>
</ol>
<p>最后，etcd 作为一个年轻的项目，正在高速迭代和开发中，这既是一个优点，也是一个缺点。优点是它的未来具有无限的可能性，缺点是无法得到大项目长时间使用的检验。然而，目前CoreOS、Kubernetes和CloudFoundry等知名项目均在生产环境中使用了etcd，所以总的来说，etcd值得你去尝试。</p>
<h2 id="etcd集群">etcd集群</h2>
<p>etcd 作为一个高可用键值存储系统，天生就是为集群化而设计的。由于 Raft 算法在做决策时需要多数节点的投票，所以 etcd 一般部署集群推荐奇数个节点，推荐的数量为 3、5 或者 7 个节点构成一个集群。</p>
<h3 id="搭建一个3节点集群示例">搭建一个3节点集群示例：</h3>
<p>在每个etcd节点指定集群成员，为了区分不同的集群最好同时配置一个独一无二的token。</p>
<p>下面是提前定义好的集群信息，其中n1、n2和n3表示3个不同的etcd节点。</p>
<pre tabindex="0"><code>TOKEN=token-01
CLUSTER_STATE=new
CLUSTER=n1=http://10.240.0.17:2380,n2=http://10.240.0.18:2380,n3=http://10.240.0.19:2380
</code></pre><p>在n1这台机器上执行以下命令来启动etcd：</p>
<pre tabindex="0"><code>etcd --data-dir=data.etcd --name n1 \
	--initial-advertise-peer-urls http://10.240.0.17:2380 --listen-peer-urls http://10.240.0.17:2380 \
	--advertise-client-urls http://10.240.0.17:2379 --listen-client-urls http://10.240.0.17:2379 \
	--initial-cluster ${CLUSTER} \
	--initial-cluster-state ${CLUSTER_STATE} --initial-cluster-token ${TOKEN}
</code></pre><p>在n2这台机器上执行以下命令启动etcd：</p>
<pre tabindex="0"><code>etcd --data-dir=data.etcd --name n2 \
	--initial-advertise-peer-urls http://10.240.0.18:2380 --listen-peer-urls http://10.240.0.18:2380 \
	--advertise-client-urls http://10.240.0.18:2379 --listen-client-urls http://10.240.0.18:2379 \
	--initial-cluster ${CLUSTER} \
	--initial-cluster-state ${CLUSTER_STATE} --initial-cluster-token ${TOKEN}
</code></pre><p>在n3这台机器上执行以下命令启动etcd：</p>
<pre tabindex="0"><code>etcd --data-dir=data.etcd --name n3 \
	--initial-advertise-peer-urls http://10.240.0.19:2380 --listen-peer-urls http://10.240.0.19:2380 \
	--advertise-client-urls http://10.240.0.19:2379 --listen-client-urls http://10.240.0.19:2379 \
	--initial-cluster ${CLUSTER} \
	--initial-cluster-state ${CLUSTER_STATE} --initial-cluster-token ${TOKEN}
</code></pre><p>etcd 官网提供了一个可以公网访问的 etcd 存储地址。你可以通过如下命令得到 etcd 服务的目录，并把它作为-discovery参数使用。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">curl</span> <span style="color:#75af00">https</span><span style="color:#111">:</span><span style="color:#75715e">//discovery.etcd.io/new?size=3</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">https</span><span style="color:#111">:</span><span style="color:#75715e">//discovery.etcd.io/a81b5818e67a6ea83e9d4daea5ecbc92</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75af00">grab</span> <span style="color:#75af00">this</span> <span style="color:#75af00">token</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">TOKEN</span><span style="color:#111">=</span><span style="color:#75af00">token</span><span style="color:#f92672">-</span><span style="color:#ae81ff">01</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">CLUSTER_STATE</span><span style="color:#111">=</span><span style="color:#75af00">new</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">DISCOVERY</span><span style="color:#111">=</span><span style="color:#75af00">https</span><span style="color:#111">:</span><span style="color:#75715e">//discovery.etcd.io/a81b5818e67a6ea83e9d4daea5ecbc92</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">etcd</span> <span style="color:#f92672">--</span><span style="color:#75af00">data</span><span style="color:#f92672">-</span><span style="color:#75af00">dir</span><span style="color:#111">=</span><span style="color:#75af00">data</span><span style="color:#111">.</span><span style="color:#75af00">etcd</span> <span style="color:#f92672">--</span><span style="color:#75af00">name</span> <span style="color:#75af00">n1</span> <span style="color:#960050;background-color:#1e0010">\</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">--</span><span style="color:#75af00">initial</span><span style="color:#f92672">-</span><span style="color:#75af00">advertise</span><span style="color:#f92672">-</span><span style="color:#75af00">peer</span><span style="color:#f92672">-</span><span style="color:#75af00">urls</span> <span style="color:#75af00">http</span><span style="color:#111">:</span><span style="color:#75715e">//10.240.0.17:2380 --listen-peer-urls http://10.240.0.17:2380 \</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">--</span><span style="color:#75af00">advertise</span><span style="color:#f92672">-</span><span style="color:#75af00">client</span><span style="color:#f92672">-</span><span style="color:#75af00">urls</span> <span style="color:#75af00">http</span><span style="color:#111">:</span><span style="color:#75715e">//10.240.0.17:2379 --listen-client-urls http://10.240.0.17:2379 \</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">--</span><span style="color:#75af00">discovery</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#111">{</span><span style="color:#75af00">DISCOVERY</span><span style="color:#111">}</span> <span style="color:#960050;background-color:#1e0010">\</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">--</span><span style="color:#75af00">initial</span><span style="color:#f92672">-</span><span style="color:#75af00">cluster</span><span style="color:#f92672">-</span><span style="color:#75af00">state</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#111">{</span><span style="color:#75af00">CLUSTER_STATE</span><span style="color:#111">}</span> <span style="color:#f92672">--</span><span style="color:#75af00">initial</span><span style="color:#f92672">-</span><span style="color:#75af00">cluster</span><span style="color:#f92672">-</span><span style="color:#75af00">token</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#111">{</span><span style="color:#75af00">TOKEN</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">etcd</span> <span style="color:#f92672">--</span><span style="color:#75af00">data</span><span style="color:#f92672">-</span><span style="color:#75af00">dir</span><span style="color:#111">=</span><span style="color:#75af00">data</span><span style="color:#111">.</span><span style="color:#75af00">etcd</span> <span style="color:#f92672">--</span><span style="color:#75af00">name</span> <span style="color:#75af00">n2</span> <span style="color:#960050;background-color:#1e0010">\</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">--</span><span style="color:#75af00">initial</span><span style="color:#f92672">-</span><span style="color:#75af00">advertise</span><span style="color:#f92672">-</span><span style="color:#75af00">peer</span><span style="color:#f92672">-</span><span style="color:#75af00">urls</span> <span style="color:#75af00">http</span><span style="color:#111">:</span><span style="color:#75715e">//10.240.0.18:2380 --listen-peer-urls http://10.240.0.18:2380 \</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">--</span><span style="color:#75af00">advertise</span><span style="color:#f92672">-</span><span style="color:#75af00">client</span><span style="color:#f92672">-</span><span style="color:#75af00">urls</span> <span style="color:#75af00">http</span><span style="color:#111">:</span><span style="color:#75715e">//10.240.0.18:2379 --listen-client-urls http://10.240.0.18:2379 \</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">--</span><span style="color:#75af00">discovery</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#111">{</span><span style="color:#75af00">DISCOVERY</span><span style="color:#111">}</span> <span style="color:#960050;background-color:#1e0010">\</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">--</span><span style="color:#75af00">initial</span><span style="color:#f92672">-</span><span style="color:#75af00">cluster</span><span style="color:#f92672">-</span><span style="color:#75af00">state</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#111">{</span><span style="color:#75af00">CLUSTER_STATE</span><span style="color:#111">}</span> <span style="color:#f92672">--</span><span style="color:#75af00">initial</span><span style="color:#f92672">-</span><span style="color:#75af00">cluster</span><span style="color:#f92672">-</span><span style="color:#75af00">token</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#111">{</span><span style="color:#75af00">TOKEN</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">etcd</span> <span style="color:#f92672">--</span><span style="color:#75af00">data</span><span style="color:#f92672">-</span><span style="color:#75af00">dir</span><span style="color:#111">=</span><span style="color:#75af00">data</span><span style="color:#111">.</span><span style="color:#75af00">etcd</span> <span style="color:#f92672">--</span><span style="color:#75af00">name</span> <span style="color:#75af00">n3</span> <span style="color:#960050;background-color:#1e0010">\</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">--</span><span style="color:#75af00">initial</span><span style="color:#f92672">-</span><span style="color:#75af00">advertise</span><span style="color:#f92672">-</span><span style="color:#75af00">peer</span><span style="color:#f92672">-</span><span style="color:#75af00">urls</span> <span style="color:#75af00">http</span><span style="color:#111">:</span><span style="color:#75715e">//10.240.0.19:2380 --listen-peer-urls http://10.240.0.19:2380 \</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">--</span><span style="color:#75af00">advertise</span><span style="color:#f92672">-</span><span style="color:#75af00">client</span><span style="color:#f92672">-</span><span style="color:#75af00">urls</span> <span style="color:#75af00">http</span><span style="color:#111">:</span><span style="color:#75715e">//10.240.0.19:2379 --listen-client-urls http:/10.240.0.19:2379 \</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">--</span><span style="color:#75af00">discovery</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#111">{</span><span style="color:#75af00">DISCOVERY</span><span style="color:#111">}</span> <span style="color:#960050;background-color:#1e0010">\</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">--</span><span style="color:#75af00">initial</span><span style="color:#f92672">-</span><span style="color:#75af00">cluster</span><span style="color:#f92672">-</span><span style="color:#75af00">state</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#111">{</span><span style="color:#75af00">CLUSTER_STATE</span><span style="color:#111">}</span> <span style="color:#f92672">--</span><span style="color:#75af00">initial</span><span style="color:#f92672">-</span><span style="color:#75af00">cluster</span><span style="color:#f92672">-</span><span style="color:#75af00">token</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#111">{</span><span style="color:#75af00">TOKEN</span><span style="color:#111">}</span>
</span></span></code></pre></div><p>到此etcd集群就搭建起来了，可以使用etcdctl来连接etcd。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#111">export</span> <span style="color:#111">ETCDCTL_API</span><span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span><span style="color:#111">HOST_1</span><span style="color:#f92672">=</span>10.240.0.17
</span></span><span style="display:flex;"><span><span style="color:#111">HOST_2</span><span style="color:#f92672">=</span>10.240.0.18
</span></span><span style="display:flex;"><span><span style="color:#111">HOST_3</span><span style="color:#f92672">=</span>10.240.0.19
</span></span><span style="display:flex;"><span><span style="color:#111">ENDPOINTS</span><span style="color:#f92672">=</span><span style="color:#111">$HOST_1</span>:2379,<span style="color:#111">$HOST_2</span>:2379,<span style="color:#111">$HOST_3</span>:2379
</span></span><span style="display:flex;"><span>etcdctl --endpoints<span style="color:#f92672">=</span><span style="color:#111">$ENDPOINTS</span> member list
</span></span></code></pre></div><h2 id="go语言操作etcd">Go语言操作etcd</h2>
<p>这里使用官方的<a href="https://github.com/etcd-io/etcd/tree/master/clientv3">etcd/clientv3</a>包来连接etcd并进行相关操作。</p>
<h3 id="安装">安装</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">go</span> <span style="color:#75af00">get</span> <span style="color:#00a8c8">go</span><span style="color:#111">.</span><span style="color:#75af00">etcd</span><span style="color:#111">.</span><span style="color:#75af00">io</span><span style="color:#f92672">/</span><span style="color:#75af00">etcd</span><span style="color:#f92672">/</span><span style="color:#75af00">clientv3</span>
</span></span></code></pre></div><h3 id="put和get操作">put和get操作</h3>
<p>put命令用来设置键值对数据，get命令用来根据key获取值。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;context&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;go.etcd.io/etcd/clientv3&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// etcd client put/get demo</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// use etcd/clientv3</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">cli</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">clientv3</span><span style="color:#111">.</span><span style="color:#75af00">New</span><span style="color:#111">(</span><span style="color:#75af00">clientv3</span><span style="color:#111">.</span><span style="color:#75af00">Config</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">Endpoints</span><span style="color:#111">:</span>   <span style="color:#111">[]</span><span style="color:#00a8c8">string</span><span style="color:#111">{</span><span style="color:#d88200">&#34;127.0.0.1:2379&#34;</span><span style="color:#111">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">DialTimeout</span><span style="color:#111">:</span> <span style="color:#ae81ff">5</span> <span style="color:#f92672">*</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Second</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// handle error!</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;connect to etcd failed, err:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;connect to etcd success&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">cli</span><span style="color:#111">.</span><span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// put</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">cancel</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">WithTimeout</span><span style="color:#111">(</span><span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Background</span><span style="color:#111">(),</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Second</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">cli</span><span style="color:#111">.</span><span style="color:#75af00">Put</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;q1mi&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;dsb&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">cancel</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;put to etcd failed, err:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// get</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">cancel</span> <span style="color:#111">=</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">WithTimeout</span><span style="color:#111">(</span><span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Background</span><span style="color:#111">(),</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Second</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">resp</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">cli</span><span style="color:#111">.</span><span style="color:#75af00">Get</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;q1mi&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">cancel</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;get from etcd failed, err:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">ev</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">resp</span><span style="color:#111">.</span><span style="color:#75af00">Kvs</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;%s:%s\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">ev</span><span style="color:#111">.</span><span style="color:#75af00">Key</span><span style="color:#111">,</span> <span style="color:#75af00">ev</span><span style="color:#111">.</span><span style="color:#75af00">Value</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="watch操作">watch操作</h3>
<p>watch用来获取未来更改的通知。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;context&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;go.etcd.io/etcd/clientv3&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// watch demo</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">cli</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">clientv3</span><span style="color:#111">.</span><span style="color:#75af00">New</span><span style="color:#111">(</span><span style="color:#75af00">clientv3</span><span style="color:#111">.</span><span style="color:#75af00">Config</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">Endpoints</span><span style="color:#111">:</span>   <span style="color:#111">[]</span><span style="color:#00a8c8">string</span><span style="color:#111">{</span><span style="color:#d88200">&#34;127.0.0.1:2379&#34;</span><span style="color:#111">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">DialTimeout</span><span style="color:#111">:</span> <span style="color:#ae81ff">5</span> <span style="color:#f92672">*</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Second</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;connect to etcd failed, err:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;connect to etcd success&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">cli</span><span style="color:#111">.</span><span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// watch key:q1mi change</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">rch</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">cli</span><span style="color:#111">.</span><span style="color:#75af00">Watch</span><span style="color:#111">(</span><span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Background</span><span style="color:#111">(),</span> <span style="color:#d88200">&#34;q1mi&#34;</span><span style="color:#111">)</span> <span style="color:#75715e">// &lt;-chan WatchResponse</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">wresp</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">rch</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">ev</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">wresp</span><span style="color:#111">.</span><span style="color:#75af00">Events</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Type: %s Key:%s Value:%s\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">ev</span><span style="color:#111">.</span><span style="color:#75af00">Type</span><span style="color:#111">,</span> <span style="color:#75af00">ev</span><span style="color:#111">.</span><span style="color:#75af00">Kv</span><span style="color:#111">.</span><span style="color:#75af00">Key</span><span style="color:#111">,</span> <span style="color:#75af00">ev</span><span style="color:#111">.</span><span style="color:#75af00">Kv</span><span style="color:#111">.</span><span style="color:#75af00">Value</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>将上面的代码保存编译执行，此时程序就会等待etcd中q1mi这个key的变化。</p>
<p>例如：我们打开终端执行以下命令修改、删除、设置q1mi这个key。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">etcd</span><span style="color:#111">&gt;</span> <span style="color:#75af00">etcdctl</span><span style="color:#111">.</span><span style="color:#75af00">exe</span> <span style="color:#f92672">--</span><span style="color:#75af00">endpoints</span><span style="color:#111">=</span><span style="color:#75af00">http</span><span style="color:#111">:</span><span style="color:#75715e">//127.0.0.1:2379 put q1mi &#34;dsb2&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">OK</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">etcd</span><span style="color:#111">&gt;</span> <span style="color:#75af00">etcdctl</span><span style="color:#111">.</span><span style="color:#75af00">exe</span> <span style="color:#f92672">--</span><span style="color:#75af00">endpoints</span><span style="color:#111">=</span><span style="color:#75af00">http</span><span style="color:#111">:</span><span style="color:#75715e">//127.0.0.1:2379 del q1mi</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">etcd</span><span style="color:#111">&gt;</span> <span style="color:#75af00">etcdctl</span><span style="color:#111">.</span><span style="color:#75af00">exe</span> <span style="color:#f92672">--</span><span style="color:#75af00">endpoints</span><span style="color:#111">=</span><span style="color:#75af00">http</span><span style="color:#111">:</span><span style="color:#75715e">//127.0.0.1:2379 put q1mi &#34;dsb3&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">OK</span>
</span></span></code></pre></div><p>上面的程序都能收到如下通知。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">watch</span><span style="color:#111">&gt;</span><span style="color:#75af00">watch</span><span style="color:#111">.</span><span style="color:#75af00">exe</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">connect</span> <span style="color:#75af00">to</span> <span style="color:#75af00">etcd</span> <span style="color:#75af00">success</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">Type</span><span style="color:#111">:</span> <span style="color:#75af00">PUT</span> <span style="color:#75af00">Key</span><span style="color:#111">:</span><span style="color:#75af00">q1mi</span> <span style="color:#75af00">Value</span><span style="color:#111">:</span><span style="color:#75af00">dsb2</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">Type</span><span style="color:#111">:</span> <span style="color:#75af00">DELETE</span> <span style="color:#75af00">Key</span><span style="color:#111">:</span><span style="color:#75af00">q1mi</span> <span style="color:#75af00">Value</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">Type</span><span style="color:#111">:</span> <span style="color:#75af00">PUT</span> <span style="color:#75af00">Key</span><span style="color:#111">:</span><span style="color:#75af00">q1mi</span> <span style="color:#75af00">Value</span><span style="color:#111">:</span><span style="color:#75af00">dsb3</span>
</span></span></code></pre></div><h3 id="lease租约">lease租约</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// etcd lease</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;context&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;go.etcd.io/etcd/clientv3&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">cli</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">clientv3</span><span style="color:#111">.</span><span style="color:#75af00">New</span><span style="color:#111">(</span><span style="color:#75af00">clientv3</span><span style="color:#111">.</span><span style="color:#75af00">Config</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">Endpoints</span><span style="color:#111">:</span>   <span style="color:#111">[]</span><span style="color:#00a8c8">string</span><span style="color:#111">{</span><span style="color:#d88200">&#34;127.0.0.1:2379&#34;</span><span style="color:#111">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">DialTimeout</span><span style="color:#111">:</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Second</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">5</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Fatal</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;connect to etcd success.&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">cli</span><span style="color:#111">.</span><span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 创建一个5秒的租约</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">resp</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">cli</span><span style="color:#111">.</span><span style="color:#75af00">Grant</span><span style="color:#111">(</span><span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">TODO</span><span style="color:#111">(),</span> <span style="color:#ae81ff">5</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Fatal</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 5秒钟之后, /nazha/ 这个key就会被移除</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">cli</span><span style="color:#111">.</span><span style="color:#75af00">Put</span><span style="color:#111">(</span><span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">TODO</span><span style="color:#111">(),</span> <span style="color:#d88200">&#34;/nazha/&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;dsb&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">clientv3</span><span style="color:#111">.</span><span style="color:#75af00">WithLease</span><span style="color:#111">(</span><span style="color:#75af00">resp</span><span style="color:#111">.</span><span style="color:#75af00">ID</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Fatal</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="keepalive">keepAlive</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;context&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;go.etcd.io/etcd/clientv3&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// etcd keepAlive</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">cli</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">clientv3</span><span style="color:#111">.</span><span style="color:#75af00">New</span><span style="color:#111">(</span><span style="color:#75af00">clientv3</span><span style="color:#111">.</span><span style="color:#75af00">Config</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">Endpoints</span><span style="color:#111">:</span>   <span style="color:#111">[]</span><span style="color:#00a8c8">string</span><span style="color:#111">{</span><span style="color:#d88200">&#34;127.0.0.1:2379&#34;</span><span style="color:#111">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">DialTimeout</span><span style="color:#111">:</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Second</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">5</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Fatal</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;connect to etcd success.&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">cli</span><span style="color:#111">.</span><span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">resp</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">cli</span><span style="color:#111">.</span><span style="color:#75af00">Grant</span><span style="color:#111">(</span><span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">TODO</span><span style="color:#111">(),</span> <span style="color:#ae81ff">5</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Fatal</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">cli</span><span style="color:#111">.</span><span style="color:#75af00">Put</span><span style="color:#111">(</span><span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">TODO</span><span style="color:#111">(),</span> <span style="color:#d88200">&#34;/nazha/&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;dsb&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">clientv3</span><span style="color:#111">.</span><span style="color:#75af00">WithLease</span><span style="color:#111">(</span><span style="color:#75af00">resp</span><span style="color:#111">.</span><span style="color:#75af00">ID</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Fatal</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// the key &#39;foo&#39; will be kept forever</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ch</span><span style="color:#111">,</span> <span style="color:#75af00">kaerr</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">cli</span><span style="color:#111">.</span><span style="color:#75af00">KeepAlive</span><span style="color:#111">(</span><span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">TODO</span><span style="color:#111">(),</span> <span style="color:#75af00">resp</span><span style="color:#111">.</span><span style="color:#75af00">ID</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">kaerr</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Fatal</span><span style="color:#111">(</span><span style="color:#75af00">kaerr</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">ka</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#75af00">ch</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;ttl:&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">ka</span><span style="color:#111">.</span><span style="color:#75af00">TTL</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="基于etcd实现分布式锁">基于etcd实现分布式锁</h3>
<p>go.etcd.io/etcd/clientv3/concurrency在etcd之上实现并发操作，如分布式锁、屏障和选举。</p>
<p>导入该包：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#d88200">&#34;go.etcd.io/etcd/clientv3/concurrency&#34;</span>
</span></span></code></pre></div><p>基于etcd实现的分布式锁示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">cli</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">clientv3</span><span style="color:#111">.</span><span style="color:#75af00">New</span><span style="color:#111">(</span><span style="color:#75af00">clientv3</span><span style="color:#111">.</span><span style="color:#75af00">Config</span><span style="color:#111">{</span><span style="color:#75af00">Endpoints</span><span style="color:#111">:</span> <span style="color:#75af00">endpoints</span><span style="color:#111">})</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Fatal</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">defer</span> <span style="color:#75af00">cli</span><span style="color:#111">.</span><span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 创建两个单独的会话用来演示锁竞争</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">s1</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">concurrency</span><span style="color:#111">.</span><span style="color:#75af00">NewSession</span><span style="color:#111">(</span><span style="color:#75af00">cli</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Fatal</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">defer</span> <span style="color:#75af00">s1</span><span style="color:#111">.</span><span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">m1</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">concurrency</span><span style="color:#111">.</span><span style="color:#75af00">NewMutex</span><span style="color:#111">(</span><span style="color:#75af00">s1</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;/my-lock/&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">s2</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">concurrency</span><span style="color:#111">.</span><span style="color:#75af00">NewSession</span><span style="color:#111">(</span><span style="color:#75af00">cli</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Fatal</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">defer</span> <span style="color:#75af00">s2</span><span style="color:#111">.</span><span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">m2</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">concurrency</span><span style="color:#111">.</span><span style="color:#75af00">NewMutex</span><span style="color:#111">(</span><span style="color:#75af00">s2</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;/my-lock/&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 会话s1获取锁</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">m1</span><span style="color:#111">.</span><span style="color:#75af00">Lock</span><span style="color:#111">(</span><span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">TODO</span><span style="color:#111">());</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Fatal</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;acquired lock for s1&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">m2Locked</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">chan</span> <span style="color:#00a8c8">struct</span><span style="color:#111">{})</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">go</span> <span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">defer</span> <span style="color:#111">close</span><span style="color:#111">(</span><span style="color:#75af00">m2Locked</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 等待直到会话s1释放了/my-lock/的锁</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">m2</span><span style="color:#111">.</span><span style="color:#75af00">Lock</span><span style="color:#111">(</span><span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">TODO</span><span style="color:#111">());</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Fatal</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}()</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">m1</span><span style="color:#111">.</span><span style="color:#75af00">Unlock</span><span style="color:#111">(</span><span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">TODO</span><span style="color:#111">());</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Fatal</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;released lock for s1&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;-</span><span style="color:#75af00">m2Locked</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;acquired lock for s2&#34;</span><span style="color:#111">)</span>
</span></span></code></pre></div><p>输出：</p>
<pre tabindex="0"><code>acquired lock for s1
released lock for s1
acquired lock for s2
</code></pre><p><a href="https://godoc.org/go.etcd.io/etcd/clientv3/concurrency">查看文档了解更多</a></p>
<h2 id="文章转自">文章转自</h2>
<ul>
<li><a href="https://www.liwenzhou.com/posts/Go/go_etcd/">https://www.liwenzhou.com/posts/Go/go_etcd/</a></li>
</ul>
]]></content:encoded><category>go</category><category>boltdb</category><category>etcd</category><category>golang</category><category>数据库</category><category>kubernetes</category></item><item><title>Go命令行工具cobra</title><link>https://daemon365.dev/post/go/go_command_line_tool_cobra/</link><pubDate>Wed, 21 Dec 2022 00:00:00 +0800</pubDate><guid>https://daemon365.dev/post/go/go_command_line_tool_cobra/</guid><description>&lt;h2 id="关于"&gt;关于&lt;/h2&gt;
&lt;p&gt;Cobra 是 Go 的 CLI 框架。它包含一个用于创建功能强大的现代 CLI 应用程序的库，以及一个用于快速生成基于 Cobra 的应用程序和命令文件的工具。&lt;/p&gt;
&lt;p&gt;Cobra 由 Go 项目成员和 hugo 作者 &lt;a href="https://github.com/spf13"&gt;spf13&lt;/a&gt; 创建，已经被许多流行的 Go 项目采用，比如 kubernetes、docker等&lt;/p&gt;
&lt;h2 id="特性"&gt;特性&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;简单的基于子命令的 CLIs：&lt;code&gt;app server&lt;/code&gt;、&lt;code&gt;app fetch&lt;/code&gt; 等；&lt;/li&gt;
&lt;li&gt;完全兼容 &lt;a href="https://zh.wikipedia.org/wiki/%E5%8F%AF%E7%A7%BB%E6%A4%8D%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E6%8E%A5%E5%8F%A3"&gt;POSIX（可移植操作系统接口）&lt;/a&gt; 的标志（包括短版和长版）&lt;/li&gt;
&lt;li&gt;嵌套子命令&lt;/li&gt;
&lt;li&gt;全局、局部和级联的标志&lt;/li&gt;
&lt;li&gt;使用 &lt;code&gt;cobra init appname&lt;/code&gt; 和 &lt;code&gt;cobra add cmdname&lt;/code&gt; 轻松生成应用程序和命令&lt;/li&gt;
&lt;li&gt;智能提示（&lt;code&gt;app srver&lt;/code&gt; &amp;hellip;did you mean &lt;code&gt;app server&lt;/code&gt;）&lt;/li&gt;
&lt;li&gt;自动生成命令和标志的帮助&lt;/li&gt;
&lt;li&gt;自动识别 &lt;code&gt;-h&lt;/code&gt;、&lt;code&gt;--help&lt;/code&gt; 等帮助标识&lt;/li&gt;
&lt;li&gt;自动为你的应用程序生成的 bash 自动完成&lt;/li&gt;
&lt;li&gt;自动为你的应用程序生成 man 手册&lt;/li&gt;
&lt;li&gt;命令别名，以便你可以更改内容而不会破坏它们&lt;/li&gt;
&lt;li&gt;定义自己的帮助，用法等的灵活性。&lt;/li&gt;
&lt;li&gt;可选与 &lt;a href="https://github.com/spf13/viper"&gt;viper&lt;/a&gt; 紧密集成，可用于 &lt;a href="https://12factor.net/zh_cn/"&gt;12factor&lt;/a&gt; 应用程序&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="概念"&gt;概念&lt;/h2&gt;
&lt;p&gt;Cobra 构建在命令（commands）、参数（arguments）和 标志（flags）上。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Commands&lt;/strong&gt; 代表动作，&lt;strong&gt;Args&lt;/strong&gt; 是事物，&lt;strong&gt;Flags&lt;/strong&gt; 是这些动作的修饰符。&lt;/p&gt;</description><content:encoded><![CDATA[<h2 id="关于">关于</h2>
<p>Cobra 是 Go 的 CLI 框架。它包含一个用于创建功能强大的现代 CLI 应用程序的库，以及一个用于快速生成基于 Cobra 的应用程序和命令文件的工具。</p>
<p>Cobra 由 Go 项目成员和 hugo 作者 <a href="https://github.com/spf13">spf13</a> 创建，已经被许多流行的 Go 项目采用，比如 kubernetes、docker等</p>
<h2 id="特性">特性</h2>
<ul>
<li>简单的基于子命令的 CLIs：<code>app server</code>、<code>app fetch</code> 等；</li>
<li>完全兼容 <a href="https://zh.wikipedia.org/wiki/%E5%8F%AF%E7%A7%BB%E6%A4%8D%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E6%8E%A5%E5%8F%A3">POSIX（可移植操作系统接口）</a> 的标志（包括短版和长版）</li>
<li>嵌套子命令</li>
<li>全局、局部和级联的标志</li>
<li>使用 <code>cobra init appname</code> 和 <code>cobra add cmdname</code> 轻松生成应用程序和命令</li>
<li>智能提示（<code>app srver</code> &hellip;did you mean <code>app server</code>）</li>
<li>自动生成命令和标志的帮助</li>
<li>自动识别 <code>-h</code>、<code>--help</code> 等帮助标识</li>
<li>自动为你的应用程序生成的 bash 自动完成</li>
<li>自动为你的应用程序生成 man 手册</li>
<li>命令别名，以便你可以更改内容而不会破坏它们</li>
<li>定义自己的帮助，用法等的灵活性。</li>
<li>可选与 <a href="https://github.com/spf13/viper">viper</a> 紧密集成，可用于 <a href="https://12factor.net/zh_cn/">12factor</a> 应用程序</li>
</ul>
<h2 id="概念">概念</h2>
<p>Cobra 构建在命令（commands）、参数（arguments）和 标志（flags）上。</p>
<p><strong>Commands</strong> 代表动作，<strong>Args</strong> 是事物，<strong>Flags</strong> 是这些动作的修饰符。</p>
<p>最好的应用程序在使用时会像句子一样读起来。用户将知道如何使用该应用程序，因为他们将自然地了解如何使用它。</p>
<p>遵循的模式是 <code>APPNAME VERB NOUN --ADJECTIVE</code>。 或 <code>APPNAME COMMAND ARG --FLAG</code></p>
<p>一些真实的例子可以更好地说明这一点。</p>
<p>在以下示例中，<code>server</code> 是命令，<code>port</code> 是标志：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>hugo server --port<span style="color:#f92672">=</span><span style="color:#ae81ff">1313</span>
</span></span></code></pre></div><p>在此命令中，我们告诉 Git 克隆 url 的内容：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>git clone URL --bare
</span></span></code></pre></div><h3 id="命令command">命令（Command）</h3>
<p>命令是应用程序的核心。应用程序提供的每一个交互都包含在 Command 中。一个命令可以有子命令和可选的运行一个动作。</p>
<p>在上面的示例中，<code>server</code> 是命令。</p>
<p><a href="https://pkg.go.dev/github.com/spf13/cobra#Command">Cobra.Command API</a>)</p>
<h3 id="标志flags">标志（Flags）</h3>
<p>一个标志是一种修饰命令行为的方式。Cobra 支持完全符合 [<a href="https://zh.wikipedia.org/wiki/%E5%8F%AF%E7%A7%BB%E6%A4%8D%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E6%8E%A5%E5%8F%A3">https://zh.wikipedia.org/wiki/可移植操作系统接口</a>) 包。</p>
<p>Cobra 命令可以定义一直保留到子命令的标志和仅可用于该命令的标志。</p>
<p>在上面的例子中，<code>port</code> 是标志。</p>
<p>标志的功能是 <a href="https://github.com/spf13/pflag">pflag</a> 库提供的，该库是一个标准库的 fork，在维护相同接口的基础上兼容了 <a href="https://zh.wikipedia.org/wiki/%E5%8F%AF%E7%A7%BB%E6%A4%8D%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E6%8E%A5%E5%8F%A3">POSIX（可移植操作系统接口）</a>。</p>
<h2 id="简单使用">简单使用</h2>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// 目录结构</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">├──</span> <span style="color:#75af00">add</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">│</span>   <span style="color:#960050;background-color:#1e0010">└──</span> <span style="color:#75af00">add</span><span style="color:#111">.</span><span style="color:#00a8c8">go</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">├──</span> <span style="color:#00a8c8">go</span><span style="color:#111">.</span><span style="color:#75af00">mod</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">├──</span> <span style="color:#00a8c8">go</span><span style="color:#111">.</span><span style="color:#75af00">sum</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">└──</span> <span style="color:#75af00">main</span><span style="color:#111">.</span><span style="color:#00a8c8">go</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// main.go</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;test/add&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;github.com/spf13/cobra&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">var</span> <span style="color:#75af00">rootCmd</span> <span style="color:#111">=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">cobra</span><span style="color:#111">.</span><span style="color:#75af00">Command</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Use</span><span style="color:#111">:</span>     <span style="color:#d88200">&#34;test&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Short</span><span style="color:#111">:</span>   <span style="color:#d88200">&#34;测试&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Long</span><span style="color:#111">:</span>    <span style="color:#d88200">`我要写博客做个测试呢,这是个常提示`</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Version</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;v1.1&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">init</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">rootCmd</span><span style="color:#111">.</span><span style="color:#75af00">AddCommand</span><span style="color:#111">(</span><span style="color:#75af00">add</span><span style="color:#111">.</span><span style="color:#75af00">CmdAdd</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">rootCmd</span><span style="color:#111">.</span><span style="color:#75af00">Execute</span><span style="color:#111">();</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Fatal</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// add/add.go</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">add</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;github.com/spf13/cobra&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">var</span> <span style="color:#75af00">CmdAdd</span> <span style="color:#111">=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">cobra</span><span style="color:#111">.</span><span style="color:#75af00">Command</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Use</span><span style="color:#111">:</span>   <span style="color:#d88200">&#34;add&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Short</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;新键&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Long</span><span style="color:#111">:</span>  <span style="color:#d88200">&#34;新建个文件&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">RunE</span><span style="color:#111">:</span>  <span style="color:#75af00">RunE</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">var</span> <span style="color:#75af00">path</span> <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">init</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">CmdAdd</span><span style="color:#111">.</span><span style="color:#75af00">Flags</span><span style="color:#111">().</span><span style="color:#75af00">StringVarP</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">path</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;path&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;p&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">path</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;file path&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">RunE</span><span style="color:#111">(</span><span style="color:#75af00">cmd</span> <span style="color:#f92672">*</span><span style="color:#75af00">cobra</span><span style="color:#111">.</span><span style="color:#75af00">Command</span><span style="color:#111">,</span> <span style="color:#75af00">args</span> <span style="color:#111">[]</span><span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;假装创建个文件 path=&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">path</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>执行结果</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># go run main.go --help</span>
</span></span><span style="display:flex;"><span>我要写博客做个测试呢,这是个常提示
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Usage:
</span></span><span style="display:flex;"><span>  <span style="color:#111">test</span> <span style="color:#f92672">[</span>command<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Available Commands:
</span></span><span style="display:flex;"><span>  add         新键
</span></span><span style="display:flex;"><span>  completion  Generate the autocompletion script <span style="color:#00a8c8">for</span> the specified shell
</span></span><span style="display:flex;"><span>  <span style="color:#111">help</span>        Help about any <span style="color:#111">command</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Flags:
</span></span><span style="display:flex;"><span>  -h, --help      <span style="color:#111">help</span> <span style="color:#00a8c8">for</span> <span style="color:#111">test</span>
</span></span><span style="display:flex;"><span>  -v, --version   version <span style="color:#00a8c8">for</span> <span style="color:#111">test</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Use <span style="color:#d88200">&#34;test [command] --help&#34;</span> <span style="color:#00a8c8">for</span> more information about a command.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># go run main.go add --help</span>
</span></span><span style="display:flex;"><span>新建个文件
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Usage:
</span></span><span style="display:flex;"><span>  <span style="color:#111">test</span> add <span style="color:#f92672">[</span>flags<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Flags:
</span></span><span style="display:flex;"><span>  -h, --help          <span style="color:#111">help</span> <span style="color:#00a8c8">for</span> add
</span></span><span style="display:flex;"><span>  -p, --path string   file path
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span><span style="color:#75715e"># go run main.go add --path=/user/pass </span>
</span></span><span style="display:flex;"><span>假装创建个文件 <span style="color:#111">path</span><span style="color:#f92672">=</span> /user/pass
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># go run main.go --version</span>
</span></span><span style="display:flex;"><span><span style="color:#111">test</span> version v1.1
</span></span></code></pre></div><h2 id="command参数">Command参数</h2>
<p>例子中的<code>cobra.Command</code>是个结构体，有很多字段，都是做什么用的呢？</p>
<p>这些参数是Go语言中<code>cobra</code>库中的<code>Command</code>结构体的字段，用于定义命令行工具的行为和选项。它们的作用如下：</p>
<ul>
<li><code>Use</code>: 命令名称。</li>
<li><code>Aliases</code>: 命令的别名。</li>
<li><code>SuggestFor</code>: 命令建议使用的单词列表。</li>
<li><code>Short</code>: 命令简短描述。</li>
<li><code>GroupID</code>: 命令所属的命令组。</li>
<li><code>Long</code>: 命令详细描述。</li>
<li><code>Example</code>: 命令的使用示例。</li>
<li><code>ValidArgs</code>: 命令接受的参数列表。</li>
<li><code>ValidArgsFunction</code>: 命令用于提供动态参数补全的函数。</li>
<li><code>Args</code>: 命令的位置参数列表。</li>
<li><code>ArgAliases</code>: 位置参数的别名。</li>
<li><code>BashCompletionFunction</code>: 生成Bash补全的函数。</li>
<li><code>Deprecated</code>: 命令是否已经过时的标志。</li>
<li><code>Annotations</code>: 命令的附加注释信息。</li>
<li><code>Version</code>: 命令版本号。</li>
<li><code>PersistentPreRun</code>: 每次执行该命令之前都会执行的函数。</li>
<li><code>PersistentPreRunE</code>: 每次执行该命令之前都会执行的返回错误的函数。</li>
<li><code>PreRun</code>: 每次执行该命令之前都会执行的函数。</li>
<li><code>PreRunE</code>: 每次执行该命令之前都会执行的返回错误的函数。</li>
<li><code>Run</code>: 执行命令的函数。</li>
<li><code>RunE</code>: 执行命令的返回错误的函数。</li>
<li><code>PostRun</code>: 每次执行该命令之后都会执行的函数。</li>
<li><code>PostRunE</code>: 每次执行该命令之后都会执行的返回错误的函数。</li>
<li><code>PersistentPostRun</code>: 每次执行该命令之后都会执行的函数。</li>
<li><code>PersistentPostRunE</code>: 每次执行该命令之后都会执行的返回错误的函数。</li>
<li><code>FParseErrWhitelist</code> : 忽略特定的解析错误</li>
<li><code>CompletionOptions</code> :控制 shell 自动完成的选项</li>
<li><code>TraverseChildren</code>: 解析父命令的标志后再执行子命令</li>
<li><code>Hidden</code> : 隐藏命令，不在可用命令列表中显示</li>
<li><code>SilenceErrors</code> : 静默下游错误</li>
<li><code>SilenceUsage</code> : 静默错误时不显示用法</li>
<li><code>DisableFlagParsing</code> : 禁用标志解析</li>
<li><code>DisableAutoGenTag</code> : 禁用自动生成的标记</li>
<li><code>DisableFlagsInUseLine</code> : 在打印帮助或生成文档时禁用“[flags]”在用法行中的添加</li>
<li><code>DisableSuggestions</code> : 禁用基于Levenshtein距离的建议</li>
<li><code>SuggestionsMinimumDistance</code> : 显示建议的最小Levenshtein距离</li>
</ul>
<h2 id="reference">Reference</h2>
<ul>
<li><a href="https://juejin.cn/post/6924541628031959047">https://juejin.cn/post/6924541628031959047</a></li>
<li><a href="https://cobra.dev/">Cobra. Dev</a></li>
</ul>
]]></content:encoded><category>go</category><category>go</category></item><item><title>golang map实现原理</title><link>https://daemon365.dev/post/go/golang_map_implementation_principle/</link><pubDate>Sat, 22 May 2021 00:00:00 +0800</pubDate><guid>https://daemon365.dev/post/go/golang_map_implementation_principle/</guid><description>&lt;p&gt;这篇文章主要讲 map 的赋值、删除、查询、扩容的具体执行过程，仍然是从底层的角度展开。结合源码，看完本文一定会彻底明白 map 底层原理。&lt;/p&gt;
&lt;p&gt;我要说明的是，这里对 map 的基本用法涉及比较少，我相信可以通过阅读其他入门书籍了解。本文的内容比较深入，但是由于我画了各种图，我相信很容易看懂。&lt;/p&gt;
&lt;h2 id="什么是-map"&gt;什么是 map&lt;/h2&gt;
&lt;p&gt;维基百科里这样定义 map：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;In computer science, an associative array, map, symbol table, or dictionary is an abstract data type composed of a collection of (key, value) pairs, such that each possible key appears at most once in the collection.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;简单说明一下：在计算机科学里，被称为相关数组、map、符号表或者字典，是由一组 &lt;code&gt;&amp;lt;key, value&amp;gt;&lt;/code&gt; 对组成的抽象数据结构，并且同一个 key 只会出现一次。&lt;/p&gt;
&lt;p&gt;有两个关键点：map 是由 &lt;code&gt;key-value&lt;/code&gt; 对组成的；&lt;code&gt;key&lt;/code&gt; 只会出现一次。&lt;/p&gt;
&lt;p&gt;和 map 相关的操作主要是：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;增加一个 k-v 对 —— Add or insert；&lt;/li&gt;
&lt;li&gt;删除一个 k-v 对 —— Remove or delete；&lt;/li&gt;
&lt;li&gt;修改某个 k 对应的 v —— Reassign；&lt;/li&gt;
&lt;li&gt;查询某个 k 对应的 v —— Lookup；&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;简单说就是最基本的 &lt;code&gt;增删查改&lt;/code&gt;。&lt;/p&gt;</description><content:encoded><![CDATA[<p>这篇文章主要讲 map 的赋值、删除、查询、扩容的具体执行过程，仍然是从底层的角度展开。结合源码，看完本文一定会彻底明白 map 底层原理。</p>
<p>我要说明的是，这里对 map 的基本用法涉及比较少，我相信可以通过阅读其他入门书籍了解。本文的内容比较深入，但是由于我画了各种图，我相信很容易看懂。</p>
<h2 id="什么是-map">什么是 map</h2>
<p>维基百科里这样定义 map：</p>
<blockquote>
<p>In computer science, an associative array, map, symbol table, or dictionary is an abstract data type composed of a collection of (key, value) pairs, such that each possible key appears at most once in the collection.</p>
</blockquote>
<p>简单说明一下：在计算机科学里，被称为相关数组、map、符号表或者字典，是由一组 <code>&lt;key, value&gt;</code> 对组成的抽象数据结构，并且同一个 key 只会出现一次。</p>
<p>有两个关键点：map 是由 <code>key-value</code> 对组成的；<code>key</code> 只会出现一次。</p>
<p>和 map 相关的操作主要是：</p>
<ol>
<li>增加一个 k-v 对 —— Add or insert；</li>
<li>删除一个 k-v 对 —— Remove or delete；</li>
<li>修改某个 k 对应的 v —— Reassign；</li>
<li>查询某个 k 对应的 v —— Lookup；</li>
</ol>
<p>简单说就是最基本的 <code>增删查改</code>。</p>
<p>map 的设计也被称为 “The dictionary problem”，它的任务是设计一种数据结构用来维护一个集合的数据，并且可以同时对集合进行增删查改的操作。最主要的数据结构有两种：<code>哈希查找表（Hash table）</code>、<code>搜索树（Search tree）</code>。</p>
<p>哈希查找表用一个哈希函数将 key 分配到不同的桶（bucket，也就是数组的不同 index）。这样，开销主要在哈希函数的计算以及数组的常数访问时间。在很多场景下，哈希查找表的性能很高。</p>
<p>哈希查找表一般会存在“碰撞”的问题，就是说不同的 key 被哈希到了同一个 bucket。一般有两种应对方法：<code>链表法</code>和<code>开放地址法</code>。<code>链表法</code>将一个 bucket 实现成一个链表，落在同一个 bucket 中的 key 都会插入这个链表。<code>开放地址法</code>则是碰撞发生后，通过一定的规律，在数组的后面挑选“空位”，用来放置新的 key。</p>
<p>搜索树法一般采用自平衡搜索树，包括：AVL 树，红黑树。面试时经常会被问到，甚至被要求手写红黑树代码，很多时候，面试官自己都写不上来，非常过分。</p>
<p>自平衡搜索树法的最差搜索效率是 O(logN)，而哈希查找表最差是 O(N)。当然，哈希查找表的平均查找效率是 O(1)，如果哈希函数设计的很好，最坏的情况基本不会出现。还有一点，遍历自平衡搜索树，返回的 key 序列，一般会按照从小到大的顺序；而哈希查找表则是乱序的。</p>
<h2 id="为什么要用-map">为什么要用 map</h2>
<p>从 Go 语言官方博客摘录一段话：</p>
<blockquote>
<p>One of the most useful data structures in computer science is the hash table. Many hash table implementations exist with varying properties, but in general they offer fast lookups, adds, and deletes. Go provides a built-in map type that implements a hash table.</p>
</blockquote>
<p>hash table 是计算机数据结构中一个最重要的设计。大部分 hash table 都实现了快速查找、添加、删除的功能。Go 语言内置的 map 实现了上述所有功能。</p>
<p>很难想象写一个程序不使用 map，以至于在回答为什么要用 map 这个问题上犯了难。</p>
<p>所以，到底为什么要用 map 呢？因为它太强大了，各种增删查改的操作效率非常高。</p>
<h2 id="map-的底层如何实现">map 的底层如何实现</h2>
<p>首先声明我用的 Go 版本：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>go version go1.9.2 darwin/amd64
</span></span></code></pre></div><p>前面说了 map 实现的几种方案，Go 语言采用的是哈希查找表，并且使用链表解决哈希冲突。</p>
<p>接下来我们要探索 map 的核心原理，一窥它的内部结构。</p>
<h3 id="map-内存模型">map 内存模型</h3>
<p>在源码中，表示 map 的结构体是 hmap，它是 hashmap 的“缩写”：</p>
<pre tabindex="0"><code>// A header for a Go map.
type hmap struct {
    // 元素个数，调用 len(map) 时，直接返回此值
	count     int
	flags     uint8
	// buckets 的对数 log_2
	B         uint8
	// overflow 的 bucket 近似数
	noverflow uint16
	// 计算 key 的哈希的时候会传入哈希函数
	hash0     uint32
    // 指向 buckets 数组，大小为 2^B
    // 如果元素个数为0，就为 nil
	buckets    unsafe.Pointer
	// 扩容的时候，buckets 长度会是 oldbuckets 的两倍
	oldbuckets unsafe.Pointer
	// 指示扩容进度，小于此地址的 buckets 迁移完成
	nevacuate  uintptr
	extra *mapextra // optional fields
}
</code></pre><p>说明一下，<code>B</code> 是 buckets 数组的长度的对数，也就是说 buckets 数组的长度就是 2^B。bucket 里面存储了 key 和 value，后面会再讲。</p>
<p>buckets 是一个指针，最终它指向的是一个结构体：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">bmap</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">tophash</span> <span style="color:#111">[</span><span style="color:#75af00">bucketCnt</span><span style="color:#111">]</span><span style="color:#00a8c8">uint8</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>但这只是表面(src/runtime/hashmap.go)的结构，编译期间会给它加料，动态地创建一个新的结构：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">bmap</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">topbits</span>  <span style="color:#111">[</span><span style="color:#ae81ff">8</span><span style="color:#111">]</span><span style="color:#00a8c8">uint8</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">keys</span>     <span style="color:#111">[</span><span style="color:#ae81ff">8</span><span style="color:#111">]</span><span style="color:#75af00">keytype</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">values</span>   <span style="color:#111">[</span><span style="color:#ae81ff">8</span><span style="color:#111">]</span><span style="color:#75af00">valuetype</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">pad</span>      <span style="color:#00a8c8">uintptr</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">overflow</span> <span style="color:#00a8c8">uintptr</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p><code>bmap</code> 就是我们常说的“桶”，桶里面会最多装 8 个 key，这些 key 之所以会落入同一个桶，是因为它们经过哈希计算后，哈希结果是“一类”的。在桶内，又会根据 key 计算出来的 hash 值的高 8 位来决定 key 到底落入桶内的哪个位置（一个桶内最多有8个位置）。</p>
<p>来一个整体的图：</p>
<p><img src="/images/bc444966-b890-4be6-b1d8-9d2596d5d4ec.png" alt=""></p>
<p>当 map 的 key 和 value 都不是指针，并且 size 都小于 128 字节的情况下，会把 bmap 标记为不含指针，这样可以避免 gc 时扫描整个 hmap。但是，我们看 bmap 其实有一个 overflow 的字段，是指针类型的，破坏了 bmap 不含指针的设想，这时会把 overflow 移动到 extra 字段来。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">mapextra</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// overflow[0] contains overflow buckets for hmap.buckets.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// overflow[1] contains overflow buckets for hmap.oldbuckets.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">overflow</span> <span style="color:#111">[</span><span style="color:#ae81ff">2</span><span style="color:#111">]</span><span style="color:#f92672">*</span><span style="color:#111">[]</span><span style="color:#f92672">*</span><span style="color:#75af00">bmap</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// nextOverflow 包含空闲的 overflow bucket，这是预分配的 bucket</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">nextOverflow</span> <span style="color:#f92672">*</span><span style="color:#75af00">bmap</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>bmap 是存放 k-v 的地方，我们把视角拉近，仔细看 bmap 的内部组成。</p>
<p><img src="/images/ada04ce4-b4ec-4bb3-8add-e0d192f97184.png" alt=""></p>
<p>上图就是 bucket 的内存模型，<code>HOB Hash</code> 指的就是 top hash。 注意到 key 和 value 是各自放在一起的，并不是 <code>key/value/key/value/...</code> 这样的形式。源码里说明这样的好处是在某些情况下可以省略掉 padding 字段，节省内存空间。</p>
<p>例如，有这样一个类型的 map：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#00a8c8">int64</span><span style="color:#111">]</span><span style="color:#00a8c8">int8</span>
</span></span></code></pre></div><p>如果按照 <code>key/value/key/value/...</code> 这样的模式存储，那在每一个 key/value 对之后都要额外 padding 7 个字节；而将所有的 key，value 分别绑定到一起，这种形式 <code>key/key/.../value/value/...</code>，则只需要在最后添加 padding。</p>
<p>每个 bucket 设计成最多只能放 8 个 key-value 对，如果有第 9 个 key-value 落入当前的 bucket，那就需要再构建一个 bucket ，通过 <code>overflow</code> 指针连接起来。</p>
<h3 id="创建-map">创建 map</h3>
<p>从语法层面上来说，创建 map 很简单：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">ageMp</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#00a8c8">string</span><span style="color:#111">]</span><span style="color:#00a8c8">int</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 指定 map 长度</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">ageMp</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#00a8c8">string</span><span style="color:#111">]</span><span style="color:#00a8c8">int</span><span style="color:#111">,</span> <span style="color:#ae81ff">8</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// ageMp 为 nil，不能向其添加元素，会直接panic</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">var</span> <span style="color:#75af00">ageMp</span> <span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#00a8c8">string</span><span style="color:#111">]</span><span style="color:#00a8c8">int</span>
</span></span></code></pre></div><p>通过汇编语言可以看到，实际上底层调用的是 <code>makemap</code> 函数，主要做的工作就是初始化 <code>hmap</code> 结构体的各种字段，例如计算 B 的大小，设置哈希种子 hash0 等等。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">makemap</span><span style="color:#111">(</span><span style="color:#75af00">t</span> <span style="color:#f92672">*</span><span style="color:#75af00">maptype</span><span style="color:#111">,</span> <span style="color:#75af00">hint</span> <span style="color:#00a8c8">int64</span><span style="color:#111">,</span> <span style="color:#75af00">h</span> <span style="color:#f92672">*</span><span style="color:#75af00">hmap</span><span style="color:#111">,</span> <span style="color:#75af00">bucket</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">)</span> <span style="color:#f92672">*</span><span style="color:#75af00">hmap</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 省略各种条件检查...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 找到一个 B，使得 map 的装载因子在正常范围内</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">B</span> <span style="color:#f92672">:=</span> <span style="color:#111">uint8</span><span style="color:#111">(</span><span style="color:#ae81ff">0</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#111">;</span> <span style="color:#75af00">overLoadFactor</span><span style="color:#111">(</span><span style="color:#75af00">hint</span><span style="color:#111">,</span> <span style="color:#75af00">B</span><span style="color:#111">);</span> <span style="color:#75af00">B</span><span style="color:#f92672">++</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 初始化 hash table</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 如果 B 等于 0，那么 buckets 就会在赋值的时候再分配</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 如果长度比较大，分配内存会花费长一点</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">buckets</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">bucket</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">var</span> <span style="color:#75af00">extra</span> <span style="color:#f92672">*</span><span style="color:#75af00">mapextra</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">B</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">var</span> <span style="color:#75af00">nextOverflow</span> <span style="color:#f92672">*</span><span style="color:#75af00">bmap</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">buckets</span><span style="color:#111">,</span> <span style="color:#75af00">nextOverflow</span> <span style="color:#111">=</span> <span style="color:#75af00">makeBucketArray</span><span style="color:#111">(</span><span style="color:#75af00">t</span><span style="color:#111">,</span> <span style="color:#75af00">B</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">nextOverflow</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">extra</span> <span style="color:#111">=</span> <span style="color:#111">new</span><span style="color:#111">(</span><span style="color:#75af00">mapextra</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">extra</span><span style="color:#111">.</span><span style="color:#75af00">nextOverflow</span> <span style="color:#111">=</span> <span style="color:#75af00">nextOverflow</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 初始化 hamp</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">h</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">h</span> <span style="color:#111">=</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">hmap</span><span style="color:#111">)(</span><span style="color:#75af00">newobject</span><span style="color:#111">(</span><span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">hmap</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">count</span> <span style="color:#111">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">B</span> <span style="color:#111">=</span> <span style="color:#75af00">B</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">extra</span> <span style="color:#111">=</span> <span style="color:#75af00">extra</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">flags</span> <span style="color:#111">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">hash0</span> <span style="color:#111">=</span> <span style="color:#75af00">fastrand</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">buckets</span> <span style="color:#111">=</span> <span style="color:#75af00">buckets</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">oldbuckets</span> <span style="color:#111">=</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">nevacuate</span> <span style="color:#111">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">noverflow</span> <span style="color:#111">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">h</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>注意，这个函数返回的结果：<code>*hmap</code>，它是一个指针，而我们之前讲过的 <code>makeslice</code> 函数返回的是 <code>Slice</code> 结构体：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">makeslice</span><span style="color:#111">(</span><span style="color:#75af00">et</span> <span style="color:#f92672">*</span><span style="color:#75af00">_type</span><span style="color:#111">,</span> <span style="color:#75af00">len</span><span style="color:#111">,</span> <span style="color:#75af00">cap</span> <span style="color:#00a8c8">int</span><span style="color:#111">)</span> <span style="color:#75af00">slice</span>
</span></span></code></pre></div><p>回顾一下 slice 的结构体定义：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// runtime/slice.go</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">slice</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">array</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span> <span style="color:#75715e">// 元素指针</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">len</span>   <span style="color:#00a8c8">int</span> <span style="color:#75715e">// 长度 </span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">cap</span>   <span style="color:#00a8c8">int</span> <span style="color:#75715e">// 容量</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>结构体内部包含底层的数据指针。</p>
<p>makemap 和 makeslice 的区别，带来一个不同点：当 map 和 slice 作为函数参数时，在函数参数内部对 map 的操作会影响 map 自身；而对 slice 却不会（之前讲 slice 的文章里有讲过）。</p>
<p>主要原因：一个是指针（<code>*hmap</code>），一个是结构体（<code>slice</code>）。Go 语言中的函数传参都是值传递，在函数内部，参数会被 copy 到本地。<code>*hmap</code>指针 copy 完之后，仍然指向同一个 map，因此函数内部对 map 的操作会影响实参。而 slice 被 copy 后，会成为一个新的 slice，对它进行的操作不会影响到实参。</p>
<h3 id="哈希函数">哈希函数</h3>
<p>map 的一个关键点在于，哈希函数的选择。在程序启动时，会检测 cpu 是否支持 aes，如果支持，则使用 aes hash，否则使用 memhash。这是在函数 <code>alginit()</code> 中完成，位于路径：<code>src/runtime/alg.go</code> 下。</p>
<blockquote>
<p>hash 函数，有加密型和非加密型。 加密型的一般用于加密数据、数字摘要等，典型代表就是 md5、sha1、sha256、aes256 这种； 非加密型的一般就是查找。在 map 的应用场景中，用的是查找。 选择 hash 函数主要考察的是两点：性能、碰撞概率。</p>
</blockquote>
<p>之前我们讲过，表示类型的结构体：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">_type</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">size</span>       <span style="color:#00a8c8">uintptr</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ptrdata</span>    <span style="color:#00a8c8">uintptr</span> <span style="color:#75715e">// size of memory prefix holding all pointers</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">hash</span>       <span style="color:#00a8c8">uint32</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">tflag</span>      <span style="color:#75af00">tflag</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">align</span>      <span style="color:#00a8c8">uint8</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fieldalign</span> <span style="color:#00a8c8">uint8</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">kind</span>       <span style="color:#00a8c8">uint8</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">alg</span>        <span style="color:#f92672">*</span><span style="color:#75af00">typeAlg</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">gcdata</span>    <span style="color:#f92672">*</span><span style="color:#00a8c8">byte</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">str</span>       <span style="color:#75af00">nameOff</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ptrToThis</span> <span style="color:#75af00">typeOff</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>其中 <code>alg</code> 字段就和哈希相关，它是指向如下结构体的指针：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// src/runtime/alg.go</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">typeAlg</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// (ptr to object, seed) -&gt; hash</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">hash</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">,</span> <span style="color:#00a8c8">uintptr</span><span style="color:#111">)</span> <span style="color:#00a8c8">uintptr</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// (ptr to object A, ptr to object B) -&gt; ==?</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">equal</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">,</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">)</span> <span style="color:#00a8c8">bool</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>typeAlg 包含两个函数，hash 函数计算类型的哈希值，而 equal 函数则计算两个类型是否“哈希相等”。</p>
<p>对于 string 类型，它的 hash、equal 函数如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">strhash</span><span style="color:#111">(</span><span style="color:#75af00">a</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">,</span> <span style="color:#75af00">h</span> <span style="color:#00a8c8">uintptr</span><span style="color:#111">)</span> <span style="color:#00a8c8">uintptr</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">x</span> <span style="color:#f92672">:=</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">stringStruct</span><span style="color:#111">)(</span><span style="color:#75af00">a</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">memhash</span><span style="color:#111">(</span><span style="color:#75af00">x</span><span style="color:#111">.</span><span style="color:#75af00">str</span><span style="color:#111">,</span> <span style="color:#75af00">h</span><span style="color:#111">,</span> <span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">x</span><span style="color:#111">.</span><span style="color:#75af00">len</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">strequal</span><span style="color:#111">(</span><span style="color:#75af00">p</span><span style="color:#111">,</span> <span style="color:#75af00">q</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">)</span> <span style="color:#00a8c8">bool</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#f92672">*</span><span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#00a8c8">string</span><span style="color:#111">)(</span><span style="color:#75af00">p</span><span style="color:#111">)</span> <span style="color:#f92672">==</span> <span style="color:#f92672">*</span><span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#00a8c8">string</span><span style="color:#111">)(</span><span style="color:#75af00">q</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>根据 key 的类型，_type 结构体的 alg 字段会被设置对应类型的 hash 和 equal 函数。</p>
<h3 id="key-定位过程">key 定位过程</h3>
<p>key 经过哈希计算后得到哈希值，共 64 个 bit 位（64位机，32位机就不讨论了，现在主流都是64位机），计算它到底要落在哪个桶时，只会用到最后 B 个 bit 位。还记得前面提到过的 B 吗？如果 B = 5，那么桶的数量，也就是 buckets 数组的长度是 2^5 = 32。</p>
<p>例如，现在有一个 key 经过哈希函数计算后，得到的哈希结果是：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span> <span style="color:#ae81ff">10010111</span> <span style="color:#111">|</span> <span style="color:#ae81ff">000011110110110010001111001010100010010110010101010</span> │ <span style="color:#ae81ff">01010</span>
</span></span></code></pre></div><p>用最后的 5 个 bit 位，也就是 <code>01010</code>，值为 10，也就是 10 号桶。这个操作实际上就是取余操作，但是取余开销太大，所以代码实现上用的位操作代替。</p>
<p>再用哈希值的高 8 位，找到此 key 在 bucket 中的位置，这是在寻找已有的 key。最开始桶内还没有 key，新加入的 key 会找到第一个空位，放入。</p>
<p>buckets 编号就是桶编号，当两个不同的 key 落在同一个桶中，也就是发生了哈希冲突。冲突的解决手段是用链表法：在 bucket 中，从前往后找到第一个空位。这样，在查找某个 key 时，先找到对应的桶，再去遍历 bucket 中的 key。</p>
<p>这里参考曹大 github 博客里的一张图，原图是 ascii 图，geek 味十足，可以从参考资料找到曹大的博客，推荐大家去看看。</p>
<p><img src="/images/f2be4f24-de4f-451a-a8d5-98b3f6b005af.png" alt=""></p>
<p>上图中，假定 B = 5，所以 bucket 总数就是 2^5 = 32。首先计算出待查找 key 的哈希，使用低 5 位 <code>00110</code>，找到对应的 6 号 bucket，使用高 8 位 <code>10010111</code>，对应十进制 151，在 6 号 bucket 中寻找 tophash 值（HOB hash）为 151 的 key，找到了 2 号槽位，这样整个查找过程就结束了。</p>
<p>如果在 bucket 中没找到，并且 overflow 不为空，还要继续去 overflow bucket 中寻找，直到找到或是所有的 key 槽位都找遍了，包括所有的 overflow bucket。</p>
<p>我们来看下源码吧，哈哈！通过汇编语言可以看到，查找某个 key 的底层函数是 <code>mapacess</code> 系列函数，函数的作用类似，区别在下一节会讲到。这里我们直接看 <code>mapacess1</code> 函数：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">mapaccess1</span><span style="color:#111">(</span><span style="color:#75af00">t</span> <span style="color:#f92672">*</span><span style="color:#75af00">maptype</span><span style="color:#111">,</span> <span style="color:#75af00">h</span> <span style="color:#f92672">*</span><span style="color:#75af00">hmap</span><span style="color:#111">,</span> <span style="color:#75af00">key</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">)</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ……</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 如果 h 什么都没有，返回零值</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">h</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#f92672">||</span> <span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">count</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">zeroVal</span><span style="color:#111">[</span><span style="color:#ae81ff">0</span><span style="color:#111">])</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 写和读冲突</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">flags</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">hashWriting</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">throw</span><span style="color:#111">(</span><span style="color:#d88200">&#34;concurrent map read and map write&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 不同类型 key 使用的 hash 算法在编译期确定</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">alg</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">key</span><span style="color:#111">.</span><span style="color:#75af00">alg</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 计算哈希值，并且加入 hash0 引入随机性</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">hash</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">alg</span><span style="color:#111">.</span><span style="color:#75af00">hash</span><span style="color:#111">(</span><span style="color:#75af00">key</span><span style="color:#111">,</span> <span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">hash0</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 比如 B=5，那 m 就是31，二进制是全 1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 求 bucket num 时，将 hash 与 m 相与，</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 达到 bucket num 由 hash 的低 8 位决定的效果</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">m</span> <span style="color:#f92672">:=</span> <span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span><span style="color:#f92672">&lt;&lt;</span><span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">B</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// b 就是 bucket 的地址</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">b</span> <span style="color:#f92672">:=</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">bmap</span><span style="color:#111">)(</span><span style="color:#75af00">add</span><span style="color:#111">(</span><span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">buckets</span><span style="color:#111">,</span> <span style="color:#111">(</span><span style="color:#75af00">hash</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">m</span><span style="color:#111">)</span><span style="color:#f92672">*</span><span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">bucketsize</span><span style="color:#111">)))</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// oldbuckets 不为 nil，说明发生了扩容</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">c</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">oldbuckets</span><span style="color:#111">;</span> <span style="color:#75af00">c</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	    <span style="color:#75715e">// 如果不是同 size 扩容（看后面扩容的内容）</span>
</span></span><span style="display:flex;"><span>	    <span style="color:#75715e">// 对应条件 1 的解决方案</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">sameSizeGrow</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 新 bucket 数量是老的 2 倍</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">m</span> <span style="color:#f92672">&gt;&gt;=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 求出 key 在老的 map 中的 bucket 位置</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">oldb</span> <span style="color:#f92672">:=</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">bmap</span><span style="color:#111">)(</span><span style="color:#75af00">add</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">,</span> <span style="color:#111">(</span><span style="color:#75af00">hash</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">m</span><span style="color:#111">)</span><span style="color:#f92672">*</span><span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">bucketsize</span><span style="color:#111">)))</span>
</span></span><span style="display:flex;"><span>		
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 如果 oldb 没有搬迁到新的 bucket</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 那就在老的 bucket 中寻找</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">evacuated</span><span style="color:#111">(</span><span style="color:#75af00">oldb</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">b</span> <span style="color:#111">=</span> <span style="color:#75af00">oldb</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 计算出高 8 位的 hash</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 相当于右移 56 位，只取高8位</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">top</span> <span style="color:#f92672">:=</span> <span style="color:#111">uint8</span><span style="color:#111">(</span><span style="color:#75af00">hash</span> <span style="color:#f92672">&gt;&gt;</span> <span style="color:#111">(</span><span style="color:#75af00">sys</span><span style="color:#111">.</span><span style="color:#75af00">PtrSize</span><span style="color:#f92672">*</span><span style="color:#ae81ff">8</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">8</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 增加一个 minTopHash</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">top</span> <span style="color:#111">&lt;</span> <span style="color:#75af00">minTopHash</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">top</span> <span style="color:#f92672">+=</span> <span style="color:#75af00">minTopHash</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	    <span style="color:#75715e">// 遍历 8 个 bucket</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">for</span> <span style="color:#75af00">i</span> <span style="color:#f92672">:=</span> <span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#ae81ff">0</span><span style="color:#111">);</span> <span style="color:#75af00">i</span> <span style="color:#111">&lt;</span> <span style="color:#75af00">bucketCnt</span><span style="color:#111">;</span> <span style="color:#75af00">i</span><span style="color:#f92672">++</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		    <span style="color:#75715e">// tophash 不匹配，继续</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">tophash</span><span style="color:#111">[</span><span style="color:#75af00">i</span><span style="color:#111">]</span> <span style="color:#f92672">!=</span> <span style="color:#75af00">top</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">continue</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// tophash 匹配，定位到 key 的位置</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">k</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">add</span><span style="color:#111">(</span><span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">(</span><span style="color:#75af00">b</span><span style="color:#111">),</span> <span style="color:#75af00">dataOffset</span><span style="color:#f92672">+</span><span style="color:#75af00">i</span><span style="color:#f92672">*</span><span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">keysize</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// key 是指针</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">indirectkey</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			    <span style="color:#75715e">// 解引用</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">k</span> <span style="color:#111">=</span> <span style="color:#f92672">*</span><span style="color:#111">((</span><span style="color:#f92672">*</span><span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">)(</span><span style="color:#75af00">k</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 如果 key 相等</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">alg</span><span style="color:#111">.</span><span style="color:#75af00">equal</span><span style="color:#111">(</span><span style="color:#75af00">key</span><span style="color:#111">,</span> <span style="color:#75af00">k</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			    <span style="color:#75715e">// 定位到 value 的位置</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">v</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">add</span><span style="color:#111">(</span><span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">(</span><span style="color:#75af00">b</span><span style="color:#111">),</span> <span style="color:#75af00">dataOffset</span><span style="color:#f92672">+</span><span style="color:#75af00">bucketCnt</span><span style="color:#f92672">*</span><span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">keysize</span><span style="color:#111">)</span><span style="color:#f92672">+</span><span style="color:#75af00">i</span><span style="color:#f92672">*</span><span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">valuesize</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// value 解引用</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">if</span> <span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">indirectvalue</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">v</span> <span style="color:#111">=</span> <span style="color:#f92672">*</span><span style="color:#111">((</span><span style="color:#f92672">*</span><span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">)(</span><span style="color:#75af00">v</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>				<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">return</span> <span style="color:#75af00">v</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// bucket 找完（还没找到），继续到 overflow bucket 里找</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">b</span> <span style="color:#111">=</span> <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">overflow</span><span style="color:#111">(</span><span style="color:#75af00">t</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// overflow bucket 也找完了，说明没有目标 key</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 返回零值</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">b</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">zeroVal</span><span style="color:#111">[</span><span style="color:#ae81ff">0</span><span style="color:#111">])</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>函数返回 h[key] 的指针，如果 h 中没有此 key，那就会返回一个 key 相应类型的零值，不会返回 nil。</p>
<p>代码整体比较直接，没什么难懂的地方。跟着上面的注释一步步理解就好了。</p>
<p>这里，说一下定位 key 和 value 的方法以及整个循环的写法。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// key 定位公式</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">k</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">add</span><span style="color:#111">(</span><span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">(</span><span style="color:#75af00">b</span><span style="color:#111">),</span> <span style="color:#75af00">dataOffset</span><span style="color:#f92672">+</span><span style="color:#75af00">i</span><span style="color:#f92672">*</span><span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">keysize</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// value 定位公式</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">v</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">add</span><span style="color:#111">(</span><span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">(</span><span style="color:#75af00">b</span><span style="color:#111">),</span> <span style="color:#75af00">dataOffset</span><span style="color:#f92672">+</span><span style="color:#75af00">bucketCnt</span><span style="color:#f92672">*</span><span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">keysize</span><span style="color:#111">)</span><span style="color:#f92672">+</span><span style="color:#75af00">i</span><span style="color:#f92672">*</span><span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">valuesize</span><span style="color:#111">))</span>
</span></span></code></pre></div><p>b 是 bmap 的地址，这里 bmap 还是源码里定义的结构体，只包含一个 tophash 数组，经编译器扩充之后的结构体才包含 key，value，overflow 这些字段。dataOffset 是 key 相对于 bmap 起始地址的偏移：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">dataOffset</span> <span style="color:#111">=</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Offsetof</span><span style="color:#111">(</span><span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">b</span> <span style="color:#75af00">bmap</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">v</span> <span style="color:#00a8c8">int64</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}{}.</span><span style="color:#75af00">v</span><span style="color:#111">)</span>
</span></span></code></pre></div><p>因此 bucket 里 key 的起始地址就是 unsafe.Pointer(b)+dataOffset。第 i 个 key 的地址就要在此基础上跨过 i 个 key 的大小；而我们又知道，value 的地址是在所有 key 之后，因此第 i 个 value 的地址还需要加上所有 key 的偏移。理解了这些，上面 key 和 value 的定位公式就很好理解了。</p>
<p>再说整个大循环的写法，最外层是一个无限循环，通过</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">b</span> <span style="color:#111">=</span> <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">overflow</span><span style="color:#111">(</span><span style="color:#75af00">t</span><span style="color:#111">)</span>
</span></span></code></pre></div><p>遍历所有的 bucket，这相当于是一个 bucket 链表。</p>
<p>当定位到一个具体的 bucket 时，里层循环就是遍历这个 bucket 里所有的 cell，或者说所有的槽位，也就是 bucketCnt=8 个槽位。整个循环过程：</p>
<p><img src="/images/a9cc075b-aa24-4fab-8eb4-1061f4264fca.png" alt=""></p>
<p>再说一下 minTopHash，当一个 cell 的 tophash 值小于 minTopHash 时，标志这个 cell 的迁移状态。因为这个状态值是放在 tophash 数组里，为了和正常的哈希值区分开，会给 key 计算出来的哈希值一个增量：minTopHash。这样就能区分正常的 top hash 值和表示状态的哈希值。</p>
<p>下面的这几种状态就表征了 bucket 的情况：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// 空的 cell，也是初始时 bucket 的状态</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">empty</span>          <span style="color:#111">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 空的 cell，表示 cell 已经被迁移到新的 bucket</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">evacuatedEmpty</span> <span style="color:#111">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// key,value 已经搬迁完毕，但是 key 都在新 bucket 前半部分，</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 后面扩容部分会再讲到。</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">evacuatedX</span>     <span style="color:#111">=</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 同上，key 在后半部分</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">evacuatedY</span>     <span style="color:#111">=</span> <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// tophash 的最小正常值</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">minTopHash</span>     <span style="color:#111">=</span> <span style="color:#ae81ff">4</span>
</span></span></code></pre></div><p>源码里判断这个 bucket 是否已经搬迁完毕，用到的函数：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">evacuated</span><span style="color:#111">(</span><span style="color:#75af00">b</span> <span style="color:#f92672">*</span><span style="color:#75af00">bmap</span><span style="color:#111">)</span> <span style="color:#00a8c8">bool</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">h</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">tophash</span><span style="color:#111">[</span><span style="color:#ae81ff">0</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">h</span> <span style="color:#111">&gt;</span> <span style="color:#75af00">empty</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">h</span> <span style="color:#111">&lt;</span> <span style="color:#75af00">minTopHash</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>只取了 tophash 数组的第一个值，判断它是否在 0-4 之间。对比上面的常量，当 top hash 是 <code>evacuatedEmpty</code>、<code>evacuatedX</code>、<code>evacuatedY</code> 这三个值之一，说明此 bucket 中的 key 全部被搬迁到了新 bucket。</p>
<h3 id="map-的两种-get-操作">map 的两种 get 操作</h3>
<p>Go 语言中读取 map 有两种语法：带 comma 和 不带 comma。当要查询的 key 不在 map 里，带 comma 的用法会返回一个 bool 型变量提示 key 是否在 map 中；而不带 comma 的语句则会返回一个 value 类型的零值。如果 value 是 int 型就会返回 0，如果 value 是 string 类型，就会返回空字符串。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ageMap</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#00a8c8">string</span><span style="color:#111">]</span><span style="color:#00a8c8">int</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ageMap</span><span style="color:#111">[</span><span style="color:#d88200">&#34;qcrao&#34;</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#ae81ff">18</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 不带 comma 用法</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">age1</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">ageMap</span><span style="color:#111">[</span><span style="color:#d88200">&#34;stefno&#34;</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">age1</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 带 comma 用法</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">age2</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">ageMap</span><span style="color:#111">[</span><span style="color:#d88200">&#34;stefno&#34;</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">age2</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>运行结果：</p>
<pre tabindex="0"><code>0
0 false
</code></pre><p>以前一直觉得好神奇，怎么实现的？这其实是编译器在背后做的工作：分析代码后，将两种语法对应到底层两个不同的函数。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// src/runtime/hashmap.go</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">mapaccess1</span><span style="color:#111">(</span><span style="color:#75af00">t</span> <span style="color:#f92672">*</span><span style="color:#75af00">maptype</span><span style="color:#111">,</span> <span style="color:#75af00">h</span> <span style="color:#f92672">*</span><span style="color:#75af00">hmap</span><span style="color:#111">,</span> <span style="color:#75af00">key</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">)</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">mapaccess2</span><span style="color:#111">(</span><span style="color:#75af00">t</span> <span style="color:#f92672">*</span><span style="color:#75af00">maptype</span><span style="color:#111">,</span> <span style="color:#75af00">h</span> <span style="color:#f92672">*</span><span style="color:#75af00">hmap</span><span style="color:#111">,</span> <span style="color:#75af00">key</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">,</span> <span style="color:#00a8c8">bool</span><span style="color:#111">)</span>
</span></span></code></pre></div><p>源码里，函数命名不拘小节，直接带上后缀 1，2，完全不理会《代码大全》里的那一套命名的做法。从上面两个函数的声明也可以看出差别了，<code>mapaccess2</code> 函数返回值多了一个 bool 型变量，两者的代码也是完全一样的，只是在返回值后面多加了一个 false 或者 true。</p>
<p>另外，根据 key 的不同类型，编译器还会将查找、插入、删除的函数用更具体的函数替换，以优化效率：</p>
<table>
  <thead>
      <tr>
          <th>key 类型</th>
          <th>查找</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>uint32</td>
          <td>mapaccess1_fast32(t *maptype, h *hmap, key uint32) unsafe.Pointer</td>
      </tr>
      <tr>
          <td>uint32</td>
          <td>mapaccess2_fast32(t *maptype, h *hmap, key uint32) (unsafe.Pointer, bool)</td>
      </tr>
      <tr>
          <td>uint64</td>
          <td>mapaccess1_fast64(t *maptype, h *hmap, key uint64) unsafe.Pointer</td>
      </tr>
      <tr>
          <td>uint64</td>
          <td>mapaccess2_fast64(t *maptype, h *hmap, key uint64) (unsafe.Pointer, bool)</td>
      </tr>
      <tr>
          <td>string</td>
          <td>mapaccess1_faststr(t *maptype, h *hmap, ky string) unsafe.Pointer</td>
      </tr>
      <tr>
          <td>string</td>
          <td>mapaccess2_faststr(t *maptype, h *hmap, ky string) (unsafe.Pointer, bool)</td>
      </tr>
  </tbody>
</table>
<p>这些函数的参数类型直接是具体的 uint32、unt64、string，在函数内部由于提前知晓了 key 的类型，所以内存布局是很清楚的，因此能节省很多操作，提高效率。</p>
<p>上面这些函数都是在文件 <code>src/runtime/hashmap_fast.go</code> 里。</p>
<h3 id="如何进行扩容">如何进行扩容</h3>
<p>使用哈希表的目的就是要快速查找到目标 key，然而，随着向 map 中添加的 key 越来越多，key 发生碰撞的概率也越来越大。bucket 中的 8 个 cell 会被逐渐塞满，查找、插入、删除 key 的效率也会越来越低。最理想的情况是一个 bucket 只装一个 key，这样，就能达到 <code>O(1)</code> 的效率，但这样空间消耗太大，用空间换时间的代价太高。</p>
<p>Go 语言采用一个 bucket 里装载 8 个 key，定位到某个 bucket 后，还需要再定位到具体的 key，这实际上又用了时间换空间。</p>
<p>当然，这样做，要有一个度，不然所有的 key 都落在了同一个 bucket 里，直接退化成了链表，各种操作的效率直接降为 O(n)，是不行的。</p>
<p>因此，需要有一个指标来衡量前面描述的情况，这就是<code>装载因子</code>。Go 源码里这样定义 <code>装载因子</code>：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">loadFactor</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">count</span> <span style="color:#f92672">/</span> <span style="color:#111">(</span><span style="color:#ae81ff">2</span><span style="color:#111">^</span><span style="color:#75af00">B</span><span style="color:#111">)</span>
</span></span></code></pre></div><p>count 就是 map 的元素个数，2^B 表示 bucket 数量。</p>
<p>再来说触发 map 扩容的时机：在向 map 插入新 key 的时候，会进行条件检测，符合下面这 2 个条件，就会触发扩容：</p>
<ol>
<li>装载因子超过阈值，源码里定义的阈值是 6.5。</li>
<li>overflow 的 bucket 数量过多：当 B 小于 15，也就是 bucket 总数 2^B 小于 2^15 时，如果 overflow 的 bucket 数量超过 2^B；当 B &gt;= 15，也就是 bucket 总数 2^B 大于等于 2^15，如果 overflow 的 bucket 数量超过 2^15。</li>
</ol>
<p>通过汇编语言可以找到赋值操作对应源码中的函数是 <code>mapassign</code>，对应扩容条件的源码如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// src/runtime/hashmap.go/mapassign</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 触发扩容时机</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">growing</span><span style="color:#111">()</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#111">(</span><span style="color:#75af00">overLoadFactor</span><span style="color:#111">(</span><span style="color:#111">int64</span><span style="color:#111">(</span><span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">count</span><span style="color:#111">),</span> <span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">B</span><span style="color:#111">)</span> <span style="color:#f92672">||</span> <span style="color:#75af00">tooManyOverflowBuckets</span><span style="color:#111">(</span><span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">noverflow</span><span style="color:#111">,</span> <span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">B</span><span style="color:#111">))</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">hashGrow</span><span style="color:#111">(</span><span style="color:#75af00">t</span><span style="color:#111">,</span> <span style="color:#75af00">h</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 装载因子超过 6.5</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">overLoadFactor</span><span style="color:#111">(</span><span style="color:#75af00">count</span> <span style="color:#00a8c8">int64</span><span style="color:#111">,</span> <span style="color:#75af00">B</span> <span style="color:#00a8c8">uint8</span><span style="color:#111">)</span> <span style="color:#00a8c8">bool</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">count</span> <span style="color:#f92672">&gt;=</span> <span style="color:#75af00">bucketCnt</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#111">float32</span><span style="color:#111">(</span><span style="color:#75af00">count</span><span style="color:#111">)</span> <span style="color:#f92672">&gt;=</span> <span style="color:#75af00">loadFactor</span><span style="color:#f92672">*</span><span style="color:#111">float32</span><span style="color:#111">((</span><span style="color:#111">uint64</span><span style="color:#111">(</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span><span style="color:#f92672">&lt;&lt;</span><span style="color:#75af00">B</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// overflow buckets 太多</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">tooManyOverflowBuckets</span><span style="color:#111">(</span><span style="color:#75af00">noverflow</span> <span style="color:#00a8c8">uint16</span><span style="color:#111">,</span> <span style="color:#75af00">B</span> <span style="color:#00a8c8">uint8</span><span style="color:#111">)</span> <span style="color:#00a8c8">bool</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">B</span> <span style="color:#111">&lt;</span> <span style="color:#ae81ff">16</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">noverflow</span> <span style="color:#f92672">&gt;=</span> <span style="color:#111">uint16</span><span style="color:#111">(</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span><span style="color:#f92672">&lt;&lt;</span><span style="color:#75af00">B</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">noverflow</span> <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">&lt;&lt;</span><span style="color:#ae81ff">15</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>解释一下：</p>
<p>第 1 点：我们知道，每个 bucket 有 8 个空位，在没有溢出，且所有的桶都装满了的情况下，装载因子算出来的结果是 8。因此当装载因子超过 6.5 时，表明很多 bucket 都快要装满了，查找效率和插入效率都变低了。在这个时候进行扩容是有必要的。</p>
<p>第 2 点：是对第 1 点的补充。就是说在装载因子比较小的情况下，这时候 map 的查找和插入效率也很低，而第 1 点识别不出来这种情况。表面现象就是计算装载因子的分子比较小，即 map 里元素总数少，但是 bucket 数量多（真实分配的 bucket 数量多，包括大量的 overflow bucket）。</p>
<p>不难想像造成这种情况的原因：不停地插入、删除元素。先插入很多元素，导致创建了很多 bucket，但是装载因子达不到第 1 点的临界值，未触发扩容来缓解这种情况。之后，删除元素降低元素总数量，再插入很多元素，导致创建很多的 overflow bucket，但就是不会触犯第 1 点的规定，你能拿我怎么办？overflow bucket 数量太多，导致 key 会很分散，查找插入效率低得吓人，因此出台第 2 点规定。这就像是一座空城，房子很多，但是住户很少，都分散了，找起人来很困难。</p>
<p>对于命中条件 1，2 的限制，都会发生扩容。但是扩容的策略并不相同，毕竟两种条件应对的场景不同。</p>
<p>对于条件 1，元素太多，而 bucket 数量太少，很简单：将 B 加 1，bucket 最大数量（2^B）直接变成原来 bucket 数量的 2 倍。于是，就有新老 bucket 了。注意，这时候元素都在老 bucket 里，还没迁移到新的 bucket 来。而且，新 bucket 只是最大数量变为原来最大数量（2^B）的 2 倍（2^B * 2）。</p>
<p>对于条件 2，其实元素没那么多，但是 overflow bucket 数特别多，说明很多 bucket 都没装满。解决办法就是开辟一个新 bucket 空间，将老 bucket 中的元素移动到新 bucket，使得同一个 bucket 中的 key 排列地更紧密。这样，原来，在 overflow bucket 中的 key 可以移动到 bucket 中来。结果是节省空间，提高 bucket 利用率，map 的查找和插入效率自然就会提升。</p>
<p>对于条件 2 的解决方案，曹大的博客里还提出了一个极端的情况：如果插入 map 的 key 哈希都一样，就会落到同一个 bucket 里，超过 8 个就会产生 overflow bucket，结果也会造成 overflow bucket 数过多。移动元素其实解决不了问题，因为这时整个哈希表已经退化成了一个链表，操作效率变成了 <code>O(n)</code>。</p>
<p>再来看一下扩容具体是怎么做的。由于 map 扩容需要将原有的 key/value 重新搬迁到新的内存地址，如果有大量的 key/value 需要搬迁，会非常影响性能。因此 Go map 的扩容采取了一种称为“渐进式”地方式，原有的 key 并不会一次性搬迁完毕，每次最多只会搬迁 2 个 bucket。</p>
<p>上面说的 <code>hashGrow()</code> 函数实际上并没有真正地“搬迁”，它只是分配好了新的 buckets，并将老的 buckets 挂到了 oldbuckets 字段上。真正搬迁 buckets 的动作在 <code>growWork()</code> 函数中，而调用 <code>growWork()</code> 函数的动作是在 mapassign 和 mapdelete 函数中。也就是插入或修改、删除 key 的时候，都会尝试进行搬迁 buckets 的工作。先检查 oldbuckets 是否搬迁完毕，具体来说就是检查 oldbuckets 是否为 nil。</p>
<p>我们先看 <code>hashGrow()</code> 函数所做的工作，再来看具体的搬迁 buckets 是如何进行的。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">hashGrow</span><span style="color:#111">(</span><span style="color:#75af00">t</span> <span style="color:#f92672">*</span><span style="color:#75af00">maptype</span><span style="color:#111">,</span> <span style="color:#75af00">h</span> <span style="color:#f92672">*</span><span style="color:#75af00">hmap</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// B+1 相当于是原来 2 倍的空间</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">bigger</span> <span style="color:#f92672">:=</span> <span style="color:#111">uint8</span><span style="color:#111">(</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 对应条件 2</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">overLoadFactor</span><span style="color:#111">(</span><span style="color:#111">int64</span><span style="color:#111">(</span><span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">count</span><span style="color:#111">),</span> <span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">B</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 进行等量的内存扩容，所以 B 不变</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">bigger</span> <span style="color:#111">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">flags</span> <span style="color:#f92672">|=</span> <span style="color:#75af00">sameSizeGrow</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 将老 buckets 挂到 buckets 上</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">oldbuckets</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">buckets</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 申请新的 buckets 空间</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">newbuckets</span><span style="color:#111">,</span> <span style="color:#75af00">nextOverflow</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">makeBucketArray</span><span style="color:#111">(</span><span style="color:#75af00">t</span><span style="color:#111">,</span> <span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">B</span><span style="color:#f92672">+</span><span style="color:#75af00">bigger</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">flags</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">flags</span> <span style="color:#f92672">&amp;^</span> <span style="color:#111">(</span><span style="color:#75af00">iterator</span> <span style="color:#111">|</span> <span style="color:#75af00">oldIterator</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">flags</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">iterator</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">flags</span> <span style="color:#f92672">|=</span> <span style="color:#75af00">oldIterator</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 提交 grow 的动作</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">B</span> <span style="color:#f92672">+=</span> <span style="color:#75af00">bigger</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">flags</span> <span style="color:#111">=</span> <span style="color:#75af00">flags</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">oldbuckets</span> <span style="color:#111">=</span> <span style="color:#75af00">oldbuckets</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">buckets</span> <span style="color:#111">=</span> <span style="color:#75af00">newbuckets</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 搬迁进度为 0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">nevacuate</span> <span style="color:#111">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// overflow buckets 数为 0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">noverflow</span> <span style="color:#111">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ……</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>主要是申请到了新的 buckets 空间，把相关的标志位都进行了处理：例如标志 nevacuate 被置为 0， 表示当前搬迁进度为 0。</p>
<p>值得一说的是对 <code>h.flags</code> 的处理：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">flags</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">flags</span> <span style="color:#f92672">&amp;^</span> <span style="color:#111">(</span><span style="color:#75af00">iterator</span> <span style="color:#111">|</span> <span style="color:#75af00">oldIterator</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">flags</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">iterator</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">flags</span> <span style="color:#f92672">|=</span> <span style="color:#75af00">oldIterator</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>这里得先说下运算符：&amp;^。这叫<code>按位置 0</code>运算符。例如：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">x</span> <span style="color:#111">=</span> <span style="color:#ae81ff">01010011</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">y</span> <span style="color:#111">=</span> <span style="color:#ae81ff">01010100</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">z</span> <span style="color:#111">=</span> <span style="color:#75af00">x</span> <span style="color:#f92672">&amp;^</span> <span style="color:#75af00">y</span> <span style="color:#111">=</span> <span style="color:#ae81ff">00000011</span>
</span></span></code></pre></div><p>如果 y bit 位为 1，那么结果 z 对应 bit 位就为 0，否则 z 对应 bit 位就和 x 对应 bit 位的值相同。</p>
<p>所以上面那段对 flags 一顿操作的代码的意思是：先把 h.flags 中 iterator 和 oldIterator 对应位清 0，然后如果发现 iterator 位为 1，那就把它转接到 oldIterator 位，使得 oldIterator 标志位变成 1。潜台词就是：buckets 现在挂到了 oldBuckets 名下了，对应的标志位也转接过去吧。</p>
<p>几个标志位如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// 可能有迭代器使用 buckets</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">iterator</span>     <span style="color:#111">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 可能有迭代器使用 oldbuckets</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">oldIterator</span>  <span style="color:#111">=</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 有协程正在向 map 中写入 key</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">hashWriting</span>  <span style="color:#111">=</span> <span style="color:#ae81ff">4</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 等量扩容（对应条件 2）</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">sameSizeGrow</span> <span style="color:#111">=</span> <span style="color:#ae81ff">8</span>
</span></span></code></pre></div><p>再来看看真正执行搬迁工作的 growWork() 函数。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">growWork</span><span style="color:#111">(</span><span style="color:#75af00">t</span> <span style="color:#f92672">*</span><span style="color:#75af00">maptype</span><span style="color:#111">,</span> <span style="color:#75af00">h</span> <span style="color:#f92672">*</span><span style="color:#75af00">hmap</span><span style="color:#111">,</span> <span style="color:#75af00">bucket</span> <span style="color:#00a8c8">uintptr</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 确认搬迁老的 bucket 对应正在使用的 bucket</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">evacuate</span><span style="color:#111">(</span><span style="color:#75af00">t</span><span style="color:#111">,</span> <span style="color:#75af00">h</span><span style="color:#111">,</span> <span style="color:#75af00">bucket</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">oldbucketmask</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 再搬迁一个 bucket，以加快搬迁进程</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">growing</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">evacuate</span><span style="color:#111">(</span><span style="color:#75af00">t</span><span style="color:#111">,</span> <span style="color:#75af00">h</span><span style="color:#111">,</span> <span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">nevacuate</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>h.growing() 函数非常简单：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">h</span> <span style="color:#f92672">*</span><span style="color:#75af00">hmap</span><span style="color:#111">)</span> <span style="color:#75af00">growing</span><span style="color:#111">()</span> <span style="color:#00a8c8">bool</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">oldbuckets</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>如果 <code>oldbuckets</code> 不为空，说明还没有搬迁完毕，还得继续搬。</p>
<p><code>bucket&amp;h.oldbucketmask()</code> 这行代码，如源码注释里说的，是为了确认搬迁的 bucket 是我们正在使用的 bucket。<code>oldbucketmask()</code> 函数返回扩容前的 map 的 bucketmask。</p>
<p>所谓的 bucketmask，作用就是将 key 计算出来的哈希值与 bucketmask 相与，得到的结果就是 key 应该落入的桶。比如 B = 5，那么 bucketmask 的低 5 位是 <code>11111</code>，其余位是 <code>0</code>，hash 值与其相与的意思是，只有 hash 值的低 5 位决策 key 到底落入哪个 bucket。</p>
<p>接下来，我们集中所有的精力在搬迁的关键函数 evacuate。源码贴在下面，不要紧张，我会加上大面积的注释，通过注释绝对是能看懂的。之后，我会再对搬迁过程作详细说明。</p>
<p>源码如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">evacuate</span><span style="color:#111">(</span><span style="color:#75af00">t</span> <span style="color:#f92672">*</span><span style="color:#75af00">maptype</span><span style="color:#111">,</span> <span style="color:#75af00">h</span> <span style="color:#f92672">*</span><span style="color:#75af00">hmap</span><span style="color:#111">,</span> <span style="color:#75af00">oldbucket</span> <span style="color:#00a8c8">uintptr</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 定位老的 bucket 地址</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">b</span> <span style="color:#f92672">:=</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">bmap</span><span style="color:#111">)(</span><span style="color:#75af00">add</span><span style="color:#111">(</span><span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">oldbuckets</span><span style="color:#111">,</span> <span style="color:#75af00">oldbucket</span><span style="color:#f92672">*</span><span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">bucketsize</span><span style="color:#111">)))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 结果是 2^B，如 B = 5，结果为32</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">newbit</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">noldbuckets</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// key 的哈希函数</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">alg</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">key</span><span style="color:#111">.</span><span style="color:#75af00">alg</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 如果 b 没有被搬迁过</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">evacuated</span><span style="color:#111">(</span><span style="color:#75af00">b</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">var</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 表示bucket 移动的目标地址</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">x</span><span style="color:#111">,</span> <span style="color:#75af00">y</span>   <span style="color:#f92672">*</span><span style="color:#75af00">bmap</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 指向 x,y 中的 key/val</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">xi</span><span style="color:#111">,</span> <span style="color:#75af00">yi</span> <span style="color:#00a8c8">int</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 指向 x，y 中的 key</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">xk</span><span style="color:#111">,</span> <span style="color:#75af00">yk</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 指向 x，y 中的 value</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">xv</span><span style="color:#111">,</span> <span style="color:#75af00">yv</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 默认是等 size 扩容，前后 bucket 序号不变</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 使用 x 来进行搬迁</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">x</span> <span style="color:#111">=</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">bmap</span><span style="color:#111">)(</span><span style="color:#75af00">add</span><span style="color:#111">(</span><span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">buckets</span><span style="color:#111">,</span> <span style="color:#75af00">oldbucket</span><span style="color:#f92672">*</span><span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">bucketsize</span><span style="color:#111">)))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">xi</span> <span style="color:#111">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">xk</span> <span style="color:#111">=</span> <span style="color:#75af00">add</span><span style="color:#111">(</span><span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">(</span><span style="color:#75af00">x</span><span style="color:#111">),</span> <span style="color:#75af00">dataOffset</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">xv</span> <span style="color:#111">=</span> <span style="color:#75af00">add</span><span style="color:#111">(</span><span style="color:#75af00">xk</span><span style="color:#111">,</span> <span style="color:#75af00">bucketCnt</span><span style="color:#f92672">*</span><span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">keysize</span><span style="color:#111">))</span><span style="color:#960050;background-color:#1e0010">、</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 如果不是等 size 扩容，前后 bucket 序号有变</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 使用 y 来进行搬迁</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">sameSizeGrow</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// y 代表的 bucket 序号增加了 2^B</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">y</span> <span style="color:#111">=</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">bmap</span><span style="color:#111">)(</span><span style="color:#75af00">add</span><span style="color:#111">(</span><span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">buckets</span><span style="color:#111">,</span> <span style="color:#111">(</span><span style="color:#75af00">oldbucket</span><span style="color:#f92672">+</span><span style="color:#75af00">newbit</span><span style="color:#111">)</span><span style="color:#f92672">*</span><span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">bucketsize</span><span style="color:#111">)))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">yi</span> <span style="color:#111">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">yk</span> <span style="color:#111">=</span> <span style="color:#75af00">add</span><span style="color:#111">(</span><span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">(</span><span style="color:#75af00">y</span><span style="color:#111">),</span> <span style="color:#75af00">dataOffset</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">yv</span> <span style="color:#111">=</span> <span style="color:#75af00">add</span><span style="color:#111">(</span><span style="color:#75af00">yk</span><span style="color:#111">,</span> <span style="color:#75af00">bucketCnt</span><span style="color:#f92672">*</span><span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">keysize</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 遍历所有的 bucket，包括 overflow buckets</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// b 是老的 bucket 地址</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">for</span> <span style="color:#111">;</span> <span style="color:#75af00">b</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span><span style="color:#111">;</span> <span style="color:#75af00">b</span> <span style="color:#111">=</span> <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">overflow</span><span style="color:#111">(</span><span style="color:#75af00">t</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">k</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">add</span><span style="color:#111">(</span><span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">(</span><span style="color:#75af00">b</span><span style="color:#111">),</span> <span style="color:#75af00">dataOffset</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">v</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">add</span><span style="color:#111">(</span><span style="color:#75af00">k</span><span style="color:#111">,</span> <span style="color:#75af00">bucketCnt</span><span style="color:#f92672">*</span><span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">keysize</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 遍历 bucket 中的所有 cell</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">for</span> <span style="color:#75af00">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span><span style="color:#111">;</span> <span style="color:#75af00">i</span> <span style="color:#111">&lt;</span> <span style="color:#75af00">bucketCnt</span><span style="color:#111">;</span> <span style="color:#75af00">i</span><span style="color:#111">,</span> <span style="color:#75af00">k</span><span style="color:#111">,</span> <span style="color:#75af00">v</span> <span style="color:#111">=</span> <span style="color:#75af00">i</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span><span style="color:#111">,</span> <span style="color:#75af00">add</span><span style="color:#111">(</span><span style="color:#75af00">k</span><span style="color:#111">,</span> <span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">keysize</span><span style="color:#111">)),</span> <span style="color:#75af00">add</span><span style="color:#111">(</span><span style="color:#75af00">v</span><span style="color:#111">,</span> <span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">valuesize</span><span style="color:#111">))</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// 当前 cell 的 top hash 值</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">top</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">tophash</span><span style="color:#111">[</span><span style="color:#75af00">i</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// 如果 cell 为空，即没有 key</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">if</span> <span style="color:#75af00">top</span> <span style="color:#f92672">==</span> <span style="color:#75af00">empty</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75715e">// 那就标志它被&#34;搬迁&#34;过</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">tophash</span><span style="color:#111">[</span><span style="color:#75af00">i</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#75af00">evacuatedEmpty</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75715e">// 继续下个 cell</span>
</span></span><span style="display:flex;"><span>					<span style="color:#00a8c8">continue</span>
</span></span><span style="display:flex;"><span>				<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// 正常不会出现这种情况</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// 未被搬迁的 cell 只可能是 empty 或是</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// 正常的 top hash（大于 minTopHash）</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">if</span> <span style="color:#75af00">top</span> <span style="color:#111">&lt;</span> <span style="color:#75af00">minTopHash</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">throw</span><span style="color:#111">(</span><span style="color:#d88200">&#34;bad map state&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">k2</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">k</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// 如果 key 是指针，则解引用</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">if</span> <span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">indirectkey</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">k2</span> <span style="color:#111">=</span> <span style="color:#f92672">*</span><span style="color:#111">((</span><span style="color:#f92672">*</span><span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">)(</span><span style="color:#75af00">k2</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>				<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// 默认使用 X，等量扩容</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">useX</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">true</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// 如果不是等量扩容</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">sameSizeGrow</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75715e">// 计算 hash 值，和 key 第一次写入时一样</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">hash</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">alg</span><span style="color:#111">.</span><span style="color:#75af00">hash</span><span style="color:#111">(</span><span style="color:#75af00">k2</span><span style="color:#111">,</span> <span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">hash0</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>					<span style="color:#75715e">// 如果有协程正在遍历 map</span>
</span></span><span style="display:flex;"><span>					<span style="color:#00a8c8">if</span> <span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">flags</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">iterator</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>						<span style="color:#75715e">// 如果出现 相同的 key 值，算出来的 hash 值不同</span>
</span></span><span style="display:flex;"><span>						<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">reflexivekey</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#111">!</span><span style="color:#75af00">alg</span><span style="color:#111">.</span><span style="color:#75af00">equal</span><span style="color:#111">(</span><span style="color:#75af00">k2</span><span style="color:#111">,</span> <span style="color:#75af00">k2</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>							<span style="color:#75715e">// 只有在 float 变量的 NaN() 情况下会出现</span>
</span></span><span style="display:flex;"><span>							<span style="color:#00a8c8">if</span> <span style="color:#75af00">top</span><span style="color:#f92672">&amp;</span><span style="color:#ae81ff">1</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>								<span style="color:#75715e">// 第 B 位置 1</span>
</span></span><span style="display:flex;"><span>								<span style="color:#75af00">hash</span> <span style="color:#f92672">|=</span> <span style="color:#75af00">newbit</span>
</span></span><span style="display:flex;"><span>							<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>								<span style="color:#75715e">// 第 B 位置 0</span>
</span></span><span style="display:flex;"><span>								<span style="color:#75af00">hash</span> <span style="color:#f92672">&amp;^=</span> <span style="color:#75af00">newbit</span>
</span></span><span style="display:flex;"><span>							<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>							<span style="color:#75715e">// 取高 8 位作为 top hash 值</span>
</span></span><span style="display:flex;"><span>							<span style="color:#75af00">top</span> <span style="color:#111">=</span> <span style="color:#111">uint8</span><span style="color:#111">(</span><span style="color:#75af00">hash</span> <span style="color:#f92672">&gt;&gt;</span> <span style="color:#111">(</span><span style="color:#75af00">sys</span><span style="color:#111">.</span><span style="color:#75af00">PtrSize</span><span style="color:#f92672">*</span><span style="color:#ae81ff">8</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">8</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>							<span style="color:#00a8c8">if</span> <span style="color:#75af00">top</span> <span style="color:#111">&lt;</span> <span style="color:#75af00">minTopHash</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>								<span style="color:#75af00">top</span> <span style="color:#f92672">+=</span> <span style="color:#75af00">minTopHash</span>
</span></span><span style="display:flex;"><span>							<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>						<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>					<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>					<span style="color:#75715e">// 取决于新哈希值的 oldB+1 位是 0 还是 1</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75715e">// 详细看后面的文章</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">useX</span> <span style="color:#111">=</span> <span style="color:#75af00">hash</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">newbit</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>				<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// 如果 key 搬到 X 部分</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">if</span> <span style="color:#75af00">useX</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75715e">// 标志老的 cell 的 top hash 值，表示搬移到 X 部分</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">tophash</span><span style="color:#111">[</span><span style="color:#75af00">i</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#75af00">evacuatedX</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75715e">// 如果 xi 等于 8，说明要溢出了</span>
</span></span><span style="display:flex;"><span>					<span style="color:#00a8c8">if</span> <span style="color:#75af00">xi</span> <span style="color:#f92672">==</span> <span style="color:#75af00">bucketCnt</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>						<span style="color:#75715e">// 新建一个 bucket</span>
</span></span><span style="display:flex;"><span>						<span style="color:#75af00">newx</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">newoverflow</span><span style="color:#111">(</span><span style="color:#75af00">t</span><span style="color:#111">,</span> <span style="color:#75af00">x</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>						<span style="color:#75af00">x</span> <span style="color:#111">=</span> <span style="color:#75af00">newx</span>
</span></span><span style="display:flex;"><span>						<span style="color:#75715e">// xi 从 0 开始计数</span>
</span></span><span style="display:flex;"><span>						<span style="color:#75af00">xi</span> <span style="color:#111">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>						<span style="color:#75715e">// xk 表示 key 要移动到的位置</span>
</span></span><span style="display:flex;"><span>						<span style="color:#75af00">xk</span> <span style="color:#111">=</span> <span style="color:#75af00">add</span><span style="color:#111">(</span><span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">(</span><span style="color:#75af00">x</span><span style="color:#111">),</span> <span style="color:#75af00">dataOffset</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>						<span style="color:#75715e">// xv 表示 value 要移动到的位置</span>
</span></span><span style="display:flex;"><span>						<span style="color:#75af00">xv</span> <span style="color:#111">=</span> <span style="color:#75af00">add</span><span style="color:#111">(</span><span style="color:#75af00">xk</span><span style="color:#111">,</span> <span style="color:#75af00">bucketCnt</span><span style="color:#f92672">*</span><span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">keysize</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>					<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75715e">// 设置 top hash 值</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">x</span><span style="color:#111">.</span><span style="color:#75af00">tophash</span><span style="color:#111">[</span><span style="color:#75af00">xi</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#75af00">top</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75715e">// key 是指针</span>
</span></span><span style="display:flex;"><span>					<span style="color:#00a8c8">if</span> <span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">indirectkey</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>						<span style="color:#75715e">// 将原 key（是指针）复制到新位置</span>
</span></span><span style="display:flex;"><span>						<span style="color:#f92672">*</span><span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">)(</span><span style="color:#75af00">xk</span><span style="color:#111">)</span> <span style="color:#111">=</span> <span style="color:#75af00">k2</span> <span style="color:#75715e">// copy pointer</span>
</span></span><span style="display:flex;"><span>					<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>						<span style="color:#75715e">// 将原 key（是值）复制到新位置</span>
</span></span><span style="display:flex;"><span>						<span style="color:#75af00">typedmemmove</span><span style="color:#111">(</span><span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">key</span><span style="color:#111">,</span> <span style="color:#75af00">xk</span><span style="color:#111">,</span> <span style="color:#75af00">k</span><span style="color:#111">)</span> <span style="color:#75715e">// copy value</span>
</span></span><span style="display:flex;"><span>					<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75715e">// value 是指针，操作同 key</span>
</span></span><span style="display:flex;"><span>					<span style="color:#00a8c8">if</span> <span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">indirectvalue</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>						<span style="color:#f92672">*</span><span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">)(</span><span style="color:#75af00">xv</span><span style="color:#111">)</span> <span style="color:#111">=</span> <span style="color:#f92672">*</span><span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">)(</span><span style="color:#75af00">v</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>					<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>						<span style="color:#75af00">typedmemmove</span><span style="color:#111">(</span><span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">elem</span><span style="color:#111">,</span> <span style="color:#75af00">xv</span><span style="color:#111">,</span> <span style="color:#75af00">v</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>					<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>					<span style="color:#75715e">// 定位到下一个 cell</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">xi</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">xk</span> <span style="color:#111">=</span> <span style="color:#75af00">add</span><span style="color:#111">(</span><span style="color:#75af00">xk</span><span style="color:#111">,</span> <span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">keysize</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">xv</span> <span style="color:#111">=</span> <span style="color:#75af00">add</span><span style="color:#111">(</span><span style="color:#75af00">xv</span><span style="color:#111">,</span> <span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">valuesize</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>				<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span> <span style="color:#75715e">// key 搬到 Y 部分，操作同 X 部分</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75715e">// ……</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75715e">// 省略了这部分，操作和 X 部分相同</span>
</span></span><span style="display:flex;"><span>				<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 如果没有协程在使用老的 buckets，就把老 buckets 清除掉，帮助gc</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">flags</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">oldIterator</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">b</span> <span style="color:#111">=</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">bmap</span><span style="color:#111">)(</span><span style="color:#75af00">add</span><span style="color:#111">(</span><span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">oldbuckets</span><span style="color:#111">,</span> <span style="color:#75af00">oldbucket</span><span style="color:#f92672">*</span><span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">bucketsize</span><span style="color:#111">)))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 只清除bucket 的 key,value 部分，保留 top hash 部分，指示搬迁状态</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">bucket</span><span style="color:#111">.</span><span style="color:#75af00">kind</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">kindNoPointers</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">memclrHasPointers</span><span style="color:#111">(</span><span style="color:#75af00">add</span><span style="color:#111">(</span><span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">(</span><span style="color:#75af00">b</span><span style="color:#111">),</span> <span style="color:#75af00">dataOffset</span><span style="color:#111">),</span> <span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">bucketsize</span><span style="color:#111">)</span><span style="color:#f92672">-</span><span style="color:#75af00">dataOffset</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">memclrNoHeapPointers</span><span style="color:#111">(</span><span style="color:#75af00">add</span><span style="color:#111">(</span><span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">(</span><span style="color:#75af00">b</span><span style="color:#111">),</span> <span style="color:#75af00">dataOffset</span><span style="color:#111">),</span> <span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">bucketsize</span><span style="color:#111">)</span><span style="color:#f92672">-</span><span style="color:#75af00">dataOffset</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 更新搬迁进度</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 如果此次搬迁的 bucket 等于当前进度</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">oldbucket</span> <span style="color:#f92672">==</span> <span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">nevacuate</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 进度加 1</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">nevacuate</span> <span style="color:#111">=</span> <span style="color:#75af00">oldbucket</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Experiments suggest that 1024 is overkill by at least an order of magnitude.</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Put it in there as a safeguard anyway, to ensure O(1) behavior.</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 尝试往后看 1024 个 bucket</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">stop</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">nevacuate</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1024</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">stop</span> <span style="color:#111">&gt;</span> <span style="color:#75af00">newbit</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">stop</span> <span style="color:#111">=</span> <span style="color:#75af00">newbit</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 寻找没有搬迁的 bucket</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">for</span> <span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">nevacuate</span> <span style="color:#f92672">!=</span> <span style="color:#75af00">stop</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">bucketEvacuated</span><span style="color:#111">(</span><span style="color:#75af00">t</span><span style="color:#111">,</span> <span style="color:#75af00">h</span><span style="color:#111">,</span> <span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">nevacuate</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">nevacuate</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 现在 h.nevacuate 之前的 bucket 都被搬迁完毕</span>
</span></span><span style="display:flex;"><span>		
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 所有的 buckets 搬迁完毕</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">nevacuate</span> <span style="color:#f92672">==</span> <span style="color:#75af00">newbit</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 清除老的 buckets</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">oldbuckets</span> <span style="color:#111">=</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 清除老的 overflow bucket</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 回忆一下：[0] 表示当前 overflow bucket</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// [1] 表示 old overflow bucket</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">extra</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">extra</span><span style="color:#111">.</span><span style="color:#75af00">overflow</span><span style="color:#111">[</span><span style="color:#ae81ff">1</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 清除正在扩容的标志位</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">flags</span> <span style="color:#f92672">&amp;^=</span> <span style="color:#75af00">sameSizeGrow</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>evacuate 函数的代码注释非常清晰，对着代码和注释是很容易看懂整个的搬迁过程的，耐心点。</p>
<p>搬迁的目的就是将老的 buckets 搬迁到新的 buckets。而通过前面的说明我们知道，应对条件 1，新的 buckets 数量是之前的一倍，应对条件 2，新的 buckets 数量和之前相等。</p>
<p>对于条件 1，从老的 buckets 搬迁到新的 buckets，由于 bucktes 数量不变，因此可以按序号来搬，比如原来在 0 号 bucktes，到新的地方后，仍然放在 0 号 buckets。</p>
<p>对于条件 2，就没这么简单了。要重新计算 key 的哈希，才能决定它到底落在哪个 bucket。例如，原来 B = 5，计算出 key 的哈希后，只用看它的低 5 位，就能决定它落在哪个 bucket。扩容后，B 变成了 6，因此需要多看一位，它的低 6 位决定 key 落在哪个 bucket。这称为 <code>rehash</code>。</p>
<p><img src="/images/56e139d0-b8ed-40e0-b096-5a3f7659f208.png" alt=""></p>
<p>因此，某个 key 在搬迁前后 bucket 序号可能和原来相等，也可能是相比原来加上 2^B（原来的 B 值），取决于 hash 值 第 6 bit 位是 0  还是 1。</p>
<p>理解了上面 bucket 序号的变化，我们就可以回答另一个问题了：为什么遍历 map 是无序的？</p>
<p>map 在扩容后，会发生 key 的搬迁，原来落在同一个 bucket 中的 key，搬迁后，有些 key 就要远走高飞了（bucket 序号加上了 2^B）。而遍历的过程，就是按顺序遍历 bucket，同时按顺序遍历 bucket 中的 key。搬迁后，key 的位置发生了重大的变化，有些 key 飞上高枝，有些 key 则原地不动。这样，遍历 map 的结果就不可能按原来的顺序了。</p>
<p>当然，如果我就一个 hard code 的 map，我也不会向 map 进行插入删除的操作，按理说每次遍历这样的 map 都会返回一个固定顺序的 key/value 序列吧。的确是这样，但是 Go 杜绝了这种做法，因为这样会给新手程序员带来误解，以为这是一定会发生的事情，在某些情况下，可能会酿成大错。</p>
<p>当然，Go 做得更绝，当我们在遍历 map 时，并不是固定地从 0 号 bucket 开始遍历，每次都是从一个随机值序号的 bucket 开始遍历，并且是从这个 bucket 的一个随机序号的 cell 开始遍历。这样，即使你是一个写死的 map，仅仅只是遍历它，也不太可能会返回一个固定序列的 key/value 对了。</p>
<p>多说一句，“迭代 map 的结果是无序的”这个特性是从 go 1.0 开始加入的。</p>
<p>再明确一个问题：如果扩容后，B 增加了 1，意味着 buckets 总数是原来的 2 倍，原来 1 号的桶“裂变”到两个桶。</p>
<p>例如，原始 B = 2，1号 bucket 中有 2 个 key 的哈希值低 3 位分别为：010，110。由于原来 B = 2，所以低 2 位 <code>10</code> 决定它们落在 2 号桶，现在 B 变成 3，所以 <code>010</code>、<code>110</code> 分别落入 2、6 号桶。</p>
<p><img src="/images/404e0490-65f9-40d2-be46-6ad3d207ca33.png" alt=""></p>
<p>理解了这个，后面讲 map 迭代的时候会用到。</p>
<p>再来讲搬迁函数中的几个关键点：</p>
<p>evacuate 函数每次只完成一个 bucket 的搬迁工作，因此要遍历完此 bucket 的所有的 cell，将有值的 cell copy 到新的地方。bucket 还会链接 overflow bucket，它们同样需要搬迁。因此会有 2 层循环，外层遍历 bucket 和 overflow bucket，内层遍历 bucket 的所有 cell。这样的循环在 map 的源码里到处都是，要理解透了。</p>
<p>源码里提到 X, Y part，其实就是我们说的如果是扩容到原来的 2 倍，桶的数量是原来的 2 倍，前一半桶被称为 X part，后一半桶被称为 Y part。一个 bucket 中的 key 可能会分裂落到 2 个桶，一个位于 X part，一个位于 Y part。所以在搬迁一个 cell 之前，需要知道这个 cell 中的 key 是落到哪个 Part。很简单，重新计算 cell 中 key 的 hash，并向前“多看”一位，决定落入哪个 Part，这个前面也说得很详细了。</p>
<p>有一个特殊情况是：有一种 key，每次对它计算 hash，得到的结果都不一样。这个 key 就是 <code>math.NaN()</code> 的结果，它的含义是 <code>not a number</code>，类型是 float64。当它作为 map 的 key，在搬迁的时候，会遇到一个问题：再次计算它的哈希值和它当初插入 map 时的计算出来的哈希值不一样！</p>
<p>你可能想到了，这样带来的一个后果是，这个 key 是永远不会被 Get 操作获取的！当我使用 <code>m[math.NaN()]</code> 语句的时候，是查不出来结果的。这个 key 只有在遍历整个 map 的时候，才有机会现身。所以，可以向一个 map 插入任意数量的 <code>math.NaN()</code> 作为 key。</p>
<p>当搬迁碰到 <code>math.NaN()</code> 的 key 时，只通过 tophash 的最低位决定分配到 X part 还是 Y part（如果扩容后是原来 buckets 数量的 2 倍）。如果 tophash 的最低位是 0 ，分配到 X part；如果是 1 ，则分配到 Y part。</p>
<p>这是通过 tophash 值与新算出来的哈希值进行运算得到的：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#75af00">top</span><span style="color:#f92672">&amp;</span><span style="color:#ae81ff">1</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// top hash 最低位为 1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 新算出来的 hash 值的 B 位置 1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">hash</span> <span style="color:#f92672">|=</span> <span style="color:#75af00">newbit</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 新算出来的 hash 值的 B 位置 0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">hash</span> <span style="color:#f92672">&amp;^=</span> <span style="color:#75af00">newbit</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// hash 值的 B 位为 0，则搬迁到 x part</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 当 B = 5时，newbit = 32，二进制低 6 位为 10 0000</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">useX</span> <span style="color:#111">=</span> <span style="color:#75af00">hash</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">newbit</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>
</span></span></code></pre></div><p>其实这样的 key 我随便搬迁到哪个 bucket 都行，当然，还是要搬迁到上面裂变那张图中的两个 bucket 中去。但这样做是有好处的，在后面讲 map 迭代的时候会再详细解释，暂时知道是这样分配的就行。</p>
<p>确定了要搬迁到的目标 bucket 后，搬迁操作就比较好进行了。将源 key/value 值 copy 到目的地相应的位置。</p>
<p>设置 key 在原始 buckets 的 tophash 为 <code>evacuatedX</code> 或是 <code>evacuatedY</code>，表示已经搬迁到了新 map 的 x part 或是 y part。新 map 的 tophash 则正常取 key 哈希值的高 8 位。</p>
<p>下面通过图来宏观地看一下扩容前后的变化。</p>
<p>扩容前，B = 2，共有 4 个 buckets，lowbits 表示 hash 值的低位。假设我们不关注其他 buckets 情况，专注在 2 号 bucket。并且假设 overflow 太多，触发了等量扩容（对应于前面的条件 2）。</p>
<p><img src="/images/d8a63f0a-3592-4d2d-abbf-1d308dc24d1f.png" alt=""></p>
<p>扩容完成后，overflow bucket 消失了，key 都集中到了一个 bucket，更为紧凑了，提高了查找的效率。</p>
<p><img src="/images/7bcdec53-7b75-42bc-8cc4-55511b02c758.png" alt=""></p>
<p>假设触发了 2 倍的扩容，那么扩容完成后，老 buckets 中的 key 分裂到了 2 个 新的 bucket。一个在 x part，一个在 y 的 part。依据是 hash 的 lowbits。新 map 中 <code>0-3</code> 称为 x part，<code>4-7</code> 称为 y part。</p>
<p><img src="/images/307e9ec7-d7e0-4a77-b188-ce43cd8ec41a.png" alt=""></p>
<p>注意，上面的两张图忽略了其他 buckets 的搬迁情况，表示所有的 bucket 都搬迁完毕后的情形。实际上，我们知道，搬迁是一个“渐进”的过程，并不会一下子就全部搬迁完毕。所以在搬迁过程中，oldbuckets 指针还会指向原来老的 []bmap，并且已经搬迁完毕的 key 的 tophash 值会是一个状态值，表示 key 的搬迁去向。</p>
<h3 id="map-的遍历">map 的遍历</h3>
<p>本来 map 的遍历过程比较简单：遍历所有的 bucket 以及它后面挂的 overflow bucket，然后挨个遍历 bucket 中的所有 cell。每个 bucket 中包含 8 个 cell，从有 key 的 cell 中取出 key 和 value，这个过程就完成了。</p>
<p>但是，现实并没有这么简单。还记得前面讲过的扩容过程吗？扩容过程不是一个原子的操作，它每次最多只搬运 2 个 bucket，所以如果触发了扩容操作，那么在很长时间里，map 的状态都是处于一个中间态：有些 bucket 已经搬迁到新家，而有些 bucket 还待在老地方。</p>
<p>因此，遍历如果发生在扩容的过程中，就会涉及到遍历新老 bucket 的过程，这是难点所在。</p>
<p>我先写一个简单的代码样例，假装不知道遍历过程具体调用的是什么函数：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ageMp</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#00a8c8">string</span><span style="color:#111">]</span><span style="color:#00a8c8">int</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ageMp</span><span style="color:#111">[</span><span style="color:#d88200">&#34;qcrao&#34;</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#ae81ff">18</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">name</span><span style="color:#111">,</span> <span style="color:#75af00">age</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">ageMp</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">name</span><span style="color:#111">,</span> <span style="color:#75af00">age</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>执行命令：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>go tool compile -S main.go
</span></span></code></pre></div><p>得到汇编命令。这里就不逐行讲解了，可以去看之前的几篇文章，说得很详细。</p>
<p>关键的几行汇编代码如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// ......</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x0124</span> <span style="color:#ae81ff">002</span><span style="color:#ae81ff">92</span> <span style="color:#111">(</span><span style="color:#75af00">test16</span><span style="color:#111">.</span><span style="color:#00a8c8">go</span><span style="color:#111">:</span><span style="color:#ae81ff">9</span><span style="color:#111">)</span>      <span style="color:#75af00">CALL</span>    <span style="color:#75af00">runtime</span><span style="color:#111">.</span><span style="color:#75af00">mapiterinit</span><span style="color:#111">(</span><span style="color:#75af00">SB</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// ......</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x01fb</span> <span style="color:#ae81ff">00507</span> <span style="color:#111">(</span><span style="color:#75af00">test16</span><span style="color:#111">.</span><span style="color:#00a8c8">go</span><span style="color:#111">:</span><span style="color:#ae81ff">9</span><span style="color:#111">)</span>      <span style="color:#75af00">CALL</span>    <span style="color:#75af00">runtime</span><span style="color:#111">.</span><span style="color:#75af00">mapiternext</span><span style="color:#111">(</span><span style="color:#75af00">SB</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x0200</span> <span style="color:#ae81ff">00512</span> <span style="color:#111">(</span><span style="color:#75af00">test16</span><span style="color:#111">.</span><span style="color:#00a8c8">go</span><span style="color:#111">:</span><span style="color:#ae81ff">9</span><span style="color:#111">)</span>      <span style="color:#75af00">MOVQ</span>    <span style="color:#d88200">&#34;&#34;</span><span style="color:#111">..</span><span style="color:#75af00">autotmp_4</span><span style="color:#f92672">+</span><span style="color:#ae81ff">160</span><span style="color:#111">(</span><span style="color:#75af00">SP</span><span style="color:#111">),</span> <span style="color:#75af00">AX</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x0208</span> <span style="color:#ae81ff">00520</span> <span style="color:#111">(</span><span style="color:#75af00">test16</span><span style="color:#111">.</span><span style="color:#00a8c8">go</span><span style="color:#111">:</span><span style="color:#ae81ff">9</span><span style="color:#111">)</span>      <span style="color:#75af00">TESTQ</span>   <span style="color:#75af00">AX</span><span style="color:#111">,</span> <span style="color:#75af00">AX</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x020b</span> <span style="color:#ae81ff">00523</span> <span style="color:#111">(</span><span style="color:#75af00">test16</span><span style="color:#111">.</span><span style="color:#00a8c8">go</span><span style="color:#111">:</span><span style="color:#ae81ff">9</span><span style="color:#111">)</span>      <span style="color:#75af00">JNE</span>     <span style="color:#ae81ff">302</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// ......</span>
</span></span></code></pre></div><p>这样，关于 map 迭代，底层的函数调用关系一目了然。先是调用 <code>mapiterinit</code> 函数初始化迭代器，然后循环调用 <code>mapiternext</code> 函数进行 map 迭代。</p>
<p><img src="/images/275dddcd-9417-4ff2-bd86-1caa120df293.png" alt=""></p>
<p>迭代器的结构体定义：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">hiter</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// key 指针</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">key</span>         <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// value 指针</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">value</span>       <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// map 类型，包含如 key size 大小等</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">t</span>           <span style="color:#f92672">*</span><span style="color:#75af00">maptype</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// map header</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">h</span>           <span style="color:#f92672">*</span><span style="color:#75af00">hmap</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 初始化时指向的 bucket</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">buckets</span>     <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 当前遍历到的 bmap</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">bptr</span>        <span style="color:#f92672">*</span><span style="color:#75af00">bmap</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">overflow</span>    <span style="color:#111">[</span><span style="color:#ae81ff">2</span><span style="color:#111">]</span><span style="color:#f92672">*</span><span style="color:#111">[]</span><span style="color:#f92672">*</span><span style="color:#75af00">bmap</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 起始遍历的 bucet 编号</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">startBucket</span> <span style="color:#00a8c8">uintptr</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 遍历开始时 cell 的编号（每个 bucket 中有 8 个 cell）</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">offset</span>      <span style="color:#00a8c8">uint8</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 是否从头遍历了</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">wrapped</span>     <span style="color:#00a8c8">bool</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// B 的大小</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">B</span>           <span style="color:#00a8c8">uint8</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 指示当前 cell 序号</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">i</span>           <span style="color:#00a8c8">uint8</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 指向当前的 bucket</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">bucket</span>      <span style="color:#00a8c8">uintptr</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 因为扩容，需要检查的 bucket</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">checkBucket</span> <span style="color:#00a8c8">uintptr</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p><code>mapiterinit</code> 就是对 hiter 结构体里的字段进行初始化赋值操作。</p>
<p>前面已经提到过，即使是对一个写死的 map 进行遍历，每次出来的结果也是无序的。下面我们就可以近距离地观察他们的实现了。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// 生成随机数 r</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">r</span> <span style="color:#f92672">:=</span> <span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">fastrand</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">B</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">31</span><span style="color:#f92672">-</span><span style="color:#75af00">bucketCntBits</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span> <span style="color:#f92672">+=</span> <span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">fastrand</span><span style="color:#111">())</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">31</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 从哪个 bucket 开始遍历</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">it</span><span style="color:#111">.</span><span style="color:#75af00">startBucket</span> <span style="color:#111">=</span> <span style="color:#75af00">r</span> <span style="color:#f92672">&amp;</span> <span style="color:#111">(</span><span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span><span style="color:#f92672">&lt;&lt;</span><span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">B</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 从 bucket 的哪个 cell 开始遍历</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">it</span><span style="color:#111">.</span><span style="color:#75af00">offset</span> <span style="color:#111">=</span> <span style="color:#111">uint8</span><span style="color:#111">(</span><span style="color:#75af00">r</span> <span style="color:#f92672">&gt;&gt;</span> <span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">B</span> <span style="color:#f92672">&amp;</span> <span style="color:#111">(</span><span style="color:#75af00">bucketCnt</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span><span style="color:#111">))</span>
</span></span></code></pre></div><p>例如，B = 2，那 <code>uintptr(1)&lt;&lt;h.B - 1</code> 结果就是 3，低 8 位为 <code>0000 0011</code>，将 r 与之相与，就可以得到一个 <code>0~3</code> 的 bucket 序号；bucketCnt - 1 等于 7，低 8 位为 <code>0000 0111</code>，将 r 右移 2 位后，与 7 相与，就可以得到一个 <code>0~7</code> 号的 cell。</p>
<p>于是，在 <code>mapiternext</code> 函数中就会从 it.startBucket 的 it.offset 号的 cell 开始遍历，取出其中的 key 和 value，直到又回到起点 bucket，完成遍历过程。</p>
<p>源码部分比较好看懂，尤其是理解了前面注释的几段代码后，再看这部分代码就没什么压力了。所以，接下来，我将通过图形化的方式讲解整个遍历过程，希望能够清晰易懂。</p>
<p>假设我们有下图所示的一个 map，起始时 B = 1，有两个 bucket，后来触发了扩容（这里不要深究扩容条件，只是一个设定），B 变成 2。并且， 1 号 bucket 中的内容搬迁到了新的 bucket，<code>1 号</code>裂变成 <code>1 号</code>和 <code>3 号</code>；<code>0 号</code> bucket 暂未搬迁。老的 bucket 挂在在 <code>*oldbuckets</code> 指针上面，新的 bucket 则挂在 <code>*buckets</code> 指针上面。</p>
<p><img src="/images/ad3e49ca-d762-496e-81ac-5795bf1b19b3.png" alt=""></p>
<p>这时，我们对此 map 进行遍历。假设经过初始化后，startBucket = 3，offset = 2。于是，遍历的起点将是 3 号 bucket 的 2 号 cell，下面这张图就是开始遍历时的状态：</p>
<p><img src="/images/c26ab30d-161e-43d3-ab72-2420656e4cca.png" alt=""></p>
<p>标红的表示起始位置，bucket 遍历顺序为：3 -&gt; 0 -&gt; 1 -&gt; 2。</p>
<p>因为 3 号 bucket 对应老的 1 号 bucket，因此先检查老 1 号 bucket 是否已经被搬迁过。判断方法就是：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">evacuated</span><span style="color:#111">(</span><span style="color:#75af00">b</span> <span style="color:#f92672">*</span><span style="color:#75af00">bmap</span><span style="color:#111">)</span> <span style="color:#00a8c8">bool</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">h</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">tophash</span><span style="color:#111">[</span><span style="color:#ae81ff">0</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">h</span> <span style="color:#111">&gt;</span> <span style="color:#75af00">empty</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">h</span> <span style="color:#111">&lt;</span> <span style="color:#75af00">minTopHash</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>如果 b.tophash[0] 的值在标志值范围内，即在 (0,4) 区间里，说明已经被搬迁过了。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">empty</span> <span style="color:#111">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">evacuatedEmpty</span> <span style="color:#111">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">evacuatedX</span> <span style="color:#111">=</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">evacuatedY</span> <span style="color:#111">=</span> <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">minTopHash</span> <span style="color:#111">=</span> <span style="color:#ae81ff">4</span>
</span></span></code></pre></div><p>在本例中，老 1 号 bucket 已经被搬迁过了。所以它的 tophash[0] 值在 (0,4) 范围内，因此只用遍历新的 3 号 bucket。</p>
<p>依次遍历 3 号 bucket 的 cell，这时候会找到第一个非空的 key：元素 e。到这里，mapiternext 函数返回，这时我们的遍历结果仅有一个元素：</p>
<p><img src="/images/583ed90d-8021-419f-920b-fb26156a9403.png" alt=""></p>
<p>由于返回的 key 不为空，所以会继续调用 mapiternext 函数。</p>
<p>继续从上次遍历到的地方往后遍历，从新 3 号 overflow bucket 中找到了元素 f 和 元素 g。</p>
<p>遍历结果集也因此壮大：</p>
<p><img src="/images/c1e81445-397f-430c-86bb-dc62f261d074.png" alt=""></p>
<p>新 3 号 bucket 遍历完之后，回到了新 0 号 bucket。0 号 bucket 对应老的 0 号 bucket，经检查，老 0 号 bucket 并未搬迁，因此对新 0 号 bucket 的遍历就改为遍历老 0 号 bucket。那是不是把老 0 号 bucket 中的所有 key 都取出来呢？</p>
<p>并没有这么简单，回忆一下，老 0 号 bucket 在搬迁后将裂变成 2 个 bucket：新 0 号、新 2 号。而我们此时正在遍历的只是新 0 号 bucket（注意，遍历都是遍历的 <code>*bucket</code> 指针，也就是所谓的新 buckets）。所以，我们只会取出老 0 号 bucket 中那些在裂变之后，分配到新 0 号 bucket 中的那些 key。</p>
<p>因此，<code>lowbits == 00</code> 的将进入遍历结果集：</p>
<p><img src="/images/02c7c564-1e6c-463c-a3c6-e60b0f631cc5.png" alt=""></p>
<p>和之前的流程一样，继续遍历新 1 号 bucket，发现老 1 号 bucket 已经搬迁，只用遍历新 1 号 bucket 中现有的元素就可以了。结果集变成：</p>
<p><img src="/images/7de551d7-64c5-4c2f-8f54-73ac7c1c5e01.png" alt=""></p>
<p>继续遍历新 2 号 bucket，它来自老 0 号 bucket，因此需要在老 0 号 bucket 中那些会裂变到新 2 号 bucket 中的 key，也就是 <code>lowbit == 10</code> 的那些 key。</p>
<p>这样，遍历结果集变成：</p>
<p><img src="/images/7369c973-b871-4903-b907-00a5a1d0a95a.png" alt=""></p>
<p>最后，继续遍历到新 3 号 bucket 时，发现所有的 bucket 都已经遍历完毕，整个迭代过程执行完毕。</p>
<p>顺便说一下，如果碰到 key 是 <code>math.NaN()</code> 这种的，处理方式类似。核心还是要看它被分裂后具体落入哪个 bucket。只不过只用看它 top hash 的最低位。如果 top hash 的最低位是 0 ，分配到 X part；如果是 1 ，则分配到 Y part。据此决定是否取出 key，放到遍历结果集里。</p>
<p>map 遍历的核心在于理解 2 倍扩容时，老 bucket 会分裂到 2 个新 bucket 中去。而遍历操作，会按照新 bucket 的序号顺序进行，碰到老 bucket 未搬迁的情况时，要在老 bucket 中找到将来要搬迁到新 bucket 来的 key。</p>
<h3 id="map-的赋值">map 的赋值</h3>
<p>通过汇编语言可以看到，向 map 中插入或者修改 key，最终调用的是 <code>mapassign</code> 函数。</p>
<p>实际上插入或修改 key 的语法是一样的，只不过前者操作的 key 在 map 中不存在，而后者操作的 key 存在 map 中。</p>
<p>mapassign 有一个系列的函数，根据 key 类型的不同，编译器会将其优化为相应的“快速函数”。</p>
<table>
  <thead>
      <tr>
          <th>key 类型</th>
          <th>插入</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>uint32</td>
          <td>mapassign_fast32(t *maptype, h *hmap, key uint32) unsafe.Pointer</td>
      </tr>
      <tr>
          <td>uint64</td>
          <td>mapassign_fast64(t *maptype, h *hmap, key uint64) unsafe.Pointer</td>
      </tr>
      <tr>
          <td>string</td>
          <td>mapassign_faststr(t *maptype, h *hmap, ky string) unsafe.Pointer</td>
      </tr>
  </tbody>
</table>
<p>我们只用研究最一般的赋值函数 <code>mapassign</code>。</p>
<p>整体来看，流程非常得简单：对 key 计算 hash 值，根据 hash 值按照之前的流程，找到要赋值的位置（可能是插入新 key，也可能是更新老 key），对相应位置进行赋值。</p>
<p>源码大体和之前讲的类似，核心还是一个双层循环，外层遍历 bucket 和它的 overflow bucket，内层遍历整个 bucket 的各个 cell。限于篇幅，这部分代码的注释我也不展示了，有兴趣的可以去看，保证理解了这篇文章内容后，能够看懂。</p>
<p>我这里会针对这个过程提几点重要的。</p>
<p>函数首先会检查 map 的标志位 flags。如果 flags 的写标志位此时被置 1 了，说明有其他协程在执行“写”操作，进而导致程序 panic。这也说明了 map 对协程是不安全的。</p>
<p>通过前文我们知道扩容是渐进式的，如果 map 处在扩容的过程中，那么当 key 定位到了某个 bucket 后，需要确保这个 bucket 对应的老 bucket 完成了迁移过程。即老 bucket 里的 key 都要迁移到新的 bucket 中来（分裂到 2 个新 bucket），才能在新的 bucket 中进行插入或者更新的操作。</p>
<p>上面说的操作是在函数靠前的位置进行的，只有进行完了这个搬迁操作后，我们才能放心地在新 bucket 里定位 key 要安置的地址，再进行之后的操作。</p>
<p>现在到了定位 key 应该放置的位置了，所谓找准自己的位置很重要。准备两个指针，一个（<code>inserti</code>）指向 key 的 hash 值在 tophash 数组所处的位置，另一个(<code>insertk</code>)指向 cell 的位置（也就是 key 最终放置的地址），当然，对应 value 的位置就很容易定位出来了。这三者实际上都是关联的，在 tophash 数组中的索引位置决定了 key 在整个 bucket 中的位置（共 8 个 key），而 value 的位置需要“跨过” 8 个 key 的长度。</p>
<p>在循环的过程中，inserti 和 insertk 分别指向第一个找到的空闲的 cell。如果之后在 map 没有找到 key 的存在，也就是说原来 map 中没有此 key，这意味着插入新 key。那最终 key 的安置地址就是第一次发现的“空位”（tophash 是 empty）。</p>
<p>如果这个 bucket 的 8 个 key 都已经放置满了，那在跳出循环后，发现 inserti 和 insertk 都是空，这时候需要在 bucket 后面挂上 overflow bucket。当然，也有可能是在 overflow bucket 后面再挂上一个 overflow bucket。这就说明，太多 key hash 到了此 bucket。</p>
<p>在正式安置 key 之前，还要检查 map 的状态，看它是否需要进行扩容。如果满足扩容的条件，就主动触发一次扩容操作。</p>
<p>这之后，整个之前的查找定位 key 的过程，还得再重新走一次。因为扩容之后，key 的分布都发生了变化。</p>
<p>最后，会更新 map 相关的值，如果是插入新 key，map 的元素数量字段 count 值会加 1；在函数之初设置的 <code>hashWriting</code> 写标志出会清零。</p>
<p>另外，有一个重要的点要说一下。前面说的找到 key 的位置，进行赋值操作，实际上并不准确。我们看 <code>mapassign</code> 函数的原型就知道，函数并没有传入 value 值，所以赋值操作是什么时候执行的呢？</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">mapassign</span><span style="color:#111">(</span><span style="color:#75af00">t</span> <span style="color:#f92672">*</span><span style="color:#75af00">maptype</span><span style="color:#111">,</span> <span style="color:#75af00">h</span> <span style="color:#f92672">*</span><span style="color:#75af00">hmap</span><span style="color:#111">,</span> <span style="color:#75af00">key</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">)</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span>
</span></span></code></pre></div><p>答案还得从汇编语言中寻找。我直接揭晓答案，有兴趣可以私下去研究一下。<code>mapassign</code> 函数返回的指针就是指向的 key 所对应的 value 值位置，有了地址，就很好操作赋值了。</p>
<h3 id="map-的删除">map 的删除</h3>
<p>写操作底层的执行函数是 <code>mapdelete</code>：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">mapdelete</span><span style="color:#111">(</span><span style="color:#75af00">t</span> <span style="color:#f92672">*</span><span style="color:#75af00">maptype</span><span style="color:#111">,</span> <span style="color:#75af00">h</span> <span style="color:#f92672">*</span><span style="color:#75af00">hmap</span><span style="color:#111">,</span> <span style="color:#75af00">key</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">)</span> 
</span></span></code></pre></div><p>根据 key 类型的不同，删除操作会被优化成更具体的函数：</p>
<table>
  <thead>
      <tr>
          <th>key 类型</th>
          <th>删除</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>uint32</td>
          <td>mapdelete_fast32(t *maptype, h *hmap, key uint32)</td>
      </tr>
      <tr>
          <td>uint64</td>
          <td>mapdelete_fast64(t *maptype, h *hmap, key uint64)</td>
      </tr>
      <tr>
          <td>string</td>
          <td>mapdelete_faststr(t *maptype, h *hmap, ky string)</td>
      </tr>
  </tbody>
</table>
<p>当然，我们只关心 <code>mapdelete</code> 函数。它首先会检查 h.flags 标志，如果发现写标位是 1，直接 panic，因为这表明有其他协程同时在进行写操作。</p>
<p>计算 key 的哈希，找到落入的 bucket。检查此 map 如果正在扩容的过程中，直接触发一次搬迁操作。</p>
<p>删除操作同样是两层循环，核心还是找到 key 的具体位置。寻找过程都是类似的，在 bucket 中挨个 cell 寻找。</p>
<p>找到对应位置后，对 key 或者 value 进行“清零”操作：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// 对 key 清零</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">indirectkey</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">*</span><span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">)(</span><span style="color:#75af00">k</span><span style="color:#111">)</span> <span style="color:#111">=</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">typedmemclr</span><span style="color:#111">(</span><span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">key</span><span style="color:#111">,</span> <span style="color:#75af00">k</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 对 value 清零</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">indirectvalue</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">*</span><span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">)(</span><span style="color:#75af00">v</span><span style="color:#111">)</span> <span style="color:#111">=</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">typedmemclr</span><span style="color:#111">(</span><span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">elem</span><span style="color:#111">,</span> <span style="color:#75af00">v</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>最后，将 count 值减 1，将对应位置的 tophash 值置成 <code>Empty</code>。</p>
<p>这块源码同样比较简单，感兴起直接去看代码。</p>
<h2 id="map-进阶">map 进阶</h2>
<h3 id="可以边遍历边删除吗">可以边遍历边删除吗</h3>
<p>map 并不是一个线程安全的数据结构。同时读写一个 map 是未定义的行为，如果被检测到，会直接 panic。</p>
<p>一般而言，这可以通过读写锁来解决：<code>sync.RWMutex</code>。</p>
<p>读之前调用 <code>RLock()</code> 函数，读完之后调用 <code>RUnlock()</code> 函数解锁；写之前调用 <code>Lock()</code> 函数，写完之后，调用 <code>Unlock()</code> 解锁。</p>
<p>另外，<code>sync.Map</code> 是线程安全的 map，也可以使用。它的实现原理，这次先不说了。</p>
<h3 id="key-可以是-float-型吗">key 可以是 float 型吗？</h3>
<p>从语法上看，是可以的。Go 语言中只要是可比较的类型都可以作为 key。除开 slice，map，functions 这几种类型，其他类型都是 OK 的。具体包括：布尔值、数字、字符串、指针、通道、接口类型、结构体、只包含上述类型的数组。这些类型的共同特征是支持 <code>==</code> 和 <code>!=</code> 操作符，<code>k1 == k2</code> 时，可认为 k1 和 k2 是同一个 key。如果是结构体，则需要它们的字段值都相等，才被认为是相同的 key。</p>
<p>顺便说一句，任何类型都可以作为 value，包括 map 类型。</p>
<p>来看个例子：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">m</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#00a8c8">float64</span><span style="color:#111">]</span><span style="color:#00a8c8">int</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">m</span><span style="color:#111">[</span><span style="color:#ae81ff">1.4</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">m</span><span style="color:#111">[</span><span style="color:#ae81ff">2.4</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">m</span><span style="color:#111">[</span><span style="color:#75af00">math</span><span style="color:#111">.</span><span style="color:#75af00">NaN</span><span style="color:#111">()]</span> <span style="color:#111">=</span> <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">m</span><span style="color:#111">[</span><span style="color:#75af00">math</span><span style="color:#111">.</span><span style="color:#75af00">NaN</span><span style="color:#111">()]</span> <span style="color:#111">=</span> <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">k</span><span style="color:#111">,</span> <span style="color:#75af00">v</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">m</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;[%v, %d] &#34;</span><span style="color:#111">,</span> <span style="color:#75af00">k</span><span style="color:#111">,</span> <span style="color:#75af00">v</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;\nk: %v, v: %d\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">math</span><span style="color:#111">.</span><span style="color:#75af00">NaN</span><span style="color:#111">(),</span> <span style="color:#75af00">m</span><span style="color:#111">[</span><span style="color:#75af00">math</span><span style="color:#111">.</span><span style="color:#75af00">NaN</span><span style="color:#111">()])</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;k: %v, v: %d\n&#34;</span><span style="color:#111">,</span> <span style="color:#ae81ff">2.400000000001</span><span style="color:#111">,</span> <span style="color:#75af00">m</span><span style="color:#111">[</span><span style="color:#ae81ff">2.400000000001</span><span style="color:#111">])</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;k: %v, v: %d\n&#34;</span><span style="color:#111">,</span> <span style="color:#ae81ff">2.4000000000000000000000001</span><span style="color:#111">,</span> <span style="color:#75af00">m</span><span style="color:#111">[</span><span style="color:#ae81ff">2.4000000000000000000000001</span><span style="color:#111">])</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">math</span><span style="color:#111">.</span><span style="color:#75af00">NaN</span><span style="color:#111">()</span> <span style="color:#f92672">==</span> <span style="color:#75af00">math</span><span style="color:#111">.</span><span style="color:#75af00">NaN</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>程序的输出：</p>
<pre tabindex="0"><code>[2.4, 2] [NaN, 3] [NaN, 3] [1.4, 1] 
k: NaN, v: 0
k: 2.400000000001, v: 0
k: 2.4, v: 2
false
</code></pre><p>例子中定义了一个 key 类型是 float 型的 map，并向其中插入了 4 个 key：1.4， 2.4， NAN，NAN。</p>
<p>打印的时候也打印出了 4 个 key，如果你知道 NAN != NAN，也就不奇怪了。因为他们比较的结果不相等，自然，在 map 看来就是两个不同的 key 了。</p>
<p>接着，我们查询了几个 key，发现 NAN 不存在，2.400000000001 也不存在，而 2.4000000000000000000000001 却存在。</p>
<p>有点诡异，不是吗？</p>
<p>接着，我通过汇编发现了如下的事实：</p>
<p>当用 float64 作为 key 的时候，先要将其转成 unit64 类型，再插入 key 中。</p>
<p>具体是通过 <code>Float64frombits</code> 函数完成：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// Float64frombits returns the floating point number corresponding</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// the IEEE 754 binary representation b.</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">Float64frombits</span><span style="color:#111">(</span><span style="color:#75af00">b</span> <span style="color:#00a8c8">uint64</span><span style="color:#111">)</span> <span style="color:#00a8c8">float64</span> <span style="color:#111">{</span> <span style="color:#00a8c8">return</span> <span style="color:#f92672">*</span><span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#00a8c8">float64</span><span style="color:#111">)(</span><span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">b</span><span style="color:#111">))</span> <span style="color:#111">}</span>
</span></span></code></pre></div><p>也就是将浮点数表示成 IEEE 754 规定的格式。如赋值语句：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ae81ff">0x00bd</span> <span style="color:#ae81ff">001</span><span style="color:#ae81ff">89</span> <span style="color:#111">(</span><span style="color:#75af00">test18</span><span style="color:#111">.</span><span style="color:#00a8c8">go</span><span style="color:#111">:</span><span style="color:#ae81ff">9</span><span style="color:#111">)</span>      <span style="color:#75af00">LEAQ</span>    <span style="color:#d88200">&#34;&#34;</span><span style="color:#111">.</span><span style="color:#75af00">statictmp_0</span><span style="color:#111">(</span><span style="color:#75af00">SB</span><span style="color:#111">),</span> <span style="color:#75af00">DX</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x00c4</span> <span style="color:#ae81ff">001</span><span style="color:#ae81ff">96</span> <span style="color:#111">(</span><span style="color:#75af00">test18</span><span style="color:#111">.</span><span style="color:#00a8c8">go</span><span style="color:#111">:</span><span style="color:#ae81ff">9</span><span style="color:#111">)</span>      <span style="color:#75af00">MOVQ</span>    <span style="color:#75af00">DX</span><span style="color:#111">,</span> <span style="color:#ae81ff">16</span><span style="color:#111">(</span><span style="color:#75af00">SP</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x00c9</span> <span style="color:#ae81ff">00201</span> <span style="color:#111">(</span><span style="color:#75af00">test18</span><span style="color:#111">.</span><span style="color:#00a8c8">go</span><span style="color:#111">:</span><span style="color:#ae81ff">9</span><span style="color:#111">)</span>      <span style="color:#75af00">PCDATA</span>  <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x00c9</span> <span style="color:#ae81ff">00201</span> <span style="color:#111">(</span><span style="color:#75af00">test18</span><span style="color:#111">.</span><span style="color:#00a8c8">go</span><span style="color:#111">:</span><span style="color:#ae81ff">9</span><span style="color:#111">)</span>      <span style="color:#75af00">CALL</span>    <span style="color:#75af00">runtime</span><span style="color:#111">.</span><span style="color:#75af00">mapassign</span><span style="color:#111">(</span><span style="color:#75af00">SB</span><span style="color:#111">)</span>
</span></span></code></pre></div><p><code>&quot;&quot;.statictmp_0(SB)</code> 变量是这样的：</p>
<pre tabindex="0"><code>&#34;&#34;.statictmp_0 SRODATA size=8
        0x0000 33 33 33 33 33 33 03 40
&#34;&#34;.statictmp_1 SRODATA size=8
        0x0000 ff 3b 33 33 33 33 03 40
&#34;&#34;.statictmp_2 SRODATA size=8
        0x0000 33 33 33 33 33 33 03 40
</code></pre><p>我们再来输出点东西：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;math&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">m</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#00a8c8">float64</span><span style="color:#111">]</span><span style="color:#00a8c8">int</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">m</span><span style="color:#111">[</span><span style="color:#ae81ff">2.4</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">math</span><span style="color:#111">.</span><span style="color:#75af00">Float64bits</span><span style="color:#111">(</span><span style="color:#ae81ff">2.4</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">math</span><span style="color:#111">.</span><span style="color:#75af00">Float64bits</span><span style="color:#111">(</span><span style="color:#ae81ff">2.400000000001</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">math</span><span style="color:#111">.</span><span style="color:#75af00">Float64bits</span><span style="color:#111">(</span><span style="color:#ae81ff">2.4000000000000000000000001</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">4612586738352864255</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">4612586738352862003</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">4612586738352862003</span>
</span></span></code></pre></div><p>转成十六进制为：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ae81ff">0x4003333333333333</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x4003333333333BFF</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x4003333333333333</span>
</span></span></code></pre></div><p>和前面的 <code>&quot;&quot;.statictmp_0</code> 比较一下，很清晰了吧。<code>2.4</code> 和 <code>2.4000000000000000000000001</code> 经过 <code>math.Float64bits()</code> 函数转换后的结果是一样的。自然，二者在 map 看来，就是同一个 key 了。</p>
<p>再来看一下 NAN（not a number）：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// NaN returns an IEEE 754 ``not-a-number&#39;&#39; value.</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">NaN</span><span style="color:#111">()</span> <span style="color:#00a8c8">float64</span> <span style="color:#111">{</span> <span style="color:#00a8c8">return</span> <span style="color:#75af00">Float64frombits</span><span style="color:#111">(</span><span style="color:#75af00">uvnan</span><span style="color:#111">)</span> <span style="color:#111">}</span>
</span></span></code></pre></div><p>uvan 的定义为：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">uvnan</span>    <span style="color:#111">=</span> <span style="color:#ae81ff">0x7FF8000000000001</span>
</span></span></code></pre></div><p>NAN() 直接调用 <code>Float64frombits</code>，传入写死的 const 型变量 <code>0x7FF8000000000001</code>，得到 NAN 型值。既然，NAN 是从一个常量解析得来的，为什么插入 map 时，会被认为是不同的 key？</p>
<p>这是由类型的哈希函数决定的，例如，对于 64 位的浮点数，它的哈希函数如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">f64hash</span><span style="color:#111">(</span><span style="color:#75af00">p</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">,</span> <span style="color:#75af00">h</span> <span style="color:#00a8c8">uintptr</span><span style="color:#111">)</span> <span style="color:#00a8c8">uintptr</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">f</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">*</span><span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#00a8c8">float64</span><span style="color:#111">)(</span><span style="color:#75af00">p</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">switch</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">case</span> <span style="color:#75af00">f</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">c1</span> <span style="color:#f92672">*</span> <span style="color:#111">(</span><span style="color:#75af00">c0</span> <span style="color:#111">^</span> <span style="color:#75af00">h</span><span style="color:#111">)</span> <span style="color:#75715e">// +0, -0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">case</span> <span style="color:#75af00">f</span> <span style="color:#f92672">!=</span> <span style="color:#75af00">f</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">c1</span> <span style="color:#f92672">*</span> <span style="color:#111">(</span><span style="color:#75af00">c0</span> <span style="color:#111">^</span> <span style="color:#75af00">h</span> <span style="color:#111">^</span> <span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">fastrand</span><span style="color:#111">()))</span> <span style="color:#75715e">// any kind of NaN</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">default</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">memhash</span><span style="color:#111">(</span><span style="color:#75af00">p</span><span style="color:#111">,</span> <span style="color:#75af00">h</span><span style="color:#111">,</span> <span style="color:#ae81ff">8</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>第二个 case，<code>f != f</code> 就是针对 <code>NAN</code>，这里会再加一个随机数。</p>
<p>这样，所有的谜题都解开了。</p>
<p>由于 NAN 的特性：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">NAN</span> <span style="color:#f92672">!=</span> <span style="color:#75af00">NAN</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">hash</span><span style="color:#111">(</span><span style="color:#75af00">NAN</span><span style="color:#111">)</span> <span style="color:#f92672">!=</span> <span style="color:#75af00">hash</span><span style="color:#111">(</span><span style="color:#75af00">NAN</span><span style="color:#111">)</span>
</span></span></code></pre></div><p>因此向 map 中查找的 key 为 NAN 时，什么也查不到；如果向其中增加了 4 次 NAN，遍历会得到 4 个 NAN。</p>
<p>最后说结论：float 型可以作为 key，但是由于精度的问题，会导致一些诡异的问题，慎用之。</p>
<h2 id="文章转自">文章转自</h2>
<ul>
<li><a href="https://juejin.cn/post/6844903848587296781">https://juejin.cn/post/6844903848587296781</a></li>
</ul>
]]></content:encoded><category>go</category><category>go</category><category>源码分析</category></item><item><title>zap高性能日志</title><link>https://daemon365.dev/post/go/zap_high_performance_log/</link><pubDate>Tue, 23 Mar 2021 00:00:00 +0800</pubDate><guid>https://daemon365.dev/post/go/zap_high_performance_log/</guid><description>&lt;h2 id="摘要"&gt;摘要&lt;/h2&gt;
&lt;p&gt;日志在整个工程实践中的重要性不言而喻，在选择日志组件的时候也有多方面的考量。详细、正确和及时的反馈是必不可少的，但是整个性能表现是否也是必要考虑的点呢？在长期的实践中发现有的日志组件对于计算资源的消耗十分巨大，这将导致整个服务成本的居高不下。此文从设计原理深度分析了 zap 的设计与实现上的权衡，也希望整个的选择、考量的过程能给其他的技术团队在开发高性能的 Go 组件时带来一定的借鉴意义。&lt;/p&gt;
&lt;h2 id="前言"&gt;前言&lt;/h2&gt;
&lt;p&gt;日志作为整个代码行为的记录，是程序执行逻辑和异常最直接的反馈。对于整个系统来说，日志是至关重要的组成部分。通过分析日志我们不仅可以发现系统的问题，同时日志中也蕴含了大量有价值可以被挖掘的信息，因此合理地记录日志是十分必要的。&lt;/p&gt;
&lt;p&gt;我们的业务通常会记录大量的 Debug 日志，但在实际测试过程中，发现我们使用的日志库 seelog 性能存在严重的瓶颈，在我们的对比结果中发现：zap 表现非常突出，单线程 Qps 也是 logrus、seelog 的数倍。&lt;/p&gt;
&lt;p&gt;在分析源码后 zap 设计与实现上的考量让我感到受益颇多，在这里我们主要分享一下以下几个方面：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;zap 为何有这么高的性能&lt;/li&gt;
&lt;li&gt;对于我们自己的开发有什么值得借鉴的地方&lt;/li&gt;
&lt;li&gt;如何正确的使用 Go 开发高性能的组件&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id="为什么选择使用zap"&gt;为什么选择使用ZAP&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;它同时提供了结构化日志记录和printf风格的日志记录&lt;/li&gt;
&lt;li&gt;它非常的快&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;根据Uber-go Zap的文档，它的性能比类似的结构化日志包更好——也比标准库更快。 以下是Zap发布的基准测试信息&lt;/p&gt;
&lt;p&gt;记录一条消息和10个字段:&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th style="text-align: center"&gt;Package&lt;/th&gt;
&lt;th style="text-align: center"&gt;Time&lt;/th&gt;
&lt;th style="text-align: center"&gt;Time % to zap&lt;/th&gt;
&lt;th style="text-align: center"&gt;Objects Allocated&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td style="text-align: center"&gt;⚡️ zap&lt;/td&gt;
&lt;td style="text-align: center"&gt;862 ns/op&lt;/td&gt;
&lt;td style="text-align: center"&gt;+0%&lt;/td&gt;
&lt;td style="text-align: center"&gt;5 allocs/op&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style="text-align: center"&gt;⚡️ zap (sugared)&lt;/td&gt;
&lt;td style="text-align: center"&gt;1250 ns/op&lt;/td&gt;
&lt;td style="text-align: center"&gt;+45%&lt;/td&gt;
&lt;td style="text-align: center"&gt;11 allocs/op&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style="text-align: center"&gt;zerolog&lt;/td&gt;
&lt;td style="text-align: center"&gt;4021 ns/op&lt;/td&gt;
&lt;td style="text-align: center"&gt;+366%&lt;/td&gt;
&lt;td style="text-align: center"&gt;76 allocs/op&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style="text-align: center"&gt;go-kit&lt;/td&gt;
&lt;td style="text-align: center"&gt;4542 ns/op&lt;/td&gt;
&lt;td style="text-align: center"&gt;+427%&lt;/td&gt;
&lt;td style="text-align: center"&gt;105 allocs/op&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style="text-align: center"&gt;apex/log&lt;/td&gt;
&lt;td style="text-align: center"&gt;26785 ns/op&lt;/td&gt;
&lt;td style="text-align: center"&gt;+3007%&lt;/td&gt;
&lt;td style="text-align: center"&gt;115 allocs/op&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style="text-align: center"&gt;logrus&lt;/td&gt;
&lt;td style="text-align: center"&gt;29501 ns/op&lt;/td&gt;
&lt;td style="text-align: center"&gt;+3322%&lt;/td&gt;
&lt;td style="text-align: center"&gt;125 allocs/op&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style="text-align: center"&gt;log15&lt;/td&gt;
&lt;td style="text-align: center"&gt;29906 ns/op&lt;/td&gt;
&lt;td style="text-align: center"&gt;+3369%&lt;/td&gt;
&lt;td style="text-align: center"&gt;122 allocs/op&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;记录一个静态字符串，没有任何上下文或printf风格的模板：&lt;/p&gt;</description><content:encoded><![CDATA[<h2 id="摘要">摘要</h2>
<p>日志在整个工程实践中的重要性不言而喻，在选择日志组件的时候也有多方面的考量。详细、正确和及时的反馈是必不可少的，但是整个性能表现是否也是必要考虑的点呢？在长期的实践中发现有的日志组件对于计算资源的消耗十分巨大，这将导致整个服务成本的居高不下。此文从设计原理深度分析了 zap 的设计与实现上的权衡，也希望整个的选择、考量的过程能给其他的技术团队在开发高性能的 Go 组件时带来一定的借鉴意义。</p>
<h2 id="前言">前言</h2>
<p>日志作为整个代码行为的记录，是程序执行逻辑和异常最直接的反馈。对于整个系统来说，日志是至关重要的组成部分。通过分析日志我们不仅可以发现系统的问题，同时日志中也蕴含了大量有价值可以被挖掘的信息，因此合理地记录日志是十分必要的。</p>
<p>我们的业务通常会记录大量的 Debug 日志，但在实际测试过程中，发现我们使用的日志库 seelog 性能存在严重的瓶颈，在我们的对比结果中发现：zap 表现非常突出，单线程 Qps 也是 logrus、seelog 的数倍。</p>
<p>在分析源码后 zap 设计与实现上的考量让我感到受益颇多，在这里我们主要分享一下以下几个方面：</p>
<ol>
<li>zap 为何有这么高的性能</li>
<li>对于我们自己的开发有什么值得借鉴的地方</li>
<li>如何正确的使用 Go 开发高性能的组件</li>
</ol>
<h2 id="为什么选择使用zap">为什么选择使用ZAP</h2>
<ul>
<li>它同时提供了结构化日志记录和printf风格的日志记录</li>
<li>它非常的快</li>
</ul>
<p>根据Uber-go Zap的文档，它的性能比类似的结构化日志包更好——也比标准库更快。 以下是Zap发布的基准测试信息</p>
<p>记录一条消息和10个字段:</p>
<table>
  <thead>
      <tr>
          <th style="text-align: center">Package</th>
          <th style="text-align: center">Time</th>
          <th style="text-align: center">Time % to zap</th>
          <th style="text-align: center">Objects Allocated</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: center">⚡️ zap</td>
          <td style="text-align: center">862 ns/op</td>
          <td style="text-align: center">+0%</td>
          <td style="text-align: center">5 allocs/op</td>
      </tr>
      <tr>
          <td style="text-align: center">⚡️ zap (sugared)</td>
          <td style="text-align: center">1250 ns/op</td>
          <td style="text-align: center">+45%</td>
          <td style="text-align: center">11 allocs/op</td>
      </tr>
      <tr>
          <td style="text-align: center">zerolog</td>
          <td style="text-align: center">4021 ns/op</td>
          <td style="text-align: center">+366%</td>
          <td style="text-align: center">76 allocs/op</td>
      </tr>
      <tr>
          <td style="text-align: center">go-kit</td>
          <td style="text-align: center">4542 ns/op</td>
          <td style="text-align: center">+427%</td>
          <td style="text-align: center">105 allocs/op</td>
      </tr>
      <tr>
          <td style="text-align: center">apex/log</td>
          <td style="text-align: center">26785 ns/op</td>
          <td style="text-align: center">+3007%</td>
          <td style="text-align: center">115 allocs/op</td>
      </tr>
      <tr>
          <td style="text-align: center">logrus</td>
          <td style="text-align: center">29501 ns/op</td>
          <td style="text-align: center">+3322%</td>
          <td style="text-align: center">125 allocs/op</td>
      </tr>
      <tr>
          <td style="text-align: center">log15</td>
          <td style="text-align: center">29906 ns/op</td>
          <td style="text-align: center">+3369%</td>
          <td style="text-align: center">122 allocs/op</td>
      </tr>
  </tbody>
</table>
<p>记录一个静态字符串，没有任何上下文或printf风格的模板：</p>
<table>
  <thead>
      <tr>
          <th style="text-align: center">Package</th>
          <th style="text-align: center">Time</th>
          <th style="text-align: center">Time % to zap</th>
          <th style="text-align: center">Objects Allocated</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: center">⚡️ zap</td>
          <td style="text-align: center">118 ns/op</td>
          <td style="text-align: center">+0%</td>
          <td style="text-align: center">0 allocs/op</td>
      </tr>
      <tr>
          <td style="text-align: center">⚡️ zap (sugared)</td>
          <td style="text-align: center">191 ns/op</td>
          <td style="text-align: center">+62%</td>
          <td style="text-align: center">2 allocs/op</td>
      </tr>
      <tr>
          <td style="text-align: center">zerolog</td>
          <td style="text-align: center">93 ns/op</td>
          <td style="text-align: center">-21%</td>
          <td style="text-align: center">0 allocs/op</td>
      </tr>
      <tr>
          <td style="text-align: center">go-kit</td>
          <td style="text-align: center">280 ns/op</td>
          <td style="text-align: center">+137%</td>
          <td style="text-align: center">11 allocs/op</td>
      </tr>
      <tr>
          <td style="text-align: center">standard library</td>
          <td style="text-align: center">499 ns/op</td>
          <td style="text-align: center">+323%</td>
          <td style="text-align: center">2 allocs/op</td>
      </tr>
      <tr>
          <td style="text-align: center">apex/log</td>
          <td style="text-align: center">1990 ns/op</td>
          <td style="text-align: center">+1586%</td>
          <td style="text-align: center">10 allocs/op</td>
      </tr>
      <tr>
          <td style="text-align: center">logrus</td>
          <td style="text-align: center">3129 ns/op</td>
          <td style="text-align: center">+2552%</td>
          <td style="text-align: center">24 allocs/op</td>
      </tr>
      <tr>
          <td style="text-align: center">log15</td>
          <td style="text-align: center">3887 ns/op</td>
          <td style="text-align: center">+3194%</td>
          <td style="text-align: center">23 allocs/op</td>
      </tr>
  </tbody>
</table>
<h2 id="安装">安装</h2>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>go get -u go.uber.org/zap
</span></span></code></pre></div><h2 id="示例">示例</h2>
<h3 id="简单示例">简单示例</h3>
<h4 id="格式化输出">格式化输出</h4>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d88200">&#34;go.uber.org/zap&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d88200">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// zap.NewDevelopment 格式化输出</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">logger</span><span style="color:#111">,</span> <span style="color:#75af00">_</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">ewDevelopment</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">defer</span> <span style="color:#75af00">logger</span><span style="color:#111">.</span><span style="color:#75af00">Sync</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">logger</span><span style="color:#111">.</span><span style="color:#75af00">Info</span><span style="color:#111">(</span><span style="color:#d88200">&#34;无法获取网址&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">String</span><span style="color:#111">(</span><span style="color:#d88200">&#34;url&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;http://www.baidu.com&#34;</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">Int</span><span style="color:#111">(</span><span style="color:#d88200">&#34;attempt&#34;</span><span style="color:#111">,</span> <span style="color:#ae81ff">3</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">Duration</span><span style="color:#111">(</span><span style="color:#d88200">&#34;backoff&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Second</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>格式化输出打印结果：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ae81ff">2019</span><span style="color:#f92672">-</span><span style="color:#ae81ff">01</span><span style="color:#f92672">-</span><span style="color:#ae81ff">02</span><span style="color:#75af00">T15</span><span style="color:#111">:</span><span style="color:#ae81ff">01</span><span style="color:#111">:</span><span style="color:#ae81ff">13.923</span><span style="color:#f92672">+</span><span style="color:#ae81ff">0800</span>    <span style="color:#75af00">INFO</span>    <span style="color:#75af00">spikeProxy</span><span style="color:#f92672">/</span><span style="color:#75af00">main</span><span style="color:#111">.</span><span style="color:#00a8c8">go</span><span style="color:#111">:</span><span style="color:#ae81ff">17</span>   <span style="color:#75af00">failed</span> <span style="color:#75af00">to</span> <span style="color:#75af00">fetch</span> <span style="color:#75af00">URL</span> <span style="color:#111">{</span><span style="color:#d88200">&#34;url&#34;</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;http://www.baidu.com&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;attempt&#34;</span><span style="color:#111">:</span> <span style="color:#ae81ff">3</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;backoff&#34;</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;1s&#34;</span><span style="color:#111">}</span>
</span></span></code></pre></div><h4 id="json-序列化输出">json 序列化输出</h4>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d88200">&#34;go.uber.org/zap&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d88200">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75715e">// zap.NewProduction json序列化输出</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">logger</span><span style="color:#111">,</span> <span style="color:#75af00">_</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">NewProduction</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">defer</span> <span style="color:#75af00">logger</span><span style="color:#111">.</span><span style="color:#75af00">Sync</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">logger</span><span style="color:#111">.</span><span style="color:#75af00">Info</span><span style="color:#111">(</span><span style="color:#d88200">&#34;无法获取网址&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">String</span><span style="color:#111">(</span><span style="color:#d88200">&#34;url&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;http://www.baidu.com&#34;</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">Int</span><span style="color:#111">(</span><span style="color:#d88200">&#34;attempt&#34;</span><span style="color:#111">,</span> <span style="color:#ae81ff">3</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">Duration</span><span style="color:#111">(</span><span style="color:#d88200">&#34;backoff&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Second</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>json序列化输出打印结果：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#111">{</span><span style="color:#d88200">&#34;level&#34;</span><span style="color:#111">:</span><span style="color:#d88200">&#34;info&#34;</span><span style="color:#111">,</span><span style="color:#d88200">&#34;ts&#34;</span><span style="color:#111">:</span><span style="color:#ae81ff">1546413239.1466308</span><span style="color:#111">,</span><span style="color:#d88200">&#34;caller&#34;</span><span style="color:#111">:</span><span style="color:#d88200">&#34;spikeProxy/main.go:16&#34;</span><span style="color:#111">,</span><span style="color:#d88200">&#34;msg&#34;</span><span style="color:#111">:</span><span style="color:#d88200">&#34;无法获取网址&#34;</span><span style="color:#111">,</span><span style="color:#d88200">&#34;url&#34;</span><span style="color:#111">:</span><span style="color:#d88200">&#34;http://www.baidu.com&#34;</span><span style="color:#111">,</span><span style="color:#d88200">&#34;attempt&#34;</span><span style="color:#111">:</span><span style="color:#ae81ff">3</span><span style="color:#111">,</span><span style="color:#d88200">&#34;backoff&#34;</span><span style="color:#111">:</span><span style="color:#ae81ff">1</span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="自定义示例">自定义示例</h3>
<p>选择一个日志库除了高性能是考量的一个标准，高扩展也非常重要，例如：json key 自定义、时间格式化、日志级别等。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d88200">&#34;go.uber.org/zap&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d88200">&#34;go.uber.org/zap/zapcore&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d88200">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">encoderConfig</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">zapcore</span><span style="color:#111">.</span><span style="color:#75af00">EncoderConfig</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">TimeKey</span><span style="color:#111">:</span>        <span style="color:#d88200">&#34;time&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">LevelKey</span><span style="color:#111">:</span>       <span style="color:#d88200">&#34;level&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">NameKey</span><span style="color:#111">:</span>        <span style="color:#d88200">&#34;logger&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">CallerKey</span><span style="color:#111">:</span>      <span style="color:#d88200">&#34;caller&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">MessageKey</span><span style="color:#111">:</span>     <span style="color:#d88200">&#34;msg&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">StacktraceKey</span><span style="color:#111">:</span>  <span style="color:#d88200">&#34;stacktrace&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">LineEnding</span><span style="color:#111">:</span>     <span style="color:#75af00">zapcore</span><span style="color:#111">.</span><span style="color:#75af00">DefaultLineEnding</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">EncodeLevel</span><span style="color:#111">:</span>    <span style="color:#75af00">zapcore</span><span style="color:#111">.</span><span style="color:#75af00">LowercaseLevelEncoder</span><span style="color:#111">,</span>  <span style="color:#75715e">// 小写编码器</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">EncodeTime</span><span style="color:#111">:</span>     <span style="color:#75af00">zapcore</span><span style="color:#111">.</span><span style="color:#75af00">ISO8601TimeEncoder</span><span style="color:#111">,</span>     <span style="color:#75715e">// ISO8601 UTC 时间格式</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">EncodeDuration</span><span style="color:#111">:</span> <span style="color:#75af00">zapcore</span><span style="color:#111">.</span><span style="color:#75af00">SecondsDurationEncoder</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">EncodeCaller</span><span style="color:#111">:</span>   <span style="color:#75af00">zapcore</span><span style="color:#111">.</span><span style="color:#75af00">FullCallerEncoder</span><span style="color:#111">,</span>      <span style="color:#75715e">// 全路径编码器</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 设置日志级别</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">atom</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">NewAtomicLevelAt</span><span style="color:#111">(</span><span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">DebugLevel</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">config</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">Config</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">Level</span><span style="color:#111">:</span>            <span style="color:#75af00">atom</span><span style="color:#111">,</span>                                                <span style="color:#75715e">// 日志级别</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">Development</span><span style="color:#111">:</span>      <span style="color:#00a8c8">true</span><span style="color:#111">,</span>                                                <span style="color:#75715e">// 开发模式，堆栈跟踪</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">Encoding</span><span style="color:#111">:</span>         <span style="color:#d88200">&#34;json&#34;</span><span style="color:#111">,</span>                                              <span style="color:#75715e">// 输出格式 console 或 json</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">EncoderConfig</span><span style="color:#111">:</span>    <span style="color:#75af00">encoderConfig</span><span style="color:#111">,</span>                                       <span style="color:#75715e">// 编码器配置</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">InitialFields</span><span style="color:#111">:</span>    <span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#00a8c8">string</span><span style="color:#111">]</span><span style="color:#00a8c8">interface</span><span style="color:#111">{}{</span><span style="color:#d88200">&#34;serviceName&#34;</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;spikeProxy&#34;</span><span style="color:#111">},</span> <span style="color:#75715e">// 初始化字段，如：添加一个服务器名称</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">OutputPaths</span><span style="color:#111">:</span>      <span style="color:#111">[]</span><span style="color:#00a8c8">string</span><span style="color:#111">{</span><span style="color:#d88200">&#34;stdout&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;./logs/spikeProxy.log&#34;</span><span style="color:#111">},</span>         <span style="color:#75715e">// 输出到指定文件 stdout（标准输出，正常颜色） stderr（错误输出，红色）</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">ErrorOutputPaths</span><span style="color:#111">:</span> <span style="color:#111">[]</span><span style="color:#00a8c8">string</span><span style="color:#111">{</span><span style="color:#d88200">&#34;stderr&#34;</span><span style="color:#111">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 构建日志</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">logger</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">config</span><span style="color:#111">.</span><span style="color:#75af00">Build</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Sprintf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;log 初始化失败: %v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">logger</span><span style="color:#111">.</span><span style="color:#75af00">Info</span><span style="color:#111">(</span><span style="color:#d88200">&#34;log 初始化成功&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">logger</span><span style="color:#111">.</span><span style="color:#75af00">Info</span><span style="color:#111">(</span><span style="color:#d88200">&#34;无法获取网址&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">String</span><span style="color:#111">(</span><span style="color:#d88200">&#34;url&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;http://www.baidu.com&#34;</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">Int</span><span style="color:#111">(</span><span style="color:#d88200">&#34;attempt&#34;</span><span style="color:#111">,</span> <span style="color:#ae81ff">3</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">Duration</span><span style="color:#111">(</span><span style="color:#d88200">&#34;backoff&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Second</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>打印结果：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#111">{</span><span style="color:#d88200">&#34;level&#34;</span><span style="color:#111">:</span><span style="color:#d88200">&#34;info&#34;</span><span style="color:#111">,</span><span style="color:#d88200">&#34;time&#34;</span><span style="color:#111">:</span><span style="color:#d88200">&#34;2019-01-02T15:38:33.778+0800&#34;</span><span style="color:#111">,</span><span style="color:#d88200">&#34;caller&#34;</span><span style="color:#111">:</span><span style="color:#d88200">&#34;/Users/lcl/go/src/spikeProxy/main.go:54&#34;</span><span style="color:#111">,</span><span style="color:#d88200">&#34;msg&#34;</span><span style="color:#111">:</span><span style="color:#d88200">&#34;log 初始化成功&#34;</span><span style="color:#111">,</span><span style="color:#d88200">&#34;serviceName&#34;</span><span style="color:#111">:</span><span style="color:#d88200">&#34;spikeProxy&#34;</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">{</span><span style="color:#d88200">&#34;level&#34;</span><span style="color:#111">:</span><span style="color:#d88200">&#34;info&#34;</span><span style="color:#111">,</span><span style="color:#d88200">&#34;time&#34;</span><span style="color:#111">:</span><span style="color:#d88200">&#34;2019-01-02T15:38:33.778+0800&#34;</span><span style="color:#111">,</span><span style="color:#d88200">&#34;caller&#34;</span><span style="color:#111">:</span><span style="color:#d88200">&#34;/Users/lcl/go/src/spikeProxy/main.go:56&#34;</span><span style="color:#111">,</span><span style="color:#d88200">&#34;msg&#34;</span><span style="color:#111">:</span><span style="color:#d88200">&#34;无法获取网址&#34;</span><span style="color:#111">,</span><span style="color:#d88200">&#34;serviceName&#34;</span><span style="color:#111">:</span><span style="color:#d88200">&#34;spikeProxy&#34;</span><span style="color:#111">,</span><span style="color:#d88200">&#34;url&#34;</span><span style="color:#111">:</span><span style="color:#d88200">&#34;http://www.baidu.com&#34;</span><span style="color:#111">,</span><span style="color:#d88200">&#34;attempt&#34;</span><span style="color:#111">:</span><span style="color:#ae81ff">3</span><span style="color:#111">,</span><span style="color:#d88200">&#34;backoff&#34;</span><span style="color:#111">:</span><span style="color:#ae81ff">1</span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="写入归档文件示例">写入归档文件示例</h2>
<h2 id="安装-lumberjack">安装 lumberjack</h2>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">go</span> <span style="color:#75af00">get</span> <span style="color:#75af00">gopkg</span><span style="color:#111">.</span><span style="color:#75af00">in</span><span style="color:#f92672">/</span><span style="color:#75af00">natefinch</span><span style="color:#f92672">/</span><span style="color:#75af00">lumberjack</span><span style="color:#111">.</span><span style="color:#75af00">v2</span>
</span></span></code></pre></div><h2 id="lumberjack介绍">lumberjack介绍</h2>
<p>Lumberjack是一个Go包，用于将日志写入滚动文件。
zap 不支持文件归档，如果要支持文件按大小或者时间归档，需要使用lumberjack，lumberjack也是<a href="https://github.com/uber-go/zap/blob/master/FAQ.md">zap官方推荐</a>的。</p>
<h2 id="示例-1">示例</h2>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d88200">&#34;go.uber.org/zap&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d88200">&#34;go.uber.org/zap/zapcore&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d88200">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d88200">&#34;gopkg.in/natefinch/lumberjack.v2&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d88200">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">hook</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">lumberjack</span><span style="color:#111">.</span><span style="color:#75af00">Logger</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">Filename</span><span style="color:#111">:</span>   <span style="color:#d88200">&#34;./logs/spikeProxy1.log&#34;</span><span style="color:#111">,</span> <span style="color:#75715e">// 日志文件路径</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">MaxSize</span><span style="color:#111">:</span>    <span style="color:#ae81ff">128</span><span style="color:#111">,</span>                      <span style="color:#75715e">// 每个日志文件保存的最大尺寸 单位：M</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">MaxBackups</span><span style="color:#111">:</span> <span style="color:#ae81ff">30</span><span style="color:#111">,</span>                       <span style="color:#75715e">// 日志文件最多保存多少个备份</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">MaxAge</span><span style="color:#111">:</span>     <span style="color:#ae81ff">7</span><span style="color:#111">,</span>                        <span style="color:#75715e">// 文件最多保存多少天</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">Compress</span><span style="color:#111">:</span>   <span style="color:#00a8c8">true</span><span style="color:#111">,</span>                     <span style="color:#75715e">// 是否压缩</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">encoderConfig</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">zapcore</span><span style="color:#111">.</span><span style="color:#75af00">EncoderConfig</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">TimeKey</span><span style="color:#111">:</span>        <span style="color:#d88200">&#34;time&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">LevelKey</span><span style="color:#111">:</span>       <span style="color:#d88200">&#34;level&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">NameKey</span><span style="color:#111">:</span>        <span style="color:#d88200">&#34;logger&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">CallerKey</span><span style="color:#111">:</span>      <span style="color:#d88200">&#34;linenum&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">MessageKey</span><span style="color:#111">:</span>     <span style="color:#d88200">&#34;msg&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">StacktraceKey</span><span style="color:#111">:</span>  <span style="color:#d88200">&#34;stacktrace&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">LineEnding</span><span style="color:#111">:</span>     <span style="color:#75af00">zapcore</span><span style="color:#111">.</span><span style="color:#75af00">DefaultLineEnding</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">EncodeLevel</span><span style="color:#111">:</span>    <span style="color:#75af00">zapcore</span><span style="color:#111">.</span><span style="color:#75af00">LowercaseLevelEncoder</span><span style="color:#111">,</span>  <span style="color:#75715e">// 小写编码器</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">EncodeTime</span><span style="color:#111">:</span>     <span style="color:#75af00">zapcore</span><span style="color:#111">.</span><span style="color:#75af00">ISO8601TimeEncoder</span><span style="color:#111">,</span>     <span style="color:#75715e">// ISO8601 UTC 时间格式</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">EncodeDuration</span><span style="color:#111">:</span> <span style="color:#75af00">zapcore</span><span style="color:#111">.</span><span style="color:#75af00">SecondsDurationEncoder</span><span style="color:#111">,</span> <span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        EncodeCaller:   zapcore.FullCallerEncoder,      // 全路径编码器</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">EncodeName</span><span style="color:#111">:</span>     <span style="color:#75af00">zapcore</span><span style="color:#111">.</span><span style="color:#75af00">FullNameEncoder</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 设置日志级别</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">atomicLevel</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">NewAtomicLevel</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">atomicLevel</span><span style="color:#111">.</span><span style="color:#75af00">SetLevel</span><span style="color:#111">(</span><span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">InfoLevel</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">core</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">zapcore</span><span style="color:#111">.</span><span style="color:#75af00">NewCore</span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">zapcore</span><span style="color:#111">.</span><span style="color:#75af00">NewJSONEncoder</span><span style="color:#111">(</span><span style="color:#75af00">encoderConfig</span><span style="color:#111">),</span>                                           <span style="color:#75715e">// 编码器配置</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">zapcore</span><span style="color:#111">.</span><span style="color:#75af00">NewMultiWriteSyncer</span><span style="color:#111">(</span><span style="color:#75af00">zapcore</span><span style="color:#111">.</span><span style="color:#75af00">AddSync</span><span style="color:#111">(</span><span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">Stdout</span><span style="color:#111">),</span> <span style="color:#75af00">zapcore</span><span style="color:#111">.</span><span style="color:#75af00">AddSync</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">hook</span><span style="color:#111">)),</span> <span style="color:#75715e">// 打印到控制台和文件</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">atomicLevel</span><span style="color:#111">,</span>                                                                     <span style="color:#75715e">// 日志级别</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 开启开发模式，堆栈跟踪</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">caller</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">AddCaller</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 开启文件及行号</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">development</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">Development</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 设置初始化字段</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">filed</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">Fields</span><span style="color:#111">(</span><span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">String</span><span style="color:#111">(</span><span style="color:#d88200">&#34;serviceName&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;serviceName&#34;</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 构造日志</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">logger</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">New</span><span style="color:#111">(</span><span style="color:#75af00">core</span><span style="color:#111">,</span> <span style="color:#75af00">caller</span><span style="color:#111">,</span> <span style="color:#75af00">development</span><span style="color:#111">,</span> <span style="color:#75af00">filed</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">logger</span><span style="color:#111">.</span><span style="color:#75af00">Info</span><span style="color:#111">(</span><span style="color:#d88200">&#34;log 初始化成功&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">logger</span><span style="color:#111">.</span><span style="color:#75af00">Info</span><span style="color:#111">(</span><span style="color:#d88200">&#34;无法获取网址&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">String</span><span style="color:#111">(</span><span style="color:#d88200">&#34;url&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;http://www.baidu.com&#34;</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">Int</span><span style="color:#111">(</span><span style="color:#d88200">&#34;attempt&#34;</span><span style="color:#111">,</span> <span style="color:#ae81ff">3</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">Duration</span><span style="color:#111">(</span><span style="color:#d88200">&#34;backoff&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Second</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>控制台打印结果：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#111">{</span><span style="color:#d88200">&#34;level&#34;</span><span style="color:#111">:</span><span style="color:#d88200">&#34;info&#34;</span><span style="color:#111">,</span><span style="color:#d88200">&#34;time&#34;</span><span style="color:#111">:</span><span style="color:#d88200">&#34;2019-01-02T16:14:43.608+0800&#34;</span><span style="color:#111">,</span><span style="color:#d88200">&#34;linenum&#34;</span><span style="color:#111">:</span><span style="color:#d88200">&#34;/Users/lcl/go/src/spikeProxy/main.go:56&#34;</span><span style="color:#111">,</span><span style="color:#d88200">&#34;msg&#34;</span><span style="color:#111">:</span><span style="color:#d88200">&#34;log 初始化成功&#34;</span><span style="color:#111">,</span><span style="color:#d88200">&#34;serviceName&#34;</span><span style="color:#111">:</span><span style="color:#d88200">&#34;serviceName&#34;</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">{</span><span style="color:#d88200">&#34;level&#34;</span><span style="color:#111">:</span><span style="color:#d88200">&#34;info&#34;</span><span style="color:#111">,</span><span style="color:#d88200">&#34;time&#34;</span><span style="color:#111">:</span><span style="color:#d88200">&#34;2019-01-02T16:14:43.608+0800&#34;</span><span style="color:#111">,</span><span style="color:#d88200">&#34;linenum&#34;</span><span style="color:#111">:</span><span style="color:#d88200">&#34;/Users/lcl/go/src/spikeProxy/main.go:57&#34;</span><span style="color:#111">,</span><span style="color:#d88200">&#34;msg&#34;</span><span style="color:#111">:</span><span style="color:#d88200">&#34;无法获取网址&#34;</span><span style="color:#111">,</span><span style="color:#d88200">&#34;serviceName&#34;</span><span style="color:#111">:</span><span style="color:#d88200">&#34;serviceName&#34;</span><span style="color:#111">,</span><span style="color:#d88200">&#34;url&#34;</span><span style="color:#111">:</span><span style="color:#d88200">&#34;http://www.baidu.com&#34;</span><span style="color:#111">,</span><span style="color:#d88200">&#34;attempt&#34;</span><span style="color:#111">:</span><span style="color:#ae81ff">3</span><span style="color:#111">,</span><span style="color:#d88200">&#34;backoff&#34;</span><span style="color:#111">:</span><span style="color:#ae81ff">1</span><span style="color:#111">}</span>
</span></span></code></pre></div><p>文件打印结果：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#111">{</span><span style="color:#d88200">&#34;level&#34;</span><span style="color:#111">:</span><span style="color:#d88200">&#34;info&#34;</span><span style="color:#111">,</span><span style="color:#d88200">&#34;time&#34;</span><span style="color:#111">:</span><span style="color:#d88200">&#34;2019-01-02T16:14:43.608+0800&#34;</span><span style="color:#111">,</span><span style="color:#d88200">&#34;linenum&#34;</span><span style="color:#111">:</span><span style="color:#d88200">&#34;/Users/lcl/go/src/spikeProxy/main.go:56&#34;</span><span style="color:#111">,</span><span style="color:#d88200">&#34;msg&#34;</span><span style="color:#111">:</span><span style="color:#d88200">&#34;log 初始化成功&#34;</span><span style="color:#111">,</span><span style="color:#d88200">&#34;serviceName&#34;</span><span style="color:#111">:</span><span style="color:#d88200">&#34;serviceName&#34;</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">{</span><span style="color:#d88200">&#34;level&#34;</span><span style="color:#111">:</span><span style="color:#d88200">&#34;info&#34;</span><span style="color:#111">,</span><span style="color:#d88200">&#34;time&#34;</span><span style="color:#111">:</span><span style="color:#d88200">&#34;2019-01-02T16:14:43.608+0800&#34;</span><span style="color:#111">,</span><span style="color:#d88200">&#34;linenum&#34;</span><span style="color:#111">:</span><span style="color:#d88200">&#34;/Users/lcl/go/src/spikeProxy/main.go:57&#34;</span><span style="color:#111">,</span><span style="color:#d88200">&#34;msg&#34;</span><span style="color:#111">:</span><span style="color:#d88200">&#34;无法获取网址&#34;</span><span style="color:#111">,</span><span style="color:#d88200">&#34;serviceName&#34;</span><span style="color:#111">:</span><span style="color:#d88200">&#34;serviceName&#34;</span><span style="color:#111">,</span><span style="color:#d88200">&#34;url&#34;</span><span style="color:#111">:</span><span style="color:#d88200">&#34;http://www.baidu.com&#34;</span><span style="color:#111">,</span><span style="color:#d88200">&#34;attempt&#34;</span><span style="color:#111">:</span><span style="color:#ae81ff">3</span><span style="color:#111">,</span><span style="color:#d88200">&#34;backoff&#34;</span><span style="color:#111">:</span><span style="color:#ae81ff">1</span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="gin框架使用zaplumberjack">gin框架使用zap+lumberjack</h2>
<h3 id="初始化zaplumberjack">初始化zap,lumberjack</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// viperconfig</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Log</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">FileName</span>   <span style="color:#00a8c8">string</span> <span style="color:#d88200">`yaml:&#34;filename&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">MaxSize</span>    <span style="color:#00a8c8">int</span>    <span style="color:#d88200">`yaml:&#34;maxsize&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">MaxBackups</span> <span style="color:#00a8c8">int</span>    <span style="color:#d88200">`yaml:&#34;maxbackups&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">MaxAges</span>    <span style="color:#00a8c8">int</span>    <span style="color:#d88200">`yaml:&#34;maxages&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Compress</span>   <span style="color:#00a8c8">bool</span>   <span style="color:#d88200">`yaml:&#34;compress&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Level</span>      <span style="color:#00a8c8">string</span> <span style="color:#d88200">`yaml:&#34;-&#34;`</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// init</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">var</span> <span style="color:#75af00">ZapLog</span> <span style="color:#f92672">*</span><span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">Logger</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// InitLogger 初始化Logger</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">InitLogger</span><span style="color:#111">(</span><span style="color:#75af00">cfg</span> <span style="color:#f92672">*</span><span style="color:#75af00">viperConfig</span><span style="color:#111">.</span><span style="color:#75af00">Log</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">writeSyncer</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">getLogWriter</span><span style="color:#111">(</span><span style="color:#75af00">cfg</span><span style="color:#111">.</span><span style="color:#75af00">FileName</span><span style="color:#111">,</span> <span style="color:#75af00">cfg</span><span style="color:#111">.</span><span style="color:#75af00">MaxSize</span><span style="color:#111">,</span> <span style="color:#75af00">cfg</span><span style="color:#111">.</span><span style="color:#75af00">MaxBackups</span><span style="color:#111">,</span> <span style="color:#75af00">cfg</span><span style="color:#111">.</span><span style="color:#75af00">MaxAges</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">encoder</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">getEncoder</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">var</span> <span style="color:#75af00">l</span> <span style="color:#111">=</span> <span style="color:#111">new</span><span style="color:#111">(</span><span style="color:#75af00">zapcore</span><span style="color:#111">.</span><span style="color:#75af00">Level</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">l</span><span style="color:#111">.</span><span style="color:#75af00">UnmarshalText</span><span style="color:#111">([]</span><span style="color:#111">byte</span><span style="color:#111">(</span><span style="color:#75af00">cfg</span><span style="color:#111">.</span><span style="color:#75af00">Level</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">core</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">zapcore</span><span style="color:#111">.</span><span style="color:#75af00">NewCore</span><span style="color:#111">(</span><span style="color:#75af00">encoder</span><span style="color:#111">,</span> <span style="color:#75af00">writeSyncer</span><span style="color:#111">,</span> <span style="color:#75af00">l</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ZapLog</span> <span style="color:#111">=</span> <span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">New</span><span style="color:#111">(</span><span style="color:#75af00">core</span><span style="color:#111">,</span> <span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">AddCaller</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">ReplaceGlobals</span><span style="color:#111">(</span><span style="color:#75af00">ZapLog</span><span style="color:#111">)</span> <span style="color:#75715e">// 替换zap包中全局的logger实例，后续在其他包中只需使用zap.L()调用即可</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">getEncoder</span><span style="color:#111">()</span> <span style="color:#75af00">zapcore</span><span style="color:#111">.</span><span style="color:#75af00">Encoder</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">encoderConfig</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">NewProductionEncoderConfig</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">encoderConfig</span><span style="color:#111">.</span><span style="color:#75af00">EncodeTime</span> <span style="color:#111">=</span> <span style="color:#75af00">zapcore</span><span style="color:#111">.</span><span style="color:#75af00">ISO8601TimeEncoder</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">encoderConfig</span><span style="color:#111">.</span><span style="color:#75af00">TimeKey</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">encoderConfig</span><span style="color:#111">.</span><span style="color:#75af00">EncodeLevel</span> <span style="color:#111">=</span> <span style="color:#75af00">zapcore</span><span style="color:#111">.</span><span style="color:#75af00">CapitalLevelEncoder</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">encoderConfig</span><span style="color:#111">.</span><span style="color:#75af00">EncodeDuration</span> <span style="color:#111">=</span> <span style="color:#75af00">zapcore</span><span style="color:#111">.</span><span style="color:#75af00">SecondsDurationEncoder</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">encoderConfig</span><span style="color:#111">.</span><span style="color:#75af00">EncodeCaller</span> <span style="color:#111">=</span> <span style="color:#75af00">zapcore</span><span style="color:#111">.</span><span style="color:#75af00">ShortCallerEncoder</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">zapcore</span><span style="color:#111">.</span><span style="color:#75af00">NewJSONEncoder</span><span style="color:#111">(</span><span style="color:#75af00">encoderConfig</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">getLogWriter</span><span style="color:#111">(</span><span style="color:#75af00">filename</span> <span style="color:#00a8c8">string</span><span style="color:#111">,</span> <span style="color:#75af00">maxSize</span><span style="color:#111">,</span> <span style="color:#75af00">maxBackup</span><span style="color:#111">,</span> <span style="color:#75af00">maxAge</span> <span style="color:#00a8c8">int</span><span style="color:#111">)</span> <span style="color:#75af00">zapcore</span><span style="color:#111">.</span><span style="color:#75af00">WriteSyncer</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">lumberJackLogger</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">lumberjack</span><span style="color:#111">.</span><span style="color:#75af00">Logger</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">Filename</span><span style="color:#111">:</span>   <span style="color:#75af00">filename</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">MaxSize</span><span style="color:#111">:</span>    <span style="color:#75af00">maxSize</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">MaxBackups</span><span style="color:#111">:</span> <span style="color:#75af00">maxBackup</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">MaxAge</span><span style="color:#111">:</span>     <span style="color:#75af00">maxAge</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">zapcore</span><span style="color:#111">.</span><span style="color:#75af00">AddSync</span><span style="color:#111">(</span><span style="color:#75af00">lumberJackLogger</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="gin日志中间件">gin日志中间件</h3>
<p>模仿Logger()和Recovery()的实现，使用我们的日志库来接收gin框架默认输出的日志。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// GinLogger 接收gin框架默认的日志</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">GinLogger</span><span style="color:#111">(</span><span style="color:#75af00">logger</span> <span style="color:#f92672">*</span><span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">Logger</span><span style="color:#111">)</span> <span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">HandlerFunc</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">start</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Now</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">path</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">Request</span><span style="color:#111">.</span><span style="color:#75af00">URL</span><span style="color:#111">.</span><span style="color:#75af00">Path</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">query</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">Request</span><span style="color:#111">.</span><span style="color:#75af00">URL</span><span style="color:#111">.</span><span style="color:#75af00">RawQuery</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">Next</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">cost</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">S</span><span style="color:#f92672">***</span><span style="color:#75af00">art</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">logger</span><span style="color:#111">.</span><span style="color:#75af00">Info</span><span style="color:#111">(</span><span style="color:#75af00">path</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">Int</span><span style="color:#111">(</span><span style="color:#d88200">&#34;status&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">Writer</span><span style="color:#111">.</span><span style="color:#75af00">Status</span><span style="color:#111">()),</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">String</span><span style="color:#111">(</span><span style="color:#d88200">&#34;method&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">Request</span><span style="color:#111">.</span><span style="color:#75af00">Method</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">String</span><span style="color:#111">(</span><span style="color:#d88200">&#34;path&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">path</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">String</span><span style="color:#111">(</span><span style="color:#d88200">&#34;query&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">query</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">String</span><span style="color:#111">(</span><span style="color:#d88200">&#34;ip&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">ClientIP</span><span style="color:#111">()),</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">String</span><span style="color:#111">(</span><span style="color:#d88200">&#34;user-agent&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">Request</span><span style="color:#111">.</span><span style="color:#75af00">UserAgent</span><span style="color:#111">()),</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">String</span><span style="color:#111">(</span><span style="color:#d88200">&#34;errors&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">Errors</span><span style="color:#111">.</span><span style="color:#75af00">ByType</span><span style="color:#111">(</span><span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">ErrorTypePrivate</span><span style="color:#111">).</span><span style="color:#75af00">String</span><span style="color:#111">()),</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">Duration</span><span style="color:#111">(</span><span style="color:#d88200">&#34;cost&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">cost</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// GinRecovery recover掉项目可能出现的panic</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">GinRecovery</span><span style="color:#111">(</span><span style="color:#75af00">logger</span> <span style="color:#f92672">*</span><span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">Logger</span><span style="color:#111">,</span> <span style="color:#75af00">stack</span> <span style="color:#00a8c8">bool</span><span style="color:#111">)</span> <span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">HandlerFunc</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">defer</span> <span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#111">recover</span><span style="color:#111">();</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// Check for a broken connection, as it is not really a</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// condition that warrants a panic stack trace.</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">var</span> <span style="color:#75af00">brokenPipe</span> <span style="color:#00a8c8">bool</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">if</span> <span style="color:#75af00">ne</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">err</span><span style="color:#111">.(</span><span style="color:#f92672">*</span><span style="color:#75af00">net</span><span style="color:#111">.</span><span style="color:#75af00">OpError</span><span style="color:#111">);</span> <span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#00a8c8">if</span> <span style="color:#75af00">se</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">ne</span><span style="color:#111">.</span><span style="color:#75af00">Err</span><span style="color:#111">.(</span><span style="color:#f92672">*</span><span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">SyscallError</span><span style="color:#111">);</span> <span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>						<span style="color:#00a8c8">if</span> <span style="color:#75af00">strings</span><span style="color:#111">.</span><span style="color:#75af00">Contains</span><span style="color:#111">(</span><span style="color:#75af00">strings</span><span style="color:#111">.</span><span style="color:#75af00">ToLower</span><span style="color:#111">(</span><span style="color:#75af00">se</span><span style="color:#111">.</span><span style="color:#75af00">Error</span><span style="color:#111">()),</span> <span style="color:#d88200">&#34;broken pipe&#34;</span><span style="color:#111">)</span> <span style="color:#f92672">||</span> <span style="color:#75af00">strings</span><span style="color:#111">.</span><span style="color:#75af00">Contains</span><span style="color:#111">(</span><span style="color:#75af00">strings</span><span style="color:#111">.</span><span style="color:#75af00">ToLower</span><span style="color:#111">(</span><span style="color:#75af00">se</span><span style="color:#111">.</span><span style="color:#75af00">Error</span><span style="color:#111">()),</span> <span style="color:#d88200">&#34;connection reset by peer&#34;</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>							<span style="color:#75af00">brokenPipe</span> <span style="color:#111">=</span> <span style="color:#00a8c8">true</span>
</span></span><span style="display:flex;"><span>						<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>					<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>				<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">httpRequest</span><span style="color:#111">,</span> <span style="color:#75af00">_</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">httputil</span><span style="color:#111">.</span><span style="color:#75af00">DumpRequest</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">Request</span><span style="color:#111">,</span> <span style="color:#00a8c8">false</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">if</span> <span style="color:#75af00">brokenPipe</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">logger</span><span style="color:#111">.</span><span style="color:#75af00">Error</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">Request</span><span style="color:#111">.</span><span style="color:#75af00">URL</span><span style="color:#111">.</span><span style="color:#75af00">Path</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>						<span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">Any</span><span style="color:#111">(</span><span style="color:#d88200">&#34;error&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>						<span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">String</span><span style="color:#111">(</span><span style="color:#d88200">&#34;request&#34;</span><span style="color:#111">,</span> <span style="color:#111">string</span><span style="color:#111">(</span><span style="color:#75af00">httpRequest</span><span style="color:#111">)),</span>
</span></span><span style="display:flex;"><span>					<span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75715e">// If the connection is dead, we can&#39;t write a status to it.</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">Error</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">.(</span><span style="color:#00a8c8">error</span><span style="color:#111">))</span> <span style="color:#75715e">// nolint: errcheck</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">Abort</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>					<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>				<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">if</span> <span style="color:#75af00">stack</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">logger</span><span style="color:#111">.</span><span style="color:#75af00">Error</span><span style="color:#111">(</span><span style="color:#d88200">&#34;[Recovery from panic]&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>						<span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">Any</span><span style="color:#111">(</span><span style="color:#d88200">&#34;error&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>						<span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">String</span><span style="color:#111">(</span><span style="color:#d88200">&#34;request&#34;</span><span style="color:#111">,</span> <span style="color:#111">string</span><span style="color:#111">(</span><span style="color:#75af00">httpRequest</span><span style="color:#111">)),</span>
</span></span><span style="display:flex;"><span>						<span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">String</span><span style="color:#111">(</span><span style="color:#d88200">&#34;stack&#34;</span><span style="color:#111">,</span> <span style="color:#111">string</span><span style="color:#111">(</span><span style="color:#75af00">debug</span><span style="color:#111">.</span><span style="color:#75af00">Stack</span><span style="color:#111">())),</span>
</span></span><span style="display:flex;"><span>					<span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">logger</span><span style="color:#111">.</span><span style="color:#75af00">Error</span><span style="color:#111">(</span><span style="color:#d88200">&#34;[Recovery from panic]&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>						<span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">Any</span><span style="color:#111">(</span><span style="color:#d88200">&#34;error&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>						<span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">String</span><span style="color:#111">(</span><span style="color:#d88200">&#34;request&#34;</span><span style="color:#111">,</span> <span style="color:#111">string</span><span style="color:#111">(</span><span style="color:#75af00">httpRequest</span><span style="color:#111">)),</span>
</span></span><span style="display:flex;"><span>					<span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">AbortWithStatus</span><span style="color:#111">(</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">StatusInternalServerError</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">Next</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>使用</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// 全局中间件</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">InitMiddleWares</span><span style="color:#111">(</span><span style="color:#75af00">eng</span> <span style="color:#f92672">*</span><span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Engine</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">eng</span><span style="color:#111">.</span><span style="color:#75af00">Use</span><span style="color:#111">(</span><span style="color:#75af00">GinLogger</span><span style="color:#111">(</span><span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">ZapLog</span><span style="color:#111">),</span> <span style="color:#75af00">GinRecovery</span><span style="color:#111">(</span><span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">ZapLog</span><span style="color:#111">,</span> <span style="color:#00a8c8">true</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>参考文章:</p>
<ul>
<li><a href="https://mp.weixin.qq.com/s/i0bMh_gLLrdnhAEWlF-xDw">https://mp.weixin.qq.com/s/i0bMh_gLLrdnhAEWlF-xDw</a></li>
<li><a href="https://studygolang.com/articles/17394">https://studygolang.com/articles/17394</a></li>
</ul>
]]></content:encoded><category>go</category><category>go</category><category>zap</category></item><item><title>golang channel原理</title><link>https://daemon365.dev/post/go/golang_channel_principle/</link><pubDate>Sun, 21 Feb 2021 00:00:00 +0800</pubDate><guid>https://daemon365.dev/post/go/golang_channel_principle/</guid><description>&lt;h2 id="channel介绍"&gt;channel介绍&lt;/h2&gt;
&lt;p&gt;channel一个类型管道，通过它可以在goroutine之间发送和接收消息。它是Golang在语言层面提供的goroutine间的通信方式。&lt;/p&gt;
&lt;p&gt;众所周知，Go依赖于称为CSP（Communicating Sequential Processes）的并发模型，通过Channel实现这种同步模式。Go并发的核心哲学是不要通过共享内存进行通信; 相反，通过沟通分享记忆。&lt;/p&gt;
&lt;p&gt;下面以简单的示例来演示Go如何通过channel来实现通信。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;package&lt;/span&gt; &lt;span style="color:#75af00"&gt;main&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;import&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;fmt&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;time&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;goRoutineA&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;a&lt;/span&gt; &lt;span style="color:#f92672"&gt;&amp;lt;-&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;chan&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;int&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;val&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#f92672"&gt;&amp;lt;-&lt;/span&gt;&lt;span style="color:#75af00"&gt;a&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;goRoutineA received the data&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;val&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;goRoutineB&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;b&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;chan&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;int&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;val&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#f92672"&gt;&amp;lt;-&lt;/span&gt;&lt;span style="color:#75af00"&gt;b&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;goRoutineB received the data&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;val&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;main&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;ch&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#111"&gt;make&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;chan&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;int&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;3&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;go&lt;/span&gt; &lt;span style="color:#75af00"&gt;goRoutineA&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;ch&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;go&lt;/span&gt; &lt;span style="color:#75af00"&gt;goRoutineB&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;ch&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;ch&lt;/span&gt; &lt;span style="color:#f92672"&gt;&amp;lt;-&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;3&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;time&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Sleep&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;time&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Second&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;1&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;结果为：&lt;code&gt;goRoutineA received the data 3&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;上面只是个简单的例子，只输出goRoutineA ，没有执行goRoutineB，说明channel仅允许被一个goroutine读写。&lt;/p&gt;
&lt;p&gt;go并发知识：&lt;a href="https://www.cnblogs.com/yuemoxi/p/15161276.html"&gt;链接&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;说道channel这里不得不提通道的结构hchan。&lt;/p&gt;
&lt;h2 id="hchan"&gt;hchan&lt;/h2&gt;
&lt;p&gt;源代码在src/runtime/chan.go&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;type&lt;/span&gt; &lt;span style="color:#75af00"&gt;hchan&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;struct&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;qcount&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;uint&lt;/span&gt; &lt;span style="color:#75715e"&gt;// total data in the queue&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;dataqsiz&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;uint&lt;/span&gt; &lt;span style="color:#75715e"&gt;// size of the circular queue&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;buf&lt;/span&gt; &lt;span style="color:#75af00"&gt;unsafe&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Pointer&lt;/span&gt; &lt;span style="color:#75715e"&gt;// points to an array of dataqsiz elements&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;elemsize&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;uint16&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;closed&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;uint32&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;elemtype&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;_type&lt;/span&gt; &lt;span style="color:#75715e"&gt;// element type&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;sendx&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;uint&lt;/span&gt; &lt;span style="color:#75715e"&gt;// send index&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;recvx&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;uint&lt;/span&gt; &lt;span style="color:#75715e"&gt;// receive index&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;recvq&lt;/span&gt; &lt;span style="color:#75af00"&gt;waitq&lt;/span&gt; &lt;span style="color:#75715e"&gt;// list of recv waiters&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;sendq&lt;/span&gt; &lt;span style="color:#75af00"&gt;waitq&lt;/span&gt; &lt;span style="color:#75715e"&gt;// list of send waiters&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// lock protects all fields in hchan, as well as several&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// fields in sudogs blocked on this channel.&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;//
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt; // Do not change another G&amp;#39;s status while holding this lock&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// (in particular, do not ready a G), as this can deadlock&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// with stack shrinking.&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;lock&lt;/span&gt; &lt;span style="color:#75af00"&gt;mutex&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;type&lt;/span&gt; &lt;span style="color:#75af00"&gt;waitq&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;struct&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;first&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;sudog&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;last&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;sudog&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;说明：&lt;/p&gt;</description><content:encoded><![CDATA[<h2 id="channel介绍">channel介绍</h2>
<p>channel一个类型管道，通过它可以在goroutine之间发送和接收消息。它是Golang在语言层面提供的goroutine间的通信方式。</p>
<p>众所周知，Go依赖于称为CSP（Communicating Sequential Processes）的并发模型，通过Channel实现这种同步模式。Go并发的核心哲学是不要通过共享内存进行通信; 相反，通过沟通分享记忆。</p>
<p>下面以简单的示例来演示Go如何通过channel来实现通信。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d88200">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">goRoutineA</span><span style="color:#111">(</span><span style="color:#75af00">a</span> <span style="color:#f92672">&lt;-</span><span style="color:#00a8c8">chan</span> <span style="color:#00a8c8">int</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">val</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#75af00">a</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;goRoutineA received the data&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">val</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">goRoutineB</span><span style="color:#111">(</span><span style="color:#75af00">b</span> <span style="color:#00a8c8">chan</span> <span style="color:#00a8c8">int</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">val</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#75af00">b</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;goRoutineB  received the data&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">val</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">ch</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">chan</span> <span style="color:#00a8c8">int</span><span style="color:#111">,</span> <span style="color:#ae81ff">3</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">go</span> <span style="color:#75af00">goRoutineA</span><span style="color:#111">(</span><span style="color:#75af00">ch</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">go</span> <span style="color:#75af00">goRoutineB</span><span style="color:#111">(</span><span style="color:#75af00">ch</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">ch</span> <span style="color:#f92672">&lt;-</span> <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Sleep</span><span style="color:#111">(</span><span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Second</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">1</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>结果为：<code>goRoutineA received the data 3</code></p>
<p>上面只是个简单的例子，只输出goRoutineA ，没有执行goRoutineB，说明channel仅允许被一个goroutine读写。</p>
<p>go并发知识：<a href="https://www.cnblogs.com/yuemoxi/p/15161276.html">链接</a></p>
<p>说道channel这里不得不提通道的结构hchan。</p>
<h2 id="hchan">hchan</h2>
<p>源代码在src/runtime/chan.go</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">hchan</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75af00">qcount</span>   <span style="color:#00a8c8">uint</span>           <span style="color:#75715e">// total data in the queue</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75af00">dataqsiz</span> <span style="color:#00a8c8">uint</span>           <span style="color:#75715e">// size of the circular queue</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75af00">buf</span>      <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span> <span style="color:#75715e">// points to an array of dataqsiz elements</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75af00">elemsize</span> <span style="color:#00a8c8">uint16</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75af00">closed</span>   <span style="color:#00a8c8">uint32</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75af00">elemtype</span> <span style="color:#f92672">*</span><span style="color:#75af00">_type</span> <span style="color:#75715e">// element type</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75af00">sendx</span>    <span style="color:#00a8c8">uint</span>   <span style="color:#75715e">// send index</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75af00">recvx</span>    <span style="color:#00a8c8">uint</span>   <span style="color:#75715e">// receive index</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75af00">recvq</span>    <span style="color:#75af00">waitq</span>  <span style="color:#75715e">// list of recv waiters</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75af00">sendq</span>    <span style="color:#75af00">waitq</span>  <span style="color:#75715e">// list of send waiters</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#75715e">// lock protects all fields in hchan, as well as several</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75715e">// fields in sudogs blocked on this channel.</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   // Do not change another G&#39;s status while holding this lock</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75715e">// (in particular, do not ready a G), as this can deadlock</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75715e">// with stack shrinking.</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75af00">lock</span> <span style="color:#75af00">mutex</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">waitq</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">first</span> <span style="color:#f92672">*</span><span style="color:#75af00">sudog</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">last</span>  <span style="color:#f92672">*</span><span style="color:#75af00">sudog</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>说明：</p>
<ul>
<li><strong>qcount</strong> uint // 当前队列中剩余元素个数</li>
<li><strong>dataqsiz</strong> uint // 环形队列长度，即缓冲区的大小，即make（chan T，N），N.</li>
<li><strong>buf</strong> unsafe.Pointer // 环形队列指针</li>
<li><strong>elemsize</strong> uint16 // 每个元素的大小</li>
<li><strong>closed</strong> uint32 // 表示当前通道是否处于关闭状态。创建通道后，该字段设置为0，即通道打开; 通过调用close将其设置为1，通道关闭。</li>
<li><strong>elemtype</strong> *_type // 元素类型，用于数据传递过程中的赋值；</li>
<li><strong>sendx</strong> uint和<strong>recvx</strong> uint是环形缓冲区的状态字段，它指示缓冲区的当前索引 - 支持数组，它可以从中发送数据和接收数据。</li>
<li><strong>recvq</strong> waitq // 等待读消息的goroutine队列</li>
<li><strong>sendq</strong> waitq // 等待写消息的goroutine队列</li>
<li><strong>lock</strong> mutex // 互斥锁，为每个读写操作锁定通道，因为发送和接收必须是互斥操作。</li>
</ul>
<p>这里<strong>sudog代表goroutine。</strong></p>
<h2 id="make-chan">make chan</h2>
<p>make函数在创建channel的时候会在该进程的heap区申请一块内存，创建一个hchan结构体，返回执行该内存的指针，所以获取的的ch变量本身就是一个指针，在函数之间传递的时候是同一个channel。</p>
<p>hchan结构体使<strong>用一个环形队列</strong>来保存groutine之间传递的数据(如果是缓存channel的话)，使用<strong>两个list</strong>保存像该chan发送和从该chan接收数据的goroutine，还有一个mutex来保证操作这些结构的安全。</p>
<p>创建channel 有两种，一种是带缓冲的channel，一种是不带缓冲的channel</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// 带缓冲</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">ch</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">chan</span> <span style="color:#75af00">Task</span><span style="color:#111">,</span> <span style="color:#ae81ff">3</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 不带缓冲</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">ch</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">chan</span> <span style="color:#00a8c8">int</span><span style="color:#111">)</span>
</span></span></code></pre></div><p>这里我们先讨论带缓冲</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">ch</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">chan</span> <span style="color:#00a8c8">int</span><span style="color:#111">,</span> <span style="color:#ae81ff">3</span><span style="color:#111">)</span>
</span></span></code></pre></div><p>创建通道后的缓冲通道结构</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">hchan</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">qcount</span> <span style="color:#00a8c8">uint</span> <span style="color:#111">:</span> <span style="color:#ae81ff">0</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">dataqsiz</span> <span style="color:#00a8c8">uint</span> <span style="color:#111">:</span> <span style="color:#ae81ff">3</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">buf</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span> <span style="color:#111">:</span> <span style="color:#ae81ff">0xc00007e0e0</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">elemsize</span> <span style="color:#00a8c8">uint16</span> <span style="color:#111">:</span> <span style="color:#ae81ff">8</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">closed</span> <span style="color:#00a8c8">uint32</span> <span style="color:#111">:</span> <span style="color:#ae81ff">0</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">elemtype</span> <span style="color:#f92672">*</span><span style="color:#75af00">runtime</span><span style="color:#111">.</span><span style="color:#75af00">_type</span> <span style="color:#111">:</span> <span style="color:#f92672">&amp;</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">size</span><span style="color:#111">:</span><span style="color:#ae81ff">8</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">ptrdata</span><span style="color:#111">:</span><span style="color:#ae81ff">0</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">hash</span><span style="color:#111">:</span><span style="color:#ae81ff">4149441018</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">tflag</span><span style="color:#111">:</span><span style="color:#ae81ff">7</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">align</span><span style="color:#111">:</span><span style="color:#ae81ff">8</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">fieldalign</span><span style="color:#111">:</span><span style="color:#ae81ff">8</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">kind</span><span style="color:#111">:</span><span style="color:#ae81ff">130</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">alg</span><span style="color:#111">:</span><span style="color:#ae81ff">0x55cdf0</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">gcdata</span><span style="color:#111">:</span><span style="color:#ae81ff">0x4d61b4</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">str</span><span style="color:#111">:</span><span style="color:#ae81ff">1055</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">ptrToThis</span><span style="color:#111">:</span><span style="color:#ae81ff">45152</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">sendx</span> <span style="color:#00a8c8">uint</span> <span style="color:#111">:</span> <span style="color:#ae81ff">0</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">recvx</span> <span style="color:#00a8c8">uint</span> <span style="color:#111">:</span> <span style="color:#ae81ff">0</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">recvq</span> <span style="color:#75af00">runtime</span><span style="color:#111">.</span><span style="color:#75af00">waitq</span> <span style="color:#111">:</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#111">{</span><span style="color:#75af00">first</span><span style="color:#111">:&lt;</span><span style="color:#00a8c8">nil</span><span style="color:#111">&gt;</span> <span style="color:#75af00">last</span><span style="color:#111">:&lt;</span><span style="color:#00a8c8">nil</span><span style="color:#111">&gt;}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">sendq</span> <span style="color:#75af00">runtime</span><span style="color:#111">.</span><span style="color:#75af00">waitq</span> <span style="color:#111">:</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#111">{</span><span style="color:#75af00">first</span><span style="color:#111">:&lt;</span><span style="color:#00a8c8">nil</span><span style="color:#111">&gt;</span> <span style="color:#75af00">last</span><span style="color:#111">:&lt;</span><span style="color:#00a8c8">nil</span><span style="color:#111">&gt;}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">lock</span> <span style="color:#75af00">runtime</span><span style="color:#111">.</span><span style="color:#75af00">mutex</span> <span style="color:#111">:</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#111">{</span><span style="color:#75af00">key</span><span style="color:#111">:</span><span style="color:#ae81ff">0</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>源代码</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">makechan</span><span style="color:#111">(</span><span style="color:#75af00">t</span> <span style="color:#f92672">*</span><span style="color:#75af00">chantype</span><span style="color:#111">,</span> <span style="color:#75af00">size</span> <span style="color:#00a8c8">int</span><span style="color:#111">)</span> <span style="color:#f92672">*</span><span style="color:#75af00">hchan</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#75af00">elem</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">elem</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>如果我们创建一个带buffer的channel，底层的数据模型如下图：</p>
<p><img src="/images/44becf0e-3cef-4a92-ad1b-74b0d3be075d.png" alt=""></p>
<h2 id="发送和接受数据">发送和接受数据</h2>
<p>向channel发送和从channel接收数据主要涉及hchan里的四个成员变量，借用Kavya ppt里的图示，来分析发送和接收的过程。</p>
<p><img src="/images/1c0e0400-0356-483d-9144-1ed65764ec37.png" alt=""></p>
<h3 id="向channel写入数据">向channel写入数据</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">ch</span> <span style="color:#f92672">&lt;-</span> <span style="color:#ae81ff">3</span>
</span></span></code></pre></div><p>底层hchan数据流程如图</p>
<p><img src="/images/dbd15c57-37a3-4d27-b110-d78695a1ed23.png" alt="">
<img src="/images/aeb25cf7-f059-4086-a8e7-26efb72aa85e.png" alt=""></p>
<p>发送操作概要</p>
<p>1、锁定整个通道结构。</p>
<p>2、确定写入。尝试<code>recvq</code>从等待队列中等待goroutine，然后将元素直接写入goroutine。</p>
<p>3、如果recvq为Empty，则确定缓冲区是否可用。如果可用，从当前goroutine复制数据到缓冲区。</p>
<p>4、如果缓冲区已满，<strong>则要</strong>写入的元素将保存在当前正在执行的goroutine的结构中，并且当前goroutine将在<strong>sendq中</strong>排队并从运行时挂起。</p>
<p>5、写入完成释放锁。</p>
<p>这里我们要注意几个属性buf、sendx、lock的变化。</p>
<p>流程图</p>
<p><img src="/images/45ec829d-b33d-49df-8be8-a2adb1f6c2f2.png" alt=""></p>
<h3 id="从channel读取操作">从channel读取操作</h3>
<p>几乎和写入操作相同</p>
<p>代码</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">goRoutineA</span><span style="color:#111">(</span><span style="color:#75af00">a</span> <span style="color:#f92672">&lt;-</span><span style="color:#00a8c8">chan</span> <span style="color:#00a8c8">int</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75af00">val</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#75af00">a</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;goRoutineA received the data&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">val</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>底层hchan数据流程如图</p>
<p><img src="/images/35c33001-5ed0-43b5-88bb-78d533a3174d.png" alt="">
<img src="/images/0386fc04-eeb6-4fb8-bcca-dec41f787ddd.png" alt=""></p>
<p>这里我们要注意几个属性buf、sendx、recvx、lock的变化。</p>
<p>读取操作概要</p>
<ol>
<li>先获取channel全局锁</li>
<li>尝试sendq从等待队列中获取等待的goroutine，</li>
<li>如有等待的goroutine，没有缓冲区，取出goroutine并读取数据，然后唤醒这个goroutine，结束读取释放锁。</li>
<li>如有等待的goroutine，且有缓冲区（此时缓冲区已满），从缓冲区队首取出数据，再从sendq取出一个goroutine，将goroutine中的数据存入buf队尾，结束读取释放锁。</li>
<li>如没有等待的goroutine，且缓冲区有数据，直接读取缓冲区数据，结束读取释放锁。</li>
<li>如没有等待的goroutine，且没有缓冲区或缓冲区为空，将当前的goroutine加入<strong>recvq</strong>排队，进入睡眠，等待被写goroutine唤醒。结束读取释放锁。</li>
</ol>
<p>流程图</p>
<p><img src="/images/3f234e37-388e-4070-ae49-5e3b22f59382.png" alt=""></p>
<h2 id="recvq和sendq-结构">recvq和sendq 结构</h2>
<p>recvq和sendq基本上是链表，看起来基本如下</p>
<p><img src="/images/d46ef751-eb47-4517-bdf7-a9e0b42a169e.png" alt=""></p>
<h2 id="goroutine-pauseresume">Goroutine Pause/Resume</h2>
<p>goroutine是Golang实现的用户空间的轻量级的线程，有runtime调度器调度，与操作系统的thread有多对一的关系，相关的数据结构如下图:</p>
<p><img src="/images/982fea32-4940-4297-bf63-b608f4e04e44.png" alt=""></p>
<p>其中M是操作系统的线程，G是用户启动的goroutine，P是与调度相关的context，每个M都拥有一个P，P维护了一个能够运行的goutine队列，用于该线程执行。</p>
<p>当G1向buf已经满了的ch发送数据的时候，当runtine检测到对应的hchan的buf已经满了，会通知调度器，调度器会将G1的状态设置为waiting, 移除与线程M的联系，然后从P的runqueue中选择一个goroutine在线程M中执行，此时G1就是阻塞状态，但是不是操作系统的线程阻塞，所以这个时候只用消耗少量的资源。</p>
<p>那么G1设置为waiting状态后去哪了？怎们去resume呢？我们再回到hchan结构体，注意到hchan有个sendq的成员，其类型是waitq，查看源码如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">hchan</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">recvq</span> <span style="color:#75af00">waitq</span> <span style="color:#75715e">// list of recv waiters </span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">sendq</span> <span style="color:#75af00">waitq</span> <span style="color:#75715e">// list of send waiters </span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span> 
</span></span><span style="display:flex;"><span><span style="color:#111">}</span> 
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">type waitq struct { </span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">first</span> <span style="color:#f92672">*</span><span style="color:#75af00">sudog</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">last</span> <span style="color:#f92672">*</span><span style="color:#75af00">sudog</span> 
</span></span><span style="display:flex;"><span><span style="color:#111">}</span> 
</span></span></code></pre></div><p>实际上，当G1变为waiting状态后，会创建一个代表自己的sudog的结构，然后放到sendq这个list中，sudog结构中保存了channel相关的变量的指针(如果该Goroutine是sender，那么保存的是待发送数据的变量的地址，如果是receiver则为接收数据的变量的地址，之所以是地址，前面我们提到在传输数据的时候使用的是copy的方式)</p>
<p><img src="/images/f8569a70-a969-44db-bd7f-e777dcaa597e.png" alt=""></p>
<p>当G2从ch中接收一个数据时，会通知调度器，设置G1的状态为runnable，然后将加入P的runqueue里，等待线程执行.</p>
<p><img src="/images/770ea2fb-2a34-4061-b34b-a1e600e62be8.png" alt=""></p>
<h2 id="wait-empty-channel">wait empty channel</h2>
<p>前面我们是假设G1先运行，如果G2先运行会怎么样呢？如果G2先运行，那么G2会从一个empty的channel里取数据，这个时候G2就会阻塞，和前面介绍的G1阻塞一样，G2也会创建一个sudog结构体，保存接收数据的变量的地址，但是该sudog结构体是放到了recvq列表里，当G1向ch发送数据的时候，<strong>runtime并没有对hchan结构体题的buf进行加锁，而是直接将G1里的发送到ch的数据copy到了G2 sudog里对应的elem指向的内存地址！</strong></p>
<p><img src="/images/daa8420b-64fe-4672-8de1-e68160550fe7.png" alt=""></p>
<h2 id="select">select</h2>
<p>select就是用来监听和channel有关的IO操作，当 IO 操作发生时，触发相应的动作。</p>
<p>一个简单的示例如下</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>   <span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#d88200">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">goRoutineD</span><span style="color:#111">(</span><span style="color:#75af00">ch</span> <span style="color:#00a8c8">chan</span> <span style="color:#00a8c8">int</span><span style="color:#111">,</span> <span style="color:#75af00">i</span> <span style="color:#00a8c8">int</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Sleep</span><span style="color:#111">(</span><span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Second</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">3</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75af00">ch</span> <span style="color:#f92672">&lt;-</span> <span style="color:#75af00">i</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">goRoutineE</span><span style="color:#111">(</span><span style="color:#75af00">chs</span> <span style="color:#00a8c8">chan</span> <span style="color:#00a8c8">string</span><span style="color:#111">,</span> <span style="color:#75af00">i</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Sleep</span><span style="color:#111">(</span><span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Second</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">3</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75af00">chs</span> <span style="color:#f92672">&lt;-</span> <span style="color:#75af00">i</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75af00">ch</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">chan</span> <span style="color:#00a8c8">int</span><span style="color:#111">,</span> <span style="color:#ae81ff">5</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75af00">chs</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">chan</span> <span style="color:#00a8c8">string</span><span style="color:#111">,</span> <span style="color:#ae81ff">5</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#00a8c8">go</span> <span style="color:#75af00">goRoutineD</span><span style="color:#111">(</span><span style="color:#75af00">ch</span><span style="color:#111">,</span> <span style="color:#ae81ff">5</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>   <span style="color:#00a8c8">go</span> <span style="color:#75af00">goRoutineE</span><span style="color:#111">(</span><span style="color:#75af00">chs</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;ok&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">select</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">case</span> <span style="color:#75af00">msg</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#75af00">ch</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34; received the data &#34;</span><span style="color:#111">,</span> <span style="color:#75af00">msg</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">case</span> <span style="color:#75af00">msgs</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#75af00">chs</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34; received the data &#34;</span><span style="color:#111">,</span> <span style="color:#75af00">msgs</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">default</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;no data received &#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Sleep</span><span style="color:#111">(</span><span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Second</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">1</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>运行程序，因为当前时间没有到3s，所以select 选择defult</p>
<p><code>no data received</code></p>
<p>修改程序，我们注释掉default，并多执行几次结果为</p>
<pre tabindex="0"><code>received the data 5

received the data ok

received the data ok

received the data ok
</code></pre><p>select语句会阻塞，直到监测到一个可以执行的IO操作为止，而这里goRoutineD和goRoutineE睡眠时间是相同的，都是3s，从输出可看出，从channel中读出数据的顺序是随机的。</p>
<p>再修改代码，goRoutineD睡眠时间改成4s</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">goRoutineD</span><span style="color:#111">(</span><span style="color:#75af00">ch</span> <span style="color:#00a8c8">chan</span> <span style="color:#00a8c8">int</span><span style="color:#111">,</span> <span style="color:#75af00">i</span> <span style="color:#00a8c8">int</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Sleep</span><span style="color:#111">(</span><span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Second</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">4</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75af00">ch</span> <span style="color:#f92672">&lt;-</span> <span style="color:#75af00">i</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>此时会先执行goRoutineE，select 选择case msgs := &lt;-chs。</p>
<h2 id="range">range</h2>
<p>可以持续从channel读取数据，一直到channel被关闭，当channel中没有数据时会阻塞当前goroutine，与读channel时阻塞处理机制一样。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>   <span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#d88200">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">goRoutineD</span><span style="color:#111">(</span><span style="color:#75af00">ch</span> <span style="color:#00a8c8">chan</span> <span style="color:#00a8c8">int</span><span style="color:#111">,</span> <span style="color:#75af00">i</span> <span style="color:#00a8c8">int</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>   <span style="color:#00a8c8">for</span>   <span style="color:#75af00">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">1</span><span style="color:#111">;</span> <span style="color:#75af00">i</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">5</span><span style="color:#111">;</span> <span style="color:#75af00">i</span><span style="color:#f92672">++</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75af00">ch</span> <span style="color:#f92672">&lt;-</span> <span style="color:#75af00">i</span>
</span></span><span style="display:flex;"><span>   <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">chanRange</span><span style="color:#111">(</span><span style="color:#75af00">chanName</span> <span style="color:#00a8c8">chan</span> <span style="color:#00a8c8">int</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>   <span style="color:#00a8c8">for</span> <span style="color:#75af00">e</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">chanName</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Get element from chan: %d\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">e</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#00a8c8">if</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">chanName</span><span style="color:#111">)</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span> <span style="color:#75715e">// 如果现有数据量为0，跳出循环</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">break</span>
</span></span><span style="display:flex;"><span>      <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>   <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75af00">ch</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">chan</span> <span style="color:#00a8c8">int</span><span style="color:#111">,</span> <span style="color:#ae81ff">5</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>   <span style="color:#00a8c8">go</span> <span style="color:#75af00">goRoutineD</span><span style="color:#111">(</span><span style="color:#75af00">ch</span><span style="color:#111">,</span> <span style="color:#ae81ff">5</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75af00">chanRange</span><span style="color:#111">(</span><span style="color:#75af00">ch</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>结果：</p>
<pre tabindex="0"><code>Get element from chan: 1
Get element from chan: 2
Get element from chan: 3
Get element from chan: 4
Get element from chan: 5
</code></pre><h2 id="死锁deadlock">死锁（deadlock）</h2>
<p>指两个或两个以上的协程的执行过程中，由于竞争资源或由于彼此通信而造成的一种阻塞的现象。</p>
<p>在非缓冲信道若发生只流入不流出，或只流出不流入，就会发生死锁。</p>
<p>下面是一些死锁的例子</p>
<p>1、</p>
<pre tabindex="0"><code>package main

func main() {
   ch := make(chan int)
   ch &lt;- 3
}
</code></pre><p>上面情况，向非缓冲通道写数据会发生阻塞，导致死锁。解决办法创建缓冲区 ch := make(chan int，3)</p>
<p>2、</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>   <span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75af00">ch</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">chan</span> <span style="color:#00a8c8">int</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#f92672">&lt;-</span><span style="color:#75af00">ch</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>向非缓冲通道读取数据会发生阻塞，导致死锁。 解决办法开启缓冲区，先向channel写入数据。</p>
<p>3、</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75af00">ch</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">chan</span> <span style="color:#00a8c8">int</span><span style="color:#111">,</span> <span style="color:#ae81ff">3</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75af00">ch</span> <span style="color:#f92672">&lt;-</span> <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75af00">ch</span> <span style="color:#f92672">&lt;-</span> <span style="color:#ae81ff">4</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75af00">ch</span> <span style="color:#f92672">&lt;-</span> <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75af00">ch</span> <span style="color:#f92672">&lt;-</span> <span style="color:#ae81ff">6</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>写入数据超过缓冲区数量也会发生死锁。解决办法将写入数据取走。</p>
<p>死锁的情况有很多这里不再赘述。
还有一种情况，向关闭的channel写入数据，不会产生死锁，产生panic。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">ch</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">chan</span> <span style="color:#00a8c8">int</span><span style="color:#111">,</span> <span style="color:#ae81ff">3</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">ch</span> <span style="color:#f92672">&lt;-</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">close</span><span style="color:#111">(</span><span style="color:#75af00">ch</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">ch</span> <span style="color:#f92672">&lt;-</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>解决办法别向关闭的channel写入数据。</p>
<h2 id="参考文章">参考文章</h2>
<ul>
<li><a href="https://segmentfault.com/a/1190000019172554">Go channel 实现原理分析</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/27917262">深入理解Golang Channel</a></li>
</ul>
]]></content:encoded><category>go</category><category>go</category><category>源码分析</category></item><item><title>golang GC 垃圾回收机制</title><link>https://daemon365.dev/post/go/golang_gc_garbage_collection_mechanism/</link><pubDate>Sat, 20 Feb 2021 00:00:00 +0800</pubDate><guid>https://daemon365.dev/post/go/golang_gc_garbage_collection_mechanism/</guid><description>&lt;p&gt;垃圾回收(Garbage Collection，简称GC)是编程语言中提供的自动的内存管理机制，自动释放不需要的对象，让出存储器资源，无需程序员手动执行。&lt;/p&gt;
&lt;p&gt;Golang中的垃圾回收主要应用三色标记法，GC过程和其他用户goroutine可并发运行，但需要一定时间的&lt;strong&gt;STW(stop the world)&lt;/strong&gt;，STW的过程中，CPU不执行用户代码，全部用于垃圾回收，这个过程的影响很大，Golang进行了多次的迭代优化来解决这个问题。&lt;/p&gt;
&lt;h2 id="go-v13之前的标记-清除mark-and-sweep算法"&gt;Go V1.3之前的标记-清除(mark and sweep)算法&lt;/h2&gt;
&lt;p&gt;此算法主要有两个主要的步骤：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;标记(Mark phase)&lt;/li&gt;
&lt;li&gt;清除(Sweep phase)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;第一步&lt;/strong&gt;，暂停程序业务逻辑, 找出不可达的对象，然后做上标记。第二步，回收标记好的对象。&lt;/p&gt;
&lt;p&gt;操作非常简单，但是有一点需要额外注意：mark and sweep算法在执行的时候，需要程序暂停！即 &lt;code&gt;STW(stop the world)&lt;/code&gt;。也就是说，这段时间程序会卡在哪儿。&lt;/p&gt;
&lt;p&gt;&lt;img src="https://daemon365.dev/images/e7452cc0-956d-44ea-8ef6-22bad882f1d8.png" alt=""&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;第二步&lt;/strong&gt;, 开始标记，程序找出它所有可达的对象，并做上标记。如下图所示：&lt;/p&gt;
&lt;p&gt;&lt;img src="https://daemon365.dev/images/a2d30455-7d6a-4039-8091-c369e405ce2b.png" alt=""&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;第三步&lt;/strong&gt;, 标记完了之后，然后开始清除未标记的对象. 结果如下.&lt;/p&gt;
&lt;p&gt;&lt;img src="https://daemon365.dev/images/532f5acd-aac6-4a12-858c-4f79c7eeba24.png" alt=""&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;第四步&lt;/strong&gt;, 停止暂停，让程序继续跑。然后循环重复这个过程，直到process程序生命周期结束。&lt;/p&gt;
&lt;h2 id="标记-清扫mark-and-sweep的缺点"&gt;标记-清扫(mark and sweep)的缺点&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;STW，stop the world；让程序暂停，程序出现卡顿 &lt;strong&gt;(重要问题)&lt;/strong&gt;。&lt;/li&gt;
&lt;li&gt;标记需要扫描整个heap&lt;/li&gt;
&lt;li&gt;清除数据会产生heap碎片&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;所以Go V1.3版本之前就是以上来实施的, 流程是&lt;/p&gt;
&lt;p&gt;&lt;img src="https://daemon365.dev/images/c24c6980-7fb9-4c34-8576-064bef2b2ba1.png" alt=""&gt;&lt;/p&gt;
&lt;p&gt;Go V1.3 做了简单的优化,将STW提前, 减少STW暂停的时间范围.如下所示&lt;/p&gt;
&lt;p&gt;&lt;img src="https://daemon365.dev/images/3cfb6c99-91b8-4693-9446-203000b2e3de.png" alt=""&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;这里面最重要的问题就是：mark-and-sweep 算法会暂停整个程序&lt;/strong&gt; 。&lt;/p&gt;
&lt;p&gt;Go是如何面对并这个问题的呢？接下来G V1.5版本 就用&lt;strong&gt;三色并发标记法&lt;/strong&gt;来优化这个问题.&lt;/p&gt;
&lt;h2 id="go-v15的三色并发标记法"&gt;Go V1.5的三色并发标记法&lt;/h2&gt;
&lt;p&gt;三色标记法 实际上就是通过三个阶段的标记来确定清楚的对象都有哪些. 我们来看一下具体的过程.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;第一步&lt;/strong&gt; , 就是只要是新创建的对象,默认的颜色都是标记为“白色”.&lt;/p&gt;
&lt;p&gt;&lt;img src="https://daemon365.dev/images/f97b6289-f495-4afd-a3b7-f89c6f106d82.png" alt=""&gt;&lt;/p&gt;
&lt;p&gt;这里面需要注意的是, 所谓“程序”, 则是一些对象的跟节点集合.&lt;/p&gt;
&lt;p&gt;&lt;img src="https://daemon365.dev/images/16192886-775b-461a-b9d0-d74a2f3f76d0.png" alt=""&gt;&lt;/p&gt;
&lt;p&gt;所以上图,可以转换如下的方式来表示.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;第二步&lt;/strong&gt;, 每次GC回收开始, 然后从根节点开始遍历所有对象，把遍历到的对象从白色集合放入“灰色”集合。&lt;/p&gt;</description><content:encoded><![CDATA[<p>垃圾回收(Garbage Collection，简称GC)是编程语言中提供的自动的内存管理机制，自动释放不需要的对象，让出存储器资源，无需程序员手动执行。</p>
<p>Golang中的垃圾回收主要应用三色标记法，GC过程和其他用户goroutine可并发运行，但需要一定时间的<strong>STW(stop the world)</strong>，STW的过程中，CPU不执行用户代码，全部用于垃圾回收，这个过程的影响很大，Golang进行了多次的迭代优化来解决这个问题。</p>
<h2 id="go-v13之前的标记-清除mark-and-sweep算法">Go V1.3之前的标记-清除(mark and sweep)算法</h2>
<p>此算法主要有两个主要的步骤：</p>
<ul>
<li>标记(Mark phase)</li>
<li>清除(Sweep phase)</li>
</ul>
<p><strong>第一步</strong>，暂停程序业务逻辑, 找出不可达的对象，然后做上标记。第二步，回收标记好的对象。</p>
<p>操作非常简单，但是有一点需要额外注意：mark and sweep算法在执行的时候，需要程序暂停！即 <code>STW(stop the world)</code>。也就是说，这段时间程序会卡在哪儿。</p>
<p><img src="/images/e7452cc0-956d-44ea-8ef6-22bad882f1d8.png" alt=""></p>
<p><strong>第二步</strong>, 开始标记，程序找出它所有可达的对象，并做上标记。如下图所示：</p>
<p><img src="/images/a2d30455-7d6a-4039-8091-c369e405ce2b.png" alt=""></p>
<p><strong>第三步</strong>,  标记完了之后，然后开始清除未标记的对象. 结果如下.</p>
<p><img src="/images/532f5acd-aac6-4a12-858c-4f79c7eeba24.png" alt=""></p>
<p><strong>第四步</strong>, 停止暂停，让程序继续跑。然后循环重复这个过程，直到process程序生命周期结束。</p>
<h2 id="标记-清扫mark-and-sweep的缺点">标记-清扫(mark and sweep)的缺点</h2>
<ul>
<li>STW，stop the world；让程序暂停，程序出现卡顿 <strong>(重要问题)</strong>。</li>
<li>标记需要扫描整个heap</li>
<li>清除数据会产生heap碎片</li>
</ul>
<p>所以Go V1.3版本之前就是以上来实施的,  流程是</p>
<p><img src="/images/c24c6980-7fb9-4c34-8576-064bef2b2ba1.png" alt=""></p>
<p>Go V1.3 做了简单的优化,将STW提前, 减少STW暂停的时间范围.如下所示</p>
<p><img src="/images/3cfb6c99-91b8-4693-9446-203000b2e3de.png" alt=""></p>
<p><strong>这里面最重要的问题就是：mark-and-sweep 算法会暂停整个程序</strong> 。</p>
<p>Go是如何面对并这个问题的呢？接下来G V1.5版本 就用<strong>三色并发标记法</strong>来优化这个问题.</p>
<h2 id="go-v15的三色并发标记法">Go V1.5的三色并发标记法</h2>
<p>三色标记法 实际上就是通过三个阶段的标记来确定清楚的对象都有哪些. 我们来看一下具体的过程.</p>
<p><strong>第一步</strong> , 就是只要是新创建的对象,默认的颜色都是标记为“白色”.</p>
<p><img src="/images/f97b6289-f495-4afd-a3b7-f89c6f106d82.png" alt=""></p>
<p>这里面需要注意的是, 所谓“程序”, 则是一些对象的跟节点集合.</p>
<p><img src="/images/16192886-775b-461a-b9d0-d74a2f3f76d0.png" alt=""></p>
<p>所以上图,可以转换如下的方式来表示.</p>
<p><strong>第二步</strong>, 每次GC回收开始, 然后从根节点开始遍历所有对象，把遍历到的对象从白色集合放入“灰色”集合。</p>
<p><img src="/images/89041a5e-2ff0-484f-acb5-486aa84cc0f1.png" alt=""></p>
<p><strong>第三步</strong>, 遍历灰色集合，将灰色对象引用的对象从白色集合放入灰色集合，之后将此灰色对象放入黑色集合</p>
<p><img src="/images/3451b546-570c-4995-9eab-2eb50f5b25cf.png" alt=""></p>
<p><strong>第四步</strong>, 重复<strong>第三步</strong>, 直到灰色中无任何对象.</p>
<p><img src="/images/8cdbacc0-3b34-46c8-9f49-89f9bda89902.png" alt=""></p>
<p><img src="/images/fcee2e45-8d1f-4421-a38a-6310ea5f7620.png" alt=""></p>
<p><strong>第五步</strong>: 回收所有的白色标记表的对象. 也就是回收垃圾.</p>
<p><img src="/images/1a47f5e7-acc4-4dbe-810e-379695bdc531.png" alt=""></p>
<p>以上便是<code>三色并发标记法</code>, 不难看出,我们上面已经清楚的体现<code>三色</code>的特性, 那么又是如何实现并行的呢?</p>
<blockquote>
<p>Go是如何解决标记-清除(mark and sweep)算法中的卡顿(stw，stop the world)问题的呢？</p>
</blockquote>
<h2 id="没有stw的三色标记法">没有STW的三色标记法</h2>
<p>​       我们还是基于上述的三色并发标记法来说, 他是一定要依赖STW的. 因为如果不暂停程序, 程序的逻辑改变对象引用关系, 这种动作如果在标记阶段做了修改，会影响标记结果的正确性。我们举一个场景.</p>
<p>如果三色标记法, 标记过程不使用STW将会发生什么事情?</p>
<hr>
<p><img src="/images/21516ce2-d194-4394-9b62-9c36563d4b2b.png" alt=""></p>
<p><img src="/images/d6592a51-f284-4fbc-905c-50dc59d92103.png" alt=""></p>
<p><img src="/images/b107beef-233d-4968-8b55-ab2dd42cad4f.png" alt=""></p>
<p><img src="/images/a10a9998-e626-4b6c-8aa9-4030238f28b1.png" alt=""></p>
<p><img src="/images/787819ca-f386-4c30-bc51-819ad368dfdb.png" alt=""></p>
<p>可以看出，有两个问题, 在三色标记法中,是不希望被发生的</p>
<ul>
<li>条件1: 一个白色对象被黑色对象引用**(白色被挂在黑色下)**</li>
<li>条件2: 灰色对象与它之间的可达关系的白色对象遭到破坏**(灰色同时丢了该白色)**</li>
</ul>
<p>当以上两个条件同时满足时, 就会出现对象丢失现象!</p>
<p>当然, 如果上述中的白色对象3, 如果他还有很多下游对象的话, 也会一并都清理掉.</p>
<p>​       为了防止这种现象的发生，最简单的方式就是STW，直接禁止掉其他用户程序对对象引用关系的干扰，但是<strong>STW的过程有明显的资源浪费，对所有的用户程序都有很大影响</strong>，如何能在保证对象不丢失的情况下合理的尽可能的提高GC效率，减少STW时间呢？</p>
<p>​       答案就是, 那么我们只要使用一个机制,来破坏上面的两个条件就可以了.</p>
<h2 id="屏障机制">屏障机制</h2>
<p>我们让GC回收器,满足下面两种情况之一时,可保对象不丢失. 所以引出两种方式.</p>
<h3 id="强-弱-三色不变式">“强-弱” 三色不变式</h3>
<ul>
<li>强三色不变式</li>
</ul>
<p>不存在黑色对象引用到白色对象的指针。</p>
<p><img src="/images/c7612fff-702e-4ffe-8055-dcc7d93b0fea.png" alt=""></p>
<ul>
<li>弱三色不变式</li>
</ul>
<p>所有被黑色对象引用的白色对象都处于灰色保护状态.</p>
<p><img src="/images/466357c5-9a01-40f8-9596-e1b767033d20.png" alt=""></p>
<p>为了遵循上述的两个方式,Golang团队初步得到了如下具体的两种屏障方式“插入屏障”, “删除屏障”.</p>
<h3 id="插入屏障">插入屏障</h3>
<p><code>具体操作</code>: 在A对象引用B对象的时候，B对象被标记为灰色。(将B挂在A下游，B必须被标记为灰色)</p>
<p><code>满足</code>: <strong>强三色不变式</strong>. (不存在黑色对象引用白色对象的情况了， 因为白色会强制变成灰色)</p>
<p>伪码如下:</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">添加下游对象</span><span style="color:#111">(</span><span style="color:#75af00">当前下游对象slot</span><span style="color:#111">,</span> <span style="color:#75af00">新下游对象ptr</span><span style="color:#111">)</span> <span style="color:#111">{</span>   
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">//1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75af00">标记灰色</span><span style="color:#111">(</span><span style="color:#75af00">新下游对象ptr</span><span style="color:#111">)</span>   
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">//2</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75af00">当前下游对象slot</span> <span style="color:#111">=</span> <span style="color:#75af00">新下游对象ptr</span>                   
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>场景：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">A</span><span style="color:#111">.</span><span style="color:#75af00">添加下游对象</span><span style="color:#111">(</span><span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">B</span><span style="color:#111">)</span>   <span style="color:#75715e">//A 之前没有下游， 新添加一个下游对象B， B被标记为灰色</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">A</span><span style="color:#111">.</span><span style="color:#75af00">添加下游对象</span><span style="color:#111">(</span><span style="color:#75af00">C</span><span style="color:#111">,</span> <span style="color:#75af00">B</span><span style="color:#111">)</span>     <span style="color:#75715e">//A 将下游对象C 更换为B，  B被标记为灰色</span>
</span></span></code></pre></div><p>​       这段伪码逻辑就是写屏障,. 我们知道,黑色对象的内存槽有两种位置, <code>栈</code>和<code>堆</code>. 栈空间的特点是容量小,但是要求相应速度快,因为函数调用弹出频繁使用, 所以“插入屏障”机制,在<strong>栈空间的对象操作中不使用</strong>. 而仅仅使用在堆空间对象的操作中.</p>
<p>​       接下来，我们用几张图，来模拟整个一个详细的过程， 希望您能够更可观的看清晰整体流程。</p>
<hr>
<p><img src="/images/82e4e137-4b21-4a48-a2c2-0ca38eec9d7d.png" alt=""></p>
<p><img src="/images/63488ff2-4d52-4a77-b55b-2052b9c66b30.png" alt=""></p>
<hr>
<p><img src="/images/f1392990-751d-4b0f-9eeb-69697d821aad.png" alt=""></p>
<hr>
<p><img src="/images/2e4c728d-3d54-403c-b8e2-e2e19bb97ae2.png" alt=""></p>
<p><img src="/images/7b3ec6ef-1694-4ba4-b120-6066451f6e44.png" alt=""></p>
<p><img src="/images/a5bf6b22-b34b-4c7e-81c3-7e422d560825.png" alt=""></p>
<hr>
<p>但是如果栈不添加,当全部三色标记扫描之后,栈上有可能依然存在白色对象被引用的情况(如上图的对象9).  所以要对栈重新进行三色标记扫描, 但这次为了对象不丢失, 要对本次标记扫描启动STW暂停. 直到栈空间的三色标记结束.</p>
<hr>
<p><img src="/images/0805cff3-e89e-4eed-a40c-31d8af5d8ad4.png" alt=""></p>
<hr>
<p><img src="/images/c5f528e4-d7ae-4249-9370-78e514144b0a.png" alt=""></p>
<p><img src="/images/b19b22ef-8484-4708-979a-2d1cbdefc23b.png" alt=""></p>
<hr>
<p>最后将栈和堆空间 扫描剩余的全部 白色节点清除.  这次STW大约的时间在10~100ms间.</p>
<hr>
<p><img src="/images/446787fa-1ad8-451b-a8f3-e87ca8f46b82.png" alt=""></p>
<hr>
<h3 id="删除屏障">删除屏障</h3>
<p><code>具体操作</code>: 被删除的对象，如果自身为灰色或者白色，那么被标记为灰色。</p>
<p><code>满足</code>: <strong>弱三色不变式</strong>. (保护灰色对象到白色对象的路径不会断)</p>
<p>伪代码：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">添加下游对象</span><span style="color:#111">(</span><span style="color:#75af00">当前下游对象slot</span><span style="color:#960050;background-color:#1e0010">，</span> <span style="color:#75af00">新下游对象ptr</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">//1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#00a8c8">if</span> <span style="color:#111">(</span><span style="color:#75af00">当前下游对象slot是灰色</span> <span style="color:#f92672">||</span> <span style="color:#75af00">当前下游对象slot是白色</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">标记灰色</span><span style="color:#111">(</span><span style="color:#75af00">当前下游对象slot</span><span style="color:#111">)</span>     <span style="color:#75715e">//slot为被删除对象， 标记为灰色</span>
</span></span><span style="display:flex;"><span>  <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">//2</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75af00">当前下游对象slot</span> <span style="color:#111">=</span> <span style="color:#75af00">新下游对象ptr</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>场景：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">A</span><span style="color:#111">.</span><span style="color:#75af00">添加下游对象</span><span style="color:#111">(</span><span style="color:#75af00">B</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span><span style="color:#111">)</span>   <span style="color:#75715e">//A对象，删除B对象的引用。  B被A删除，被标记为灰(如果B之前为白)</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">A</span><span style="color:#111">.</span><span style="color:#75af00">添加下游对象</span><span style="color:#111">(</span><span style="color:#75af00">B</span><span style="color:#111">,</span> <span style="color:#75af00">C</span><span style="color:#111">)</span>       <span style="color:#75715e">//A对象，更换下游B变成C。   B被A删除，被标记为灰(如果B之前为白)</span>
</span></span></code></pre></div><p>接下来，我们用几张图，来模拟整个一个详细的过程， 希望您能够更可观的看清晰整体流程。</p>
<hr>
<p><img src="/images/37cec983-9229-45e1-b5b1-cc17cefaebd3.png" alt=""></p>
<hr>
<p><img src="/images/f3affdd8-36d5-4c28-9efb-932e8eafe855.png" alt=""></p>
<hr>
<p><img src="/images/231684ca-812d-4ce5-af4f-772503d1be63.png" alt=""></p>
<p><img src="/images/ed0497f6-15b1-4375-bf60-2df7a1af08b8.png" alt=""></p>
<p><img src="/images/b51da9dd-7b88-403e-a4e7-1e1c3614e897.png" alt=""></p>
<p><img src="/images/430453b0-b9f1-420a-bfb4-5c6e8cc6deda.png" alt=""></p>
<p><img src="/images/e1546bc1-a282-4746-94c6-fc468329e7d3.png" alt=""></p>
<hr>
<p>这种方式的回收精度低，一个对象即使被删除了最后一个指向它的指针也依旧可以活过这一轮，在下一轮GC中被清理掉。</p>
<h2 id="go-v18的混合写屏障hybrid-write-barrier机制">Go V1.8的混合写屏障(hybrid write barrier)机制</h2>
<p>插入写屏障和删除写屏障的短板：</p>
<ul>
<li>插入写屏障：结束时需要STW来重新扫描栈，标记栈上引用的白色对象的存活；</li>
<li>删除写屏障：回收精度低，GC开始时STW扫描堆栈来记录初始快照，这个过程会保护开始时刻的所有存活对象。</li>
</ul>
<p>Go V1.8版本引入了混合写屏障机制（hybrid write barrier），避免了对栈re-scan的过程，极大的减少了STW的时间。结合了两者的优点。</p>
<hr>
<h3 id="混合写屏障规则">混合写屏障规则</h3>
<p><code>具体操作</code>:</p>
<p>1、GC开始将栈上的对象全部扫描并标记为黑色(之后不再进行第二次重复扫描，无需STW)，</p>
<p>2、GC期间，任何在栈上创建的新对象，均为黑色。</p>
<p>3、被删除的对象标记为灰色。</p>
<p>4、被添加的对象标记为灰色。</p>
<p><code>满足</code>: 变形的<strong>弱三色不变式</strong>.</p>
<p>伪代码：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">添加下游对象</span><span style="color:#111">(</span><span style="color:#75af00">当前下游对象slot</span><span style="color:#111">,</span> <span style="color:#75af00">新下游对象ptr</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//1 </span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">标记灰色</span><span style="color:#111">(</span><span style="color:#75af00">当前下游对象slot</span><span style="color:#111">)</span>    <span style="color:#75715e">//只要当前下游对象被移走，就标记灰色</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//2 </span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">标记灰色</span><span style="color:#111">(</span><span style="color:#75af00">新下游对象ptr</span><span style="color:#111">)</span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//3</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">当前下游对象slot</span> <span style="color:#111">=</span> <span style="color:#75af00">新下游对象ptr</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><blockquote>
<p>这里我们注意， 屏障技术是不在栈上应用的，因为要保证栈的运行效率。</p>
</blockquote>
<h3 id="混合写屏障的具体场景分析">混合写屏障的具体场景分析</h3>
<p>接下来，我们用几张图，来模拟整个一个详细的过程， 希望您能够更可观的看清晰整体流程。</p>
<blockquote>
<p>注意混合写屏障是Gc的一种屏障机制，所以只是当程序执行GC的时候，才会触发这种机制。</p>
</blockquote>
<h4 id="gc开始扫描栈区将可达对象全部标记为黑">GC开始：扫描栈区，将可达对象全部标记为黑</h4>
<p><img src="/images/cd30cf15-058a-4a64-a2f8-775c87dfea89.png" alt=""></p>
<p><img src="/images/a9c3a537-6c7b-4d07-8fc7-6f1c4c181cfb.png" alt=""></p>
<hr>
<h4 id="场景一-对象被一个堆对象删除引用成为栈对象的下游">场景一： 对象被一个堆对象删除引用，成为栈对象的下游</h4>
<blockquote>
<p>伪代码</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">//前提：堆对象4-&gt;对象7 = 对象7；  //对象7 被 对象4引用</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">栈对象1</span><span style="color:#f92672">-</span><span style="color:#111">&gt;</span><span style="color:#75af00">对象7</span> <span style="color:#111">=</span> <span style="color:#75af00">堆对象7</span><span style="color:#960050;background-color:#1e0010">；</span>  <span style="color:#75715e">//将堆对象7 挂在 栈对象1 下游</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">堆对象4</span><span style="color:#f92672">-</span><span style="color:#111">&gt;</span><span style="color:#75af00">对象7</span> <span style="color:#111">=</span> <span style="color:#75af00">null</span><span style="color:#960050;background-color:#1e0010">；</span>    <span style="color:#75715e">//对象4 删除引用 对象7</span>
</span></span></code></pre></div><p><img src="/images/ebaedc9a-8cd0-4598-8962-2f2e7fb3ac36.png" alt=""></p>
<hr>
<p><img src="/images/a3066126-ad87-44a0-b712-4e80b69ad25d.png" alt=""></p>
<h4 id="场景二-对象被一个栈对象删除引用成为另一个栈对象的下游">场景二： 对象被一个栈对象删除引用，成为另一个栈对象的下游</h4>
<blockquote>
<p>伪代码</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">new</span> <span style="color:#75af00">栈对象9</span><span style="color:#960050;background-color:#1e0010">；</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">对象8</span><span style="color:#f92672">-</span><span style="color:#111">&gt;</span><span style="color:#75af00">对象3</span> <span style="color:#111">=</span> <span style="color:#75af00">对象3</span><span style="color:#960050;background-color:#1e0010">；</span>      <span style="color:#75715e">//将栈对象3 挂在 栈对象9 下游</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">对象2</span><span style="color:#f92672">-</span><span style="color:#111">&gt;</span><span style="color:#75af00">对象3</span> <span style="color:#111">=</span> <span style="color:#75af00">null</span><span style="color:#960050;background-color:#1e0010">；</span>      <span style="color:#75715e">//对象2 删除引用 对象3</span>
</span></span></code></pre></div><hr>
<p><img src="/images/4899f7b2-d951-4d9c-9880-6fb79fa01fee.png" alt=""></p>
<p><img src="/images/a185fd86-0ca0-4294-9ebf-6c8a73f8af19.png" alt=""></p>
<p><img src="/images/eb499138-8d6a-4c75-a4a9-1dad614879bf.png" alt=""></p>
<hr>
<h4 id="场景三对象被一个堆对象删除引用成为另一个堆对象的下游">场景三：对象被一个堆对象删除引用，成为另一个堆对象的下游</h4>
<blockquote>
<p>伪代码</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">堆对象10</span><span style="color:#f92672">-</span><span style="color:#111">&gt;</span><span style="color:#75af00">对象7</span> <span style="color:#111">=</span> <span style="color:#75af00">堆对象7</span><span style="color:#960050;background-color:#1e0010">；</span>       <span style="color:#75715e">//将堆对象7 挂在 堆对象10 下游</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">堆对象4</span><span style="color:#f92672">-</span><span style="color:#111">&gt;</span><span style="color:#75af00">对象7</span> <span style="color:#111">=</span> <span style="color:#75af00">null</span><span style="color:#960050;background-color:#1e0010">；</span>         <span style="color:#75715e">//对象4 删除引用 对象7</span>
</span></span></code></pre></div><hr>
<p><img src="/images/cb9a84fe-73ec-43e7-9d37-f14683e4f6e4.png" alt=""></p>
<hr>
<p><img src="/images/e010d5a5-4867-43df-8e82-1a4368f2c8e2.png" alt=""></p>
<p><img src="/images/d11efffb-50de-4aed-b6a6-06eb20a4824e.png" alt=""></p>
<hr>
<h4 id="场景四对象从一个栈对象删除引用成为另一个堆对象的下游">场景四：对象从一个栈对象删除引用，成为另一个堆对象的下游</h4>
<blockquote>
<p>伪代码</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">堆对象10</span><span style="color:#f92672">-</span><span style="color:#111">&gt;</span><span style="color:#75af00">对象7</span> <span style="color:#111">=</span> <span style="color:#75af00">堆对象7</span><span style="color:#960050;background-color:#1e0010">；</span>       <span style="color:#75715e">//将堆对象7 挂在 堆对象10 下游</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">堆对象4</span><span style="color:#f92672">-</span><span style="color:#111">&gt;</span><span style="color:#75af00">对象7</span> <span style="color:#111">=</span> <span style="color:#75af00">null</span><span style="color:#960050;background-color:#1e0010">；</span>         <span style="color:#75715e">//对象4 删除引用 对象7</span>
</span></span></code></pre></div><hr>
<p><img src="/images/29e311a4-4387-4387-be10-06bf33338c01.png" alt=""></p>
<p><img src="/images/ba80f06b-42a9-463d-b88f-62ee6f83bc4d.png" alt=""></p>
<p><img src="/images/497960cd-b419-430a-90e5-88f2e37bc848.png" alt=""></p>
<hr>
<p>​       Golang中的混合写屏障满足<code>弱三色不变式</code>，结合了删除写屏障和插入写屏障的优点，只需要在开始时并发扫描各个goroutine的栈，使其变黑并一直保持，这个过程不需要STW，而标记结束后，因为栈在扫描后始终是黑色的，也无需再进行re-scan操作了，减少了STW的时间。</p>
<h2 id="总结">总结</h2>
<p>​       以上便是Golang的GC全部的标记-清除逻辑及场景演示全过程。</p>
<p>GoV1.3- 普通标记清除法，整体过程需要启动STW，效率极低。</p>
<p>GoV1.5- 三色标记法， 堆空间启动写屏障，栈空间不启动，全部扫描之后，需要重新扫描一次栈(需要STW)，效率普通</p>
<p>GoV1.8-三色标记法，混合写屏障机制， 栈空间不启动，堆空间启动。整个过程几乎不需要STW，效率较高。</p>
<h2 id="文章转自">文章转自</h2>
<p><a href="https://www.jianshu.com/p/4c5a303af470">https://www.jianshu.com/p/4c5a303af470</a></p>
]]></content:encoded><category>go</category><category>go</category></item><item><title>viper配置管理</title><link>https://daemon365.dev/post/go/viper_configuration_management/</link><pubDate>Sat, 23 Jan 2021 00:00:00 +0800</pubDate><guid>https://daemon365.dev/post/go/viper_configuration_management/</guid><description>&lt;h2 id="安装"&gt;安装&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;go get github.com/spf13/viper
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id="viper支持的功能"&gt;viper支持的功能&lt;/h2&gt;
&lt;p&gt;1、可以设置默认值
2、可以加载多种格式的配置文件，如JSON，TOML，YAML，HCL和Java属性配置文件
3、应用程序运行过程中，保持监听和重新读取配置文件
4、可以从环境变量读取配置
5、可以从远程配置系统读取配置
6、可以读取命令行标志作为配置
7、可以从缓冲区中读取
8、设置显式的值&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;在GitHub中，作者是这样描述viper对于开发人员的作用：在构建现代化应用程序的过程中，开发人员可以通过使用viper而不必考虑配置文件的格式问题。&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="viper具体的帮助"&gt;viper具体的帮助&lt;/h2&gt;
&lt;p&gt;1、可以查找、加载和反序列化多种格式的配置文件，如JSON, TOML, YAML, HCL, Java属性配置格式。
2、提供一种为不同配置选项设置默认值的机制
3、提供一种通过命令行标志覆盖指定配置选项值的机制
4、提供了一种别名系统，可以在避免破坏现有代码的前提下，轻松地重命名参数
5、当用户提供的命令行或配置文件的配置选项与默认的配置选项相同时，可以很容易通过选项值结果看出优先级的差异。&lt;/p&gt;
&lt;h2 id="viper提供的配置方式的优先级顺序如下由高到低"&gt;viper提供的配置方式的优先级顺序如下(由高到低)：&lt;/h2&gt;
&lt;p&gt;1.设置显示调用(explicit call to Set)
2.命令行标志(flag)
3.环境变量(env)
4.配置文件(config)
5.远程键/值存储(key/value store)
6.默认值(default)&lt;/p&gt;
&lt;h2 id="viper的简单使用"&gt;viper的简单使用&lt;/h2&gt;
&lt;h3 id="把值存入viper"&gt;把值存入Viper&lt;/h3&gt;
&lt;h4 id="建立默认值"&gt;建立默认值&lt;/h4&gt;
&lt;p&gt;一个好的配置系统应该支持默认值。键不需要默认值，但如果没有通过配置文件、环境变量、远程配置或命令行标志（flag）设置键，则默认值非常有用。&lt;/p&gt;
&lt;p&gt;例如：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75af00"&gt;viper&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;SetDefault&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;ContentDir&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;content&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75af00"&gt;viper&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;SetDefault&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;LayoutDir&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;layouts&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75af00"&gt;viper&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;SetDefault&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;Taxonomies&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;map&lt;/span&gt;&lt;span style="color:#111"&gt;[&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;string&lt;/span&gt;&lt;span style="color:#111"&gt;]&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;string&lt;/span&gt;&lt;span style="color:#111"&gt;{&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;tag&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;tags&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;category&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;categories&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;})&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h4 id="读取配置文件"&gt;读取配置文件&lt;/h4&gt;
&lt;p&gt;Viper需要最少知道在哪里查找配置文件的配置。Viper支持JSON、TOML、YAML、HCL、envfile和Java properties格式的配置文件。Viper可以搜索多个路径，但目前单个Viper实例只支持单个配置文件。Viper不默认任何配置搜索路径，将默认决策留给应用程序。&lt;/p&gt;
&lt;p&gt;下面是一个如何使用Viper搜索和读取配置文件的示例。不需要任何特定的路径，但是至少应该提供一个配置文件预期出现的路径。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75af00"&gt;viper&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;SetConfigFile&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;./config.yaml&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 指定配置文件路径&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75af00"&gt;viper&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;SetConfigName&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;config&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 配置文件名称(无扩展名)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75af00"&gt;viper&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;SetConfigType&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;yaml&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 如果配置文件的名称中没有扩展名，则需要配置此项&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75af00"&gt;viper&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;AddConfigPath&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;/etc/appname/&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 查找配置文件所在的路径&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75af00"&gt;viper&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;AddConfigPath&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;$HOME/.appname&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 多次调用以添加多个搜索路径&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75af00"&gt;viper&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;AddConfigPath&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;.&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 还可以在工作目录中查找配置&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;viper&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;ReadInConfig&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 查找并读取配置文件&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;!=&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 处理读取配置文件的错误&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;panic&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Errorf&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;Fatal error config file: %s \n&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt;&lt;span style="color:#111"&gt;))&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;在加载配置文件出错时，你可以像下面这样处理找不到配置文件的特定情况：&lt;/p&gt;</description><content:encoded><![CDATA[<h2 id="安装">安装</h2>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>go get github.com/spf13/viper
</span></span></code></pre></div><h2 id="viper支持的功能">viper支持的功能</h2>
<p>1、可以设置默认值
2、可以加载多种格式的配置文件，如JSON，TOML，YAML，HCL和Java属性配置文件
3、应用程序运行过程中，保持监听和重新读取配置文件
4、可以从环境变量读取配置
5、可以从远程配置系统读取配置
6、可以读取命令行标志作为配置
7、可以从缓冲区中读取
8、设置显式的值</p>
<ul>
<li>在GitHub中，作者是这样描述viper对于开发人员的作用：在构建现代化应用程序的过程中，开发人员可以通过使用viper而不必考虑配置文件的格式问题。</li>
</ul>
<h2 id="viper具体的帮助">viper具体的帮助</h2>
<p>1、可以查找、加载和反序列化多种格式的配置文件，如JSON, TOML, YAML, HCL, Java属性配置格式。
2、提供一种为不同配置选项设置默认值的机制
3、提供一种通过命令行标志覆盖指定配置选项值的机制
4、提供了一种别名系统，可以在避免破坏现有代码的前提下，轻松地重命名参数
5、当用户提供的命令行或配置文件的配置选项与默认的配置选项相同时，可以很容易通过选项值结果看出优先级的差异。</p>
<h2 id="viper提供的配置方式的优先级顺序如下由高到低">viper提供的配置方式的优先级顺序如下(由高到低)：</h2>
<p>1.设置显示调用(explicit call to Set)
2.命令行标志(flag)
3.环境变量(env)
4.配置文件(config)
5.远程键/值存储(key/value store)
6.默认值(default)</p>
<h2 id="viper的简单使用">viper的简单使用</h2>
<h3 id="把值存入viper">把值存入Viper</h3>
<h4 id="建立默认值">建立默认值</h4>
<p>一个好的配置系统应该支持默认值。键不需要默认值，但如果没有通过配置文件、环境变量、远程配置或命令行标志（flag）设置键，则默认值非常有用。</p>
<p>例如：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">viper</span><span style="color:#111">.</span><span style="color:#75af00">SetDefault</span><span style="color:#111">(</span><span style="color:#d88200">&#34;ContentDir&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;content&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">viper</span><span style="color:#111">.</span><span style="color:#75af00">SetDefault</span><span style="color:#111">(</span><span style="color:#d88200">&#34;LayoutDir&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;layouts&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">viper</span><span style="color:#111">.</span><span style="color:#75af00">SetDefault</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Taxonomies&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#00a8c8">string</span><span style="color:#111">]</span><span style="color:#00a8c8">string</span><span style="color:#111">{</span><span style="color:#d88200">&#34;tag&#34;</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;tags&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;category&#34;</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;categories&#34;</span><span style="color:#111">})</span>
</span></span></code></pre></div><h4 id="读取配置文件">读取配置文件</h4>
<p>Viper需要最少知道在哪里查找配置文件的配置。Viper支持JSON、TOML、YAML、HCL、envfile和Java properties格式的配置文件。Viper可以搜索多个路径，但目前单个Viper实例只支持单个配置文件。Viper不默认任何配置搜索路径，将默认决策留给应用程序。</p>
<p>下面是一个如何使用Viper搜索和读取配置文件的示例。不需要任何特定的路径，但是至少应该提供一个配置文件预期出现的路径。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">viper</span><span style="color:#111">.</span><span style="color:#75af00">SetConfigFile</span><span style="color:#111">(</span><span style="color:#d88200">&#34;./config.yaml&#34;</span><span style="color:#111">)</span> <span style="color:#75715e">// 指定配置文件路径</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">viper</span><span style="color:#111">.</span><span style="color:#75af00">SetConfigName</span><span style="color:#111">(</span><span style="color:#d88200">&#34;config&#34;</span><span style="color:#111">)</span> <span style="color:#75715e">// 配置文件名称(无扩展名)</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">viper</span><span style="color:#111">.</span><span style="color:#75af00">SetConfigType</span><span style="color:#111">(</span><span style="color:#d88200">&#34;yaml&#34;</span><span style="color:#111">)</span> <span style="color:#75715e">// 如果配置文件的名称中没有扩展名，则需要配置此项</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">viper</span><span style="color:#111">.</span><span style="color:#75af00">AddConfigPath</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/etc/appname/&#34;</span><span style="color:#111">)</span>   <span style="color:#75715e">// 查找配置文件所在的路径</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">viper</span><span style="color:#111">.</span><span style="color:#75af00">AddConfigPath</span><span style="color:#111">(</span><span style="color:#d88200">&#34;$HOME/.appname&#34;</span><span style="color:#111">)</span>  <span style="color:#75715e">// 多次调用以添加多个搜索路径</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">viper</span><span style="color:#111">.</span><span style="color:#75af00">AddConfigPath</span><span style="color:#111">(</span><span style="color:#d88200">&#34;.&#34;</span><span style="color:#111">)</span>               <span style="color:#75715e">// 还可以在工作目录中查找配置</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">viper</span><span style="color:#111">.</span><span style="color:#75af00">ReadInConfig</span><span style="color:#111">()</span> <span style="color:#75715e">// 查找并读取配置文件</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span> <span style="color:#75715e">// 处理读取配置文件的错误</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Fatal error config file: %s \n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>在加载配置文件出错时，你可以像下面这样处理找不到配置文件的特定情况：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">viper</span><span style="color:#111">.</span><span style="color:#75af00">ReadInConfig</span><span style="color:#111">();</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">err</span><span style="color:#111">.(</span><span style="color:#75af00">viper</span><span style="color:#111">.</span><span style="color:#75af00">ConfigFileNotFoundError</span><span style="color:#111">);</span> <span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 配置文件未找到错误；如果需要可以忽略</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 配置文件被找到，但产生了另外的错误</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 配置文件找到并成功解析</span>
</span></span></code></pre></div><p><em>注意[自1.6起]：</em> 你也可以有不带扩展名的文件，并以编程方式指定其格式。对于位于用户$HOME目录中的配置文件没有任何扩展名，如.bashrc。</p>
<p><strong>这里补充两个问题供读者解答并自行验证</strong></p>
<p>当你使用如下方式读取配置时，viper会从./conf目录下查找任何以config为文件名的配置文件，如果同时存在./conf/config.json和./conf/config.yaml两个配置文件的话，viper会从哪个配置文件加载配置呢？</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">viper</span><span style="color:#111">.</span><span style="color:#75af00">SetConfigName</span><span style="color:#111">(</span><span style="color:#d88200">&#34;config&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">viper</span><span style="color:#111">.</span><span style="color:#75af00">AddConfigPath</span><span style="color:#111">(</span><span style="color:#d88200">&#34;./conf&#34;</span><span style="color:#111">)</span>
</span></span></code></pre></div><p>在上面两个语句下搭配使用viper.SetConfigType(&ldquo;yaml&rdquo;)指定配置文件类型可以实现预期的效果吗？</p>
<h4 id="写入配置文件">写入配置文件</h4>
<p>从配置文件中读取配置文件是有用的，但是有时你想要存储在运行时所做的所有修改。为此，可以使用下面一组命令，每个命令都有自己的用途:</p>
<ul>
<li>WriteConfig - 将当前的viper配置写入预定义的路径并覆盖（如果存在的话）。如果没有预定义的路径，则报错。</li>
<li>SafeWriteConfig - 将当前的viper配置写入预定义的路径。如果没有预定义的路径，则报错。如果存在，将不会覆盖当前的配置文件。</li>
<li>WriteConfigAs - 将当前的viper配置写入给定的文件路径。将覆盖给定的文件(如果它存在的话)。</li>
<li>SafeWriteConfigAs - 将当前的viper配置写入给定的文件路径。不会覆盖给定的文件(如果它存在的话)。</li>
</ul>
<p>根据经验，标记为safe的所有方法都不会覆盖任何文件，而是直接创建（如果不存在），而默认行为是创建或截断。</p>
<p>一个小示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">viper</span><span style="color:#111">.</span><span style="color:#75af00">WriteConfig</span><span style="color:#111">()</span> <span style="color:#75715e">// 将当前配置写入“viper.AddConfigPath()”和“viper.SetConfigName”设置的预定义路径</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">viper</span><span style="color:#111">.</span><span style="color:#75af00">SafeWriteConfig</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">viper</span><span style="color:#111">.</span><span style="color:#75af00">WriteConfigAs</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/path/to/my/.config&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">viper</span><span style="color:#111">.</span><span style="color:#75af00">SafeWriteConfigAs</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/path/to/my/.config&#34;</span><span style="color:#111">)</span> <span style="color:#75715e">// 因为该配置文件写入过，所以会报错</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">viper</span><span style="color:#111">.</span><span style="color:#75af00">SafeWriteConfigAs</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/path/to/my/.other_config&#34;</span><span style="color:#111">)</span>
</span></span></code></pre></div><h4 id="监控并重新读取配置文件">监控并重新读取配置文件</h4>
<p>Viper支持在运行时实时读取配置文件的功能。</p>
<p>需要重新启动服务器以使配置生效的日子已经一去不复返了，viper驱动的应用程序可以在运行时读取配置文件的更新，而不会错过任何消息。</p>
<p>只需告诉viper实例watchConfig。可选地，你可以为Viper提供一个回调函数，以便在每次发生更改时运行。</p>
<h4 id="确保在调用watchconfig之前添加了所有的配置路径"><strong>确保在调用WatchConfig()之前添加了所有的配置路径。</strong></h4>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">viper</span><span style="color:#111">.</span><span style="color:#75af00">WatchConfig</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">viper</span><span style="color:#111">.</span><span style="color:#75af00">OnConfigChange</span><span style="color:#111">(</span><span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">e</span> <span style="color:#75af00">fsnotify</span><span style="color:#111">.</span><span style="color:#75af00">Event</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 配置文件发生变更之后会调用的回调函数</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Config file changed:&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">Name</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">})</span>
</span></span></code></pre></div><h4 id="从ioreader读取配置">从io.Reader读取配置</h4>
<p>Viper预先定义了许多配置源，如文件、环境变量、标志和远程K/V存储，但你不受其约束。你还可以实现自己所需的配置源并将其提供给viper。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">viper</span><span style="color:#111">.</span><span style="color:#75af00">SetConfigType</span><span style="color:#111">(</span><span style="color:#d88200">&#34;yaml&#34;</span><span style="color:#111">)</span> <span style="color:#75715e">// 或者 viper.SetConfigType(&#34;YAML&#34;)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 任何需要将此配置添加到程序中的方法。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">var</span> <span style="color:#75af00">yamlExample</span> <span style="color:#111">=</span> <span style="color:#111">[]</span><span style="color:#111">byte</span><span style="color:#111">(</span><span style="color:#d88200">`
</span></span></span><span style="display:flex;"><span><span style="color:#d88200">Hacker: true
</span></span></span><span style="display:flex;"><span><span style="color:#d88200">name: steve
</span></span></span><span style="display:flex;"><span><span style="color:#d88200">hobbies:
</span></span></span><span style="display:flex;"><span><span style="color:#d88200">- skateboarding
</span></span></span><span style="display:flex;"><span><span style="color:#d88200">- snowboarding
</span></span></span><span style="display:flex;"><span><span style="color:#d88200">- go
</span></span></span><span style="display:flex;"><span><span style="color:#d88200">clothing:
</span></span></span><span style="display:flex;"><span><span style="color:#d88200">  jacket: leather
</span></span></span><span style="display:flex;"><span><span style="color:#d88200">  trousers: denim
</span></span></span><span style="display:flex;"><span><span style="color:#d88200">age: 35
</span></span></span><span style="display:flex;"><span><span style="color:#d88200">eyes : brown
</span></span></span><span style="display:flex;"><span><span style="color:#d88200">beard: true
</span></span></span><span style="display:flex;"><span><span style="color:#d88200">`</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">viper</span><span style="color:#111">.</span><span style="color:#75af00">ReadConfig</span><span style="color:#111">(</span><span style="color:#75af00">bytes</span><span style="color:#111">.</span><span style="color:#75af00">NewBuffer</span><span style="color:#111">(</span><span style="color:#75af00">yamlExample</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">viper</span><span style="color:#111">.</span><span style="color:#75af00">Get</span><span style="color:#111">(</span><span style="color:#d88200">&#34;name&#34;</span><span style="color:#111">)</span> <span style="color:#75715e">// 这里会得到 &#34;steve&#34;</span>
</span></span></code></pre></div><h4 id="覆盖设置">覆盖设置</h4>
<p>这些可能来自命令行标志，也可能来自你自己的应用程序逻辑。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">viper</span><span style="color:#111">.</span><span style="color:#75af00">Set</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Verbose&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">true</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">viper</span><span style="color:#111">.</span><span style="color:#75af00">Set</span><span style="color:#111">(</span><span style="color:#d88200">&#34;LogFile&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">LogFile</span><span style="color:#111">)</span>
</span></span></code></pre></div><h4 id="注册和使用别名">注册和使用别名</h4>
<p>别名允许多个键引用单个值</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">viper</span><span style="color:#111">.</span><span style="color:#75af00">RegisterAlias</span><span style="color:#111">(</span><span style="color:#d88200">&#34;loud&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Verbose&#34;</span><span style="color:#111">)</span>  <span style="color:#75715e">// 注册别名（此处loud和Verbose建立了别名）</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">viper</span><span style="color:#111">.</span><span style="color:#75af00">Set</span><span style="color:#111">(</span><span style="color:#d88200">&#34;verbose&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">true</span><span style="color:#111">)</span> <span style="color:#75715e">// 结果与下一行相同</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">viper</span><span style="color:#111">.</span><span style="color:#75af00">Set</span><span style="color:#111">(</span><span style="color:#d88200">&#34;loud&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">true</span><span style="color:#111">)</span>   <span style="color:#75715e">// 结果与前一行相同</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">viper</span><span style="color:#111">.</span><span style="color:#75af00">GetBool</span><span style="color:#111">(</span><span style="color:#d88200">&#34;loud&#34;</span><span style="color:#111">)</span> <span style="color:#75715e">// true</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">viper</span><span style="color:#111">.</span><span style="color:#75af00">GetBool</span><span style="color:#111">(</span><span style="color:#d88200">&#34;verbose&#34;</span><span style="color:#111">)</span> <span style="color:#75715e">// true</span>
</span></span></code></pre></div><h4 id="使用环境变量">使用环境变量</h4>
<p>Viper完全支持环境变量。这使Twelve-Factor App开箱即用。有五种方法可以帮助与ENV协作:</p>
<ul>
<li>AutomaticEnv()</li>
<li>BindEnv(string&hellip;) : error</li>
<li>SetEnvPrefix(string)</li>
<li>SetEnvKeyReplacer(string&hellip;) *strings.Replacer</li>
<li>AllowEmptyEnv(bool)</li>
</ul>
<p><em>使用ENV变量时，务必要意识到Viper将ENV变量视为区分大小写。</em></p>
<p>Viper提供了一种机制来确保ENV变量是惟一的。通过使用SetEnvPrefix，你可以告诉Viper在读取环境变量时使用前缀。BindEnv和AutomaticEnv都将使用这个前缀。</p>
<p>BindEnv使用一个或两个参数。第一个参数是键名称，第二个是环境变量的名称。环境变量的名称区分大小写。如果没有提供ENV变量名，那么Viper将自动假设ENV变量与以下格式匹配：前缀+ “_” +键名全部大写。当你显式提供ENV变量名（第二个参数）时，它 <strong>不会</strong> 自动添加前缀。例如，如果第二个参数是“id”，Viper将查找环境变量“ID”。</p>
<p>在使用ENV变量时，需要注意的一件重要事情是，每次访问该值时都将读取它。Viper在调用BindEnv时不固定该值。</p>
<p>AutomaticEnv是一个强大的助手，尤其是与SetEnvPrefix结合使用时。调用时，Viper会在发出viper.Get请求时随时检查环境变量。它将应用以下规则。它将检查环境变量的名称是否与键匹配（如果设置了EnvPrefix）。</p>
<p>SetEnvKeyReplacer允许你使用strings.Replacer对象在一定程度上重写 Env 键。如果你希望在Get()调用中使用-或者其他什么符号，但是环境变量里使用_分隔符，那么这个功能是非常有用的。可以在viper_test.go中找到它的使用示例。</p>
<p>或者，你可以使用带有NewWithOptions工厂函数的EnvKeyReplacer。与SetEnvKeyReplacer不同，它接受StringReplacer接口，允许你编写自定义字符串替换逻辑。</p>
<p>默认情况下，空环境变量被认为是未设置的，并将返回到下一个配置源。若要将空环境变量视为已设置，请使用AllowEmptyEnv方法。</p>
<h5 id="env-示例">Env 示例：</h5>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">SetEnvPrefix</span><span style="color:#111">(</span><span style="color:#d88200">&#34;spf&#34;</span><span style="color:#111">)</span> <span style="color:#75715e">// 将自动转为大写</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">BindEnv</span><span style="color:#111">(</span><span style="color:#d88200">&#34;id&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">Setenv</span><span style="color:#111">(</span><span style="color:#d88200">&#34;SPF_ID&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;13&#34;</span><span style="color:#111">)</span> <span style="color:#75715e">// 通常是在应用程序之外完成的</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">id</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">Get</span><span style="color:#111">(</span><span style="color:#d88200">&#34;id&#34;</span><span style="color:#111">)</span> <span style="color:#75715e">// 13</span>
</span></span></code></pre></div><h5 id="使用flags">使用Flags</h5>
<p>Viper 具有绑定到标志的能力。具体来说，Viper支持<a href="https://github.com/spf13/cobra">Cobra</a>库中使用的Pflag。</p>
<p>与BindEnv类似，该值不是在调用绑定方法时设置的，而是在访问该方法时设置的。这意味着你可以根据需要尽早进行绑定，即使在init()函数中也是如此。</p>
<p>对于单个标志，BindPFlag()方法提供此功能。</p>
<p>例如：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">serverCmd</span><span style="color:#111">.</span><span style="color:#75af00">Flags</span><span style="color:#111">().</span><span style="color:#75af00">Int</span><span style="color:#111">(</span><span style="color:#d88200">&#34;port&#34;</span><span style="color:#111">,</span> <span style="color:#ae81ff">1138</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Port to run Application server on&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">viper</span><span style="color:#111">.</span><span style="color:#75af00">BindPFlag</span><span style="color:#111">(</span><span style="color:#d88200">&#34;port&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">serverCmd</span><span style="color:#111">.</span><span style="color:#75af00">Flags</span><span style="color:#111">().</span><span style="color:#75af00">Lookup</span><span style="color:#111">(</span><span style="color:#d88200">&#34;port&#34;</span><span style="color:#111">))</span>
</span></span></code></pre></div><p>你还可以绑定一组现有的pflags （pflag.FlagSet）：</p>
<p>举个例子：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">pflag</span><span style="color:#111">.</span><span style="color:#75af00">Int</span><span style="color:#111">(</span><span style="color:#d88200">&#34;flagname&#34;</span><span style="color:#111">,</span> <span style="color:#ae81ff">1234</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;help message for flagname&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">pflag</span><span style="color:#111">.</span><span style="color:#75af00">Parse</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">viper</span><span style="color:#111">.</span><span style="color:#75af00">BindPFlags</span><span style="color:#111">(</span><span style="color:#75af00">pflag</span><span style="color:#111">.</span><span style="color:#75af00">CommandLine</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">i</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">viper</span><span style="color:#111">.</span><span style="color:#75af00">GetInt</span><span style="color:#111">(</span><span style="color:#d88200">&#34;flagname&#34;</span><span style="color:#111">)</span> <span style="color:#75715e">// 从viper而不是从pflag检索值</span>
</span></span></code></pre></div><p>在 Viper 中使用 pflag 并不阻碍其他包中使用标准库中的 flag 包。pflag 包可以通过导入这些 flags 来处理flag包定义的flags。这是通过调用pflag包提供的便利函数AddGoFlagSet()来实现的。</p>
<p>例如：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;flag&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;github.com/spf13/pflag&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 使用标准库 &#34;flag&#34; 包</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">flag</span><span style="color:#111">.</span><span style="color:#75af00">Int</span><span style="color:#111">(</span><span style="color:#d88200">&#34;flagname&#34;</span><span style="color:#111">,</span> <span style="color:#ae81ff">1234</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;help message for flagname&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">pflag</span><span style="color:#111">.</span><span style="color:#75af00">CommandLine</span><span style="color:#111">.</span><span style="color:#75af00">AddGoFlagSet</span><span style="color:#111">(</span><span style="color:#75af00">flag</span><span style="color:#111">.</span><span style="color:#75af00">CommandLine</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">pflag</span><span style="color:#111">.</span><span style="color:#75af00">Parse</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">viper</span><span style="color:#111">.</span><span style="color:#75af00">BindPFlags</span><span style="color:#111">(</span><span style="color:#75af00">pflag</span><span style="color:#111">.</span><span style="color:#75af00">CommandLine</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">i</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">viper</span><span style="color:#111">.</span><span style="color:#75af00">GetInt</span><span style="color:#111">(</span><span style="color:#d88200">&#34;flagname&#34;</span><span style="color:#111">)</span> <span style="color:#75715e">// 从 viper 检索值</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h5 id="flag接口">flag接口</h5>
<p>如果你不使用Pflag，Viper 提供了两个Go接口来绑定其他 flag 系统。</p>
<p>FlagValue表示单个flag。这是一个关于如何实现这个接口的非常简单的例子：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">myFlag</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">f</span> <span style="color:#75af00">myFlag</span><span style="color:#111">)</span> <span style="color:#75af00">HasChanged</span><span style="color:#111">()</span> <span style="color:#00a8c8">bool</span> <span style="color:#111">{</span> <span style="color:#00a8c8">return</span> <span style="color:#00a8c8">false</span> <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">f</span> <span style="color:#75af00">myFlag</span><span style="color:#111">)</span> <span style="color:#75af00">Name</span><span style="color:#111">()</span> <span style="color:#00a8c8">string</span> <span style="color:#111">{</span> <span style="color:#00a8c8">return</span> <span style="color:#d88200">&#34;my-flag-name&#34;</span> <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">f</span> <span style="color:#75af00">myFlag</span><span style="color:#111">)</span> <span style="color:#75af00">ValueString</span><span style="color:#111">()</span> <span style="color:#00a8c8">string</span> <span style="color:#111">{</span> <span style="color:#00a8c8">return</span> <span style="color:#d88200">&#34;my-flag-value&#34;</span> <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">f</span> <span style="color:#75af00">myFlag</span><span style="color:#111">)</span> <span style="color:#75af00">ValueType</span><span style="color:#111">()</span> <span style="color:#00a8c8">string</span> <span style="color:#111">{</span> <span style="color:#00a8c8">return</span> <span style="color:#d88200">&#34;string&#34;</span> <span style="color:#111">}</span>
</span></span></code></pre></div><p>一旦你的 flag 实现了这个接口，你可以很方便地告诉Viper绑定它：</p>
<pre tabindex="0"><code>viper.BindFlagValue(&#34;my-flag-name&#34;, myFlag{})
</code></pre><p>FlagValueSet代表一组 flags 。这是一个关于如何实现这个接口的非常简单的例子:</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">myFlagSet</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">flags</span> <span style="color:#111">[]</span><span style="color:#75af00">myFlag</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">f</span> <span style="color:#75af00">myFlagSet</span><span style="color:#111">)</span> <span style="color:#75af00">VisitAll</span><span style="color:#111">(</span><span style="color:#75af00">fn</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">FlagValue</span><span style="color:#111">))</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">flag</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">flags</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fn</span><span style="color:#111">(</span><span style="color:#75af00">flag</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>一旦你的flag set实现了这个接口，你就可以很方便地告诉Viper绑定它：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">fSet</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">myFlagSet</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">flags</span><span style="color:#111">:</span> <span style="color:#111">[]</span><span style="color:#75af00">myFlag</span><span style="color:#111">{</span><span style="color:#75af00">myFlag</span><span style="color:#111">{},</span> <span style="color:#75af00">myFlag</span><span style="color:#111">{}},</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">viper</span><span style="color:#111">.</span><span style="color:#75af00">BindFlagValues</span><span style="color:#111">(</span><span style="color:#d88200">&#34;my-flags&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">fSet</span><span style="color:#111">)</span>
</span></span></code></pre></div><h4 id="远程keyvalue存储支持">远程Key/Value存储支持</h4>
<p>在Viper中启用远程支持，需要在代码中匿名导入viper/remote这个包。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#75af00">_</span> <span style="color:#d88200">&#34;github.com/spf13/viper/remote&#34;</span>
</span></span></code></pre></div><p>Viper将读取从Key/Value存储（例如etcd或Consul）中的路径检索到的配置字符串（如JSON、TOML、YAML、HCL、envfile和Java properties格式）。这些值的优先级高于默认值，但是会被从磁盘、flag或环境变量检索到的配置值覆盖。（译注：也就是说Viper加载配置值的优先级为：磁盘上的配置文件&gt;命令行标志位&gt;环境变量&gt;远程Key/Value存储&gt;默认值。）</p>
<p>Viper使用<a href="https://github.com/bketelsen/crypt">crypt</a>从K/V存储中检索配置，这意味着如果你有正确的gpg密匙，你可以将配置值加密存储并自动解密。加密是可选的。</p>
<p>你可以将远程配置与本地配置结合使用，也可以独立使用。</p>
<p>crypt有一个命令行助手，你可以使用它将配置放入K/V存储中。crypt默认使用在<a href="http://127.0.0.1:4001/">http://127.0.0.1:4001</a>的etcd。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ go get github.com/bketelsen/crypt/bin/crypt
</span></span><span style="display:flex;"><span>$ crypt <span style="color:#111">set</span> -plaintext /config/hugo.json /Users/hugo/settings/config.json
</span></span></code></pre></div><p>确认值已经设置：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ crypt get -plaintext /config/hugo.json
</span></span></code></pre></div><p>有关如何设置加密值或如何使用Consul的示例，请参见crypt文档。</p>
<h4 id="远程keyvalue存储示例-未加密">远程Key/Value存储示例-未加密</h4>
<h5 id="etcd">etcd</h5>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">viper</span><span style="color:#111">.</span><span style="color:#75af00">AddRemoteProvider</span><span style="color:#111">(</span><span style="color:#d88200">&#34;etcd&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;http://127.0.0.1:4001&#34;</span><span style="color:#111">,</span><span style="color:#d88200">&#34;/config/hugo.json&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">viper</span><span style="color:#111">.</span><span style="color:#75af00">SetConfigType</span><span style="color:#111">(</span><span style="color:#d88200">&#34;json&#34;</span><span style="color:#111">)</span> <span style="color:#75715e">// 因为在字节流中没有文件扩展名，所以这里需要设置下类型。支持的扩展名有 &#34;json&#34;, &#34;toml&#34;, &#34;yaml&#34;, &#34;yml&#34;, &#34;properties&#34;, &#34;props&#34;, &#34;prop&#34;, &#34;env&#34;, &#34;dotenv&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">viper</span><span style="color:#111">.</span><span style="color:#75af00">ReadRemoteConfig</span><span style="color:#111">()</span>
</span></span></code></pre></div><h5 id="consul">Consul</h5>
<p>你需要 Consul Key/Value存储中设置一个Key保存包含所需配置的JSON值。例如，创建一个keyMY_CONSUL_KEY将下面的值存入Consul key/value 存储：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d88200">&#34;port&#34;</span><span style="color:#111">:</span> <span style="color:#ae81ff">8080</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d88200">&#34;hostname&#34;</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;liwenzhou.com&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">viper</span><span style="color:#111">.</span><span style="color:#75af00">AddRemoteProvider</span><span style="color:#111">(</span><span style="color:#d88200">&#34;consul&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;localhost:8500&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;MY_CONSUL_KEY&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">viper</span><span style="color:#111">.</span><span style="color:#75af00">SetConfigType</span><span style="color:#111">(</span><span style="color:#d88200">&#34;json&#34;</span><span style="color:#111">)</span> <span style="color:#75715e">// 需要显示设置成json</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">viper</span><span style="color:#111">.</span><span style="color:#75af00">ReadRemoteConfig</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">viper</span><span style="color:#111">.</span><span style="color:#75af00">Get</span><span style="color:#111">(</span><span style="color:#d88200">&#34;port&#34;</span><span style="color:#111">))</span> <span style="color:#75715e">// 8080</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">viper</span><span style="color:#111">.</span><span style="color:#75af00">Get</span><span style="color:#111">(</span><span style="color:#d88200">&#34;hostname&#34;</span><span style="color:#111">))</span> <span style="color:#75715e">// liwenzhou.com</span>
</span></span></code></pre></div><h5 id="firestore">Firestore</h5>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">viper</span><span style="color:#111">.</span><span style="color:#75af00">AddRemoteProvider</span><span style="color:#111">(</span><span style="color:#d88200">&#34;firestore&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;google-cloud-project-id&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;collection/document&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">viper</span><span style="color:#111">.</span><span style="color:#75af00">SetConfigType</span><span style="color:#111">(</span><span style="color:#d88200">&#34;json&#34;</span><span style="color:#111">)</span> <span style="color:#75715e">// 配置的格式: &#34;json&#34;, &#34;toml&#34;, &#34;yaml&#34;, &#34;yml&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">viper</span><span style="color:#111">.</span><span style="color:#75af00">ReadRemoteConfig</span><span style="color:#111">()</span>
</span></span></code></pre></div><p>当然，你也可以使用SecureRemoteProvider。</p>
<h4 id="远程keyvalue存储示例-加密">远程Key/Value存储示例-加密</h4>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">viper</span><span style="color:#111">.</span><span style="color:#75af00">AddSecureRemoteProvider</span><span style="color:#111">(</span><span style="color:#d88200">&#34;etcd&#34;</span><span style="color:#111">,</span><span style="color:#d88200">&#34;http://127.0.0.1:4001&#34;</span><span style="color:#111">,</span><span style="color:#d88200">&#34;/config/hugo.json&#34;</span><span style="color:#111">,</span><span style="color:#d88200">&#34;/etc/secrets/mykeyring.gpg&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">viper</span><span style="color:#111">.</span><span style="color:#75af00">SetConfigType</span><span style="color:#111">(</span><span style="color:#d88200">&#34;json&#34;</span><span style="color:#111">)</span> <span style="color:#75715e">// 因为在字节流中没有文件扩展名，所以这里需要设置下类型。支持的扩展名有 &#34;json&#34;, &#34;toml&#34;, &#34;yaml&#34;, &#34;yml&#34;, &#34;properties&#34;, &#34;props&#34;, &#34;prop&#34;, &#34;env&#34;, &#34;dotenv&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">viper</span><span style="color:#111">.</span><span style="color:#75af00">ReadRemoteConfig</span><span style="color:#111">()</span>
</span></span></code></pre></div><h4 id="监控etcd中的更改-未加密">监控etcd中的更改-未加密</h4>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// 或者你可以创建一个新的viper实例</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">var</span> <span style="color:#75af00">runtime_viper</span> <span style="color:#111">=</span> <span style="color:#75af00">viper</span><span style="color:#111">.</span><span style="color:#75af00">New</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">runtime_viper</span><span style="color:#111">.</span><span style="color:#75af00">AddRemoteProvider</span><span style="color:#111">(</span><span style="color:#d88200">&#34;etcd&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;http://127.0.0.1:4001&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;/config/hugo.yml&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">runtime_viper</span><span style="color:#111">.</span><span style="color:#75af00">SetConfigType</span><span style="color:#111">(</span><span style="color:#d88200">&#34;yaml&#34;</span><span style="color:#111">)</span> <span style="color:#75715e">// 因为在字节流中没有文件扩展名，所以这里需要设置下类型。支持的扩展名有 &#34;json&#34;, &#34;toml&#34;, &#34;yaml&#34;, &#34;yml&#34;, &#34;properties&#34;, &#34;props&#34;, &#34;prop&#34;, &#34;env&#34;, &#34;dotenv&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 第一次从远程读取配置</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">runtime_viper</span><span style="color:#111">.</span><span style="color:#75af00">ReadRemoteConfig</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 反序列化</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">runtime_viper</span><span style="color:#111">.</span><span style="color:#75af00">Unmarshal</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">runtime_conf</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 开启一个单独的goroutine一直监控远端的变更</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">go</span> <span style="color:#00a8c8">func</span><span style="color:#111">(){</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	    <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Sleep</span><span style="color:#111">(</span><span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Second</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">5</span><span style="color:#111">)</span> <span style="color:#75715e">// 每次请求后延迟一下</span>
</span></span><span style="display:flex;"><span>	    <span style="color:#75715e">// 目前只测试了etcd支持</span>
</span></span><span style="display:flex;"><span>	    <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">runtime_viper</span><span style="color:#111">.</span><span style="color:#75af00">WatchRemoteConfig</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	    <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	        <span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;unable to read remote config: %v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	        <span style="color:#00a8c8">continue</span>
</span></span><span style="display:flex;"><span>	    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	    <span style="color:#75715e">// 将新配置反序列化到我们运行时的配置结构体中。你还可以借助channel实现一个通知系统更改的信号</span>
</span></span><span style="display:flex;"><span>	    <span style="color:#75af00">runtime_viper</span><span style="color:#111">.</span><span style="color:#75af00">Unmarshal</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">runtime_conf</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}()</span>
</span></span></code></pre></div><h3 id="从viper获取值">从Viper获取值</h3>
<p>在Viper中，有几种方法可以根据值的类型获取值。存在以下功能和方法:</p>
<ul>
<li>Get(key string) : interface{}</li>
<li>GetBool(key string) : bool</li>
<li>GetFloat64(key string) : float64</li>
<li>GetInt(key string) : int</li>
<li>GetIntSlice(key string) : []int</li>
<li>GetString(key string) : string</li>
<li>GetStringMap(key string) : map[string]interface{}</li>
<li>GetStringMapString(key string) : map[string]string</li>
<li>GetStringSlice(key string) : []string</li>
<li>GetTime(key string) : time.Time</li>
<li>GetDuration(key string) : time.Duration</li>
<li>IsSet(key string) : bool</li>
<li>AllSettings() : map[string]interface{}</li>
</ul>
<p>需要认识到的一件重要事情是，每一个Get方法在找不到值的时候都会返回零值。为了检查给定的键是否存在，提供了IsSet()方法。</p>
<p>例如：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">viper</span><span style="color:#111">.</span><span style="color:#75af00">GetString</span><span style="color:#111">(</span><span style="color:#d88200">&#34;logfile&#34;</span><span style="color:#111">)</span> <span style="color:#75715e">// 不区分大小写的设置和获取</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#75af00">viper</span><span style="color:#111">.</span><span style="color:#75af00">GetBool</span><span style="color:#111">(</span><span style="color:#d88200">&#34;verbose&#34;</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;verbose enabled&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h4 id="访问嵌套的键">访问嵌套的键</h4>
<p>访问器方法也接受深度嵌套键的格式化路径。例如，如果加载下面的JSON文件：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d88200">&#34;host&#34;</span><span style="color:#111">:</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#d88200">&#34;address&#34;</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;localhost&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#d88200">&#34;port&#34;</span><span style="color:#111">:</span> <span style="color:#ae81ff">5799</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d88200">&#34;datastore&#34;</span><span style="color:#111">:</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#d88200">&#34;metric&#34;</span><span style="color:#111">:</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#d88200">&#34;host&#34;</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;127.0.0.1&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#d88200">&#34;port&#34;</span><span style="color:#111">:</span> <span style="color:#ae81ff">3099</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">},</span>
</span></span><span style="display:flex;"><span>        <span style="color:#d88200">&#34;warehouse&#34;</span><span style="color:#111">:</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#d88200">&#34;host&#34;</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;198.0.0.1&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#d88200">&#34;port&#34;</span><span style="color:#111">:</span> <span style="color:#ae81ff">2112</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>Viper可以通过传入.分隔的路径来访问嵌套字段：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">GetString</span><span style="color:#111">(</span><span style="color:#d88200">&#34;datastore.metric.host&#34;</span><span style="color:#111">)</span> <span style="color:#75715e">// (返回 &#34;127.0.0.1&#34;)</span>
</span></span></code></pre></div><p>这遵守上面建立的优先规则；搜索路径将遍历其余配置注册表，直到找到为止。(译注：因为Viper支持从多种配置来源，例如磁盘上的配置文件&gt;命令行标志位&gt;环境变量&gt;远程Key/Value存储&gt;默认值，我们在查找一个配置的时候如果在当前配置源中没找到，就会继续从后续的配置源查找，直到找到为止。)</p>
<p>例如，在给定此配置文件的情况下，datastore.metric.host和datastore.metric.port均已定义（并且可以被覆盖）。如果另外在默认值中定义了datastore.metric.protocol，Viper也会找到它。</p>
<p>然而，如果datastore.metric被直接赋值覆盖（被flag，环境变量，set()方法等等…），那么datastore.metric的所有子键都将变为未定义状态，它们被高优先级配置级别“遮蔽”（shadowed）了。</p>
<p>最后，如果存在与分隔的键路径匹配的键，则返回其值。例如：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d88200">&#34;datastore.metric.host&#34;</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;0.0.0.0&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d88200">&#34;host&#34;</span><span style="color:#111">:</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#d88200">&#34;address&#34;</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;localhost&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#d88200">&#34;port&#34;</span><span style="color:#111">:</span> <span style="color:#ae81ff">5799</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d88200">&#34;datastore&#34;</span><span style="color:#111">:</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#d88200">&#34;metric&#34;</span><span style="color:#111">:</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#d88200">&#34;host&#34;</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;127.0.0.1&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#d88200">&#34;port&#34;</span><span style="color:#111">:</span> <span style="color:#ae81ff">3099</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">},</span>
</span></span><span style="display:flex;"><span>        <span style="color:#d88200">&#34;warehouse&#34;</span><span style="color:#111">:</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#d88200">&#34;host&#34;</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;198.0.0.1&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#d88200">&#34;port&#34;</span><span style="color:#111">:</span> <span style="color:#ae81ff">2112</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">GetString</span><span style="color:#111">(</span><span style="color:#d88200">&#34;datastore.metric.host&#34;</span><span style="color:#111">)</span> <span style="color:#75715e">// 返回 &#34;0.0.0.0&#34;</span>
</span></span></code></pre></div><h4 id="提取子树">提取子树</h4>
<p>从Viper中提取子树。</p>
<p>例如，viper实例现在代表了以下配置：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">app</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">cache1</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">max-items</span><span style="color:#111">:</span> <span style="color:#ae81ff">100</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">item-size</span><span style="color:#111">:</span> <span style="color:#ae81ff">64</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">cache2</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">max-items</span><span style="color:#111">:</span> <span style="color:#ae81ff">200</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">item-size</span><span style="color:#111">:</span> <span style="color:#ae81ff">80</span>
</span></span></code></pre></div><p>执行后：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">subv</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">viper</span><span style="color:#111">.</span><span style="color:#75af00">Sub</span><span style="color:#111">(</span><span style="color:#d88200">&#34;app.cache1&#34;</span><span style="color:#111">)</span>
</span></span></code></pre></div><p>subv现在就代表：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">max</span><span style="color:#f92672">-</span><span style="color:#75af00">items</span><span style="color:#111">:</span> <span style="color:#ae81ff">100</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">item</span><span style="color:#f92672">-</span><span style="color:#75af00">size</span><span style="color:#111">:</span> <span style="color:#ae81ff">64</span>
</span></span></code></pre></div><p>假设我们现在有这么一个函数：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">NewCache</span><span style="color:#111">(</span><span style="color:#75af00">cfg</span> <span style="color:#f92672">*</span><span style="color:#75af00">Viper</span><span style="color:#111">)</span> <span style="color:#f92672">*</span><span style="color:#75af00">Cache</span> <span style="color:#111">{</span><span style="color:#f92672">...</span><span style="color:#111">}</span>
</span></span></code></pre></div><p>它基于subv格式的配置信息创建缓存。现在，可以轻松地分别创建这两个缓存，如下所示：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">cfg1</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">viper</span><span style="color:#111">.</span><span style="color:#75af00">Sub</span><span style="color:#111">(</span><span style="color:#d88200">&#34;app.cache1&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">cache1</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">NewCache</span><span style="color:#111">(</span><span style="color:#75af00">cfg1</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">cfg2</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">viper</span><span style="color:#111">.</span><span style="color:#75af00">Sub</span><span style="color:#111">(</span><span style="color:#d88200">&#34;app.cache2&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">cache2</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">NewCache</span><span style="color:#111">(</span><span style="color:#75af00">cfg2</span><span style="color:#111">)</span>
</span></span></code></pre></div><h4 id="反序列化">反序列化</h4>
<p>你还可以选择将所有或特定的值解析到结构体、map等。</p>
<p>有两种方法可以做到这一点：</p>
<ul>
<li>Unmarshal(rawVal interface{}) : error</li>
<li>UnmarshalKey(key string, rawVal interface{}) : error</li>
</ul>
<p>举个例子：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">config</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Port</span> <span style="color:#00a8c8">int</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Name</span> <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">PathMap</span> <span style="color:#00a8c8">string</span> <span style="color:#d88200">`mapstructure:&#34;path_map&#34;`</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">var</span> <span style="color:#75af00">C</span> <span style="color:#75af00">config</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">viper</span><span style="color:#111">.</span><span style="color:#75af00">Unmarshal</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">C</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">Fatalf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;unable to decode into struct, %v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>如果你想要解析那些键本身就包含.(默认的键分隔符）的配置，你需要修改分隔符：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">v</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">viper</span><span style="color:#111">.</span><span style="color:#75af00">NewWithOptions</span><span style="color:#111">(</span><span style="color:#75af00">viper</span><span style="color:#111">.</span><span style="color:#75af00">KeyDelimiter</span><span style="color:#111">(</span><span style="color:#d88200">&#34;::&#34;</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">v</span><span style="color:#111">.</span><span style="color:#75af00">SetDefault</span><span style="color:#111">(</span><span style="color:#d88200">&#34;chart::values&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#00a8c8">string</span><span style="color:#111">]</span><span style="color:#00a8c8">interface</span><span style="color:#111">{}{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d88200">&#34;ingress&#34;</span><span style="color:#111">:</span> <span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#00a8c8">string</span><span style="color:#111">]</span><span style="color:#00a8c8">interface</span><span style="color:#111">{}{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#d88200">&#34;annotations&#34;</span><span style="color:#111">:</span> <span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#00a8c8">string</span><span style="color:#111">]</span><span style="color:#00a8c8">interface</span><span style="color:#111">{}{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#d88200">&#34;traefik.frontend.rule.type&#34;</span><span style="color:#111">:</span>                 <span style="color:#d88200">&#34;PathPrefix&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#d88200">&#34;traefik.ingress.kubernetes.io/ssl-redirect&#34;</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;true&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">},</span>
</span></span><span style="display:flex;"><span><span style="color:#111">})</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">config</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Chart</span> <span style="color:#00a8c8">struct</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">Values</span> <span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#00a8c8">string</span><span style="color:#111">]</span><span style="color:#00a8c8">interface</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">var</span> <span style="color:#75af00">C</span> <span style="color:#75af00">config</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">v</span><span style="color:#111">.</span><span style="color:#75af00">Unmarshal</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">C</span><span style="color:#111">)</span>
</span></span></code></pre></div><p>Viper还支持解析到嵌入的结构体：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">Example config:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">module:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    enabled: true
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    token: 89h3f98hbwf987h3f98wenf89ehf
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">config</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Module</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">Enabled</span> <span style="color:#00a8c8">bool</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">moduleConfig</span> <span style="color:#d88200">`mapstructure:&#34;,squash&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// moduleConfig could be in a module specific package</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">moduleConfig</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Token</span> <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">var</span> <span style="color:#75af00">C</span> <span style="color:#75af00">config</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">viper</span><span style="color:#111">.</span><span style="color:#75af00">Unmarshal</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">C</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">Fatalf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;unable to decode into struct, %v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>Viper在后台使用<a href="https://github.com/mitchellh/mapstructure">github.com/mitchellh/mapstructure</a>来解析值，其默认情况下使用mapstructuretag。</p>
<p><strong>注意</strong> 当我们需要将viper读取的配置反序列到我们定义的结构体变量中时，一定要使用mapstructuretag哦！</p>
<h4 id="序列化成字符串">序列化成字符串</h4>
<p>你可能需要将viper中保存的所有设置序列化到一个字符串中，而不是将它们写入到一个文件中。你可以将自己喜欢的格式的序列化器与AllSettings()返回的配置一起使用。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">yaml</span> <span style="color:#d88200">&#34;gopkg.in/yaml.v2&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ...</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">yamlStringSettings</span><span style="color:#111">()</span> <span style="color:#00a8c8">string</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">c</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">viper</span><span style="color:#111">.</span><span style="color:#75af00">AllSettings</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">bs</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">yaml</span><span style="color:#111">.</span><span style="color:#75af00">Marshal</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Fatalf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;unable to marshal config to YAML: %v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#111">string</span><span style="color:#111">(</span><span style="color:#75af00">bs</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="使用单个还是多个viper实例">使用单个还是多个Viper实例?</h3>
<p>Viper是开箱即用的。你不需要配置或初始化即可开始使用Viper。由于大多数应用程序都希望使用单个中央存储库管理它们的配置信息，所以viper包提供了这个功能。它类似于单例模式。</p>
<p>在上面的所有示例中，它们都以其单例风格的方法演示了如何使用viper。</p>
<h4 id="使用多个viper实例">使用多个viper实例</h4>
<p>你还可以在应用程序中创建许多不同的viper实例。每个都有自己独特的一组配置和值。每个人都可以从不同的配置文件，key value存储区等读取数据。每个都可以从不同的配置文件、键值存储等中读取。viper包支持的所有功能都被镜像为viper实例的方法。</p>
<p>例如：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">x</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">viper</span><span style="color:#111">.</span><span style="color:#75af00">New</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">y</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">viper</span><span style="color:#111">.</span><span style="color:#75af00">New</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">x</span><span style="color:#111">.</span><span style="color:#75af00">SetDefault</span><span style="color:#111">(</span><span style="color:#d88200">&#34;ContentDir&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;content&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">y</span><span style="color:#111">.</span><span style="color:#75af00">SetDefault</span><span style="color:#111">(</span><span style="color:#d88200">&#34;ContentDir&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;foobar&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//...</span>
</span></span></code></pre></div><p>当使用多个viper实例时，由用户来管理不同的viper实例。</p>
<h4 id="使用viper示例">使用Viper示例</h4>
<p>假设我们的项目现在有一个./conf/config.yaml配置文件，内容如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">port</span><span style="color:#111">:</span> <span style="color:#ae81ff">8123</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">version</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;v1.2.3&#34;</span>
</span></span></code></pre></div><p>接下来通过示例代码演示两种在项目中使用viper管理项目配置信息的方式。</p>
<h4 id="直接使用viper管理配置">直接使用viper管理配置</h4>
<p>这里用一个demo演示如何在gin框架搭建的web项目中使用viper，使用viper加载配置文件中的信息，并在代码中直接使用viper.GetXXX()方法获取对应的配置值。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;net/http&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;github.com/gin-gonic/gin&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;github.com/spf13/viper&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">viper</span><span style="color:#111">.</span><span style="color:#75af00">SetConfigFile</span><span style="color:#111">(</span><span style="color:#d88200">&#34;config.yaml&#34;</span><span style="color:#111">)</span> <span style="color:#75715e">// 指定配置文件</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">viper</span><span style="color:#111">.</span><span style="color:#75af00">AddConfigPath</span><span style="color:#111">(</span><span style="color:#d88200">&#34;./conf/&#34;</span><span style="color:#111">)</span>     <span style="color:#75715e">// 指定查找配置文件的路径</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">viper</span><span style="color:#111">.</span><span style="color:#75af00">ReadInConfig</span><span style="color:#111">()</span>        <span style="color:#75715e">// 读取配置信息</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>                    <span style="color:#75715e">// 读取配置信息失败</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Fatal error config file: %s \n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 监控配置文件变化</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">viper</span><span style="color:#111">.</span><span style="color:#75af00">WatchConfig</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Default</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 访问/version的返回值会随配置文件的变化而变化</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">GET</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/version&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">String</span><span style="color:#111">(</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">StatusOK</span><span style="color:#111">,</span> <span style="color:#75af00">viper</span><span style="color:#111">.</span><span style="color:#75af00">GetString</span><span style="color:#111">(</span><span style="color:#d88200">&#34;version&#34;</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">Run</span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Sprintf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;:%d&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">viper</span><span style="color:#111">.</span><span style="color:#75af00">GetInt</span><span style="color:#111">(</span><span style="color:#d88200">&#34;port&#34;</span><span style="color:#111">)));</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h4 id="使用结构体变量保存配置信息">使用结构体变量保存配置信息</h4>
<p>除了上面的用法外，我们还可以在项目中定义与配置文件对应的结构体，viper加载完配置信息后使用结构体变量保存配置信息。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;net/http&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;github.com/fsnotify/fsnotify&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;github.com/gin-gonic/gin&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;github.com/spf13/viper&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Config</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Port</span>    <span style="color:#00a8c8">int</span>    <span style="color:#d88200">`mapstructure:&#34;port&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Version</span> <span style="color:#00a8c8">string</span> <span style="color:#d88200">`mapstructure:&#34;version&#34;`</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">var</span> <span style="color:#75af00">Conf</span> <span style="color:#111">=</span> <span style="color:#111">new</span><span style="color:#111">(</span><span style="color:#75af00">Config</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">viper</span><span style="color:#111">.</span><span style="color:#75af00">SetConfigFile</span><span style="color:#111">(</span><span style="color:#d88200">&#34;./conf/config.yaml&#34;</span><span style="color:#111">)</span> <span style="color:#75715e">// 指定配置文件路径</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">viper</span><span style="color:#111">.</span><span style="color:#75af00">ReadInConfig</span><span style="color:#111">()</span>               <span style="color:#75715e">// 读取配置信息</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>                           <span style="color:#75715e">// 读取配置信息失败</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Fatal error config file: %s \n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 将读取的配置信息保存至全局变量Conf</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">viper</span><span style="color:#111">.</span><span style="color:#75af00">Unmarshal</span><span style="color:#111">(</span><span style="color:#75af00">Conf</span><span style="color:#111">);</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;unmarshal conf failed, err:%s \n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 监控配置文件变化</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">viper</span><span style="color:#111">.</span><span style="color:#75af00">WatchConfig</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 注意！！！配置文件发生变化后要同步到全局变量Conf</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">viper</span><span style="color:#111">.</span><span style="color:#75af00">OnConfigChange</span><span style="color:#111">(</span><span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">in</span> <span style="color:#75af00">fsnotify</span><span style="color:#111">.</span><span style="color:#75af00">Event</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;夭寿啦~配置文件被人修改啦...&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">viper</span><span style="color:#111">.</span><span style="color:#75af00">Unmarshal</span><span style="color:#111">(</span><span style="color:#75af00">Conf</span><span style="color:#111">);</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;unmarshal conf failed, err:%s \n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Default</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 访问/version的返回值会随配置文件的变化而变化</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">GET</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/version&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">String</span><span style="color:#111">(</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">StatusOK</span><span style="color:#111">,</span> <span style="color:#75af00">Conf</span><span style="color:#111">.</span><span style="color:#75af00">Version</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">Run</span><span style="color:#111">(</span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Sprintf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;:%d&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">Conf</span><span style="color:#111">.</span><span style="color:#75af00">Port</span><span style="color:#111">));</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="参考文章">参考文章</h2>
<ul>
<li><a href="https://www.liwenzhou.com/posts/Go/viper_tutorial">https://www.liwenzhou.com/posts/Go/viper_tutorial</a></li>
<li><a href="https://www.jianshu.com/p/7bb4f7f69280">https://www.jianshu.com/p/7bb4f7f69280</a></li>
</ul>
]]></content:encoded><category>go</category><category>go</category><category>viper</category></item><item><title>golangHTML标签提取器soup</title><link>https://daemon365.dev/post/go/golanghtml_tag_extractor_soup/</link><pubDate>Tue, 05 Jan 2021 00:00:00 +0800</pubDate><guid>https://daemon365.dev/post/go/golanghtml_tag_extractor_soup/</guid><description>&lt;h2 id="什么是soup"&gt;什么是soup&lt;/h2&gt;
&lt;p&gt;类似python中beatifulsoup，用于提取html标签提取，多用于爬虫。它可以很好的处理不规范标记并生成剖析树(parse tree)。 它提供简单又常用的导航，搜索以及修改剖析树的操作。利用它我们不在需要编写正则表达式就可以方便的实现网页信息的提取。soup是一个小型的网页提取包，其接口与beauthoulsoup非常相似。&lt;/p&gt;
&lt;h2 id="下载"&gt;下载&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;go get github.com/anaskhan96/soup
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id="接口"&gt;接口&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;var Headers map[string]string 将头文件设置为键-值对的映射，这是单独调用Header()的替代方法&lt;/li&gt;
&lt;li&gt;var Cookies map[string]string 将Cookie设置为键-值对的映射，这是单独调用Cookie()的另一种方法&lt;/li&gt;
&lt;li&gt;func Get(string) (string,error) {} 将url作为参数，返回HTML字符串&lt;/li&gt;
&lt;li&gt;func GetWithClient(string, *http.Client) {} 将url和自定义HTTP客户端作为参数，返回HTML字符串&lt;/li&gt;
&lt;li&gt;func Post(string, string, interface{}) (string, error) {} 以url、bodyType和负载为参数，返回HTML字符串&lt;/li&gt;
&lt;li&gt;func PostForm(string, url.Values) {} 接受url和正文。bodyType设置为“application/x-www-form-urlencoded&lt;/li&gt;
&lt;li&gt;func Header(string, string) {} 接受key，value对，将其设置为Get（）中的HTTP请求的头&lt;/li&gt;
&lt;li&gt;func Cookie(string, string) {} 接受key，value对，将其设置为要与Get（）中的HTTP请求一起发送的Cookie&lt;/li&gt;
&lt;li&gt;func HTMLParse(string) Root {} 以HTML字符串为参数，返回一个指向构造的DOM的指针&lt;/li&gt;
&lt;li&gt;func Find([]string) Root {} Element标记，（属性键值对）作为参数，返回指向第一个出现的指针&lt;/li&gt;
&lt;li&gt;func FindAll([]string) []Root {} 与Find（）相同，但返回指向所有匹配项的指针&lt;/li&gt;
&lt;li&gt;func FindStrict([]string) Root {} Element tag，（attribute key-value pair）作为参数，指向第一次出现的指针返回了完全匹配的值&lt;/li&gt;
&lt;li&gt;func FindAllStrict([]string) []Root {} 与FindStrict（）相同，但指向返回的所有引用的指针&lt;/li&gt;
&lt;li&gt;func FindNextSibling() Root {} find指向同一个functing}元素的下一个functing}指针&lt;/li&gt;
&lt;li&gt;func FindNextElementSibling() Root {} 指向返回的DOM中元素的下一个同级元素的指针&lt;/li&gt;
&lt;li&gt;func FindPrevSibling() Root {} 指向返回的DOM中元素的上一个同级的指针&lt;/li&gt;
&lt;li&gt;func FindPrevElementSibling() Root {} 指向返回的DOM中元素的上一个同级元素的指针&lt;/li&gt;
&lt;li&gt;func Children() []Root {} 查找此DOM元素的所有直接子级&lt;/li&gt;
&lt;li&gt;func Attrs() map[string]string {} map返回元素的所有属性作为对其各自值的查找&lt;/li&gt;
&lt;li&gt;func Text() string {} 返回非嵌套标记内的全文，在嵌套标记中返回前半部分e&lt;/li&gt;
&lt;li&gt;func FullText() string {} 返回嵌套/非嵌套标记内的全文&lt;/li&gt;
&lt;li&gt;func SetDebug(bool) {} 将调试模式设置为true或false；默认为false&lt;/li&gt;
&lt;li&gt;func HTML() {} HTML返回特定元素的HTML代码&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="例子"&gt;例子&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;package&lt;/span&gt; &lt;span style="color:#75af00"&gt;main&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;import&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;fmt&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;os&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;github.com/anaskhan96/soup&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;main&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;resp&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;soup&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Get&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;http://zhaohaiyu.com&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;!=&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;os&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Exit&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;1&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;doc&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;soup&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;HTMLParse&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;resp&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;links&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;doc&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Find&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;div&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;class&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;res-cons&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;).&lt;/span&gt;&lt;span style="color:#75af00"&gt;FindAll&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;article&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;class&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;post&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;links&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;for&lt;/span&gt; &lt;span style="color:#75af00"&gt;_&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;link&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;range&lt;/span&gt; &lt;span style="color:#75af00"&gt;links&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;l&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;link&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Find&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;a&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;l&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Text&lt;/span&gt;&lt;span style="color:#111"&gt;(),&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;--------&amp;gt;&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;l&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Attrs&lt;/span&gt;&lt;span style="color:#111"&gt;()[&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;href&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;])&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;结果&lt;/p&gt;</description><content:encoded><![CDATA[<h2 id="什么是soup">什么是soup</h2>
<p>类似python中beatifulsoup，用于提取html标签提取，多用于爬虫。它可以很好的处理不规范标记并生成剖析树(parse tree)。 它提供简单又常用的导航，搜索以及修改剖析树的操作。利用它我们不在需要编写正则表达式就可以方便的实现网页信息的提取。soup是一个小型的网页提取包，其接口与beauthoulsoup非常相似。</p>
<h2 id="下载">下载</h2>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>go get github.com/anaskhan96/soup
</span></span></code></pre></div><h2 id="接口">接口</h2>
<ul>
<li>var Headers map[string]string 将头文件设置为键-值对的映射，这是单独调用Header()的替代方法</li>
<li>var Cookies map[string]string 将Cookie设置为键-值对的映射，这是单独调用Cookie()的另一种方法</li>
<li>func Get(string) (string,error) {} 将url作为参数，返回HTML字符串</li>
<li>func GetWithClient(string, *http.Client) {} 将url和自定义HTTP客户端作为参数，返回HTML字符串</li>
<li>func Post(string, string, interface{}) (string, error) {} 以url、bodyType和负载为参数，返回HTML字符串</li>
<li>func PostForm(string, url.Values) {} 接受url和正文。bodyType设置为“application/x-www-form-urlencoded</li>
<li>func Header(string, string) {}  接受key，value对，将其设置为Get（）中的HTTP请求的头</li>
<li>func Cookie(string, string) {} 接受key，value对，将其设置为要与Get（）中的HTTP请求一起发送的Cookie</li>
<li>func HTMLParse(string) Root {} 以HTML字符串为参数，返回一个指向构造的DOM的指针</li>
<li>func Find([]string) Root {} Element标记，（属性键值对）作为参数，返回指向第一个出现的指针</li>
<li>func FindAll([]string) []Root {} 与Find（）相同，但返回指向所有匹配项的指针</li>
<li>func FindStrict([]string) Root {}  Element tag，（attribute key-value pair）作为参数，指向第一次出现的指针返回了完全匹配的值</li>
<li>func FindAllStrict([]string) []Root {} 与FindStrict（）相同，但指向返回的所有引用的指针</li>
<li>func FindNextSibling() Root {} find指向同一个functing}元素的下一个functing}指针</li>
<li>func FindNextElementSibling() Root {} 指向返回的DOM中元素的下一个同级元素的指针</li>
<li>func FindPrevSibling() Root {} 指向返回的DOM中元素的上一个同级的指针</li>
<li>func FindPrevElementSibling() Root {} 指向返回的DOM中元素的上一个同级元素的指针</li>
<li>func Children() []Root {} 查找此DOM元素的所有直接子级</li>
<li>func Attrs() map[string]string {} map返回元素的所有属性作为对其各自值的查找</li>
<li>func Text() string {} 返回非嵌套标记内的全文，在嵌套标记中返回前半部分e</li>
<li>func FullText() string {} 返回嵌套/非嵌套标记内的全文</li>
<li>func SetDebug(bool) {}  将调试模式设置为true或false；默认为false</li>
<li>func HTML() {}  HTML返回特定元素的HTML代码</li>
</ul>
<h2 id="例子">例子</h2>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;github.com/anaskhan96/soup&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">resp</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">soup</span><span style="color:#111">.</span><span style="color:#75af00">Get</span><span style="color:#111">(</span><span style="color:#d88200">&#34;http://zhaohaiyu.com&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">Exit</span><span style="color:#111">(</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">doc</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">soup</span><span style="color:#111">.</span><span style="color:#75af00">HTMLParse</span><span style="color:#111">(</span><span style="color:#75af00">resp</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">links</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">doc</span><span style="color:#111">.</span><span style="color:#75af00">Find</span><span style="color:#111">(</span><span style="color:#d88200">&#34;div&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;class&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;res-cons&#34;</span><span style="color:#111">).</span><span style="color:#75af00">FindAll</span><span style="color:#111">(</span><span style="color:#d88200">&#34;article&#34;</span><span style="color:#111">,</span><span style="color:#d88200">&#34;class&#34;</span><span style="color:#111">,</span><span style="color:#d88200">&#34;post&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">links</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">link</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">links</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">l</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">link</span><span style="color:#111">.</span><span style="color:#75af00">Find</span><span style="color:#111">(</span><span style="color:#d88200">&#34;a&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">l</span><span style="color:#111">.</span><span style="color:#75af00">Text</span><span style="color:#111">(),</span> <span style="color:#d88200">&#34;--------&gt;&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">l</span><span style="color:#111">.</span><span style="color:#75af00">Attrs</span><span style="color:#111">()[</span><span style="color:#d88200">&#34;href&#34;</span><span style="color:#111">])</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>结果</p>
<pre tabindex="0"><code>【置顶】golang目录 --------&gt; https://zhaohaiyu.com/post/go/go_catalog/
go语言文件系统 --------&gt; https://zhaohaiyu.com/post/go/go_file/
Flex --------&gt; https://zhaohaiyu.com/post/javascript/flex/
makefile --------&gt; https://zhaohaiyu.com/post/go/makefile/
air热加载 --------&gt; https://zhaohaiyu.com/post/go/air/
thrift的介绍及其使用 --------&gt; https://zhaohaiyu.com/post/go/thrift/
golang中间件的实现 --------&gt; https://zhaohaiyu.com/post/go/middleware/
zap高性能日志 --------&gt; https://zhaohaiyu.com/post/go/zap/
viper配置管理 --------&gt; https://zhaohaiyu.com/post/go/viper/
proto Prometheus --------&gt; https://zhaohaiyu.com/post/go/promethues/
</code></pre>]]></content:encoded><category>go</category><category>go</category></item><item><title>golang jwt</title><link>https://daemon365.dev/post/go/golang_jwt/</link><pubDate>Wed, 20 May 2020 00:00:00 +0800</pubDate><guid>https://daemon365.dev/post/go/golang_jwt/</guid><description>&lt;h2 id="什么是jwt"&gt;什么是JWT？&lt;/h2&gt;
&lt;p&gt;JWT全称JSON Web Token是一种跨域认证解决方案，属于一个开放的标准，它规定了一种Token实现方式，目前多用于前后端分离项目和OAuth2.0业务场景下。&lt;/p&gt;
&lt;h2 id="jwt作用"&gt;JWT作用？&lt;/h2&gt;
&lt;p&gt;JWT就是一种基于Token的轻量级认证模式，服务端认证通过后，会生成一个JSON对象，经过签名后得到一个Token（令牌）再发回给用户，用户后续请求只需要带上这个Token，服务端解密之后就能获取该用户的相关信息了。&lt;/p&gt;
&lt;h2 id="下载jwt"&gt;下载jwt&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;go get -u github.com/golang-jwt/jwt
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id="生成jwt和解析jwt"&gt;生成JWT和解析JWT&lt;/h2&gt;
&lt;p&gt;我们在这里直接使用jwt-go这个库来实现我们生成JWT和解析JWT的功能。&lt;/p&gt;
&lt;p&gt;定义需求&lt;/p&gt;
&lt;p&gt;我们需要定制自己的需求来决定JWT中保存哪些数据&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;type&lt;/span&gt; &lt;span style="color:#75af00"&gt;MyClaims&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;struct&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;UserID&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;uint64&lt;/span&gt; &lt;span style="color:#d88200"&gt;`json:&amp;#34;user_id&amp;#34;`&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;Username&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;string&lt;/span&gt; &lt;span style="color:#d88200"&gt;`json:&amp;#34;username&amp;#34;`&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;jwt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;StandardClaims&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;定义JWT的过期时间和Secret(盐)：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;const&lt;/span&gt; &lt;span style="color:#75af00"&gt;TokenExpireDuration&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#75af00"&gt;time&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Hour&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;24&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;2&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 过期时间 -2天&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;var&lt;/span&gt; &lt;span style="color:#75af00"&gt;Secret&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#111"&gt;[]&lt;/span&gt;&lt;span style="color:#111"&gt;byte&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;i am zhaohaiyu&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75715e"&gt;// Secret(盐) 用来加密解密&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id="生成jwt"&gt;生成JWT&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;//生成 jwt token&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;genToken&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;userID&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;uint64&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;username&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;string&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;string&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;error&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;var&lt;/span&gt; &lt;span style="color:#75af00"&gt;claims&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#75af00"&gt;MyClaims&lt;/span&gt;&lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;userID&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;username&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;jwt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;StandardClaims&lt;/span&gt;&lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;ExpiresAt&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#75af00"&gt;time&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Now&lt;/span&gt;&lt;span style="color:#111"&gt;().&lt;/span&gt;&lt;span style="color:#75af00"&gt;Add&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;TokenExpireDuration&lt;/span&gt;&lt;span style="color:#111"&gt;).&lt;/span&gt;&lt;span style="color:#75af00"&gt;Unix&lt;/span&gt;&lt;span style="color:#111"&gt;(),&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 过期时间&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;Issuer&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;zhaohaiyu&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 签发人&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;},&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;token&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;jwt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;NewWithClaims&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;jwt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;SigningMethodHS256&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;claims&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;signedToken&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;token&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;SignedString&lt;/span&gt;&lt;span style="color:#111"&gt;([]&lt;/span&gt;&lt;span style="color:#111"&gt;byte&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;Secret&lt;/span&gt;&lt;span style="color:#111"&gt;))&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;!=&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Errorf&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;生成token失败:%v&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt; &lt;span style="color:#75af00"&gt;signedToken&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id="解析jwt"&gt;解析JWT&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;//验证jwt token&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;ParseToken&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;tokenStr&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;string&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;MyClaims&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;error&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;token&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;jwt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;ParseWithClaims&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;tokenStr&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#f92672"&gt;&amp;amp;&lt;/span&gt;&lt;span style="color:#75af00"&gt;MyClaims&lt;/span&gt;&lt;span style="color:#111"&gt;{},&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;func&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;token&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;jwt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Token&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;i&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;interface&lt;/span&gt;&lt;span style="color:#111"&gt;{},&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;error&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 解析token&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt; &lt;span style="color:#75af00"&gt;Secret&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;})&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;!=&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;claims&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;ok&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;token&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Claims&lt;/span&gt;&lt;span style="color:#111"&gt;.(&lt;/span&gt;&lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;MyClaims&lt;/span&gt;&lt;span style="color:#111"&gt;);&lt;/span&gt; &lt;span style="color:#75af00"&gt;ok&lt;/span&gt; &lt;span style="color:#f92672"&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span style="color:#75af00"&gt;token&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Valid&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 校验token&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt; &lt;span style="color:#75af00"&gt;claims&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;errors&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;New&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;invalid token&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id="在gin框架中使用jwt"&gt;在gin框架中使用JWT&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75af00"&gt;r&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;POST&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;/auth/token&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;GetTokenHandler&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id="登录生成token"&gt;登录生成token&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;GetTokenHandler&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;c&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;gin&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Context&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// 接收参数&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;var&lt;/span&gt; &lt;span style="color:#75af00"&gt;user&lt;/span&gt; &lt;span style="color:#75af00"&gt;UserInfo&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;c&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;ShouldBind&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#f92672"&gt;&amp;amp;&lt;/span&gt;&lt;span style="color:#75af00"&gt;user&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;!=&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;c&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;JSON&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;http&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;StatusOK&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;gin&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;H&lt;/span&gt;&lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;code&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;1001&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;err_info&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;参数错误&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;})&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// 验证密码&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;user&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Username&lt;/span&gt; &lt;span style="color:#f92672"&gt;==&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;root&amp;#34;&lt;/span&gt; &lt;span style="color:#f92672"&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span style="color:#75af00"&gt;user&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Password&lt;/span&gt; &lt;span style="color:#f92672"&gt;==&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;123&amp;#34;&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// 生成Token&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;tokenString&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;GenToken&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;user&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Username&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;!=&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;c&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;JSON&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;http&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;StatusOK&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;gin&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;H&lt;/span&gt;&lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;code&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;1001&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;err_info&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;生成token错误&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;})&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;c&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;JSON&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;http&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;StatusOK&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;gin&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;H&lt;/span&gt;&lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;code&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;2000&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;msg&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;success&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;data&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#75af00"&gt;gin&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;H&lt;/span&gt;&lt;span style="color:#111"&gt;{&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;token&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#75af00"&gt;tokenString&lt;/span&gt;&lt;span style="color:#111"&gt;},&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;})&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;else&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;c&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;JSON&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;http&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;StatusOK&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;gin&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;H&lt;/span&gt;&lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;code&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;2002&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;msg&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;用户名或密码错误&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;})&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id="jwt中间件验证"&gt;jwt中间件验证&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;// JWThMiddleware 中间件&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;JWThMiddleware&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;func&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;c&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;gin&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Context&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;func&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;c&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;gin&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Context&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// 客户端携带Token有三种方式 1.放在请求头 2.放在请求体 3.放在URI&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// 这里假设Token放在Header的token中&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;token&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;c&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Request&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Header&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Get&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;token&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;token&lt;/span&gt; &lt;span style="color:#f92672"&gt;==&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;&amp;#34;&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// 处理 没有token的时候&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;c&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Abort&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 不会继续停止&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// 解析&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;mc&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;ParseToken&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;token&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;!=&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// 处理 解析失败&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;c&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Abort&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// 将当前请求的userID信息保存到请求的上下文c上&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;c&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Set&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;userID&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;mc&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;UserID&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;c&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Next&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;</description><content:encoded><![CDATA[<h2 id="什么是jwt">什么是JWT？</h2>
<p>JWT全称JSON Web Token是一种跨域认证解决方案，属于一个开放的标准，它规定了一种Token实现方式，目前多用于前后端分离项目和OAuth2.0业务场景下。</p>
<h2 id="jwt作用">JWT作用？</h2>
<p>JWT就是一种基于Token的轻量级认证模式，服务端认证通过后，会生成一个JSON对象，经过签名后得到一个Token（令牌）再发回给用户，用户后续请求只需要带上这个Token，服务端解密之后就能获取该用户的相关信息了。</p>
<h2 id="下载jwt">下载jwt</h2>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>go get -u github.com/golang-jwt/jwt
</span></span></code></pre></div><h2 id="生成jwt和解析jwt">生成JWT和解析JWT</h2>
<p>我们在这里直接使用jwt-go这个库来实现我们生成JWT和解析JWT的功能。</p>
<p>定义需求</p>
<p>我们需要定制自己的需求来决定JWT中保存哪些数据</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">MyClaims</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">UserID</span>   <span style="color:#00a8c8">uint64</span> <span style="color:#d88200">`json:&#34;user_id&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Username</span> <span style="color:#00a8c8">string</span> <span style="color:#d88200">`json:&#34;username&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">jwt</span><span style="color:#111">.</span><span style="color:#75af00">StandardClaims</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>定义JWT的过期时间和Secret(盐)：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">const</span> <span style="color:#75af00">TokenExpireDuration</span> <span style="color:#111">=</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Hour</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">24</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">2</span> <span style="color:#75715e">// 过期时间 -2天</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">var</span> <span style="color:#75af00">Secret</span> <span style="color:#111">=</span> <span style="color:#111">[]</span><span style="color:#111">byte</span><span style="color:#111">(</span><span style="color:#d88200">&#34;i am zhaohaiyu&#34;</span><span style="color:#111">)</span> <span style="color:#75715e">// Secret(盐) 用来加密解密</span>
</span></span></code></pre></div><h2 id="生成jwt">生成JWT</h2>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">//生成 jwt token</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">genToken</span><span style="color:#111">(</span><span style="color:#75af00">userID</span> <span style="color:#00a8c8">uint64</span><span style="color:#111">,</span> <span style="color:#75af00">username</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#00a8c8">string</span><span style="color:#111">,</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">var</span> <span style="color:#75af00">claims</span> <span style="color:#111">=</span> <span style="color:#75af00">MyClaims</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">userID</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">username</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">jwt</span><span style="color:#111">.</span><span style="color:#75af00">StandardClaims</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">ExpiresAt</span><span style="color:#111">:</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Now</span><span style="color:#111">().</span><span style="color:#75af00">Add</span><span style="color:#111">(</span><span style="color:#75af00">TokenExpireDuration</span><span style="color:#111">).</span><span style="color:#75af00">Unix</span><span style="color:#111">(),</span> <span style="color:#75715e">// 过期时间</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">Issuer</span><span style="color:#111">:</span>    <span style="color:#d88200">&#34;zhaohaiyu&#34;</span><span style="color:#111">,</span>                                <span style="color:#75715e">// 签发人</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">},</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">token</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">jwt</span><span style="color:#111">.</span><span style="color:#75af00">NewWithClaims</span><span style="color:#111">(</span><span style="color:#75af00">jwt</span><span style="color:#111">.</span><span style="color:#75af00">SigningMethodHS256</span><span style="color:#111">,</span> <span style="color:#75af00">claims</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">signedToken</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">token</span><span style="color:#111">.</span><span style="color:#75af00">SignedString</span><span style="color:#111">([]</span><span style="color:#111">byte</span><span style="color:#111">(</span><span style="color:#75af00">Secret</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#d88200">&#34;&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;生成token失败:%v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">signedToken</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="解析jwt">解析JWT</h2>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">//验证jwt token</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">ParseToken</span><span style="color:#111">(</span><span style="color:#75af00">tokenStr</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">MyClaims</span><span style="color:#111">,</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">token</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">jwt</span><span style="color:#111">.</span><span style="color:#75af00">ParseWithClaims</span><span style="color:#111">(</span><span style="color:#75af00">tokenStr</span><span style="color:#111">,</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">MyClaims</span><span style="color:#111">{},</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">token</span> <span style="color:#f92672">*</span><span style="color:#75af00">jwt</span><span style="color:#111">.</span><span style="color:#75af00">Token</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#75af00">i</span> <span style="color:#00a8c8">interface</span><span style="color:#111">{},</span> <span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span> <span style="color:#75715e">// 解析token</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">Secret</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">claims</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">token</span><span style="color:#111">.</span><span style="color:#75af00">Claims</span><span style="color:#111">.(</span><span style="color:#f92672">*</span><span style="color:#75af00">MyClaims</span><span style="color:#111">);</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">token</span><span style="color:#111">.</span><span style="color:#75af00">Valid</span> <span style="color:#111">{</span> <span style="color:#75715e">// 校验token</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">claims</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">errors</span><span style="color:#111">.</span><span style="color:#75af00">New</span><span style="color:#111">(</span><span style="color:#d88200">&#34;invalid token&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="在gin框架中使用jwt">在gin框架中使用JWT</h2>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">POST</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/auth/token&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">GetTokenHandler</span><span style="color:#111">)</span>
</span></span></code></pre></div><h3 id="登录生成token">登录生成token</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">GetTokenHandler</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 接收参数</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">var</span> <span style="color:#75af00">user</span> <span style="color:#75af00">UserInfo</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">ShouldBind</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">user</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">JSON</span><span style="color:#111">(</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">StatusOK</span><span style="color:#111">,</span> <span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">H</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#d88200">&#34;code&#34;</span><span style="color:#111">:</span>     <span style="color:#ae81ff">1001</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#d88200">&#34;err_info&#34;</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;参数错误&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 验证密码</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">user</span><span style="color:#111">.</span><span style="color:#75af00">Username</span> <span style="color:#f92672">==</span> <span style="color:#d88200">&#34;root&#34;</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">user</span><span style="color:#111">.</span><span style="color:#75af00">Password</span> <span style="color:#f92672">==</span> <span style="color:#d88200">&#34;123&#34;</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 生成Token</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">tokenString</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">GenToken</span><span style="color:#111">(</span><span style="color:#75af00">user</span><span style="color:#111">.</span><span style="color:#75af00">Username</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">JSON</span><span style="color:#111">(</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">StatusOK</span><span style="color:#111">,</span> <span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">H</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#d88200">&#34;code&#34;</span><span style="color:#111">:</span>     <span style="color:#ae81ff">1001</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#d88200">&#34;err_info&#34;</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;生成token错误&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">JSON</span><span style="color:#111">(</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">StatusOK</span><span style="color:#111">,</span> <span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">H</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#d88200">&#34;code&#34;</span><span style="color:#111">:</span> <span style="color:#ae81ff">2000</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#d88200">&#34;msg&#34;</span><span style="color:#111">:</span>  <span style="color:#d88200">&#34;success&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#d88200">&#34;data&#34;</span><span style="color:#111">:</span> <span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">H</span><span style="color:#111">{</span><span style="color:#d88200">&#34;token&#34;</span><span style="color:#111">:</span> <span style="color:#75af00">tokenString</span><span style="color:#111">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">JSON</span><span style="color:#111">(</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">StatusOK</span><span style="color:#111">,</span> <span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">H</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#d88200">&#34;code&#34;</span><span style="color:#111">:</span> <span style="color:#ae81ff">2002</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#d88200">&#34;msg&#34;</span><span style="color:#111">:</span>  <span style="color:#d88200">&#34;用户名或密码错误&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="jwt中间件验证">jwt中间件验证</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// JWThMiddleware 中间件</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">JWThMiddleware</span><span style="color:#111">()</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 客户端携带Token有三种方式 1.放在请求头 2.放在请求体 3.放在URI</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 这里假设Token放在Header的token中</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">token</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">Request</span><span style="color:#111">.</span><span style="color:#75af00">Header</span><span style="color:#111">.</span><span style="color:#75af00">Get</span><span style="color:#111">(</span><span style="color:#d88200">&#34;token&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">token</span> <span style="color:#f92672">==</span> <span style="color:#d88200">&#34;&#34;</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 处理 没有token的时候</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">Abort</span><span style="color:#111">()</span> <span style="color:#75715e">// 不会继续停止</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 解析</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">mc</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">ParseToken</span><span style="color:#111">(</span><span style="color:#75af00">token</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 处理 解析失败</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">Abort</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 将当前请求的userID信息保存到请求的上下文c上</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">Set</span><span style="color:#111">(</span><span style="color:#d88200">&#34;userID&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">mc</span><span style="color:#111">.</span><span style="color:#75af00">UserID</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">Next</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div>]]></content:encoded><category>go</category><category>go</category></item><item><title>golang web源码解析</title><link>https://daemon365.dev/post/go/golang_web_source_code_analysis/</link><pubDate>Sat, 21 Mar 2020 00:00:00 +0800</pubDate><guid>https://daemon365.dev/post/go/golang_web_source_code_analysis/</guid><description>&lt;h2 id="go的web工作原理"&gt;Go的web工作原理&lt;/h2&gt;
&lt;p&gt;在Go中使用及其简单的代码即可开启一个web服务。如下：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;//开启web服务&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;test&lt;/span&gt;&lt;span style="color:#111"&gt;(){&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;http&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;HandleFunc&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;/&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;sayHello&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;http&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;ListenAndServe&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;:9090&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt;&lt;span style="color:#f92672"&gt;!=&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;log&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Fatal&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;ListenAndServer:&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt;&lt;span style="color:#75af00"&gt;err&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;sayHello&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;w&lt;/span&gt; &lt;span style="color:#75af00"&gt;http&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;ResponseWriter&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;r&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;http&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Request&lt;/span&gt;&lt;span style="color:#111"&gt;){&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;r&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;ParseForm&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;path&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt;&lt;span style="color:#75af00"&gt;r&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;URL&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Path&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;scheme&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt;&lt;span style="color:#75af00"&gt;r&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;URL&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Scheme&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Fprintf&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;w&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;Hello Guest!&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;在使用&lt;code&gt;ListenAndServe&lt;/code&gt;这个方法时，系统就会给我们指派一个路由器，&lt;code&gt;DefaultServeMux&lt;/code&gt;是系统默认使用的路由器，如果&lt;code&gt;ListenAndServe&lt;/code&gt;这个方法的第2个参数传入nil，系统就会默认使用&lt;code&gt;DefaultServeMux&lt;/code&gt;。当然，这里也可以传入自定义的路由器。&lt;/p&gt;
&lt;p&gt;先来看&lt;code&gt;http.HandleFunc(&amp;quot;/&amp;quot;, sayHello)&lt;/code&gt;，从&lt;code&gt;HandleFunc&lt;/code&gt;方法点进去，如下：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;HandleFunc&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;pattern&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;string&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;handler&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;func&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;ResponseWriter&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;Request&lt;/span&gt;&lt;span style="color:#111"&gt;))&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;DefaultServeMux&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;HandleFunc&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;pattern&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;handler&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;在这里调用了&lt;code&gt;DefaultServeMux&lt;/code&gt;的&lt;code&gt;HandleFunc&lt;/code&gt;方法，这个方法有两个参数，&lt;code&gt;pattern&lt;/code&gt;是匹配的路由规则，&lt;code&gt;handler&lt;/code&gt;表示这个路由规则对应的处理方法，并且这个处理方法有两个参数。&lt;/p&gt;
&lt;p&gt;在我们书写的代码示例中，&lt;code&gt;pattern&lt;/code&gt;对应&lt;code&gt;/&lt;/code&gt;，&lt;code&gt;handler&lt;/code&gt;对应&lt;code&gt;sayHello&lt;/code&gt;，当我们在浏览器中输入&lt;code&gt;http://localhost:9090&lt;/code&gt;时，就会触发&lt;code&gt;sayHello&lt;/code&gt;方法。&lt;/p&gt;
&lt;p&gt;我们再顺着&lt;code&gt;DefaultServeMux&lt;/code&gt;的&lt;code&gt;HandleFunc&lt;/code&gt;方法继续点下去，如下：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;mux&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;ServeMux&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75af00"&gt;HandleFunc&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;pattern&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;string&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;handler&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;func&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;ResponseWriter&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;Request&lt;/span&gt;&lt;span style="color:#111"&gt;))&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;mux&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Handle&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;pattern&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;HandlerFunc&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;handler&lt;/span&gt;&lt;span style="color:#111"&gt;))&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;在这个方法中，路由器又调用了&lt;code&gt;Handle&lt;/code&gt;方法，注意这个&lt;code&gt;Handle&lt;/code&gt;方法的第2个参数，将之前传入的&lt;code&gt;handler&lt;/code&gt;这个响应方法强制转换成了&lt;code&gt;HandlerFunc&lt;/code&gt;类型。&lt;/p&gt;
&lt;p&gt;这个&lt;code&gt;HandlerFunc&lt;/code&gt;类型到底是个什么呢？如下：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;type&lt;/span&gt; &lt;span style="color:#75af00"&gt;HandlerFunc&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;func&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;ResponseWriter&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;Request&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;看来和我们定义的&lt;code&gt;SayHello&lt;/code&gt;方法的类型都差不多。但是！！！
这个&lt;code&gt;HandlerFunc&lt;/code&gt;默认实现了&lt;code&gt;ServeHTTP&lt;/code&gt;接口！这样&lt;code&gt;HandlerFunc&lt;/code&gt;对象就有了&lt;code&gt;ServeHTTP&lt;/code&gt;方法！如下：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;// ServeHTTP calls f(w, r).&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;f&lt;/span&gt; &lt;span style="color:#75af00"&gt;HandlerFunc&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75af00"&gt;ServeHTTP&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;w&lt;/span&gt; &lt;span style="color:#75af00"&gt;ResponseWriter&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;r&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;Request&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;f&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;w&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;r&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;这个细节是十分重要的，因为这一步关乎到当路由规则匹配时，相应的响应方法是否会被调用的问题！这个方法的调用时机会在下一小节中讲到。&lt;/p&gt;
&lt;p&gt;接下来，我们返回去继续看&lt;code&gt;mux&lt;/code&gt;的&lt;code&gt;Handle&lt;/code&gt;方法，也就是这段代码&lt;code&gt;mux.Handle(pattern, HandlerFunc(handler))&lt;/code&gt;。这段代码做了哪些事呢？源码如下：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;mux&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;ServeMux&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75af00"&gt;Handle&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;pattern&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;string&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;handler&lt;/span&gt; &lt;span style="color:#75af00"&gt;Handler&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;mux&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;mu&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Lock&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;defer&lt;/span&gt; &lt;span style="color:#75af00"&gt;mux&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;mu&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Unlock&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;pattern&lt;/span&gt; &lt;span style="color:#f92672"&gt;==&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;&amp;#34;&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;panic&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;http: invalid pattern &amp;#34;&lt;/span&gt; &lt;span style="color:#f92672"&gt;+&lt;/span&gt; &lt;span style="color:#75af00"&gt;pattern&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;handler&lt;/span&gt; &lt;span style="color:#f92672"&gt;==&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;panic&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;http: nil handler&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;mux&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;m&lt;/span&gt;&lt;span style="color:#111"&gt;[&lt;/span&gt;&lt;span style="color:#75af00"&gt;pattern&lt;/span&gt;&lt;span style="color:#111"&gt;].&lt;/span&gt;&lt;span style="color:#75af00"&gt;explicit&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;panic&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;http: multiple registrations for &amp;#34;&lt;/span&gt; &lt;span style="color:#f92672"&gt;+&lt;/span&gt; &lt;span style="color:#75af00"&gt;pattern&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;mux&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;m&lt;/span&gt; &lt;span style="color:#f92672"&gt;==&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;mux&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;m&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#111"&gt;make&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;map&lt;/span&gt;&lt;span style="color:#111"&gt;[&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;string&lt;/span&gt;&lt;span style="color:#111"&gt;]&lt;/span&gt;&lt;span style="color:#75af00"&gt;muxEntry&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;mux&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;m&lt;/span&gt;&lt;span style="color:#111"&gt;[&lt;/span&gt;&lt;span style="color:#75af00"&gt;pattern&lt;/span&gt;&lt;span style="color:#111"&gt;]&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#75af00"&gt;muxEntry&lt;/span&gt;&lt;span style="color:#111"&gt;{&lt;/span&gt;&lt;span style="color:#75af00"&gt;explicit&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;true&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;h&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#75af00"&gt;handler&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;pattern&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#75af00"&gt;pattern&lt;/span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;pattern&lt;/span&gt;&lt;span style="color:#111"&gt;[&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;0&lt;/span&gt;&lt;span style="color:#111"&gt;]&lt;/span&gt; &lt;span style="color:#f92672"&gt;!=&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#39;/&amp;#39;&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;mux&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;hosts&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;true&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// Helpful behavior:&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// If pattern is /tree/, insert an implicit permanent redirect for /tree.&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// It can be overridden by an explicit registration.&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;n&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#111"&gt;len&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;pattern&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;n&lt;/span&gt; &lt;span style="color:#111"&gt;&amp;gt;&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;0&lt;/span&gt; &lt;span style="color:#f92672"&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span style="color:#75af00"&gt;pattern&lt;/span&gt;&lt;span style="color:#111"&gt;[&lt;/span&gt;&lt;span style="color:#75af00"&gt;n&lt;/span&gt;&lt;span style="color:#f92672"&gt;-&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;1&lt;/span&gt;&lt;span style="color:#111"&gt;]&lt;/span&gt; &lt;span style="color:#f92672"&gt;==&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#39;/&amp;#39;&lt;/span&gt; &lt;span style="color:#f92672"&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span style="color:#111"&gt;!&lt;/span&gt;&lt;span style="color:#75af00"&gt;mux&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;m&lt;/span&gt;&lt;span style="color:#111"&gt;[&lt;/span&gt;&lt;span style="color:#75af00"&gt;pattern&lt;/span&gt;&lt;span style="color:#111"&gt;[&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;0&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt;&lt;span style="color:#75af00"&gt;n&lt;/span&gt;&lt;span style="color:#f92672"&gt;-&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;1&lt;/span&gt;&lt;span style="color:#111"&gt;]].&lt;/span&gt;&lt;span style="color:#75af00"&gt;explicit&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// If pattern contains a host name, strip it and use remaining&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// path for redirect.&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;path&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;pattern&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;pattern&lt;/span&gt;&lt;span style="color:#111"&gt;[&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;0&lt;/span&gt;&lt;span style="color:#111"&gt;]&lt;/span&gt; &lt;span style="color:#f92672"&gt;!=&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#39;/&amp;#39;&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// In pattern, at least the last character is a &amp;#39;/&amp;#39;, so&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// strings.Index can&amp;#39;t be -1.&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;path&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#75af00"&gt;pattern&lt;/span&gt;&lt;span style="color:#111"&gt;[&lt;/span&gt;&lt;span style="color:#75af00"&gt;strings&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Index&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;pattern&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;/&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;):]&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;url&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#f92672"&gt;&amp;amp;&lt;/span&gt;&lt;span style="color:#75af00"&gt;url&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;URL&lt;/span&gt;&lt;span style="color:#111"&gt;{&lt;/span&gt;&lt;span style="color:#75af00"&gt;Path&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#75af00"&gt;path&lt;/span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;mux&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;m&lt;/span&gt;&lt;span style="color:#111"&gt;[&lt;/span&gt;&lt;span style="color:#75af00"&gt;pattern&lt;/span&gt;&lt;span style="color:#111"&gt;[&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;0&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt;&lt;span style="color:#75af00"&gt;n&lt;/span&gt;&lt;span style="color:#f92672"&gt;-&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;1&lt;/span&gt;&lt;span style="color:#111"&gt;]]&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#75af00"&gt;muxEntry&lt;/span&gt;&lt;span style="color:#111"&gt;{&lt;/span&gt;&lt;span style="color:#75af00"&gt;h&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#75af00"&gt;RedirectHandler&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;url&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;String&lt;/span&gt;&lt;span style="color:#111"&gt;(),&lt;/span&gt; &lt;span style="color:#75af00"&gt;StatusMovedPermanently&lt;/span&gt;&lt;span style="color:#111"&gt;),&lt;/span&gt; &lt;span style="color:#75af00"&gt;pattern&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#75af00"&gt;pattern&lt;/span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;代码挺多，其实主要就做了一件事，向&lt;code&gt;DefaultServeMux&lt;/code&gt;的&lt;code&gt;map[string]muxEntry&lt;/code&gt;中增加对应的路由规则和&lt;code&gt;handler&lt;/code&gt;。&lt;/p&gt;</description><content:encoded><![CDATA[<h2 id="go的web工作原理">Go的web工作原理</h2>
<p>在Go中使用及其简单的代码即可开启一个web服务。如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">//开启web服务</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">test</span><span style="color:#111">(){</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">HandleFunc</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">sayHello</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">ListenAndServe</span><span style="color:#111">(</span><span style="color:#d88200">&#34;:9090&#34;</span><span style="color:#111">,</span><span style="color:#00a8c8">nil</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span><span style="color:#f92672">!=</span><span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Fatal</span><span style="color:#111">(</span><span style="color:#d88200">&#34;ListenAndServer:&#34;</span><span style="color:#111">,</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">sayHello</span><span style="color:#111">(</span><span style="color:#75af00">w</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">ResponseWriter</span><span style="color:#111">,</span> <span style="color:#75af00">r</span> <span style="color:#f92672">*</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Request</span><span style="color:#111">){</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">ParseForm</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;path&#34;</span><span style="color:#111">,</span><span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">URL</span><span style="color:#111">.</span><span style="color:#75af00">Path</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;scheme&#34;</span><span style="color:#111">,</span><span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">URL</span><span style="color:#111">.</span><span style="color:#75af00">Scheme</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Fprintf</span><span style="color:#111">(</span><span style="color:#75af00">w</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Hello Guest!&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>在使用<code>ListenAndServe</code>这个方法时，系统就会给我们指派一个路由器，<code>DefaultServeMux</code>是系统默认使用的路由器，如果<code>ListenAndServe</code>这个方法的第2个参数传入nil，系统就会默认使用<code>DefaultServeMux</code>。当然，这里也可以传入自定义的路由器。</p>
<p>先来看<code>http.HandleFunc(&quot;/&quot;, sayHello)</code>，从<code>HandleFunc</code>方法点进去，如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">HandleFunc</span><span style="color:#111">(</span><span style="color:#75af00">pattern</span> <span style="color:#00a8c8">string</span><span style="color:#111">,</span> <span style="color:#75af00">handler</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">ResponseWriter</span><span style="color:#111">,</span> <span style="color:#f92672">*</span><span style="color:#75af00">Request</span><span style="color:#111">))</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">DefaultServeMux</span><span style="color:#111">.</span><span style="color:#75af00">HandleFunc</span><span style="color:#111">(</span><span style="color:#75af00">pattern</span><span style="color:#111">,</span> <span style="color:#75af00">handler</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>在这里调用了<code>DefaultServeMux</code>的<code>HandleFunc</code>方法，这个方法有两个参数，<code>pattern</code>是匹配的路由规则，<code>handler</code>表示这个路由规则对应的处理方法，并且这个处理方法有两个参数。</p>
<p>在我们书写的代码示例中，<code>pattern</code>对应<code>/</code>，<code>handler</code>对应<code>sayHello</code>，当我们在浏览器中输入<code>http://localhost:9090</code>时，就会触发<code>sayHello</code>方法。</p>
<p>我们再顺着<code>DefaultServeMux</code>的<code>HandleFunc</code>方法继续点下去，如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">mux</span> <span style="color:#f92672">*</span><span style="color:#75af00">ServeMux</span><span style="color:#111">)</span> <span style="color:#75af00">HandleFunc</span><span style="color:#111">(</span><span style="color:#75af00">pattern</span> <span style="color:#00a8c8">string</span><span style="color:#111">,</span> <span style="color:#75af00">handler</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">ResponseWriter</span><span style="color:#111">,</span> <span style="color:#f92672">*</span><span style="color:#75af00">Request</span><span style="color:#111">))</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">Handle</span><span style="color:#111">(</span><span style="color:#75af00">pattern</span><span style="color:#111">,</span> <span style="color:#75af00">HandlerFunc</span><span style="color:#111">(</span><span style="color:#75af00">handler</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>在这个方法中，路由器又调用了<code>Handle</code>方法，注意这个<code>Handle</code>方法的第2个参数，将之前传入的<code>handler</code>这个响应方法强制转换成了<code>HandlerFunc</code>类型。</p>
<p>这个<code>HandlerFunc</code>类型到底是个什么呢？如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">HandlerFunc</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">ResponseWriter</span><span style="color:#111">,</span> <span style="color:#f92672">*</span><span style="color:#75af00">Request</span><span style="color:#111">)</span>
</span></span></code></pre></div><p>看来和我们定义的<code>SayHello</code>方法的类型都差不多。但是！！！
这个<code>HandlerFunc</code>默认实现了<code>ServeHTTP</code>接口！这样<code>HandlerFunc</code>对象就有了<code>ServeHTTP</code>方法！如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// ServeHTTP calls f(w, r).</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">f</span> <span style="color:#75af00">HandlerFunc</span><span style="color:#111">)</span> <span style="color:#75af00">ServeHTTP</span><span style="color:#111">(</span><span style="color:#75af00">w</span> <span style="color:#75af00">ResponseWriter</span><span style="color:#111">,</span> <span style="color:#75af00">r</span> <span style="color:#f92672">*</span><span style="color:#75af00">Request</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">f</span><span style="color:#111">(</span><span style="color:#75af00">w</span><span style="color:#111">,</span> <span style="color:#75af00">r</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>这个细节是十分重要的，因为这一步关乎到当路由规则匹配时，相应的响应方法是否会被调用的问题！这个方法的调用时机会在下一小节中讲到。</p>
<p>接下来，我们返回去继续看<code>mux</code>的<code>Handle</code>方法，也就是这段代码<code>mux.Handle(pattern, HandlerFunc(handler))</code>。这段代码做了哪些事呢？源码如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">mux</span> <span style="color:#f92672">*</span><span style="color:#75af00">ServeMux</span><span style="color:#111">)</span> <span style="color:#75af00">Handle</span><span style="color:#111">(</span><span style="color:#75af00">pattern</span> <span style="color:#00a8c8">string</span><span style="color:#111">,</span> <span style="color:#75af00">handler</span> <span style="color:#75af00">Handler</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">Lock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">defer</span> <span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">Unlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">pattern</span> <span style="color:#f92672">==</span> <span style="color:#d88200">&#34;&#34;</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#d88200">&#34;http: invalid pattern &#34;</span> <span style="color:#f92672">+</span> <span style="color:#75af00">pattern</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">handler</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#d88200">&#34;http: nil handler&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">m</span><span style="color:#111">[</span><span style="color:#75af00">pattern</span><span style="color:#111">].</span><span style="color:#75af00">explicit</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#d88200">&#34;http: multiple registrations for &#34;</span> <span style="color:#f92672">+</span> <span style="color:#75af00">pattern</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">m</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">m</span> <span style="color:#111">=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#00a8c8">string</span><span style="color:#111">]</span><span style="color:#75af00">muxEntry</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">m</span><span style="color:#111">[</span><span style="color:#75af00">pattern</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#75af00">muxEntry</span><span style="color:#111">{</span><span style="color:#75af00">explicit</span><span style="color:#111">:</span> <span style="color:#00a8c8">true</span><span style="color:#111">,</span> <span style="color:#75af00">h</span><span style="color:#111">:</span> <span style="color:#75af00">handler</span><span style="color:#111">,</span> <span style="color:#75af00">pattern</span><span style="color:#111">:</span> <span style="color:#75af00">pattern</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">pattern</span><span style="color:#111">[</span><span style="color:#ae81ff">0</span><span style="color:#111">]</span> <span style="color:#f92672">!=</span> <span style="color:#d88200">&#39;/&#39;</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">hosts</span> <span style="color:#111">=</span> <span style="color:#00a8c8">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Helpful behavior:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// If pattern is /tree/, insert an implicit permanent redirect for /tree.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// It can be overridden by an explicit registration.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">n</span> <span style="color:#f92672">:=</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">pattern</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">n</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">pattern</span><span style="color:#111">[</span><span style="color:#75af00">n</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">]</span> <span style="color:#f92672">==</span> <span style="color:#d88200">&#39;/&#39;</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#111">!</span><span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">m</span><span style="color:#111">[</span><span style="color:#75af00">pattern</span><span style="color:#111">[</span><span style="color:#ae81ff">0</span><span style="color:#111">:</span><span style="color:#75af00">n</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">]].</span><span style="color:#75af00">explicit</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// If pattern contains a host name, strip it and use remaining</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// path for redirect.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">path</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">pattern</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#75af00">pattern</span><span style="color:#111">[</span><span style="color:#ae81ff">0</span><span style="color:#111">]</span> <span style="color:#f92672">!=</span> <span style="color:#d88200">&#39;/&#39;</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// In pattern, at least the last character is a &#39;/&#39;, so</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// strings.Index can&#39;t be -1.</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75af00">path</span> <span style="color:#111">=</span> <span style="color:#75af00">pattern</span><span style="color:#111">[</span><span style="color:#75af00">strings</span><span style="color:#111">.</span><span style="color:#75af00">Index</span><span style="color:#111">(</span><span style="color:#75af00">pattern</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;/&#34;</span><span style="color:#111">):]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">url</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">url</span><span style="color:#111">.</span><span style="color:#75af00">URL</span><span style="color:#111">{</span><span style="color:#75af00">Path</span><span style="color:#111">:</span> <span style="color:#75af00">path</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">m</span><span style="color:#111">[</span><span style="color:#75af00">pattern</span><span style="color:#111">[</span><span style="color:#ae81ff">0</span><span style="color:#111">:</span><span style="color:#75af00">n</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">]]</span> <span style="color:#111">=</span> <span style="color:#75af00">muxEntry</span><span style="color:#111">{</span><span style="color:#75af00">h</span><span style="color:#111">:</span> <span style="color:#75af00">RedirectHandler</span><span style="color:#111">(</span><span style="color:#75af00">url</span><span style="color:#111">.</span><span style="color:#75af00">String</span><span style="color:#111">(),</span> <span style="color:#75af00">StatusMovedPermanently</span><span style="color:#111">),</span> <span style="color:#75af00">pattern</span><span style="color:#111">:</span> <span style="color:#75af00">pattern</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>代码挺多，其实主要就做了一件事，向<code>DefaultServeMux</code>的<code>map[string]muxEntry</code>中增加对应的路由规则和<code>handler</code>。</p>
<p><code>map[string]muxEntry</code>是个什么鬼？</p>
<ul>
<li><code>map</code>是一个字典对象，它保存的是<code>key-value</code>。</li>
<li><code>[string]</code>表示这个字典的<code>key</code>是<code>string</code>类型的，这个<code>key</code>值会保存我们的路由规则。</li>
<li><code>muxEntry</code>是一个实例对象，这个对象内保存了路由规则对应的处理方法。</li>
</ul>
<p>找到相应代码，如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">//路由器</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">ServeMux</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">mu</span>    <span style="color:#75af00">sync</span><span style="color:#111">.</span><span style="color:#75af00">RWMutex</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">m</span>     <span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#00a8c8">string</span><span style="color:#111">]</span><span style="color:#75af00">muxEntry</span> <span style="color:#75715e">//路由规则，一个string对应一个mux实例对象，map的key就是注册的路由表达式(string类型的)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">hosts</span> <span style="color:#00a8c8">bool</span> <span style="color:#75715e">// whether any patterns contain hostnames</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//muxEntry</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">muxEntry</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">explicit</span> <span style="color:#00a8c8">bool</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">h</span>        <span style="color:#75af00">Handler</span> <span style="color:#75715e">//这个路由表达式对应哪个handler</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">pattern</span>  <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//路由响应方法</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Handler</span> <span style="color:#00a8c8">interface</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">ServeHTTP</span><span style="color:#111">(</span><span style="color:#75af00">ResponseWriter</span><span style="color:#111">,</span> <span style="color:#f92672">*</span><span style="color:#75af00">Request</span><span style="color:#111">)</span>  <span style="color:#75715e">//handler的路由实现器</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p><code>ServeMux</code>就是这个系统默认的路由器。</p>
<p>最后，总结一下这个部分：</p>
<ol>
<li>调用<code>http.HandleFunc(&quot;/&quot;, sayHello)</code></li>
<li>调用<code>DefaultServeMux</code>的<code>HandleFunc()</code>，把我们定义的<code>sayHello()</code>包装成<code>HandlerFunc</code>类型</li>
<li>继续调用<code>DefaultServeMux</code>的<code>Handle()</code>，向<code>DefaultServeMux</code>的<code>map[string]muxEntry</code>中增加路由规则和对应的<code>handler</code></li>
</ol>
<p>OK，这部分代码做的事就这么多，第一部分结束。</p>
<p>第二部分主要就是研究这句代码<code>err := http.ListenAndServe(&quot;:9090&quot;,nil)</code>，也就是<code>ListenAndServe</code>这个方法。从这个方法点进去，如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">ListenAndServe</span><span style="color:#111">(</span><span style="color:#75af00">addr</span> <span style="color:#00a8c8">string</span><span style="color:#111">,</span> <span style="color:#75af00">handler</span> <span style="color:#75af00">Handler</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">server</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">Server</span><span style="color:#111">{</span><span style="color:#75af00">Addr</span><span style="color:#111">:</span> <span style="color:#75af00">addr</span><span style="color:#111">,</span> <span style="color:#75af00">Handler</span><span style="color:#111">:</span> <span style="color:#75af00">handler</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#75af00">server</span><span style="color:#111">.</span><span style="color:#75af00">ListenAndServe</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>在这个方法中，初始化了一个<code>server</code>对象，然后调用这个<code>server</code>对象的<code>ListenAndServe</code>方法，在这个方法中，如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">srv</span> <span style="color:#f92672">*</span><span style="color:#75af00">Server</span><span style="color:#111">)</span> <span style="color:#75af00">ListenAndServe</span><span style="color:#111">()</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">addr</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">srv</span><span style="color:#111">.</span><span style="color:#75af00">Addr</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">addr</span> <span style="color:#f92672">==</span> <span style="color:#d88200">&#34;&#34;</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">addr</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;:http&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">ln</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">net</span><span style="color:#111">.</span><span style="color:#75af00">Listen</span><span style="color:#111">(</span><span style="color:#d88200">&#34;tcp&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">addr</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#75af00">srv</span><span style="color:#111">.</span><span style="color:#75af00">Serve</span><span style="color:#111">(</span><span style="color:#75af00">tcpKeepAliveListener</span><span style="color:#111">{</span><span style="color:#75af00">ln</span><span style="color:#111">.(</span><span style="color:#f92672">*</span><span style="color:#75af00">net</span><span style="color:#111">.</span><span style="color:#75af00">TCPListener</span><span style="color:#111">)})</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>在这个方法中，调用了<code>net.Listen(&quot;tcp&quot;, addr)</code>，也就是底层用TCP协议搭建了一个服务，然后监控我们设置的端口。</p>
<p>代码的最后，调用了<code>srv</code>的<code>Serve</code>方法，如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">srv</span> <span style="color:#f92672">*</span><span style="color:#75af00">Server</span><span style="color:#111">)</span> <span style="color:#75af00">Serve</span><span style="color:#111">(</span><span style="color:#75af00">l</span> <span style="color:#75af00">net</span><span style="color:#111">.</span><span style="color:#75af00">Listener</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">defer</span> <span style="color:#75af00">l</span><span style="color:#111">.</span><span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">fn</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">testHookServerServe</span><span style="color:#111">;</span> <span style="color:#75af00">fn</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">fn</span><span style="color:#111">(</span><span style="color:#75af00">srv</span><span style="color:#111">,</span> <span style="color:#75af00">l</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">var</span> <span style="color:#75af00">tempDelay</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Duration</span> <span style="color:#75715e">// how long to sleep on accept failure</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">srv</span><span style="color:#111">.</span><span style="color:#75af00">setupHTTP2_Serve</span><span style="color:#111">();</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">srv</span><span style="color:#111">.</span><span style="color:#75af00">trackListener</span><span style="color:#111">(</span><span style="color:#75af00">l</span><span style="color:#111">,</span> <span style="color:#00a8c8">true</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">defer</span> <span style="color:#75af00">srv</span><span style="color:#111">.</span><span style="color:#75af00">trackListener</span><span style="color:#111">(</span><span style="color:#75af00">l</span><span style="color:#111">,</span> <span style="color:#00a8c8">false</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">baseCtx</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Background</span><span style="color:#111">()</span> <span style="color:#75715e">// base is always background, per Issue 16220</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">ctx</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">WithValue</span><span style="color:#111">(</span><span style="color:#75af00">baseCtx</span><span style="color:#111">,</span> <span style="color:#75af00">ServerContextKey</span><span style="color:#111">,</span> <span style="color:#75af00">srv</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">ctx</span> <span style="color:#111">=</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">WithValue</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">LocalAddrContextKey</span><span style="color:#111">,</span> <span style="color:#75af00">l</span><span style="color:#111">.</span><span style="color:#75af00">Addr</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">for</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">rw</span><span style="color:#111">,</span> <span style="color:#75af00">e</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">l</span><span style="color:#111">.</span><span style="color:#75af00">Accept</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#75af00">e</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">select</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#75af00">srv</span><span style="color:#111">.</span><span style="color:#75af00">getDoneChan</span><span style="color:#111">():</span>
</span></span><span style="display:flex;"><span>                <span style="color:#00a8c8">return</span> <span style="color:#75af00">ErrServerClosed</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">default</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">if</span> <span style="color:#75af00">ne</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">e</span><span style="color:#111">.(</span><span style="color:#75af00">net</span><span style="color:#111">.</span><span style="color:#75af00">Error</span><span style="color:#111">);</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">ne</span><span style="color:#111">.</span><span style="color:#75af00">Temporary</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#00a8c8">if</span> <span style="color:#75af00">tempDelay</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#75af00">tempDelay</span> <span style="color:#111">=</span> <span style="color:#ae81ff">5</span> <span style="color:#f92672">*</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Millisecond</span>
</span></span><span style="display:flex;"><span>                <span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#75af00">tempDelay</span> <span style="color:#f92672">*=</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>                <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#00a8c8">if</span> <span style="color:#75af00">max</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">*</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Second</span><span style="color:#111">;</span> <span style="color:#75af00">tempDelay</span> <span style="color:#111">&gt;</span> <span style="color:#75af00">max</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#75af00">tempDelay</span> <span style="color:#111">=</span> <span style="color:#75af00">max</span>
</span></span><span style="display:flex;"><span>                <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75af00">srv</span><span style="color:#111">.</span><span style="color:#75af00">logf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;http: Accept error: %v; retrying in %v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">e</span><span style="color:#111">,</span> <span style="color:#75af00">tempDelay</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Sleep</span><span style="color:#111">(</span><span style="color:#75af00">tempDelay</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#00a8c8">continue</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">return</span> <span style="color:#75af00">e</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">tempDelay</span> <span style="color:#111">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">c</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">srv</span><span style="color:#111">.</span><span style="color:#75af00">newConn</span><span style="color:#111">(</span><span style="color:#75af00">rw</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">setState</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">rwc</span><span style="color:#111">,</span> <span style="color:#75af00">StateNew</span><span style="color:#111">)</span> <span style="color:#75715e">// before Serve can return</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">go</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">serve</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>最后3段代码比较重要，也是Go语言支持高并发的体现，如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">c</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">srv</span><span style="color:#111">.</span><span style="color:#75af00">newConn</span><span style="color:#111">(</span><span style="color:#75af00">rw</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">setState</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">rwc</span><span style="color:#111">,</span> <span style="color:#75af00">StateNew</span><span style="color:#111">)</span> <span style="color:#75715e">// before Serve can return</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">go</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">serve</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">)</span>
</span></span></code></pre></div><p>上面那一大坨代码，总体意思是进入方法后，首先开了一个<code>for</code>循环，在<code>for</code>循环内时刻Accept请求，请求来了之后，会为每个请求创建一个<code>Conn</code>，然后单独开启一个<code>goroutine</code>，把这个请求的数据当做参数扔给这个<code>Conn</code>去服务：<code>go c.serve()</code>。用户的每一次请求都是在一个新的<code>goroutine</code>去服务，每个请求间相互不影响。</p>
<p>在<code>conn</code>的<code>serve</code>方法中，有一句代码很重要，如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">serverHandler</span><span style="color:#111">{</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">server</span><span style="color:#111">}.</span><span style="color:#75af00">ServeHTTP</span><span style="color:#111">(</span><span style="color:#75af00">w</span><span style="color:#111">,</span> <span style="color:#75af00">w</span><span style="color:#111">.</span><span style="color:#75af00">req</span><span style="color:#111">)</span>
</span></span></code></pre></div><p>表示<code>serverHandler</code>也实现了<code>ServeHTTP</code>接口，<code>ServeHTTP</code>方法实现如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">sh</span> <span style="color:#75af00">serverHandler</span><span style="color:#111">)</span> <span style="color:#75af00">ServeHTTP</span><span style="color:#111">(</span><span style="color:#75af00">rw</span> <span style="color:#75af00">ResponseWriter</span><span style="color:#111">,</span> <span style="color:#75af00">req</span> <span style="color:#f92672">*</span><span style="color:#75af00">Request</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">handler</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">sh</span><span style="color:#111">.</span><span style="color:#75af00">srv</span><span style="color:#111">.</span><span style="color:#75af00">Handler</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">handler</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">handler</span> <span style="color:#111">=</span> <span style="color:#75af00">DefaultServeMux</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">req</span><span style="color:#111">.</span><span style="color:#75af00">RequestURI</span> <span style="color:#f92672">==</span> <span style="color:#d88200">&#34;*&#34;</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">req</span><span style="color:#111">.</span><span style="color:#75af00">Method</span> <span style="color:#f92672">==</span> <span style="color:#d88200">&#34;OPTIONS&#34;</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">handler</span> <span style="color:#111">=</span> <span style="color:#75af00">globalOptionsHandler</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">handler</span><span style="color:#111">.</span><span style="color:#75af00">ServeHTTP</span><span style="color:#111">(</span><span style="color:#75af00">rw</span><span style="color:#111">,</span> <span style="color:#75af00">req</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>在这里如果<code>handler</code>为空（这个<code>handler</code>就可以理解为是我们自定义的路由器），就会使用系统默认的<code>DefaultServeMux</code>，代码的最后调用了<code>DefaultServeMux</code>的<code>ServeHTTP()</code></p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">mux</span> <span style="color:#f92672">*</span><span style="color:#75af00">ServeMux</span><span style="color:#111">)</span> <span style="color:#75af00">ServeHTTP</span><span style="color:#111">(</span><span style="color:#75af00">w</span> <span style="color:#75af00">ResponseWriter</span><span style="color:#111">,</span> <span style="color:#75af00">r</span> <span style="color:#f92672">*</span><span style="color:#75af00">Request</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">RequestURI</span> <span style="color:#f92672">==</span> <span style="color:#d88200">&#34;*&#34;</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">ProtoAtLeast</span><span style="color:#111">(</span><span style="color:#ae81ff">1</span><span style="color:#111">,</span> <span style="color:#ae81ff">1</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75af00">w</span><span style="color:#111">.</span><span style="color:#75af00">Header</span><span style="color:#111">().</span><span style="color:#75af00">Set</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Connection&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;close&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">w</span><span style="color:#111">.</span><span style="color:#75af00">WriteHeader</span><span style="color:#111">(</span><span style="color:#75af00">StatusBadRequest</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">h</span><span style="color:#111">,</span> <span style="color:#75af00">_</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">Handler</span><span style="color:#111">(</span><span style="color:#75af00">r</span><span style="color:#111">)</span>  <span style="color:#75715e">//这里返回的h是Handler接口对象</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">ServeHTTP</span><span style="color:#111">(</span><span style="color:#75af00">w</span><span style="color:#111">,</span> <span style="color:#75af00">r</span><span style="color:#111">)</span>       <span style="color:#75715e">//调用Handler接口对象的ServeHTTP方法实际上就调用了我们定义的sayHello方法</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>路由器接收到请求之后，如果是<code>*</code>那么关闭链接，如果不是<code>*</code>就调用<code>mux.Handler(r)</code>返回该路由对应的处理<code>Handler</code>，然后执行该<code>handler</code>的<code>ServeHTTP</code>方法，也就是这句代码<code>h.ServeHTTP(w, r)</code>，<code>mux.Handler(r)</code>做了什么呢？如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">mux</span> <span style="color:#f92672">*</span><span style="color:#75af00">ServeMux</span><span style="color:#111">)</span> <span style="color:#75af00">Handler</span><span style="color:#111">(</span><span style="color:#75af00">r</span> <span style="color:#f92672">*</span><span style="color:#75af00">Request</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#75af00">h</span> <span style="color:#75af00">Handler</span><span style="color:#111">,</span> <span style="color:#75af00">pattern</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">Method</span> <span style="color:#f92672">!=</span> <span style="color:#d88200">&#34;CONNECT&#34;</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#75af00">p</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">cleanPath</span><span style="color:#111">(</span><span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">URL</span><span style="color:#111">.</span><span style="color:#75af00">Path</span><span style="color:#111">);</span> <span style="color:#75af00">p</span> <span style="color:#f92672">!=</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">URL</span><span style="color:#111">.</span><span style="color:#75af00">Path</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">pattern</span> <span style="color:#111">=</span> <span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">handler</span><span style="color:#111">(</span><span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">Host</span><span style="color:#111">,</span> <span style="color:#75af00">p</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75af00">url</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">*</span><span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">URL</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75af00">url</span><span style="color:#111">.</span><span style="color:#75af00">Path</span> <span style="color:#111">=</span> <span style="color:#75af00">p</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">return</span> <span style="color:#75af00">RedirectHandler</span><span style="color:#111">(</span><span style="color:#75af00">url</span><span style="color:#111">.</span><span style="color:#75af00">String</span><span style="color:#111">(),</span> <span style="color:#75af00">StatusMovedPermanently</span><span style="color:#111">),</span> <span style="color:#75af00">pattern</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">handler</span><span style="color:#111">(</span><span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">Host</span><span style="color:#111">,</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">URL</span><span style="color:#111">.</span><span style="color:#75af00">Path</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">mux</span> <span style="color:#f92672">*</span><span style="color:#75af00">ServeMux</span><span style="color:#111">)</span> <span style="color:#75af00">handler</span><span style="color:#111">(</span><span style="color:#75af00">host</span><span style="color:#111">,</span> <span style="color:#75af00">path</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#75af00">h</span> <span style="color:#75af00">Handler</span><span style="color:#111">,</span> <span style="color:#75af00">pattern</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">RLock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">defer</span> <span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">RUnlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Host-specific pattern takes precedence over generic ones</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">hosts</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">h</span><span style="color:#111">,</span> <span style="color:#75af00">pattern</span> <span style="color:#111">=</span> <span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">match</span><span style="color:#111">(</span><span style="color:#75af00">host</span> <span style="color:#f92672">+</span> <span style="color:#75af00">path</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">h</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">h</span><span style="color:#111">,</span> <span style="color:#75af00">pattern</span> <span style="color:#111">=</span> <span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">match</span><span style="color:#111">(</span><span style="color:#75af00">path</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">h</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">h</span><span style="color:#111">,</span> <span style="color:#75af00">pattern</span> <span style="color:#111">=</span> <span style="color:#75af00">NotFoundHandler</span><span style="color:#111">(),</span> <span style="color:#d88200">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">mux</span> <span style="color:#f92672">*</span><span style="color:#75af00">ServeMux</span><span style="color:#111">)</span> <span style="color:#75af00">match</span><span style="color:#111">(</span><span style="color:#75af00">path</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#75af00">h</span> <span style="color:#75af00">Handler</span><span style="color:#111">,</span> <span style="color:#75af00">pattern</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">var</span> <span style="color:#75af00">n</span> <span style="color:#111">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">for</span> <span style="color:#75af00">k</span><span style="color:#111">,</span> <span style="color:#75af00">v</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">m</span> <span style="color:#111">{</span>  <span style="color:#75715e">//mux.m就是系统默认路由的map</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">pathMatch</span><span style="color:#111">(</span><span style="color:#75af00">k</span><span style="color:#111">,</span> <span style="color:#75af00">path</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">continue</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#75af00">h</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#f92672">||</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">k</span><span style="color:#111">)</span> <span style="color:#111">&gt;</span> <span style="color:#75af00">n</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75af00">n</span> <span style="color:#111">=</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">k</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75af00">h</span> <span style="color:#111">=</span> <span style="color:#75af00">v</span><span style="color:#111">.</span><span style="color:#75af00">h</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75af00">pattern</span> <span style="color:#111">=</span> <span style="color:#75af00">v</span><span style="color:#111">.</span><span style="color:#75af00">pattern</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>它会根据用户请求的<code>URL</code>到路由器里面存储的<code>map</code>中匹配，匹配成功就会返回存储的<code>handler</code>，调用这个<code>handler</code>的<code>ServeHTTP()</code>就可以执行到相应的处理方法了，这个处理方法实际上就是我们刚开始定义的<code>sayHello()</code>，只不过这个<code>sayHello()</code>被<code>HandlerFunc</code>又包了一层，因为<code>HandlerFunc</code>实现了<code>ServeHTTP</code>接口，所以在调用<code>HandlerFunc</code>对象的<code>ServeHTTP()</code>时，实际上在<code>ServeHTTP ()</code>的内部调用了我们的<code>sayHello()</code>。</p>
<p>总结一下：</p>
<ol>
<li>调用<code>http.ListenAndServe(&quot;:9090&quot;,nil)</code></li>
<li>实例化<code>server</code></li>
<li>调用<code>server</code>的<code>ListenAndServe()</code></li>
<li>调用<code>server</code>的<code>Serve</code>方法，开启<code>for</code>循环，在循环中Accept请求</li>
<li>对每一个请求实例化一个<code>Conn</code>，并且开启一个<code>goroutine</code>为这个请求进行服务<code>go c.serve()</code></li>
<li>读取每个请求的内容<code>c.readRequest()</code></li>
<li>调用<code>serverHandler</code>的<code>ServeHTTP()</code>，如果<code>handler</code>为空，就把<code>handler</code>设置为系统默认的路由器<code>DefaultServeMux</code></li>
<li>调用<code>handler</code>的<code>ServeHTTP()</code> =&gt;实际上是调用了<code>DefaultServeMux</code>的<code>ServeHTTP()</code></li>
<li>在<code>ServeHTTP()</code>中会调用路由对应处理<code>handler</code></li>
<li>在路由对应处理<code>handler</code>中会执行<code>sayHello()</code></li>
</ol>
<p>有一个需要注意的点：
<code>DefaultServeMux</code>和路由对应的处理方法<code>handler</code>都实现了<code>ServeHTTP</code>接口，他们俩都有<code>ServeHTTP</code>方法，但是方法要达到的目的不同，在<code>DefaultServeMux</code>的<code>ServeHttp()</code>里会执行路由对应的处理<code>handler</code>的<code>ServeHttp()</code>。</p>
<h2 id="文章转自">文章转自</h2>
<p><a href="https://juejin.cn/post/6844903550993039374">https://juejin.cn/post/6844903550993039374</a></p>
]]></content:encoded><category>go</category><category>go</category><category>源码分析</category></item><item><title>golang sqlx</title><link>https://daemon365.dev/post/go/golang_sqlx/</link><pubDate>Mon, 13 Jan 2020 00:00:00 +0800</pubDate><guid>https://daemon365.dev/post/go/golang_sqlx/</guid><description>&lt;p&gt;在项目中我们通常可能会使用&lt;code&gt;database/sql&lt;/code&gt;连接MySQL数据库。本文借助使用&lt;code&gt;sqlx&lt;/code&gt;实现批量插入数据的例子，介绍了&lt;code&gt;sqlx&lt;/code&gt;中可能被你忽视了的&lt;code&gt;sqlx.In&lt;/code&gt;和&lt;code&gt;DB.NamedExec&lt;/code&gt;方法。&lt;/p&gt;
&lt;h2 id="sqlx介绍"&gt;sqlx介绍&lt;/h2&gt;
&lt;p&gt;在项目中我们通常可能会使用&lt;code&gt;database/sql&lt;/code&gt;连接MySQL数据库。&lt;code&gt;sqlx&lt;/code&gt;可以认为是Go语言内置&lt;code&gt;database/sql&lt;/code&gt;的超集，它在优秀的内置&lt;code&gt;database/sql&lt;/code&gt;基础上提供了一组扩展。这些扩展中除了大家常用来查询的&lt;code&gt;Get(dest interface{}, ...) error&lt;/code&gt;和&lt;code&gt;Select(dest interface{}, ...) error&lt;/code&gt;外还有很多其他强大的功能。&lt;/p&gt;
&lt;h2 id="安装sqlx"&gt;安装sqlx&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;go&lt;/span&gt; &lt;span style="color:#75af00"&gt;get&lt;/span&gt; &lt;span style="color:#75af00"&gt;github&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;com&lt;/span&gt;&lt;span style="color:#f92672"&gt;/&lt;/span&gt;&lt;span style="color:#75af00"&gt;jmoiron&lt;/span&gt;&lt;span style="color:#f92672"&gt;/&lt;/span&gt;&lt;span style="color:#75af00"&gt;sqlx&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id="基本使用"&gt;基本使用&lt;/h2&gt;
&lt;h3 id="连接数据库"&gt;连接数据库&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;var&lt;/span&gt; &lt;span style="color:#75af00"&gt;db&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;sqlx&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;DB&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;initDB&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;error&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;dsn&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;user:password@tcp(127.0.0.1:3306)/sql_test?charset=utf8mb4&amp;amp;parseTime=True&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// 也可以使用MustConnect连接不成功就panic&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;db&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#75af00"&gt;sqlx&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Connect&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;mysql&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;dsn&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;!=&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Printf&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;connect DB failed, err:%v\n&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;db&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;SetMaxOpenConns&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;20&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;db&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;SetMaxIdleConns&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;10&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id="查询"&gt;查询&lt;/h3&gt;
&lt;p&gt;查询单行数据示例代码如下：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;// 查询单条数据示例&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;queryRowDemo&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;sqlStr&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;select id, name, age from user where id=?&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;var&lt;/span&gt; &lt;span style="color:#75af00"&gt;u&lt;/span&gt; &lt;span style="color:#75af00"&gt;user&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;db&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Get&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#f92672"&gt;&amp;amp;&lt;/span&gt;&lt;span style="color:#75af00"&gt;u&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;sqlStr&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;1&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;!=&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Printf&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;get failed, err:%v\n&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Printf&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;id:%d name:%s age:%d\n&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;u&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;ID&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;u&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Name&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;u&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Age&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;查询多行数据示例代码如下：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;// 查询多条数据示例&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;queryMultiRowDemo&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;sqlStr&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;select id, name, age from user where id &amp;gt; ?&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;var&lt;/span&gt; &lt;span style="color:#75af00"&gt;users&lt;/span&gt; &lt;span style="color:#111"&gt;[]&lt;/span&gt;&lt;span style="color:#75af00"&gt;user&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;db&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Select&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#f92672"&gt;&amp;amp;&lt;/span&gt;&lt;span style="color:#75af00"&gt;users&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;sqlStr&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;0&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;!=&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Printf&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;query failed, err:%v\n&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Printf&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;users:%#v\n&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;users&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id="插入更新和删除"&gt;插入、更新和删除&lt;/h3&gt;
&lt;p&gt;sqlx中的exec方法与原生sql中的exec使用基本一致：&lt;/p&gt;</description><content:encoded><![CDATA[<p>在项目中我们通常可能会使用<code>database/sql</code>连接MySQL数据库。本文借助使用<code>sqlx</code>实现批量插入数据的例子，介绍了<code>sqlx</code>中可能被你忽视了的<code>sqlx.In</code>和<code>DB.NamedExec</code>方法。</p>
<h2 id="sqlx介绍">sqlx介绍</h2>
<p>在项目中我们通常可能会使用<code>database/sql</code>连接MySQL数据库。<code>sqlx</code>可以认为是Go语言内置<code>database/sql</code>的超集，它在优秀的内置<code>database/sql</code>基础上提供了一组扩展。这些扩展中除了大家常用来查询的<code>Get(dest interface{}, ...) error</code>和<code>Select(dest interface{}, ...) error</code>外还有很多其他强大的功能。</p>
<h2 id="安装sqlx">安装sqlx</h2>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">go</span> <span style="color:#75af00">get</span> <span style="color:#75af00">github</span><span style="color:#111">.</span><span style="color:#75af00">com</span><span style="color:#f92672">/</span><span style="color:#75af00">jmoiron</span><span style="color:#f92672">/</span><span style="color:#75af00">sqlx</span>
</span></span></code></pre></div><h2 id="基本使用">基本使用</h2>
<h3 id="连接数据库">连接数据库</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">var</span> <span style="color:#75af00">db</span> <span style="color:#f92672">*</span><span style="color:#75af00">sqlx</span><span style="color:#111">.</span><span style="color:#75af00">DB</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">initDB</span><span style="color:#111">()</span> <span style="color:#111">(</span><span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">dsn</span> <span style="color:#f92672">:=</span> <span style="color:#d88200">&#34;user:password@tcp(127.0.0.1:3306)/sql_test?charset=utf8mb4&amp;parseTime=True&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 也可以使用MustConnect连接不成功就panic</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">db</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">sqlx</span><span style="color:#111">.</span><span style="color:#75af00">Connect</span><span style="color:#111">(</span><span style="color:#d88200">&#34;mysql&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">dsn</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;connect DB failed, err:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">SetMaxOpenConns</span><span style="color:#111">(</span><span style="color:#ae81ff">20</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">SetMaxIdleConns</span><span style="color:#111">(</span><span style="color:#ae81ff">10</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="查询">查询</h3>
<p>查询单行数据示例代码如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// 查询单条数据示例</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">queryRowDemo</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">sqlStr</span> <span style="color:#f92672">:=</span> <span style="color:#d88200">&#34;select id, name, age from user where id=?&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">var</span> <span style="color:#75af00">u</span> <span style="color:#75af00">user</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">Get</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">u</span><span style="color:#111">,</span> <span style="color:#75af00">sqlStr</span><span style="color:#111">,</span> <span style="color:#ae81ff">1</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;get failed, err:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;id:%d name:%s age:%d\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">u</span><span style="color:#111">.</span><span style="color:#75af00">ID</span><span style="color:#111">,</span> <span style="color:#75af00">u</span><span style="color:#111">.</span><span style="color:#75af00">Name</span><span style="color:#111">,</span> <span style="color:#75af00">u</span><span style="color:#111">.</span><span style="color:#75af00">Age</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>查询多行数据示例代码如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// 查询多条数据示例</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">queryMultiRowDemo</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">sqlStr</span> <span style="color:#f92672">:=</span> <span style="color:#d88200">&#34;select id, name, age from user where id &gt; ?&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">var</span> <span style="color:#75af00">users</span> <span style="color:#111">[]</span><span style="color:#75af00">user</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">Select</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">users</span><span style="color:#111">,</span> <span style="color:#75af00">sqlStr</span><span style="color:#111">,</span> <span style="color:#ae81ff">0</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;query failed, err:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;users:%#v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">users</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="插入更新和删除">插入、更新和删除</h3>
<p>sqlx中的exec方法与原生sql中的exec使用基本一致：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// 插入数据</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">insertRowDemo</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">sqlStr</span> <span style="color:#f92672">:=</span> <span style="color:#d88200">&#34;insert into user(name, age) values (?,?)&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ret</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">Exec</span><span style="color:#111">(</span><span style="color:#75af00">sqlStr</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;沙河小王子&#34;</span><span style="color:#111">,</span> <span style="color:#ae81ff">19</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;insert failed, err:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">theID</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">ret</span><span style="color:#111">.</span><span style="color:#75af00">LastInsertId</span><span style="color:#111">()</span> <span style="color:#75715e">// 新插入数据的id</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;get lastinsert ID failed, err:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;insert success, the id is %d.\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">theID</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 更新数据</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">updateRowDemo</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">sqlStr</span> <span style="color:#f92672">:=</span> <span style="color:#d88200">&#34;update user set age=? where id = ?&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ret</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">Exec</span><span style="color:#111">(</span><span style="color:#75af00">sqlStr</span><span style="color:#111">,</span> <span style="color:#ae81ff">39</span><span style="color:#111">,</span> <span style="color:#ae81ff">6</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;update failed, err:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">n</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">ret</span><span style="color:#111">.</span><span style="color:#75af00">RowsAffected</span><span style="color:#111">()</span> <span style="color:#75715e">// 操作影响的行数</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;get RowsAffected failed, err:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;update success, affected rows:%d\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">n</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 删除数据</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">deleteRowDemo</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">sqlStr</span> <span style="color:#f92672">:=</span> <span style="color:#d88200">&#34;delete from user where id = ?&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ret</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">Exec</span><span style="color:#111">(</span><span style="color:#75af00">sqlStr</span><span style="color:#111">,</span> <span style="color:#ae81ff">6</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;delete failed, err:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">n</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">ret</span><span style="color:#111">.</span><span style="color:#75af00">RowsAffected</span><span style="color:#111">()</span> <span style="color:#75715e">// 操作影响的行数</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;get RowsAffected failed, err:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;delete success, affected rows:%d\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">n</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="namedexec">NamedExec</h3>
<p><code>DB.NamedExec</code>方法用来绑定SQL语句与结构体或map中的同名字段。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">insertUserDemo</span><span style="color:#111">()(</span><span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span><span style="color:#111">){</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">sqlStr</span> <span style="color:#f92672">:=</span> <span style="color:#d88200">&#34;INSERT INTO user (name,age) VALUES (:name,:age)&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">NamedExec</span><span style="color:#111">(</span><span style="color:#75af00">sqlStr</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#00a8c8">string</span><span style="color:#111">]</span><span style="color:#00a8c8">interface</span><span style="color:#111">{}{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#d88200">&#34;name&#34;</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;七米&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#d88200">&#34;age&#34;</span><span style="color:#111">:</span> <span style="color:#ae81ff">28</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="namedquery">NamedQuery</h3>
<p>与<code>DB.NamedExec</code>同理，这里是支持查询。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">namedQuery</span><span style="color:#111">(){</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">sqlStr</span> <span style="color:#f92672">:=</span> <span style="color:#d88200">&#34;SELECT * FROM user WHERE name=:name&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 使用map做命名查询</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">rows</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">NamedQuery</span><span style="color:#111">(</span><span style="color:#75af00">sqlStr</span><span style="color:#111">,</span> <span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#00a8c8">string</span><span style="color:#111">]</span><span style="color:#00a8c8">interface</span><span style="color:#111">{}{</span><span style="color:#d88200">&#34;name&#34;</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;七米&#34;</span><span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;db.NamedQuery failed, err:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">rows</span><span style="color:#111">.</span><span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">rows</span><span style="color:#111">.</span><span style="color:#75af00">Next</span><span style="color:#111">(){</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">var</span> <span style="color:#75af00">u</span> <span style="color:#75af00">user</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">rows</span><span style="color:#111">.</span><span style="color:#75af00">StructScan</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">u</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;scan failed, err:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">continue</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;user:%#v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">u</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">u</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">user</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">Name</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;七米&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 使用结构体命名查询，根据结构体字段的 db tag进行映射</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">rows</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">NamedQuery</span><span style="color:#111">(</span><span style="color:#75af00">sqlStr</span><span style="color:#111">,</span> <span style="color:#75af00">u</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;db.NamedQuery failed, err:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">rows</span><span style="color:#111">.</span><span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">rows</span><span style="color:#111">.</span><span style="color:#75af00">Next</span><span style="color:#111">(){</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">var</span> <span style="color:#75af00">u</span> <span style="color:#75af00">user</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">rows</span><span style="color:#111">.</span><span style="color:#75af00">StructScan</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">u</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;scan failed, err:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">continue</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;user:%#v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">u</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="事务操作">事务操作</h3>
<p>对于事务操作，我们可以使用<code>sqlx</code>中提供的<code>db.Beginx()</code>和<code>tx.Exec()</code>方法。示例代码如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">transactionDemo2</span><span style="color:#111">()(</span><span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">tx</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">Beginx</span><span style="color:#111">()</span> <span style="color:#75715e">// 开启事务</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;begin trans failed, err:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">p</span> <span style="color:#f92672">:=</span> <span style="color:#111">recover</span><span style="color:#111">();</span> <span style="color:#75af00">p</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">Rollback</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#75af00">p</span><span style="color:#111">)</span> <span style="color:#75715e">// re-throw panic after Rollback</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;rollback&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">Rollback</span><span style="color:#111">()</span> <span style="color:#75715e">// err is non-nil; don&#39;t change it</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">Commit</span><span style="color:#111">()</span> <span style="color:#75715e">// err is nil; if Commit returns error update err</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;commit&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">sqlStr1</span> <span style="color:#f92672">:=</span> <span style="color:#d88200">&#34;Update user set age=20 where id=?&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">rs</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">Exec</span><span style="color:#111">(</span><span style="color:#75af00">sqlStr1</span><span style="color:#111">,</span> <span style="color:#ae81ff">1</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span><span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">n</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">rs</span><span style="color:#111">.</span><span style="color:#75af00">RowsAffected</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">n</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">1</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">errors</span><span style="color:#111">.</span><span style="color:#75af00">New</span><span style="color:#111">(</span><span style="color:#d88200">&#34;exec sqlStr1 failed&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">sqlStr2</span> <span style="color:#f92672">:=</span> <span style="color:#d88200">&#34;Update user set age=50 where i=?&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">rs</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">Exec</span><span style="color:#111">(</span><span style="color:#75af00">sqlStr2</span><span style="color:#111">,</span> <span style="color:#ae81ff">5</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span><span style="color:#f92672">!=</span><span style="color:#00a8c8">nil</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">n</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">rs</span><span style="color:#111">.</span><span style="color:#75af00">RowsAffected</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">n</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">1</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">errors</span><span style="color:#111">.</span><span style="color:#75af00">New</span><span style="color:#111">(</span><span style="color:#d88200">&#34;exec sqlStr1 failed&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="sqlxin">sqlx.In</h2>
<p><code>sqlx.In</code>是<code>sqlx</code>提供的一个非常方便的函数。</p>
<h3 id="sqlxin的批量插入示例">sqlx.In的批量插入示例</h3>
<h4 id="表结构">表结构</h4>
<p>为了方便演示插入数据操作，这里创建一个<code>user</code>表，表结构如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#00a8c8">CREATE</span> <span style="color:#00a8c8">TABLE</span> <span style="color:#f92672">`</span><span style="color:#00a8c8">user</span><span style="color:#f92672">`</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">`</span><span style="color:#111">id</span><span style="color:#f92672">`</span> <span style="color:#111">BIGINT</span><span style="color:#111">(</span><span style="color:#ae81ff">20</span><span style="color:#111">)</span> <span style="color:#00a8c8">NOT</span> <span style="color:#00a8c8">NULL</span> <span style="color:#111">AUTO_INCREMENT</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">`</span><span style="color:#111">name</span><span style="color:#f92672">`</span> <span style="color:#111">VARCHAR</span><span style="color:#111">(</span><span style="color:#ae81ff">20</span><span style="color:#111">)</span> <span style="color:#00a8c8">DEFAULT</span> <span style="color:#d88200">&#39;&#39;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">`</span><span style="color:#111">age</span><span style="color:#f92672">`</span> <span style="color:#111">INT</span><span style="color:#111">(</span><span style="color:#ae81ff">11</span><span style="color:#111">)</span> <span style="color:#00a8c8">DEFAULT</span> <span style="color:#d88200">&#39;0&#39;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">PRIMARY</span> <span style="color:#00a8c8">KEY</span><span style="color:#111">(</span><span style="color:#f92672">`</span><span style="color:#111">id</span><span style="color:#f92672">`</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span><span style="color:#111">ENGINE</span><span style="color:#f92672">=</span><span style="color:#111">InnoDB</span> <span style="color:#111">AUTO_INCREMENT</span><span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> <span style="color:#00a8c8">DEFAULT</span> <span style="color:#111">CHARSET</span><span style="color:#f92672">=</span><span style="color:#111">utf8mb4</span><span style="color:#111">;</span>
</span></span></code></pre></div><h4 id="结构体">结构体</h4>
<p>定义一个<code>user</code>结构体，字段通过tag与数据库中user表的列一致。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">User</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Name</span> <span style="color:#00a8c8">string</span> <span style="color:#d88200">`db:&#34;name&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Age</span>  <span style="color:#00a8c8">int</span>    <span style="color:#d88200">`db:&#34;age&#34;`</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h4 id="bindvars绑定变量">bindvars（绑定变量）</h4>
<p>查询占位符<code>?</code>在内部称为<strong>bindvars（查询占位符）</strong>,它非常重要。你应该始终使用它们向数据库发送值，因为它们可以防止SQL注入攻击。<code>database/sql</code>不尝试对查询文本进行任何验证；它与编码的参数一起按原样发送到服务器。除非驱动程序实现一个特殊的接口，否则在执行之前，查询是在服务器上准备的。因此<code>bindvars</code>是特定于数据库的:</p>
<ul>
<li>MySQL中使用<code>?</code></li>
<li>PostgreSQL使用枚举的<code>$1</code>、<code>$2</code>等bindvar语法</li>
<li>SQLite中<code>?</code>和<code>$1</code>的语法都支持</li>
<li>Oracle中使用<code>:name</code>的语法</li>
</ul>
<p><code>bindvars</code>的一个常见误解是，它们用来在sql语句中插入值。它们其实仅用于参数化，不允许更改SQL语句的结构。例如，使用<code>bindvars</code>尝试参数化列或表名将不起作用：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// ？不能用来插入表名（做SQL语句中表名的占位符）</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">Query</span><span style="color:#111">(</span><span style="color:#d88200">&#34;SELECT * FROM ?&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;mytable&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#75715e">// ？也不能用来插入列名（做SQL语句中列名的占位符）</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">Query</span><span style="color:#111">(</span><span style="color:#d88200">&#34;SELECT ?, ? FROM people&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;name&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;location&#34;</span><span style="color:#111">)</span>
</span></span></code></pre></div><h4 id="自己拼接语句实现批量插入">自己拼接语句实现批量插入</h4>
<p>比较笨，但是很好理解。就是有多少个User就拼接多少个<code>(?, ?)</code>。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// BatchInsertUsers 自行构造批量插入的语句</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">BatchInsertUsers</span><span style="color:#111">(</span><span style="color:#75af00">users</span> <span style="color:#111">[]</span><span style="color:#f92672">*</span><span style="color:#75af00">User</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 存放 (?, ?) 的slice</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">valueStrings</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">([]</span><span style="color:#00a8c8">string</span><span style="color:#111">,</span> <span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">users</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 存放values的slice</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">valueArgs</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">([]</span><span style="color:#00a8c8">interface</span><span style="color:#111">{},</span> <span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">users</span><span style="color:#111">)</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">2</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 遍历users准备相关数据</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">u</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">users</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 此处占位符要与插入值的个数对应</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">valueStrings</span> <span style="color:#111">=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">valueStrings</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;(?, ?)&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">valueArgs</span> <span style="color:#111">=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">valueArgs</span><span style="color:#111">,</span> <span style="color:#75af00">u</span><span style="color:#111">.</span><span style="color:#75af00">Name</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">valueArgs</span> <span style="color:#111">=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">valueArgs</span><span style="color:#111">,</span> <span style="color:#75af00">u</span><span style="color:#111">.</span><span style="color:#75af00">Age</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 自行拼接要执行的具体语句</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">stmt</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Sprintf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;INSERT INTO user (name, age) VALUES %s&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">strings</span><span style="color:#111">.</span><span style="color:#75af00">Join</span><span style="color:#111">(</span><span style="color:#75af00">valueStrings</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;,&#34;</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">DB</span><span style="color:#111">.</span><span style="color:#75af00">Exec</span><span style="color:#111">(</span><span style="color:#75af00">stmt</span><span style="color:#111">,</span> <span style="color:#75af00">valueArgs</span><span style="color:#f92672">...</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h4 id="使用sqlxin实现批量插入">使用sqlx.In实现批量插入</h4>
<p>前提是需要我们的结构体实现<code>driver.Valuer</code>接口：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">u</span> <span style="color:#75af00">User</span><span style="color:#111">)</span> <span style="color:#75af00">Value</span><span style="color:#111">()</span> <span style="color:#111">(</span><span style="color:#75af00">driver</span><span style="color:#111">.</span><span style="color:#75af00">Value</span><span style="color:#111">,</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#111">[]</span><span style="color:#00a8c8">interface</span><span style="color:#111">{}{</span><span style="color:#75af00">u</span><span style="color:#111">.</span><span style="color:#75af00">Name</span><span style="color:#111">,</span> <span style="color:#75af00">u</span><span style="color:#111">.</span><span style="color:#75af00">Age</span><span style="color:#111">},</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>使用<code>sqlx.In</code>实现批量插入代码如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// BatchInsertUsers2 使用sqlx.In帮我们拼接语句和参数, 注意传入的参数是[]interface{}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">BatchInsertUsers2</span><span style="color:#111">(</span><span style="color:#75af00">users</span> <span style="color:#111">[]</span><span style="color:#00a8c8">interface</span><span style="color:#111">{})</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">query</span><span style="color:#111">,</span> <span style="color:#75af00">args</span><span style="color:#111">,</span> <span style="color:#75af00">_</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">sqlx</span><span style="color:#111">.</span><span style="color:#75af00">In</span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#d88200">&#34;INSERT INTO user (name, age) VALUES (?), (?), (?)&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">users</span><span style="color:#f92672">...</span><span style="color:#111">,</span> <span style="color:#75715e">// 如果arg实现了 driver.Valuer, sqlx.In 会通过调用 Value()来展开它</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">query</span><span style="color:#111">)</span> <span style="color:#75715e">// 查看生成的querystring</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">args</span><span style="color:#111">)</span>  <span style="color:#75715e">// 查看生成的args</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">DB</span><span style="color:#111">.</span><span style="color:#75af00">Exec</span><span style="color:#111">(</span><span style="color:#75af00">query</span><span style="color:#111">,</span> <span style="color:#75af00">args</span><span style="color:#f92672">...</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h4 id="使用namedexec实现批量插入">使用NamedExec实现批量插入</h4>
<p><strong>注意</strong> ：该功能需1.3.1版本以上，并且1.3.1版本目前还有点问题，sql语句最后不能有空格和<code>;</code>，详见<a href="https://github.com/jmoiron/sqlx/issues/690">issues/690</a>。</p>
<p>使用<code>NamedExec</code>实现批量插入的代码如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// BatchInsertUsers3 使用NamedExec实现批量插入</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">BatchInsertUsers3</span><span style="color:#111">(</span><span style="color:#75af00">users</span> <span style="color:#111">[]</span><span style="color:#f92672">*</span><span style="color:#75af00">User</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">DB</span><span style="color:#111">.</span><span style="color:#75af00">NamedExec</span><span style="color:#111">(</span><span style="color:#d88200">&#34;INSERT INTO user (name, age) VALUES (:name, :age)&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">users</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>把上面三种方法综合起来试一下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">initDB</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">DB</span><span style="color:#111">.</span><span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">u1</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">User</span><span style="color:#111">{</span><span style="color:#75af00">Name</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;七米&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">Age</span><span style="color:#111">:</span> <span style="color:#ae81ff">18</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">u2</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">User</span><span style="color:#111">{</span><span style="color:#75af00">Name</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;q1mi&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">Age</span><span style="color:#111">:</span> <span style="color:#ae81ff">28</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">u3</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">User</span><span style="color:#111">{</span><span style="color:#75af00">Name</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;小王子&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">Age</span><span style="color:#111">:</span> <span style="color:#ae81ff">38</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 方法1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">users</span> <span style="color:#f92672">:=</span> <span style="color:#111">[]</span><span style="color:#f92672">*</span><span style="color:#75af00">User</span><span style="color:#111">{</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">u1</span><span style="color:#111">,</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">u2</span><span style="color:#111">,</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">u3</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">BatchInsertUsers</span><span style="color:#111">(</span><span style="color:#75af00">users</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;BatchInsertUsers failed, err:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 方法2</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">users2</span> <span style="color:#f92672">:=</span> <span style="color:#111">[]</span><span style="color:#00a8c8">interface</span><span style="color:#111">{}{</span><span style="color:#75af00">u1</span><span style="color:#111">,</span> <span style="color:#75af00">u2</span><span style="color:#111">,</span> <span style="color:#75af00">u3</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">BatchInsertUsers2</span><span style="color:#111">(</span><span style="color:#75af00">users2</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;BatchInsertUsers2 failed, err:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 方法3</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">users3</span> <span style="color:#f92672">:=</span> <span style="color:#111">[]</span><span style="color:#f92672">*</span><span style="color:#75af00">User</span><span style="color:#111">{</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">u1</span><span style="color:#111">,</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">u2</span><span style="color:#111">,</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">u3</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">BatchInsertUsers3</span><span style="color:#111">(</span><span style="color:#75af00">users3</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;BatchInsertUsers3 failed, err:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="sqlxin的查询示例">sqlx.In的查询示例</h3>
<p>关于<code>sqlx.In</code>这里再补充一个用法，在<code>sqlx</code>查询语句中实现In查询和FIND_IN_SET函数。即实现<code>SELECT * FROM user WHERE id in (3, 2, 1);</code>和<code>SELECT * FROM user WHERE id in (3, 2, 1) ORDER BY FIND_IN_SET(id, '3,2,1');</code>。</p>
<h4 id="in查询">in查询</h4>
<p>查询id在给定id集合中的数据。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// QueryByIDs 根据给定ID查询</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">QueryByIDs</span><span style="color:#111">(</span><span style="color:#75af00">ids</span> <span style="color:#111">[]</span><span style="color:#00a8c8">int</span><span style="color:#111">)(</span><span style="color:#75af00">users</span> <span style="color:#111">[]</span><span style="color:#75af00">User</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span><span style="color:#111">){</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 动态填充id</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">query</span><span style="color:#111">,</span> <span style="color:#75af00">args</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">sqlx</span><span style="color:#111">.</span><span style="color:#75af00">In</span><span style="color:#111">(</span><span style="color:#d88200">&#34;SELECT name, age FROM user WHERE id IN (?)&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">ids</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// sqlx.In 返回带 `?` bindvar的查询语句, 我们使用Rebind()重新绑定它</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">query</span> <span style="color:#111">=</span> <span style="color:#75af00">DB</span><span style="color:#111">.</span><span style="color:#75af00">Rebind</span><span style="color:#111">(</span><span style="color:#75af00">query</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">DB</span><span style="color:#111">.</span><span style="color:#75af00">Select</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">users</span><span style="color:#111">,</span> <span style="color:#75af00">query</span><span style="color:#111">,</span> <span style="color:#75af00">args</span><span style="color:#f92672">...</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h4 id="in查询和find_in_set函数">in查询和FIND_IN_SET函数</h4>
<p>查询id在给定id集合的数据并维持给定id集合的顺序。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// QueryAndOrderByIDs 按照指定id查询并维护顺序</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">QueryAndOrderByIDs</span><span style="color:#111">(</span><span style="color:#75af00">ids</span> <span style="color:#111">[]</span><span style="color:#00a8c8">int</span><span style="color:#111">)(</span><span style="color:#75af00">users</span> <span style="color:#111">[]</span><span style="color:#75af00">User</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span><span style="color:#111">){</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 动态填充id</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">strIDs</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">([]</span><span style="color:#00a8c8">string</span><span style="color:#111">,</span> <span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">ids</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">id</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">ids</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">strIDs</span> <span style="color:#111">=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">strIDs</span><span style="color:#111">,</span> <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Sprintf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;%d&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">id</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">query</span><span style="color:#111">,</span> <span style="color:#75af00">args</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">sqlx</span><span style="color:#111">.</span><span style="color:#75af00">In</span><span style="color:#111">(</span><span style="color:#d88200">&#34;SELECT name, age FROM user WHERE id IN (?) ORDER BY FIND_IN_SET(id, ?)&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">ids</span><span style="color:#111">,</span> <span style="color:#75af00">strings</span><span style="color:#111">.</span><span style="color:#75af00">Join</span><span style="color:#111">(</span><span style="color:#75af00">strIDs</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;,&#34;</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// sqlx.In 返回带 `?` bindvar的查询语句, 我们使用Rebind()重新绑定它</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">query</span> <span style="color:#111">=</span> <span style="color:#75af00">DB</span><span style="color:#111">.</span><span style="color:#75af00">Rebind</span><span style="color:#111">(</span><span style="color:#75af00">query</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">DB</span><span style="color:#111">.</span><span style="color:#75af00">Select</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">users</span><span style="color:#111">,</span> <span style="color:#75af00">query</span><span style="color:#111">,</span> <span style="color:#75af00">args</span><span style="color:#f92672">...</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>当然，在这个例子里面你也可以先使用<code>IN</code>查询，然后通过代码按给定的ids对查询结果进行排序。</p>
<h2 id="文章转自">文章转自</h2>
<ul>
<li><a href="https://www.liwenzhou.com/posts/Go/sqlx/">https://www.liwenzhou.com/posts/Go/sqlx/</a></li>
</ul>
]]></content:encoded><category>go</category><category>golang</category><category>sqlx</category></item><item><title>golang redis</title><link>https://daemon365.dev/post/go/golang_redis/</link><pubDate>Sun, 12 Jan 2020 00:00:00 +0800</pubDate><guid>https://daemon365.dev/post/go/golang_redis/</guid><description>&lt;h2 id="安装"&gt;安装&lt;/h2&gt;
&lt;p&gt;下载第三方包:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;go get -u github.com/go-redis/redis/v9
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id="连接"&gt;连接&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;// 定义一个rdis客户端&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;var&lt;/span&gt; &lt;span style="color:#75af00"&gt;redisdb&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;redis&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Client&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;// 初始化&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;initClient&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;error&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;redisdb&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#75af00"&gt;redis&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;NewClient&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#f92672"&gt;&amp;amp;&lt;/span&gt;&lt;span style="color:#75af00"&gt;redis&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Options&lt;/span&gt;&lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;Addr&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;localhost:6379&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75715e"&gt;// post端口&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;Password&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 密码&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;DB&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;0&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 使用redis的库&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;})&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;_&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#75af00"&gt;redisdb&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Ping&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;context&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Background&lt;/span&gt;&lt;span style="color:#111"&gt;()).&lt;/span&gt;&lt;span style="color:#75af00"&gt;Result&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;!=&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;连接失败&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id="使用"&gt;使用&lt;/h2&gt;
&lt;h3 id="setget示例"&gt;set/get示例&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;redisExample&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;ctx&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;context&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Background&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;redisdb&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Set&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;ctx&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;score&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;100&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;0&lt;/span&gt;&lt;span style="color:#111"&gt;).&lt;/span&gt;&lt;span style="color:#75af00"&gt;Err&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;!=&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Printf&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;set score failed, err:%v\n&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;val&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;redisdb&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Get&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;ctx&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;score&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;).&lt;/span&gt;&lt;span style="color:#75af00"&gt;Result&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;!=&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Printf&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;get score failed, err:%v\n&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;score&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;val&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;val2&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;redisdb&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Get&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;ctx&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;name&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;).&lt;/span&gt;&lt;span style="color:#75af00"&gt;Result&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;==&lt;/span&gt; &lt;span style="color:#75af00"&gt;redis&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Nil&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;name does not exist&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;else&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;!=&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Printf&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;get name failed, err:%v\n&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;else&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;name&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;val2&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id="zset示例"&gt;zset示例&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;redisExample2&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;ctx&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;context&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Background&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;zsetKey&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;language_rank&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;languages&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#111"&gt;[]&lt;/span&gt;&lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;redis&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Z&lt;/span&gt;&lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f92672"&gt;&amp;amp;&lt;/span&gt;&lt;span style="color:#75af00"&gt;redis&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Z&lt;/span&gt;&lt;span style="color:#111"&gt;{&lt;/span&gt;&lt;span style="color:#75af00"&gt;Score&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;90.0&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;Member&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;Golang&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;},&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f92672"&gt;&amp;amp;&lt;/span&gt;&lt;span style="color:#75af00"&gt;redis&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Z&lt;/span&gt;&lt;span style="color:#111"&gt;{&lt;/span&gt;&lt;span style="color:#75af00"&gt;Score&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;98.0&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;Member&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;Java&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;},&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f92672"&gt;&amp;amp;&lt;/span&gt;&lt;span style="color:#75af00"&gt;redis&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Z&lt;/span&gt;&lt;span style="color:#111"&gt;{&lt;/span&gt;&lt;span style="color:#75af00"&gt;Score&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;95.0&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;Member&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;Python&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;},&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f92672"&gt;&amp;amp;&lt;/span&gt;&lt;span style="color:#75af00"&gt;redis&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Z&lt;/span&gt;&lt;span style="color:#111"&gt;{&lt;/span&gt;&lt;span style="color:#75af00"&gt;Score&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;97.0&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;Member&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;JavaScript&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;},&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f92672"&gt;&amp;amp;&lt;/span&gt;&lt;span style="color:#75af00"&gt;redis&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Z&lt;/span&gt;&lt;span style="color:#111"&gt;{&lt;/span&gt;&lt;span style="color:#75af00"&gt;Score&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;99.0&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;Member&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;C/C++&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;},&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// ZADD&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;num&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;redisdb&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;ZAdd&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;ctx&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;zsetKey&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;languages&lt;/span&gt;&lt;span style="color:#f92672"&gt;...&lt;/span&gt;&lt;span style="color:#111"&gt;).&lt;/span&gt;&lt;span style="color:#75af00"&gt;Result&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;!=&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Printf&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;zadd failed, err:%v\n&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Printf&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;zadd %d succ.\n&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;num&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// 把Golang的分数加10&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;newScore&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;redisdb&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;ZIncrBy&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;ctx&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;zsetKey&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;10.0&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;Golang&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;).&lt;/span&gt;&lt;span style="color:#75af00"&gt;Result&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;!=&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Printf&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;zincrby failed, err:%v\n&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Printf&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;Golang&amp;#39;s score is %f now.\n&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;newScore&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// 取分数最高的3个&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;ret&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;redisdb&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;ZRevRangeWithScores&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;ctx&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;zsetKey&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;0&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;2&lt;/span&gt;&lt;span style="color:#111"&gt;).&lt;/span&gt;&lt;span style="color:#75af00"&gt;Result&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;!=&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Printf&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;zrevrange failed, err:%v\n&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;for&lt;/span&gt; &lt;span style="color:#75af00"&gt;_&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;z&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;range&lt;/span&gt; &lt;span style="color:#75af00"&gt;ret&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;z&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Member&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;z&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Score&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// 取95~100分的&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;op&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#f92672"&gt;&amp;amp;&lt;/span&gt;&lt;span style="color:#75af00"&gt;redis&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;ZRangeBy&lt;/span&gt;&lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;Min&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;95&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;Max&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;100&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;ret&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#75af00"&gt;redisdb&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;ZRangeByScoreWithScores&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;ctx&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;zsetKey&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;op&lt;/span&gt;&lt;span style="color:#111"&gt;).&lt;/span&gt;&lt;span style="color:#75af00"&gt;Result&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;!=&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Printf&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;zrangebyscore failed, err:%v\n&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;for&lt;/span&gt; &lt;span style="color:#75af00"&gt;_&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;z&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;range&lt;/span&gt; &lt;span style="color:#75af00"&gt;ret&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;z&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Member&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;z&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Score&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;输出结果如下：&lt;/p&gt;</description><content:encoded><![CDATA[<h2 id="安装">安装</h2>
<p>下载第三方包:</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>go get -u github.com/go-redis/redis/v9
</span></span></code></pre></div><h2 id="连接">连接</h2>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// 定义一个rdis客户端</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">var</span> <span style="color:#75af00">redisdb</span> <span style="color:#f92672">*</span><span style="color:#75af00">redis</span><span style="color:#111">.</span><span style="color:#75af00">Client</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 初始化</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">initClient</span><span style="color:#111">()</span> <span style="color:#111">(</span><span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">redisdb</span> <span style="color:#111">=</span> <span style="color:#75af00">redis</span><span style="color:#111">.</span><span style="color:#75af00">NewClient</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">redis</span><span style="color:#111">.</span><span style="color:#75af00">Options</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">Addr</span><span style="color:#111">:</span>     <span style="color:#d88200">&#34;localhost:6379&#34;</span><span style="color:#111">,</span> <span style="color:#75715e">// post端口</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">Password</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;&#34;</span><span style="color:#111">,</span> <span style="color:#75715e">// 密码</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">DB</span><span style="color:#111">:</span>       <span style="color:#ae81ff">0</span><span style="color:#111">,</span>  <span style="color:#75715e">// 使用redis的库</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">redisdb</span><span style="color:#111">.</span><span style="color:#75af00">Ping</span><span style="color:#111">(</span><span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Background</span><span style="color:#111">()).</span><span style="color:#75af00">Result</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;连接失败&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="使用">使用</h2>
<h3 id="setget示例">set/get示例</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">redisExample</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ctx</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Background</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">redisdb</span><span style="color:#111">.</span><span style="color:#75af00">Set</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;score&#34;</span><span style="color:#111">,</span> <span style="color:#ae81ff">100</span><span style="color:#111">,</span> <span style="color:#ae81ff">0</span><span style="color:#111">).</span><span style="color:#75af00">Err</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;set score failed, err:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">val</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">redisdb</span><span style="color:#111">.</span><span style="color:#75af00">Get</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;score&#34;</span><span style="color:#111">).</span><span style="color:#75af00">Result</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;get score failed, err:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;score&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">val</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">val2</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">redisdb</span><span style="color:#111">.</span><span style="color:#75af00">Get</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;name&#34;</span><span style="color:#111">).</span><span style="color:#75af00">Result</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">==</span> <span style="color:#75af00">redis</span><span style="color:#111">.</span><span style="color:#75af00">Nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;name does not exist&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;get name failed, err:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;name&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">val2</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="zset示例">zset示例</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">redisExample2</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ctx</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Background</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">zsetKey</span> <span style="color:#f92672">:=</span> <span style="color:#d88200">&#34;language_rank&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">languages</span> <span style="color:#f92672">:=</span> <span style="color:#111">[]</span><span style="color:#f92672">*</span><span style="color:#75af00">redis</span><span style="color:#111">.</span><span style="color:#75af00">Z</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">&amp;</span><span style="color:#75af00">redis</span><span style="color:#111">.</span><span style="color:#75af00">Z</span><span style="color:#111">{</span><span style="color:#75af00">Score</span><span style="color:#111">:</span> <span style="color:#ae81ff">90.0</span><span style="color:#111">,</span> <span style="color:#75af00">Member</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;Golang&#34;</span><span style="color:#111">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">&amp;</span><span style="color:#75af00">redis</span><span style="color:#111">.</span><span style="color:#75af00">Z</span><span style="color:#111">{</span><span style="color:#75af00">Score</span><span style="color:#111">:</span> <span style="color:#ae81ff">98.0</span><span style="color:#111">,</span> <span style="color:#75af00">Member</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;Java&#34;</span><span style="color:#111">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">&amp;</span><span style="color:#75af00">redis</span><span style="color:#111">.</span><span style="color:#75af00">Z</span><span style="color:#111">{</span><span style="color:#75af00">Score</span><span style="color:#111">:</span> <span style="color:#ae81ff">95.0</span><span style="color:#111">,</span> <span style="color:#75af00">Member</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;Python&#34;</span><span style="color:#111">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">&amp;</span><span style="color:#75af00">redis</span><span style="color:#111">.</span><span style="color:#75af00">Z</span><span style="color:#111">{</span><span style="color:#75af00">Score</span><span style="color:#111">:</span> <span style="color:#ae81ff">97.0</span><span style="color:#111">,</span> <span style="color:#75af00">Member</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;JavaScript&#34;</span><span style="color:#111">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">&amp;</span><span style="color:#75af00">redis</span><span style="color:#111">.</span><span style="color:#75af00">Z</span><span style="color:#111">{</span><span style="color:#75af00">Score</span><span style="color:#111">:</span> <span style="color:#ae81ff">99.0</span><span style="color:#111">,</span> <span style="color:#75af00">Member</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;C/C++&#34;</span><span style="color:#111">},</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ZADD</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">num</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">redisdb</span><span style="color:#111">.</span><span style="color:#75af00">ZAdd</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">zsetKey</span><span style="color:#111">,</span> <span style="color:#75af00">languages</span><span style="color:#f92672">...</span><span style="color:#111">).</span><span style="color:#75af00">Result</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;zadd failed, err:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;zadd %d succ.\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">num</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 把Golang的分数加10</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">newScore</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">redisdb</span><span style="color:#111">.</span><span style="color:#75af00">ZIncrBy</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">zsetKey</span><span style="color:#111">,</span> <span style="color:#ae81ff">10.0</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Golang&#34;</span><span style="color:#111">).</span><span style="color:#75af00">Result</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;zincrby failed, err:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Golang&#39;s score is %f now.\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">newScore</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 取分数最高的3个</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ret</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">redisdb</span><span style="color:#111">.</span><span style="color:#75af00">ZRevRangeWithScores</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">zsetKey</span><span style="color:#111">,</span> <span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#ae81ff">2</span><span style="color:#111">).</span><span style="color:#75af00">Result</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;zrevrange failed, err:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">z</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">ret</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">z</span><span style="color:#111">.</span><span style="color:#75af00">Member</span><span style="color:#111">,</span> <span style="color:#75af00">z</span><span style="color:#111">.</span><span style="color:#75af00">Score</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 取95~100分的</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">op</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">redis</span><span style="color:#111">.</span><span style="color:#75af00">ZRangeBy</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">Min</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;95&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">Max</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;100&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ret</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">redisdb</span><span style="color:#111">.</span><span style="color:#75af00">ZRangeByScoreWithScores</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">zsetKey</span><span style="color:#111">,</span> <span style="color:#75af00">op</span><span style="color:#111">).</span><span style="color:#75af00">Result</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;zrangebyscore failed, err:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">z</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">ret</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">z</span><span style="color:#111">.</span><span style="color:#75af00">Member</span><span style="color:#111">,</span> <span style="color:#75af00">z</span><span style="color:#111">.</span><span style="color:#75af00">Score</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>输出结果如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ ./06redis_demo 
</span></span><span style="display:flex;"><span>zadd <span style="color:#ae81ff">0</span> succ.
</span></span><span style="display:flex;"><span>Golang<span style="color:#960050;background-color:#1e0010">&#39;</span>s score is 100.000000 now.
</span></span><span style="display:flex;"><span>Golang <span style="color:#ae81ff">100</span>
</span></span><span style="display:flex;"><span>C/C++ <span style="color:#ae81ff">99</span>
</span></span><span style="display:flex;"><span>Java <span style="color:#ae81ff">98</span>
</span></span><span style="display:flex;"><span>JavaScript <span style="color:#ae81ff">97</span>
</span></span><span style="display:flex;"><span>Java <span style="color:#ae81ff">98</span>
</span></span><span style="display:flex;"><span>C/C++ <span style="color:#ae81ff">99</span>
</span></span><span style="display:flex;"><span>Golang <span style="color:#ae81ff">100</span>
</span></span></code></pre></div>]]></content:encoded><category>go</category><category>golang</category><category>redis</category></item><item><title>golang nethttp包</title><link>https://daemon365.dev/post/go/golang_nethttp_package/</link><pubDate>Sat, 11 Jan 2020 00:00:00 +0800</pubDate><guid>https://daemon365.dev/post/go/golang_nethttp_package/</guid><description>&lt;h2 id="http协议"&gt;http协议&lt;/h2&gt;
&lt;p&gt;超文本传输协议（HTTP，HyperText Transfer Protocol)是互联网上应用最为广泛的一种网络传输协议，所有的WWW文件都必须遵守这个标准。设计HTTP最初的目的是为了提供一种发布和接收HTML页面的方法。&lt;/p&gt;
&lt;p&gt;关于http(https)协议: &lt;a href="https://www.cnblogs.com/yuemoxi/p/15162601.html"&gt;https://www.cnblogs.com/yuemoxi/p/15162601.html&lt;/a&gt;&lt;/p&gt;
&lt;h2 id="http包中重要的类型和接口"&gt;http包中重要的类型和接口&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;server：HTTP服务器，定义监听的地址、端口，处理器等信息。&lt;/li&gt;
&lt;li&gt;conn：用户每次请求的链接。&lt;/li&gt;
&lt;li&gt;response：返回给用户的信息。&lt;/li&gt;
&lt;li&gt;request：用户请求的信息。&lt;/li&gt;
&lt;li&gt;Handler: 处理器，用户请求到来时，服务器的处理逻辑，它是一个包含ServeHTTP方法的接口。&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="http包的运行流程"&gt;http包的运行流程&lt;/h2&gt;
&lt;p&gt;&lt;img src="https://daemon365.dev/images/8f5c944f-7915-4f74-8efe-e9253fea0c5d.png" alt=""&gt;&lt;/p&gt;
&lt;h3 id="http包如何实现高并发"&gt;http包如何实现高并发&lt;/h3&gt;
&lt;p&gt;http包中，server每接收一个用户请求，都会生成一个conn链接，并生成一个goroutines来处理对应的conn。所以每个请求都是独立的，相互不阻塞的。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75af00"&gt;c&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;srv&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;newConn&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;rw&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75af00"&gt;c&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;setState&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;c&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;rwc&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;StateNew&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;go&lt;/span&gt; &lt;span style="color:#75af00"&gt;c&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;serve&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;ctx&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id="处理器handler和多路复用器servemux"&gt;处理器(Handler)和多路复用器(ServeMux)&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;sh&lt;/span&gt; &lt;span style="color:#75af00"&gt;serverHandler&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75af00"&gt;ServeHTTP&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;rw&lt;/span&gt; &lt;span style="color:#75af00"&gt;ResponseWriter&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;req&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;Request&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;handler&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;sh&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;srv&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Handler&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;handler&lt;/span&gt; &lt;span style="color:#f92672"&gt;==&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;handler&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#75af00"&gt;DefaultServeMux&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;req&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;RequestURI&lt;/span&gt; &lt;span style="color:#f92672"&gt;==&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;*&amp;#34;&lt;/span&gt; &lt;span style="color:#f92672"&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span style="color:#75af00"&gt;req&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Method&lt;/span&gt; &lt;span style="color:#f92672"&gt;==&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;OPTIONS&amp;#34;&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;handler&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#75af00"&gt;globalOptionsHandler&lt;/span&gt;&lt;span style="color:#111"&gt;{}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;handler&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;ServeHTTP&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;rw&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;req&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;所以当我们的处理器为空时，http包会默认帮我们生成一个DefaultServeMux处理器。 不是说第二个参数是处理器吗，但是DefaultServeMux是一个ServeMux结构的实例, 是一个多路复用器。这是怎么回事？ 其实处理器是一个拥有ServeHTTP方法的接口，只要实现了这个方法，它就是一个处理器。所以DefaultServeMux不仅是一个多路复用器，而且还是一个处理器。只是这个处理器比较特殊，它只是根据请求的URL将请求分配到对应的处理器。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;mux&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;ServeMux&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75af00"&gt;ServeHTTP&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;w&lt;/span&gt; &lt;span style="color:#75af00"&gt;ResponseWriter&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;r&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;Request&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;r&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;RequestURI&lt;/span&gt; &lt;span style="color:#f92672"&gt;==&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;*&amp;#34;&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;r&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;ProtoAtLeast&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;1&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;1&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;w&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Header&lt;/span&gt;&lt;span style="color:#111"&gt;().&lt;/span&gt;&lt;span style="color:#75af00"&gt;Set&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;Connection&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;close&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;w&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;WriteHeader&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;StatusBadRequest&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;h&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;_&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;mux&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Handler&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;r&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;h&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;ServeHTTP&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;w&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;r&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;我们可以自定义自己的处理器&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;package&lt;/span&gt; &lt;span style="color:#75af00"&gt;main&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;import&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;fmt&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;net/http&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;// 定一个自定义的Handler的结构&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;type&lt;/span&gt; &lt;span style="color:#75af00"&gt;MyHanlder&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;struct&lt;/span&gt;&lt;span style="color:#111"&gt;{}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;// 为MyHanlder结构实现Hanlder接口的ServeHTTP的方法，此时MyHandler将是一个处理器(Handler)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;h&lt;/span&gt; &lt;span style="color:#75af00"&gt;MyHanlder&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75af00"&gt;ServeHTTP&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;w&lt;/span&gt; &lt;span style="color:#75af00"&gt;http&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;ResponseWriter&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;r&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;http&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Request&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Fprintf&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;w&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;This my handler&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;main&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// 实例化MyHandler&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;hanlder&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;MyHanlder&lt;/span&gt;&lt;span style="color:#111"&gt;{}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;//启动服务器并监听8000/tcp端口&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;http&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;ListenAndServe&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;:8000&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;hanlder&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;!=&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;err&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id="servemux和defaultservemux"&gt;ServeMux和DefaultServeMux&lt;/h3&gt;
&lt;p&gt;前面我们说DefaultServeMux是一个ServeMux的实例，它不仅是一个多路复用器，而且是一个处理器。多路复用器具有路由功能，可以根据请求的URL将请求传递给对应的处理器处理。看下http包中默认的多路复用器是怎么实现的：&lt;/p&gt;</description><content:encoded><![CDATA[<h2 id="http协议">http协议</h2>
<p>超文本传输协议（HTTP，HyperText Transfer Protocol)是互联网上应用最为广泛的一种网络传输协议，所有的WWW文件都必须遵守这个标准。设计HTTP最初的目的是为了提供一种发布和接收HTML页面的方法。</p>
<p>关于http(https)协议: <a href="https://www.cnblogs.com/yuemoxi/p/15162601.html">https://www.cnblogs.com/yuemoxi/p/15162601.html</a></p>
<h2 id="http包中重要的类型和接口">http包中重要的类型和接口</h2>
<ul>
<li>server：HTTP服务器，定义监听的地址、端口，处理器等信息。</li>
<li>conn：用户每次请求的链接。</li>
<li>response：返回给用户的信息。</li>
<li>request：用户请求的信息。</li>
<li>Handler: 处理器，用户请求到来时，服务器的处理逻辑，它是一个包含ServeHTTP方法的接口。</li>
</ul>
<h2 id="http包的运行流程">http包的运行流程</h2>
<p><img src="/images/8f5c944f-7915-4f74-8efe-e9253fea0c5d.png" alt=""></p>
<h3 id="http包如何实现高并发">http包如何实现高并发</h3>
<p>http包中，server每接收一个用户请求，都会生成一个conn链接，并生成一个goroutines来处理对应的conn。所以每个请求都是独立的，相互不阻塞的。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">c</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">srv</span><span style="color:#111">.</span><span style="color:#75af00">newConn</span><span style="color:#111">(</span><span style="color:#75af00">rw</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">setState</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">rwc</span><span style="color:#111">,</span> <span style="color:#75af00">StateNew</span><span style="color:#111">)</span> 
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">go</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">serve</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">)</span>
</span></span></code></pre></div><h3 id="处理器handler和多路复用器servemux">处理器(Handler)和多路复用器(ServeMux)</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">sh</span> <span style="color:#75af00">serverHandler</span><span style="color:#111">)</span> <span style="color:#75af00">ServeHTTP</span><span style="color:#111">(</span><span style="color:#75af00">rw</span> <span style="color:#75af00">ResponseWriter</span><span style="color:#111">,</span> <span style="color:#75af00">req</span> <span style="color:#f92672">*</span><span style="color:#75af00">Request</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">handler</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">sh</span><span style="color:#111">.</span><span style="color:#75af00">srv</span><span style="color:#111">.</span><span style="color:#75af00">Handler</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">handler</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">handler</span> <span style="color:#111">=</span> <span style="color:#75af00">DefaultServeMux</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">req</span><span style="color:#111">.</span><span style="color:#75af00">RequestURI</span> <span style="color:#f92672">==</span> <span style="color:#d88200">&#34;*&#34;</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">req</span><span style="color:#111">.</span><span style="color:#75af00">Method</span> <span style="color:#f92672">==</span> <span style="color:#d88200">&#34;OPTIONS&#34;</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">handler</span> <span style="color:#111">=</span> <span style="color:#75af00">globalOptionsHandler</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">handler</span><span style="color:#111">.</span><span style="color:#75af00">ServeHTTP</span><span style="color:#111">(</span><span style="color:#75af00">rw</span><span style="color:#111">,</span> <span style="color:#75af00">req</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>所以当我们的处理器为空时，http包会默认帮我们生成一个DefaultServeMux处理器。 不是说第二个参数是处理器吗，但是DefaultServeMux是一个ServeMux结构的实例, 是一个多路复用器。这是怎么回事？ 其实处理器是一个拥有ServeHTTP方法的接口，只要实现了这个方法，它就是一个处理器。所以DefaultServeMux不仅是一个多路复用器，而且还是一个处理器。只是这个处理器比较特殊，它只是根据请求的URL将请求分配到对应的处理器。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">mux</span> <span style="color:#f92672">*</span><span style="color:#75af00">ServeMux</span><span style="color:#111">)</span> <span style="color:#75af00">ServeHTTP</span><span style="color:#111">(</span><span style="color:#75af00">w</span> <span style="color:#75af00">ResponseWriter</span><span style="color:#111">,</span> <span style="color:#75af00">r</span> <span style="color:#f92672">*</span><span style="color:#75af00">Request</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">RequestURI</span> <span style="color:#f92672">==</span> <span style="color:#d88200">&#34;*&#34;</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">ProtoAtLeast</span><span style="color:#111">(</span><span style="color:#ae81ff">1</span><span style="color:#111">,</span> <span style="color:#ae81ff">1</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75af00">w</span><span style="color:#111">.</span><span style="color:#75af00">Header</span><span style="color:#111">().</span><span style="color:#75af00">Set</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Connection&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;close&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">w</span><span style="color:#111">.</span><span style="color:#75af00">WriteHeader</span><span style="color:#111">(</span><span style="color:#75af00">StatusBadRequest</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">h</span><span style="color:#111">,</span> <span style="color:#75af00">_</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">Handler</span><span style="color:#111">(</span><span style="color:#75af00">r</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">ServeHTTP</span><span style="color:#111">(</span><span style="color:#75af00">w</span><span style="color:#111">,</span> <span style="color:#75af00">r</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>我们可以自定义自己的处理器</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d88200">&#34;net/http&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 定一个自定义的Handler的结构</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">MyHanlder</span> <span style="color:#00a8c8">struct</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 为MyHanlder结构实现Hanlder接口的ServeHTTP的方法，此时MyHandler将是一个处理器(Handler)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">h</span> <span style="color:#75af00">MyHanlder</span><span style="color:#111">)</span> <span style="color:#75af00">ServeHTTP</span><span style="color:#111">(</span><span style="color:#75af00">w</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">ResponseWriter</span><span style="color:#111">,</span> <span style="color:#75af00">r</span> <span style="color:#f92672">*</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Request</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Fprintf</span><span style="color:#111">(</span><span style="color:#75af00">w</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;This my handler&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 实例化MyHandler</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">hanlder</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">MyHanlder</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//启动服务器并监听8000/tcp端口</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">ListenAndServe</span><span style="color:#111">(</span><span style="color:#d88200">&#34;:8000&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">hanlder</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="servemux和defaultservemux">ServeMux和DefaultServeMux</h3>
<p>前面我们说DefaultServeMux是一个ServeMux的实例，它不仅是一个多路复用器，而且是一个处理器。多路复用器具有路由功能，可以根据请求的URL将请求传递给对应的处理器处理。看下http包中默认的多路复用器是怎么实现的：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">ServeMux</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">mu</span>    <span style="color:#75af00">sync</span><span style="color:#111">.</span><span style="color:#75af00">RWMutex</span>  <span style="color:#75715e">//锁，应为请求是并发处理的，所以这里需要锁机制</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">m</span>     <span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#00a8c8">string</span><span style="color:#111">]</span><span style="color:#75af00">muxEntry</span> <span style="color:#75715e">//路由规则的map，一个string对应一个muxEntry</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">es</span>    <span style="color:#111">[]</span><span style="color:#75af00">muxEntry</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">hosts</span> <span style="color:#00a8c8">bool</span>       
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">muxEntry</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">h</span>       <span style="color:#75af00">Handler</span>    <span style="color:#75715e">//string对应的处理器</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">pattern</span> <span style="color:#00a8c8">string</span>     <span style="color:#75715e">//匹配的字符串</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>默认的多路复用器是根据请求的URL与存储的map做匹配，匹配到了就返回对应的handler，然后调用该handler的ServeHTTP方法来处理请求。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">mux</span> <span style="color:#f92672">*</span><span style="color:#75af00">ServeMux</span><span style="color:#111">)</span> <span style="color:#75af00">ServeHTTP</span><span style="color:#111">(</span><span style="color:#75af00">w</span> <span style="color:#75af00">ResponseWriter</span><span style="color:#111">,</span> <span style="color:#75af00">r</span> <span style="color:#f92672">*</span><span style="color:#75af00">Request</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">RequestURI</span> <span style="color:#f92672">==</span> <span style="color:#d88200">&#34;*&#34;</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">ProtoAtLeast</span><span style="color:#111">(</span><span style="color:#ae81ff">1</span><span style="color:#111">,</span> <span style="color:#ae81ff">1</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75af00">w</span><span style="color:#111">.</span><span style="color:#75af00">Header</span><span style="color:#111">().</span><span style="color:#75af00">Set</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Connection&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;close&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">w</span><span style="color:#111">.</span><span style="color:#75af00">WriteHeader</span><span style="color:#111">(</span><span style="color:#75af00">StatusBadRequest</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">h</span><span style="color:#111">,</span> <span style="color:#75af00">_</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">Handler</span><span style="color:#111">(</span><span style="color:#75af00">r</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">ServeHTTP</span><span style="color:#111">(</span><span style="color:#75af00">w</span><span style="color:#111">,</span> <span style="color:#75af00">r</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">mux</span> <span style="color:#f92672">*</span><span style="color:#75af00">ServeMux</span><span style="color:#111">)</span> <span style="color:#75af00">Handler</span><span style="color:#111">(</span><span style="color:#75af00">r</span> <span style="color:#f92672">*</span><span style="color:#75af00">Request</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#75af00">h</span> <span style="color:#75af00">Handler</span><span style="color:#111">,</span> <span style="color:#75af00">pattern</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">Method</span> <span style="color:#f92672">==</span> <span style="color:#d88200">&#34;CONNECT&#34;</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#75af00">u</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">redirectToPathSlash</span><span style="color:#111">(</span><span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">URL</span><span style="color:#111">.</span><span style="color:#75af00">Host</span><span style="color:#111">,</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">URL</span><span style="color:#111">.</span><span style="color:#75af00">Path</span><span style="color:#111">,</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">URL</span><span style="color:#111">);</span> <span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">return</span> <span style="color:#75af00">RedirectHandler</span><span style="color:#111">(</span><span style="color:#75af00">u</span><span style="color:#111">.</span><span style="color:#75af00">String</span><span style="color:#111">(),</span> <span style="color:#75af00">StatusMovedPermanently</span><span style="color:#111">),</span> <span style="color:#75af00">u</span><span style="color:#111">.</span><span style="color:#75af00">Path</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">handler</span><span style="color:#111">(</span><span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">Host</span><span style="color:#111">,</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">URL</span><span style="color:#111">.</span><span style="color:#75af00">Path</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">host</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">stripHostPort</span><span style="color:#111">(</span><span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">Host</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">path</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">cleanPath</span><span style="color:#111">(</span><span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">URL</span><span style="color:#111">.</span><span style="color:#75af00">Path</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">u</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">redirectToPathSlash</span><span style="color:#111">(</span><span style="color:#75af00">host</span><span style="color:#111">,</span> <span style="color:#75af00">path</span><span style="color:#111">,</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">URL</span><span style="color:#111">);</span> <span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">RedirectHandler</span><span style="color:#111">(</span><span style="color:#75af00">u</span><span style="color:#111">.</span><span style="color:#75af00">String</span><span style="color:#111">(),</span> <span style="color:#75af00">StatusMovedPermanently</span><span style="color:#111">),</span> <span style="color:#75af00">u</span><span style="color:#111">.</span><span style="color:#75af00">Path</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">path</span> <span style="color:#f92672">!=</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">URL</span><span style="color:#111">.</span><span style="color:#75af00">Path</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">pattern</span> <span style="color:#111">=</span> <span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">handler</span><span style="color:#111">(</span><span style="color:#75af00">host</span><span style="color:#111">,</span> <span style="color:#75af00">path</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">url</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">*</span><span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">URL</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">url</span><span style="color:#111">.</span><span style="color:#75af00">Path</span> <span style="color:#111">=</span> <span style="color:#75af00">path</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">RedirectHandler</span><span style="color:#111">(</span><span style="color:#75af00">url</span><span style="color:#111">.</span><span style="color:#75af00">String</span><span style="color:#111">(),</span> <span style="color:#75af00">StatusMovedPermanently</span><span style="color:#111">),</span> <span style="color:#75af00">pattern</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">handler</span><span style="color:#111">(</span><span style="color:#75af00">host</span><span style="color:#111">,</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">URL</span><span style="color:#111">.</span><span style="color:#75af00">Path</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">mux</span> <span style="color:#f92672">*</span><span style="color:#75af00">ServeMux</span><span style="color:#111">)</span> <span style="color:#75af00">handler</span><span style="color:#111">(</span><span style="color:#75af00">host</span><span style="color:#111">,</span> <span style="color:#75af00">path</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#75af00">h</span> <span style="color:#75af00">Handler</span><span style="color:#111">,</span> <span style="color:#75af00">pattern</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">RLock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">defer</span> <span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">RUnlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">hosts</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">h</span><span style="color:#111">,</span> <span style="color:#75af00">pattern</span> <span style="color:#111">=</span> <span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">match</span><span style="color:#111">(</span><span style="color:#75af00">host</span> <span style="color:#f92672">+</span> <span style="color:#75af00">path</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">h</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">h</span><span style="color:#111">,</span> <span style="color:#75af00">pattern</span> <span style="color:#111">=</span> <span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">match</span><span style="color:#111">(</span><span style="color:#75af00">path</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">h</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">h</span><span style="color:#111">,</span> <span style="color:#75af00">pattern</span> <span style="color:#111">=</span> <span style="color:#75af00">NotFoundHandler</span><span style="color:#111">(),</span> <span style="color:#d88200">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>我们也可以根据接口定义实现自己简单的路由器</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d88200">&#34;net/http&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 自定义一个多路复用器的结构</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">MyMux</span> <span style="color:#00a8c8">struct</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 实现ServeHTTP方法</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">m</span> <span style="color:#75af00">MyMux</span><span style="color:#111">)</span> <span style="color:#75af00">ServeHTTP</span><span style="color:#111">(</span><span style="color:#75af00">w</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">ResponseWriter</span><span style="color:#111">,</span> <span style="color:#75af00">r</span> <span style="color:#f92672">*</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Request</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 判断URL并转到对应的handler处理</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">URL</span><span style="color:#111">.</span><span style="color:#75af00">Path</span> <span style="color:#f92672">==</span> <span style="color:#d88200">&#34;/index&#34;</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">IndexHandler</span><span style="color:#111">(</span><span style="color:#75af00">w</span><span style="color:#111">,</span> <span style="color:#75af00">r</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">NotFound</span><span style="color:#111">(</span><span style="color:#75af00">w</span><span style="color:#111">,</span> <span style="color:#75af00">r</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">IndexHandler</span><span style="color:#111">(</span><span style="color:#75af00">w</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">ResponseWriter</span><span style="color:#111">,</span> <span style="color:#75af00">r</span> <span style="color:#f92672">*</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Request</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Fprintf</span><span style="color:#111">(</span><span style="color:#75af00">w</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;This is index page&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 实例化一个自定义的路由器</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">mux</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">MyMux</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">ListenAndServe</span><span style="color:#111">(</span><span style="color:#d88200">&#34;:8000&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">mux</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="http客户端">HTTP客户端</h2>
<h3 id="基本的httphttps请求">基本的HTTP/HTTPS请求</h3>
<p>Get、Head、Post和PostForm函数发出HTTP/HTTPS请求。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">resp</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Get</span><span style="color:#111">(</span><span style="color:#d88200">&#34;http://example.com/&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">resp</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Post</span><span style="color:#111">(</span><span style="color:#d88200">&#34;http://example.com/upload&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;image/jpeg&#34;</span><span style="color:#111">,</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">buf</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">resp</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">PostForm</span><span style="color:#111">(</span><span style="color:#d88200">&#34;http://example.com/form&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">url</span><span style="color:#111">.</span><span style="color:#75af00">Values</span><span style="color:#111">{</span><span style="color:#d88200">&#34;key&#34;</span><span style="color:#111">:</span> <span style="color:#111">{</span><span style="color:#d88200">&#34;Value&#34;</span><span style="color:#111">},</span> <span style="color:#d88200">&#34;id&#34;</span><span style="color:#111">:</span> <span style="color:#111">{</span><span style="color:#d88200">&#34;123&#34;</span><span style="color:#111">}})</span>
</span></span></code></pre></div><p>程序在使用完response后必须关闭回复的主体。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">resp</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Get</span><span style="color:#111">(</span><span style="color:#d88200">&#34;http://example.com/&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// handle error</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">defer</span> <span style="color:#75af00">resp</span><span style="color:#111">.</span><span style="color:#75af00">Body</span><span style="color:#111">.</span><span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">body</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">ioutil</span><span style="color:#111">.</span><span style="color:#75af00">ReadAll</span><span style="color:#111">(</span><span style="color:#75af00">resp</span><span style="color:#111">.</span><span style="color:#75af00">Body</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// ...</span>
</span></span></code></pre></div><h3 id="get请求示例">GET请求示例</h3>
<p>使用net/http包编写一个简单的发送HTTP请求的Client端，代码如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;io/ioutil&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;net/http&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">resp</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Get</span><span style="color:#111">(</span><span style="color:#d88200">&#34;https://www.liwenzhou.com/&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;get failed, err:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">resp</span><span style="color:#111">.</span><span style="color:#75af00">Body</span><span style="color:#111">.</span><span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">body</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">ioutil</span><span style="color:#111">.</span><span style="color:#75af00">ReadAll</span><span style="color:#111">(</span><span style="color:#75af00">resp</span><span style="color:#111">.</span><span style="color:#75af00">Body</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;read from resp.Body failed, err:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Print</span><span style="color:#111">(</span><span style="color:#111">string</span><span style="color:#111">(</span><span style="color:#75af00">body</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>将上面的代码保存之后编译成可执行文件，执行之后就能在终端打印liwenzhou.com网站首页的内容了，我们的浏览器其实就是一个发送和接收HTTP协议数据的客户端，我们平时通过浏览器访问网页其实就是从网站的服务器接收HTTP数据，然后浏览器会按照HTML、CSS等规则将网页渲染展示出来。</p>
<h3 id="带参数的get请求示例">带参数的GET请求示例</h3>
<p>关于GET请求的参数需要使用Go语言内置的net/url这个标准库来处理。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">apiUrl</span> <span style="color:#f92672">:=</span> <span style="color:#d88200">&#34;http://127.0.0.1:9090/get&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// URL param</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">data</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">url</span><span style="color:#111">.</span><span style="color:#75af00">Values</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">data</span><span style="color:#111">.</span><span style="color:#75af00">Set</span><span style="color:#111">(</span><span style="color:#d88200">&#34;name&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;小王子&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">data</span><span style="color:#111">.</span><span style="color:#75af00">Set</span><span style="color:#111">(</span><span style="color:#d88200">&#34;age&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;18&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">u</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">url</span><span style="color:#111">.</span><span style="color:#75af00">ParseRequestURI</span><span style="color:#111">(</span><span style="color:#75af00">apiUrl</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;parse url requestUrl failed, err:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">u</span><span style="color:#111">.</span><span style="color:#75af00">RawQuery</span> <span style="color:#111">=</span> <span style="color:#75af00">data</span><span style="color:#111">.</span><span style="color:#75af00">Encode</span><span style="color:#111">()</span> <span style="color:#75715e">// URL encode</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">u</span><span style="color:#111">.</span><span style="color:#75af00">String</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">resp</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Get</span><span style="color:#111">(</span><span style="color:#75af00">u</span><span style="color:#111">.</span><span style="color:#75af00">String</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;post failed, err:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">resp</span><span style="color:#111">.</span><span style="color:#75af00">Body</span><span style="color:#111">.</span><span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">b</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">ioutil</span><span style="color:#111">.</span><span style="color:#75af00">ReadAll</span><span style="color:#111">(</span><span style="color:#75af00">resp</span><span style="color:#111">.</span><span style="color:#75af00">Body</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;get resp failed, err:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#111">string</span><span style="color:#111">(</span><span style="color:#75af00">b</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>对应的Server端HandlerFunc如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">getHandler</span><span style="color:#111">(</span><span style="color:#75af00">w</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">ResponseWriter</span><span style="color:#111">,</span> <span style="color:#75af00">r</span> <span style="color:#f92672">*</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Request</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">Body</span><span style="color:#111">.</span><span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">data</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">URL</span><span style="color:#111">.</span><span style="color:#75af00">Query</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">data</span><span style="color:#111">.</span><span style="color:#75af00">Get</span><span style="color:#111">(</span><span style="color:#d88200">&#34;name&#34;</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">data</span><span style="color:#111">.</span><span style="color:#75af00">Get</span><span style="color:#111">(</span><span style="color:#d88200">&#34;age&#34;</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">answer</span> <span style="color:#f92672">:=</span> <span style="color:#d88200">`{&#34;status&#34;: &#34;ok&#34;}`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">w</span><span style="color:#111">.</span><span style="color:#75af00">Write</span><span style="color:#111">([]</span><span style="color:#111">byte</span><span style="color:#111">(</span><span style="color:#75af00">answer</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="post请求">Post请求</h3>
<p>上面演示了使用net/http包发送GET请求的示例，发送POST请求的示例代码如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;io/ioutil&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;net/http&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;strings&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// net/http post demo</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">url</span> <span style="color:#f92672">:=</span> <span style="color:#d88200">&#34;http://127.0.0.1:9090/post&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 表单数据</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//contentType := &#34;application/x-www-form-urlencoded&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//data := &#34;name=小王子&amp;age=18&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// json</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">contentType</span> <span style="color:#f92672">:=</span> <span style="color:#d88200">&#34;application/json&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">data</span> <span style="color:#f92672">:=</span> <span style="color:#d88200">`{&#34;name&#34;:&#34;小王子&#34;,&#34;age&#34;:18}`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">resp</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Post</span><span style="color:#111">(</span><span style="color:#75af00">url</span><span style="color:#111">,</span> <span style="color:#75af00">contentType</span><span style="color:#111">,</span> <span style="color:#75af00">strings</span><span style="color:#111">.</span><span style="color:#75af00">NewReader</span><span style="color:#111">(</span><span style="color:#75af00">data</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;post failed, err:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">resp</span><span style="color:#111">.</span><span style="color:#75af00">Body</span><span style="color:#111">.</span><span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">b</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">ioutil</span><span style="color:#111">.</span><span style="color:#75af00">ReadAll</span><span style="color:#111">(</span><span style="color:#75af00">resp</span><span style="color:#111">.</span><span style="color:#75af00">Body</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;get resp failed, err:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#111">string</span><span style="color:#111">(</span><span style="color:#75af00">b</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>对应的Server端HandlerFunc如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">postHandler</span><span style="color:#111">(</span><span style="color:#75af00">w</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">ResponseWriter</span><span style="color:#111">,</span> <span style="color:#75af00">r</span> <span style="color:#f92672">*</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Request</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">Body</span><span style="color:#111">.</span><span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 1\. 请求类型是application/x-www-form-urlencoded时解析form数据</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">ParseForm</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">PostForm</span><span style="color:#111">)</span> <span style="color:#75715e">// 打印form数据</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">PostForm</span><span style="color:#111">.</span><span style="color:#75af00">Get</span><span style="color:#111">(</span><span style="color:#d88200">&#34;name&#34;</span><span style="color:#111">),</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">PostForm</span><span style="color:#111">.</span><span style="color:#75af00">Get</span><span style="color:#111">(</span><span style="color:#d88200">&#34;age&#34;</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 2\. 请求类型是application/json时从r.Body读取数据</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">b</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">ioutil</span><span style="color:#111">.</span><span style="color:#75af00">ReadAll</span><span style="color:#111">(</span><span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">Body</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;read request.Body failed, err:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#111">string</span><span style="color:#111">(</span><span style="color:#75af00">b</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">answer</span> <span style="color:#f92672">:=</span> <span style="color:#d88200">`{&#34;status&#34;: &#34;ok&#34;}`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">w</span><span style="color:#111">.</span><span style="color:#75af00">Write</span><span style="color:#111">([]</span><span style="color:#111">byte</span><span style="color:#111">(</span><span style="color:#75af00">answer</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="client">Client</h3>
<p>要管理HTTP客户端的头域、重定向策略和其他设置，创建一个Client：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">client</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Client</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">CheckRedirect</span><span style="color:#111">:</span> <span style="color:#75af00">redirectPolicyFunc</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">resp</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">client</span><span style="color:#111">.</span><span style="color:#75af00">Get</span><span style="color:#111">(</span><span style="color:#d88200">&#34;http://example.com&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// ...</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">req</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">NewRequest</span><span style="color:#111">(</span><span style="color:#d88200">&#34;GET&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;http://example.com&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// ...</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">req</span><span style="color:#111">.</span><span style="color:#75af00">Header</span><span style="color:#111">.</span><span style="color:#75af00">Add</span><span style="color:#111">(</span><span style="color:#d88200">&#34;If-None-Match&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">`W/&#34;wyzzy&#34;`</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">resp</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">client</span><span style="color:#111">.</span><span style="color:#75af00">Do</span><span style="color:#111">(</span><span style="color:#75af00">req</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// ...</span>
</span></span></code></pre></div><h4 id="自定义transport">自定义Transport</h4>
<p>要管理代理、TLS配置、keep-alive、压缩和其他设置，创建一个Transport：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">tr</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Transport</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">TLSClientConfig</span><span style="color:#111">:</span>    <span style="color:#f92672">&amp;</span><span style="color:#75af00">tls</span><span style="color:#111">.</span><span style="color:#75af00">Config</span><span style="color:#111">{</span><span style="color:#75af00">RootCAs</span><span style="color:#111">:</span> <span style="color:#75af00">pool</span><span style="color:#111">},</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">DisableCompression</span><span style="color:#111">:</span> <span style="color:#00a8c8">true</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">client</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Client</span><span style="color:#111">{</span><span style="color:#75af00">Transport</span><span style="color:#111">:</span> <span style="color:#75af00">tr</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">resp</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">client</span><span style="color:#111">.</span><span style="color:#75af00">Get</span><span style="color:#111">(</span><span style="color:#d88200">&#34;https://example.com&#34;</span><span style="color:#111">)</span>
</span></span></code></pre></div><p>Client和Transport类型都可以安全的被多个goroutine同时使用。出于效率考虑，应该一次建立、尽量重用。</p>
<h2 id="服务端">服务端</h2>
<h3 id="默认的server">默认的Server</h3>
<p>ListenAndServe使用指定的监听地址和处理器启动一个HTTP服务端。处理器参数通常是nil，这表示采用包变量DefaultServeMux作为处理器。</p>
<p>Handle和HandleFunc函数可以向DefaultServeMux添加处理器。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Handle</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/foo&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">fooHandler</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">HandleFunc</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/bar&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">w</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">ResponseWriter</span><span style="color:#111">,</span> <span style="color:#75af00">r</span> <span style="color:#f92672">*</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Request</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Fprintf</span><span style="color:#111">(</span><span style="color:#75af00">w</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Hello, %q&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">html</span><span style="color:#111">.</span><span style="color:#75af00">EscapeString</span><span style="color:#111">(</span><span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">URL</span><span style="color:#111">.</span><span style="color:#75af00">Path</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span><span style="color:#111">})</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Fatal</span><span style="color:#111">(</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">ListenAndServe</span><span style="color:#111">(</span><span style="color:#d88200">&#34;:8080&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span><span style="color:#111">))</span>
</span></span></code></pre></div><h3 id="默认的server示例">默认的Server示例</h3>
<p>使用Go语言中的net/http包来编写一个简单的接收HTTP请求的Server端示例，net/http包是对net包的进一步封装，专门用来处理HTTP协议的数据。具体的代码如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// http server</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">sayHello</span><span style="color:#111">(</span><span style="color:#75af00">w</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">ResponseWriter</span><span style="color:#111">,</span> <span style="color:#75af00">r</span> <span style="color:#f92672">*</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Request</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Fprintln</span><span style="color:#111">(</span><span style="color:#75af00">w</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Hello 沙河！&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">HandleFunc</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">sayHello</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">ListenAndServe</span><span style="color:#111">(</span><span style="color:#d88200">&#34;:9090&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;http server failed, err:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>将上面的代码编译之后执行，打开你电脑上的浏览器在地址栏输入127.0.0.1:9090回车，此时就能够看到如下页面了。<img src="/images/c35e630d-731a-4c19-af21-01ab6838d42f.png" alt=""></p>
<h3 id="自定义server">自定义Server</h3>
<p>要管理服务端的行为，可以创建一个自定义的Server：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">s</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Server</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Addr</span><span style="color:#111">:</span>           <span style="color:#d88200">&#34;:8080&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Handler</span><span style="color:#111">:</span>        <span style="color:#75af00">myHandler</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ReadTimeout</span><span style="color:#111">:</span>    <span style="color:#ae81ff">10</span> <span style="color:#f92672">*</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Second</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">WriteTimeout</span><span style="color:#111">:</span>   <span style="color:#ae81ff">10</span> <span style="color:#f92672">*</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Second</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">MaxHeaderBytes</span><span style="color:#111">:</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">20</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Fatal</span><span style="color:#111">(</span><span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">ListenAndServe</span><span style="color:#111">())</span>
</span></span></code></pre></div><h2 id="参考文章">参考文章</h2>
<ul>
<li><a href="https://www.jianshu.com/p/c90ebdd5d1a1">https://www.jianshu.com/p/c90ebdd5d1a1</a></li>
<li><a href="https://www.liwenzhou.com/posts/Go/go_http/">https://www.liwenzhou.com/posts/Go/go_http/</a></li>
</ul>
]]></content:encoded><category>go</category><category>go</category></item><item><title>nethttp和gin 路由</title><link>https://daemon365.dev/post/go/nethttp_and_gin_routing/</link><pubDate>Mon, 23 Dec 2019 00:00:00 +0800</pubDate><guid>https://daemon365.dev/post/go/nethttp_and_gin_routing/</guid><description>&lt;h2 id="nethttp-路由注册"&gt;net/http 路由注册&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;test1&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;http&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;HandleFunc&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;/&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;func&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;w&lt;/span&gt; &lt;span style="color:#75af00"&gt;http&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;ResponseWriter&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;r&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;http&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Request&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Fprintf&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;w&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;Hello world!&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;})&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;http&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;ListenAndServe&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;:9001&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;!=&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;log&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Fatal&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;ListenAndServer:&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;在使用&lt;code&gt;ListenAndServe&lt;/code&gt;这个方法时，系统就会给我们指派一个路由器，&lt;code&gt;DefaultServeMux&lt;/code&gt;是系统默认使用的路由器，如果&lt;code&gt;ListenAndServe&lt;/code&gt;这个方法的第2个参数传入nil，系统就会默认使用&lt;code&gt;DefaultServeMux&lt;/code&gt;。当然，这里也可以传入自定义的路由器。&lt;/p&gt;
&lt;p&gt;先看&lt;code&gt;http.HandleFunc(&amp;quot;/&amp;quot;, ...)&lt;/code&gt;，从&lt;code&gt;HandleFunc&lt;/code&gt;方法点进去，如下：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;HandleFunc&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;pattern&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;string&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;handler&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;func&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;ResponseWriter&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;Request&lt;/span&gt;&lt;span style="color:#111"&gt;))&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;DefaultServeMux&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;HandleFunc&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;pattern&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;handler&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;在这里调用了&lt;code&gt;DefaultServeMux&lt;/code&gt;的&lt;code&gt;HandleFunc&lt;/code&gt;方法，这个方法有两个参数，&lt;code&gt;pattern&lt;/code&gt;是匹配的路由规则，&lt;code&gt;handler&lt;/code&gt;表示这个路由规则对应的处理方法，并且这个处理方法有两个参数。&lt;/p&gt;
&lt;p&gt;在我们书写的代码示例中，&lt;code&gt;pattern&lt;/code&gt;对应&lt;code&gt;/&lt;/code&gt;，&lt;code&gt;handler&lt;/code&gt;对应&lt;code&gt;sayHello&lt;/code&gt;，当我们在浏览器中输入&lt;code&gt;http://localhost:9001&lt;/code&gt;时，就会触发匿名函数。&lt;/p&gt;
&lt;p&gt;我们再顺着&lt;code&gt;DefaultServeMux&lt;/code&gt;的&lt;code&gt;HandleFunc&lt;/code&gt;方法继续点下去，如下：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;mux&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;ServeMux&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75af00"&gt;HandleFunc&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;pattern&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;string&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;handler&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;func&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;ResponseWriter&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;Request&lt;/span&gt;&lt;span style="color:#111"&gt;))&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;handler&lt;/span&gt; &lt;span style="color:#f92672"&gt;==&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;panic&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;http: nil handler&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;mux&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Handle&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;pattern&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;HandlerFunc&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;handler&lt;/span&gt;&lt;span style="color:#111"&gt;))&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;在这个方法中，路由器又调用了&lt;code&gt;Handle&lt;/code&gt;方法，注意这个&lt;code&gt;Handle&lt;/code&gt;方法的第2个参数，将之前传入的&lt;code&gt;handler&lt;/code&gt;这个响应方法强制转换成了&lt;code&gt;HandlerFunc&lt;/code&gt;类型。&lt;/p&gt;
&lt;p&gt;这个&lt;code&gt;HandlerFunc&lt;/code&gt;类型到底是个什么呢？如下：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;type&lt;/span&gt; &lt;span style="color:#75af00"&gt;HandlerFunc&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;func&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;ResponseWriter&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;Request&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;看来和我们定义的&amp;quot;/&amp;ldquo;的匿名函数的类型都差不多。但是！！！ 这个&lt;code&gt;HandlerFunc&lt;/code&gt;默认实现了&lt;code&gt;ServeHTTP&lt;/code&gt;接口！这样&lt;code&gt;HandlerFunc&lt;/code&gt;对象就有了&lt;code&gt;ServeHTTP&lt;/code&gt;方法！如下：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;// ServeHTTP calls f(w, r).&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;f&lt;/span&gt; &lt;span style="color:#75af00"&gt;HandlerFunc&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75af00"&gt;ServeHTTP&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;w&lt;/span&gt; &lt;span style="color:#75af00"&gt;ResponseWriter&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;r&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;Request&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;f&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;w&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;r&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;接下来，我们返回去继续看&lt;code&gt;mux&lt;/code&gt;的&lt;code&gt;Handle&lt;/code&gt;方法，也就是这段代码&lt;code&gt;mux.Handle(pattern, HandlerFunc(handler))&lt;/code&gt;。这段代码做了哪些事呢？源码如下&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;// Handle registers the handler for the given pattern.&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;// If a handler already exists for pattern, Handle panics.&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;mux&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;ServeMux&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75af00"&gt;Handle&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;pattern&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;string&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;handler&lt;/span&gt; &lt;span style="color:#75af00"&gt;Handler&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;mux&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;mu&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Lock&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;defer&lt;/span&gt; &lt;span style="color:#75af00"&gt;mux&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;mu&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Unlock&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;pattern&lt;/span&gt; &lt;span style="color:#f92672"&gt;==&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;&amp;#34;&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;panic&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;http: invalid pattern&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;handler&lt;/span&gt; &lt;span style="color:#f92672"&gt;==&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;panic&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;http: nil handler&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;_&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;exist&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;mux&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;m&lt;/span&gt;&lt;span style="color:#111"&gt;[&lt;/span&gt;&lt;span style="color:#75af00"&gt;pattern&lt;/span&gt;&lt;span style="color:#111"&gt;];&lt;/span&gt; &lt;span style="color:#75af00"&gt;exist&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;panic&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;http: multiple registrations for &amp;#34;&lt;/span&gt; &lt;span style="color:#f92672"&gt;+&lt;/span&gt; &lt;span style="color:#75af00"&gt;pattern&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;mux&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;m&lt;/span&gt; &lt;span style="color:#f92672"&gt;==&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;mux&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;m&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#111"&gt;make&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;map&lt;/span&gt;&lt;span style="color:#111"&gt;[&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;string&lt;/span&gt;&lt;span style="color:#111"&gt;]&lt;/span&gt;&lt;span style="color:#75af00"&gt;muxEntry&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;e&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;muxEntry&lt;/span&gt;&lt;span style="color:#111"&gt;{&lt;/span&gt;&lt;span style="color:#75af00"&gt;h&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#75af00"&gt;handler&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;pattern&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#75af00"&gt;pattern&lt;/span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;mux&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;m&lt;/span&gt;&lt;span style="color:#111"&gt;[&lt;/span&gt;&lt;span style="color:#75af00"&gt;pattern&lt;/span&gt;&lt;span style="color:#111"&gt;]&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#75af00"&gt;e&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;pattern&lt;/span&gt;&lt;span style="color:#111"&gt;[&lt;/span&gt;&lt;span style="color:#111"&gt;len&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;pattern&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;&lt;span style="color:#f92672"&gt;-&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;1&lt;/span&gt;&lt;span style="color:#111"&gt;]&lt;/span&gt; &lt;span style="color:#f92672"&gt;==&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#39;/&amp;#39;&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;mux&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;es&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#75af00"&gt;appendSorted&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;mux&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;es&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;e&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;pattern&lt;/span&gt;&lt;span style="color:#111"&gt;[&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;0&lt;/span&gt;&lt;span style="color:#111"&gt;]&lt;/span&gt; &lt;span style="color:#f92672"&gt;!=&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#39;/&amp;#39;&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;mux&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;hosts&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;true&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;主要就做了一件事，向&lt;code&gt;DefaultServeMux&lt;/code&gt;的&lt;code&gt;map[string]muxEntry&lt;/code&gt;中增加对应的路由规则和&lt;code&gt;handler&lt;/code&gt;。&lt;/p&gt;</description><content:encoded><![CDATA[<h2 id="nethttp-路由注册">net/http 路由注册</h2>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">test1</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">HandleFunc</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">w</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">ResponseWriter</span><span style="color:#111">,</span> <span style="color:#75af00">r</span> <span style="color:#f92672">*</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Request</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Fprintf</span><span style="color:#111">(</span><span style="color:#75af00">w</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Hello world!&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">ListenAndServe</span><span style="color:#111">(</span><span style="color:#d88200">&#34;:9001&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Fatal</span><span style="color:#111">(</span><span style="color:#d88200">&#34;ListenAndServer:&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>在使用<code>ListenAndServe</code>这个方法时，系统就会给我们指派一个路由器，<code>DefaultServeMux</code>是系统默认使用的路由器，如果<code>ListenAndServe</code>这个方法的第2个参数传入nil，系统就会默认使用<code>DefaultServeMux</code>。当然，这里也可以传入自定义的路由器。</p>
<p>先看<code>http.HandleFunc(&quot;/&quot;, ...)</code>，从<code>HandleFunc</code>方法点进去，如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">HandleFunc</span><span style="color:#111">(</span><span style="color:#75af00">pattern</span> <span style="color:#00a8c8">string</span><span style="color:#111">,</span> <span style="color:#75af00">handler</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">ResponseWriter</span><span style="color:#111">,</span> <span style="color:#f92672">*</span><span style="color:#75af00">Request</span><span style="color:#111">))</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">DefaultServeMux</span><span style="color:#111">.</span><span style="color:#75af00">HandleFunc</span><span style="color:#111">(</span><span style="color:#75af00">pattern</span><span style="color:#111">,</span> <span style="color:#75af00">handler</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>在这里调用了<code>DefaultServeMux</code>的<code>HandleFunc</code>方法，这个方法有两个参数，<code>pattern</code>是匹配的路由规则，<code>handler</code>表示这个路由规则对应的处理方法，并且这个处理方法有两个参数。</p>
<p>在我们书写的代码示例中，<code>pattern</code>对应<code>/</code>，<code>handler</code>对应<code>sayHello</code>，当我们在浏览器中输入<code>http://localhost:9001</code>时，就会触发匿名函数。</p>
<p>我们再顺着<code>DefaultServeMux</code>的<code>HandleFunc</code>方法继续点下去，如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">mux</span> <span style="color:#f92672">*</span><span style="color:#75af00">ServeMux</span><span style="color:#111">)</span> <span style="color:#75af00">HandleFunc</span><span style="color:#111">(</span><span style="color:#75af00">pattern</span> <span style="color:#00a8c8">string</span><span style="color:#111">,</span> <span style="color:#75af00">handler</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">ResponseWriter</span><span style="color:#111">,</span> <span style="color:#f92672">*</span><span style="color:#75af00">Request</span><span style="color:#111">))</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">handler</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#d88200">&#34;http: nil handler&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">Handle</span><span style="color:#111">(</span><span style="color:#75af00">pattern</span><span style="color:#111">,</span> <span style="color:#75af00">HandlerFunc</span><span style="color:#111">(</span><span style="color:#75af00">handler</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>在这个方法中，路由器又调用了<code>Handle</code>方法，注意这个<code>Handle</code>方法的第2个参数，将之前传入的<code>handler</code>这个响应方法强制转换成了<code>HandlerFunc</code>类型。</p>
<p>这个<code>HandlerFunc</code>类型到底是个什么呢？如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">HandlerFunc</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">ResponseWriter</span><span style="color:#111">,</span> <span style="color:#f92672">*</span><span style="color:#75af00">Request</span><span style="color:#111">)</span>
</span></span></code></pre></div><p>看来和我们定义的&quot;/&ldquo;的匿名函数的类型都差不多。但是！！！ 这个<code>HandlerFunc</code>默认实现了<code>ServeHTTP</code>接口！这样<code>HandlerFunc</code>对象就有了<code>ServeHTTP</code>方法！如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// ServeHTTP calls f(w, r).</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">f</span> <span style="color:#75af00">HandlerFunc</span><span style="color:#111">)</span> <span style="color:#75af00">ServeHTTP</span><span style="color:#111">(</span><span style="color:#75af00">w</span> <span style="color:#75af00">ResponseWriter</span><span style="color:#111">,</span> <span style="color:#75af00">r</span> <span style="color:#f92672">*</span><span style="color:#75af00">Request</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">f</span><span style="color:#111">(</span><span style="color:#75af00">w</span><span style="color:#111">,</span> <span style="color:#75af00">r</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>接下来，我们返回去继续看<code>mux</code>的<code>Handle</code>方法，也就是这段代码<code>mux.Handle(pattern, HandlerFunc(handler))</code>。这段代码做了哪些事呢？源码如下</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// Handle registers the handler for the given pattern.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// If a handler already exists for pattern, Handle panics.</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">mux</span> <span style="color:#f92672">*</span><span style="color:#75af00">ServeMux</span><span style="color:#111">)</span> <span style="color:#75af00">Handle</span><span style="color:#111">(</span><span style="color:#75af00">pattern</span> <span style="color:#00a8c8">string</span><span style="color:#111">,</span> <span style="color:#75af00">handler</span> <span style="color:#75af00">Handler</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">Lock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">defer</span> <span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">Unlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">pattern</span> <span style="color:#f92672">==</span> <span style="color:#d88200">&#34;&#34;</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#d88200">&#34;http: invalid pattern&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">handler</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#d88200">&#34;http: nil handler&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">exist</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">m</span><span style="color:#111">[</span><span style="color:#75af00">pattern</span><span style="color:#111">];</span> <span style="color:#75af00">exist</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#d88200">&#34;http: multiple registrations for &#34;</span> <span style="color:#f92672">+</span> <span style="color:#75af00">pattern</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">m</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">m</span> <span style="color:#111">=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#00a8c8">string</span><span style="color:#111">]</span><span style="color:#75af00">muxEntry</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">e</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">muxEntry</span><span style="color:#111">{</span><span style="color:#75af00">h</span><span style="color:#111">:</span> <span style="color:#75af00">handler</span><span style="color:#111">,</span> <span style="color:#75af00">pattern</span><span style="color:#111">:</span> <span style="color:#75af00">pattern</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">m</span><span style="color:#111">[</span><span style="color:#75af00">pattern</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#75af00">e</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">pattern</span><span style="color:#111">[</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">pattern</span><span style="color:#111">)</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">]</span> <span style="color:#f92672">==</span> <span style="color:#d88200">&#39;/&#39;</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">es</span> <span style="color:#111">=</span> <span style="color:#75af00">appendSorted</span><span style="color:#111">(</span><span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">es</span><span style="color:#111">,</span> <span style="color:#75af00">e</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">pattern</span><span style="color:#111">[</span><span style="color:#ae81ff">0</span><span style="color:#111">]</span> <span style="color:#f92672">!=</span> <span style="color:#d88200">&#39;/&#39;</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">hosts</span> <span style="color:#111">=</span> <span style="color:#00a8c8">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>主要就做了一件事，向<code>DefaultServeMux</code>的<code>map[string]muxEntry</code>中增加对应的路由规则和<code>handler</code>。</p>
<p><code>map[string]muxEntry</code>是个什么鬼？</p>
<ul>
<li><code>map</code>是一个字典对象，它保存的是<code>key-value</code>。</li>
<li><code>[string]</code>表示这个字典的<code>key</code>是<code>string</code>类型的，这个<code>key</code>值会保存我们的路由规则。</li>
<li><code>muxEntry</code>是一个实例对象，这个对象内保存了路由规则对应的处理方法。</li>
<li><code>mux.es</code> 为模糊匹配 有长倒短排序 比如有路由<code>/hello/</code> 访问<code>/hello/world</code> 时没有路由 会落到<code>/hello/</code>上</li>
</ul>
<p>找到相应代码，如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// 路由器</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">ServeMux</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">mu</span>    <span style="color:#75af00">sync</span><span style="color:#111">.</span><span style="color:#75af00">RWMutex</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">m</span>     <span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#00a8c8">string</span><span style="color:#111">]</span><span style="color:#75af00">muxEntry</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">es</span>    <span style="color:#111">[]</span><span style="color:#75af00">muxEntry</span> <span style="color:#75715e">// slice of entries sorted from longest to shortest.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">hosts</span> <span style="color:#00a8c8">bool</span>       <span style="color:#75715e">// whether any patterns contain hostnames</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">muxEntry</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">h</span>       <span style="color:#75af00">Handler</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">pattern</span> <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 路由响应方法</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Handler</span> <span style="color:#00a8c8">interface</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">ServeHTTP</span><span style="color:#111">(</span><span style="color:#75af00">ResponseWriter</span><span style="color:#111">,</span> <span style="color:#f92672">*</span><span style="color:#75af00">Request</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="nethttp-运行">net/http 运行</h2>
<p>第二部分主要就是研究这句代码<code>err := http.ListenAndServe(&quot;:9001&quot;,nil)</code>，也就是<code>ListenAndServe</code>这个方法。从这个方法点进去，如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">ListenAndServe</span><span style="color:#111">(</span><span style="color:#75af00">addr</span> <span style="color:#00a8c8">string</span><span style="color:#111">,</span> <span style="color:#75af00">handler</span> <span style="color:#75af00">Handler</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">server</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">Server</span><span style="color:#111">{</span><span style="color:#75af00">Addr</span><span style="color:#111">:</span> <span style="color:#75af00">addr</span><span style="color:#111">,</span> <span style="color:#75af00">Handler</span><span style="color:#111">:</span> <span style="color:#75af00">handler</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#75af00">server</span><span style="color:#111">.</span><span style="color:#75af00">ListenAndServe</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>在这个方法中，初始化了一个<code>server</code>对象，然后调用这个<code>server</code>对象的<code>ListenAndServe</code>方法，在这个方法中，如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">srv</span> <span style="color:#f92672">*</span><span style="color:#75af00">Server</span><span style="color:#111">)</span> <span style="color:#75af00">ListenAndServe</span><span style="color:#111">()</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">srv</span><span style="color:#111">.</span><span style="color:#75af00">shuttingDown</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">ErrServerClosed</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">addr</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">srv</span><span style="color:#111">.</span><span style="color:#75af00">Addr</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">addr</span> <span style="color:#f92672">==</span> <span style="color:#d88200">&#34;&#34;</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">addr</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;:http&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">ln</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">net</span><span style="color:#111">.</span><span style="color:#75af00">Listen</span><span style="color:#111">(</span><span style="color:#d88200">&#34;tcp&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">addr</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#75af00">srv</span><span style="color:#111">.</span><span style="color:#75af00">Serve</span><span style="color:#111">(</span><span style="color:#75af00">ln</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>在这个方法中，调用了<code>net.Listen(&quot;tcp&quot;, addr)</code>，也就是底层用TCP协议搭建了一个服务，然后监控我们设置的端口。</p>
<p>代码的最后，调用了<code>srv</code>的<code>Serve</code>方法，如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">srv</span> <span style="color:#f92672">*</span><span style="color:#75af00">Server</span><span style="color:#111">)</span> <span style="color:#75af00">Serve</span><span style="color:#111">(</span><span style="color:#75af00">l</span> <span style="color:#75af00">net</span><span style="color:#111">.</span><span style="color:#75af00">Listener</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">fn</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">testHookServerServe</span><span style="color:#111">;</span> <span style="color:#75af00">fn</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">fn</span><span style="color:#111">(</span><span style="color:#75af00">srv</span><span style="color:#111">,</span> <span style="color:#75af00">l</span><span style="color:#111">)</span> <span style="color:#75715e">// call hook with unwrapped listener</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">origListener</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">l</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">l</span> <span style="color:#111">=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">onceCloseListener</span><span style="color:#111">{</span><span style="color:#75af00">Listener</span><span style="color:#111">:</span> <span style="color:#75af00">l</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">defer</span> <span style="color:#75af00">l</span><span style="color:#111">.</span><span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">srv</span><span style="color:#111">.</span><span style="color:#75af00">setupHTTP2_Serve</span><span style="color:#111">();</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">srv</span><span style="color:#111">.</span><span style="color:#75af00">trackListener</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">l</span><span style="color:#111">,</span> <span style="color:#00a8c8">true</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">ErrServerClosed</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">defer</span> <span style="color:#75af00">srv</span><span style="color:#111">.</span><span style="color:#75af00">trackListener</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">l</span><span style="color:#111">,</span> <span style="color:#00a8c8">false</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">baseCtx</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Background</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">srv</span><span style="color:#111">.</span><span style="color:#75af00">BaseContext</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">baseCtx</span> <span style="color:#111">=</span> <span style="color:#75af00">srv</span><span style="color:#111">.</span><span style="color:#75af00">BaseContext</span><span style="color:#111">(</span><span style="color:#75af00">origListener</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#75af00">baseCtx</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#d88200">&#34;BaseContext returned a nil context&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">var</span> <span style="color:#75af00">tempDelay</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Duration</span> <span style="color:#75715e">// how long to sleep on accept failure</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">ctx</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">WithValue</span><span style="color:#111">(</span><span style="color:#75af00">baseCtx</span><span style="color:#111">,</span> <span style="color:#75af00">ServerContextKey</span><span style="color:#111">,</span> <span style="color:#75af00">srv</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">for</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">rw</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">l</span><span style="color:#111">.</span><span style="color:#75af00">Accept</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">select</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#75af00">srv</span><span style="color:#111">.</span><span style="color:#75af00">getDoneChan</span><span style="color:#111">():</span>
</span></span><span style="display:flex;"><span>                <span style="color:#00a8c8">return</span> <span style="color:#75af00">ErrServerClosed</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">default</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">if</span> <span style="color:#75af00">ne</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">err</span><span style="color:#111">.(</span><span style="color:#75af00">net</span><span style="color:#111">.</span><span style="color:#75af00">Error</span><span style="color:#111">);</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">ne</span><span style="color:#111">.</span><span style="color:#75af00">Temporary</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#00a8c8">if</span> <span style="color:#75af00">tempDelay</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#75af00">tempDelay</span> <span style="color:#111">=</span> <span style="color:#ae81ff">5</span> <span style="color:#f92672">*</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Millisecond</span>
</span></span><span style="display:flex;"><span>                <span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#75af00">tempDelay</span> <span style="color:#f92672">*=</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>                <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#00a8c8">if</span> <span style="color:#75af00">max</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">*</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Second</span><span style="color:#111">;</span> <span style="color:#75af00">tempDelay</span> <span style="color:#111">&gt;</span> <span style="color:#75af00">max</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#75af00">tempDelay</span> <span style="color:#111">=</span> <span style="color:#75af00">max</span>
</span></span><span style="display:flex;"><span>                <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75af00">srv</span><span style="color:#111">.</span><span style="color:#75af00">logf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;http: Accept error: %v; retrying in %v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#75af00">tempDelay</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Sleep</span><span style="color:#111">(</span><span style="color:#75af00">tempDelay</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#00a8c8">continue</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">connCtx</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">ctx</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#75af00">cc</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">srv</span><span style="color:#111">.</span><span style="color:#75af00">ConnContext</span><span style="color:#111">;</span> <span style="color:#75af00">cc</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75af00">connCtx</span> <span style="color:#111">=</span> <span style="color:#75af00">cc</span><span style="color:#111">(</span><span style="color:#75af00">connCtx</span><span style="color:#111">,</span> <span style="color:#75af00">rw</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">if</span> <span style="color:#75af00">connCtx</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#d88200">&#34;ConnContext returned nil&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">tempDelay</span> <span style="color:#111">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">c</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">srv</span><span style="color:#111">.</span><span style="color:#75af00">newConn</span><span style="color:#111">(</span><span style="color:#75af00">rw</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">setState</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">rwc</span><span style="color:#111">,</span> <span style="color:#75af00">StateNew</span><span style="color:#111">,</span> <span style="color:#75af00">runHooks</span><span style="color:#111">)</span> <span style="color:#75715e">// before Serve can return</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">go</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">serve</span><span style="color:#111">(</span><span style="color:#75af00">connCtx</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>最后3段代码比较重要，也是Go语言支持高并发的体现，如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">c</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">srv</span><span style="color:#111">.</span><span style="color:#75af00">newConn</span><span style="color:#111">(</span><span style="color:#75af00">rw</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">setState</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">rwc</span><span style="color:#111">,</span> <span style="color:#75af00">StateNew</span><span style="color:#111">,</span> <span style="color:#75af00">runHooks</span><span style="color:#111">)</span> <span style="color:#75715e">// before Serve can return</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">go</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">serve</span><span style="color:#111">(</span><span style="color:#75af00">connCtx</span><span style="color:#111">)</span>
</span></span></code></pre></div><p>上面那一大坨代码，总体意思是进入方法后，首先开了一个<code>for</code>循环，在<code>for</code>循环内时刻Accept请求，请求来了之后，会为每个请求创建一个<code>Conn</code>，然后单独开启一个<code>goroutine</code>，把这个请求的数据当做参数扔给这个<code>Conn</code>去服务：<code>go c.serve()</code>。用户的每一次请求都是在一个新的<code>goroutine</code>去服务，每个请求间相互不影响。</p>
<p>在<code>conn</code>的<code>serve</code>方法中，有一句代码很重要，如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">serverHandler</span><span style="color:#111">{</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">server</span><span style="color:#111">}.</span><span style="color:#75af00">ServeHTTP</span><span style="color:#111">(</span><span style="color:#75af00">w</span><span style="color:#111">,</span> <span style="color:#75af00">w</span><span style="color:#111">.</span><span style="color:#75af00">req</span><span style="color:#111">)</span>
</span></span></code></pre></div><p>表示<code>serverHandler</code>也实现了<code>ServeHTTP</code>接口，<code>ServeHTTP</code>方法实现如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">sh</span> <span style="color:#75af00">serverHandler</span><span style="color:#111">)</span> <span style="color:#75af00">ServeHTTP</span><span style="color:#111">(</span><span style="color:#75af00">rw</span> <span style="color:#75af00">ResponseWriter</span><span style="color:#111">,</span> <span style="color:#75af00">req</span> <span style="color:#f92672">*</span><span style="color:#75af00">Request</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">handler</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">sh</span><span style="color:#111">.</span><span style="color:#75af00">srv</span><span style="color:#111">.</span><span style="color:#75af00">Handler</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">handler</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">handler</span> <span style="color:#111">=</span> <span style="color:#75af00">DefaultServeMux</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">req</span><span style="color:#111">.</span><span style="color:#75af00">RequestURI</span> <span style="color:#f92672">==</span> <span style="color:#d88200">&#34;*&#34;</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">req</span><span style="color:#111">.</span><span style="color:#75af00">Method</span> <span style="color:#f92672">==</span> <span style="color:#d88200">&#34;OPTIONS&#34;</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">handler</span> <span style="color:#111">=</span> <span style="color:#75af00">globalOptionsHandler</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">req</span><span style="color:#111">.</span><span style="color:#75af00">URL</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">strings</span><span style="color:#111">.</span><span style="color:#75af00">Contains</span><span style="color:#111">(</span><span style="color:#75af00">req</span><span style="color:#111">.</span><span style="color:#75af00">URL</span><span style="color:#111">.</span><span style="color:#75af00">RawQuery</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;;&#34;</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">var</span> <span style="color:#75af00">allowQuerySemicolonsInUse</span> <span style="color:#00a8c8">int32</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">req</span> <span style="color:#111">=</span> <span style="color:#75af00">req</span><span style="color:#111">.</span><span style="color:#75af00">WithContext</span><span style="color:#111">(</span><span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">WithValue</span><span style="color:#111">(</span><span style="color:#75af00">req</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">(),</span> <span style="color:#75af00">silenceSemWarnContextKey</span><span style="color:#111">,</span> <span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75af00">atomic</span><span style="color:#111">.</span><span style="color:#75af00">StoreInt32</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">allowQuerySemicolonsInUse</span><span style="color:#111">,</span> <span style="color:#ae81ff">1</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}))</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">defer</span> <span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">if</span> <span style="color:#75af00">atomic</span><span style="color:#111">.</span><span style="color:#75af00">LoadInt32</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">allowQuerySemicolonsInUse</span><span style="color:#111">)</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75af00">sh</span><span style="color:#111">.</span><span style="color:#75af00">srv</span><span style="color:#111">.</span><span style="color:#75af00">logf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;http: URL query contains semicolon, which is no longer a supported separator; parts of the query may be stripped when parsed; see golang.org/issue/25192&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">handler</span><span style="color:#111">.</span><span style="color:#75af00">ServeHTTP</span><span style="color:#111">(</span><span style="color:#75af00">rw</span><span style="color:#111">,</span> <span style="color:#75af00">req</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>在这里如果<code>handler</code>为空（这个<code>handler</code>就可以理解为是我们自定义的路由器），就会使用系统默认的<code>DefaultServeMux</code>，代码的最后调用了<code>DefaultServeMux</code>的<code>ServeHTTP()</code></p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">mux</span> <span style="color:#f92672">*</span><span style="color:#75af00">ServeMux</span><span style="color:#111">)</span> <span style="color:#75af00">ServeHTTP</span><span style="color:#111">(</span><span style="color:#75af00">w</span> <span style="color:#75af00">ResponseWriter</span><span style="color:#111">,</span> <span style="color:#75af00">r</span> <span style="color:#f92672">*</span><span style="color:#75af00">Request</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">RequestURI</span> <span style="color:#f92672">==</span> <span style="color:#d88200">&#34;*&#34;</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">ProtoAtLeast</span><span style="color:#111">(</span><span style="color:#ae81ff">1</span><span style="color:#111">,</span> <span style="color:#ae81ff">1</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75af00">w</span><span style="color:#111">.</span><span style="color:#75af00">Header</span><span style="color:#111">().</span><span style="color:#75af00">Set</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Connection&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;close&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">w</span><span style="color:#111">.</span><span style="color:#75af00">WriteHeader</span><span style="color:#111">(</span><span style="color:#75af00">StatusBadRequest</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">h</span><span style="color:#111">,</span> <span style="color:#75af00">_</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">Handler</span><span style="color:#111">(</span><span style="color:#75af00">r</span><span style="color:#111">)</span>  <span style="color:#75715e">//这里返回的h是Handler接口对象</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">ServeHTTP</span><span style="color:#111">(</span><span style="color:#75af00">w</span><span style="color:#111">,</span> <span style="color:#75af00">r</span><span style="color:#111">)</span>  <span style="color:#75715e">//调用Handler接口对象的ServeHTTP方法实际上就调用了我们定义的sayHello方法</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">mux</span> <span style="color:#f92672">*</span><span style="color:#75af00">ServeMux</span><span style="color:#111">)</span> <span style="color:#75af00">Handler</span><span style="color:#111">(</span><span style="color:#75af00">r</span> <span style="color:#f92672">*</span><span style="color:#75af00">Request</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#75af00">h</span> <span style="color:#75af00">Handler</span><span style="color:#111">,</span> <span style="color:#75af00">pattern</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// CONNECT requests are not canonicalized.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">Method</span> <span style="color:#f92672">==</span> <span style="color:#d88200">&#34;CONNECT&#34;</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// If r.URL.Path is /tree and its handler is not registered,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// the /tree -&gt; /tree/ redirect applies to CONNECT requests</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// but the path canonicalization does not.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#75af00">u</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">redirectToPathSlash</span><span style="color:#111">(</span><span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">URL</span><span style="color:#111">.</span><span style="color:#75af00">Host</span><span style="color:#111">,</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">URL</span><span style="color:#111">.</span><span style="color:#75af00">Path</span><span style="color:#111">,</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">URL</span><span style="color:#111">);</span> <span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">return</span> <span style="color:#75af00">RedirectHandler</span><span style="color:#111">(</span><span style="color:#75af00">u</span><span style="color:#111">.</span><span style="color:#75af00">String</span><span style="color:#111">(),</span> <span style="color:#75af00">StatusMovedPermanently</span><span style="color:#111">),</span> <span style="color:#75af00">u</span><span style="color:#111">.</span><span style="color:#75af00">Path</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">handler</span><span style="color:#111">(</span><span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">Host</span><span style="color:#111">,</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">URL</span><span style="color:#111">.</span><span style="color:#75af00">Path</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// All other requests have any port stripped and path cleaned</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// before passing to mux.handler.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">host</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">stripHostPort</span><span style="color:#111">(</span><span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">Host</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">path</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">cleanPath</span><span style="color:#111">(</span><span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">URL</span><span style="color:#111">.</span><span style="color:#75af00">Path</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// If the given path is /tree and its handler is not registered,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// redirect for /tree/.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">u</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">redirectToPathSlash</span><span style="color:#111">(</span><span style="color:#75af00">host</span><span style="color:#111">,</span> <span style="color:#75af00">path</span><span style="color:#111">,</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">URL</span><span style="color:#111">);</span> <span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">RedirectHandler</span><span style="color:#111">(</span><span style="color:#75af00">u</span><span style="color:#111">.</span><span style="color:#75af00">String</span><span style="color:#111">(),</span> <span style="color:#75af00">StatusMovedPermanently</span><span style="color:#111">),</span> <span style="color:#75af00">u</span><span style="color:#111">.</span><span style="color:#75af00">Path</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">path</span> <span style="color:#f92672">!=</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">URL</span><span style="color:#111">.</span><span style="color:#75af00">Path</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">pattern</span> <span style="color:#111">=</span> <span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">handler</span><span style="color:#111">(</span><span style="color:#75af00">host</span><span style="color:#111">,</span> <span style="color:#75af00">path</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">u</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">url</span><span style="color:#111">.</span><span style="color:#75af00">URL</span><span style="color:#111">{</span><span style="color:#75af00">Path</span><span style="color:#111">:</span> <span style="color:#75af00">path</span><span style="color:#111">,</span> <span style="color:#75af00">RawQuery</span><span style="color:#111">:</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">URL</span><span style="color:#111">.</span><span style="color:#75af00">RawQuery</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">RedirectHandler</span><span style="color:#111">(</span><span style="color:#75af00">u</span><span style="color:#111">.</span><span style="color:#75af00">String</span><span style="color:#111">(),</span> <span style="color:#75af00">StatusMovedPermanently</span><span style="color:#111">),</span> <span style="color:#75af00">pattern</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">handler</span><span style="color:#111">(</span><span style="color:#75af00">host</span><span style="color:#111">,</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">URL</span><span style="color:#111">.</span><span style="color:#75af00">Path</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">mux</span> <span style="color:#f92672">*</span><span style="color:#75af00">ServeMux</span><span style="color:#111">)</span> <span style="color:#75af00">handler</span><span style="color:#111">(</span><span style="color:#75af00">host</span><span style="color:#111">,</span> <span style="color:#75af00">path</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#75af00">h</span> <span style="color:#75af00">Handler</span><span style="color:#111">,</span> <span style="color:#75af00">pattern</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">RLock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">defer</span> <span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">RUnlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Host-specific pattern takes precedence over generic ones</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">hosts</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">h</span><span style="color:#111">,</span> <span style="color:#75af00">pattern</span> <span style="color:#111">=</span> <span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">match</span><span style="color:#111">(</span><span style="color:#75af00">host</span> <span style="color:#f92672">+</span> <span style="color:#75af00">path</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">h</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">h</span><span style="color:#111">,</span> <span style="color:#75af00">pattern</span> <span style="color:#111">=</span> <span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">match</span><span style="color:#111">(</span><span style="color:#75af00">path</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">h</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">h</span><span style="color:#111">,</span> <span style="color:#75af00">pattern</span> <span style="color:#111">=</span> <span style="color:#75af00">NotFoundHandler</span><span style="color:#111">(),</span> <span style="color:#d88200">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">mux</span> <span style="color:#f92672">*</span><span style="color:#75af00">ServeMux</span><span style="color:#111">)</span> <span style="color:#75af00">match</span><span style="color:#111">(</span><span style="color:#75af00">path</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#75af00">h</span> <span style="color:#75af00">Handler</span><span style="color:#111">,</span> <span style="color:#75af00">pattern</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Check for exact match first.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">v</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">m</span><span style="color:#111">[</span><span style="color:#75af00">path</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">v</span><span style="color:#111">.</span><span style="color:#75af00">h</span><span style="color:#111">,</span> <span style="color:#75af00">v</span><span style="color:#111">.</span><span style="color:#75af00">pattern</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Check for longest valid match.  mux.es contains all patterns</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// that end in / sorted from longest to shortest.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">e</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">es</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#75af00">strings</span><span style="color:#111">.</span><span style="color:#75af00">HasPrefix</span><span style="color:#111">(</span><span style="color:#75af00">path</span><span style="color:#111">,</span> <span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">pattern</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">return</span> <span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">h</span><span style="color:#111">,</span> <span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">pattern</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>它会根据用户请求的<code>URL</code>到路由器里面存储的<code>map</code>中匹配，匹配成功就会返回存储的<code>handler</code>，调用这个<code>handler</code>的<code>ServeHTTP()</code>就可以执行到相应的处理方法了，这个处理方法实际上就是我们刚开始定义的<code>sayHello()</code>，只不过这个<code>sayHello()</code>被<code>HandlerFunc</code>又包了一层，因为<code>HandlerFunc</code>实现了<code>ServeHTTP</code>接口，所以在调用<code>HandlerFunc</code>对象的<code>ServeHTTP()</code>时，实际上在<code>ServeHTTP ()</code>的内部调用了我们的<code>sayHello()</code>。</p>
<h2 id="总结">总结</h2>
<ol>
<li>调用<code>http.ListenAndServe(&quot;:9090&quot;,nil)</code></li>
<li>实例化<code>server</code></li>
<li>调用<code>server</code>的<code>ListenAndServe()</code></li>
<li>调用<code>server</code>的<code>Serve</code>方法，开启<code>for</code>循环，在循环中Accept请求</li>
<li>对每一个请求实例化一个<code>Conn</code>，并且开启一个<code>goroutine</code>为这个请求进行服务<code>go c.serve()</code></li>
<li>读取每个请求的内容<code>c.readRequest()</code></li>
<li>调用<code>serverHandler</code>的<code>ServeHTTP()</code>，如果<code>handler</code>为空，就把<code>handler</code>设置为系统默认的路由器<code>DefaultServeMux</code></li>
<li>调用<code>handler</code>的<code>ServeHTTP()</code> =&gt;实际上是调用了<code>DefaultServeMux</code>的<code>ServeHTTP()</code></li>
<li>在<code>ServeHTTP()</code>中会调用路由对应处理<code>handler</code></li>
<li>在路由对应处理<code>handler</code>中会执行<code>sayHello()</code></li>
</ol>
<p>有一个需要注意的点： <code>DefaultServeMux</code>和路由对应的处理方法<code>handler</code>都实现了<code>ServeHTTP</code>接口，他们俩都有<code>ServeHTTP</code>方法，但是方法要达到的目的不同，在<code>DefaultServeMux</code>的<code>ServeHttp()</code>里会执行路由对应的处理<code>handler</code>的<code>ServeHttp()</code>。</p>
<h2 id="自定义个简单的路由">自定义个简单的路由</h2>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">mux</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d88200">&#34;net/http&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d88200">&#34;strings&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">muxEntry</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">h</span> <span style="color:#75af00">TesthandleFunc</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">TesthandleFunc</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">ResponseWriter</span><span style="color:#111">,</span> <span style="color:#f92672">*</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Request</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">TestHandler</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">routes</span> <span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#00a8c8">string</span><span style="color:#111">]</span><span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#00a8c8">string</span><span style="color:#111">]</span><span style="color:#75af00">muxEntry</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">h</span> <span style="color:#f92672">*</span><span style="color:#75af00">TestHandler</span><span style="color:#111">)</span> <span style="color:#75af00">ServeHTTP</span><span style="color:#111">(</span><span style="color:#75af00">w</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">ResponseWriter</span><span style="color:#111">,</span> <span style="color:#75af00">r</span> <span style="color:#f92672">*</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Request</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">method</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">strings</span><span style="color:#111">.</span><span style="color:#75af00">ToUpper</span><span style="color:#111">(</span><span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">Method</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">path</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">URL</span><span style="color:#111">.</span><span style="color:#75af00">Path</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">route</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">routes</span><span style="color:#111">[</span><span style="color:#75af00">method</span><span style="color:#111">];</span> <span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#75af00">entry</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">route</span><span style="color:#111">[</span><span style="color:#75af00">path</span><span style="color:#111">];</span> <span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75af00">entry</span><span style="color:#111">.</span><span style="color:#75af00">h</span><span style="color:#111">(</span><span style="color:#75af00">w</span><span style="color:#111">,</span> <span style="color:#75af00">r</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">w</span><span style="color:#111">.</span><span style="color:#75af00">WriteHeader</span><span style="color:#111">(</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">StatusNotFound</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">Newhandler</span><span style="color:#111">()</span> <span style="color:#f92672">*</span><span style="color:#75af00">TestHandler</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">TestHandler</span><span style="color:#111">{</span><span style="color:#75af00">routes</span><span style="color:#111">:</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#00a8c8">string</span><span style="color:#111">]</span><span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#00a8c8">string</span><span style="color:#111">]</span><span style="color:#75af00">muxEntry</span><span style="color:#111">)}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">h</span> <span style="color:#f92672">*</span><span style="color:#75af00">TestHandler</span><span style="color:#111">)</span> <span style="color:#75af00">Handle</span><span style="color:#111">(</span><span style="color:#75af00">method</span><span style="color:#111">,</span> <span style="color:#75af00">path</span> <span style="color:#00a8c8">string</span><span style="color:#111">,</span> <span style="color:#75af00">handler</span> <span style="color:#75af00">TesthandleFunc</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">method</span> <span style="color:#111">=</span> <span style="color:#75af00">strings</span><span style="color:#111">.</span><span style="color:#75af00">ToUpper</span><span style="color:#111">(</span><span style="color:#75af00">method</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">routes</span><span style="color:#111">[</span><span style="color:#75af00">method</span><span style="color:#111">];</span> <span style="color:#111">!</span><span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">routes</span><span style="color:#111">[</span><span style="color:#75af00">method</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#00a8c8">string</span><span style="color:#111">]</span><span style="color:#75af00">muxEntry</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">routes</span><span style="color:#111">[</span><span style="color:#75af00">method</span><span style="color:#111">][</span><span style="color:#75af00">path</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#75af00">muxEntry</span><span style="color:#111">{</span><span style="color:#75af00">handler</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d88200">&#34;net/http&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d88200">&#34;study/mux&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">handler</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">Newhandler</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">handler</span><span style="color:#111">.</span><span style="color:#75af00">Handle</span><span style="color:#111">(</span><span style="color:#d88200">&#34;GET&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;/hello&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">rw</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">ResponseWriter</span><span style="color:#111">,</span> <span style="color:#75af00">r</span> <span style="color:#f92672">*</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Request</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">rw</span><span style="color:#111">.</span><span style="color:#75af00">Write</span><span style="color:#111">([]</span><span style="color:#111">byte</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Hello World&#34;</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">handler</span><span style="color:#111">.</span><span style="color:#75af00">Handle</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Post&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;/hello/world&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">rw</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">ResponseWriter</span><span style="color:#111">,</span> <span style="color:#75af00">r</span> <span style="color:#f92672">*</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Request</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Fprintln</span><span style="color:#111">(</span><span style="color:#75af00">rw</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;你好&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">ListenAndServe</span><span style="color:#111">(</span><span style="color:#d88200">&#34;:9002&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">handler</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>自定义context</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">router</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d88200">&#34;encoding/json&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d88200">&#34;net/http&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d88200">&#34;strings&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Context</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">w</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">ResponseWriter</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">r</span> <span style="color:#f92672">*</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Request</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#75af00">Json</span><span style="color:#111">(</span><span style="color:#75af00">code</span> <span style="color:#00a8c8">int</span><span style="color:#111">,</span> <span style="color:#75af00">v</span> <span style="color:#00a8c8">interface</span><span style="color:#111">{})</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">w</span><span style="color:#111">.</span><span style="color:#75af00">Header</span><span style="color:#111">().</span><span style="color:#75af00">Set</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Content-Type&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;application/json&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">w</span><span style="color:#111">.</span><span style="color:#75af00">WriteHeader</span><span style="color:#111">(</span><span style="color:#75af00">code</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">s</span><span style="color:#111">,</span> <span style="color:#75af00">_</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">json</span><span style="color:#111">.</span><span style="color:#75af00">Marshal</span><span style="color:#111">(</span><span style="color:#75af00">v</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">w</span><span style="color:#111">.</span><span style="color:#75af00">Write</span><span style="color:#111">(</span><span style="color:#75af00">s</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Routerfunc</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">Context</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">RouterHandler</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">routes</span> <span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#00a8c8">string</span><span style="color:#111">]</span><span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#00a8c8">string</span><span style="color:#111">]</span><span style="color:#75af00">Routerfunc</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">NewRouterHandler</span><span style="color:#111">()</span> <span style="color:#f92672">*</span><span style="color:#75af00">RouterHandler</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">RouterHandler</span><span style="color:#111">{</span><span style="color:#75af00">routes</span><span style="color:#111">:</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#00a8c8">string</span><span style="color:#111">]</span><span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#00a8c8">string</span><span style="color:#111">]</span><span style="color:#75af00">Routerfunc</span><span style="color:#111">)}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">h</span> <span style="color:#f92672">*</span><span style="color:#75af00">RouterHandler</span><span style="color:#111">)</span> <span style="color:#75af00">ServeHTTP</span><span style="color:#111">(</span><span style="color:#75af00">w</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">ResponseWriter</span><span style="color:#111">,</span> <span style="color:#75af00">r</span> <span style="color:#f92672">*</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Request</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">method</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">strings</span><span style="color:#111">.</span><span style="color:#75af00">ToUpper</span><span style="color:#111">(</span><span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">Method</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">path</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">URL</span><span style="color:#111">.</span><span style="color:#75af00">Path</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">c</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">Context</span><span style="color:#111">{</span><span style="color:#75af00">w</span><span style="color:#111">:</span> <span style="color:#75af00">w</span><span style="color:#111">,</span> <span style="color:#75af00">r</span><span style="color:#111">:</span> <span style="color:#75af00">r</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">route</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">routes</span><span style="color:#111">[</span><span style="color:#75af00">method</span><span style="color:#111">];</span> <span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#75af00">h</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">route</span><span style="color:#111">[</span><span style="color:#75af00">path</span><span style="color:#111">];</span> <span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75af00">h</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">w</span><span style="color:#111">.</span><span style="color:#75af00">WriteHeader</span><span style="color:#111">(</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">StatusNotFound</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">h</span> <span style="color:#f92672">*</span><span style="color:#75af00">RouterHandler</span><span style="color:#111">)</span> <span style="color:#75af00">Handle</span><span style="color:#111">(</span><span style="color:#75af00">method</span><span style="color:#111">,</span> <span style="color:#75af00">path</span> <span style="color:#00a8c8">string</span><span style="color:#111">,</span> <span style="color:#75af00">handler</span> <span style="color:#75af00">Routerfunc</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">method</span> <span style="color:#111">=</span> <span style="color:#75af00">strings</span><span style="color:#111">.</span><span style="color:#75af00">ToUpper</span><span style="color:#111">(</span><span style="color:#75af00">method</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">routes</span><span style="color:#111">[</span><span style="color:#75af00">method</span><span style="color:#111">];</span> <span style="color:#111">!</span><span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">routes</span><span style="color:#111">[</span><span style="color:#75af00">method</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#00a8c8">string</span><span style="color:#111">]</span><span style="color:#75af00">Routerfunc</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">routes</span><span style="color:#111">[</span><span style="color:#75af00">method</span><span style="color:#111">][</span><span style="color:#75af00">path</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#75af00">handler</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">r</span> <span style="color:#f92672">*</span><span style="color:#75af00">RouterHandler</span><span style="color:#111">)</span> <span style="color:#75af00">Run</span><span style="color:#111">(</span><span style="color:#75af00">addr</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">ListenAndServe</span><span style="color:#111">(</span><span style="color:#75af00">addr</span><span style="color:#111">,</span> <span style="color:#75af00">r</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="gin">Gin</h2>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Engine</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">RouterGroup</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">pool</span>     <span style="color:#75af00">sync</span><span style="color:#111">.</span><span style="color:#75af00">Pool</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">trees</span>    <span style="color:#75af00">methodTrees</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span><span style="color:#75715e">// trie</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">RouterGroup</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">basePath</span> <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">engine</span>   <span style="color:#f92672">*</span><span style="color:#75af00">Engine</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">engine</span> <span style="color:#f92672">*</span><span style="color:#75af00">Engine</span><span style="color:#111">)</span> <span style="color:#75af00">ServeHTTP</span><span style="color:#111">(</span><span style="color:#75af00">w</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">ResponseWriter</span><span style="color:#111">,</span> <span style="color:#75af00">req</span> <span style="color:#f92672">*</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Request</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">c</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">engine</span><span style="color:#111">.</span><span style="color:#75af00">pool</span><span style="color:#111">.</span><span style="color:#75af00">Get</span><span style="color:#111">().(</span><span style="color:#f92672">*</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#75715e">// 从pool 拿出一个context</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">writermem</span><span style="color:#111">.</span><span style="color:#75af00">reset</span><span style="color:#111">(</span><span style="color:#75af00">w</span><span style="color:#111">)</span> <span style="color:#75715e">// 记录http.ResponseWriter 及 *http.Request</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">Request</span> <span style="color:#111">=</span> <span style="color:#75af00">req</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">reset</span><span style="color:#111">()</span> <span style="color:#75715e">// 重置上一个留下的值</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">engine</span><span style="color:#111">.</span><span style="color:#75af00">handleHTTPRequest</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">engine</span><span style="color:#111">.</span><span style="color:#75af00">pool</span><span style="color:#111">.</span><span style="color:#75af00">Put</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">)</span> <span style="color:#75715e">// 把用完的context放回池子</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// get: /bac</span>
</span></span></code></pre></div><p><img src="/images/6c261f0b5937d728d3763beaf08f85eea6999091.png#id=UR4F8&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title=" alt=""></p>
<p>添加路由</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">group</span> <span style="color:#f92672">*</span><span style="color:#75af00">RouterGroup</span><span style="color:#111">)</span> <span style="color:#75af00">handle</span><span style="color:#111">(</span><span style="color:#75af00">httpMethod</span><span style="color:#111">,</span> <span style="color:#75af00">relativePath</span> <span style="color:#00a8c8">string</span><span style="color:#111">,</span> <span style="color:#75af00">handlers</span> <span style="color:#75af00">HandlersChain</span><span style="color:#111">)</span> <span style="color:#75af00">IRoutes</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">absolutePath</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">group</span><span style="color:#111">.</span><span style="color:#75af00">calculateAbsolutePath</span><span style="color:#111">(</span><span style="color:#75af00">relativePath</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">handlers</span> <span style="color:#111">=</span> <span style="color:#75af00">group</span><span style="color:#111">.</span><span style="color:#75af00">combineHandlers</span><span style="color:#111">(</span><span style="color:#75af00">handlers</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">group</span><span style="color:#111">.</span><span style="color:#75af00">engine</span><span style="color:#111">.</span><span style="color:#75af00">addRoute</span><span style="color:#111">(</span><span style="color:#75af00">httpMethod</span><span style="color:#111">,</span> <span style="color:#75af00">absolutePath</span><span style="color:#111">,</span> <span style="color:#75af00">handlers</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#75af00">group</span><span style="color:#111">.</span><span style="color:#75af00">returnObj</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>Context</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Context</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">Request</span>   <span style="color:#f92672">*</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Request</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">Writer</span>    <span style="color:#75af00">ResponseWriter</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">Params</span>   <span style="color:#75af00">Params</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">handlers</span> <span style="color:#75af00">HandlersChain</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">index</span>    <span style="color:#00a8c8">int8</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">fullPath</span> <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">engine</span>       <span style="color:#f92672">*</span><span style="color:#75af00">Engine</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">params</span>       <span style="color:#f92672">*</span><span style="color:#75af00">Params</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">skippedNodes</span> <span style="color:#f92672">*</span><span style="color:#111">[]</span><span style="color:#75af00">skippedNode</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// This mutex protect Keys map</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">mu</span> <span style="color:#75af00">sync</span><span style="color:#111">.</span><span style="color:#75af00">RWMutex</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Keys is a key/value pair exclusively for the context of each request.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">Keys</span> <span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#00a8c8">string</span><span style="color:#111">]</span><span style="color:#00a8c8">interface</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Errors is a list of errors attached to all the handlers/middlewares who used this context.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">Errors</span> <span style="color:#75af00">errorMsgs</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Accepted defines a list of manually accepted formats for content negotiation.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">Accepted</span> <span style="color:#111">[]</span><span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// queryCache use url.ParseQuery cached the param query result from c.Request.URL.Query()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">queryCache</span> <span style="color:#75af00">url</span><span style="color:#111">.</span><span style="color:#75af00">Values</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// formCache use url.ParseQuery cached PostForm contains the parsed form data from POST, PATCH,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// or PUT body parameters.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">formCache</span> <span style="color:#75af00">url</span><span style="color:#111">.</span><span style="color:#75af00">Values</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// SameSite allows a server to define a cookie attribute making it impossible for</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// the browser to send this cookie along with cross-site requests.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">sameSite</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">SameSite</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#75af00">Next</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">index</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">for</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">index</span> <span style="color:#111">&lt;</span> <span style="color:#111">int8</span><span style="color:#111">(</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">handlers</span><span style="color:#111">))</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">handlers</span><span style="color:#111">[</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">index</span><span style="color:#111">](</span><span style="color:#75af00">c</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">index</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">engine</span> <span style="color:#f92672">*</span><span style="color:#75af00">Engine</span><span style="color:#111">)</span> <span style="color:#75af00">handleHTTPRequest</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">httpMethod</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">Request</span><span style="color:#111">.</span><span style="color:#75af00">Method</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">rPath</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">Request</span><span style="color:#111">.</span><span style="color:#75af00">URL</span><span style="color:#111">.</span><span style="color:#75af00">Path</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">unescape</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">engine</span><span style="color:#111">.</span><span style="color:#75af00">UseRawPath</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">Request</span><span style="color:#111">.</span><span style="color:#75af00">URL</span><span style="color:#111">.</span><span style="color:#75af00">RawPath</span><span style="color:#111">)</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">rPath</span> <span style="color:#111">=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">Request</span><span style="color:#111">.</span><span style="color:#75af00">URL</span><span style="color:#111">.</span><span style="color:#75af00">RawPath</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">unescape</span> <span style="color:#111">=</span> <span style="color:#75af00">engine</span><span style="color:#111">.</span><span style="color:#75af00">UnescapePathValues</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">engine</span><span style="color:#111">.</span><span style="color:#75af00">RemoveExtraSlash</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">rPath</span> <span style="color:#111">=</span> <span style="color:#75af00">cleanPath</span><span style="color:#111">(</span><span style="color:#75af00">rPath</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Find root of the tree for the given HTTP method</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">t</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">engine</span><span style="color:#111">.</span><span style="color:#75af00">trees</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">for</span> <span style="color:#75af00">i</span><span style="color:#111">,</span> <span style="color:#75af00">tl</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">t</span><span style="color:#111">);</span> <span style="color:#75af00">i</span> <span style="color:#111">&lt;</span> <span style="color:#75af00">tl</span><span style="color:#111">;</span> <span style="color:#75af00">i</span><span style="color:#f92672">++</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#75af00">t</span><span style="color:#111">[</span><span style="color:#75af00">i</span><span style="color:#111">].</span><span style="color:#75af00">method</span> <span style="color:#f92672">!=</span> <span style="color:#75af00">httpMethod</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">continue</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">root</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">t</span><span style="color:#111">[</span><span style="color:#75af00">i</span><span style="color:#111">].</span><span style="color:#75af00">root</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Find route in tree</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">value</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">root</span><span style="color:#111">.</span><span style="color:#75af00">getValue</span><span style="color:#111">(</span><span style="color:#75af00">rPath</span><span style="color:#111">,</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">params</span><span style="color:#111">,</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">skippedNodes</span><span style="color:#111">,</span> <span style="color:#75af00">unescape</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#75af00">value</span><span style="color:#111">.</span><span style="color:#75af00">params</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">Params</span> <span style="color:#111">=</span> <span style="color:#f92672">*</span><span style="color:#75af00">value</span><span style="color:#111">.</span><span style="color:#75af00">params</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#75af00">value</span><span style="color:#111">.</span><span style="color:#75af00">handlers</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">handlers</span> <span style="color:#111">=</span> <span style="color:#75af00">value</span><span style="color:#111">.</span><span style="color:#75af00">handlers</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">fullPath</span> <span style="color:#111">=</span> <span style="color:#75af00">value</span><span style="color:#111">.</span><span style="color:#75af00">fullPath</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">Next</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">writermem</span><span style="color:#111">.</span><span style="color:#75af00">WriteHeaderNow</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#75af00">httpMethod</span> <span style="color:#f92672">!=</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">MethodConnect</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">rPath</span> <span style="color:#f92672">!=</span> <span style="color:#d88200">&#34;/&#34;</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">if</span> <span style="color:#75af00">value</span><span style="color:#111">.</span><span style="color:#75af00">tsr</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">engine</span><span style="color:#111">.</span><span style="color:#75af00">RedirectTrailingSlash</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75af00">redirectTrailingSlash</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">if</span> <span style="color:#75af00">engine</span><span style="color:#111">.</span><span style="color:#75af00">RedirectFixedPath</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">redirectFixedPath</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">,</span> <span style="color:#75af00">root</span><span style="color:#111">,</span> <span style="color:#75af00">engine</span><span style="color:#111">.</span><span style="color:#75af00">RedirectFixedPath</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">break</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">engine</span><span style="color:#111">.</span><span style="color:#75af00">HandleMethodNotAllowed</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">tree</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">engine</span><span style="color:#111">.</span><span style="color:#75af00">trees</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">if</span> <span style="color:#75af00">tree</span><span style="color:#111">.</span><span style="color:#75af00">method</span> <span style="color:#f92672">==</span> <span style="color:#75af00">httpMethod</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#00a8c8">continue</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">if</span> <span style="color:#75af00">value</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">tree</span><span style="color:#111">.</span><span style="color:#75af00">root</span><span style="color:#111">.</span><span style="color:#75af00">getValue</span><span style="color:#111">(</span><span style="color:#75af00">rPath</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">skippedNodes</span><span style="color:#111">,</span> <span style="color:#75af00">unescape</span><span style="color:#111">);</span> <span style="color:#75af00">value</span><span style="color:#111">.</span><span style="color:#75af00">handlers</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">handlers</span> <span style="color:#111">=</span> <span style="color:#75af00">engine</span><span style="color:#111">.</span><span style="color:#75af00">allNoMethod</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75af00">serveError</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">,</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">StatusMethodNotAllowed</span><span style="color:#111">,</span> <span style="color:#75af00">default405Body</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">handlers</span> <span style="color:#111">=</span> <span style="color:#75af00">engine</span><span style="color:#111">.</span><span style="color:#75af00">allNoRoute</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">serveError</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">,</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">StatusNotFound</span><span style="color:#111">,</span> <span style="color:#75af00">default404Body</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div>]]></content:encoded><category>go</category><category>go</category><category>gin</category></item><item><title>go mod</title><link>https://daemon365.dev/post/go/go_mod/</link><pubDate>Tue, 01 Oct 2019 00:00:00 +0800</pubDate><guid>https://daemon365.dev/post/go/go_mod/</guid><description>&lt;p&gt;go module是 Go1.11版本之后官方推出的版本管理工具，并且从Go1.13版本开始，go module将是Go语言默认的依赖管理工具。&lt;/p&gt;
&lt;h2 id="go111module"&gt;GO111MODULE&lt;/h2&gt;
&lt;p&gt;要启用go module支持首先要设置环境变量GO111MODULE，通过它可以开启或关闭模块支持，它有三个可选值：off、on、auto，默认值是auto。&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;GO111MODULE=off禁用模块支持，编译时会从GOPATH和vendor文件夹中查找包。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;GO111MODULE=on启用模块支持，编译时会忽略GOPATH和vendor文件夹，只根据 go.mod下载依赖。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;GO111MODULE=auto，当项目在$GOPATH/src外且项目根目录有go.mod文件时，开启模块支持。&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;简单来说，设置GO111MODULE=on之后就可以使用go module了，以后就没有必要在GOPATH中创建项目了，并且还能够很好的管理项目依赖的第三方包信息。&lt;/p&gt;
&lt;p&gt;使用 go module 管理依赖后会在项目根目录下生成两个文件go.mod和go.sum。&lt;/p&gt;
&lt;h2 id="goproxy"&gt;GOPROXY&lt;/h2&gt;
&lt;p&gt;Go1.11之后设置GOPROXY命令为：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#ae81ff"&gt;1&lt;/span&gt; &lt;span style="color:#111"&gt;export&lt;/span&gt; &lt;span style="color:#111"&gt;GOPROXY&lt;/span&gt;&lt;span style="color:#f92672"&gt;=&lt;/span&gt;https://goproxy.cn
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Go1.13之后GOPROXY默认值为https://proxy.golang.org，在国内是无法访问的，所以十分建议大家设置GOPROXY，这里我推荐使用&lt;a href="https://studygolang.com/topics/10014"&gt;goproxy.cn&lt;/a&gt;。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;go env -w &lt;span style="color:#111"&gt;GOPROXY&lt;/span&gt;&lt;span style="color:#f92672"&gt;=&lt;/span&gt;https://goproxy.cn,direct
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id="go-mod命令"&gt;go mod命令&lt;/h2&gt;
&lt;p&gt;常用的go mod命令如下：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;go mod download 下载依赖的module到本地cache（默认为$GOPATH/pkg/mod目录）&lt;/li&gt;
&lt;li&gt;go mod edit 编辑go.mod文件&lt;/li&gt;
&lt;li&gt;go mod graph 打印模块依赖图&lt;/li&gt;
&lt;li&gt;go mod init 初始化当前文件夹, 创建go.mod文件&lt;/li&gt;
&lt;li&gt;go mod tidy 增加缺少的module，删除无用的module&lt;/li&gt;
&lt;li&gt;go mod vendor 将依赖复制到vendor下&lt;/li&gt;
&lt;li&gt;go mod verify 校验依赖&lt;/li&gt;
&lt;li&gt;go mod why 解释为什么需要依赖&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id="gomod"&gt;go.mod&lt;/h2&gt;
&lt;p&gt;go.mod文件记录了项目所有的依赖信息，其结构大致如下：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75af00"&gt;module&lt;/span&gt; &lt;span style="color:#75af00"&gt;test&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;go&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;1.15&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75af00"&gt;require&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;github&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;com&lt;/span&gt;&lt;span style="color:#f92672"&gt;/&lt;/span&gt;&lt;span style="color:#75af00"&gt;DeanThompson&lt;/span&gt;&lt;span style="color:#f92672"&gt;/&lt;/span&gt;&lt;span style="color:#75af00"&gt;ginpprof&lt;/span&gt; &lt;span style="color:#75af00"&gt;v0&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;.0.0&lt;/span&gt;&lt;span style="color:#f92672"&gt;-&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;20190408063150&lt;/span&gt;&lt;span style="color:#f92672"&gt;-&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;3&lt;/span&gt;&lt;span style="color:#75af00"&gt;be636683586&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;github&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;com&lt;/span&gt;&lt;span style="color:#f92672"&gt;/&lt;/span&gt;&lt;span style="color:#75af00"&gt;gin&lt;/span&gt;&lt;span style="color:#f92672"&gt;-&lt;/span&gt;&lt;span style="color:#75af00"&gt;gonic&lt;/span&gt;&lt;span style="color:#f92672"&gt;/&lt;/span&gt;&lt;span style="color:#75af00"&gt;gin&lt;/span&gt; &lt;span style="color:#75af00"&gt;v1&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;.4.0&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;github&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;com&lt;/span&gt;&lt;span style="color:#f92672"&gt;/&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;go&lt;/span&gt;&lt;span style="color:#f92672"&gt;-&lt;/span&gt;&lt;span style="color:#75af00"&gt;sql&lt;/span&gt;&lt;span style="color:#f92672"&gt;-&lt;/span&gt;&lt;span style="color:#75af00"&gt;driver&lt;/span&gt;&lt;span style="color:#f92672"&gt;/&lt;/span&gt;&lt;span style="color:#75af00"&gt;mysql&lt;/span&gt; &lt;span style="color:#75af00"&gt;v1&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;.4.1&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;github&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;com&lt;/span&gt;&lt;span style="color:#f92672"&gt;/&lt;/span&gt;&lt;span style="color:#75af00"&gt;jmoiron&lt;/span&gt;&lt;span style="color:#f92672"&gt;/&lt;/span&gt;&lt;span style="color:#75af00"&gt;sqlx&lt;/span&gt; &lt;span style="color:#75af00"&gt;v1&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;.2.0&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;10&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;github&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;com&lt;/span&gt;&lt;span style="color:#f92672"&gt;/&lt;/span&gt;&lt;span style="color:#75af00"&gt;satori&lt;/span&gt;&lt;span style="color:#f92672"&gt;/&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;go&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;uuid&lt;/span&gt; &lt;span style="color:#75af00"&gt;v1&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;.2.0&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;google&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;golang&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;org&lt;/span&gt;&lt;span style="color:#f92672"&gt;/&lt;/span&gt;&lt;span style="color:#75af00"&gt;appengine&lt;/span&gt; &lt;span style="color:#75af00"&gt;v1&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;.6.1&lt;/span&gt; &lt;span style="color:#75715e"&gt;// indirect 12 &lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;其中，&lt;/p&gt;</description><content:encoded><![CDATA[<p>go module是 Go1.11版本之后官方推出的版本管理工具，并且从Go1.13版本开始，go module将是Go语言默认的依赖管理工具。</p>
<h2 id="go111module">GO111MODULE</h2>
<p>要启用go module支持首先要设置环境变量GO111MODULE，通过它可以开启或关闭模块支持，它有三个可选值：off、on、auto，默认值是auto。</p>
<ol>
<li>
<p>GO111MODULE=off禁用模块支持，编译时会从GOPATH和vendor文件夹中查找包。</p>
</li>
<li>
<p>GO111MODULE=on启用模块支持，编译时会忽略GOPATH和vendor文件夹，只根据 go.mod下载依赖。</p>
</li>
<li>
<p>GO111MODULE=auto，当项目在$GOPATH/src外且项目根目录有go.mod文件时，开启模块支持。</p>
</li>
</ol>
<p>简单来说，设置GO111MODULE=on之后就可以使用go module了，以后就没有必要在GOPATH中创建项目了，并且还能够很好的管理项目依赖的第三方包信息。</p>
<p>使用 go module 管理依赖后会在项目根目录下生成两个文件go.mod和go.sum。</p>
<h2 id="goproxy">GOPROXY</h2>
<p>Go1.11之后设置GOPROXY命令为：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ae81ff">1</span> <span style="color:#111">export</span> <span style="color:#111">GOPROXY</span><span style="color:#f92672">=</span>https://goproxy.cn
</span></span></code></pre></div><p>Go1.13之后GOPROXY默认值为https://proxy.golang.org，在国内是无法访问的，所以十分建议大家设置GOPROXY，这里我推荐使用<a href="https://studygolang.com/topics/10014">goproxy.cn</a>。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>go env -w <span style="color:#111">GOPROXY</span><span style="color:#f92672">=</span>https://goproxy.cn,direct
</span></span></code></pre></div><h2 id="go-mod命令">go mod命令</h2>
<p>常用的go mod命令如下：</p>
<ol>
<li>go mod download    下载依赖的module到本地cache（默认为$GOPATH/pkg/mod目录）</li>
<li>go mod edit       编辑go.mod文件</li>
<li>go mod graph       打印模块依赖图</li>
<li>go mod init       初始化当前文件夹, 创建go.mod文件</li>
<li>go mod tidy       增加缺少的module，删除无用的module</li>
<li>go mod vendor     将依赖复制到vendor下</li>
<li>go mod verify     校验依赖</li>
<li>go mod why         解释为什么需要依赖</li>
</ol>
<h2 id="gomod">go.mod</h2>
<p>go.mod文件记录了项目所有的依赖信息，其结构大致如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">module</span> <span style="color:#75af00">test</span> 
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">go</span> <span style="color:#ae81ff">1.15</span>  
</span></span><span style="display:flex;"><span><span style="color:#75af00">require</span> <span style="color:#111">(</span>  
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">github</span><span style="color:#111">.</span><span style="color:#75af00">com</span><span style="color:#f92672">/</span><span style="color:#75af00">DeanThompson</span><span style="color:#f92672">/</span><span style="color:#75af00">ginpprof</span> <span style="color:#75af00">v0</span><span style="color:#ae81ff">.0.0</span><span style="color:#f92672">-</span><span style="color:#ae81ff">20190408063150</span><span style="color:#f92672">-</span><span style="color:#ae81ff">3</span><span style="color:#75af00">be636683586</span> 
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">github</span><span style="color:#111">.</span><span style="color:#75af00">com</span><span style="color:#f92672">/</span><span style="color:#75af00">gin</span><span style="color:#f92672">-</span><span style="color:#75af00">gonic</span><span style="color:#f92672">/</span><span style="color:#75af00">gin</span> <span style="color:#75af00">v1</span><span style="color:#ae81ff">.4.0</span>   		
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">github</span><span style="color:#111">.</span><span style="color:#75af00">com</span><span style="color:#f92672">/</span><span style="color:#00a8c8">go</span><span style="color:#f92672">-</span><span style="color:#75af00">sql</span><span style="color:#f92672">-</span><span style="color:#75af00">driver</span><span style="color:#f92672">/</span><span style="color:#75af00">mysql</span> <span style="color:#75af00">v1</span><span style="color:#ae81ff">.4.1</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">github</span><span style="color:#111">.</span><span style="color:#75af00">com</span><span style="color:#f92672">/</span><span style="color:#75af00">jmoiron</span><span style="color:#f92672">/</span><span style="color:#75af00">sqlx</span> <span style="color:#75af00">v1</span><span style="color:#ae81ff">.2.0</span> <span style="color:#ae81ff">10</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">github</span><span style="color:#111">.</span><span style="color:#75af00">com</span><span style="color:#f92672">/</span><span style="color:#75af00">satori</span><span style="color:#f92672">/</span><span style="color:#00a8c8">go</span><span style="color:#111">.</span><span style="color:#75af00">uuid</span> <span style="color:#75af00">v1</span><span style="color:#ae81ff">.2.0</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">google</span><span style="color:#111">.</span><span style="color:#75af00">golang</span><span style="color:#111">.</span><span style="color:#75af00">org</span><span style="color:#f92672">/</span><span style="color:#75af00">appengine</span> <span style="color:#75af00">v1</span><span style="color:#ae81ff">.6.1</span> <span style="color:#75715e">// indirect 12 </span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span></code></pre></div><p>其中，</p>
<ul>
<li>
<p>module用来定义包名</p>
</li>
<li>
<p>require用来定义依赖包及版本</p>
</li>
<li>
<p>indirect表示间接引用</p>
</li>
</ul>
<h3 id="依赖的版本">依赖的版本</h3>
<p>go mod支持语义化版本号，比如go get <a href="mailto:foo@v1.2.3">foo@v1.2.3</a>，也可以跟git的分支或tag，比如go get foo@master，当然也可以跟git提交哈希，比如go get foo@e3702bed2。关于依赖的版本支持以下几种格式：</p>
<pre tabindex="0"><code>gopkg.in/tomb.v1 v1.0.0-20141024135613-dd632973f1e7 
gopkg.in/vmihailenco/msgpack.v2 v2.9.1 gopkg.in/yaml.v2 v2.2.1 
github.com/tatsushid/go-fastping v0.0.0-20160109021039-d7bb493dee3e latest
</code></pre><h3 id="replace">replace</h3>
<p>在国内访问golang.org/x的各个包都需要***，你可以在go.mod中使用replace替换成github上对应的库。</p>
<pre tabindex="0"><code>replace (  
	golang.org/x/crypto v0.0.0-20180820150726-614d502a4dac =&gt; github.com/golang/crypto v0.0.0-20180820150726-614d502a4dac  
	golang.org/x/net v0.0.0-20180821023952-922f4815f713 =&gt; github.com/golang/net v0.0.0-20180826012351-8a410e7b638d  
	golang.org/x/text v0.3.0 =&gt; github.com/golang/text v0.3.0 
)
</code></pre><h2 id="go-get">go get</h2>
<p>在项目中执行go get命令可以下载依赖包，并且还可以指定下载的版本。</p>
<ol>
<li>
<p>运行go get -u将会升级到最新的次要版本或者修订版本(x.y.z, z是修订版本号， y是次要版本号)</p>
</li>
<li>
<p>运行go get -u=patch将会升级到最新的修订版本</p>
</li>
<li>
<p>运行go get package@version将会升级到指定的版本号version</p>
</li>
</ol>
<p>如果下载所有依赖可以使用go mod download命令。</p>
<h2 id="整理依赖">整理依赖</h2>
<p>我们在代码中删除依赖代码后，相关的依赖库并不会在go.mod文件中自动移除。这种情况下我们可以使用go mod tidy命令更新go.mod中的依赖关系。</p>
<h2 id="go-mod-edit">go mod edit</h2>
<h3 id="格式化">格式化</h3>
<p>因为我们可以手动修改go.mod文件，所以有些时候需要格式化该文件。Go提供了一下命令：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>go mod edit -fmt
</span></span></code></pre></div><h3 id="添加依赖项">添加依赖项</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>go mod edit -require<span style="color:#f92672">=</span>golang.org/x/text
</span></span></code></pre></div><h3 id="移除依赖项">移除依赖项</h3>
<p>如果只是想修改go.mod文件中的内容，那么可以运行go mod edit -droprequire=package path，比如要在go.mod中移除golang.org/x/text包，可以使用如下命令：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>go mod edit -droprequire<span style="color:#f92672">=</span>golang.org/x/text
</span></span></code></pre></div><p>关于go mod edit的更多用法可以通过go help mod edit查看。</p>
<h2 id="在项目中使用go-module">在项目中使用go module</h2>
<h3 id="既有项目">既有项目</h3>
<p>如果需要对一个已经存在的项目启用go module，可以按照以下步骤操作：</p>
<ol>
<li>
<p>在项目目录下执行go mod init，生成一个go.mod文件。</p>
</li>
<li>
<p>执行go get，查找并记录当前项目的依赖，同时生成一个go.sum记录每个依赖库的版本和哈希值。</p>
</li>
</ol>
<h3 id="新项目">新项目</h3>
<p>对于一个新创建的项目，我们可以在项目文件夹下按照以下步骤操作：</p>
<ol>
<li>
<p>执行go mod init 项目名命令，在当前项目文件夹下创建一个go.mod文件。</p>
</li>
<li>
<p>手动编辑go.mod中的require依赖项或执行go get自动发现、维护依赖。</p>
</li>
</ol>
<h2 id="文章转自">文章转自</h2>
<ul>
<li><a href="https://www.liwenzhou.com/posts/Go/go_dependency/">https://www.liwenzhou.com/posts/Go/go_dependency/</a></li>
</ul>
]]></content:encoded><category>go</category><category>go</category></item><item><title>golang 模板 htmltemplate与texttemplate</title><link>https://daemon365.dev/post/go/golang_template_htmltemplate_and_texttemplate/</link><pubDate>Sat, 13 Jul 2019 00:00:00 +0800</pubDate><guid>https://daemon365.dev/post/go/golang_template_htmltemplate_and_texttemplate/</guid><description>&lt;h2 id="html模板生成"&gt;html模板生成:&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;html/template包实现了数据驱动的模板，用于生成可对抗代码注入的安全HTML输出。它提供了和text/template包相同的接口，Go语言中输出HTML的场景都应使用text/template包。&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="模板语法"&gt;模板语法&lt;/h2&gt;
&lt;h3 id="heading"&gt;{{.}}&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;模板语法都包含在{{和}}中间，其中{{.}}中的点表示当前对象。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;当我们传入一个结构体对象时，我们可以根据.来访问结构体的对应字段。例如：&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;// main.go&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;sayHello&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;w&lt;/span&gt; &lt;span style="color:#75af00"&gt;http&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;ResponseWriter&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;r&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;http&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Request&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// 解析指定文件生成模板对象&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;tmpl&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;template&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;ParseFiles&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;./hello.html&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;!=&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;create template failed, err:&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;var&lt;/span&gt; &lt;span style="color:#75af00"&gt;user&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;struct&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;name&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;string&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;age&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;int&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;name&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;zhaohaiyu&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;age&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;18&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// 利用给定数据渲染模板，并将结果写入w&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;tmpl&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Execute&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;w&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;user&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;main&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;http&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;HandleFunc&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;/&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;sayHello&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;http&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;ListenAndServe&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;:9090&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;!=&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;HTTP server failed,err:&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre&gt;&lt;code&gt;Hello
姓名 {{.Name}}
年龄：{{.Age}}
同理，当我们传入的变量是map时，也可以在模板文件中通过.根据key来取值。
&lt;/code&gt;&lt;/pre&gt;
&lt;h3 id="注释"&gt;注释&lt;/h3&gt;
&lt;p&gt;{{/* a comment */}}&lt;/p&gt;
&lt;h3 id="pipeline"&gt;pipeline&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;pipeline是指产生数据的操作。比如{{.}}、{{.Name}}等。Go的模板语法中支持使用管道符号|链接多个命令，用法和unix下的管道类似：|前面的命令会将运算结果(或返回值)传递给后一个命令的最后一个位置。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;**注意：**并不是只有使用了|才是pipeline。Go的模板语法中，pipeline的概念是传递数据，只要能产生数据的，都是pipeline。&lt;/p&gt;
&lt;h3 id="变量"&gt;变量&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;我们还可以在模板中声明变量，用来保存传入模板的数据或其他语句生成的结果。具体语法如下：&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;$&lt;/span&gt;&lt;span style="color:#75af00"&gt;obj&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#111"&gt;{{.}}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75af00"&gt;其中&lt;/span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;$&lt;/span&gt;&lt;span style="color:#75af00"&gt;obj是变量的名字&lt;/span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;，&lt;/span&gt;&lt;span style="color:#75af00"&gt;在后续的代码中就可以使用该变量了&lt;/span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;。&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id="移除空格"&gt;移除空格&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;有时候我们在使用模板语法的时候会不可避免的引入一下空格或者换行符，这样模板最终渲染出来的内容可能就和我们想的不一样，这个时候可以使用{{-语法去除模板内容左侧的所有空白符号， 使用-}}去除模板内容右侧的所有空白符号。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;例如：{{- .Name -}}&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;注意：&lt;/strong&gt;-要紧挨{{和}}，同时与模板值之间需要使用空格分隔。&lt;/p&gt;
&lt;h3 id="条件判断"&gt;条件判断&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;Go模板语法中的条件判断有以下几种:&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;{{&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;pipeline&lt;/span&gt;&lt;span style="color:#111"&gt;}}&lt;/span&gt; &lt;span style="color:#75af00"&gt;T1&lt;/span&gt; &lt;span style="color:#111"&gt;{{&lt;/span&gt;&lt;span style="color:#75af00"&gt;end&lt;/span&gt;&lt;span style="color:#111"&gt;}}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;{{&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;pipeline&lt;/span&gt;&lt;span style="color:#111"&gt;}}&lt;/span&gt; &lt;span style="color:#75af00"&gt;T1&lt;/span&gt; &lt;span style="color:#111"&gt;{{&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;else&lt;/span&gt;&lt;span style="color:#111"&gt;}}&lt;/span&gt; &lt;span style="color:#75af00"&gt;T0&lt;/span&gt; &lt;span style="color:#111"&gt;{{&lt;/span&gt;&lt;span style="color:#75af00"&gt;end&lt;/span&gt;&lt;span style="color:#111"&gt;}}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;{{&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;pipeline&lt;/span&gt;&lt;span style="color:#111"&gt;}}&lt;/span&gt; &lt;span style="color:#75af00"&gt;T1&lt;/span&gt; &lt;span style="color:#111"&gt;{{&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;else&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;pipeline&lt;/span&gt;&lt;span style="color:#111"&gt;}}&lt;/span&gt; &lt;span style="color:#75af00"&gt;T0&lt;/span&gt; &lt;span style="color:#111"&gt;{{&lt;/span&gt;&lt;span style="color:#75af00"&gt;end&lt;/span&gt;&lt;span style="color:#111"&gt;}}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id="range"&gt;range&lt;/h3&gt;
&lt;p&gt;Go的模板语法中使用range关键字进行遍历，有以下两种写法，其中pipeline的值必须是数组、切片、字典或者通道。&lt;/p&gt;</description><content:encoded><![CDATA[<h2 id="html模板生成">html模板生成:</h2>
<ul>
<li>html/template包实现了数据驱动的模板，用于生成可对抗代码注入的安全HTML输出。它提供了和text/template包相同的接口，Go语言中输出HTML的场景都应使用text/template包。</li>
</ul>
<h2 id="模板语法">模板语法</h2>
<h3 id="heading">{{.}}</h3>
<ul>
<li>
<p>模板语法都包含在{{和}}中间，其中{{.}}中的点表示当前对象。</p>
</li>
<li>
<p>当我们传入一个结构体对象时，我们可以根据.来访问结构体的对应字段。例如：</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// main.go</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">sayHello</span><span style="color:#111">(</span><span style="color:#75af00">w</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">ResponseWriter</span><span style="color:#111">,</span> <span style="color:#75af00">r</span> <span style="color:#f92672">*</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Request</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 解析指定文件生成模板对象</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">tmpl</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">template</span><span style="color:#111">.</span><span style="color:#75af00">ParseFiles</span><span style="color:#111">(</span><span style="color:#d88200">&#34;./hello.html&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;create template failed, err:&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">var</span> <span style="color:#75af00">user</span> <span style="color:#111">=</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">name</span> <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">age</span> <span style="color:#00a8c8">int</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">name</span><span style="color:#111">:</span><span style="color:#d88200">&#34;zhaohaiyu&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">age</span><span style="color:#111">:</span><span style="color:#ae81ff">18</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 利用给定数据渲染模板，并将结果写入w</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">tmpl</span><span style="color:#111">.</span><span style="color:#75af00">Execute</span><span style="color:#111">(</span><span style="color:#75af00">w</span><span style="color:#111">,</span> <span style="color:#75af00">user</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">HandleFunc</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">sayHello</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">ListenAndServe</span><span style="color:#111">(</span><span style="color:#d88200">&#34;:9090&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;HTTP server failed,err:&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><pre><code>Hello
姓名 {{.Name}}
年龄：{{.Age}}
同理，当我们传入的变量是map时，也可以在模板文件中通过.根据key来取值。
</code></pre>
<h3 id="注释">注释</h3>
<p>{{/* a comment */}}</p>
<h3 id="pipeline">pipeline</h3>
<ul>
<li>pipeline是指产生数据的操作。比如{{.}}、{{.Name}}等。Go的模板语法中支持使用管道符号|链接多个命令，用法和unix下的管道类似：|前面的命令会将运算结果(或返回值)传递给后一个命令的最后一个位置。</li>
</ul>
<p>**注意：**并不是只有使用了|才是pipeline。Go的模板语法中，pipeline的概念是传递数据，只要能产生数据的，都是pipeline。</p>
<h3 id="变量">变量</h3>
<ul>
<li>我们还可以在模板中声明变量，用来保存传入模板的数据或其他语句生成的结果。具体语法如下：</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">$</span><span style="color:#75af00">obj</span> <span style="color:#f92672">:=</span> <span style="color:#111">{{.}}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">其中</span><span style="color:#960050;background-color:#1e0010">$</span><span style="color:#75af00">obj是变量的名字</span><span style="color:#960050;background-color:#1e0010">，</span><span style="color:#75af00">在后续的代码中就可以使用该变量了</span><span style="color:#960050;background-color:#1e0010">。</span>
</span></span></code></pre></div><h3 id="移除空格">移除空格</h3>
<ul>
<li>有时候我们在使用模板语法的时候会不可避免的引入一下空格或者换行符，这样模板最终渲染出来的内容可能就和我们想的不一样，这个时候可以使用{{-语法去除模板内容左侧的所有空白符号， 使用-}}去除模板内容右侧的所有空白符号。</li>
</ul>
<p>例如：{{- .Name -}}</p>
<p><strong>注意：</strong>-要紧挨{{和}}，同时与模板值之间需要使用空格分隔。</p>
<h3 id="条件判断">条件判断</h3>
<ul>
<li>Go模板语法中的条件判断有以下几种:</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#111">{{</span><span style="color:#00a8c8">if</span> <span style="color:#75af00">pipeline</span><span style="color:#111">}}</span> <span style="color:#75af00">T1</span> <span style="color:#111">{{</span><span style="color:#75af00">end</span><span style="color:#111">}}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">{{</span><span style="color:#00a8c8">if</span> <span style="color:#75af00">pipeline</span><span style="color:#111">}}</span> <span style="color:#75af00">T1</span> <span style="color:#111">{{</span><span style="color:#00a8c8">else</span><span style="color:#111">}}</span> <span style="color:#75af00">T0</span> <span style="color:#111">{{</span><span style="color:#75af00">end</span><span style="color:#111">}}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">{{</span><span style="color:#00a8c8">if</span> <span style="color:#75af00">pipeline</span><span style="color:#111">}}</span> <span style="color:#75af00">T1</span> <span style="color:#111">{{</span><span style="color:#00a8c8">else</span> <span style="color:#00a8c8">if</span> <span style="color:#75af00">pipeline</span><span style="color:#111">}}</span> <span style="color:#75af00">T0</span> <span style="color:#111">{{</span><span style="color:#75af00">end</span><span style="color:#111">}}</span>
</span></span></code></pre></div><h3 id="range">range</h3>
<p>Go的模板语法中使用range关键字进行遍历，有以下两种写法，其中pipeline的值必须是数组、切片、字典或者通道。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#111">{{</span><span style="color:#00a8c8">range</span> <span style="color:#75af00">pipeline</span><span style="color:#111">}}</span> <span style="color:#75af00">T1</span> <span style="color:#111">{{</span><span style="color:#75af00">end</span><span style="color:#111">}}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">{{</span><span style="color:#00a8c8">range</span> <span style="color:#75af00">pipeline</span><span style="color:#111">}}</span> <span style="color:#75af00">T1</span> <span style="color:#111">{{</span><span style="color:#00a8c8">else</span><span style="color:#111">}}</span> <span style="color:#75af00">T0</span> <span style="color:#111">{{</span><span style="color:#75af00">end</span><span style="color:#111">}}</span>
</span></span></code></pre></div><h3 id="with">with</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#111">{{</span><span style="color:#75af00">with</span> <span style="color:#75af00">pipeline</span><span style="color:#111">}}</span> <span style="color:#75af00">T1</span> <span style="color:#111">{{</span><span style="color:#75af00">end</span><span style="color:#111">}}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">{{</span><span style="color:#75af00">with</span> <span style="color:#75af00">pipeline</span><span style="color:#111">}}</span> <span style="color:#75af00">T1</span> <span style="color:#111">{{</span><span style="color:#00a8c8">else</span><span style="color:#111">}}</span> <span style="color:#75af00">T0</span> <span style="color:#111">{{</span><span style="color:#75af00">end</span><span style="color:#111">}}</span>
</span></span></code></pre></div><h3 id="预定义函数">预定义函数</h3>
<p>执行模板时，函数从两个函数字典中查找：首先是模板函数字典，然后是全局函数字典。一般不在模板内定义函数，而是使用Funcs方法添加函数到模板里。</p>
<p>预定义的全局函数如下：</p>
<ol>
<li>and
<ul>
<li>函数返回它的第一个empty参数或者最后一个参数；</li>
<li>就是说&quot;and x y&quot;等价于&quot;if x then y else x&quot;；所有参数都会执行；</li>
</ul>
</li>
<li>or
<ul>
<li>返回第一个非empty参数或者最后一个参数；</li>
<li>亦即&quot;or x y&quot;等价于&quot;if x then x else y&quot;；所有参数都会执行；</li>
</ul>
</li>
<li>not
<ul>
<li>返回它的单个参数的布尔值的否定</li>
</ul>
</li>
<li>len
<ul>
<li>返回它的参数的整数类型长度</li>
</ul>
</li>
<li>index
<ul>
<li>执行结果为第一个参数以剩下的参数为索引/键指向的值；</li>
<li>如&quot;index x 1 2 3&quot;返回x[1][2][3]的值；每个被索引的主体必须是数组、切片或者字典。</li>
</ul>
</li>
<li>print
<ul>
<li>即fmt.Sprint</li>
</ul>
</li>
<li>printf
<ul>
<li>即fmt.Sprintf</li>
</ul>
</li>
<li>println
<ul>
<li>即fmt.Sprintln</li>
</ul>
</li>
<li>html
<ul>
<li>返回与其参数的文本表示形式等效的转义HTML。</li>
<li>这个函数在html/template中不可用。</li>
</ul>
</li>
<li>urlquery</li>
</ol>
<ul>
<li>以适合嵌入到网址查询中的形式返回其参数的文本表示的转义值。</li>
<li>这个函数在html/template中不可用。</li>
</ul>
<ol>
<li>js</li>
</ol>
<ul>
<li>返回与其参数的文本表示形式等效的转义JavaScript。</li>
</ul>
<ol>
<li>call</li>
</ol>
<ul>
<li>
<p>执行结果是调用第一个参数的返回值，该参数必须是函数类型，其余参数作为调用该函数的参数；</p>
<p>如&quot;call .X.Y 1 2&quot;等价于go语言里的dot.X.Y(1, 2)；
其中Y是函数类型的字段或者字典的值，或者其他类似情况；
call的第一个参数的执行结果必须是函数类型的值（和预定义函数如print明显不同）；
该函数类型值必须有1到2个返回值，如果有2个则后一个必须是error接口类型；
如果有2个返回值的方法返回的error非nil，模板执行会中断并返回给调用模板执行者该错误；</p>
</li>
</ul>
<h3 id="比较函数">比较函数</h3>
<ul>
<li>布尔函数会将任何类型的零值视为假，其余视为真。</li>
</ul>
<p>下面是定义为函数的二元比较运算的集合：</p>
<p>eq      如果arg1 == arg2则返回真
ne      如果arg1 != arg2则返回真
lt      如果arg1 &lt; arg2则返回真
le      如果arg1 &lt;= arg2则返回真
gt      如果arg1 &gt; arg2则返回真
ge      如果arg1 &gt;= arg2则返回真</p>
<p>为了简化多参数相等检测，eq（只有eq）可以接受2个或更多个参数，它会将第一个参数和其余参数依次比较，返回下式的结果：</p>
<p>{{eq arg1 arg2 arg3}}</p>
<p>比较函数只适用于基本类型（或重定义的基本类型，如”type Celsius float32”）。但是，整数和浮点数不能互相比较。</p>
<h3 id="自定义函数">自定义函数</h3>
<p>Go的模板支持自定义函数。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">sayHello</span><span style="color:#111">(</span><span style="color:#75af00">w</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">ResponseWriter</span><span style="color:#111">,</span> <span style="color:#75af00">r</span> <span style="color:#f92672">*</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Request</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">htmlByte</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">ioutil</span><span style="color:#111">.</span><span style="color:#75af00">ReadFile</span><span style="color:#111">(</span><span style="color:#d88200">&#34;./hello.tmpl&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;read html failed, err:&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 自定义一个夸人的模板函数</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">kua</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">arg</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#00a8c8">string</span><span style="color:#111">,</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">arg</span> <span style="color:#f92672">+</span> <span style="color:#d88200">&#34;真帅&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 采用链式操作在Parse之前调用Funcs添加自定义的kua函数</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">tmpl</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">template</span><span style="color:#111">.</span><span style="color:#75af00">New</span><span style="color:#111">(</span><span style="color:#d88200">&#34;hello&#34;</span><span style="color:#111">).</span><span style="color:#75af00">Funcs</span><span style="color:#111">(</span><span style="color:#75af00">template</span><span style="color:#111">.</span><span style="color:#75af00">FuncMap</span><span style="color:#111">{</span><span style="color:#d88200">&#34;kua&#34;</span><span style="color:#111">:</span> <span style="color:#75af00">kua</span><span style="color:#111">}).</span><span style="color:#75af00">Parse</span><span style="color:#111">(</span><span style="color:#111">string</span><span style="color:#111">(</span><span style="color:#75af00">htmlByte</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;create template failed, err:&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">user</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">UserInfo</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">Name</span><span style="color:#111">:</span>   <span style="color:#d88200">&#34;小王子&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">Gender</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;男&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">Age</span><span style="color:#111">:</span>    <span style="color:#ae81ff">18</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 使用user渲染模板，并将结果写入w</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">tmpl</span><span style="color:#111">.</span><span style="color:#75af00">Execute</span><span style="color:#111">(</span><span style="color:#75af00">w</span><span style="color:#111">,</span> <span style="color:#75af00">user</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>我们可以在模板文件hello.tmpl中按照如下方式使用我们自定义的kua函数了。</p>
<p>{{kua .Name}}</p>
<h3 id="嵌套template">嵌套template</h3>
<p>我们可以在template中嵌套其他的template。这个template可以是单独的文件，也可以是通过define定义的template。</p>
<p>举个例子：t.tmpl文件内容如下：tmpl test</p>
<p>测试嵌套template语法 {{template &ldquo;ul.tmpl&rdquo;}}</p>
<pre><code>{{template &quot;ol.tmpl&quot;}}

{{ define &quot;ol.tmpl&quot;}}
吃饭
睡觉
打豆豆
{{end}}
</code></pre>
<p>ul.tmpl文件内容如下：
注释
日志
测试
我们注册一个templDemo路由处理函数.
http.HandleFunc(&quot;/tmpl&quot;, tmplDemo)
tmplDemo函数的具体内容如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">tmplDemo</span><span style="color:#111">(</span><span style="color:#75af00">w</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">ResponseWriter</span><span style="color:#111">,</span> <span style="color:#75af00">r</span> <span style="color:#f92672">*</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Request</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">tmpl</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">template</span><span style="color:#111">.</span><span style="color:#75af00">ParseFiles</span><span style="color:#111">(</span><span style="color:#d88200">&#34;./t.tmpl&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;./ul.tmpl&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;create template failed, err:&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">user</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">UserInfo</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">Name</span><span style="color:#111">:</span>   <span style="color:#d88200">&#34;小王子&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">Gender</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;男&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">Age</span><span style="color:#111">:</span>    <span style="color:#ae81ff">18</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">tmpl</span><span style="color:#111">.</span><span style="color:#75af00">Execute</span><span style="color:#111">(</span><span style="color:#75af00">w</span><span style="color:#111">,</span> <span style="color:#75af00">user</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p><strong>注意</strong>：在解析模板时，被嵌套的模板一定要在后面解析，例如上面的示例中t.tmpl模板中嵌套了ul.tmpl，所以ul.tmpl要在t.tmpl后进行解析。</p>
<h3 id="block">block</h3>
<p>{{block &ldquo;name&rdquo; pipeline}} T1 {{end}}</p>
<p>block是定义模板{{define &ldquo;name&rdquo;}} T1 {{end}}和执行{{template &ldquo;name&rdquo; pipeline}}缩写，典型的用法是定义一组根模板，然后通过在其中重新定义块模板进行自定义。</p>
<p>定义一个根模板templates/base.tmpl，内容如下：Go Templates</p>
<p>{{block &ldquo;content&rdquo; . }}{{end}}</p>
<p>然后定义一个templates/index.tmpl，”继承”base.tmpl：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#111">{{</span><span style="color:#75af00">template</span> <span style="color:#d88200">&#34;base.tmpl&#34;</span><span style="color:#111">}}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">{{</span><span style="color:#75af00">define</span> <span style="color:#d88200">&#34;content&#34;</span><span style="color:#111">}}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">Hello</span> <span style="color:#75af00">world</span><span style="color:#111">!</span>
</span></span><span style="display:flex;"><span><span style="color:#111">{{</span><span style="color:#75af00">end</span><span style="color:#111">}}</span>
</span></span></code></pre></div><p>然后使用template.ParseGlob按照正则匹配规则解析模板文件，然后通过ExecuteTemplate渲染指定的模板：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">index</span><span style="color:#111">(</span><span style="color:#75af00">w</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">ResponseWriter</span><span style="color:#111">,</span> <span style="color:#75af00">r</span> <span style="color:#f92672">*</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Request</span><span style="color:#111">){</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">tmpl</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">template</span><span style="color:#111">.</span><span style="color:#75af00">ParseGlob</span><span style="color:#111">(</span><span style="color:#d88200">&#34;templates/*.tmpl&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;create template failed, err:&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">tmpl</span><span style="color:#111">.</span><span style="color:#75af00">ExecuteTemplate</span><span style="color:#111">(</span><span style="color:#75af00">w</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;index.tmpl&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;render template failed, err:&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>如果我们的模板名称冲突了，例如不同业务线下都定义了一个index.tmpl模板，我们可以通过下面两种方法来解决。</p>
<ol>
<li>在模板文件开头使用{{define 模板名}}语句显式的为模板命名。</li>
<li>可以把模板文件存放在templates文件夹下面的不同目录中，然后使用template.ParseGlob(&ldquo;templates/**/*.tmpl&rdquo;)解析模板。</li>
</ol>
<h3 id="修改默认的标识符">修改默认的标识符</h3>
<p>Go标准库的模板引擎使用的花括号{{和}}作为标识，而许多前端框架（如Vue和AngularJS）也使用{{和}}作为标识符，所以当我们同时使用Go语言模板引擎和以上前端框架时就会出现冲突，这个时候我们需要修改标识符，修改前端的或者修改Go语言的。这里演示如何修改Go语言模板引擎默认的标识符：</p>
<p>template.New(&ldquo;test&rdquo;).Delims(&quot;{[&quot;, &ldquo;]}&rdquo;).ParseFiles(&quot;./t.tmpl&quot;)</p>
<h2 id="texttemplate与htmltempalte的区别">text/template与html/tempalte的区别</h2>
<p>html/template针对的是需要返回HTML内容的场景，在模板渲染过程中会对一些有风险的内容进行转义，以此来防范跨站脚本攻击。</p>
<p>例如，我定义下面的模板文件：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">Hello</span>
</span></span><span style="display:flex;"><span><span style="color:#111">{{.}}</span>
</span></span></code></pre></div><p>这个时候传入一段JS代码并使用html/template去渲染该文件，会在页面上显示出转义后的JS内容。alert(&lsquo;嘿嘿嘿&rsquo;)这就是html/template为我们做的事。</p>
<p>但是在某些场景下，我们如果相信用户输入的内容，不想转义的话，可以自行编写一个safe函数，手动返回一个template.HTML类型的内容。示例如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">xss</span><span style="color:#111">(</span><span style="color:#75af00">w</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">ResponseWriter</span><span style="color:#111">,</span> <span style="color:#75af00">r</span> <span style="color:#f92672">*</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Request</span><span style="color:#111">){</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">tmpl</span><span style="color:#111">,</span><span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">template</span><span style="color:#111">.</span><span style="color:#75af00">New</span><span style="color:#111">(</span><span style="color:#d88200">&#34;xss.tmpl&#34;</span><span style="color:#111">).</span><span style="color:#75af00">Funcs</span><span style="color:#111">(</span><span style="color:#75af00">template</span><span style="color:#111">.</span><span style="color:#75af00">FuncMap</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#d88200">&#34;safe&#34;</span><span style="color:#111">:</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">s</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span><span style="color:#75af00">template</span><span style="color:#111">.</span><span style="color:#75af00">HTML</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#75af00">template</span><span style="color:#111">.</span><span style="color:#75af00">HTML</span><span style="color:#111">(</span><span style="color:#75af00">s</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">},</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}).</span><span style="color:#75af00">ParseFiles</span><span style="color:#111">(</span><span style="color:#d88200">&#34;./xss.tmpl&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;create template failed, err:&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">jsStr</span> <span style="color:#f92672">:=</span> <span style="color:#d88200">`alert(&#39;嘿嘿嘿&#39;)`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">tmpl</span><span style="color:#111">.</span><span style="color:#75af00">Execute</span><span style="color:#111">(</span><span style="color:#75af00">w</span><span style="color:#111">,</span> <span style="color:#75af00">jsStr</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>这样我们只需要在模板文件不需要转义的内容后面使用我们定义好的safe函数就可以了。{{ . | safe }}</p>
<h2 id="代码生成">代码生成</h2>
<p><strong>生成代码用text/template包,模板语法和html/template一样</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;html/template&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">var</span> <span style="color:#75af00">data</span> <span style="color:#111">=</span> <span style="color:#d88200">`
</span></span></span><span style="display:flex;"><span><span style="color:#d88200">package main
</span></span></span><span style="display:flex;"><span><span style="color:#d88200">import &#34;fmt&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#d88200">func main() {
</span></span></span><span style="display:flex;"><span><span style="color:#d88200">	str := &#34;</span><span style="color:#75715e">{{</span> <span style="color:#75af00">.</span> <span style="color:#75715e">}}</span><span style="color:#d88200">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#d88200">	for _, v := range str {
</span></span></span><span style="display:flex;"><span><span style="color:#d88200">		fmt.Println(v)
</span></span></span><span style="display:flex;"><span><span style="color:#d88200">	}
</span></span></span><span style="display:flex;"><span><span style="color:#d88200">}
</span></span></span><span style="display:flex;"><span><span style="color:#d88200">`</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">t</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">template</span><span style="color:#111">.</span><span style="color:#75af00">New</span><span style="color:#111">(</span><span style="color:#d88200">&#34;main&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">t</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">Parse</span><span style="color:#111">(</span><span style="color:#75af00">data</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;解析失败&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">var</span> <span style="color:#75af00">str</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;zhaohaiyu&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">file</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">OpenFile</span><span style="color:#111">(</span><span style="color:#d88200">&#34;./print/main.go&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">O_WRONLY</span><span style="color:#111">|</span><span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">O_CREATE</span><span style="color:#111">|</span><span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">O_TRUNC</span><span style="color:#111">,</span> <span style="color:#ae81ff">0755</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;open file:%s failed, err:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;./print/main.go&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">Execute</span><span style="color:#111">(</span><span style="color:#75af00">file</span><span style="color:#111">,</span> <span style="color:#75af00">str</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;execute failed err:&#34;</span><span style="color:#111">,</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>生成的代码:</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">str</span> <span style="color:#f92672">:=</span> <span style="color:#d88200">&#34;zhaohaiyu&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">v</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">str</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">v</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>参考文章:</p>
<ul>
<li><a href="https://www.liwenzhou.com/posts/Go/go_template/#autoid-1-3-0">https://www.liwenzhou.com/posts/Go/go_template/#autoid-1-3-0</a></li>
</ul>
]]></content:encoded><category>go</category><category>go</category></item><item><title>golang 反射</title><link>https://daemon365.dev/post/go/golang_reflection/</link><pubDate>Fri, 12 Jul 2019 00:00:00 +0800</pubDate><guid>https://daemon365.dev/post/go/golang_reflection/</guid><description>&lt;h2 id="变量的内在机制"&gt;变量的内在机制&lt;/h2&gt;
&lt;p&gt;Go语言中的变量是分为两部分的:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;类型信息：预先定义好的元信息。&lt;/li&gt;
&lt;li&gt;值信息：程序运行过程中可动态变化的。&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="反射介绍"&gt;反射介绍&lt;/h2&gt;
&lt;p&gt;反射是指在程序运行期对程序本身进行访问和修改的能力。程序在编译时，变量被转换为内存地址，变量名不会被编译器写入到可执行部分。在运行程序时，程序无法获取自身的信息。&lt;/p&gt;
&lt;p&gt;支持反射的语言可以在程序编译期将变量的反射信息，如字段名称、类型信息、结构体信息等整合到可执行文件中，并给程序提供接口访问反射信息，这样就可以在程序运行期获取类型的反射信息，并且有能力修改它们。&lt;/p&gt;
&lt;p&gt;Go程序在运行期使用reflect包访问程序的反射信息。&lt;/p&gt;
&lt;p&gt;在上一篇博客中我们介绍了空接口。 空接口可以存储任意类型的变量，那我们如何知道这个空接口保存的数据是什么呢？ 反射就是在运行时动态的获取一个变量的类型信息和值信息。&lt;/p&gt;
&lt;h2 id="reflect包"&gt;reflect包&lt;/h2&gt;
&lt;p&gt;在Go语言的反射机制中，任何接口值都由是&lt;code&gt;一个具体类型&lt;/code&gt;和&lt;code&gt;具体类型的值&lt;/code&gt;两部分组成的(我们在上一篇接口的博客中有介绍相关概念)。 在Go语言中反射的相关功能由内置的reflect包提供，任意接口值在反射中都可以理解为由&lt;code&gt;reflect.Type&lt;/code&gt;和&lt;code&gt;reflect.Value&lt;/code&gt;两部分组成，并且reflect包提供了&lt;code&gt;reflect.TypeOf&lt;/code&gt;和&lt;code&gt;reflect.ValueOf&lt;/code&gt;两个函数来获取任意对象的Value和Type。&lt;/p&gt;
&lt;h2 id="reflecttype-和-reflectvalue"&gt;reflect.Type 和 reflect.Value&lt;/h2&gt;
&lt;p&gt;反射是由 reflect 包提供的。它定义了两个重要的类型，Type 和 Value。一个 Type 表示一个Go类型。它是一个接口，有许多方法来区分类型以及检查它们的组成部分，例如一个结构体的成员或一个函数的参数等。唯一能反映 reflect.Type 实现的是接口的类型描述信息（§7.5），也正是这个实体标识了接口值的动态类型。&lt;/p&gt;
&lt;p&gt;函数 reflect.TypeOf 接受任意的 interface{} 类型，并以 reflect.Type 形式返回其动态类型：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-Go" data-lang="Go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75af00"&gt;t&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;reflect&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;TypeOf&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;3&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75715e"&gt;// a reflect.Type&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;t&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;String&lt;/span&gt;&lt;span style="color:#111"&gt;())&lt;/span&gt; &lt;span style="color:#75715e"&gt;// &amp;#34;int&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;t&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75715e"&gt;// &amp;#34;int&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;其中 TypeOf(3) 调用将值 3 传给 interface{} 参数。回到 7.5节 的将一个具体的值转为接口类型会有一个隐式的接口转换操作，它会创建一个包含两个信息的接口值：操作数的动态类型（这里是 int）和它的动态的值（这里是 3）。&lt;/p&gt;
&lt;p&gt;因为 reflect.TypeOf 返回的是一个动态类型的接口值，它总是返回具体的类型。因此，下面的代码将打印 &amp;ldquo;*os.File&amp;rdquo; 而不是 &amp;ldquo;io.Writer&amp;rdquo;。稍后，我们将看到能够表达接口类型的 reflect.Type。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-Go" data-lang="Go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;var&lt;/span&gt; &lt;span style="color:#75af00"&gt;w&lt;/span&gt; &lt;span style="color:#75af00"&gt;io&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Writer&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#75af00"&gt;os&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Stdout&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;reflect&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;TypeOf&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;w&lt;/span&gt;&lt;span style="color:#111"&gt;))&lt;/span&gt; &lt;span style="color:#75715e"&gt;// &amp;#34;*os.File&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;要注意的是 reflect.Type 接口是满足 fmt.Stringer 接口的。因为打印一个接口的动态类型对于调试和日志是有帮助的， fmt.Printf 提供了一个缩写 %T 参数，内部使用 reflect.TypeOf 来输出：&lt;/p&gt;</description><content:encoded><![CDATA[<h2 id="变量的内在机制">变量的内在机制</h2>
<p>Go语言中的变量是分为两部分的:</p>
<ul>
<li>类型信息：预先定义好的元信息。</li>
<li>值信息：程序运行过程中可动态变化的。</li>
</ul>
<h2 id="反射介绍">反射介绍</h2>
<p>反射是指在程序运行期对程序本身进行访问和修改的能力。程序在编译时，变量被转换为内存地址，变量名不会被编译器写入到可执行部分。在运行程序时，程序无法获取自身的信息。</p>
<p>支持反射的语言可以在程序编译期将变量的反射信息，如字段名称、类型信息、结构体信息等整合到可执行文件中，并给程序提供接口访问反射信息，这样就可以在程序运行期获取类型的反射信息，并且有能力修改它们。</p>
<p>Go程序在运行期使用reflect包访问程序的反射信息。</p>
<p>在上一篇博客中我们介绍了空接口。 空接口可以存储任意类型的变量，那我们如何知道这个空接口保存的数据是什么呢？ 反射就是在运行时动态的获取一个变量的类型信息和值信息。</p>
<h2 id="reflect包">reflect包</h2>
<p>在Go语言的反射机制中，任何接口值都由是<code>一个具体类型</code>和<code>具体类型的值</code>两部分组成的(我们在上一篇接口的博客中有介绍相关概念)。 在Go语言中反射的相关功能由内置的reflect包提供，任意接口值在反射中都可以理解为由<code>reflect.Type</code>和<code>reflect.Value</code>两部分组成，并且reflect包提供了<code>reflect.TypeOf</code>和<code>reflect.ValueOf</code>两个函数来获取任意对象的Value和Type。</p>
<h2 id="reflecttype-和-reflectvalue">reflect.Type 和 reflect.Value</h2>
<p>反射是由 reflect 包提供的。它定义了两个重要的类型，Type 和 Value。一个 Type 表示一个Go类型。它是一个接口，有许多方法来区分类型以及检查它们的组成部分，例如一个结构体的成员或一个函数的参数等。唯一能反映 reflect.Type 实现的是接口的类型描述信息（§7.5），也正是这个实体标识了接口值的动态类型。</p>
<p>函数 reflect.TypeOf 接受任意的 interface{} 类型，并以 reflect.Type 形式返回其动态类型：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Go" data-lang="Go"><span style="display:flex;"><span><span style="color:#75af00">t</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">reflect</span><span style="color:#111">.</span><span style="color:#75af00">TypeOf</span><span style="color:#111">(</span><span style="color:#ae81ff">3</span><span style="color:#111">)</span>  <span style="color:#75715e">// a reflect.Type</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">String</span><span style="color:#111">())</span> <span style="color:#75715e">// &#34;int&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">t</span><span style="color:#111">)</span>          <span style="color:#75715e">// &#34;int&#34;</span>
</span></span></code></pre></div><p>其中 TypeOf(3) 调用将值 3 传给 interface{} 参数。回到 7.5节 的将一个具体的值转为接口类型会有一个隐式的接口转换操作，它会创建一个包含两个信息的接口值：操作数的动态类型（这里是 int）和它的动态的值（这里是 3）。</p>
<p>因为 reflect.TypeOf 返回的是一个动态类型的接口值，它总是返回具体的类型。因此，下面的代码将打印 &ldquo;*os.File&rdquo; 而不是 &ldquo;io.Writer&rdquo;。稍后，我们将看到能够表达接口类型的 reflect.Type。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Go" data-lang="Go"><span style="display:flex;"><span><span style="color:#00a8c8">var</span> <span style="color:#75af00">w</span> <span style="color:#75af00">io</span><span style="color:#111">.</span><span style="color:#75af00">Writer</span> <span style="color:#111">=</span> <span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">Stdout</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">reflect</span><span style="color:#111">.</span><span style="color:#75af00">TypeOf</span><span style="color:#111">(</span><span style="color:#75af00">w</span><span style="color:#111">))</span> <span style="color:#75715e">// &#34;*os.File&#34;</span>
</span></span></code></pre></div><p>要注意的是 reflect.Type 接口是满足 fmt.Stringer 接口的。因为打印一个接口的动态类型对于调试和日志是有帮助的， fmt.Printf 提供了一个缩写 %T 参数，内部使用 reflect.TypeOf 来输出：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Go" data-lang="Go"><span style="display:flex;"><span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;%T\n&#34;</span><span style="color:#111">,</span> <span style="color:#ae81ff">3</span><span style="color:#111">)</span> <span style="color:#75715e">// &#34;int&#34;</span>
</span></span></code></pre></div><p>reflect 包中另一个重要的类型是 Value。一个 reflect.Value 可以装载任意类型的值。函数 reflect.ValueOf 接受任意的 interface{} 类型，并返回一个装载着其动态值的 reflect.Value。和 reflect.TypeOf 类似，reflect.ValueOf 返回的结果也是具体的类型，但是 reflect.Value 也可以持有一个接口值。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Go" data-lang="Go"><span style="display:flex;"><span><span style="color:#75af00">v</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">reflect</span><span style="color:#111">.</span><span style="color:#75af00">ValueOf</span><span style="color:#111">(</span><span style="color:#ae81ff">3</span><span style="color:#111">)</span> <span style="color:#75715e">// a reflect.Value</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">v</span><span style="color:#111">)</span>          <span style="color:#75715e">// &#34;3&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">v</span><span style="color:#111">)</span>   <span style="color:#75715e">// &#34;3&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">v</span><span style="color:#111">.</span><span style="color:#75af00">String</span><span style="color:#111">())</span> <span style="color:#75715e">// NOTE: &#34;&lt;int Value&gt;&#34;</span>
</span></span></code></pre></div><p>和 reflect.Type 类似，reflect.Value 也满足 fmt.Stringer 接口，但是除非 Value 持有的是字符串，否则 String 方法只返回其类型。而使用 fmt 包的 %v 标志参数会对 reflect.Values 特殊处理。</p>
<p>对 Value 调用 Type 方法将返回具体类型所对应的 reflect.Type：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Go" data-lang="Go"><span style="display:flex;"><span><span style="color:#75af00">t</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">v</span><span style="color:#111">.</span><span style="color:#75af00">Type</span><span style="color:#111">()</span>           <span style="color:#75715e">// a reflect.Type</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">String</span><span style="color:#111">())</span> <span style="color:#75715e">// &#34;int&#34;</span>
</span></span></code></pre></div><p>reflect.ValueOf 的逆操作是 reflect.Value.Interface 方法。它返回一个 interface{} 类型，装载着与 reflect.Value 相同的具体值：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Go" data-lang="Go"><span style="display:flex;"><span><span style="color:#75af00">v</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">reflect</span><span style="color:#111">.</span><span style="color:#75af00">ValueOf</span><span style="color:#111">(</span><span style="color:#ae81ff">3</span><span style="color:#111">)</span> <span style="color:#75715e">// a reflect.Value</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">x</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">v</span><span style="color:#111">.</span><span style="color:#75af00">Interface</span><span style="color:#111">()</span>      <span style="color:#75715e">// an interface{}</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">i</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">x</span><span style="color:#111">.(</span><span style="color:#00a8c8">int</span><span style="color:#111">)</span>            <span style="color:#75715e">// an int</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;%d\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">i</span><span style="color:#111">)</span>   <span style="color:#75715e">// &#34;3&#34;</span>
</span></span></code></pre></div><p>reflect.Value 和 interface{} 都能装载任意的值。所不同的是，一个空的接口隐藏了值内部的表示方式和所有方法，因此只有我们知道具体的动态类型才能使用类型断言来访问内部的值（就像上面那样），内部值我们没法访问。相比之下，一个 Value 则有很多方法来检查其内容，无论它的具体类型是什么。让我们再次尝试实现我们的格式化函数 format.Any。</p>
<p>我们使用 reflect.Value 的 Kind 方法来替代之前的类型 switch。虽然还是有无穷多的类型，但是它们的 kinds 类型却是有限的：Bool、String 和 所有数字类型的基础类型；Array 和 Struct 对应的聚合类型；Chan、Func、Ptr、Slice 和 Map 对应的引用类型；interface 类型；还有表示空值的 Invalid 类型。（空的 reflect.Value 的 kind 即为 Invalid。）</p>
<p><em>gopl.io/ch12/format</em></p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Go" data-lang="Go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">format</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d88200">&#34;reflect&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d88200">&#34;strconv&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Any formats any value as a string.</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">Any</span><span style="color:#111">(</span><span style="color:#75af00">value</span> <span style="color:#00a8c8">interface</span><span style="color:#111">{})</span> <span style="color:#00a8c8">string</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#75af00">formatAtom</span><span style="color:#111">(</span><span style="color:#75af00">reflect</span><span style="color:#111">.</span><span style="color:#75af00">ValueOf</span><span style="color:#111">(</span><span style="color:#75af00">value</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// formatAtom formats a value without inspecting its internal structure.</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">formatAtom</span><span style="color:#111">(</span><span style="color:#75af00">v</span> <span style="color:#75af00">reflect</span><span style="color:#111">.</span><span style="color:#75af00">Value</span><span style="color:#111">)</span> <span style="color:#00a8c8">string</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">switch</span> <span style="color:#75af00">v</span><span style="color:#111">.</span><span style="color:#75af00">Kind</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">case</span> <span style="color:#75af00">reflect</span><span style="color:#111">.</span><span style="color:#75af00">Invalid</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#d88200">&#34;invalid&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">case</span> <span style="color:#75af00">reflect</span><span style="color:#111">.</span><span style="color:#75af00">Int</span><span style="color:#111">,</span> <span style="color:#75af00">reflect</span><span style="color:#111">.</span><span style="color:#75af00">Int8</span><span style="color:#111">,</span> <span style="color:#75af00">reflect</span><span style="color:#111">.</span><span style="color:#75af00">Int16</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">reflect</span><span style="color:#111">.</span><span style="color:#75af00">Int32</span><span style="color:#111">,</span> <span style="color:#75af00">reflect</span><span style="color:#111">.</span><span style="color:#75af00">Int64</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">strconv</span><span style="color:#111">.</span><span style="color:#75af00">FormatInt</span><span style="color:#111">(</span><span style="color:#75af00">v</span><span style="color:#111">.</span><span style="color:#75af00">Int</span><span style="color:#111">(),</span> <span style="color:#ae81ff">10</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">case</span> <span style="color:#75af00">reflect</span><span style="color:#111">.</span><span style="color:#75af00">Uint</span><span style="color:#111">,</span> <span style="color:#75af00">reflect</span><span style="color:#111">.</span><span style="color:#75af00">Uint8</span><span style="color:#111">,</span> <span style="color:#75af00">reflect</span><span style="color:#111">.</span><span style="color:#75af00">Uint16</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">reflect</span><span style="color:#111">.</span><span style="color:#75af00">Uint32</span><span style="color:#111">,</span> <span style="color:#75af00">reflect</span><span style="color:#111">.</span><span style="color:#75af00">Uint64</span><span style="color:#111">,</span> <span style="color:#75af00">reflect</span><span style="color:#111">.</span><span style="color:#75af00">Uintptr</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">strconv</span><span style="color:#111">.</span><span style="color:#75af00">FormatUint</span><span style="color:#111">(</span><span style="color:#75af00">v</span><span style="color:#111">.</span><span style="color:#75af00">Uint</span><span style="color:#111">(),</span> <span style="color:#ae81ff">10</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ...floating-point and complex cases omitted for brevity...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">case</span> <span style="color:#75af00">reflect</span><span style="color:#111">.</span><span style="color:#75af00">Bool</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">strconv</span><span style="color:#111">.</span><span style="color:#75af00">FormatBool</span><span style="color:#111">(</span><span style="color:#75af00">v</span><span style="color:#111">.</span><span style="color:#75af00">Bool</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">case</span> <span style="color:#75af00">reflect</span><span style="color:#111">.</span><span style="color:#75af00">String</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">strconv</span><span style="color:#111">.</span><span style="color:#75af00">Quote</span><span style="color:#111">(</span><span style="color:#75af00">v</span><span style="color:#111">.</span><span style="color:#75af00">String</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">case</span> <span style="color:#75af00">reflect</span><span style="color:#111">.</span><span style="color:#75af00">Chan</span><span style="color:#111">,</span> <span style="color:#75af00">reflect</span><span style="color:#111">.</span><span style="color:#75af00">Func</span><span style="color:#111">,</span> <span style="color:#75af00">reflect</span><span style="color:#111">.</span><span style="color:#75af00">Ptr</span><span style="color:#111">,</span> <span style="color:#75af00">reflect</span><span style="color:#111">.</span><span style="color:#75af00">Slice</span><span style="color:#111">,</span> <span style="color:#75af00">reflect</span><span style="color:#111">.</span><span style="color:#75af00">Map</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">v</span><span style="color:#111">.</span><span style="color:#75af00">Type</span><span style="color:#111">().</span><span style="color:#75af00">String</span><span style="color:#111">()</span> <span style="color:#f92672">+</span> <span style="color:#d88200">&#34; 0x&#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75af00">strconv</span><span style="color:#111">.</span><span style="color:#75af00">FormatUint</span><span style="color:#111">(</span><span style="color:#111">uint64</span><span style="color:#111">(</span><span style="color:#75af00">v</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">()),</span> <span style="color:#ae81ff">16</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">default</span><span style="color:#111">:</span> <span style="color:#75715e">// reflect.Array, reflect.Struct, reflect.Interface</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">v</span><span style="color:#111">.</span><span style="color:#75af00">Type</span><span style="color:#111">().</span><span style="color:#75af00">String</span><span style="color:#111">()</span> <span style="color:#f92672">+</span> <span style="color:#d88200">&#34; value&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>到目前为止，我们的函数将每个值视作一个不可分割没有内部结构的物品，因此它叫 formatAtom。对于聚合类型（结构体和数组）和接口，只是打印值的类型，对于引用类型（channels、functions、pointers、slices 和 maps），打印类型和十六进制的引用地址。虽然还不够理想，但是依然是一个重大的进步，并且 Kind 只关心底层表示，format.Any 也支持具名类型。例如：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Go" data-lang="Go"><span style="display:flex;"><span><span style="color:#00a8c8">var</span> <span style="color:#75af00">x</span> <span style="color:#00a8c8">int64</span> <span style="color:#111">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">var</span> <span style="color:#75af00">d</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Duration</span> <span style="color:#111">=</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">*</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Nanosecond</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">format</span><span style="color:#111">.</span><span style="color:#75af00">Any</span><span style="color:#111">(</span><span style="color:#75af00">x</span><span style="color:#111">))</span>                  <span style="color:#75715e">// &#34;1&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">format</span><span style="color:#111">.</span><span style="color:#75af00">Any</span><span style="color:#111">(</span><span style="color:#75af00">d</span><span style="color:#111">))</span>                  <span style="color:#75715e">// &#34;1&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">format</span><span style="color:#111">.</span><span style="color:#75af00">Any</span><span style="color:#111">([]</span><span style="color:#00a8c8">int64</span><span style="color:#111">{</span><span style="color:#75af00">x</span><span style="color:#111">}))</span>         <span style="color:#75715e">// &#34;[]int64 0x8202b87b0&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">format</span><span style="color:#111">.</span><span style="color:#75af00">Any</span><span style="color:#111">([]</span><span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Duration</span><span style="color:#111">{</span><span style="color:#75af00">d</span><span style="color:#111">}))</span> <span style="color:#75715e">// &#34;[]time.Duration 0x8202b87e0&#34;</span>
</span></span></code></pre></div><h2 id="通过reflectvalue修改值">通过reflect.Value修改值</h2>
<p>到目前为止，反射还只是程序中变量的另一种读取方式。然而，在本节中我们将重点讨论如何通过反射机制来修改变量。</p>
<p>回想一下，Go语言中类似x、x.f[1]和*p形式的表达式都可以表示变量，但是其它如x + 1和f(2)则不是变量。一个变量就是一个可寻址的内存空间，里面存储了一个值，并且存储的值可以通过内存地址来更新。</p>
<p>对于reflect.Values也有类似的区别。有一些reflect.Values是可取地址的；其它一些则不可以。考虑以下的声明语句：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Go" data-lang="Go"><span style="display:flex;"><span><span style="color:#75af00">x</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">2</span>                   <span style="color:#75715e">// value   type    variable?</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">a</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">reflect</span><span style="color:#111">.</span><span style="color:#75af00">ValueOf</span><span style="color:#111">(</span><span style="color:#ae81ff">2</span><span style="color:#111">)</span>  <span style="color:#75715e">// 2       int     no</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">b</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">reflect</span><span style="color:#111">.</span><span style="color:#75af00">ValueOf</span><span style="color:#111">(</span><span style="color:#75af00">x</span><span style="color:#111">)</span>  <span style="color:#75715e">// 2       int     no</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">c</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">reflect</span><span style="color:#111">.</span><span style="color:#75af00">ValueOf</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">x</span><span style="color:#111">)</span> <span style="color:#75715e">// &amp;x      *int    no</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">d</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">Elem</span><span style="color:#111">()</span>            <span style="color:#75715e">// 2       int     yes (x)</span>
</span></span></code></pre></div><p>其中a对应的变量不可取地址。因为a中的值仅仅是整数2的拷贝副本。b中的值也同样不可取地址。c中的值还是不可取地址，它只是一个指针<code>&amp;x</code>的拷贝。实际上，所有通过reflect.ValueOf(x)返回的reflect.Value都是不可取地址的。但是对于d，它是c的解引用方式生成的，指向另一个变量，因此是可取地址的。我们可以通过调用reflect.ValueOf(&amp;x).Elem()，来获取任意变量x对应的可取地址的Value。</p>
<p>我们可以通过调用reflect.Value的CanAddr方法来判断其是否可以被取地址：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Go" data-lang="Go"><span style="display:flex;"><span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">a</span><span style="color:#111">.</span><span style="color:#75af00">CanAddr</span><span style="color:#111">())</span> <span style="color:#75715e">// &#34;false&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">CanAddr</span><span style="color:#111">())</span> <span style="color:#75715e">// &#34;false&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">CanAddr</span><span style="color:#111">())</span> <span style="color:#75715e">// &#34;false&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">d</span><span style="color:#111">.</span><span style="color:#75af00">CanAddr</span><span style="color:#111">())</span> <span style="color:#75715e">// &#34;true&#34;</span>
</span></span></code></pre></div><p>每当我们通过指针间接地获取的reflect.Value都是可取地址的，即使开始的是一个不可取地址的Value。在反射机制中，所有关于是否支持取地址的规则都是类似的。例如，slice的索引表达式e[i]将隐式地包含一个指针，它就是可取地址的，即使开始的e表达式不支持也没有关系。以此类推，reflect.ValueOf(e).Index(i)对应的值也是可取地址的，即使原始的reflect.ValueOf(e)不支持也没有关系。</p>
<p>要从变量对应的可取地址的reflect.Value来访问变量需要三个步骤。第一步是调用Addr()方法，它返回一个Value，里面保存了指向变量的指针。然后是在Value上调用Interface()方法，也就是返回一个interface{}，里面包含指向变量的指针。最后，如果我们知道变量的类型，我们可以使用类型的断言机制将得到的interface{}类型的接口强制转为普通的类型指针。这样我们就可以通过这个普通指针来更新变量了：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Go" data-lang="Go"><span style="display:flex;"><span><span style="color:#75af00">x</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">d</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">reflect</span><span style="color:#111">.</span><span style="color:#75af00">ValueOf</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">x</span><span style="color:#111">).</span><span style="color:#75af00">Elem</span><span style="color:#111">()</span>   <span style="color:#75715e">// d refers to the variable x</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">px</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">d</span><span style="color:#111">.</span><span style="color:#75af00">Addr</span><span style="color:#111">().</span><span style="color:#75af00">Interface</span><span style="color:#111">().(</span><span style="color:#f92672">*</span><span style="color:#00a8c8">int</span><span style="color:#111">)</span> <span style="color:#75715e">// px := &amp;x</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">*</span><span style="color:#75af00">px</span> <span style="color:#111">=</span> <span style="color:#ae81ff">3</span>                           <span style="color:#75715e">// x = 3</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">x</span><span style="color:#111">)</span>                    <span style="color:#75715e">// &#34;3&#34;</span>
</span></span></code></pre></div><p>或者，不使用指针，而是通过调用可取地址的reflect.Value的reflect.Value.Set方法来更新对应的值：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Go" data-lang="Go"><span style="display:flex;"><span><span style="color:#75af00">d</span><span style="color:#111">.</span><span style="color:#75af00">Set</span><span style="color:#111">(</span><span style="color:#75af00">reflect</span><span style="color:#111">.</span><span style="color:#75af00">ValueOf</span><span style="color:#111">(</span><span style="color:#ae81ff">4</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">x</span><span style="color:#111">)</span> <span style="color:#75715e">// &#34;4&#34;</span>
</span></span></code></pre></div><p>Set方法将在运行时执行和编译时进行类似的可赋值性约束的检查。以上代码，变量和值都是int类型，但是如果变量是int64类型，那么程序将抛出一个panic异常，所以关键问题是要确保改类型的变量可以接受对应的值：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Go" data-lang="Go"><span style="display:flex;"><span><span style="color:#75af00">d</span><span style="color:#111">.</span><span style="color:#75af00">Set</span><span style="color:#111">(</span><span style="color:#75af00">reflect</span><span style="color:#111">.</span><span style="color:#75af00">ValueOf</span><span style="color:#111">(</span><span style="color:#111">int64</span><span style="color:#111">(</span><span style="color:#ae81ff">5</span><span style="color:#111">)))</span> <span style="color:#75715e">// panic: int64 is not assignable to int</span>
</span></span></code></pre></div><p>同样，对一个不可取地址的reflect.Value调用Set方法也会导致panic异常：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Go" data-lang="Go"><span style="display:flex;"><span><span style="color:#75af00">x</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">b</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">reflect</span><span style="color:#111">.</span><span style="color:#75af00">ValueOf</span><span style="color:#111">(</span><span style="color:#75af00">x</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">Set</span><span style="color:#111">(</span><span style="color:#75af00">reflect</span><span style="color:#111">.</span><span style="color:#75af00">ValueOf</span><span style="color:#111">(</span><span style="color:#ae81ff">3</span><span style="color:#111">))</span> <span style="color:#75715e">// panic: Set using unaddressable value</span>
</span></span></code></pre></div><p>这里有很多用于基本数据类型的Set方法：SetInt、SetUint、SetString和SetFloat等。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Go" data-lang="Go"><span style="display:flex;"><span><span style="color:#75af00">d</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">reflect</span><span style="color:#111">.</span><span style="color:#75af00">ValueOf</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">x</span><span style="color:#111">).</span><span style="color:#75af00">Elem</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">d</span><span style="color:#111">.</span><span style="color:#75af00">SetInt</span><span style="color:#111">(</span><span style="color:#ae81ff">3</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">x</span><span style="color:#111">)</span> <span style="color:#75715e">// &#34;3&#34;</span>
</span></span></code></pre></div><p>从某种程度上说，这些Set方法总是尽可能地完成任务。以SetInt为例，只要变量是某种类型的有符号整数就可以工作，即使是一些命名的类型、甚至只要底层数据类型是有符号整数就可以，而且如果对于变量类型值太大的话会被自动截断。但需要谨慎的是：对于一个引用interface{}类型的reflect.Value调用SetInt会导致panic异常，即使那个interface{}变量对于整数类型也不行。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Go" data-lang="Go"><span style="display:flex;"><span><span style="color:#75af00">x</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">rx</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">reflect</span><span style="color:#111">.</span><span style="color:#75af00">ValueOf</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">x</span><span style="color:#111">).</span><span style="color:#75af00">Elem</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">rx</span><span style="color:#111">.</span><span style="color:#75af00">SetInt</span><span style="color:#111">(</span><span style="color:#ae81ff">2</span><span style="color:#111">)</span>                     <span style="color:#75715e">// OK, x = 2</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">rx</span><span style="color:#111">.</span><span style="color:#75af00">Set</span><span style="color:#111">(</span><span style="color:#75af00">reflect</span><span style="color:#111">.</span><span style="color:#75af00">ValueOf</span><span style="color:#111">(</span><span style="color:#ae81ff">3</span><span style="color:#111">))</span>       <span style="color:#75715e">// OK, x = 3</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">rx</span><span style="color:#111">.</span><span style="color:#75af00">SetString</span><span style="color:#111">(</span><span style="color:#d88200">&#34;hello&#34;</span><span style="color:#111">)</span>            <span style="color:#75715e">// panic: string is not assignable to int</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">rx</span><span style="color:#111">.</span><span style="color:#75af00">Set</span><span style="color:#111">(</span><span style="color:#75af00">reflect</span><span style="color:#111">.</span><span style="color:#75af00">ValueOf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;hello&#34;</span><span style="color:#111">))</span> <span style="color:#75715e">// panic: string is not assignable to int</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">var</span> <span style="color:#75af00">y</span> <span style="color:#00a8c8">interface</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">ry</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">reflect</span><span style="color:#111">.</span><span style="color:#75af00">ValueOf</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">y</span><span style="color:#111">).</span><span style="color:#75af00">Elem</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">ry</span><span style="color:#111">.</span><span style="color:#75af00">SetInt</span><span style="color:#111">(</span><span style="color:#ae81ff">2</span><span style="color:#111">)</span>                     <span style="color:#75715e">// panic: SetInt called on interface Value</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">ry</span><span style="color:#111">.</span><span style="color:#75af00">Set</span><span style="color:#111">(</span><span style="color:#75af00">reflect</span><span style="color:#111">.</span><span style="color:#75af00">ValueOf</span><span style="color:#111">(</span><span style="color:#ae81ff">3</span><span style="color:#111">))</span>       <span style="color:#75715e">// OK, y = int(3)</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">ry</span><span style="color:#111">.</span><span style="color:#75af00">SetString</span><span style="color:#111">(</span><span style="color:#d88200">&#34;hello&#34;</span><span style="color:#111">)</span>            <span style="color:#75715e">// panic: SetString called on interface Value</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">ry</span><span style="color:#111">.</span><span style="color:#75af00">Set</span><span style="color:#111">(</span><span style="color:#75af00">reflect</span><span style="color:#111">.</span><span style="color:#75af00">ValueOf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;hello&#34;</span><span style="color:#111">))</span> <span style="color:#75715e">// OK, y = &#34;hello&#34;</span>
</span></span></code></pre></div><p>当我们用Display显示os.Stdout结构时，我们发现反射可以越过Go语言的导出规则的限制读取结构体中未导出的成员，比如在类Unix系统上os.File结构体中的fd int成员。然而，利用反射机制并不能修改这些未导出的成员：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Go" data-lang="Go"><span style="display:flex;"><span><span style="color:#75af00">stdout</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">reflect</span><span style="color:#111">.</span><span style="color:#75af00">ValueOf</span><span style="color:#111">(</span><span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">Stdout</span><span style="color:#111">).</span><span style="color:#75af00">Elem</span><span style="color:#111">()</span> <span style="color:#75715e">// *os.Stdout, an os.File var</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">stdout</span><span style="color:#111">.</span><span style="color:#75af00">Type</span><span style="color:#111">())</span>                  <span style="color:#75715e">// &#34;os.File&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">fd</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">stdout</span><span style="color:#111">.</span><span style="color:#75af00">FieldByName</span><span style="color:#111">(</span><span style="color:#d88200">&#34;fd&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">fd</span><span style="color:#111">.</span><span style="color:#75af00">Int</span><span style="color:#111">())</span> <span style="color:#75715e">// &#34;1&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">fd</span><span style="color:#111">.</span><span style="color:#75af00">SetInt</span><span style="color:#111">(</span><span style="color:#ae81ff">2</span><span style="color:#111">)</span>          <span style="color:#75715e">// panic: unexported field</span>
</span></span></code></pre></div><p>一个可取地址的reflect.Value会记录一个结构体成员是否是未导出成员，如果是的话则拒绝修改操作。因此，CanAddr方法并不能正确反映一个变量是否是可以被修改的。另一个相关的方法CanSet是用于检查对应的reflect.Value是否是可取地址并可被修改的：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Go" data-lang="Go"><span style="display:flex;"><span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">fd</span><span style="color:#111">.</span><span style="color:#75af00">CanAddr</span><span style="color:#111">(),</span> <span style="color:#75af00">fd</span><span style="color:#111">.</span><span style="color:#75af00">CanSet</span><span style="color:#111">())</span> <span style="color:#75715e">// &#34;true false&#34;</span>
</span></span></code></pre></div><h2 id="获取结构体字段标签">获取结构体字段标签</h2>
<p>在4.5节我们使用构体成员标签用于设置对应JSON对应的名字。其中json成员标签让我们可以选择成员的名字和抑制零值成员的输出。在本节，我们将看到如何通过反射机制类获取成员标签。</p>
<p>对于一个web服务，大部分HTTP处理函数要做的第一件事情就是展开请求中的参数到本地变量中。我们定义了一个工具函数，叫params.Unpack，通过使用结构体成员标签机制来让HTTP处理函数解析请求参数更方便。</p>
<p>首先，我们看看如何使用它。下面的search函数是一个HTTP请求处理函数。它定义了一个匿名结构体类型的变量，用结构体的每个成员表示HTTP请求的参数。其中结构体成员标签指明了对于请求参数的名字，为了减少URL的长度这些参数名通常都是神秘的缩略词。Unpack将请求参数填充到合适的结构体成员中，这样我们可以方便地通过合适的类型类来访问这些参数。</p>
<p><em>gopl.io/ch12/search</em></p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Go" data-lang="Go"><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#d88200">&#34;gopl.io/ch12/params&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// search implements the /search URL endpoint.</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">search</span><span style="color:#111">(</span><span style="color:#75af00">resp</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">ResponseWriter</span><span style="color:#111">,</span> <span style="color:#75af00">req</span> <span style="color:#f92672">*</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Request</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">var</span> <span style="color:#75af00">data</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">Labels</span>     <span style="color:#111">[]</span><span style="color:#00a8c8">string</span> <span style="color:#d88200">`http:&#34;l&#34;`</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">MaxResults</span> <span style="color:#00a8c8">int</span>      <span style="color:#d88200">`http:&#34;max&#34;`</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">Exact</span>      <span style="color:#00a8c8">bool</span>     <span style="color:#d88200">`http:&#34;x&#34;`</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">data</span><span style="color:#111">.</span><span style="color:#75af00">MaxResults</span> <span style="color:#111">=</span> <span style="color:#ae81ff">10</span> <span style="color:#75715e">// set default</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">params</span><span style="color:#111">.</span><span style="color:#75af00">Unpack</span><span style="color:#111">(</span><span style="color:#75af00">req</span><span style="color:#111">,</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">data</span><span style="color:#111">);</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Error</span><span style="color:#111">(</span><span style="color:#75af00">resp</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">.</span><span style="color:#75af00">Error</span><span style="color:#111">(),</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">StatusBadRequest</span><span style="color:#111">)</span> <span style="color:#75715e">// 400</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ...rest of handler...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Fprintf</span><span style="color:#111">(</span><span style="color:#75af00">resp</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Search: %+v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">data</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>下面的Unpack函数主要完成三件事情。第一，它调用req.ParseForm()来解析HTTP请求。然后，req.Form将包含所有的请求参数，不管HTTP客户端使用的是GET还是POST请求方法。</p>
<p>下一步，Unpack函数将构建每个结构体成员有效参数名字到成员变量的映射。如果结构体成员有成员标签的话，有效参数名字可能和实际的成员名字不相同。reflect.Type的Field方法将返回一个reflect.StructField，里面含有每个成员的名字、类型和可选的成员标签等信息。其中成员标签信息对应reflect.StructTag类型的字符串，并且提供了Get方法用于解析和根据特定key提取的子串，例如这里的http:&quot;&hellip;&ldquo;形式的子串。</p>
<p><em>gopl.io/ch12/params</em></p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Go" data-lang="Go"><span style="display:flex;"><span><span style="color:#75715e">// Unpack populates the fields of the struct pointed to by ptr</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// from the HTTP request parameters in req.</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">Unpack</span><span style="color:#111">(</span><span style="color:#75af00">req</span> <span style="color:#f92672">*</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Request</span><span style="color:#111">,</span> <span style="color:#75af00">ptr</span> <span style="color:#00a8c8">interface</span><span style="color:#111">{})</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">req</span><span style="color:#111">.</span><span style="color:#75af00">ParseForm</span><span style="color:#111">();</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Build map of fields keyed by effective name.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">fields</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#00a8c8">string</span><span style="color:#111">]</span><span style="color:#75af00">reflect</span><span style="color:#111">.</span><span style="color:#75af00">Value</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">v</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">reflect</span><span style="color:#111">.</span><span style="color:#75af00">ValueOf</span><span style="color:#111">(</span><span style="color:#75af00">ptr</span><span style="color:#111">).</span><span style="color:#75af00">Elem</span><span style="color:#111">()</span> <span style="color:#75715e">// the struct variable</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">for</span> <span style="color:#75af00">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span><span style="color:#111">;</span> <span style="color:#75af00">i</span> <span style="color:#111">&lt;</span> <span style="color:#75af00">v</span><span style="color:#111">.</span><span style="color:#75af00">NumField</span><span style="color:#111">();</span> <span style="color:#75af00">i</span><span style="color:#f92672">++</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">fieldInfo</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">v</span><span style="color:#111">.</span><span style="color:#75af00">Type</span><span style="color:#111">().</span><span style="color:#75af00">Field</span><span style="color:#111">(</span><span style="color:#75af00">i</span><span style="color:#111">)</span> <span style="color:#75715e">// a reflect.StructField</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">tag</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">fieldInfo</span><span style="color:#111">.</span><span style="color:#75af00">Tag</span>           <span style="color:#75715e">// a reflect.StructTag</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">name</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">tag</span><span style="color:#111">.</span><span style="color:#75af00">Get</span><span style="color:#111">(</span><span style="color:#d88200">&#34;http&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#75af00">name</span> <span style="color:#f92672">==</span> <span style="color:#d88200">&#34;&#34;</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75af00">name</span> <span style="color:#111">=</span> <span style="color:#75af00">strings</span><span style="color:#111">.</span><span style="color:#75af00">ToLower</span><span style="color:#111">(</span><span style="color:#75af00">fieldInfo</span><span style="color:#111">.</span><span style="color:#75af00">Name</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">fields</span><span style="color:#111">[</span><span style="color:#75af00">name</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#75af00">v</span><span style="color:#111">.</span><span style="color:#75af00">Field</span><span style="color:#111">(</span><span style="color:#75af00">i</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Update struct field for each parameter in the request.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">for</span> <span style="color:#75af00">name</span><span style="color:#111">,</span> <span style="color:#75af00">values</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">req</span><span style="color:#111">.</span><span style="color:#75af00">Form</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">f</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">fields</span><span style="color:#111">[</span><span style="color:#75af00">name</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">IsValid</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">continue</span> <span style="color:#75715e">// ignore unrecognized HTTP parameters</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">value</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">values</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">if</span> <span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">Kind</span><span style="color:#111">()</span> <span style="color:#f92672">==</span> <span style="color:#75af00">reflect</span><span style="color:#111">.</span><span style="color:#75af00">Slice</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75af00">elem</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">reflect</span><span style="color:#111">.</span><span style="color:#75af00">New</span><span style="color:#111">(</span><span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">Type</span><span style="color:#111">().</span><span style="color:#75af00">Elem</span><span style="color:#111">()).</span><span style="color:#75af00">Elem</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>                <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">populate</span><span style="color:#111">(</span><span style="color:#75af00">elem</span><span style="color:#111">,</span> <span style="color:#75af00">value</span><span style="color:#111">);</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#00a8c8">return</span> <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;%s: %v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">name</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">Set</span><span style="color:#111">(</span><span style="color:#75af00">reflect</span><span style="color:#111">.</span><span style="color:#75af00">Append</span><span style="color:#111">(</span><span style="color:#75af00">f</span><span style="color:#111">,</span> <span style="color:#75af00">elem</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">populate</span><span style="color:#111">(</span><span style="color:#75af00">f</span><span style="color:#111">,</span> <span style="color:#75af00">value</span><span style="color:#111">);</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#00a8c8">return</span> <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;%s: %v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">name</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>最后，Unpack遍历HTTP请求的name/valu参数键值对，并且根据更新相应的结构体成员。回想一下，同一个名字的参数可能出现多次。如果发生这种情况，并且对应的结构体成员是一个slice，那么就将所有的参数添加到slice中。其它情况，对应的成员值将被覆盖，只有最后一次出现的参数值才是起作用的。</p>
<p>populate函数小心用请求的字符串类型参数值来填充单一的成员v（或者是slice类型成员中的单一的元素）。目前，它仅支持字符串、有符号整数和布尔型。其中其它的类型将留做练习任务。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Go" data-lang="Go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">populate</span><span style="color:#111">(</span><span style="color:#75af00">v</span> <span style="color:#75af00">reflect</span><span style="color:#111">.</span><span style="color:#75af00">Value</span><span style="color:#111">,</span> <span style="color:#75af00">value</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">switch</span> <span style="color:#75af00">v</span><span style="color:#111">.</span><span style="color:#75af00">Kind</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">case</span> <span style="color:#75af00">reflect</span><span style="color:#111">.</span><span style="color:#75af00">String</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">v</span><span style="color:#111">.</span><span style="color:#75af00">SetString</span><span style="color:#111">(</span><span style="color:#75af00">value</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">case</span> <span style="color:#75af00">reflect</span><span style="color:#111">.</span><span style="color:#75af00">Int</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">i</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">strconv</span><span style="color:#111">.</span><span style="color:#75af00">ParseInt</span><span style="color:#111">(</span><span style="color:#75af00">value</span><span style="color:#111">,</span> <span style="color:#ae81ff">10</span><span style="color:#111">,</span> <span style="color:#ae81ff">64</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">v</span><span style="color:#111">.</span><span style="color:#75af00">SetInt</span><span style="color:#111">(</span><span style="color:#75af00">i</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">case</span> <span style="color:#75af00">reflect</span><span style="color:#111">.</span><span style="color:#75af00">Bool</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">b</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">strconv</span><span style="color:#111">.</span><span style="color:#75af00">ParseBool</span><span style="color:#111">(</span><span style="color:#75af00">value</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">v</span><span style="color:#111">.</span><span style="color:#75af00">SetBool</span><span style="color:#111">(</span><span style="color:#75af00">b</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">default</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;unsupported kind %s&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">v</span><span style="color:#111">.</span><span style="color:#75af00">Type</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>如果我们上上面的处理程序添加到一个web服务器，则可以产生以下的会话：</p>
<pre tabindex="0"><code>$ go build gopl.io/ch12/search
$ ./search &amp;
$ ./fetch &#39;http://localhost:12345/search&#39;
Search: {Labels:[] MaxResults:10 Exact:false}
$ ./fetch &#39;http://localhost:12345/search?l=golang&amp;l=programming&#39;
Search: {Labels:[golang programming] MaxResults:10 Exact:false}
$ ./fetch &#39;http://localhost:12345/search?l=golang&amp;l=programming&amp;max=100&#39;
Search: {Labels:[golang programming] MaxResults:100 Exact:false}
$ ./fetch &#39;http://localhost:12345/search?x=true&amp;l=golang&amp;l=programming&#39;
Search: {Labels:[golang programming] MaxResults:10 Exact:true}
$ ./fetch &#39;http://localhost:12345/search?q=hello&amp;x=123&#39;
x: strconv.ParseBool: parsing &#34;123&#34;: invalid syntax
$ ./fetch &#39;http://localhost:12345/search?q=hello&amp;max=lots&#39;
max: strconv.ParseInt: parsing &#34;lots&#34;: invalid syntax
</code></pre><h2 id="显示一个类型的方法集">显示一个类型的方法集</h2>
<p>我们的最后一个例子是使用reflect.Type来打印任意值的类型和枚举它的方法：</p>
<p><em>gopl.io/ch12/methods</em></p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Go" data-lang="Go"><span style="display:flex;"><span><span style="color:#75715e">// Print prints the method set of the value x.</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">Print</span><span style="color:#111">(</span><span style="color:#75af00">x</span> <span style="color:#00a8c8">interface</span><span style="color:#111">{})</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">v</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">reflect</span><span style="color:#111">.</span><span style="color:#75af00">ValueOf</span><span style="color:#111">(</span><span style="color:#75af00">x</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">t</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">v</span><span style="color:#111">.</span><span style="color:#75af00">Type</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;type %s\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">t</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">for</span> <span style="color:#75af00">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span><span style="color:#111">;</span> <span style="color:#75af00">i</span> <span style="color:#111">&lt;</span> <span style="color:#75af00">v</span><span style="color:#111">.</span><span style="color:#75af00">NumMethod</span><span style="color:#111">();</span> <span style="color:#75af00">i</span><span style="color:#f92672">++</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">methType</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">v</span><span style="color:#111">.</span><span style="color:#75af00">Method</span><span style="color:#111">(</span><span style="color:#75af00">i</span><span style="color:#111">).</span><span style="color:#75af00">Type</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;func (%s) %s%s\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">t</span><span style="color:#111">,</span> <span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">Method</span><span style="color:#111">(</span><span style="color:#75af00">i</span><span style="color:#111">).</span><span style="color:#75af00">Name</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75af00">strings</span><span style="color:#111">.</span><span style="color:#75af00">TrimPrefix</span><span style="color:#111">(</span><span style="color:#75af00">methType</span><span style="color:#111">.</span><span style="color:#75af00">String</span><span style="color:#111">(),</span> <span style="color:#d88200">&#34;func&#34;</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>reflect.Type和reflect.Value都提供了一个Method方法。每次t.Method(i)调用将一个reflect.Method的实例，对应一个用于描述一个方法的名称和类型的结构体。每次v.Method(i)方法调用都返回一个reflect.Value以表示对应的值（§6.4），也就是一个方法是帮到它的接收者的。使用reflect.Value.Call方法（我们这里没有演示），将可以调用一个Func类型的Value，但是这个例子中只用到了它的类型。</p>
<p>这是属于time.Duration和<code>*strings.Replacer</code>两个类型的方法：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Go" data-lang="Go"><span style="display:flex;"><span><span style="color:#75af00">methods</span><span style="color:#111">.</span><span style="color:#75af00">Print</span><span style="color:#111">(</span><span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Hour</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Output:</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// type time.Duration</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// func (time.Duration) Hours() float64</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// func (time.Duration) Minutes() float64</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// func (time.Duration) Nanoseconds() int64</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// func (time.Duration) Seconds() float64</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// func (time.Duration) String() string</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">methods</span><span style="color:#111">.</span><span style="color:#75af00">Print</span><span style="color:#111">(</span><span style="color:#111">new</span><span style="color:#111">(</span><span style="color:#75af00">strings</span><span style="color:#111">.</span><span style="color:#75af00">Replacer</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Output:</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// type *strings.Replacer</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// func (*strings.Replacer) Replace(string) string</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// func (*strings.Replacer) WriteString(io.Writer, string) (int, error)</span>
</span></span></code></pre></div><p>文章转自：</p>
<ul>
<li>《go语言圣经》</li>
<li><a href="https://www.liwenzhou.com/posts/Go/13_reflect">https://www.liwenzhou.com/posts/Go/13_reflect</a></li>
</ul>
]]></content:encoded><category>go</category><category>go</category></item><item><title>Gin框架介绍及使用</title><link>https://daemon365.dev/post/go/introduction_and_use_of_gin_framework/</link><pubDate>Sun, 30 Jun 2019 00:00:00 +0800</pubDate><guid>https://daemon365.dev/post/go/introduction_and_use_of_gin_framework/</guid><description>&lt;h2 id="gin框架介绍"&gt;Gin框架介绍&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;基于&lt;a href="https://github.com/julienschmidt/httprouter"&gt;httprouter&lt;/a&gt;开发的Web框架。&lt;/li&gt;
&lt;li&gt;&lt;a href="https://gin-gonic.com/zh-cn/docs/"&gt;中文文档&lt;/a&gt;，齐全。&lt;/li&gt;
&lt;li&gt;简单易用的轻量级框架。&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="gin框架安装"&gt;Gin框架安装&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;go get -u github.com/gin-gonic/gin
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;strong&gt;实例:&lt;/strong&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;package&lt;/span&gt; &lt;span style="color:#75af00"&gt;main&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;import&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;fmt&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;github.com/gin-gonic/gin&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;main&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;r&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;gin&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Default&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// 创建一个默认的路由引擎&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// 也可以用gin.New() gin.Default()多用了日志和panic的recover中间件&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;r&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;GET&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;/helloworld&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;func&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;c&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;gin&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Context&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;c&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;JSON&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;200&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;gin&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;H&lt;/span&gt;&lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// c.JSON：返回JSON格式的数据&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;msg&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;Hello world!&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;})&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;})&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;r&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Run&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;127.0.0.1:8001&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// 启动HTTP服务，默认在127.0.0.1:8001启动服务&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;!=&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;run gin field&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;img src="https://daemon365.dev/images/a78c08f7-e35f-41f2-bc49-9388ef405408.png" alt=""&gt;&lt;/p&gt;
&lt;h2 id="restful-api"&gt;RESTful API&lt;/h2&gt;
&lt;p&gt;REST与技术无关，代表的是一种软件架构风格，REST是Representational State Transfer的简称，中文翻译为“表征状态转移”或“表现层状态转化”。&lt;/p&gt;
&lt;p&gt;简单来说，REST的含义就是客户端与Web服务器之间进行交互的时候，使用HTTP协议中的4个请求方法代表不同的动作。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;GET用来获取资源&lt;/li&gt;
&lt;li&gt;POST用来新建资源&lt;/li&gt;
&lt;li&gt;PUT用来更新资源&lt;/li&gt;
&lt;li&gt;DELETE用来删除资源。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;只要API程序遵循了REST风格，那就可以称其为RESTful API。目前在前后端分离的架构中，前后端基本都是通过RESTful API来进行交互。&lt;/p&gt;
&lt;p&gt;例如，我们现在要编写一个管理书籍的系统，我们可以查询对一本书进行查询、创建、更新和删除等操作，我们在编写程序的时候就要设计客户端浏览器与我们Web服务端交互的方式和路径。按照经验我们通常会设计成如下模式：&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;请求方法&lt;/th&gt;
&lt;th&gt;URL&lt;/th&gt;
&lt;th&gt;含义&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;GET&lt;/td&gt;
&lt;td&gt;/book&lt;/td&gt;
&lt;td&gt;查询书籍信息&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;POST&lt;/td&gt;
&lt;td&gt;/create_book&lt;/td&gt;
&lt;td&gt;创建书籍记录&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;POST&lt;/td&gt;
&lt;td&gt;/update_book&lt;/td&gt;
&lt;td&gt;更新书籍信息&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;POST&lt;/td&gt;
&lt;td&gt;/delete_book&lt;/td&gt;
&lt;td&gt;删除书籍信息&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;同样的需求我们按照RESTful API设计如下：&lt;/p&gt;</description><content:encoded><![CDATA[<h2 id="gin框架介绍">Gin框架介绍</h2>
<ul>
<li>基于<a href="https://github.com/julienschmidt/httprouter">httprouter</a>开发的Web框架。</li>
<li><a href="https://gin-gonic.com/zh-cn/docs/">中文文档</a>，齐全。</li>
<li>简单易用的轻量级框架。</li>
</ul>
<h2 id="gin框架安装">Gin框架安装</h2>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>go get -u github.com/gin-gonic/gin
</span></span></code></pre></div><p><strong>实例:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;github.com/gin-gonic/gin&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Default</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 创建一个默认的路由引擎</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 也可以用gin.New() gin.Default()多用了日志和panic的recover中间件</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">GET</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/helloworld&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">JSON</span><span style="color:#111">(</span><span style="color:#ae81ff">200</span><span style="color:#111">,</span> <span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">H</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// c.JSON：返回JSON格式的数据</span>
</span></span><span style="display:flex;"><span>			<span style="color:#d88200">&#34;msg&#34;</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;Hello world!&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">Run</span><span style="color:#111">(</span><span style="color:#d88200">&#34;127.0.0.1:8001&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 启动HTTP服务，默认在127.0.0.1:8001启动服务</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;run gin field&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p><img src="/images/a78c08f7-e35f-41f2-bc49-9388ef405408.png" alt=""></p>
<h2 id="restful-api">RESTful API</h2>
<p>REST与技术无关，代表的是一种软件架构风格，REST是Representational State Transfer的简称，中文翻译为“表征状态转移”或“表现层状态转化”。</p>
<p>简单来说，REST的含义就是客户端与Web服务器之间进行交互的时候，使用HTTP协议中的4个请求方法代表不同的动作。</p>
<ul>
<li>GET用来获取资源</li>
<li>POST用来新建资源</li>
<li>PUT用来更新资源</li>
<li>DELETE用来删除资源。</li>
</ul>
<p>只要API程序遵循了REST风格，那就可以称其为RESTful API。目前在前后端分离的架构中，前后端基本都是通过RESTful API来进行交互。</p>
<p>例如，我们现在要编写一个管理书籍的系统，我们可以查询对一本书进行查询、创建、更新和删除等操作，我们在编写程序的时候就要设计客户端浏览器与我们Web服务端交互的方式和路径。按照经验我们通常会设计成如下模式：</p>
<table>
  <thead>
      <tr>
          <th>请求方法</th>
          <th>URL</th>
          <th>含义</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>GET</td>
          <td>/book</td>
          <td>查询书籍信息</td>
      </tr>
      <tr>
          <td>POST</td>
          <td>/create_book</td>
          <td>创建书籍记录</td>
      </tr>
      <tr>
          <td>POST</td>
          <td>/update_book</td>
          <td>更新书籍信息</td>
      </tr>
      <tr>
          <td>POST</td>
          <td>/delete_book</td>
          <td>删除书籍信息</td>
      </tr>
  </tbody>
</table>
<p>同样的需求我们按照RESTful API设计如下：</p>
<table>
  <thead>
      <tr>
          <th>请求方法</th>
          <th>URL</th>
          <th>含义</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>GET</td>
          <td>/book</td>
          <td>查询书籍信息</td>
      </tr>
      <tr>
          <td>POST</td>
          <td>/book</td>
          <td>创建书籍记录</td>
      </tr>
      <tr>
          <td>PUT</td>
          <td>/book</td>
          <td>更新书籍信息</td>
      </tr>
      <tr>
          <td>DELETE</td>
          <td>/book</td>
          <td>删除书籍信息</td>
      </tr>
  </tbody>
</table>
<p>Gin框架支持开发RESTful API的开发。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Default</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">GET</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/book&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">JSON</span><span style="color:#111">(</span><span style="color:#ae81ff">200</span><span style="color:#111">,</span> <span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">H</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#d88200">&#34;message&#34;</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;GET&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">POST</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/book&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">JSON</span><span style="color:#111">(</span><span style="color:#ae81ff">200</span><span style="color:#111">,</span> <span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">H</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#d88200">&#34;message&#34;</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;POST&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">PUT</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/book&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">JSON</span><span style="color:#111">(</span><span style="color:#ae81ff">200</span><span style="color:#111">,</span> <span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">H</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#d88200">&#34;message&#34;</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;PUT&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">DELETE</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/book&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">JSON</span><span style="color:#111">(</span><span style="color:#ae81ff">200</span><span style="color:#111">,</span> <span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">H</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#d88200">&#34;message&#34;</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;DELETE&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>开发RESTful API的时候我们通常使用<a href="https://www.getpostman.com/">Postman</a>来作为客户端的测试工具。</p>
<h2 id="gin渲染">Gin渲染</h2>
<h3 id="html渲染">HTML渲染</h3>
<p>我们首先定义一个存放模板文件的templates文件夹，然后在其内部按照业务分别定义一个posts文件夹和一个users文件夹。posts/index.html文件的内容如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#111">{{</span><span style="color:#75af00">define</span> <span style="color:#d88200">&#34;posts/index.html&#34;</span><span style="color:#111">}}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">posts</span><span style="color:#f92672">/</span><span style="color:#75af00">index</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">{{.</span><span style="color:#75af00">title</span><span style="color:#111">}}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">{{</span><span style="color:#75af00">end</span><span style="color:#111">}}</span>
</span></span></code></pre></div><p>users/index.html文件的内容如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#111">{{</span><span style="color:#75af00">define</span> <span style="color:#d88200">&#34;users/index.html&#34;</span><span style="color:#111">}}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">users</span><span style="color:#f92672">/</span><span style="color:#75af00">index</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">{{.</span><span style="color:#75af00">title</span><span style="color:#111">}}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">{{</span><span style="color:#75af00">end</span><span style="color:#111">}}</span>
</span></span></code></pre></div><p>Gin框架中使用LoadHTMLGlob()或者LoadHTMLFiles()方法进行HTML模板渲染。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Default</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">LoadHTMLGlob</span><span style="color:#111">(</span><span style="color:#d88200">&#34;templates/**/*&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//r.LoadHTMLFiles(&#34;templates/posts/index.html&#34;, &#34;templates/users/index.html&#34;)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">GET</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/posts/index&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">HTML</span><span style="color:#111">(</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">StatusOK</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;posts/index.html&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">H</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#d88200">&#34;title&#34;</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;posts/index&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">GET</span><span style="color:#111">(</span><span style="color:#d88200">&#34;users/index&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">HTML</span><span style="color:#111">(</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">StatusOK</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;users/index.html&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">H</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#d88200">&#34;title&#34;</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;users/index&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">Run</span><span style="color:#111">(</span><span style="color:#d88200">&#34;:8080&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="静态文件处理">静态文件处理</h3>
<p>当我们渲染的HTML文件中引用了静态文件时，我们只需要按照以下方式在渲染页面前调用gin.Static方法即可。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Default</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">Static</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/static&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;./static&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">LoadHTMLGlob</span><span style="color:#111">(</span><span style="color:#d88200">&#34;templates/**/*&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">Run</span><span style="color:#111">(</span><span style="color:#d88200">&#34;:8080&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="补充文件路径处理">补充文件路径处理</h3>
<p>关于模板文件和静态文件的路径，我们需要根据公司/项目的要求进行设置。可以使用下面的函数获取当前执行程序的路径。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">getCurrentPath</span><span style="color:#111">()</span> <span style="color:#00a8c8">string</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">ex</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">Executable</span><span style="color:#111">();</span> <span style="color:#75af00">err</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">filepath</span><span style="color:#111">.</span><span style="color:#75af00">Dir</span><span style="color:#111">(</span><span style="color:#75af00">ex</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#d88200">&#34;./&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="json渲染">JSON渲染</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Default</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// gin.H 是map[string]interface{}的缩写</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">GET</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/someJSON&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 方式一：自己拼接JSON</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">JSON</span><span style="color:#111">(</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">StatusOK</span><span style="color:#111">,</span> <span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">H</span><span style="color:#111">{</span><span style="color:#d88200">&#34;message&#34;</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;Hello world!&#34;</span><span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">GET</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/moreJSON&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 方法二：使用结构体</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">var</span> <span style="color:#75af00">msg</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">Name</span>    <span style="color:#00a8c8">string</span> <span style="color:#d88200">`json:&#34;user&#34;`</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">Message</span> <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">Age</span>     <span style="color:#00a8c8">int</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">msg</span><span style="color:#111">.</span><span style="color:#75af00">Name</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;zhy&#34;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">msg</span><span style="color:#111">.</span><span style="color:#75af00">Message</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;Hello world!&#34;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">msg</span><span style="color:#111">.</span><span style="color:#75af00">Age</span> <span style="color:#111">=</span> <span style="color:#ae81ff">18</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">JSON</span><span style="color:#111">(</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">StatusOK</span><span style="color:#111">,</span> <span style="color:#75af00">msg</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">Run</span><span style="color:#111">(</span><span style="color:#d88200">&#34;:8080&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="xml渲染">XML渲染</h3>
<p>注意需要使用具名的结构体类型。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Default</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// gin.H 是map[string]interface{}的缩写</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">GET</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/someXML&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 方式一：自己拼接JSON</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">XML</span><span style="color:#111">(</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">StatusOK</span><span style="color:#111">,</span> <span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">H</span><span style="color:#111">{</span><span style="color:#d88200">&#34;message&#34;</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;Hello world!&#34;</span><span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">GET</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/moreXML&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 方法二：使用结构体</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">type</span> <span style="color:#75af00">MessageRecord</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">Name</span>    <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">Message</span> <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">Age</span>     <span style="color:#00a8c8">int</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">var</span> <span style="color:#75af00">msg</span> <span style="color:#75af00">MessageRecord</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">msg</span><span style="color:#111">.</span><span style="color:#75af00">Name</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;小王子&#34;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">msg</span><span style="color:#111">.</span><span style="color:#75af00">Message</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;Hello world!&#34;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">msg</span><span style="color:#111">.</span><span style="color:#75af00">Age</span> <span style="color:#111">=</span> <span style="color:#ae81ff">18</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">XML</span><span style="color:#111">(</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">StatusOK</span><span style="color:#111">,</span> <span style="color:#75af00">msg</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">Run</span><span style="color:#111">(</span><span style="color:#d88200">&#34;:8080&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="ymal渲染">YMAL渲染</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">GET</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/someYAML&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">YAML</span><span style="color:#111">(</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">StatusOK</span><span style="color:#111">,</span> <span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">H</span><span style="color:#111">{</span><span style="color:#d88200">&#34;message&#34;</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;ok&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;status&#34;</span><span style="color:#111">:</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">StatusOK</span><span style="color:#111">})</span>
</span></span><span style="display:flex;"><span><span style="color:#111">})</span>
</span></span></code></pre></div><h3 id="protobuf渲染">protobuf渲染</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-protobuf" data-lang="protobuf"><span style="display:flex;"><span><span style="color:#75715e">// protobuf文件
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#111">syntax</span> <span style="color:#f92672">=</span> <span style="color:#d88200">&#34;proto3&#34;</span><span style="color:#111">;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#f92672">package</span> <span style="color:#111">models</span><span style="color:#111">;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#00a8c8">message</span> <span style="color:#75af00">hello</span> <span style="color:#111">{</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    <span style="color:#00a8c8">string</span> <span style="color:#111">content</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span><span style="color:#111">;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#111">}</span><span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;net/http&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;test/models&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;github.com/gin-gonic/gin&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Default</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">GET</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/hello&#34;</span><span style="color:#111">,</span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span>  <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">res</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">models</span><span style="color:#111">.</span><span style="color:#75af00">Hello</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">Content</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;你好&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">ProtoBuf</span><span style="color:#111">(</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">StatusOK</span><span style="color:#111">,</span><span style="color:#75af00">res</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">_</span> <span style="color:#111">=</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">Run</span><span style="color:#111">(</span><span style="color:#d88200">&#34;127.0.0.1:8001&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="获取参数">获取参数</h2>
<h3 id="获取querystring参数">获取querystring参数</h3>
<p>querystring指的是URL中?后面携带的参数，例如：/user?username=赵海宇&amp;address=地球一角。</p>
<ol>
<li>c.DefaultQuery有默认值 如果没有传去默认值</li>
<li>c.Query没有默认值 如果没传 为空</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;net/http&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;github.com/gin-gonic/gin&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Default</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">GET</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/user&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">username</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">DefaultQuery</span><span style="color:#111">(</span><span style="color:#d88200">&#34;username&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;zhy&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">address</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">Query</span><span style="color:#111">(</span><span style="color:#d88200">&#34;address&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">JSON</span><span style="color:#111">(</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">StatusOK</span><span style="color:#111">,</span> <span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">H</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#d88200">&#34;username&#34;</span><span style="color:#111">:</span> <span style="color:#75af00">username</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#d88200">&#34;address&#34;</span><span style="color:#111">:</span>  <span style="color:#75af00">address</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">_</span> <span style="color:#111">=</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">Run</span><span style="color:#111">(</span><span style="color:#d88200">&#34;127.0.0.1:8001&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="获取form参数">获取form参数</h3>
<p>请求的数据通过form表单来提交，例如向/user发送一个POST请求，获取请求数据的方式如下：c.PostForm</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;net/http&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;github.com/gin-gonic/gin&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Default</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">POST</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/user&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">username</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">PostForm</span><span style="color:#111">(</span><span style="color:#d88200">&#34;username&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">address</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">PostForm</span><span style="color:#111">(</span><span style="color:#d88200">&#34;address&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">JSON</span><span style="color:#111">(</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">StatusOK</span><span style="color:#111">,</span> <span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">H</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#d88200">&#34;username&#34;</span><span style="color:#111">:</span> <span style="color:#75af00">username</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#d88200">&#34;address&#34;</span><span style="color:#111">:</span>  <span style="color:#75af00">address</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">_</span> <span style="color:#111">=</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">Run</span><span style="color:#111">(</span><span style="color:#d88200">&#34;127.0.0.1:8001&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="获取path参数">获取path参数</h3>
<p>请求的参数通过URL路径传递，例如：/user/zhaohaiyu/地球一角/路由:/user/:username/:address方法:c.Param</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;net/http&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;github.com/gin-gonic/gin&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Default</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">GET</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/user/:username/:address&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">username</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">Param</span><span style="color:#111">(</span><span style="color:#d88200">&#34;username&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">address</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">Param</span><span style="color:#111">(</span><span style="color:#d88200">&#34;address&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">JSON</span><span style="color:#111">(</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">StatusOK</span><span style="color:#111">,</span> <span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">H</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#d88200">&#34;username&#34;</span><span style="color:#111">:</span> <span style="color:#75af00">username</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#d88200">&#34;address&#34;</span><span style="color:#111">:</span>  <span style="color:#75af00">address</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">_</span> <span style="color:#111">=</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">Run</span><span style="color:#111">(</span><span style="color:#d88200">&#34;127.0.0.1:8001&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="参数绑定">参数绑定</h3>
<p>为了能够更方便的获取请求相关参数，提高开发效率，我们可以基于请求的content-type识别请求数据类型并利用反射机制自动提取请求中querystring、form表单、JSON、XML等参数到结构体中。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;net/http&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;github.com/gin-gonic/gin&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Binding from JSON</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Login</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">User</span>     <span style="color:#00a8c8">string</span> <span style="color:#d88200">`form:&#34;user&#34; json:&#34;user&#34; binding:&#34;required&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Password</span> <span style="color:#00a8c8">string</span> <span style="color:#d88200">`form:&#34;password&#34; json:&#34;password&#34; binding:&#34;required&#34;`</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Default</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 绑定JSON的示例 ({&#34;user&#34;: &#34;root&#34;, &#34;password&#34;: &#34;123&#34;})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">POST</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/loginJSON&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">var</span> <span style="color:#75af00">login</span> <span style="color:#75af00">Login</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">ShouldBindJSON</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">login</span><span style="color:#111">);</span> <span style="color:#75af00">err</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;login info:%#v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">login</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">JSON</span><span style="color:#111">(</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">StatusOK</span><span style="color:#111">,</span> <span style="color:#75af00">login</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">JSON</span><span style="color:#111">(</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">StatusBadRequest</span><span style="color:#111">,</span> <span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">H</span><span style="color:#111">{</span><span style="color:#d88200">&#34;error&#34;</span><span style="color:#111">:</span> <span style="color:#75af00">err</span><span style="color:#111">.</span><span style="color:#75af00">Error</span><span style="color:#111">()})</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 绑定form表单示例 (user=root&amp;password=123)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">POST</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/loginForm&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">var</span> <span style="color:#75af00">login</span> <span style="color:#75af00">Login</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// ShouldBind()会根据请求的Content-Type自行选择绑定器</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">ShouldBind</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">login</span><span style="color:#111">);</span> <span style="color:#75af00">err</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">JSON</span><span style="color:#111">(</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">StatusOK</span><span style="color:#111">,</span> <span style="color:#75af00">login</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">JSON</span><span style="color:#111">(</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">StatusBadRequest</span><span style="color:#111">,</span> <span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">H</span><span style="color:#111">{</span><span style="color:#d88200">&#34;error&#34;</span><span style="color:#111">:</span> <span style="color:#75af00">err</span><span style="color:#111">.</span><span style="color:#75af00">Error</span><span style="color:#111">()})</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 绑定querystring示例 (user=root&amp;password=123)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">GET</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/loginForm&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">var</span> <span style="color:#75af00">login</span> <span style="color:#75af00">Login</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// ShouldBind()会根据请求的Content-Type自行选择绑定器</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">ShouldBind</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">login</span><span style="color:#111">);</span> <span style="color:#75af00">err</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">JSON</span><span style="color:#111">(</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">StatusOK</span><span style="color:#111">,</span> <span style="color:#75af00">login</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">JSON</span><span style="color:#111">(</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">StatusBadRequest</span><span style="color:#111">,</span> <span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">H</span><span style="color:#111">{</span><span style="color:#d88200">&#34;error&#34;</span><span style="color:#111">:</span> <span style="color:#75af00">err</span><span style="color:#111">.</span><span style="color:#75af00">Error</span><span style="color:#111">()})</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">_</span> <span style="color:#111">=</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">Run</span><span style="color:#111">(</span><span style="color:#d88200">&#34;127.0.0.1:8001&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="文件上传">文件上传</h2>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">router</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Default</span><span style="color:#111">()</span> <span style="color:#75715e">// 处理multipart forms提交文件时默认的内存限制是32 MiB</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 可以通过下面的方式修改</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// router.MaxMultipartMemory = 8 &lt;&lt; 20 // 8 MiB</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">router</span><span style="color:#111">.</span><span style="color:#75af00">POST</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/upload&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 单个文件</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">file</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">FormFile</span><span style="color:#111">(</span><span style="color:#d88200">&#34;file&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">JSON</span><span style="color:#111">(</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">StatusInternalServerError</span><span style="color:#111">,</span> <span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">H</span><span style="color:#111">{</span><span style="color:#d88200">&#34;message&#34;</span><span style="color:#111">:</span> <span style="color:#75af00">err</span><span style="color:#111">.</span><span style="color:#75af00">Error</span><span style="color:#111">()})</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">file</span><span style="color:#111">.</span><span style="color:#75af00">Filename</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">dst</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Sprintf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;C:/tmp/%s&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">file</span><span style="color:#111">.</span><span style="color:#75af00">Filename</span><span style="color:#111">)</span> <span style="color:#75715e">// 上传文件到指定的目录</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">SaveUploadedFile</span><span style="color:#111">(</span><span style="color:#75af00">file</span><span style="color:#111">,</span> <span style="color:#75af00">dst</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">JSON</span><span style="color:#111">(</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">StatusOK</span><span style="color:#111">,</span> <span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">H</span><span style="color:#111">{</span><span style="color:#d88200">&#34;message&#34;</span><span style="color:#111">:</span> <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Sprintf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;&#39;%s&#39; uploaded!&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">file</span><span style="color:#111">.</span><span style="color:#75af00">Filename</span><span style="color:#111">)})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">router</span><span style="color:#111">.</span><span style="color:#75af00">Run</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="多个文件上传">多个文件上传</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">router</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Default</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 处理multipart forms提交文件时默认的内存限制是32 MiB</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 可以通过下面的方式修改</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// router.MaxMultipartMemory = 8 &lt;&lt; 20  // 8 MiB</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">router</span><span style="color:#111">.</span><span style="color:#75af00">POST</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/upload&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Multipart form</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">form</span><span style="color:#111">,</span> <span style="color:#75af00">_</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">MultipartForm</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">files</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">form</span><span style="color:#111">.</span><span style="color:#75af00">File</span><span style="color:#111">[</span><span style="color:#d88200">&#34;file&#34;</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">for</span> <span style="color:#75af00">index</span><span style="color:#111">,</span> <span style="color:#75af00">file</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">files</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">file</span><span style="color:#111">.</span><span style="color:#75af00">Filename</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">dst</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Sprintf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;C:/tmp/%s_%d&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">file</span><span style="color:#111">.</span><span style="color:#75af00">Filename</span><span style="color:#111">,</span> <span style="color:#75af00">index</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 上传文件到指定的目录</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">SaveUploadedFile</span><span style="color:#111">(</span><span style="color:#75af00">file</span><span style="color:#111">,</span> <span style="color:#75af00">dst</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">JSON</span><span style="color:#111">(</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">StatusOK</span><span style="color:#111">,</span> <span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">H</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#d88200">&#34;message&#34;</span><span style="color:#111">:</span> <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Sprintf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;%d files uploaded!&#34;</span><span style="color:#111">,</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">files</span><span style="color:#111">)),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">router</span><span style="color:#111">.</span><span style="color:#75af00">Run</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="gin中间件">Gin中间件</h2>
<p>Gin框架允许开发者在处理请求的过程中，加入用户自己的钩子（Hook）函数。这个钩子函数就叫中间件，中间件适合处理一些公共的业务逻辑，比如登录校验、日志打印、耗时统计等。</p>
<p>Gin中的中间件必须是一个gin.HandlerFunc类型。例如我们像下面的代码一样定义一个中间件。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// StatCost 是一个统计耗时请求耗时的中间件</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">StatCost</span><span style="color:#111">()</span> <span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">HandlerFunc</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">start</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Now</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">Set</span><span style="color:#111">(</span><span style="color:#d88200">&#34;name&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;小王子&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 执行其他中间件</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">Next</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 计算耗时</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">cost</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">S</span><span style="color:#f92672">***</span><span style="color:#75af00">art</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">cost</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>然后注册中间件的时候，可以在全局注册。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 新建一个没有任何默认中间件的路由</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">New</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 注册一个全局中间件</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">Use</span><span style="color:#111">(</span><span style="color:#75af00">StatCost</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">GET</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/test&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">name</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">MustGet</span><span style="color:#111">(</span><span style="color:#d88200">&#34;name&#34;</span><span style="color:#111">).(</span><span style="color:#00a8c8">string</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">name</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">JSON</span><span style="color:#111">(</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">StatusOK</span><span style="color:#111">,</span> <span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">H</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#d88200">&#34;message&#34;</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;Hello world!&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">Run</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>也可以给某个路由单独注册中间件。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// 给/test2路由单独注册中间件（可注册多个）</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">GET</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/test2&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">StatCost</span><span style="color:#111">(),</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">name</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">MustGet</span><span style="color:#111">(</span><span style="color:#d88200">&#34;name&#34;</span><span style="color:#111">).(</span><span style="color:#00a8c8">string</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">name</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">JSON</span><span style="color:#111">(</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">StatusOK</span><span style="color:#111">,</span> <span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">H</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#d88200">&#34;message&#34;</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;Hello world!&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span></code></pre></div><h3 id="重定向">重定向</h3>
<h4 id="http重定向">HTTP重定向</h4>
<p>HTTP 重定向很容易。 内部、外部重定向均支持。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">GET</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/test&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">Redirect</span><span style="color:#111">(</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">StatusMovedPermanently</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;http://www.google.com/&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">})</span>
</span></span></code></pre></div><h4 id="路由重定向">路由重定向</h4>
<p>路由重定向，使用HandleContext：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">GET</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/test&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 指定重定向的URL</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">Request</span><span style="color:#111">.</span><span style="color:#75af00">URL</span><span style="color:#111">.</span><span style="color:#75af00">Path</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;/test2&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">HandleContext</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">})</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">GET</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/test2&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">JSON</span><span style="color:#111">(</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">StatusOK</span><span style="color:#111">,</span> <span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">H</span><span style="color:#111">{</span><span style="color:#d88200">&#34;hello&#34;</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;world&#34;</span><span style="color:#111">})</span>
</span></span><span style="display:flex;"><span><span style="color:#111">})</span>
</span></span></code></pre></div><h2 id="gin路由">Gin路由</h2>
<h3 id="普通路由">普通路由</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">GET</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/index&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#111">{</span><span style="color:#f92672">...</span><span style="color:#111">})</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">GET</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/login&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#111">{</span><span style="color:#f92672">...</span><span style="color:#111">})</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">POST</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/login&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#111">{</span><span style="color:#f92672">...</span><span style="color:#111">})</span>
</span></span></code></pre></div><p>此外，还有一个可以匹配所有请求方法的Any方法如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">Any</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/test&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#111">{</span><span style="color:#f92672">...</span><span style="color:#111">})</span>
</span></span></code></pre></div><p>为没有配置处理函数的路由添加处理程序。默认情况下它返回404代码。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">NoRoute</span><span style="color:#111">(</span><span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">HTML</span><span style="color:#111">(</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">StatusNotFound</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;views/404.html&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span></code></pre></div><h3 id="路由组">路由组</h3>
<p>我们可以将拥有共同URL前缀的路由划分为一个路由组。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Default</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">userGroup</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">Group</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/user&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">userGroup</span><span style="color:#111">.</span><span style="color:#75af00">GET</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/index&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#111">{</span><span style="color:#f92672">...</span><span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">userGroup</span><span style="color:#111">.</span><span style="color:#75af00">GET</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/login&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#111">{</span><span style="color:#f92672">...</span><span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">userGroup</span><span style="color:#111">.</span><span style="color:#75af00">POST</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/login&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#111">{</span><span style="color:#f92672">...</span><span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">shopGroup</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">Group</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/shop&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">shopGroup</span><span style="color:#111">.</span><span style="color:#75af00">GET</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/index&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#111">{</span><span style="color:#f92672">...</span><span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">shopGroup</span><span style="color:#111">.</span><span style="color:#75af00">GET</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/cart&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#111">{</span><span style="color:#f92672">...</span><span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">shopGroup</span><span style="color:#111">.</span><span style="color:#75af00">POST</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/checkout&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#111">{</span><span style="color:#f92672">...</span><span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">Run</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>通常我们将路由分组用在划分业务逻辑或划分API版本时。</p>
<h3 id="路由分文件">路由分文件</h3>
<ol>
<li>在route中初始化route和切片路由组</li>
<li>在各个文件写路由</li>
<li>在main中把路由函数放入函数路由组</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// route中go</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">route</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#d88200">&#34;github.com/gin-gonic/gin&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Option</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Engine</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">var</span> <span style="color:#75af00">options</span> <span style="color:#111">=</span> <span style="color:#111">[]</span><span style="color:#75af00">Option</span><span style="color:#111">{}</span> <span style="color:#75715e">// 路由函数组</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 注册app的路由配置</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">Include</span><span style="color:#111">(</span><span style="color:#75af00">opts</span> <span style="color:#f92672">...</span><span style="color:#75af00">Option</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">options</span> <span style="color:#111">=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">options</span><span style="color:#111">,</span> <span style="color:#75af00">opts</span><span style="color:#f92672">...</span><span style="color:#111">)</span> <span style="color:#75715e">// 路由函数组添加函数</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 初始化</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">Init</span><span style="color:#111">()</span> <span style="color:#f92672">*</span><span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Engine</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">New</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">function</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">options</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">function</span><span style="color:#111">(</span><span style="color:#75af00">r</span><span style="color:#111">)</span> <span style="color:#75715e">// 执行路由函数组中所有函数</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">r</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// shop中的文件</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">shop</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#d88200">&#34;github.com/gin-gonic/gin&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">Routers</span><span style="color:#111">(</span><span style="color:#75af00">e</span> <span style="color:#f92672">*</span><span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Engine</span><span style="color:#111">)</span> <span style="color:#111">{</span><span style="color:#75715e">// 路由函数</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">GET</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/post&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">String</span><span style="color:#111">(</span><span style="color:#ae81ff">200</span><span style="color:#111">,</span><span style="color:#d88200">&#34;psot shop&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">GET</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/comment&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">String</span><span style="color:#111">(</span><span style="color:#ae81ff">200</span><span style="color:#111">,</span><span style="color:#d88200">&#34;comment shop&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// main.go</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;test/demo1/route&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;test/demo1/shop&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">route</span><span style="color:#111">.</span><span style="color:#75af00">Include</span><span style="color:#111">(</span><span style="color:#75af00">shop</span><span style="color:#111">.</span><span style="color:#75af00">Routers</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 初始化路由</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">route</span><span style="color:#111">.</span><span style="color:#75af00">Init</span><span style="color:#111">()</span> 
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">_</span> <span style="color:#111">=</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">Run</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="路由原理">路由原理</h3>
<p>Gin框架中的路由使用的是<a href="https://github.com/julienschmidt/httprouter">httprouter</a>这个库。</p>
<p>其基本原理就是构造一个路由地址的前缀树。</p>
<h2 id="参考文章">参考文章</h2>
<ul>
<li><a href="https://www.liwenzhou.com/posts/Go/Gin_framework/">https://www.liwenzhou.com/posts/Go/Gin_framework/</a></li>
</ul>
]]></content:encoded><category>go</category><category>go</category><category>gin</category></item><item><title>goalng包和命令工具</title><link>https://daemon365.dev/post/go/goalng_package_and_command_tools/</link><pubDate>Sat, 29 Jun 2019 00:00:00 +0800</pubDate><guid>https://daemon365.dev/post/go/goalng_package_and_command_tools/</guid><description>&lt;h2 id="包简介"&gt;包简介&lt;/h2&gt;
&lt;p&gt;任何包系统设计的目的都是为了简化大型程序的设计和维护工作，通过将一组相关的特性放进一个独立的单元以便于理解和更新，在每个单元更新的同时保持和程序中其它单元的相对独立性。这种模块化的特性允许每个包可以被其它的不同项目共享和重用，在项目范围内、甚至全球范围统一的分发和复用。&lt;/p&gt;
&lt;p&gt;每个包一般都定义了一个不同的名字空间用于它内部的每个标识符的访问。每个名字空间关联到一个特定的包，让我们给类型、函数等选择简短明了的名字，这样可以在使用它们的时候减少和其它部分名字的冲突。&lt;/p&gt;
&lt;p&gt;每个包还通过控制包内名字的可见性和是否导出来实现封装特性。通过限制包成员的可见性并隐藏包API的具体实现，将允许包的维护者在不影响外部包用户的前提下调整包的内部实现。通过限制包内变量的可见性，还可以强制用户通过某些特定函数来访问和更新内部变量，这样可以保证内部变量的一致性和并发时的互斥约束。&lt;/p&gt;
&lt;h2 id="包的导入"&gt;包的导入&lt;/h2&gt;
&lt;p&gt;每个包是由一个全局唯一的字符串所标识的导入路径定位。出现在import语句中的导入路径也是字符串。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;import&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;fmt&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;math/rand&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;encoding/json&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;golang.org/x/net/html&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;github.com/go-sql-driver/mysql&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id="包声明"&gt;包声明&lt;/h2&gt;
&lt;p&gt;在每个Go语言源文件的开头都必须有包声明语句。包声明语句的主要目的是确定当前包被其它包导入时默认的标识符（也称为包名）。&lt;/p&gt;
&lt;p&gt;通常来说，默认的包名就是包导入路径名的最后一段，因此即使两个包的导入路径不同，它们依然可能有一个相同的包名。例如，math/rand包和golang.org/x/exp/rand包的包名都是rand。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;package&lt;/span&gt; &lt;span style="color:#75af00"&gt;main&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;import&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;fmt&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;math/rand&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// 导入rand包 用rand包里的方法函数等&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;main&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;rand&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Int63n&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;10000&lt;/span&gt;&lt;span style="color:#111"&gt;))&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 9410&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;package&lt;/span&gt; &lt;span style="color:#75af00"&gt;main&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;import&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;fmt&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;golang.org/x/exp/rand&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;main&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;rand&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Int63n&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;10000&lt;/span&gt;&lt;span style="color:#111"&gt;))&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 9351&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id="导入声明"&gt;导入声明&lt;/h2&gt;
&lt;p&gt;如果我们想同时导入两个有着名字相同的包，例如math/rand包和golang.org/x/exp/rand包，那么导入声明必须至少为一个同名包指定一个新的包名以避免冲突。这叫做导入包的重命名。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;package&lt;/span&gt; &lt;span style="color:#75af00"&gt;main&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;import&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;fmt&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;rand1&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;math/rand&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;rand2&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;golang.org/x/exp/rand&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;main&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;rand1&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Int63n&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;10000&lt;/span&gt;&lt;span style="color:#111"&gt;))&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 9401&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;rand2&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Int63n&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;10000&lt;/span&gt;&lt;span style="color:#111"&gt;))&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 9351&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id="包的匿名导入"&gt;包的匿名导入&lt;/h2&gt;
&lt;p&gt;如果只是导入一个包而并不使用导入的包将会导致一个编译错误。但是有时候我们只是想利用导入包而产生的副作用：它会计算包级变量的初始化表达式和执行导入包的init初始化函数。这时候我们需要抑制“unused import”编译错误，我们可以用下划线_来重命名导入的包。比如序号gorm包是要带入sql驱动&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;import&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;github.com/jinzhu/gorm&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;_&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;github.com/jinzhu/gorm/dialects/mysql&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;main&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;db&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;gorm&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Open&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;mysql&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;user:password@/dbname?charset=utf8&amp;amp;parseTime=True&amp;amp;loc=Local&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;defer&lt;/span&gt; &lt;span style="color:#75af00"&gt;db&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Close&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id="包和命名"&gt;包和命名&lt;/h2&gt;
&lt;p&gt;当创建一个包，**一般要用短小的包名，但也不能太短导致难以理解。**标准库中最常用的包有bufio、bytes、flag、fmt、http、io、json、os、sort、sync和time等包。&lt;/p&gt;
&lt;p&gt;包名一般采用单数的形式。标准库的bytes、errors和strings使用了复数形式，这是为了避免和预定义的类型冲突，同样还有go/types是为了避免和type关键字冲突。&lt;/p&gt;
&lt;h2 id="工具"&gt;工具&lt;/h2&gt;
&lt;p&gt;Go语言工具箱的具体功能，包括如何下载、格式化、构建、测试和安装Go语言编写的程序。&lt;/p&gt;
&lt;h3 id="go命令"&gt;go命令&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;$&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;go&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;...&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;build&lt;/span&gt; &lt;span style="color:#75af00"&gt;compile&lt;/span&gt; &lt;span style="color:#75af00"&gt;packages&lt;/span&gt; &lt;span style="color:#75af00"&gt;and&lt;/span&gt; &lt;span style="color:#75af00"&gt;dependencies&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;clean&lt;/span&gt; &lt;span style="color:#75af00"&gt;remove&lt;/span&gt; &lt;span style="color:#75af00"&gt;object&lt;/span&gt; &lt;span style="color:#75af00"&gt;files&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;doc&lt;/span&gt; &lt;span style="color:#75af00"&gt;show&lt;/span&gt; &lt;span style="color:#75af00"&gt;documentation&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;for&lt;/span&gt; &lt;span style="color:#f92672"&gt;package&lt;/span&gt; &lt;span style="color:#75af00"&gt;or&lt;/span&gt; &lt;span style="color:#75af00"&gt;symbol&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;env&lt;/span&gt; &lt;span style="color:#75af00"&gt;print&lt;/span&gt; &lt;span style="color:#75af00"&gt;Go&lt;/span&gt; &lt;span style="color:#75af00"&gt;environment&lt;/span&gt; &lt;span style="color:#75af00"&gt;information&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt; &lt;span style="color:#75af00"&gt;run&lt;/span&gt; &lt;span style="color:#75af00"&gt;gofmt&lt;/span&gt; &lt;span style="color:#75af00"&gt;on&lt;/span&gt; &lt;span style="color:#f92672"&gt;package&lt;/span&gt; &lt;span style="color:#75af00"&gt;sources&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;get&lt;/span&gt; &lt;span style="color:#75af00"&gt;download&lt;/span&gt; &lt;span style="color:#75af00"&gt;and&lt;/span&gt; &lt;span style="color:#75af00"&gt;install&lt;/span&gt; &lt;span style="color:#75af00"&gt;packages&lt;/span&gt; &lt;span style="color:#75af00"&gt;and&lt;/span&gt; &lt;span style="color:#75af00"&gt;dependencies&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;install&lt;/span&gt; &lt;span style="color:#75af00"&gt;compile&lt;/span&gt; &lt;span style="color:#75af00"&gt;and&lt;/span&gt; &lt;span style="color:#75af00"&gt;install&lt;/span&gt; &lt;span style="color:#75af00"&gt;packages&lt;/span&gt; &lt;span style="color:#75af00"&gt;and&lt;/span&gt; &lt;span style="color:#75af00"&gt;dependencies&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;list&lt;/span&gt; &lt;span style="color:#75af00"&gt;list&lt;/span&gt; &lt;span style="color:#75af00"&gt;packages&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;run&lt;/span&gt; &lt;span style="color:#75af00"&gt;compile&lt;/span&gt; &lt;span style="color:#75af00"&gt;and&lt;/span&gt; &lt;span style="color:#75af00"&gt;run&lt;/span&gt; &lt;span style="color:#75af00"&gt;Go&lt;/span&gt; &lt;span style="color:#75af00"&gt;program&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;test&lt;/span&gt; &lt;span style="color:#75af00"&gt;test&lt;/span&gt; &lt;span style="color:#75af00"&gt;packages&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;version&lt;/span&gt; &lt;span style="color:#75af00"&gt;print&lt;/span&gt; &lt;span style="color:#75af00"&gt;Go&lt;/span&gt; &lt;span style="color:#75af00"&gt;version&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;vet&lt;/span&gt; &lt;span style="color:#75af00"&gt;run&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;go&lt;/span&gt; &lt;span style="color:#75af00"&gt;tool&lt;/span&gt; &lt;span style="color:#75af00"&gt;vet&lt;/span&gt; &lt;span style="color:#75af00"&gt;on&lt;/span&gt; &lt;span style="color:#75af00"&gt;packages&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75af00"&gt;Use&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;go help [command]&amp;#34;&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;for&lt;/span&gt; &lt;span style="color:#75af00"&gt;more&lt;/span&gt; &lt;span style="color:#75af00"&gt;information&lt;/span&gt; &lt;span style="color:#75af00"&gt;about&lt;/span&gt; &lt;span style="color:#75af00"&gt;a&lt;/span&gt; &lt;span style="color:#75af00"&gt;command&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;...&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id="下载包"&gt;下载包&lt;/h3&gt;
&lt;p&gt;使用Go语言工具箱的go命令，不仅可以根据包导入路径找到本地工作区的包，甚至可以从互联网上找到和更新包。&lt;/p&gt;</description><content:encoded><![CDATA[<h2 id="包简介">包简介</h2>
<p>任何包系统设计的目的都是为了简化大型程序的设计和维护工作，通过将一组相关的特性放进一个独立的单元以便于理解和更新，在每个单元更新的同时保持和程序中其它单元的相对独立性。这种模块化的特性允许每个包可以被其它的不同项目共享和重用，在项目范围内、甚至全球范围统一的分发和复用。</p>
<p>每个包一般都定义了一个不同的名字空间用于它内部的每个标识符的访问。每个名字空间关联到一个特定的包，让我们给类型、函数等选择简短明了的名字，这样可以在使用它们的时候减少和其它部分名字的冲突。</p>
<p>每个包还通过控制包内名字的可见性和是否导出来实现封装特性。通过限制包成员的可见性并隐藏包API的具体实现，将允许包的维护者在不影响外部包用户的前提下调整包的内部实现。通过限制包内变量的可见性，还可以强制用户通过某些特定函数来访问和更新内部变量，这样可以保证内部变量的一致性和并发时的互斥约束。</p>
<h2 id="包的导入">包的导入</h2>
<p>每个包是由一个全局唯一的字符串所标识的导入路径定位。出现在import语句中的导入路径也是字符串。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d88200">&#34;math/rand&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d88200">&#34;encoding/json&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d88200">&#34;golang.org/x/net/html&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d88200">&#34;github.com/go-sql-driver/mysql&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span></code></pre></div><h2 id="包声明">包声明</h2>
<p>在每个Go语言源文件的开头都必须有包声明语句。包声明语句的主要目的是确定当前包被其它包导入时默认的标识符（也称为包名）。</p>
<p>通常来说，默认的包名就是包导入路径名的最后一段，因此即使两个包的导入路径不同，它们依然可能有一个相同的包名。例如，math/rand包和golang.org/x/exp/rand包的包名都是rand。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;math/rand&#34;</span>  
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 导入rand包 用rand包里的方法函数等</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">rand</span><span style="color:#111">.</span><span style="color:#75af00">Int63n</span><span style="color:#111">(</span><span style="color:#ae81ff">10000</span><span style="color:#111">))</span>  <span style="color:#75715e">// 9410</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;golang.org/x/exp/rand&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">rand</span><span style="color:#111">.</span><span style="color:#75af00">Int63n</span><span style="color:#111">(</span><span style="color:#ae81ff">10000</span><span style="color:#111">))</span> <span style="color:#75715e">// 9351</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="导入声明">导入声明</h2>
<p>如果我们想同时导入两个有着名字相同的包，例如math/rand包和golang.org/x/exp/rand包，那么导入声明必须至少为一个同名包指定一个新的包名以避免冲突。这叫做导入包的重命名。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">rand1</span> <span style="color:#d88200">&#34;math/rand&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">rand2</span> <span style="color:#d88200">&#34;golang.org/x/exp/rand&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">rand1</span><span style="color:#111">.</span><span style="color:#75af00">Int63n</span><span style="color:#111">(</span><span style="color:#ae81ff">10000</span><span style="color:#111">))</span> <span style="color:#75715e">// 9401</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">rand2</span><span style="color:#111">.</span><span style="color:#75af00">Int63n</span><span style="color:#111">(</span><span style="color:#ae81ff">10000</span><span style="color:#111">))</span> <span style="color:#75715e">// 9351</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="包的匿名导入">包的匿名导入</h2>
<p>如果只是导入一个包而并不使用导入的包将会导致一个编译错误。但是有时候我们只是想利用导入包而产生的副作用：它会计算包级变量的初始化表达式和执行导入包的init初始化函数。这时候我们需要抑制“unused import”编译错误，我们可以用下划线_来重命名导入的包。比如序号gorm包是要带入sql驱动</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d88200">&#34;github.com/jinzhu/gorm&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">_</span> <span style="color:#d88200">&#34;github.com/jinzhu/gorm/dialects/mysql&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75af00">db</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">gorm</span><span style="color:#111">.</span><span style="color:#75af00">Open</span><span style="color:#111">(</span><span style="color:#d88200">&#34;mysql&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;user:password@/dbname?charset=utf8&amp;parseTime=True&amp;loc=Local&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#00a8c8">defer</span> <span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="包和命名">包和命名</h2>
<p>当创建一个包，**一般要用短小的包名，但也不能太短导致难以理解。**标准库中最常用的包有bufio、bytes、flag、fmt、http、io、json、os、sort、sync和time等包。</p>
<p>包名一般采用单数的形式。标准库的bytes、errors和strings使用了复数形式，这是为了避免和预定义的类型冲突，同样还有go/types是为了避免和type关键字冲突。</p>
<h2 id="工具">工具</h2>
<p>Go语言工具箱的具体功能，包括如何下载、格式化、构建、测试和安装Go语言编写的程序。</p>
<h3 id="go命令">go命令</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">$</span> <span style="color:#00a8c8">go</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">build</span>            <span style="color:#75af00">compile</span> <span style="color:#75af00">packages</span> <span style="color:#75af00">and</span> <span style="color:#75af00">dependencies</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">clean</span>            <span style="color:#75af00">remove</span> <span style="color:#75af00">object</span> <span style="color:#75af00">files</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">doc</span>              <span style="color:#75af00">show</span> <span style="color:#75af00">documentation</span> <span style="color:#00a8c8">for</span> <span style="color:#f92672">package</span> <span style="color:#75af00">or</span> <span style="color:#75af00">symbol</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">env</span>              <span style="color:#75af00">print</span> <span style="color:#75af00">Go</span> <span style="color:#75af00">environment</span> <span style="color:#75af00">information</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">fmt</span>              <span style="color:#75af00">run</span> <span style="color:#75af00">gofmt</span> <span style="color:#75af00">on</span> <span style="color:#f92672">package</span> <span style="color:#75af00">sources</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">get</span>              <span style="color:#75af00">download</span> <span style="color:#75af00">and</span> <span style="color:#75af00">install</span> <span style="color:#75af00">packages</span> <span style="color:#75af00">and</span> <span style="color:#75af00">dependencies</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">install</span>          <span style="color:#75af00">compile</span> <span style="color:#75af00">and</span> <span style="color:#75af00">install</span> <span style="color:#75af00">packages</span> <span style="color:#75af00">and</span> <span style="color:#75af00">dependencies</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">list</span>             <span style="color:#75af00">list</span> <span style="color:#75af00">packages</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">run</span>              <span style="color:#75af00">compile</span> <span style="color:#75af00">and</span> <span style="color:#75af00">run</span> <span style="color:#75af00">Go</span> <span style="color:#75af00">program</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">test</span>             <span style="color:#75af00">test</span> <span style="color:#75af00">packages</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">version</span>          <span style="color:#75af00">print</span> <span style="color:#75af00">Go</span> <span style="color:#75af00">version</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">vet</span>              <span style="color:#75af00">run</span> <span style="color:#00a8c8">go</span> <span style="color:#75af00">tool</span> <span style="color:#75af00">vet</span> <span style="color:#75af00">on</span> <span style="color:#75af00">packages</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">Use</span> <span style="color:#d88200">&#34;go help [command]&#34;</span> <span style="color:#00a8c8">for</span> <span style="color:#75af00">more</span> <span style="color:#75af00">information</span> <span style="color:#75af00">about</span> <span style="color:#75af00">a</span> <span style="color:#75af00">command</span><span style="color:#111">.</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">...</span>
</span></span></code></pre></div><h3 id="下载包">下载包</h3>
<p>使用Go语言工具箱的go命令，不仅可以根据包导入路径找到本地工作区的包，甚至可以从互联网上找到和更新包。</p>
<p>使用命令go get可以下载一个单一的包或者用&hellip;下载整个子目录里面的每个包。Go语言工具箱的go命令同时计算并下载所依赖的每个包，这也是前一个例子中golang.org/x/net/html自动出现在本地工作区目录的原因。</p>
<h3 id="构建包">构建包</h3>
<p>go build命令编译命令行参数指定的每个包。如果包是一个库，则忽略输出结果；这可以用于检测包是可以正确编译的。如果包的名字是main，go build将调用链接器在当前目录创建一个可执行程序；以导入路径的最后一段作为可执行程序的名字。</p>
<h3 id="包文档">包文档</h3>
<p>Go语言的编码风格鼓励为每个包提供良好的文档。包中每个导出的成员和包声明前都应该包含目的和用法说明的注释。</p>
<p>Go语言中的文档注释一般是完整的句子，第一行通常是摘要说明，以被注释者的名字开头。注释中函数的参数或其它的标识符并不需要额外的引号或其它标记注明。例如，下面是fmt.Fprintf的文档注释。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// Fprintf formats according to a format specifier and writes to w.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// It returns the number of bytes written and any write error encountered.</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">Fprintf</span><span style="color:#111">(</span><span style="color:#75af00">w</span> <span style="color:#75af00">io</span><span style="color:#111">.</span><span style="color:#75af00">Writer</span><span style="color:#111">,</span> <span style="color:#75af00">format</span> <span style="color:#00a8c8">string</span><span style="color:#111">,</span> <span style="color:#75af00">a</span> <span style="color:#f92672">...</span><span style="color:#00a8c8">interface</span><span style="color:#111">{})</span> <span style="color:#111">(</span><span style="color:#00a8c8">int</span><span style="color:#111">,</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span>
</span></span></code></pre></div><p>首先是go doc命令，该命令打印其后所指定的实体的声明与文档注释，该实体可能是一个包：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">$</span> <span style="color:#00a8c8">go</span> <span style="color:#75af00">doc</span> <span style="color:#75af00">time</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">time</span> <span style="color:#75715e">// import &#34;time&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">Package</span> <span style="color:#75af00">time</span> <span style="color:#75af00">provides</span> <span style="color:#75af00">functionality</span> <span style="color:#00a8c8">for</span> <span style="color:#75af00">measuring</span> <span style="color:#75af00">and</span> <span style="color:#75af00">displaying</span> <span style="color:#75af00">time</span><span style="color:#111">.</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">const</span> <span style="color:#75af00">Nanosecond</span> <span style="color:#75af00">Duration</span> <span style="color:#111">=</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">After</span><span style="color:#111">(</span><span style="color:#75af00">d</span> <span style="color:#75af00">Duration</span><span style="color:#111">)</span> <span style="color:#f92672">&lt;-</span><span style="color:#00a8c8">chan</span> <span style="color:#75af00">Time</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">Sleep</span><span style="color:#111">(</span><span style="color:#75af00">d</span> <span style="color:#75af00">Duration</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">Since</span><span style="color:#111">(</span><span style="color:#75af00">t</span> <span style="color:#75af00">Time</span><span style="color:#111">)</span> <span style="color:#75af00">Duration</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">Now</span><span style="color:#111">()</span> <span style="color:#75af00">Time</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Duration</span> <span style="color:#00a8c8">int64</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Time</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span> <span style="color:#f92672">...</span> <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">...</span><span style="color:#75af00">many</span> <span style="color:#75af00">more</span><span style="color:#f92672">...</span>
</span></span></code></pre></div><p>或者是某个具体的包成员：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">$</span> <span style="color:#00a8c8">go</span> <span style="color:#75af00">doc</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Since</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">Since</span><span style="color:#111">(</span><span style="color:#75af00">t</span> <span style="color:#75af00">Time</span><span style="color:#111">)</span> <span style="color:#75af00">Duration</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">Since</span> <span style="color:#75af00">returns</span> <span style="color:#75af00">the</span> <span style="color:#75af00">time</span> <span style="color:#75af00">elapsed</span> <span style="color:#75af00">since</span> <span style="color:#75af00">t</span><span style="color:#111">.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">It</span> <span style="color:#75af00">is</span> <span style="color:#75af00">shorthand</span> <span style="color:#00a8c8">for</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Now</span><span style="color:#111">().</span><span style="color:#75af00">Sub</span><span style="color:#111">(</span><span style="color:#75af00">t</span><span style="color:#111">).</span>
</span></span></code></pre></div><p>或者是一个方法：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">$</span> <span style="color:#00a8c8">go</span> <span style="color:#75af00">doc</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Duration</span><span style="color:#111">.</span><span style="color:#75af00">Seconds</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">d</span> <span style="color:#75af00">Duration</span><span style="color:#111">)</span> <span style="color:#75af00">Seconds</span><span style="color:#111">()</span> <span style="color:#00a8c8">float64</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">Seconds</span> <span style="color:#75af00">returns</span> <span style="color:#75af00">the</span> <span style="color:#75af00">duration</span> <span style="color:#75af00">as</span> <span style="color:#75af00">a</span> <span style="color:#75af00">floating</span><span style="color:#f92672">-</span><span style="color:#75af00">point</span> <span style="color:#75af00">number</span> <span style="color:#75af00">of</span> <span style="color:#75af00">seconds</span><span style="color:#111">.</span>
</span></span></code></pre></div><h3 id="内部包">内部包</h3>
<p>在Go语言程序中，包是最重要的封装机制。没有导出的标识符只在同一个包内部可以访问，而导出的标识符则是面向全宇宙都是可见的。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">net</span><span style="color:#f92672">/</span><span style="color:#75af00">http</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">net</span><span style="color:#f92672">/</span><span style="color:#75af00">http</span><span style="color:#f92672">/</span><span style="color:#75af00">internal</span><span style="color:#f92672">/</span><span style="color:#75af00">chunked</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">net</span><span style="color:#f92672">/</span><span style="color:#75af00">http</span><span style="color:#f92672">/</span><span style="color:#75af00">httputil</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">net</span><span style="color:#f92672">/</span><span style="color:#75af00">url</span>
</span></span></code></pre></div><h3 id="查询包">查询包</h3>
<p>go list命令可以查询可用包的信息。其最简单的形式，可以测试包是否在工作区并打印它的导入路径：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">$</span> <span style="color:#00a8c8">go</span> <span style="color:#75af00">list</span> <span style="color:#75af00">github</span><span style="color:#111">.</span><span style="color:#75af00">com</span><span style="color:#f92672">/</span><span style="color:#00a8c8">go</span><span style="color:#f92672">-</span><span style="color:#75af00">sql</span><span style="color:#f92672">-</span><span style="color:#75af00">driver</span><span style="color:#f92672">/</span><span style="color:#75af00">mysql</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">github</span><span style="color:#111">.</span><span style="color:#75af00">com</span><span style="color:#f92672">/</span><span style="color:#00a8c8">go</span><span style="color:#f92672">-</span><span style="color:#75af00">sql</span><span style="color:#f92672">-</span><span style="color:#75af00">driver</span><span style="color:#f92672">/</span><span style="color:#75af00">mysql</span>
</span></span></code></pre></div><p>go list命令还可以获取每个包完整的元信息，而不仅仅只是导入路径，这些元信息可以以不同格式提供给用户。其中-json命令行参数表示用JSON格式打印每个包的元信息。可以用&quot;&hellip;&ldquo;表示匹配相关包的包的导入路径。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">$</span> <span style="color:#00a8c8">go</span> <span style="color:#75af00">list</span> <span style="color:#f92672">...</span><span style="color:#75af00">mysql</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">github</span><span style="color:#111">.</span><span style="color:#75af00">com</span><span style="color:#f92672">/</span><span style="color:#75af00">astaxie</span><span style="color:#f92672">/</span><span style="color:#75af00">beego</span><span style="color:#f92672">/</span><span style="color:#75af00">session</span><span style="color:#f92672">/</span><span style="color:#75af00">mysql</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">github</span><span style="color:#111">.</span><span style="color:#75af00">com</span><span style="color:#f92672">/</span><span style="color:#00a8c8">go</span><span style="color:#f92672">-</span><span style="color:#75af00">sql</span><span style="color:#f92672">-</span><span style="color:#75af00">driver</span><span style="color:#f92672">/</span><span style="color:#75af00">mysql</span>
</span></span></code></pre></div><p>参考文章:</p>
<ul>
<li>《go语言圣经》</li>
</ul>
]]></content:encoded><category>go</category><category>go</category></item><item><title>golang 单元测试</title><link>https://daemon365.dev/post/go/golang_unit_testing/</link><pubDate>Sat, 29 Jun 2019 00:00:00 +0800</pubDate><guid>https://daemon365.dev/post/go/golang_unit_testing/</guid><description>&lt;h2 id="go-test"&gt;go test&lt;/h2&gt;
&lt;p&gt;go test命令是一个按照一定的约定和组织来测试代码的程序。在包目录内，所有以_test.go为后缀名的源文件在执行go build时不会被构建成包的一部分，它们是go test测试的一部分。&lt;/p&gt;
&lt;p&gt;go test命令会遍历所有的*_test.go文件中符合上述命名规则的函数，生成一个临时的main包用于调用相应的测试函数，接着构建并运行、报告测试结果，最后清理测试中生成的临时文件。&lt;/p&gt;
&lt;p&gt;在*_test.go文件中有三种类型的函数，单元测试函数、基准测试函数和示例函数。&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;类型&lt;/th&gt;
&lt;th&gt;格式&lt;/th&gt;
&lt;th&gt;作用&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;测试函数&lt;/td&gt;
&lt;td&gt;函数名前缀为Test&lt;/td&gt;
&lt;td&gt;测试程序的一些逻辑行为是否正确&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;基准函数&lt;/td&gt;
&lt;td&gt;函数名前缀为Benchmark&lt;/td&gt;
&lt;td&gt;测试函数的性能&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;示例函数&lt;/td&gt;
&lt;td&gt;函数名前缀为Example&lt;/td&gt;
&lt;td&gt;为文档提供示例文档&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h2 id="测试函数"&gt;测试函数&lt;/h2&gt;
&lt;p&gt;每个测试函数必须导入testing包。测试函数有如下的签名：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;TestName&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;t&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;testing&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;T&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// ...&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;测试函数的名字必须以Test开头，可选的后缀名必须以大写字母开头：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;TestSin&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;t&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;testing&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;T&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt; &lt;span style="color:#75715e"&gt;/* ... */&lt;/span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;TestCos&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;t&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;testing&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;T&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt; &lt;span style="color:#75715e"&gt;/* ... */&lt;/span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;TestLog&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;t&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;testing&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;T&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt; &lt;span style="color:#75715e"&gt;/* ... */&lt;/span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;其中参数t用于报告测试失败和附加的日志信息。testing.T的拥有的方法如下：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;c&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;T&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75af00"&gt;Error&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;args&lt;/span&gt; &lt;span style="color:#f92672"&gt;...&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;interface&lt;/span&gt;&lt;span style="color:#111"&gt;{})&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;c&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;T&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75af00"&gt;Errorf&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;format&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;string&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;args&lt;/span&gt; &lt;span style="color:#f92672"&gt;...&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;interface&lt;/span&gt;&lt;span style="color:#111"&gt;{})&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;c&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;T&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75af00"&gt;Fail&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;c&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;T&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75af00"&gt;FailNow&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;c&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;T&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75af00"&gt;Failed&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;bool&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;c&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;T&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75af00"&gt;Fatal&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;args&lt;/span&gt; &lt;span style="color:#f92672"&gt;...&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;interface&lt;/span&gt;&lt;span style="color:#111"&gt;{})&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;c&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;T&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75af00"&gt;Fatalf&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;format&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;string&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;args&lt;/span&gt; &lt;span style="color:#f92672"&gt;...&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;interface&lt;/span&gt;&lt;span style="color:#111"&gt;{})&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;c&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;T&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75af00"&gt;Log&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;args&lt;/span&gt; &lt;span style="color:#f92672"&gt;...&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;interface&lt;/span&gt;&lt;span style="color:#111"&gt;{})&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;c&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;T&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75af00"&gt;Logf&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;format&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;string&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;args&lt;/span&gt; &lt;span style="color:#f92672"&gt;...&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;interface&lt;/span&gt;&lt;span style="color:#111"&gt;{})&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;c&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;T&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75af00"&gt;Name&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;string&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;t&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;T&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75af00"&gt;Parallel&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;t&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;T&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75af00"&gt;Run&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;name&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;string&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;f&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;func&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;t&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;T&lt;/span&gt;&lt;span style="color:#111"&gt;))&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;bool&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;c&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;T&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75af00"&gt;Skip&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;args&lt;/span&gt; &lt;span style="color:#f92672"&gt;...&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;interface&lt;/span&gt;&lt;span style="color:#111"&gt;{})&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;c&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;T&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75af00"&gt;SkipNow&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;c&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;T&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75af00"&gt;Skipf&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;format&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;string&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;args&lt;/span&gt; &lt;span style="color:#f92672"&gt;...&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;interface&lt;/span&gt;&lt;span style="color:#111"&gt;{})&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;c&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;T&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75af00"&gt;Skipped&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;bool&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id="测试函数示例"&gt;测试函数示例&lt;/h3&gt;
&lt;p&gt;就像细胞是构成我们身体的基本单位，一个软件程序也是由很多单元组件构成的。单元组件可以是函数、结构体、方法和最终用户可能依赖的任意东西。总之我们需要确保这些组件是能够正常运行的。单元测试是一些利用各种方法测试单元组件的程序，它会将结果与预期输出进行比较。&lt;/p&gt;
&lt;p&gt;接下来，我们定义一个split的包，包中定义了一个Split函数，具体实现如下：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;// split/split.go&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;package&lt;/span&gt; &lt;span style="color:#75af00"&gt;split&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;import&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;strings&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;// split package with a single split function.&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;// Split slices s into all substrings separated by sep and&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;// returns a slice of the substrings between those separators.&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;Split&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;s&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;sep&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;string&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;result&lt;/span&gt; &lt;span style="color:#111"&gt;[]&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;string&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;i&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;strings&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Index&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;s&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;sep&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;for&lt;/span&gt; &lt;span style="color:#75af00"&gt;i&lt;/span&gt; &lt;span style="color:#111"&gt;&amp;gt;&lt;/span&gt; &lt;span style="color:#f92672"&gt;-&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;1&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;result&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#111"&gt;append&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;result&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;s&lt;/span&gt;&lt;span style="color:#111"&gt;[:&lt;/span&gt;&lt;span style="color:#75af00"&gt;i&lt;/span&gt;&lt;span style="color:#111"&gt;])&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;s&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#75af00"&gt;s&lt;/span&gt;&lt;span style="color:#111"&gt;[&lt;/span&gt;&lt;span style="color:#75af00"&gt;i&lt;/span&gt;&lt;span style="color:#f92672"&gt;+&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;1&lt;/span&gt;&lt;span style="color:#111"&gt;:]&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;i&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#75af00"&gt;strings&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Index&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;s&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;sep&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;result&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#111"&gt;append&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;result&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;s&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;在当前目录下，我们创建一个split_test.go的测试文件，并定义一个测试函数如下：&lt;/p&gt;</description><content:encoded><![CDATA[<h2 id="go-test">go test</h2>
<p>go test命令是一个按照一定的约定和组织来测试代码的程序。在包目录内，所有以_test.go为后缀名的源文件在执行go build时不会被构建成包的一部分，它们是go test测试的一部分。</p>
<p>go test命令会遍历所有的*_test.go文件中符合上述命名规则的函数，生成一个临时的main包用于调用相应的测试函数，接着构建并运行、报告测试结果，最后清理测试中生成的临时文件。</p>
<p>在*_test.go文件中有三种类型的函数，单元测试函数、基准测试函数和示例函数。</p>
<table>
  <thead>
      <tr>
          <th>类型</th>
          <th>格式</th>
          <th>作用</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>测试函数</td>
          <td>函数名前缀为Test</td>
          <td>测试程序的一些逻辑行为是否正确</td>
      </tr>
      <tr>
          <td>基准函数</td>
          <td>函数名前缀为Benchmark</td>
          <td>测试函数的性能</td>
      </tr>
      <tr>
          <td>示例函数</td>
          <td>函数名前缀为Example</td>
          <td>为文档提供示例文档</td>
      </tr>
  </tbody>
</table>
<h2 id="测试函数">测试函数</h2>
<p>每个测试函数必须导入testing包。测试函数有如下的签名：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">TestName</span><span style="color:#111">(</span><span style="color:#75af00">t</span> <span style="color:#f92672">*</span><span style="color:#75af00">testing</span><span style="color:#111">.</span><span style="color:#75af00">T</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ...</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>测试函数的名字必须以Test开头，可选的后缀名必须以大写字母开头：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">TestSin</span><span style="color:#111">(</span><span style="color:#75af00">t</span> <span style="color:#f92672">*</span><span style="color:#75af00">testing</span><span style="color:#111">.</span><span style="color:#75af00">T</span><span style="color:#111">)</span> <span style="color:#111">{</span> <span style="color:#75715e">/* ... */</span> <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">TestCos</span><span style="color:#111">(</span><span style="color:#75af00">t</span> <span style="color:#f92672">*</span><span style="color:#75af00">testing</span><span style="color:#111">.</span><span style="color:#75af00">T</span><span style="color:#111">)</span> <span style="color:#111">{</span> <span style="color:#75715e">/* ... */</span> <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">TestLog</span><span style="color:#111">(</span><span style="color:#75af00">t</span> <span style="color:#f92672">*</span><span style="color:#75af00">testing</span><span style="color:#111">.</span><span style="color:#75af00">T</span><span style="color:#111">)</span> <span style="color:#111">{</span> <span style="color:#75715e">/* ... */</span> <span style="color:#111">}</span>
</span></span></code></pre></div><p>其中参数t用于报告测试失败和附加的日志信息。testing.T的拥有的方法如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">T</span><span style="color:#111">)</span> <span style="color:#75af00">Error</span><span style="color:#111">(</span><span style="color:#75af00">args</span> <span style="color:#f92672">...</span><span style="color:#00a8c8">interface</span><span style="color:#111">{})</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">T</span><span style="color:#111">)</span> <span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#75af00">format</span> <span style="color:#00a8c8">string</span><span style="color:#111">,</span> <span style="color:#75af00">args</span> <span style="color:#f92672">...</span><span style="color:#00a8c8">interface</span><span style="color:#111">{})</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">T</span><span style="color:#111">)</span> <span style="color:#75af00">Fail</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">T</span><span style="color:#111">)</span> <span style="color:#75af00">FailNow</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">T</span><span style="color:#111">)</span> <span style="color:#75af00">Failed</span><span style="color:#111">()</span> <span style="color:#00a8c8">bool</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">T</span><span style="color:#111">)</span> <span style="color:#75af00">Fatal</span><span style="color:#111">(</span><span style="color:#75af00">args</span> <span style="color:#f92672">...</span><span style="color:#00a8c8">interface</span><span style="color:#111">{})</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">T</span><span style="color:#111">)</span> <span style="color:#75af00">Fatalf</span><span style="color:#111">(</span><span style="color:#75af00">format</span> <span style="color:#00a8c8">string</span><span style="color:#111">,</span> <span style="color:#75af00">args</span> <span style="color:#f92672">...</span><span style="color:#00a8c8">interface</span><span style="color:#111">{})</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">T</span><span style="color:#111">)</span> <span style="color:#75af00">Log</span><span style="color:#111">(</span><span style="color:#75af00">args</span> <span style="color:#f92672">...</span><span style="color:#00a8c8">interface</span><span style="color:#111">{})</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">T</span><span style="color:#111">)</span> <span style="color:#75af00">Logf</span><span style="color:#111">(</span><span style="color:#75af00">format</span> <span style="color:#00a8c8">string</span><span style="color:#111">,</span> <span style="color:#75af00">args</span> <span style="color:#f92672">...</span><span style="color:#00a8c8">interface</span><span style="color:#111">{})</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">T</span><span style="color:#111">)</span> <span style="color:#75af00">Name</span><span style="color:#111">()</span> <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">t</span> <span style="color:#f92672">*</span><span style="color:#75af00">T</span><span style="color:#111">)</span> <span style="color:#75af00">Parallel</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">t</span> <span style="color:#f92672">*</span><span style="color:#75af00">T</span><span style="color:#111">)</span> <span style="color:#75af00">Run</span><span style="color:#111">(</span><span style="color:#75af00">name</span> <span style="color:#00a8c8">string</span><span style="color:#111">,</span> <span style="color:#75af00">f</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">t</span> <span style="color:#f92672">*</span><span style="color:#75af00">T</span><span style="color:#111">))</span> <span style="color:#00a8c8">bool</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">T</span><span style="color:#111">)</span> <span style="color:#75af00">Skip</span><span style="color:#111">(</span><span style="color:#75af00">args</span> <span style="color:#f92672">...</span><span style="color:#00a8c8">interface</span><span style="color:#111">{})</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">T</span><span style="color:#111">)</span> <span style="color:#75af00">SkipNow</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">T</span><span style="color:#111">)</span> <span style="color:#75af00">Skipf</span><span style="color:#111">(</span><span style="color:#75af00">format</span> <span style="color:#00a8c8">string</span><span style="color:#111">,</span> <span style="color:#75af00">args</span> <span style="color:#f92672">...</span><span style="color:#00a8c8">interface</span><span style="color:#111">{})</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">T</span><span style="color:#111">)</span> <span style="color:#75af00">Skipped</span><span style="color:#111">()</span> <span style="color:#00a8c8">bool</span>
</span></span></code></pre></div><h3 id="测试函数示例">测试函数示例</h3>
<p>就像细胞是构成我们身体的基本单位，一个软件程序也是由很多单元组件构成的。单元组件可以是函数、结构体、方法和最终用户可能依赖的任意东西。总之我们需要确保这些组件是能够正常运行的。单元测试是一些利用各种方法测试单元组件的程序，它会将结果与预期输出进行比较。</p>
<p>接下来，我们定义一个split的包，包中定义了一个Split函数，具体实现如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// split/split.go</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">split</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#d88200">&#34;strings&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// split package with a single split function.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Split slices s into all substrings separated by sep and</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// returns a slice of the substrings between those separators.</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">Split</span><span style="color:#111">(</span><span style="color:#75af00">s</span><span style="color:#111">,</span> <span style="color:#75af00">sep</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#75af00">result</span> <span style="color:#111">[]</span><span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">i</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">strings</span><span style="color:#111">.</span><span style="color:#75af00">Index</span><span style="color:#111">(</span><span style="color:#75af00">s</span><span style="color:#111">,</span> <span style="color:#75af00">sep</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">i</span> <span style="color:#111">&gt;</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">result</span> <span style="color:#111">=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">result</span><span style="color:#111">,</span> <span style="color:#75af00">s</span><span style="color:#111">[:</span><span style="color:#75af00">i</span><span style="color:#111">])</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">s</span> <span style="color:#111">=</span> <span style="color:#75af00">s</span><span style="color:#111">[</span><span style="color:#75af00">i</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span><span style="color:#111">:]</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">i</span> <span style="color:#111">=</span> <span style="color:#75af00">strings</span><span style="color:#111">.</span><span style="color:#75af00">Index</span><span style="color:#111">(</span><span style="color:#75af00">s</span><span style="color:#111">,</span> <span style="color:#75af00">sep</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">result</span> <span style="color:#111">=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">result</span><span style="color:#111">,</span> <span style="color:#75af00">s</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>在当前目录下，我们创建一个split_test.go的测试文件，并定义一个测试函数如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// split/split_test.go</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">split</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;reflect&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;testing&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">TestSplit</span><span style="color:#111">(</span><span style="color:#75af00">t</span> <span style="color:#f92672">*</span><span style="color:#75af00">testing</span><span style="color:#111">.</span><span style="color:#75af00">T</span><span style="color:#111">)</span> <span style="color:#111">{</span> <span style="color:#75715e">// 测试函数名必须以Test开头，必须接收一个*testing.T类型参数</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">got</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">Split</span><span style="color:#111">(</span><span style="color:#d88200">&#34;a:b:c&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;:&#34;</span><span style="color:#111">)</span>         <span style="color:#75715e">// 程序输出的结果</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">want</span> <span style="color:#f92672">:=</span> <span style="color:#111">[]</span><span style="color:#00a8c8">string</span><span style="color:#111">{</span><span style="color:#d88200">&#34;a&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;b&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;c&#34;</span><span style="color:#111">}</span>    <span style="color:#75715e">// 期望的结果</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">reflect</span><span style="color:#111">.</span><span style="color:#75af00">DeepEqual</span><span style="color:#111">(</span><span style="color:#75af00">want</span><span style="color:#111">,</span> <span style="color:#75af00">got</span><span style="color:#111">)</span> <span style="color:#111">{</span> <span style="color:#75715e">// 因为slice不能比较直接，借助反射包中的方法比较</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;excepted:%v, got:%v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">want</span><span style="color:#111">,</span> <span style="color:#75af00">got</span><span style="color:#111">)</span> <span style="color:#75715e">// 测试失败输出错误提示</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>此时split这个包中的文件如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>split $ ls -l
</span></span><span style="display:flex;"><span>total <span style="color:#ae81ff">16</span>
</span></span><span style="display:flex;"><span>-rw-r--r--  <span style="color:#ae81ff">1</span> zhaohaiyu  <span style="color:#111">test</span>  <span style="color:#ae81ff">408</span>  <span style="color:#ae81ff">4</span> <span style="color:#ae81ff">29</span> 15:50 split.go
</span></span><span style="display:flex;"><span>-rw-r--r--  <span style="color:#ae81ff">1</span> zhaohaiyu  <span style="color:#111">test</span>  <span style="color:#ae81ff">466</span>  <span style="color:#ae81ff">4</span> <span style="color:#ae81ff">29</span> 16:04 split_test.go
</span></span></code></pre></div><p>在split包路径下，执行go test命令，可以看到输出结果如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>split $ go <span style="color:#111">test</span>
</span></span><span style="display:flex;"><span>PASS
</span></span><span style="display:flex;"><span>ok     test/split       0.005s
</span></span></code></pre></div><p>一个测试用例有点单薄，我们再编写一个测试使用多个字符切割字符串的例子，在split_test.go中添加如下测试函数：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">TestMoreSplit</span><span style="color:#111">(</span><span style="color:#75af00">t</span> <span style="color:#f92672">*</span><span style="color:#75af00">testing</span><span style="color:#111">.</span><span style="color:#75af00">T</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">got</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">Split</span><span style="color:#111">(</span><span style="color:#d88200">&#34;abcd&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;bc&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">want</span> <span style="color:#f92672">:=</span> <span style="color:#111">[]</span><span style="color:#00a8c8">string</span><span style="color:#111">{</span><span style="color:#d88200">&#34;a&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;d&#34;</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">reflect</span><span style="color:#111">.</span><span style="color:#75af00">DeepEqual</span><span style="color:#111">(</span><span style="color:#75af00">want</span><span style="color:#111">,</span> <span style="color:#75af00">got</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;excepted:%v, got:%v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">want</span><span style="color:#111">,</span> <span style="color:#75af00">got</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>再次运行go test命令，输出结果如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>split $ go <span style="color:#111">test</span>
</span></span><span style="display:flex;"><span>--- FAIL: TestMultiSplit <span style="color:#f92672">(</span>0.00s<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    split_test.go:20: excepted:<span style="color:#f92672">[</span>a d<span style="color:#f92672">]</span>, got:<span style="color:#f92672">[</span>a cd<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>FAIL
</span></span><span style="display:flex;"><span><span style="color:#111">exit</span> status <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>FAIL    test/split        0.006s
</span></span></code></pre></div><p>这一次，我们的测试失败了。我们可以为go test命令添加-v参数，查看测试函数名称和运行时间：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>split $ go <span style="color:#111">test</span> -v
</span></span><span style="display:flex;"><span><span style="color:#f92672">===</span> RUN   TestSplit
</span></span><span style="display:flex;"><span>--- PASS: TestSplit <span style="color:#f92672">(</span>0.00s<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">===</span> RUN   TestMoreSplit
</span></span><span style="display:flex;"><span>--- FAIL: TestMoreSplit <span style="color:#f92672">(</span>0.00s<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    split_test.go:21: excepted:<span style="color:#f92672">[</span>a d<span style="color:#f92672">]</span>, got:<span style="color:#f92672">[</span>a cd<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>FAIL
</span></span><span style="display:flex;"><span><span style="color:#111">exit</span> status <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>FAIL    test/split        0.005s
</span></span></code></pre></div><p>这一次我们能清楚的看到是TestMoreSplit这个测试没有成功。 还可以在go test命令后添加-run参数，它对应一个正则表达式，只有函数名匹配上的测试函数才会被go test命令执行。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>split $ go <span style="color:#111">test</span> -v -run<span style="color:#f92672">=</span><span style="color:#d88200">&#34;More&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">===</span> RUN   TestMoreSplit
</span></span><span style="display:flex;"><span>--- FAIL: TestMoreSplit <span style="color:#f92672">(</span>0.00s<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    split_test.go:21: excepted:<span style="color:#f92672">[</span>a d<span style="color:#f92672">]</span>, got:<span style="color:#f92672">[</span>a cd<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>FAIL
</span></span><span style="display:flex;"><span><span style="color:#111">exit</span> status <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>FAIL    test/split       0.006s
</span></span></code></pre></div><p>现在我们回过头来解决我们程序中的问题。很显然我们最初的split函数并没有考虑到sep为多个字符的情况，我们来修复下这个Bug：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">split</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#d88200">&#34;strings&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// split package with a single split function.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Split slices s into all substrings separated by sep and</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// returns a slice of the substrings between those separators.</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">Split</span><span style="color:#111">(</span><span style="color:#75af00">s</span><span style="color:#111">,</span> <span style="color:#75af00">sep</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#75af00">result</span> <span style="color:#111">[]</span><span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">i</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">strings</span><span style="color:#111">.</span><span style="color:#75af00">Index</span><span style="color:#111">(</span><span style="color:#75af00">s</span><span style="color:#111">,</span> <span style="color:#75af00">sep</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">i</span> <span style="color:#111">&gt;</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">result</span> <span style="color:#111">=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">result</span><span style="color:#111">,</span> <span style="color:#75af00">s</span><span style="color:#111">[:</span><span style="color:#75af00">i</span><span style="color:#111">])</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">s</span> <span style="color:#111">=</span> <span style="color:#75af00">s</span><span style="color:#111">[</span><span style="color:#75af00">i</span><span style="color:#f92672">+</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">sep</span><span style="color:#111">):]</span> <span style="color:#75715e">// 这里使用len(sep)获取sep的长度</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">i</span> <span style="color:#111">=</span> <span style="color:#75af00">strings</span><span style="color:#111">.</span><span style="color:#75af00">Index</span><span style="color:#111">(</span><span style="color:#75af00">s</span><span style="color:#111">,</span> <span style="color:#75af00">sep</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">result</span> <span style="color:#111">=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">result</span><span style="color:#111">,</span> <span style="color:#75af00">s</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>这一次我们再来测试一下，我们的程序。注意，当我们修改了我们的代码之后不要仅仅执行那些失败的测试函数，我们应该完整的运行所有的测试，保证不会因为修改代码而引入了新的问题。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>split $ go <span style="color:#111">test</span> -v
</span></span><span style="display:flex;"><span><span style="color:#f92672">===</span> RUN   TestSplit
</span></span><span style="display:flex;"><span>--- PASS: TestSplit <span style="color:#f92672">(</span>0.00s<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">===</span> RUN   TestMoreSplit
</span></span><span style="display:flex;"><span>--- PASS: TestMoreSplit <span style="color:#f92672">(</span>0.00s<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>PASS
</span></span><span style="display:flex;"><span>ok      test/split        0.006s
</span></span></code></pre></div><p>这一次我们的测试都通过了。</p>
<h3 id="测试组">测试组</h3>
<p>我们现在还想要测试一下split函数对中文字符串的支持，这个时候我们可以再编写一个TestChineseSplit测试函数，但是我们也可以使用如下更友好的一种方式来添加更多的测试用例。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">TestSplit</span><span style="color:#111">(</span><span style="color:#75af00">t</span> <span style="color:#f92672">*</span><span style="color:#75af00">testing</span><span style="color:#111">.</span><span style="color:#75af00">T</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75715e">// 定义一个测试用例类型</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">type</span> <span style="color:#75af00">test</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">input</span> <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">sep</span>   <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">want</span>  <span style="color:#111">[]</span><span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 定义一个存储测试用例的切片</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">tests</span> <span style="color:#f92672">:=</span> <span style="color:#111">[]</span><span style="color:#75af00">test</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">{</span><span style="color:#75af00">input</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;a:b:c&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">sep</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;:&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">want</span><span style="color:#111">:</span> <span style="color:#111">[]</span><span style="color:#00a8c8">string</span><span style="color:#111">{</span><span style="color:#d88200">&#34;a&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;b&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;c&#34;</span><span style="color:#111">}},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">{</span><span style="color:#75af00">input</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;a:b:c&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">sep</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;,&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">want</span><span style="color:#111">:</span> <span style="color:#111">[]</span><span style="color:#00a8c8">string</span><span style="color:#111">{</span><span style="color:#d88200">&#34;a:b:c&#34;</span><span style="color:#111">}},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">{</span><span style="color:#75af00">input</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;abcd&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">sep</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;bc&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">want</span><span style="color:#111">:</span> <span style="color:#111">[]</span><span style="color:#00a8c8">string</span><span style="color:#111">{</span><span style="color:#d88200">&#34;a&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;d&#34;</span><span style="color:#111">}},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">{</span><span style="color:#75af00">input</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;沙河有沙又有河&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">sep</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;沙&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">want</span><span style="color:#111">:</span> <span style="color:#111">[]</span><span style="color:#00a8c8">string</span><span style="color:#111">{</span><span style="color:#d88200">&#34;河有&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;又有河&#34;</span><span style="color:#111">}},</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 遍历切片，逐一执行测试用例</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">tc</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">tests</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">got</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">Split</span><span style="color:#111">(</span><span style="color:#75af00">tc</span><span style="color:#111">.</span><span style="color:#75af00">input</span><span style="color:#111">,</span> <span style="color:#75af00">tc</span><span style="color:#111">.</span><span style="color:#75af00">sep</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">reflect</span><span style="color:#111">.</span><span style="color:#75af00">DeepEqual</span><span style="color:#111">(</span><span style="color:#75af00">got</span><span style="color:#111">,</span> <span style="color:#75af00">tc</span><span style="color:#111">.</span><span style="color:#75af00">want</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;excepted:%v, got:%v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">tc</span><span style="color:#111">.</span><span style="color:#75af00">want</span><span style="color:#111">,</span> <span style="color:#75af00">got</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>我们通过上面的代码把多个测试用例合到一起，再次执行go test命令。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>split $ go <span style="color:#111">test</span> -v
</span></span><span style="display:flex;"><span><span style="color:#f92672">===</span> RUN   TestSplit
</span></span><span style="display:flex;"><span>--- FAIL: TestSplit <span style="color:#f92672">(</span>0.00s<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    split_test.go:42: excepted:<span style="color:#f92672">[</span>河有 又有河<span style="color:#f92672">]</span>, got:<span style="color:#f92672">[</span> 河有 又有河<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>FAIL
</span></span><span style="display:flex;"><span><span style="color:#111">exit</span> status <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>FAIL    test/split        0.006s
</span></span></code></pre></div><p>我们的测试出现了问题，仔细看打印的测试失败提示信息：excepted:[河有 又有河], got:[ 河有 又有河]，你会发现[ 河有 又有河]中有个不明显的空串，这种情况下十分推荐使用%#v的格式化方式。</p>
<p>我们修改下测试用例的格式化输出错误提示部分：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">TestSplit</span><span style="color:#111">(</span><span style="color:#75af00">t</span> <span style="color:#f92672">*</span><span style="color:#75af00">testing</span><span style="color:#111">.</span><span style="color:#75af00">T</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">tc</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">tests</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">got</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">Split</span><span style="color:#111">(</span><span style="color:#75af00">tc</span><span style="color:#111">.</span><span style="color:#75af00">input</span><span style="color:#111">,</span> <span style="color:#75af00">tc</span><span style="color:#111">.</span><span style="color:#75af00">sep</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">reflect</span><span style="color:#111">.</span><span style="color:#75af00">DeepEqual</span><span style="color:#111">(</span><span style="color:#75af00">got</span><span style="color:#111">,</span> <span style="color:#75af00">tc</span><span style="color:#111">.</span><span style="color:#75af00">want</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;excepted:%#v, got:%#v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">tc</span><span style="color:#111">.</span><span style="color:#75af00">want</span><span style="color:#111">,</span> <span style="color:#75af00">got</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>此时运行go test命令后就能看到比较明显的提示信息了：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>split $ go <span style="color:#111">test</span> -v
</span></span><span style="display:flex;"><span><span style="color:#f92672">===</span> RUN   TestSplit
</span></span><span style="display:flex;"><span>--- FAIL: TestSplit <span style="color:#f92672">(</span>0.00s<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    split_test.go:42: excepted:<span style="color:#f92672">[]</span>string<span style="color:#f92672">{</span><span style="color:#d88200">&#34;河有&#34;</span>, <span style="color:#d88200">&#34;又有河&#34;</span><span style="color:#f92672">}</span>, got:<span style="color:#f92672">[]</span>string<span style="color:#f92672">{</span><span style="color:#d88200">&#34;&#34;</span>, <span style="color:#d88200">&#34;河有&#34;</span>, <span style="color:#d88200">&#34;又有河&#34;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>FAIL
</span></span><span style="display:flex;"><span><span style="color:#111">exit</span> status <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>FAIL    test/split       0.006s
</span></span></code></pre></div><h3 id="子测试">子测试</h3>
<p>看起来都挺不错的，但是如果测试用例比较多的时候，我们是没办法一眼看出来具体是哪个测试用例失败了。我们可能会想到下面的解决办法：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>func TestSplit<span style="color:#f92672">(</span>t *testing.T<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">type</span> <span style="color:#111">test</span> struct <span style="color:#f92672">{</span> // 定义test结构体
</span></span><span style="display:flex;"><span>		input string
</span></span><span style="display:flex;"><span>		sep   string
</span></span><span style="display:flex;"><span>		want  <span style="color:#f92672">[]</span>string
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>	tests :<span style="color:#f92672">=</span> map<span style="color:#f92672">[</span>string<span style="color:#f92672">]</span>test<span style="color:#f92672">{</span> // 测试用例使用map存储
</span></span><span style="display:flex;"><span>		<span style="color:#d88200">&#34;simple&#34;</span>:      <span style="color:#f92672">{</span>input: <span style="color:#d88200">&#34;a:b:c&#34;</span>, sep: <span style="color:#d88200">&#34;:&#34;</span>, want: <span style="color:#f92672">[]</span>string<span style="color:#f92672">{</span><span style="color:#d88200">&#34;a&#34;</span>, <span style="color:#d88200">&#34;b&#34;</span>, <span style="color:#d88200">&#34;c&#34;</span><span style="color:#f92672">}}</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#d88200">&#34;wrong sep&#34;</span>:   <span style="color:#f92672">{</span>input: <span style="color:#d88200">&#34;a:b:c&#34;</span>, sep: <span style="color:#d88200">&#34;,&#34;</span>, want: <span style="color:#f92672">[]</span>string<span style="color:#f92672">{</span><span style="color:#d88200">&#34;a:b:c&#34;</span><span style="color:#f92672">}}</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#d88200">&#34;more sep&#34;</span>:    <span style="color:#f92672">{</span>input: <span style="color:#d88200">&#34;abcd&#34;</span>, sep: <span style="color:#d88200">&#34;bc&#34;</span>, want: <span style="color:#f92672">[]</span>string<span style="color:#f92672">{</span><span style="color:#d88200">&#34;a&#34;</span>, <span style="color:#d88200">&#34;d&#34;</span><span style="color:#f92672">}}</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#d88200">&#34;leading sep&#34;</span>: <span style="color:#f92672">{</span>input: <span style="color:#d88200">&#34;沙河有沙又有河&#34;</span>, sep: <span style="color:#d88200">&#34;沙&#34;</span>, want: <span style="color:#f92672">[]</span>string<span style="color:#f92672">{</span><span style="color:#d88200">&#34;河有&#34;</span>, <span style="color:#d88200">&#34;又有河&#34;</span><span style="color:#f92672">}}</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> name, tc :<span style="color:#f92672">=</span> range tests <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>		got :<span style="color:#f92672">=</span> Split<span style="color:#f92672">(</span>tc.input, tc.sep<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> !reflect.DeepEqual<span style="color:#f92672">(</span>got, tc.want<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>			t.Errorf<span style="color:#f92672">(</span><span style="color:#d88200">&#34;name:%s excepted:%#v, got:%#v&#34;</span>, name, tc.want, got<span style="color:#f92672">)</span> // 将测试用例的name格式化输出
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>上面的做法是能够解决问题的。同时Go1.7+中新增了子测试，我们可以按照如下方式使用t.Run执行子测试：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">TestSplit</span><span style="color:#111">(</span><span style="color:#75af00">t</span> <span style="color:#f92672">*</span><span style="color:#75af00">testing</span><span style="color:#111">.</span><span style="color:#75af00">T</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">type</span> <span style="color:#75af00">test</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span> <span style="color:#75715e">// 定义test结构体</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">input</span> <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">sep</span>   <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">want</span>  <span style="color:#111">[]</span><span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">tests</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#00a8c8">string</span><span style="color:#111">]</span><span style="color:#75af00">test</span><span style="color:#111">{</span> <span style="color:#75715e">// 测试用例使用map存储</span>
</span></span><span style="display:flex;"><span>		<span style="color:#d88200">&#34;simple&#34;</span><span style="color:#111">:</span>      <span style="color:#111">{</span><span style="color:#75af00">input</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;a:b:c&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">sep</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;:&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">want</span><span style="color:#111">:</span> <span style="color:#111">[]</span><span style="color:#00a8c8">string</span><span style="color:#111">{</span><span style="color:#d88200">&#34;a&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;b&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;c&#34;</span><span style="color:#111">}},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#d88200">&#34;wrong sep&#34;</span><span style="color:#111">:</span>   <span style="color:#111">{</span><span style="color:#75af00">input</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;a:b:c&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">sep</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;,&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">want</span><span style="color:#111">:</span> <span style="color:#111">[]</span><span style="color:#00a8c8">string</span><span style="color:#111">{</span><span style="color:#d88200">&#34;a:b:c&#34;</span><span style="color:#111">}},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#d88200">&#34;more sep&#34;</span><span style="color:#111">:</span>    <span style="color:#111">{</span><span style="color:#75af00">input</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;abcd&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">sep</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;bc&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">want</span><span style="color:#111">:</span> <span style="color:#111">[]</span><span style="color:#00a8c8">string</span><span style="color:#111">{</span><span style="color:#d88200">&#34;a&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;d&#34;</span><span style="color:#111">}},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#d88200">&#34;leading sep&#34;</span><span style="color:#111">:</span> <span style="color:#111">{</span><span style="color:#75af00">input</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;沙河有沙又有河&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">sep</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;沙&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">want</span><span style="color:#111">:</span> <span style="color:#111">[]</span><span style="color:#00a8c8">string</span><span style="color:#111">{</span><span style="color:#d88200">&#34;河有&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;又有河&#34;</span><span style="color:#111">}},</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">name</span><span style="color:#111">,</span> <span style="color:#75af00">tc</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">tests</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">Run</span><span style="color:#111">(</span><span style="color:#75af00">name</span><span style="color:#111">,</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">t</span> <span style="color:#f92672">*</span><span style="color:#75af00">testing</span><span style="color:#111">.</span><span style="color:#75af00">T</span><span style="color:#111">)</span> <span style="color:#111">{</span> <span style="color:#75715e">// 使用t.Run()执行子测试</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">got</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">Split</span><span style="color:#111">(</span><span style="color:#75af00">tc</span><span style="color:#111">.</span><span style="color:#75af00">input</span><span style="color:#111">,</span> <span style="color:#75af00">tc</span><span style="color:#111">.</span><span style="color:#75af00">sep</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">reflect</span><span style="color:#111">.</span><span style="color:#75af00">DeepEqual</span><span style="color:#111">(</span><span style="color:#75af00">got</span><span style="color:#111">,</span> <span style="color:#75af00">tc</span><span style="color:#111">.</span><span style="color:#75af00">want</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;excepted:%#v, got:%#v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">tc</span><span style="color:#111">.</span><span style="color:#75af00">want</span><span style="color:#111">,</span> <span style="color:#75af00">got</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>此时我们再执行go test命令就能够看到更清晰的输出内容了：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>split $ go <span style="color:#111">test</span> -v
</span></span><span style="display:flex;"><span><span style="color:#f92672">===</span> RUN   <span style="color:#111">TestSplit</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">===</span> RUN   TestSplit/leading_sep
</span></span><span style="display:flex;"><span><span style="color:#f92672">===</span> RUN   TestSplit/simple
</span></span><span style="display:flex;"><span><span style="color:#f92672">===</span> RUN   TestSplit/wrong_sep
</span></span><span style="display:flex;"><span><span style="color:#f92672">===</span> RUN   TestSplit/more_sep
</span></span><span style="display:flex;"><span>--- FAIL: TestSplit <span style="color:#f92672">(</span>0.00s<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    --- FAIL: TestSplit/leading_sep <span style="color:#f92672">(</span>0.00s<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        split_test.go:83: excepted:<span style="color:#f92672">[]</span>string<span style="color:#f92672">{</span><span style="color:#d88200">&#34;河有&#34;</span>, <span style="color:#d88200">&#34;又有河&#34;</span><span style="color:#f92672">}</span>, got:<span style="color:#f92672">[]</span>string<span style="color:#f92672">{</span><span style="color:#d88200">&#34;&#34;</span>, <span style="color:#d88200">&#34;河有&#34;</span>, <span style="color:#d88200">&#34;又有河&#34;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    --- PASS: TestSplit/simple <span style="color:#f92672">(</span>0.00s<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    --- PASS: TestSplit/wrong_sep <span style="color:#f92672">(</span>0.00s<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    --- PASS: TestSplit/more_sep <span style="color:#f92672">(</span>0.00s<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>FAIL
</span></span><span style="display:flex;"><span><span style="color:#111">exit</span> status <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>FAIL    test/split       0.006s
</span></span></code></pre></div><p>这个时候我们要把测试用例中的错误修改回来：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">TestSplit</span><span style="color:#111">(</span><span style="color:#75af00">t</span> <span style="color:#f92672">*</span><span style="color:#75af00">testing</span><span style="color:#111">.</span><span style="color:#75af00">T</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">tests</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#00a8c8">string</span><span style="color:#111">]</span><span style="color:#75af00">test</span><span style="color:#111">{</span> <span style="color:#75715e">// 测试用例使用map存储</span>
</span></span><span style="display:flex;"><span>		<span style="color:#d88200">&#34;simple&#34;</span><span style="color:#111">:</span>      <span style="color:#111">{</span><span style="color:#75af00">input</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;a:b:c&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">sep</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;:&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">want</span><span style="color:#111">:</span> <span style="color:#111">[]</span><span style="color:#00a8c8">string</span><span style="color:#111">{</span><span style="color:#d88200">&#34;a&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;b&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;c&#34;</span><span style="color:#111">}},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#d88200">&#34;wrong sep&#34;</span><span style="color:#111">:</span>   <span style="color:#111">{</span><span style="color:#75af00">input</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;a:b:c&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">sep</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;,&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">want</span><span style="color:#111">:</span> <span style="color:#111">[]</span><span style="color:#00a8c8">string</span><span style="color:#111">{</span><span style="color:#d88200">&#34;a:b:c&#34;</span><span style="color:#111">}},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#d88200">&#34;more sep&#34;</span><span style="color:#111">:</span>    <span style="color:#111">{</span><span style="color:#75af00">input</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;abcd&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">sep</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;bc&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">want</span><span style="color:#111">:</span> <span style="color:#111">[]</span><span style="color:#00a8c8">string</span><span style="color:#111">{</span><span style="color:#d88200">&#34;a&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;d&#34;</span><span style="color:#111">}},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#d88200">&#34;leading sep&#34;</span><span style="color:#111">:</span> <span style="color:#111">{</span><span style="color:#75af00">input</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;沙河有沙又有河&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">sep</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;沙&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">want</span><span style="color:#111">:</span> <span style="color:#111">[]</span><span style="color:#00a8c8">string</span><span style="color:#111">{</span><span style="color:#d88200">&#34;&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;河有&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;又有河&#34;</span><span style="color:#111">}},</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>我们都知道可以通过-run=RegExp来指定运行的测试用例，还可以通过/来指定要运行的子测试用例，例如：go test -v -run=Split/simple只会运行simple对应的子测试用例。</p>
<h3 id="测试覆盖率">测试覆盖率</h3>
<p>测试覆盖率是你的代码被测试套件覆盖的百分比。通常我们使用的都是语句的覆盖率，也就是在测试中至少被运行一次的代码占总代码的比例。</p>
<p>Go提供内置功能来检查你的代码覆盖率。我们可以使用go test -cover来查看测试覆盖率。例如：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>split $ go <span style="color:#111">test</span> -cover
</span></span><span style="display:flex;"><span>PASS
</span></span><span style="display:flex;"><span>coverage: 100.0% of statements
</span></span><span style="display:flex;"><span>ok      test/split       0.005s
</span></span></code></pre></div><p>从上面的结果可以看到我们的测试用例覆盖了100%的代码。</p>
<p>Go还提供了一个额外的-coverprofile参数，用来将覆盖率相关的记录信息输出到一个文件。例如：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>split $ go <span style="color:#111">test</span> -cover -coverprofile<span style="color:#f92672">=</span>c.out
</span></span><span style="display:flex;"><span>PASS
</span></span><span style="display:flex;"><span>coverage: 100.0% of statements
</span></span><span style="display:flex;"><span>ok      test/split        0.005s
</span></span></code></pre></div><p>上面的命令会将覆盖率相关的信息输出到当前文件夹下面的c.out文件中，然后我们执行go tool cover -html=c.out，使用cover工具来处理生成的记录信息，该命令会打开本地的浏览器窗口生成一个HTML报告。
<img src="/images/8ad6e6e1-9397-41e3-a5c2-9192040ed726.png" alt="">
上图中每个用绿色标记的语句块表示被覆盖了，而红色的表示没有被覆盖。</p>
<h2 id="基准测试">基准测试</h2>
<h3 id="基准测试函数格式">基准测试函数格式</h3>
<p>基准测试就是在一定的工作负载之下检测程序性能的一种方法。基准测试的基本格式如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">BenchmarkName</span><span style="color:#111">(</span><span style="color:#75af00">b</span> <span style="color:#f92672">*</span><span style="color:#75af00">testing</span><span style="color:#111">.</span><span style="color:#75af00">B</span><span style="color:#111">){</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ...</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>基准测试以Benchmark为前缀，需要一个*testing.B类型的参数b，基准测试必须要执行b.N次，这样的测试才有对照性，b.N的值是系统根据实际情况去调整的，从而保证测试的稳定性。testing.B拥有的方法如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">B</span><span style="color:#111">)</span> <span style="color:#75af00">Error</span><span style="color:#111">(</span><span style="color:#75af00">args</span> <span style="color:#f92672">...</span><span style="color:#00a8c8">interface</span><span style="color:#111">{})</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">B</span><span style="color:#111">)</span> <span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#75af00">format</span> <span style="color:#00a8c8">string</span><span style="color:#111">,</span> <span style="color:#75af00">args</span> <span style="color:#f92672">...</span><span style="color:#00a8c8">interface</span><span style="color:#111">{})</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">B</span><span style="color:#111">)</span> <span style="color:#75af00">Fail</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">B</span><span style="color:#111">)</span> <span style="color:#75af00">FailNow</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">B</span><span style="color:#111">)</span> <span style="color:#75af00">Failed</span><span style="color:#111">()</span> <span style="color:#00a8c8">bool</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">B</span><span style="color:#111">)</span> <span style="color:#75af00">Fatal</span><span style="color:#111">(</span><span style="color:#75af00">args</span> <span style="color:#f92672">...</span><span style="color:#00a8c8">interface</span><span style="color:#111">{})</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">B</span><span style="color:#111">)</span> <span style="color:#75af00">Fatalf</span><span style="color:#111">(</span><span style="color:#75af00">format</span> <span style="color:#00a8c8">string</span><span style="color:#111">,</span> <span style="color:#75af00">args</span> <span style="color:#f92672">...</span><span style="color:#00a8c8">interface</span><span style="color:#111">{})</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">B</span><span style="color:#111">)</span> <span style="color:#75af00">Log</span><span style="color:#111">(</span><span style="color:#75af00">args</span> <span style="color:#f92672">...</span><span style="color:#00a8c8">interface</span><span style="color:#111">{})</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">B</span><span style="color:#111">)</span> <span style="color:#75af00">Logf</span><span style="color:#111">(</span><span style="color:#75af00">format</span> <span style="color:#00a8c8">string</span><span style="color:#111">,</span> <span style="color:#75af00">args</span> <span style="color:#f92672">...</span><span style="color:#00a8c8">interface</span><span style="color:#111">{})</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">B</span><span style="color:#111">)</span> <span style="color:#75af00">Name</span><span style="color:#111">()</span> <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">b</span> <span style="color:#f92672">*</span><span style="color:#75af00">B</span><span style="color:#111">)</span> <span style="color:#75af00">ReportAllocs</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">b</span> <span style="color:#f92672">*</span><span style="color:#75af00">B</span><span style="color:#111">)</span> <span style="color:#75af00">ResetTimer</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">b</span> <span style="color:#f92672">*</span><span style="color:#75af00">B</span><span style="color:#111">)</span> <span style="color:#75af00">Run</span><span style="color:#111">(</span><span style="color:#75af00">name</span> <span style="color:#00a8c8">string</span><span style="color:#111">,</span> <span style="color:#75af00">f</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">b</span> <span style="color:#f92672">*</span><span style="color:#75af00">B</span><span style="color:#111">))</span> <span style="color:#00a8c8">bool</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">b</span> <span style="color:#f92672">*</span><span style="color:#75af00">B</span><span style="color:#111">)</span> <span style="color:#75af00">RunParallel</span><span style="color:#111">(</span><span style="color:#75af00">body</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">PB</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">b</span> <span style="color:#f92672">*</span><span style="color:#75af00">B</span><span style="color:#111">)</span> <span style="color:#75af00">SetBytes</span><span style="color:#111">(</span><span style="color:#75af00">n</span> <span style="color:#00a8c8">int64</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">b</span> <span style="color:#f92672">*</span><span style="color:#75af00">B</span><span style="color:#111">)</span> <span style="color:#75af00">SetParallelism</span><span style="color:#111">(</span><span style="color:#75af00">p</span> <span style="color:#00a8c8">int</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">B</span><span style="color:#111">)</span> <span style="color:#75af00">Skip</span><span style="color:#111">(</span><span style="color:#75af00">args</span> <span style="color:#f92672">...</span><span style="color:#00a8c8">interface</span><span style="color:#111">{})</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">B</span><span style="color:#111">)</span> <span style="color:#75af00">SkipNow</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">B</span><span style="color:#111">)</span> <span style="color:#75af00">Skipf</span><span style="color:#111">(</span><span style="color:#75af00">format</span> <span style="color:#00a8c8">string</span><span style="color:#111">,</span> <span style="color:#75af00">args</span> <span style="color:#f92672">...</span><span style="color:#00a8c8">interface</span><span style="color:#111">{})</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">B</span><span style="color:#111">)</span> <span style="color:#75af00">Skipped</span><span style="color:#111">()</span> <span style="color:#00a8c8">bool</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">b</span> <span style="color:#f92672">*</span><span style="color:#75af00">B</span><span style="color:#111">)</span> <span style="color:#75af00">StartTimer</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">b</span> <span style="color:#f92672">*</span><span style="color:#75af00">B</span><span style="color:#111">)</span> <span style="color:#75af00">StopTimer</span><span style="color:#111">()</span>
</span></span></code></pre></div><h3 id="基准测试示例">基准测试示例</h3>
<p>我们为split包中的Split函数编写基准测试如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">BenchmarkSplit</span><span style="color:#111">(</span><span style="color:#75af00">b</span> <span style="color:#f92672">*</span><span style="color:#75af00">testing</span><span style="color:#111">.</span><span style="color:#75af00">B</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span><span style="color:#111">;</span> <span style="color:#75af00">i</span> <span style="color:#111">&lt;</span> <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">N</span><span style="color:#111">;</span> <span style="color:#75af00">i</span><span style="color:#f92672">++</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">Split</span><span style="color:#111">(</span><span style="color:#d88200">&#34;沙河有沙又有河&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;沙&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>基准测试并不会默认执行，需要增加-bench参数，所以我们通过执行go test -bench=Split命令执行基准测试，输出结果如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>split $ go <span style="color:#111">test</span> -bench<span style="color:#f92672">=</span>Split
</span></span><span style="display:flex;"><span>goos: darwin
</span></span><span style="display:flex;"><span>goarch: amd64
</span></span><span style="display:flex;"><span>pkg: test/split 
</span></span><span style="display:flex;"><span>BenchmarkSplit-8        <span style="color:#ae81ff">10000000</span>               <span style="color:#ae81ff">203</span> ns/op
</span></span><span style="display:flex;"><span>PASS
</span></span><span style="display:flex;"><span>ok      test/split        2.255s
</span></span></code></pre></div><p>其中BenchmarkSplit-8表示对Split函数进行基准测试，数字8表示GOMAXPROCS的值，这个对于并发基准测试很重要。10000000和203ns/op表示每次调用Split函数耗时203ns，这个结果是10000000次调用的平均值。</p>
<p>我们还可以为基准测试添加-benchmem参数，来获得内存分配的统计数据。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>split $ go <span style="color:#111">test</span> -bench<span style="color:#f92672">=</span>Split -benchmem
</span></span><span style="display:flex;"><span>goos: darwin
</span></span><span style="display:flex;"><span>goarch: amd64
</span></span><span style="display:flex;"><span>pkg: test/split 
</span></span><span style="display:flex;"><span>BenchmarkSplit-8        <span style="color:#ae81ff">10000000</span>               <span style="color:#ae81ff">215</span> ns/op             <span style="color:#ae81ff">112</span> B/op          <span style="color:#ae81ff">3</span> allocs/op
</span></span><span style="display:flex;"><span>PASS
</span></span><span style="display:flex;"><span>ok      test/split        2.394s
</span></span></code></pre></div><p>其中，112 B/op表示每次操作内存分配了112字节，3 allocs/op则表示每次操作进行了3次内存分配。 我们将我们的Split函数优化如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">Split</span><span style="color:#111">(</span><span style="color:#75af00">s</span><span style="color:#111">,</span> <span style="color:#75af00">sep</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#75af00">result</span> <span style="color:#111">[]</span><span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">result</span> <span style="color:#111">=</span> <span style="color:#111">make</span><span style="color:#111">([]</span><span style="color:#00a8c8">string</span><span style="color:#111">,</span> <span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#75af00">strings</span><span style="color:#111">.</span><span style="color:#75af00">Count</span><span style="color:#111">(</span><span style="color:#75af00">s</span><span style="color:#111">,</span> <span style="color:#75af00">sep</span><span style="color:#111">)</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">i</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">strings</span><span style="color:#111">.</span><span style="color:#75af00">Index</span><span style="color:#111">(</span><span style="color:#75af00">s</span><span style="color:#111">,</span> <span style="color:#75af00">sep</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">i</span> <span style="color:#111">&gt;</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">result</span> <span style="color:#111">=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">result</span><span style="color:#111">,</span> <span style="color:#75af00">s</span><span style="color:#111">[:</span><span style="color:#75af00">i</span><span style="color:#111">])</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">s</span> <span style="color:#111">=</span> <span style="color:#75af00">s</span><span style="color:#111">[</span><span style="color:#75af00">i</span><span style="color:#f92672">+</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">sep</span><span style="color:#111">):]</span> <span style="color:#75715e">// 这里使用len(sep)获取sep的长度</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">i</span> <span style="color:#111">=</span> <span style="color:#75af00">strings</span><span style="color:#111">.</span><span style="color:#75af00">Index</span><span style="color:#111">(</span><span style="color:#75af00">s</span><span style="color:#111">,</span> <span style="color:#75af00">sep</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">result</span> <span style="color:#111">=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">result</span><span style="color:#111">,</span> <span style="color:#75af00">s</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>这一次我们提前使用make函数将result初始化为一个容量足够大的切片，而不再像之前一样通过调用append函数来追加。我们来看一下这个改进会带来多大的性能提升：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>split $ go <span style="color:#111">test</span> -bench<span style="color:#f92672">=</span>Split -benchmem
</span></span><span style="display:flex;"><span>goos: darwin
</span></span><span style="display:flex;"><span>goarch: amd64
</span></span><span style="display:flex;"><span>pkg: test/split 
</span></span><span style="display:flex;"><span>BenchmarkSplit-8        <span style="color:#ae81ff">10000000</span>               <span style="color:#ae81ff">127</span> ns/op              <span style="color:#ae81ff">48</span> B/op          <span style="color:#ae81ff">1</span> allocs/op
</span></span><span style="display:flex;"><span>PASS
</span></span><span style="display:flex;"><span>ok      test/split        1.423s
</span></span></code></pre></div><p>这个使用make函数提前分配内存的改动，减少了2/3的内存分配次数，并且减少了一半的内存分配。</p>
<h3 id="性能比较函数">性能比较函数</h3>
<p>上面的基准测试只能得到给定操作的绝对耗时，但是在很多性能问题是发生在两个不同操作之间的相对耗时，比如同一个函数处理1000个元素的耗时与处理1万甚至100万个元素的耗时的差别是多少？再或者对于同一个任务究竟使用哪种算法性能最佳？我们通常需要对两个不同算法的实现使用相同的输入来进行基准比较测试。</p>
<p>性能比较函数通常是一个带有参数的函数，被多个不同的Benchmark函数传入不同的值来调用。举个例子如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">benchmark</span><span style="color:#111">(</span><span style="color:#75af00">b</span> <span style="color:#f92672">*</span><span style="color:#75af00">testing</span><span style="color:#111">.</span><span style="color:#75af00">B</span><span style="color:#111">,</span> <span style="color:#75af00">size</span> <span style="color:#00a8c8">int</span><span style="color:#111">){</span><span style="color:#75715e">/* ... */</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">Benchmark10</span><span style="color:#111">(</span><span style="color:#75af00">b</span> <span style="color:#f92672">*</span><span style="color:#75af00">testing</span><span style="color:#111">.</span><span style="color:#75af00">B</span><span style="color:#111">){</span> <span style="color:#75af00">benchmark</span><span style="color:#111">(</span><span style="color:#75af00">b</span><span style="color:#111">,</span> <span style="color:#ae81ff">10</span><span style="color:#111">)</span> <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">Benchmark100</span><span style="color:#111">(</span><span style="color:#75af00">b</span> <span style="color:#f92672">*</span><span style="color:#75af00">testing</span><span style="color:#111">.</span><span style="color:#75af00">B</span><span style="color:#111">){</span> <span style="color:#75af00">benchmark</span><span style="color:#111">(</span><span style="color:#75af00">b</span><span style="color:#111">,</span> <span style="color:#ae81ff">100</span><span style="color:#111">)</span> <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">Benchmark1000</span><span style="color:#111">(</span><span style="color:#75af00">b</span> <span style="color:#f92672">*</span><span style="color:#75af00">testing</span><span style="color:#111">.</span><span style="color:#75af00">B</span><span style="color:#111">){</span> <span style="color:#75af00">benchmark</span><span style="color:#111">(</span><span style="color:#75af00">b</span><span style="color:#111">,</span> <span style="color:#ae81ff">1000</span><span style="color:#111">)</span> <span style="color:#111">}</span>
</span></span></code></pre></div><p>例如我们编写了一个计算斐波那契数列的函数如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// fib.go</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Fib 是一个计算第n个斐波那契数的函数</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">Fib</span><span style="color:#111">(</span><span style="color:#75af00">n</span> <span style="color:#00a8c8">int</span><span style="color:#111">)</span> <span style="color:#00a8c8">int</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">n</span> <span style="color:#111">&lt;</span> <span style="color:#ae81ff">2</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">n</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">Fib</span><span style="color:#111">(</span><span style="color:#75af00">n</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span> <span style="color:#f92672">+</span> <span style="color:#75af00">Fib</span><span style="color:#111">(</span><span style="color:#75af00">n</span><span style="color:#f92672">-</span><span style="color:#ae81ff">2</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>我们编写的性能比较函数如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// fib_test.go</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">benchmarkFib</span><span style="color:#111">(</span><span style="color:#75af00">b</span> <span style="color:#f92672">*</span><span style="color:#75af00">testing</span><span style="color:#111">.</span><span style="color:#75af00">B</span><span style="color:#111">,</span> <span style="color:#75af00">n</span> <span style="color:#00a8c8">int</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span><span style="color:#111">;</span> <span style="color:#75af00">i</span> <span style="color:#111">&lt;</span> <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">N</span><span style="color:#111">;</span> <span style="color:#75af00">i</span><span style="color:#f92672">++</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">Fib</span><span style="color:#111">(</span><span style="color:#75af00">n</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">BenchmarkFib1</span><span style="color:#111">(</span><span style="color:#75af00">b</span> <span style="color:#f92672">*</span><span style="color:#75af00">testing</span><span style="color:#111">.</span><span style="color:#75af00">B</span><span style="color:#111">)</span>  <span style="color:#111">{</span> <span style="color:#75af00">benchmarkFib</span><span style="color:#111">(</span><span style="color:#75af00">b</span><span style="color:#111">,</span> <span style="color:#ae81ff">1</span><span style="color:#111">)</span> <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">BenchmarkFib2</span><span style="color:#111">(</span><span style="color:#75af00">b</span> <span style="color:#f92672">*</span><span style="color:#75af00">testing</span><span style="color:#111">.</span><span style="color:#75af00">B</span><span style="color:#111">)</span>  <span style="color:#111">{</span> <span style="color:#75af00">benchmarkFib</span><span style="color:#111">(</span><span style="color:#75af00">b</span><span style="color:#111">,</span> <span style="color:#ae81ff">2</span><span style="color:#111">)</span> <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">BenchmarkFib3</span><span style="color:#111">(</span><span style="color:#75af00">b</span> <span style="color:#f92672">*</span><span style="color:#75af00">testing</span><span style="color:#111">.</span><span style="color:#75af00">B</span><span style="color:#111">)</span>  <span style="color:#111">{</span> <span style="color:#75af00">benchmarkFib</span><span style="color:#111">(</span><span style="color:#75af00">b</span><span style="color:#111">,</span> <span style="color:#ae81ff">3</span><span style="color:#111">)</span> <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">BenchmarkFib10</span><span style="color:#111">(</span><span style="color:#75af00">b</span> <span style="color:#f92672">*</span><span style="color:#75af00">testing</span><span style="color:#111">.</span><span style="color:#75af00">B</span><span style="color:#111">)</span> <span style="color:#111">{</span> <span style="color:#75af00">benchmarkFib</span><span style="color:#111">(</span><span style="color:#75af00">b</span><span style="color:#111">,</span> <span style="color:#ae81ff">10</span><span style="color:#111">)</span> <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">BenchmarkFib20</span><span style="color:#111">(</span><span style="color:#75af00">b</span> <span style="color:#f92672">*</span><span style="color:#75af00">testing</span><span style="color:#111">.</span><span style="color:#75af00">B</span><span style="color:#111">)</span> <span style="color:#111">{</span> <span style="color:#75af00">benchmarkFib</span><span style="color:#111">(</span><span style="color:#75af00">b</span><span style="color:#111">,</span> <span style="color:#ae81ff">20</span><span style="color:#111">)</span> <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">BenchmarkFib40</span><span style="color:#111">(</span><span style="color:#75af00">b</span> <span style="color:#f92672">*</span><span style="color:#75af00">testing</span><span style="color:#111">.</span><span style="color:#75af00">B</span><span style="color:#111">)</span> <span style="color:#111">{</span> <span style="color:#75af00">benchmarkFib</span><span style="color:#111">(</span><span style="color:#75af00">b</span><span style="color:#111">,</span> <span style="color:#ae81ff">40</span><span style="color:#111">)</span> <span style="color:#111">}</span>
</span></span></code></pre></div><p>运行基准测试：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>split $ go <span style="color:#111">test</span> -bench<span style="color:#f92672">=</span>.
</span></span><span style="display:flex;"><span>goos: darwin
</span></span><span style="display:flex;"><span>goarch: amd64
</span></span><span style="display:flex;"><span>pkg: test/fib
</span></span><span style="display:flex;"><span>BenchmarkFib1-8         <span style="color:#ae81ff">1000000000</span>               2.03 ns/op
</span></span><span style="display:flex;"><span>BenchmarkFib2-8         <span style="color:#ae81ff">300000000</span>                5.39 ns/op
</span></span><span style="display:flex;"><span>BenchmarkFib3-8         <span style="color:#ae81ff">200000000</span>                9.71 ns/op
</span></span><span style="display:flex;"><span>BenchmarkFib10-8         <span style="color:#ae81ff">5000000</span>               <span style="color:#ae81ff">325</span> ns/op
</span></span><span style="display:flex;"><span>BenchmarkFib20-8           <span style="color:#ae81ff">30000</span>             <span style="color:#ae81ff">42460</span> ns/op
</span></span><span style="display:flex;"><span>BenchmarkFib40-8               <span style="color:#ae81ff">2</span>         <span style="color:#ae81ff">638524980</span> ns/op
</span></span><span style="display:flex;"><span>PASS
</span></span><span style="display:flex;"><span>ok      test/fib 12.944s
</span></span></code></pre></div><p>这里需要注意的是，默认情况下，每个基准测试至少运行1秒。如果在Benchmark函数返回时没有到1秒，则b.N的值会按1,2,5,10,20,50，…增加，并且函数再次运行。</p>
<p>最终的BenchmarkFib40只运行了两次，每次运行的平均值只有不到一秒。像这种情况下我们应该可以使用-benchtime标志增加最小基准时间，以产生更准确的结果。例如：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>split $ go <span style="color:#111">test</span> -bench<span style="color:#f92672">=</span>Fib40 -benchtime<span style="color:#f92672">=</span>20s
</span></span><span style="display:flex;"><span>goos: darwin
</span></span><span style="display:flex;"><span>goarch: amd64
</span></span><span style="display:flex;"><span>pkg: test/fib
</span></span><span style="display:flex;"><span>BenchmarkFib40-8              <span style="color:#ae81ff">50</span>         <span style="color:#ae81ff">663205114</span> ns/op
</span></span><span style="display:flex;"><span>PASS
</span></span><span style="display:flex;"><span>ok      test/fib 33.849s
</span></span></code></pre></div><p>这一次BenchmarkFib40函数运行了50次，结果就会更准确一些了。</p>
<p>使用性能比较函数做测试的时候一个容易犯的错误就是把b.N作为输入的大小，例如以下两个例子都是错误的示范：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// 错误示范1</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">BenchmarkFibWrong</span><span style="color:#111">(</span><span style="color:#75af00">b</span> <span style="color:#f92672">*</span><span style="color:#75af00">testing</span><span style="color:#111">.</span><span style="color:#75af00">B</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">n</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span><span style="color:#111">;</span> <span style="color:#75af00">n</span> <span style="color:#111">&lt;</span> <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">N</span><span style="color:#111">;</span> <span style="color:#75af00">n</span><span style="color:#f92672">++</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">Fib</span><span style="color:#111">(</span><span style="color:#75af00">n</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 错误示范2</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">BenchmarkFibWrong2</span><span style="color:#111">(</span><span style="color:#75af00">b</span> <span style="color:#f92672">*</span><span style="color:#75af00">testing</span><span style="color:#111">.</span><span style="color:#75af00">B</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Fib</span><span style="color:#111">(</span><span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">N</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="重置时间">重置时间</h3>
<p>b.ResetTimer之前的处理不会放到执行时间里，也不会输出到报告中，所以可以在之前做一些不计划作为测试报告的操作。例如：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">BenchmarkSplit</span><span style="color:#111">(</span><span style="color:#75af00">b</span> <span style="color:#f92672">*</span><span style="color:#75af00">testing</span><span style="color:#111">.</span><span style="color:#75af00">B</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Sleep</span><span style="color:#111">(</span><span style="color:#ae81ff">5</span> <span style="color:#f92672">*</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Second</span><span style="color:#111">)</span> <span style="color:#75715e">// 假设需要做一些耗时的无关操作</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">ResetTimer</span><span style="color:#111">()</span>              <span style="color:#75715e">// 重置计时器</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span><span style="color:#111">;</span> <span style="color:#75af00">i</span> <span style="color:#111">&lt;</span> <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">N</span><span style="color:#111">;</span> <span style="color:#75af00">i</span><span style="color:#f92672">++</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">Split</span><span style="color:#111">(</span><span style="color:#d88200">&#34;沙河有沙又有河&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;沙&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="并行测试">并行测试</h3>
<p>func (b *B) RunParallel(body func(*PB))会以并行的方式执行给定的基准测试。</p>
<p>RunParallel会创建出多个goroutine，并将b.N分配给这些goroutine执行， 其中goroutine数量的默认值为GOMAXPROCS。用户如果想要增加非CPU受限（non-CPU-bound）基准测试的并行性， 那么可以在RunParallel之前调用SetParallelism。RunParallel通常会与-cpu标志一同使用。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">BenchmarkSplitParallel</span><span style="color:#111">(</span><span style="color:#75af00">b</span> <span style="color:#f92672">*</span><span style="color:#75af00">testing</span><span style="color:#111">.</span><span style="color:#75af00">B</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// b.SetParallelism(1) // 设置使用的CPU数</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">RunParallel</span><span style="color:#111">(</span><span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">pb</span> <span style="color:#f92672">*</span><span style="color:#75af00">testing</span><span style="color:#111">.</span><span style="color:#75af00">PB</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">for</span> <span style="color:#75af00">pb</span><span style="color:#111">.</span><span style="color:#75af00">Next</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">Split</span><span style="color:#111">(</span><span style="color:#d88200">&#34;沙河有沙又有河&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;沙&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>执行一下基准测试：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>split $ go <span style="color:#111">test</span> -bench<span style="color:#f92672">=</span>.
</span></span><span style="display:flex;"><span>goos: darwin
</span></span><span style="display:flex;"><span>goarch: amd64
</span></span><span style="display:flex;"><span>pkg: test/split 
</span></span><span style="display:flex;"><span>BenchmarkSplit-8                <span style="color:#ae81ff">10000000</span>               <span style="color:#ae81ff">131</span> ns/op
</span></span><span style="display:flex;"><span>BenchmarkSplitParallel-8        <span style="color:#ae81ff">50000000</span>                36.1 ns/op
</span></span><span style="display:flex;"><span>PASS
</span></span><span style="display:flex;"><span>ok      test/split        3.308s
</span></span></code></pre></div><p>还可以通过在测试命令后添加-cpu参数如go test -bench=. -cpu 1来指定使用的CPU数量。</p>
<h2 id="setup与teardown">Setup与TearDown</h2>
<p>测试程序有时需要在测试之前进行额外的设置（setup）或在测试之后进行拆卸（teardown）。</p>
<h3 id="testmain">TestMain</h3>
<p>通过在*_test.go文件中定义TestMain函数来可以在测试之前进行额外的设置（setup）或在测试之后进行拆卸（teardown）操作。</p>
<p>如果测试文件包含函数:func TestMain(m *testing.M)那么生成的测试会先调用 TestMain(m)，然后再运行具体测试。TestMain运行在主goroutine中, 可以在调用m.Run前后做任何设置（setup）和拆卸（teardown）。退出测试的时候应该使用m.Run的返回值作为参数调用os.Exit。</p>
<p>一个使用TestMain来设置Setup和TearDown的示例如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">TestMain</span><span style="color:#111">(</span><span style="color:#75af00">m</span> <span style="color:#f92672">*</span><span style="color:#75af00">testing</span><span style="color:#111">.</span><span style="color:#75af00">M</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;write setup code here...&#34;</span><span style="color:#111">)</span> <span style="color:#75715e">// 测试之前的做一些设置</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 如果 TestMain 使用了 flags，这里应该加上flag.Parse()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">retCode</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">Run</span><span style="color:#111">()</span>                         <span style="color:#75715e">// 执行测试</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;write teardown code here...&#34;</span><span style="color:#111">)</span> <span style="color:#75715e">// 测试之后做一些拆卸工作</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">Exit</span><span style="color:#111">(</span><span style="color:#75af00">retCode</span><span style="color:#111">)</span>                           <span style="color:#75715e">// 退出测试</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>需要注意的是：在调用TestMain时,flag.Parse并没有被调用。所以如果TestMain依赖于command-line标志 (包括 testing 包的标记), 则应该显示的调用flag.Parse。</p>
<h3 id="子测试的setup与teardown">子测试的Setup与Teardown</h3>
<p>有时候我们可能需要为每个测试集设置Setup与Teardown，也有可能需要为每个子测试设置Setup与Teardown。下面我们定义两个函数工具函数如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// 测试集的Setup与Teardown</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">setupTestCase</span><span style="color:#111">(</span><span style="color:#75af00">t</span> <span style="color:#f92672">*</span><span style="color:#75af00">testing</span><span style="color:#111">.</span><span style="color:#75af00">T</span><span style="color:#111">)</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">t</span> <span style="color:#f92672">*</span><span style="color:#75af00">testing</span><span style="color:#111">.</span><span style="color:#75af00">T</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">Log</span><span style="color:#111">(</span><span style="color:#d88200">&#34;如有需要在此执行:测试之前的setup&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">t</span> <span style="color:#f92672">*</span><span style="color:#75af00">testing</span><span style="color:#111">.</span><span style="color:#75af00">T</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">Log</span><span style="color:#111">(</span><span style="color:#d88200">&#34;如有需要在此执行:测试之后的teardown&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 子测试的Setup与Teardown</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">setupSubTest</span><span style="color:#111">(</span><span style="color:#75af00">t</span> <span style="color:#f92672">*</span><span style="color:#75af00">testing</span><span style="color:#111">.</span><span style="color:#75af00">T</span><span style="color:#111">)</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">t</span> <span style="color:#f92672">*</span><span style="color:#75af00">testing</span><span style="color:#111">.</span><span style="color:#75af00">T</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">Log</span><span style="color:#111">(</span><span style="color:#d88200">&#34;如有需要在此执行:子测试之前的setup&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">t</span> <span style="color:#f92672">*</span><span style="color:#75af00">testing</span><span style="color:#111">.</span><span style="color:#75af00">T</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">Log</span><span style="color:#111">(</span><span style="color:#d88200">&#34;如有需要在此执行:子测试之后的teardown&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>使用方式如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">TestSplit</span><span style="color:#111">(</span><span style="color:#75af00">t</span> <span style="color:#f92672">*</span><span style="color:#75af00">testing</span><span style="color:#111">.</span><span style="color:#75af00">T</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">type</span> <span style="color:#75af00">test</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span> <span style="color:#75715e">// 定义test结构体</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">input</span> <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">sep</span>   <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">want</span>  <span style="color:#111">[]</span><span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">tests</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#00a8c8">string</span><span style="color:#111">]</span><span style="color:#75af00">test</span><span style="color:#111">{</span> <span style="color:#75715e">// 测试用例使用map存储</span>
</span></span><span style="display:flex;"><span>		<span style="color:#d88200">&#34;simple&#34;</span><span style="color:#111">:</span>      <span style="color:#111">{</span><span style="color:#75af00">input</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;a:b:c&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">sep</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;:&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">want</span><span style="color:#111">:</span> <span style="color:#111">[]</span><span style="color:#00a8c8">string</span><span style="color:#111">{</span><span style="color:#d88200">&#34;a&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;b&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;c&#34;</span><span style="color:#111">}},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#d88200">&#34;wrong sep&#34;</span><span style="color:#111">:</span>   <span style="color:#111">{</span><span style="color:#75af00">input</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;a:b:c&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">sep</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;,&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">want</span><span style="color:#111">:</span> <span style="color:#111">[]</span><span style="color:#00a8c8">string</span><span style="color:#111">{</span><span style="color:#d88200">&#34;a:b:c&#34;</span><span style="color:#111">}},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#d88200">&#34;more sep&#34;</span><span style="color:#111">:</span>    <span style="color:#111">{</span><span style="color:#75af00">input</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;abcd&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">sep</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;bc&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">want</span><span style="color:#111">:</span> <span style="color:#111">[]</span><span style="color:#00a8c8">string</span><span style="color:#111">{</span><span style="color:#d88200">&#34;a&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;d&#34;</span><span style="color:#111">}},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#d88200">&#34;leading sep&#34;</span><span style="color:#111">:</span> <span style="color:#111">{</span><span style="color:#75af00">input</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;沙河有沙又有河&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">sep</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;沙&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">want</span><span style="color:#111">:</span> <span style="color:#111">[]</span><span style="color:#00a8c8">string</span><span style="color:#111">{</span><span style="color:#d88200">&#34;&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;河有&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;又有河&#34;</span><span style="color:#111">}},</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">teardownTestCase</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">setupTestCase</span><span style="color:#111">(</span><span style="color:#75af00">t</span><span style="color:#111">)</span> <span style="color:#75715e">// 测试之前执行setup操作</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">teardownTestCase</span><span style="color:#111">(</span><span style="color:#75af00">t</span><span style="color:#111">)</span>            <span style="color:#75715e">// 测试之后执行testdoen操作</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">name</span><span style="color:#111">,</span> <span style="color:#75af00">tc</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">tests</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">Run</span><span style="color:#111">(</span><span style="color:#75af00">name</span><span style="color:#111">,</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">t</span> <span style="color:#f92672">*</span><span style="color:#75af00">testing</span><span style="color:#111">.</span><span style="color:#75af00">T</span><span style="color:#111">)</span> <span style="color:#111">{</span> <span style="color:#75715e">// 使用t.Run()执行子测试</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">teardownSubTest</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">setupSubTest</span><span style="color:#111">(</span><span style="color:#75af00">t</span><span style="color:#111">)</span> <span style="color:#75715e">// 子测试之前执行setup操作</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">defer</span> <span style="color:#75af00">teardownSubTest</span><span style="color:#111">(</span><span style="color:#75af00">t</span><span style="color:#111">)</span>           <span style="color:#75715e">// 测试之后执行testdoen操作</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">got</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">Split</span><span style="color:#111">(</span><span style="color:#75af00">tc</span><span style="color:#111">.</span><span style="color:#75af00">input</span><span style="color:#111">,</span> <span style="color:#75af00">tc</span><span style="color:#111">.</span><span style="color:#75af00">sep</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">reflect</span><span style="color:#111">.</span><span style="color:#75af00">DeepEqual</span><span style="color:#111">(</span><span style="color:#75af00">got</span><span style="color:#111">,</span> <span style="color:#75af00">tc</span><span style="color:#111">.</span><span style="color:#75af00">want</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;excepted:%#v, got:%#v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">tc</span><span style="color:#111">.</span><span style="color:#75af00">want</span><span style="color:#111">,</span> <span style="color:#75af00">got</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>测试结果如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>split $ go <span style="color:#111">test</span> -v
</span></span><span style="display:flex;"><span><span style="color:#f92672">===</span> RUN   <span style="color:#111">TestSplit</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">===</span> RUN   TestSplit/simple
</span></span><span style="display:flex;"><span><span style="color:#f92672">===</span> RUN   TestSplit/wrong_sep
</span></span><span style="display:flex;"><span><span style="color:#f92672">===</span> RUN   TestSplit/more_sep
</span></span><span style="display:flex;"><span><span style="color:#f92672">===</span> RUN   TestSplit/leading_sep
</span></span><span style="display:flex;"><span>--- PASS: TestSplit <span style="color:#f92672">(</span>0.00s<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    split_test.go:71: 如有需要在此执行:测试之前的setup
</span></span><span style="display:flex;"><span>    --- PASS: TestSplit/simple <span style="color:#f92672">(</span>0.00s<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        split_test.go:79: 如有需要在此执行:子测试之前的setup
</span></span><span style="display:flex;"><span>        split_test.go:81: 如有需要在此执行:子测试之后的teardown
</span></span><span style="display:flex;"><span>    --- PASS: TestSplit/wrong_sep <span style="color:#f92672">(</span>0.00s<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        split_test.go:79: 如有需要在此执行:子测试之前的setup
</span></span><span style="display:flex;"><span>        split_test.go:81: 如有需要在此执行:子测试之后的teardown
</span></span><span style="display:flex;"><span>    --- PASS: TestSplit/more_sep <span style="color:#f92672">(</span>0.00s<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        split_test.go:79: 如有需要在此执行:子测试之前的setup
</span></span><span style="display:flex;"><span>        split_test.go:81: 如有需要在此执行:子测试之后的teardown
</span></span><span style="display:flex;"><span>    --- PASS: TestSplit/leading_sep <span style="color:#f92672">(</span>0.00s<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        split_test.go:79: 如有需要在此执行:子测试之前的setup
</span></span><span style="display:flex;"><span>        split_test.go:81: 如有需要在此执行:子测试之后的teardown
</span></span><span style="display:flex;"><span>    split_test.go:73: 如有需要在此执行:测试之后的teardown
</span></span><span style="display:flex;"><span><span style="color:#f92672">===</span> RUN   ExampleSplit
</span></span><span style="display:flex;"><span>--- PASS: ExampleSplit <span style="color:#f92672">(</span>0.00s<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>PASS
</span></span><span style="display:flex;"><span>ok      test/split        0.006s
</span></span></code></pre></div><h2 id="示例函数">示例函数</h2>
<h3 id="示例函数的格式">示例函数的格式</h3>
<p>被go test特殊对待的第三种函数就是示例函数，它们的函数名以Example为前缀。它们既没有参数也没有返回值。标准格式如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">ExampleName</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ...</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="示例函数示例">示例函数示例</h3>
<p>下面的代码是我们为Split函数编写的一个示例函数：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">ExampleSplit</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">split</span><span style="color:#111">.</span><span style="color:#75af00">Split</span><span style="color:#111">(</span><span style="color:#d88200">&#34;a:b:c&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;:&#34;</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">split</span><span style="color:#111">.</span><span style="color:#75af00">Split</span><span style="color:#111">(</span><span style="color:#d88200">&#34;沙河有沙又有河&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;沙&#34;</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Output:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// [a b c]</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// [ 河有 又有河]</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>为你的代码编写示例代码有如下三个用处：</p>
<ol>
<li>
<p>示例函数能够作为文档直接使用，例如基于web的godoc中能把示例函数与对应的函数或包相关联。</p>
</li>
<li>
<p>示例函数只要包含了// Output:也是可以通过go test运行的可执行测试。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>split $ go <span style="color:#111">test</span> -run Example
</span></span><span style="display:flex;"><span>PASS
</span></span><span style="display:flex;"><span>ok      test/split        0.006s
</span></span></code></pre></div></li>
<li>
<p>示例函数提供了可以直接运行的示例代码，可以直接在golang.org的godoc文档服务器上使用Go Playground运行示例代码。下图为strings.ToUpper函数在Playground的示例函数效果。![Go Playground]<img src="/Users/zhaohaiyu/img/877190903_1600072014345_9B81FBE536826F0B4110CAC9E05372C2.png" alt=""></p>
</li>
</ol>
<p>参考文章:</p>
<ul>
<li>《go语言圣经》</li>
<li><a href="https://www.liwenzhou.com/posts/Go/16_test/">https://www.liwenzhou.com/posts/Go/16_test/</a></li>
</ul>
]]></content:encoded><category>go</category><category>go</category></item><item><title>golang context包</title><link>https://daemon365.dev/post/go/golang_context_package/</link><pubDate>Fri, 28 Jun 2019 00:00:00 +0800</pubDate><guid>https://daemon365.dev/post/go/golang_context_package/</guid><description>&lt;h2 id="go-context标准库"&gt;go context标准库&lt;/h2&gt;
&lt;p&gt;context包在Go1.7版本时加入到标准库中。其设计目标是给Golang提供一个标准接口来给其他任务发送取消信号和传递数据。其具体作用为：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;可以通过context发送取消信号。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;可以指定截止时间（Deadline)，context在截止时间到期后自动发送取消信号。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;可以通过context传输一些数据。&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;context在Golang中最主要的用途是控制协程任务的取消&lt;/strong&gt;，但是context除了协程以外也可以用在线程控制等非协程的情况。&lt;/p&gt;
&lt;h2 id="基本概念"&gt;基本概念&lt;/h2&gt;
&lt;p&gt;context的核心是其定义的Context接口类型。围绕着Context接口类型存在两种角色：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;父任务：创建Context，将Context对象传递给子任务，并且根据需要发送取消信号来结束子任务。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;子任务：使用Context类型对象，当收到父任务发来的取消信号，结束当前任务并退出。&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;接下来我们从这两个角色的视角分别看一下Context对象。&lt;/p&gt;
&lt;h2 id="context接口"&gt;context接口&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-golang" data-lang="golang"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;type&lt;/span&gt; &lt;span style="color:#75af00"&gt;Context&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;interface&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt; &lt;span style="color:#75af00"&gt;Deadline&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;deadline&lt;/span&gt; &lt;span style="color:#75af00"&gt;time&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Time&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;ok&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;bool&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75af00"&gt;Done&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;chan&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;struct&lt;/span&gt;&lt;span style="color:#111"&gt;{}&lt;/span&gt; &lt;span style="color:#75af00"&gt;Err&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;error&lt;/span&gt; &lt;span style="color:#75af00"&gt;Value&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;key&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;interface&lt;/span&gt;&lt;span style="color:#111"&gt;{})&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;interface&lt;/span&gt;&lt;span style="color:#111"&gt;{}&lt;/span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;Deadline方法需要返回当前Context被取消的时间，也就是完成工作的截止时间（deadline）；&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Done方法需要返回一个Channel，这个Channel会在当前工作完成或者上下文被取消之后关闭，多次调用Done方***返回同一个Channel；&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Err方***返回当前Context结束的原因，它只会在Done返回的Channel被关闭时才会返回非空的值；&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;如果当前Context被取消就会返回Canceled错误；&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;如果当前Context超时就会返回DeadlineExceeded错误；&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Value方***从Context中返回键对应的值，对于同一个上下文来说，多次调用Value 并传入相同的Key会返回相同的结果，该方法仅用于传递跨API和进程间跟请求域的数据；&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="background和todo"&gt;Background()和TODO()&lt;/h2&gt;
&lt;p&gt;Go内置两个函数：Background()和TODO()，这两个函数分别返回一个实现了Context接口的background和todo。我们代码中最开始都是以这两个内置的上下文对象作为最顶层的partent context，衍生出更多的子上下文对象。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;Background()主要用于main函数、初始化以及测试代码中，作为Context这个树结构的最顶层的Context，也就是根Context。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;TODO()，它目前还不知道具体的使用场景，如果我们不知道该使用什么Context的时候，可以使用这个。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;background和todo本质上都是emptyCtx结构体类型，是一个不可取消，没有设置截止时间，没有携带任何值的Context。&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="with函数"&gt;With函数&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;WithCancel函数，传递一个父Context作为参数，返回子Context，以及一个取消函数用来取消Context&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;WithDeadline函数，和WithCancel差不多，它会多传递一个截止时间参数，意味着到了这个时间点，会自动取消Context，当然我们也可以不等到这个时候，可以提前通过取消函数进行取消&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;WithTimeout和WithDeadline基本上一样，这个表示是超时自动取消，是多少时间后自动取消Context的意思&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;WithValue函数和取消Context无关，它是为了生成一个绑定了一个键值对数据的Context，这个绑定的数据可以通过Context.Value方法访问到&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="context使用原则"&gt;Context使用原则&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;不要把Context放在结构体中，要以参数的方式进行传递&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;以Context作为参数的函数方法，应该把Context作为第一个参数，放在第一位]&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;给一个函数方法传递Context的时候，不要传递nil，如果不知道传递什么，就使用context.TODO&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Context的Value相关方法应该传递必须的数据，不要什么数据都使用这个传递&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;package&lt;/span&gt; &lt;span style="color:#75af00"&gt;main&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;import&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;context&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;fmt&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;time&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;main&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;server1&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;time&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Sleep&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;time&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Second&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;server1&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;ctx&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;cancel&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;context&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;WithTimeout&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;context&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Background&lt;/span&gt;&lt;span style="color:#111"&gt;(),&lt;/span&gt;&lt;span style="color:#75af00"&gt;time&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Millisecond&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;30&lt;/span&gt; &lt;span style="color:#111"&gt;)&lt;/span&gt;&lt;span style="color:#75715e"&gt;// 30毫秒后过期 &lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;defer&lt;/span&gt; &lt;span style="color:#75af00"&gt;cancel&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;ctx&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#75af00"&gt;context&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;WithValue&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;ctx&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;name&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;zhaohaiyu&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;for&lt;/span&gt; &lt;span style="color:#75af00"&gt;i&lt;/span&gt;&lt;span style="color:#f92672"&gt;:=&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;0&lt;/span&gt;&lt;span style="color:#111"&gt;;&lt;/span&gt;&lt;span style="color:#75af00"&gt;i&lt;/span&gt;&lt;span style="color:#111"&gt;&amp;lt;&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;100&lt;/span&gt;&lt;span style="color:#111"&gt;;&lt;/span&gt;&lt;span style="color:#75af00"&gt;i&lt;/span&gt;&lt;span style="color:#f92672"&gt;++&lt;/span&gt;&lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;time&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Sleep&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;time&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Millisecond&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;10&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;go&lt;/span&gt; &lt;span style="color:#75af00"&gt;server2&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;ctx&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;server2&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;ctx&lt;/span&gt; &lt;span style="color:#75af00"&gt;context&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Context&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;select&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;case&lt;/span&gt; &lt;span style="color:#75af00"&gt;ctx&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Done&lt;/span&gt;&lt;span style="color:#111"&gt;():&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;打断执行&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;default&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;name&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt;&lt;span style="color:#75af00"&gt;ok&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;ctx&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Value&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;name&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;).(&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;string&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#111"&gt;!&lt;/span&gt;&lt;span style="color:#75af00"&gt;ok&lt;/span&gt;&lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;没有取到&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;name=&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt;&lt;span style="color:#75af00"&gt;name&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id="请求作用域上下文"&gt;请求作用域上下文&lt;/h2&gt;
&lt;p&gt;在 Go 服务中，每个传入的请求都在其自己的goroutine 中处理。请求处理程序通常启动额外的 goroutine 来访问其他后端，如数据库和 RPC服务。处理请求的 goroutine 通常需要访问特定于请求(request-specific context)的值，例如最终用户的身份、授权令牌和请求的截止日期(deadline)。当一个请求被取消或超时时，处理该请求的所有 goroutine 都应该快速退出(fail fast)，这样系统就可以回收它们正在使用的任何资源。
Go 1.7 引入一个 context 包，它使得跨 API 边界的请求范围元数据、取消信号和截止日期很容易传递给处理请求所涉及的所有 goroutine(显示传递)。&lt;/p&gt;</description><content:encoded><![CDATA[<h2 id="go-context标准库">go context标准库</h2>
<p>context包在Go1.7版本时加入到标准库中。其设计目标是给Golang提供一个标准接口来给其他任务发送取消信号和传递数据。其具体作用为：</p>
<ul>
<li>
<p>可以通过context发送取消信号。</p>
</li>
<li>
<p>可以指定截止时间（Deadline)，context在截止时间到期后自动发送取消信号。</p>
</li>
<li>
<p>可以通过context传输一些数据。</p>
</li>
</ul>
<p><strong>context在Golang中最主要的用途是控制协程任务的取消</strong>，但是context除了协程以外也可以用在线程控制等非协程的情况。</p>
<h2 id="基本概念">基本概念</h2>
<p>context的核心是其定义的Context接口类型。围绕着Context接口类型存在两种角色：</p>
<ul>
<li>
<p>父任务：创建Context，将Context对象传递给子任务，并且根据需要发送取消信号来结束子任务。</p>
</li>
<li>
<p>子任务：使用Context类型对象，当收到父任务发来的取消信号，结束当前任务并退出。</p>
</li>
</ul>
<p>接下来我们从这两个角色的视角分别看一下Context对象。</p>
<h2 id="context接口">context接口</h2>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-golang" data-lang="golang"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Context</span> <span style="color:#00a8c8">interface</span> <span style="color:#111">{</span>  <span style="color:#75af00">Deadline</span><span style="color:#111">()</span> <span style="color:#111">(</span><span style="color:#75af00">deadline</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Time</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#00a8c8">bool</span><span style="color:#111">)</span>  <span style="color:#75af00">Done</span><span style="color:#111">()</span> <span style="color:#00a8c8">chan</span> <span style="color:#00a8c8">struct</span><span style="color:#111">{}</span>  <span style="color:#75af00">Err</span><span style="color:#111">()</span> <span style="color:#00a8c8">error</span>  <span style="color:#75af00">Value</span><span style="color:#111">(</span><span style="color:#75af00">key</span> <span style="color:#00a8c8">interface</span><span style="color:#111">{})</span> <span style="color:#00a8c8">interface</span><span style="color:#111">{}</span> <span style="color:#111">}</span>
</span></span></code></pre></div><ul>
<li>
<p>Deadline方法需要返回当前Context被取消的时间，也就是完成工作的截止时间（deadline）；</p>
</li>
<li>
<p>Done方法需要返回一个Channel，这个Channel会在当前工作完成或者上下文被取消之后关闭，多次调用Done方***返回同一个Channel；</p>
</li>
<li>
<p>Err方***返回当前Context结束的原因，它只会在Done返回的Channel被关闭时才会返回非空的值；</p>
<ul>
<li>
<p>如果当前Context被取消就会返回Canceled错误；</p>
</li>
<li>
<p>如果当前Context超时就会返回DeadlineExceeded错误；</p>
</li>
</ul>
</li>
<li>
<p>Value方***从Context中返回键对应的值，对于同一个上下文来说，多次调用Value 并传入相同的Key会返回相同的结果，该方法仅用于传递跨API和进程间跟请求域的数据；</p>
</li>
</ul>
<h2 id="background和todo">Background()和TODO()</h2>
<p>Go内置两个函数：Background()和TODO()，这两个函数分别返回一个实现了Context接口的background和todo。我们代码中最开始都是以这两个内置的上下文对象作为最顶层的partent context，衍生出更多的子上下文对象。</p>
<ul>
<li>
<p>Background()主要用于main函数、初始化以及测试代码中，作为Context这个树结构的最顶层的Context，也就是根Context。</p>
</li>
<li>
<p>TODO()，它目前还不知道具体的使用场景，如果我们不知道该使用什么Context的时候，可以使用这个。</p>
</li>
<li>
<p>background和todo本质上都是emptyCtx结构体类型，是一个不可取消，没有设置截止时间，没有携带任何值的Context。</p>
</li>
</ul>
<h2 id="with函数">With函数</h2>
<ul>
<li>
<p>WithCancel函数，传递一个父Context作为参数，返回子Context，以及一个取消函数用来取消Context</p>
</li>
<li>
<p>WithDeadline函数，和WithCancel差不多，它会多传递一个截止时间参数，意味着到了这个时间点，会自动取消Context，当然我们也可以不等到这个时候，可以提前通过取消函数进行取消</p>
</li>
<li>
<p>WithTimeout和WithDeadline基本上一样，这个表示是超时自动取消，是多少时间后自动取消Context的意思</p>
</li>
<li>
<p>WithValue函数和取消Context无关，它是为了生成一个绑定了一个键值对数据的Context，这个绑定的数据可以通过Context.Value方法访问到</p>
</li>
</ul>
<h2 id="context使用原则">Context使用原则</h2>
<ul>
<li>
<p>不要把Context放在结构体中，要以参数的方式进行传递</p>
</li>
<li>
<p>以Context作为参数的函数方法，应该把Context作为第一个参数，放在第一位]</p>
</li>
<li>
<p>给一个函数方法传递Context的时候，不要传递nil，如果不知道传递什么，就使用context.TODO</p>
</li>
<li>
<p>Context的Value相关方法应该传递必须的数据，不要什么数据都使用这个传递</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>  
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>  
</span></span><span style="display:flex;"><span>    <span style="color:#d88200">&#34;context&#34;</span>  
</span></span><span style="display:flex;"><span>    <span style="color:#d88200">&#34;fmt&#34;</span>  
</span></span><span style="display:flex;"><span>    <span style="color:#d88200">&#34;time&#34;</span> 
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>   
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>  
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">server1</span><span style="color:#111">()</span>  
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Sleep</span><span style="color:#111">(</span><span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Second</span><span style="color:#111">)</span> 
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>   
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">server1</span><span style="color:#111">()</span> <span style="color:#111">{</span>  
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">cancel</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">WithTimeout</span><span style="color:#111">(</span><span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Background</span><span style="color:#111">(),</span><span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Millisecond</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">30</span> <span style="color:#111">)</span><span style="color:#75715e">// 30毫秒后过期  </span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">defer</span> <span style="color:#75af00">cancel</span><span style="color:#111">()</span>  
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">ctx</span> <span style="color:#111">=</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">WithValue</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;name&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;zhaohaiyu&#34;</span><span style="color:#111">)</span>  
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">for</span> <span style="color:#75af00">i</span><span style="color:#f92672">:=</span><span style="color:#ae81ff">0</span><span style="color:#111">;</span><span style="color:#75af00">i</span><span style="color:#111">&lt;</span><span style="color:#ae81ff">100</span><span style="color:#111">;</span><span style="color:#75af00">i</span><span style="color:#f92672">++</span><span style="color:#111">{</span>   
</span></span><span style="display:flex;"><span>      <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Sleep</span><span style="color:#111">(</span><span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Millisecond</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">10</span><span style="color:#111">)</span>   
</span></span><span style="display:flex;"><span>      <span style="color:#00a8c8">go</span> <span style="color:#75af00">server2</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">)</span>  
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>  
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>  
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">server2</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#111">{</span>  
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">select</span> <span style="color:#111">{</span>  
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">case</span> <span style="color:#75af00">ctx</span><span style="color:#111">.</span><span style="color:#75af00">Done</span><span style="color:#111">():</span>   
</span></span><span style="display:flex;"><span>						<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;打断执行&#34;</span><span style="color:#111">)</span>   
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">return</span>  <span style="color:#00a8c8">default</span><span style="color:#111">:</span>   
</span></span><span style="display:flex;"><span>						<span style="color:#75af00">name</span><span style="color:#111">,</span><span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">ctx</span><span style="color:#111">.</span><span style="color:#75af00">Value</span><span style="color:#111">(</span><span style="color:#d88200">&#34;name&#34;</span><span style="color:#111">).(</span><span style="color:#00a8c8">string</span><span style="color:#111">)</span>   
</span></span><span style="display:flex;"><span>						<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">ok</span><span style="color:#111">{</span>    
</span></span><span style="display:flex;"><span>								<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;没有取到&#34;</span><span style="color:#111">)</span>    
</span></span><span style="display:flex;"><span>								<span style="color:#00a8c8">return</span>   
</span></span><span style="display:flex;"><span>						<span style="color:#111">}</span>   
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;name=&#34;</span><span style="color:#111">,</span><span style="color:#75af00">name</span><span style="color:#111">)</span>  
</span></span><span style="display:flex;"><span>				<span style="color:#111">}</span> 
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="请求作用域上下文">请求作用域上下文</h2>
<p>在 Go 服务中，每个传入的请求都在其自己的goroutine 中处理。请求处理程序通常启动额外的 goroutine 来访问其他后端，如数据库和 RPC服务。处理请求的 goroutine 通常需要访问特定于请求(request-specific context)的值，例如最终用户的身份、授权令牌和请求的截止日期(deadline)。当一个请求被取消或超时时，处理该请求的所有 goroutine 都应该快速退出(fail fast)，这样系统就可以回收它们正在使用的任何资源。
Go 1.7 引入一个 context 包，它使得跨 API 边界的请求范围元数据、取消信号和截止日期很容易传递给处理请求所涉及的所有 goroutine(显示传递)。</p>
<p><strong>其他语言: Thread Local Storage(TLS)，XXXContext</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Context</span> <span style="color:#00a8c8">interface</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Deadline returns the time when work done on behalf of this context</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// should be canceled. Deadline returns ok==false when no deadline is</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// set. Successive calls to Deadline return the same results.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Deadline</span><span style="color:#111">()</span> <span style="color:#111">(</span><span style="color:#75af00">deadline</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Time</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#00a8c8">bool</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Done returns a channel that&#39;s closed when work done on behalf of this</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// context should be canceled. Done may return nil if this context can</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// never be canceled. Successive calls to Done return the same value.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// The close of the Done channel may happen asynchronously,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// after the cancel function returns.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	// WithCancel arranges for Done to be closed when cancel is called;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// WithDeadline arranges for Done to be closed when the deadline</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// expires; WithTimeout arranges for Done to be closed when the timeout</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// elapses.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	// Done is provided for use in select statements:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	//  // Stream generates values with DoSomething and sends them to out</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//  // until DoSomething returns an error or ctx.Done is closed.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//  func Stream(ctx context.Context, out chan&lt;- Value) error {</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//  	for {</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//  		v, err := DoSomething(ctx)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//  		if err != nil {</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//  			return err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//  		}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//  		select {</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//  		case &lt;-ctx.Done():</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//  			return ctx.Err()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//  		case out &lt;- v:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//  		}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//  	}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//  }</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	// See https://blog.golang.org/pipelines for more examples of how to use</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// a Done channel for cancellation.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Done</span><span style="color:#111">()</span> <span style="color:#f92672">&lt;-</span><span style="color:#00a8c8">chan</span> <span style="color:#00a8c8">struct</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// If Done is not yet closed, Err returns nil.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// If Done is closed, Err returns a non-nil error explaining why:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Canceled if the context was canceled</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// or DeadlineExceeded if the context&#39;s deadline passed.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// After Err returns a non-nil error, successive calls to Err return the same error.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Err</span><span style="color:#111">()</span> <span style="color:#00a8c8">error</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Value returns the value associated with this context for key, or nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// if no value is associated with key. Successive calls to Value with</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// the same key returns the same result.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	// Use context values only for request-scoped data that transits</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// processes and API boundaries, not for passing optional parameters to</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// functions.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	// A key identifies a specific value in a Context. Functions that wish</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// to store values in Context typically allocate a key in a global</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// variable then use that key as the argument to context.WithValue and</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Context.Value. A key can be any type that supports equality;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// packages should define keys as an unexported type to avoid</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// collisions.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	// Packages that define a Context key should provide type-safe accessors</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// for the values stored using that key:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	// 	// Package user defines a User type that&#39;s stored in Contexts.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 	package user</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	// 	import &#34;context&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	// 	// User is the type of value stored in the Contexts.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 	type User struct {...}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	// 	// key is an unexported type for keys defined in this package.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 	// This prevents collisions with keys defined in other packages.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 	type key int</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	// 	// userKey is the key for user.User values in Contexts. It is</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 	// unexported; clients use user.NewContext and user.FromContext</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 	// instead of using this key directly.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 	var userKey key</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	// 	// NewContext returns a new Context that carries value u.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 	func NewContext(ctx context.Context, u *User) context.Context {</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 		return context.WithValue(ctx, userKey, u)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 	}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	// 	// FromContext returns the User value stored in ctx, if any.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 	func FromContext(ctx context.Context) (*User, bool) {</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 		u, ok := ctx.Value(userKey).(*User)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 		return u, ok</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 	}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Value</span><span style="color:#111">(</span><span style="color:#75af00">key</span> <span style="color:#00a8c8">interface</span><span style="color:#111">{})</span> <span style="color:#00a8c8">interface</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#00a8c8">func</span> <span style="color:#75af00">IsAdminUser</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>         <span style="color:#75af00">x</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">token</span><span style="color:#111">.</span><span style="color:#75af00">GetToken</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>         <span style="color:#75af00">userObject</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">auth</span><span style="color:#111">.</span><span style="color:#75af00">AuthenticateToken</span><span style="color:#111">(</span><span style="color:#75af00">x</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>         <span style="color:#00a8c8">return</span> <span style="color:#75af00">userObject</span><span style="color:#111">.</span><span style="color:#75af00">IsAdmin</span> <span style="color:#f92672">||</span> <span style="color:#75af00">userObject</span><span style="color:#111">.</span><span style="color:#75af00">IsRoot</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span> <span style="color:#111">}</span>
</span></span></code></pre></div><p>如何将 context 集成到 API 中？
在将 context 集成到 API 中时，要记住的最重要的一点是，它的作用域是请求级别	的。例如，沿单个数据库查询存在是有意义的，但沿数据库对象存在则没有意义。
目前有两种方法可以将 context 对象集成到 API 中：</p>
<ul>
<li>
<p>The first parameter of a function call</p>
<p>​	首参数传递 context 对象，比如，参考  net 包 Dialer.DialContext。此函数执行正常的 Dial 操作，但可以通过 context 对象取消函数调用。</p>
<p><code>func (d *Dialer) DialContext(ctx context.Context,network,address string) (Conn,error)</code></p>
</li>
<li>
<p>Optional config on a request structure
在第一个 request 对象中携带一个可选的 context 对象。例如 net/http 库的 Request.WithContext，通过携带给定的 context 对象，返回一个新的 Request 对象。</p>
<p><code>func (r *Request) WithContext(ctx context.Context) *Request</code></p>
</li>
</ul>
<p><img src="/images/84cdba12-ce31-4bee-a624-8a579f3b6d57.png" alt=""></p>
<h3 id="不要在stuct类型中存储上下文">不要在stuct类型中存储上下文</h3>
<p>不要在结构题类型中存储上下文；相反，应该显式地将上下文传递给每个需要它的函数。上下文应该是第一个参数，通常命名为ctx:</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  <span style="color:#00a8c8">func</span> <span style="color:#75af00">DoSomething</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">,</span><span style="color:#75af00">arg</span> <span style="color:#75af00">Arg</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>          <span style="color:#75715e">// .. use ctx</span>
</span></span><span style="display:flex;"><span>  <span style="color:#111">}</span>
</span></span></code></pre></div><p>对服务器的传入请求应创建上下文。
使用 context 的一个很好的心智模型是它应该在程序中流动，应该贯穿你的代码。这通常意味着您不希望将其存储在结构体之中。它从一个函数传递到另一个函数，并根据需要进行扩展。理想情况下，每个请求都会创建一个 context 对象，并在请求结束时过期。
不存储上下文的一个例外是，当您需要将它放入一个结构中时，该结构纯粹用作通过通道传递的消息。如下例所示。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">message</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">responseChan</span> <span style="color:#00a8c8">chan</span><span style="color:#f92672">&lt;-</span> <span style="color:#00a8c8">int</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">parameter</span> <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">ctx</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Context</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="contextwithvalue">context.WithValue</h2>
<p>比如我们新建了一个基于 context.Background() 的 ctx1，携带了一个 map 的数据，map 中包含了 “k1”: “v1” 的一个键值对，ctx1 被两个 goroutine 同时使用作为函数签名传入，如果我们修改了 这个map，会导致另外进行读 context.Value 的 goroutine 和修改 map 的 goroutine，在 map 对象上产生 data race。因此我们要使用 copy-on-write 的思路，解决跨多个 goroutine 使用数据、修改数据的场景。</p>
<p><img src="/images/ba882718-fb1a-49f6-ac33-08f2bd536252.png" alt=""></p>
<p>context.WithValue 内部基于 valueCtx 实现:</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">valueCtx</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">Context</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">key</span><span style="color:#111">,</span><span style="color:#75af00">val</span> <span style="color:#00a8c8">interface</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>为了实现不断的 WithValue，构建新的 context，内部在查找 key 时候，使用递归方式不断从当前，从父节点寻找匹配的 key，直到 root context(Backgrond 和 TODO Value 函数会返回 nil)。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">valueCtx</span><span style="color:#111">)</span> <span style="color:#75af00">Value</span><span style="color:#111">(</span><span style="color:#75af00">key</span> <span style="color:#00a8c8">interface</span><span style="color:#111">{}(</span> <span style="color:#00a8c8">interface</span><span style="color:#111">{}</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">key</span> <span style="color:#f92672">==</span> <span style="color:#75af00">key</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#00a8c8">return</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">val</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">.</span><span style="color:#75af00">Value</span><span style="color:#111">(</span><span style="color:#75af00">key</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p><img src="/images/4428bf8f-7a2d-4648-bac1-6b57ae3b11c8.png" alt=""></p>
<h2 id="调试或跟踪数据在上下文中传递是安全的">调试或跟踪数据在上下文中传递是安全的</h2>
<p>context.WithValue 方法允许上下文携带请求范围的数据。这些数据必须是安全的，以便多个 goroutine 同时使用。这里的数据，更多是面向请求的元数据，不应该作为函数的可选参数来使用(比如 context 里面挂了一个sql.Tx 对象，传递到 Dao 层使用)，因为元数据相对函数参数更加是隐含的，面向请求的。而参数是更加显示的。</p>
<ul>
<li>同一个 context 对象可以传递给在不同 goroutine 中运行的函数；上下文对于多个 goroutine 同时使用是安全的。对于值类型最容易犯错的地方，在于 context value 应该是 immutable 的，每次重新赋值应该是新的 context，即: context.WithValue(ctx, oldvalue)</li>
</ul>
<p><a href="https://pkg.go.dev/google.golang.org/grpc/metadata">https://pkg.go.dev/google.golang.org/grpc/metadata</a>
Context.Value should inform, not control</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">WithValue</span><span style="color:#111">(</span><span style="color:#75af00">parent</span> <span style="color:#75af00">Context</span><span style="color:#111">,</span><span style="color:#75af00">key</span> <span style="color:#75af00">val</span> <span style="color:#00a8c8">interface</span><span style="color:#111">{})</span> <span style="color:#75af00">Context</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">parent</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#d88200">&#34;connot creat context from nil parent&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">key</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#d88200">&#34;nil key&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">reflectlite</span><span style="color:#111">.</span><span style="color:#75af00">Typeof</span><span style="color:#111">(</span><span style="color:#75af00">key</span><span style="color:#111">).</span><span style="color:#75af00">Comparable</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#d88200">&#34;key is not comparable&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">valueCtx</span><span style="color:#111">{</span><span style="color:#75af00">parent</span><span style="color:#111">,</span><span style="color:#75af00">key</span><span style="color:#111">,</span><span style="color:#75af00">val</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">valueCtx</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Context</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">key</span><span style="color:#111">,</span><span style="color:#75af00">val</span> <span style="color:#00a8c8">interface</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>用于传递作用域的参数的可选api和用于传递作用域的参数的可选api。比如 染色，API 重要性，Trace</p>
<p>比如我们新建了一个基于 context.Background() 的 ctx1，携带了一个 map 的数据，map 中包含了 “k1”: “v1” 的一个键值对，ctx1 被两个 goroutine 同时使用作为函数签名传入，如果我们修改了 这个map，会导致另外进行读 context.Value 的 goroutine 和修改 map 的 goroutine，在 map 对象上产生 data race。因此我们要使用 copy-on-write 的思路，解决跨多个 goroutine 使用数据、修改数据的场景。</p>
<p><img src="/images/65975244-2584-457b-a766-9bcee97ed59d.png" alt=""></p>
<p>COW: 从 ctx1 中获取 map1(可以理解为 v1 版本的 map 数据)。构建一个新的 map 对象 map2，复制所有 map1 数据，同时追加新的数据 “k2”: “v2” 键值对，使用 context.WithValue 创建新的 ctx2，ctx2 会传递到其他的 goroutine 中。这样各自读取的副本都是自己的数据，写行为追加的数据，在 ctx2 中也能完整读取到，同时也不会污染 ctx1 中的数据。</p>
<p><img src="/images/f173fee2-4037-43aa-91a7-fa0a70cd1210.png" alt=""></p>
<p><strong>当上下文被取消时，从它派生的所有上下文也被取消</strong></p>
<p>当一个 context 被取消时，从它派生的所有 context 也将被取消。WithCancel(ctx) 参数 ctx 认为是 parent ctx，在内部会进行一个传播关系链的关联。Done() 返回 一个 chan，当我们取消某个parent context, 实际上上会递归层层 cancel 掉自己的 child context 的 done chan 从而让整个调用链中所有监听 cancel 的 goroutine退出。</p>
<p><img src="/images/23ab1c43-739f-42cf-bc72-5605ee9318a1.png" alt=""></p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;context&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">gen</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#f92672">&lt;-</span><span style="color:#00a8c8">chan</span> <span style="color:#00a8c8">int</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">dst</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">chan</span> <span style="color:#00a8c8">int</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">n</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">go</span> <span style="color:#00a8c8">func</span><span style="color:#111">(){</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">for</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">select</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">case</span> <span style="color:#f92672">&lt;-</span> <span style="color:#75af00">ctx</span><span style="color:#111">.</span><span style="color:#75af00">Done</span><span style="color:#111">():</span>
</span></span><span style="display:flex;"><span>					<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">case</span> <span style="color:#75af00">dst</span> <span style="color:#f92672">&lt;-</span> <span style="color:#75af00">n</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">n</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>				<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">dst</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ctx</span><span style="color:#111">,</span><span style="color:#75af00">cancel</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">WithCancel</span><span style="color:#111">(</span><span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Backgroup</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">n</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">gen</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">n</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">n</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">5</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">break</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span></code></pre></div><p><strong>所有阻塞/长操作都应可取消</strong></p>
<p>如果要实现一个超时控制，通过上面的context 的parent/child 机制，其实我们只需要启动一个定时器，然后在超时的时候，直接将当前的 context 给 cancel 掉，就可以实现监听在当前和下层的额context.Done() 的 goroutine 的退出。</p>
<p><img src="/images/9321cf21-0197-4903-ad91-f4cb823d3966.png" alt=""></p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;context&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">const</span> <span style="color:#75af00">shortDuration</span> <span style="color:#111">=</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Millisecond</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">d</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Now</span><span style="color:#111">().</span><span style="color:#75af00">Add</span><span style="color:#111">(</span><span style="color:#75af00">shortDuration</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ctx</span><span style="color:#111">,</span><span style="color:#75af00">cancel</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">WithDeadline</span><span style="color:#111">(</span><span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Backgroup</span><span style="color:#111">(),</span><span style="color:#75af00">d</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">canel</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">select</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">After</span><span style="color:#111">(</span><span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Second</span><span style="color:#111">):</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;overslept&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">case</span> <span style="color:#f92672">&lt;-</span> <span style="color:#75af00">ctx</span><span style="color:#111">.</span><span style="color:#75af00">Done</span><span style="color:#111">():</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">.</span><span style="color:#75af00">Err</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div>]]></content:encoded><category>go</category><category>go</category></item><item><title>golang channel</title><link>https://daemon365.dev/post/go/golang_channel/</link><pubDate>Wed, 26 Jun 2019 00:00:00 +0800</pubDate><guid>https://daemon365.dev/post/go/golang_channel/</guid><description>&lt;h2 id="什么是channel"&gt;什么是channel&lt;/h2&gt;
&lt;p&gt;channels 是一种类型安全的消息队列，充当两个 goroutine 之间的管道，将通过它同步的进行任意资源的交换。chan 控制 goroutines 交互的能力从而创建了 Go 同步机制。当创建的 chan 没有容量时，称为无缓冲通道。反过来，使用容量创建的 chan 称为缓冲通道。&lt;/p&gt;
&lt;p&gt;要了解通过 chan 交互的 goroutine 的同步行为是什么，我们需要知道通道的类型和状态。根据我们使用的是无缓冲通道还是缓冲通道，场景会有所不同，所以让我们单独讨论每个场景。&lt;/p&gt;
&lt;h2 id="无缓冲管道"&gt;无缓冲管道&lt;/h2&gt;
&lt;p&gt;make ： &lt;code&gt;ch := make(chan struct{})&lt;/code&gt;
无缓冲 chan 没有容量，因此进行任何交换前需要两个 goroutine 同时准备好。当 goroutine 试图将一个资源发送到一个无缓冲的通道并且没有goroutine 等待接收该资源时，该通道将锁住发送 goroutine 并使其等待。当 goroutine 尝试从无缓冲通道接收，并且没有 goroutine 等待发送资源时，该通道将锁住接收 goroutine 并使其等待。&lt;/p&gt;
&lt;p&gt;无缓冲信道的本质是保证同步。&lt;/p&gt;
&lt;p&gt;&lt;img src="https://daemon365.dev/images/3f53ded4-19e7-43d2-981b-a44bf8a04de8.png" alt=""&gt;&lt;/p&gt;
&lt;p&gt;无缓冲channel在消息发送时需要接收者就绪。声明无缓冲channel的方式是不指定缓冲大小。以下是一个列子：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;package&lt;/span&gt; &lt;span style="color:#75af00"&gt;main&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;import&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;sync&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;time&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;main&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;c&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#111"&gt;make&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;chan&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;string&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;var&lt;/span&gt; &lt;span style="color:#75af00"&gt;wg&lt;/span&gt; &lt;span style="color:#75af00"&gt;sync&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;WaitGroup&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;wg&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Add&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;2&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;go&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;func&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;defer&lt;/span&gt; &lt;span style="color:#75af00"&gt;wg&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Done&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;c&lt;/span&gt; &lt;span style="color:#f92672"&gt;&amp;lt;-&lt;/span&gt; &lt;span style="color:#d88200"&gt;`foo`&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;go&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;func&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;defer&lt;/span&gt; &lt;span style="color:#75af00"&gt;wg&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Done&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;time&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Sleep&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;time&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Second&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;1&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;`Message: `&lt;/span&gt;&lt;span style="color:#f92672"&gt;+&lt;/span&gt; &lt;span style="color:#f92672"&gt;&amp;lt;-&lt;/span&gt;&lt;span style="color:#75af00"&gt;c&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;wg&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Wait&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;第一个协程会在发送消息&lt;code&gt;foo&lt;/code&gt;时阻塞，原因是接收者还没有就绪：这个特性在&lt;a href="https://golang.org/ref/spec?source=post_page---------------------------#Channel_types"&gt;标准文档&lt;/a&gt;中描述如下：&lt;/p&gt;</description><content:encoded><![CDATA[<h2 id="什么是channel">什么是channel</h2>
<p>channels 是一种类型安全的消息队列，充当两个 goroutine 之间的管道，将通过它同步的进行任意资源的交换。chan 控制 goroutines 交互的能力从而创建了 Go 同步机制。当创建的 chan 没有容量时，称为无缓冲通道。反过来，使用容量创建的 chan 称为缓冲通道。</p>
<p>要了解通过 chan 交互的 goroutine 的同步行为是什么，我们需要知道通道的类型和状态。根据我们使用的是无缓冲通道还是缓冲通道，场景会有所不同，所以让我们单独讨论每个场景。</p>
<h2 id="无缓冲管道">无缓冲管道</h2>
<p>make ： <code>ch := make(chan struct{})</code>
无缓冲 chan 没有容量，因此进行任何交换前需要两个 goroutine 同时准备好。当 goroutine 试图将一个资源发送到一个无缓冲的通道并且没有goroutine 等待接收该资源时，该通道将锁住发送 goroutine 并使其等待。当 goroutine 尝试从无缓冲通道接收，并且没有 goroutine 等待发送资源时，该通道将锁住接收 goroutine 并使其等待。</p>
<p>无缓冲信道的本质是保证同步。</p>
<p><img src="/images/3f53ded4-19e7-43d2-981b-a44bf8a04de8.png" alt=""></p>
<p>无缓冲channel在消息发送时需要接收者就绪。声明无缓冲channel的方式是不指定缓冲大小。以下是一个列子：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;sync&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">c</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">chan</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">var</span> <span style="color:#75af00">wg</span> <span style="color:#75af00">sync</span><span style="color:#111">.</span><span style="color:#75af00">WaitGroup</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">wg</span><span style="color:#111">.</span><span style="color:#75af00">Add</span><span style="color:#111">(</span><span style="color:#ae81ff">2</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">go</span> <span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">defer</span> <span style="color:#75af00">wg</span><span style="color:#111">.</span><span style="color:#75af00">Done</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">c</span> <span style="color:#f92672">&lt;-</span> <span style="color:#d88200">`foo`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">go</span> <span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">defer</span> <span style="color:#75af00">wg</span><span style="color:#111">.</span><span style="color:#75af00">Done</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Sleep</span><span style="color:#111">(</span><span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Second</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">1</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">println</span><span style="color:#111">(</span><span style="color:#d88200">`Message: `</span><span style="color:#f92672">+</span> <span style="color:#f92672">&lt;-</span><span style="color:#75af00">c</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">wg</span><span style="color:#111">.</span><span style="color:#75af00">Wait</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>第一个协程会在发送消息<code>foo</code>时阻塞，原因是接收者还没有就绪：这个特性在<a href="https://golang.org/ref/spec?source=post_page---------------------------#Channel_types">标准文档</a>中描述如下：</p>
<blockquote>
<p>如果缓冲大小设置为0或者不设置，channel为无缓冲类型，通信成功的前提是发送者和接收者都处于就绪状态。</p>
</blockquote>
<p><a href="https://golang.org/doc/effective_go.html?source=post_page---------------------------#channels">effective Go</a>文档也有相应的描述：</p>
<blockquote>
<p>无缓冲channel，发送者会阻塞直到接收者接收了发送的值。</p>
</blockquote>
<p>为了更好的理解channel的特性，接下来我们分析channel的内部结构。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;sync&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">c</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">chan</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">var</span> <span style="color:#75af00">wg</span> <span style="color:#75af00">sync</span><span style="color:#111">.</span><span style="color:#75af00">WaitGroup</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">wg</span><span style="color:#111">.</span><span style="color:#75af00">Add</span><span style="color:#111">(</span><span style="color:#ae81ff">2</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">go</span> <span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">defer</span> <span style="color:#75af00">wg</span><span style="color:#111">.</span><span style="color:#75af00">Done</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">c</span> <span style="color:#f92672">&lt;-</span> <span style="color:#d88200">&#34;foo&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">go</span> <span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">defer</span> <span style="color:#75af00">wg</span><span style="color:#111">.</span><span style="color:#75af00">Done</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Sleep</span><span style="color:#111">(</span><span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Second</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;message:&#34;</span> <span style="color:#f92672">+</span> <span style="color:#f92672">&lt;-</span> <span style="color:#75af00">c</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">wg</span><span style="color:#111">.</span><span style="color:#75af00">Wait</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">foo
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span></code></pre></div><h2 id="有缓冲管道">有缓冲管道</h2>
<p>buffered channel 具有容量，因此其行为可能有点不同。当 goroutine 试图将资源发送到缓冲通道，而该通道已满时，该通道将锁住 goroutine并使其等待缓冲区可用。如果通道中有空间，发送可以立即进行，goroutine 可以继续。当goroutine 试图从缓冲通道接收数据，而缓冲通道为空时，该通道将锁住 goroutine 并使其等待资源被发送。</p>
<p><img src="/images/1dd9d417-4fff-4650-a111-0c8062f6cb0a.png" alt=""></p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;sync&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">c</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">chan</span> <span style="color:#00a8c8">string</span><span style="color:#111">,</span><span style="color:#ae81ff">2</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">var</span> <span style="color:#75af00">wg</span> <span style="color:#75af00">sync</span><span style="color:#111">.</span><span style="color:#75af00">WaitGroup</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">wg</span><span style="color:#111">.</span><span style="color:#75af00">Add</span><span style="color:#111">(</span><span style="color:#ae81ff">2</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">go</span> <span style="color:#00a8c8">func</span><span style="color:#111">(){</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">defer</span> <span style="color:#75af00">wg</span><span style="color:#111">.</span><span style="color:#75af00">Done</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">c</span> <span style="color:#f92672">&lt;-</span> <span style="color:#d88200">&#34;foo&#34;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">c</span> <span style="color:#f92672">&lt;-</span> <span style="color:#d88200">&#34;bar&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">go</span> <span style="color:#00a8c8">func</span><span style="color:#111">(){</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">defer</span> <span style="color:#75af00">wg</span><span style="color:#111">.</span><span style="color:#75af00">Done</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Sleep</span><span style="color:#111">(</span><span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Second</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;mesage:&#34;</span> <span style="color:#f92672">+</span> <span style="color:#f92672">&lt;-</span> <span style="color:#75af00">c</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;message:&#34;</span> <span style="color:#f92672">+</span> <span style="color:#f92672">&lt;-</span> <span style="color:#75af00">c</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">wg</span><span style="color:#111">.</span><span style="color:#75af00">Wait</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">mesage:foo
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">message:bar
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span></code></pre></div><h2 id="追踪耗时">追踪耗时</h2>
<p>通过Go工具trace中的<code>synchronization blocking profile</code>来查看测试程序被同步原语阻塞所消耗的时间。接收时的耗时对比：无缓冲channel为9毫秒，缓冲大小为50的channel为1.9毫秒。</p>
<p><img src="/images/f28ef331-7779-49d3-acbb-754ab88a5cd2.png" alt=""></p>
<p>发送时的耗时对比：有缓冲channel将耗时缩小了五倍。</p>
<p><img src="/images/a60dbc3e-190a-46af-96d1-44c80f2892bd.png" alt=""></p>
<ul>
<li>Send 先于 Receive 发生。</li>
<li>好处: 延迟更小。</li>
<li>代价: 不保证数据到达，越大的 buffer，越小的保障到达。buffer = 1 时，给你延迟一个消息的保障。</li>
</ul>
<h2 id="参考文章">参考文章</h2>
<ul>
<li><a href="https://www.it1352.com/807929.html">https://www.it1352.com/807929.html</a></li>
<li><a href="https://www.pengrl.com/p/21027/">https://www.pengrl.com/p/21027/</a></li>
</ul>
]]></content:encoded><category>go</category><category>go</category></item><item><title>golang并发</title><link>https://daemon365.dev/post/go/golang_concurrency/</link><pubDate>Wed, 26 Jun 2019 00:00:00 +0800</pubDate><guid>https://daemon365.dev/post/go/golang_concurrency/</guid><description>&lt;h2 id="goroutine"&gt;goroutine&lt;/h2&gt;
&lt;p&gt;goroutine是Go并行设计的核心。goroutine说到底其实就是线程，但是它比线程更小，十几个goroutine可能体现在底层就是五六个线程，Go语言内部帮你实现了这些goroutine之间的内存共享。执行goroutine只需极少的栈内存(大概是4~5KB)，当然会根据相应的数据伸缩。也正因为如此，可同时运行成千上万个并发任务。goroutine比thread更易用、更高效、更轻便。&lt;/p&gt;
&lt;p&gt;goroutine是通过Go的runtime管理的一个线程管理器。goroutine通过go关键字实现了，其实就是一个普通的函数。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;go&lt;/span&gt; &lt;span style="color:#75af00"&gt;hello&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;a&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;b&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;c&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;通过关键字go就启动了一个goroutine。我们来看一个例子&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;package&lt;/span&gt; &lt;span style="color:#75af00"&gt;main&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;import&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;fmt&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;runtime&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;say&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;s&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;string&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;for&lt;/span&gt; &lt;span style="color:#75af00"&gt;i&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;0&lt;/span&gt;&lt;span style="color:#111"&gt;;&lt;/span&gt; &lt;span style="color:#75af00"&gt;i&lt;/span&gt; &lt;span style="color:#111"&gt;&amp;lt;&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;5&lt;/span&gt;&lt;span style="color:#111"&gt;;&lt;/span&gt; &lt;span style="color:#75af00"&gt;i&lt;/span&gt;&lt;span style="color:#f92672"&gt;++&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;runtime&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Gosched&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;s&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;main&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;go&lt;/span&gt; &lt;span style="color:#75af00"&gt;say&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;world&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75715e"&gt;//开一个新的Goroutines执行&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;say&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;hello&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75715e"&gt;//当前Goroutines执行&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;// 以上程序执行后将输出：&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;// hello&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;// world&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;// hello&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;// world&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;// hello&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;// world&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;// hello&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;// world&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;// hello&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;我们可以看到go关键字很方便的就实现了并发编程。 上面的多个goroutine运行在同一个进程里面，共享内存数据，不过设计上我们要遵循：不要通过共享来通信，而要通过通信来共享。&lt;/p&gt;
&lt;h3 id="goroutine的调度机制"&gt;goroutine的调度机制&lt;/h3&gt;
&lt;p&gt;Go runtime的调度器：
在了解Go的运行时的scheduler之前，需要先了解为什么需要它，因为我们可能会想，OS内核不是已经有一个线程scheduler了嘛？
熟悉POSIX API的人都知道，POSIX的方案在很大程度上是对Unix process进场模型的一个逻辑描述和扩展，两者有很多相似的地方。 Thread有自己的信号掩码，CPU affinity等。但是很多特征对于Go程序来说都是累赘。 尤其是context上下文切换的耗时。另一个原因是Go的垃圾回收需要所有的goroutine停止，使得内存在一个一致的状态。垃圾回收的时间点是不确定的，如果依靠OS自身的scheduler来调度，那么会有大量的线程需要停止工作。&lt;/p&gt;
&lt;p&gt;单独的开发一个GO得调度器，可以是其知道在什么时候内存状态是一致的，也就是说，当开始垃圾回收时，运行时只需要为当时正在CPU核上运行的那个线程等待即可，而不是等待所有的线程。&lt;/p&gt;
&lt;p&gt;用户空间线程和内核空间线程之间的映射关系有：N:1,1:1和M:N
N:1是说，多个（N）用户线程始终在一个内核线程上跑，context上下文切换确实很快，但是无法真正的利用多核。
1：1是说，一个用户线程就只在一个内核线程上跑，这时可以利用多核，但是上下文switch很慢。
M:N是说， 多个goroutine在多个内核线程上跑，这个看似可以集齐上面两者的优势，但是无疑增加了调度的难度。&lt;/p&gt;
&lt;p&gt;&lt;img src="https://daemon365.dev/images/5e7fe8ab-8d4d-4332-8e32-33a9f7fbe810.png" alt=""&gt;&lt;/p&gt;
&lt;p&gt;Go的调度器内部有三个重要的结构：M，P，S
M:代表真正的内核OS线程，和POSIX里的thread差不多，真正干活的人
G:代表一个goroutine，它有自己的栈，instruction pointer和其他信息（正在等待的channel等等），用于调度。
P:代表调度的上下文，可以把它看做一个局部的调度器，使go代码在一个线程上跑，它是实现从N:1到N:M映射的关键。&lt;/p&gt;
&lt;p&gt;&lt;img src="https://daemon365.dev/images/4ebd290c-6ac3-4cbd-84a4-7e1036f4b4f4.png" alt=""&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src="https://daemon365.dev/images/3fa3fa7e-18ee-4db2-b2ce-8455f7eb803a.png" alt=""&gt;&lt;/p&gt;
&lt;p&gt;图中看，有2个物理线程M，每一个M都拥有一个context（P），每一个也都有一个正在运行的goroutine。
P的数量可以通过GOMAXPROCS()来设置，它其实也就代表了真正的并发度，即有多少个goroutine可以同时运行。
图中灰色的那些goroutine并没有运行，而是出于ready的就绪态，正在等待被调度。P维护着这个队列（称之为runqueue），
Go语言里，启动一个goroutine很容易：go function 就行，所以每有一个go语句被执行，runqueue队列就在其末尾加入一个
goroutine，在下一个调度点，就从runqueue中取出（如何决定取哪个goroutine？）一个goroutine执行。&lt;/p&gt;</description><content:encoded><![CDATA[<h2 id="goroutine">goroutine</h2>
<p>goroutine是Go并行设计的核心。goroutine说到底其实就是线程，但是它比线程更小，十几个goroutine可能体现在底层就是五六个线程，Go语言内部帮你实现了这些goroutine之间的内存共享。执行goroutine只需极少的栈内存(大概是4~5KB)，当然会根据相应的数据伸缩。也正因为如此，可同时运行成千上万个并发任务。goroutine比thread更易用、更高效、更轻便。</p>
<p>goroutine是通过Go的runtime管理的一个线程管理器。goroutine通过go关键字实现了，其实就是一个普通的函数。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">go</span> <span style="color:#75af00">hello</span><span style="color:#111">(</span><span style="color:#75af00">a</span><span style="color:#111">,</span> <span style="color:#75af00">b</span><span style="color:#111">,</span> <span style="color:#75af00">c</span><span style="color:#111">)</span>
</span></span></code></pre></div><p>通过关键字go就启动了一个goroutine。我们来看一个例子</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d88200">&#34;runtime&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">say</span><span style="color:#111">(</span><span style="color:#75af00">s</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">for</span> <span style="color:#75af00">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span><span style="color:#111">;</span> <span style="color:#75af00">i</span> <span style="color:#111">&lt;</span> <span style="color:#ae81ff">5</span><span style="color:#111">;</span> <span style="color:#75af00">i</span><span style="color:#f92672">++</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">runtime</span><span style="color:#111">.</span><span style="color:#75af00">Gosched</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">s</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">go</span> <span style="color:#75af00">say</span><span style="color:#111">(</span><span style="color:#d88200">&#34;world&#34;</span><span style="color:#111">)</span> <span style="color:#75715e">//开一个新的Goroutines执行</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">say</span><span style="color:#111">(</span><span style="color:#d88200">&#34;hello&#34;</span><span style="color:#111">)</span> <span style="color:#75715e">//当前Goroutines执行</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 以上程序执行后将输出：</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// hello</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// world</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// hello</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// world</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// hello</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// world</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// hello</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// world</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// hello</span>
</span></span></code></pre></div><p>我们可以看到go关键字很方便的就实现了并发编程。 上面的多个goroutine运行在同一个进程里面，共享内存数据，不过设计上我们要遵循：不要通过共享来通信，而要通过通信来共享。</p>
<h3 id="goroutine的调度机制">goroutine的调度机制</h3>
<p>Go runtime的调度器：
在了解Go的运行时的scheduler之前，需要先了解为什么需要它，因为我们可能会想，OS内核不是已经有一个线程scheduler了嘛？
熟悉POSIX API的人都知道，POSIX的方案在很大程度上是对Unix process进场模型的一个逻辑描述和扩展，两者有很多相似的地方。 Thread有自己的信号掩码，CPU affinity等。但是很多特征对于Go程序来说都是累赘。 尤其是context上下文切换的耗时。另一个原因是Go的垃圾回收需要所有的goroutine停止，使得内存在一个一致的状态。垃圾回收的时间点是不确定的，如果依靠OS自身的scheduler来调度，那么会有大量的线程需要停止工作。</p>
<p>单独的开发一个GO得调度器，可以是其知道在什么时候内存状态是一致的，也就是说，当开始垃圾回收时，运行时只需要为当时正在CPU核上运行的那个线程等待即可，而不是等待所有的线程。</p>
<p>用户空间线程和内核空间线程之间的映射关系有：N:1,1:1和M:N
N:1是说，多个（N）用户线程始终在一个内核线程上跑，context上下文切换确实很快，但是无法真正的利用多核。
1：1是说，一个用户线程就只在一个内核线程上跑，这时可以利用多核，但是上下文switch很慢。
M:N是说， 多个goroutine在多个内核线程上跑，这个看似可以集齐上面两者的优势，但是无疑增加了调度的难度。</p>
<p><img src="/images/5e7fe8ab-8d4d-4332-8e32-33a9f7fbe810.png" alt=""></p>
<p>Go的调度器内部有三个重要的结构：M，P，S
M:代表真正的内核OS线程，和POSIX里的thread差不多，真正干活的人
G:代表一个goroutine，它有自己的栈，instruction pointer和其他信息（正在等待的channel等等），用于调度。
P:代表调度的上下文，可以把它看做一个局部的调度器，使go代码在一个线程上跑，它是实现从N:1到N:M映射的关键。</p>
<p><img src="/images/4ebd290c-6ac3-4cbd-84a4-7e1036f4b4f4.png" alt=""></p>
<p><img src="/images/3fa3fa7e-18ee-4db2-b2ce-8455f7eb803a.png" alt=""></p>
<p>图中看，有2个物理线程M，每一个M都拥有一个context（P），每一个也都有一个正在运行的goroutine。
P的数量可以通过GOMAXPROCS()来设置，它其实也就代表了真正的并发度，即有多少个goroutine可以同时运行。
图中灰色的那些goroutine并没有运行，而是出于ready的就绪态，正在等待被调度。P维护着这个队列（称之为runqueue），
Go语言里，启动一个goroutine很容易：go function 就行，所以每有一个go语句被执行，runqueue队列就在其末尾加入一个
goroutine，在下一个调度点，就从runqueue中取出（如何决定取哪个goroutine？）一个goroutine执行。</p>
<p>为何要维护多个上下文P？因为当一个OS线程被阻塞时，P可以转而投奔另一个OS线程！
图中看到，当一个OS线程M0陷入阻塞时，P转而在OS线程M1上运行。调度器保证有足够的线程来运行所以的context P。</p>
<p><img src="/images/f3d3e8c9-630d-422b-86f5-728100c6c5db.png" alt=""></p>
<p><img src="/images/02f44202-df5e-4039-9371-677e4f95afc0.png" alt=""></p>
<p>图中的M1可能是被创建，或者从线程缓存中取出。</p>
<p>当MO返回时，它必须尝试取得一个context P来运行goroutine，一般情况下，它会从其他的OS线程那里steal偷一个context过来，
如果没有偷到的话，它就把goroutine放在一个global runqueue里，然后自己就去睡大觉了（放入线程缓存里）。Contexts们也会周期性的检查global runqueue，否则global runqueue上的goroutine永远无法执行。</p>
<p><img src="/images/6cd67396-b803-459c-8068-29d2e68246b1.png" alt=""></p>
<p><img src="/images/9457c8af-1fb9-427c-ac90-9d71d3671d80.png" alt=""></p>
<p>另一种情况是P所分配的任务G很快就执行完了（分配不均），这就导致了一个上下文P闲着没事儿干而系统却任然忙碌。但是如果global runqueue没有任务G了，那么P就不得不从其他的上下文P那里拿一些G来执行。一般来说，如果上下文P从其他的上下文P那里要偷一个任务的话，一般就‘偷’run queue的一半，这就确保了每个OS线程都能充分的使用。</p>
<h2 id="channels">channels</h2>
<p>goroutine运行在相同的地址空间，因此访问共享内存必须做好同步。那么goroutine之间如何进行数据的通信呢，Go提供了一个很好的通信机制channel。channel可以与Unix shell 中的双向管道做类比：可以通过它发送或者接收值。这些值只能是特定的类型：channel类型。定义一个channel时，也需要定义发送到channel的值的类型。注意，必须使用make 创建channel：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">ci</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">chan</span> <span style="color:#00a8c8">int</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">cs</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">chan</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">cf</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">chan</span> <span style="color:#00a8c8">interface</span><span style="color:#111">{})</span>
</span></span></code></pre></div><p>channel通过操作符&lt;-来接收和发送数据</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">ch</span> <span style="color:#f92672">&lt;-</span> <span style="color:#75af00">v</span>    <span style="color:#75715e">// 发送v到channel ch.</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">v</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#75af00">ch</span>  <span style="color:#75715e">// 从ch中接收数据，并赋值给v</span>
</span></span></code></pre></div><p>我们把这些应用到我们的例子中来：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">sum</span><span style="color:#111">(</span><span style="color:#75af00">a</span> <span style="color:#111">[]</span><span style="color:#00a8c8">int</span><span style="color:#111">,</span> <span style="color:#75af00">c</span> <span style="color:#00a8c8">chan</span> <span style="color:#00a8c8">int</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">total</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">v</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">a</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">total</span> <span style="color:#f92672">+=</span> <span style="color:#75af00">v</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">c</span> <span style="color:#f92672">&lt;-</span> <span style="color:#75af00">total</span>  <span style="color:#75715e">// send total to c</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">a</span> <span style="color:#f92672">:=</span> <span style="color:#111">[]</span><span style="color:#00a8c8">int</span><span style="color:#111">{</span><span style="color:#ae81ff">7</span><span style="color:#111">,</span> <span style="color:#ae81ff">2</span><span style="color:#111">,</span> <span style="color:#ae81ff">8</span><span style="color:#111">,</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">9</span><span style="color:#111">,</span> <span style="color:#ae81ff">4</span><span style="color:#111">,</span> <span style="color:#ae81ff">0</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">c</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">chan</span> <span style="color:#00a8c8">int</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">go</span> <span style="color:#75af00">sum</span><span style="color:#111">(</span><span style="color:#75af00">a</span><span style="color:#111">[:</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">a</span><span style="color:#111">)</span><span style="color:#f92672">/</span><span style="color:#ae81ff">2</span><span style="color:#111">],</span> <span style="color:#75af00">c</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">go</span> <span style="color:#75af00">sum</span><span style="color:#111">(</span><span style="color:#75af00">a</span><span style="color:#111">[</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">a</span><span style="color:#111">)</span><span style="color:#f92672">/</span><span style="color:#ae81ff">2</span><span style="color:#111">:],</span> <span style="color:#75af00">c</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">x</span><span style="color:#111">,</span> <span style="color:#75af00">y</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#75af00">c</span><span style="color:#111">,</span> <span style="color:#f92672">&lt;-</span><span style="color:#75af00">c</span>  <span style="color:#75715e">// receive from c</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">x</span><span style="color:#111">,</span> <span style="color:#75af00">y</span><span style="color:#111">,</span> <span style="color:#75af00">x</span> <span style="color:#f92672">+</span> <span style="color:#75af00">y</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>默认情况下，channel接收和发送数据都是阻塞的，除非另一端已经准备好，这样就使得Goroutines同步变的更加的简单，而不需要显式的lock。所谓阻塞，也就是如果读取（value := &lt;-ch）它将会被阻塞，直到有数据接收。其次，任何发送（ch&lt;-5）将会被阻塞，直到数据被读出。无缓冲channel是在多个goroutine之间同步很棒的工具。</p>
<h3 id="buffered-channels">Buffered Channels</h3>
<p>上面我们介绍了默认的非缓存类型的channel，不过Go也允许指定channel的缓冲大小，很简单，就是channel可以存储多少元素。ch:= make(chan bool, 4)，创建了可以存储4个元素的bool 型channel。在这个channel 中，前4个元素可以无阻塞的写入。当写入第5个元素时，代码将会阻塞，直到其他goroutine从channel 中读取一些元素，腾出空间。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">ch</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">chan</span> <span style="color:#00a8c8">type</span><span style="color:#111">,</span> <span style="color:#75af00">value</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">value == 0 ! 无缓冲（阻塞）
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">value &gt; 0 ! 缓冲（非阻塞，直到value 个元素）
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span></code></pre></div><p>我们看一下下面这个例子，你可以在自己本机测试一下，修改相应的value值</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">c</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">chan</span> <span style="color:#00a8c8">int</span><span style="color:#111">,</span> <span style="color:#ae81ff">2</span><span style="color:#111">)</span><span style="color:#75715e">//修改2为1就报错，修改2为3可以正常运行</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">c</span> <span style="color:#f92672">&lt;-</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">c</span> <span style="color:#f92672">&lt;-</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#f92672">&lt;-</span><span style="color:#75af00">c</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#f92672">&lt;-</span><span style="color:#75af00">c</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//修改为1报如下的错误:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//fatal error: all goroutines are asleep - deadlock!</span>
</span></span></code></pre></div><h3 id="range和close">Range和Close</h3>
<p>上面这个例子中，我们需要读取两次c，这样不是很方便，Go考虑到了这一点，所以也可以通过range，像操作slice或者map一样操作缓存类型的channel，请看下面的例子</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">fibonacci</span><span style="color:#111">(</span><span style="color:#75af00">n</span> <span style="color:#00a8c8">int</span><span style="color:#111">,</span> <span style="color:#75af00">c</span> <span style="color:#00a8c8">chan</span> <span style="color:#00a8c8">int</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">x</span><span style="color:#111">,</span> <span style="color:#75af00">y</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">1</span><span style="color:#111">,</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">for</span> <span style="color:#75af00">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span><span style="color:#111">;</span> <span style="color:#75af00">i</span> <span style="color:#111">&lt;</span> <span style="color:#75af00">n</span><span style="color:#111">;</span> <span style="color:#75af00">i</span><span style="color:#f92672">++</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">c</span> <span style="color:#f92672">&lt;-</span> <span style="color:#75af00">x</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">x</span><span style="color:#111">,</span> <span style="color:#75af00">y</span> <span style="color:#111">=</span> <span style="color:#75af00">y</span><span style="color:#111">,</span> <span style="color:#75af00">x</span> <span style="color:#f92672">+</span> <span style="color:#75af00">y</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">close</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">c</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">chan</span> <span style="color:#00a8c8">int</span><span style="color:#111">,</span> <span style="color:#ae81ff">10</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">go</span> <span style="color:#75af00">fibonacci</span><span style="color:#111">(</span><span style="color:#111">cap</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">),</span> <span style="color:#75af00">c</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">for</span> <span style="color:#75af00">i</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">c</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">i</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>for i := range c能够不断的读取channel里面的数据，直到该channel被显式的关闭。上面代码我们看到可以显式的关闭channel，生产者通过内置函数close关闭channel。关闭channel之后就无法再发送任何数据了，在消费方可以通过语法v, ok := &lt;-ch测试channel是否被关闭。如果ok返回false，那么说明channel已经没有任何数据并且已经被关闭。</p>
<blockquote>
<p>记住应该在生产者的地方关闭channel，而不是消费的地方去关闭它，这样容易引起panic</p>
<p>另外记住一点的就是channel不像文件之类的，不需要经常去关闭，只有当你确实没有任何发送数据了，或者你想显式的结束range循环之类的</p>
</blockquote>
<h3 id="select">Select</h3>
<p>我们上面介绍的都是只有一个channel的情况，那么如果存在多个channel的时候，我们该如何操作呢，Go里面提供了一个关键字select，通过select可以监听channel上的数据流动。</p>
<p>select默认是阻塞的，只有当监听的channel中有发送或接收可以进行时才会运行，当多个channel都准备好的时候，select是随机的选择一个执行的。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">fibonacci</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">,</span> <span style="color:#75af00">quit</span> <span style="color:#00a8c8">chan</span> <span style="color:#00a8c8">int</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">x</span><span style="color:#111">,</span> <span style="color:#75af00">y</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">1</span><span style="color:#111">,</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">for</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">select</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">case</span> <span style="color:#75af00">c</span> <span style="color:#f92672">&lt;-</span> <span style="color:#75af00">x</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75af00">x</span><span style="color:#111">,</span> <span style="color:#75af00">y</span> <span style="color:#111">=</span> <span style="color:#75af00">y</span><span style="color:#111">,</span> <span style="color:#75af00">x</span> <span style="color:#f92672">+</span> <span style="color:#75af00">y</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#75af00">quit</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;quit&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">c</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">chan</span> <span style="color:#00a8c8">int</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">quit</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">chan</span> <span style="color:#00a8c8">int</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">go</span> <span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">for</span> <span style="color:#75af00">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span><span style="color:#111">;</span> <span style="color:#75af00">i</span> <span style="color:#111">&lt;</span> <span style="color:#ae81ff">10</span><span style="color:#111">;</span> <span style="color:#75af00">i</span><span style="color:#f92672">++</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#f92672">&lt;-</span><span style="color:#75af00">c</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">quit</span> <span style="color:#f92672">&lt;-</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">fibonacci</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">,</span> <span style="color:#75af00">quit</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>在select里面还有default语法，select其实就是类似switch的功能，default就是当监听的channel都没有准备好的时候，默认执行的（select不再阻塞等待channel）。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">select</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">case</span> <span style="color:#75af00">i</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#75af00">c</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// use i</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">default</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 当c阻塞的时候执行这里</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="超时">超时</h3>
<p>有时候会出现goroutine阻塞的情况，那么我们如何避免整个程序进入阻塞的情况呢？我们可以利用select来设置超时，通过如下的方式实现：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">c</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">chan</span> <span style="color:#00a8c8">int</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">o</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">chan</span> <span style="color:#00a8c8">bool</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">go</span> <span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">for</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">select</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#00a8c8">case</span> <span style="color:#75af00">v</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span> <span style="color:#75af00">c</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#111">println</span><span style="color:#111">(</span><span style="color:#75af00">v</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#00a8c8">case</span> <span style="color:#f92672">&lt;-</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">After</span><span style="color:#111">(</span><span style="color:#ae81ff">5</span> <span style="color:#f92672">*</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Second</span><span style="color:#111">):</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#111">println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;timeout&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#75af00">o</span> <span style="color:#f92672">&lt;-</span> <span style="color:#00a8c8">true</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#00a8c8">break</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;-</span> <span style="color:#75af00">o</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="runtime-goroutine">runtime goroutine</h3>
<p>runtime包中有几个处理goroutine的函数：</p>
<ul>
<li>
<p>Goexit</p>
<p>退出当前执行的goroutine，但是defer函数还会继续调用</p>
</li>
<li>
<p>Gosched</p>
<p>让出当前goroutine的执行权限，调度器安排其他等待的任务运行，并在下次某个时候从该位置恢复执行。</p>
</li>
<li>
<p>NumCPU</p>
<p>返回 CPU 核数量</p>
</li>
<li>
<p>NumGoroutine</p>
<p>返回正在执行和排队的任务总数</p>
</li>
<li>
<p>GOMAXPROCS</p>
<p>用来设置可以并行计算的CPU核数的最大值，并返回之前的值。</p>
</li>
</ul>
<p>参考文章:</p>
<ul>
<li>《go web编程》</li>
<li><a href="https://www.zhihu.com/question/20862617/answer/27964865">https://www.zhihu.com/question/20862617/answer/27964865</a></li>
</ul>
]]></content:encoded><category>go</category><category>go</category></item><item><title>go语言文件系统</title><link>https://daemon365.dev/post/go/go_language_file_system/</link><pubDate>Sun, 23 Jun 2019 00:00:00 +0800</pubDate><guid>https://daemon365.dev/post/go/go_language_file_system/</guid><description>&lt;h2 id="检测文件是否存在"&gt;检测文件是否存在&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;//存在返回 true，不存在返回 false&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;fileIfExist&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;filename&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;string&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;bool&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;_&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;os&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Stat&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;filename&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt; &lt;span style="color:#f92672"&gt;!=&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;filename&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;is not exist!&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;false&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;os&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;IsNotExist&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;err&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;false&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;true&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id="打开文件"&gt;打开文件&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75af00"&gt;f&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;os&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Open&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;filename&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt; &lt;span style="color:#f92672"&gt;!=&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;open&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;filename&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;failed!&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;defer&lt;/span&gt; &lt;span style="color:#75af00"&gt;f&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Close&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;如果文件不存在，就会返回错误，如果存在就以只读的方式打开文件。&lt;/p&gt;
&lt;p&gt;还可以使用 &lt;code&gt;os.OpenFile()&lt;/code&gt; 打开文件，达到不存在就新建，存在就清空（&lt;code&gt;os.O_TRUNC&lt;/code&gt;）的目的。当然，也可以不清空文件（&lt;code&gt;os.O_APPEND&lt;/code&gt;）。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75af00"&gt;f&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;os&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;OpenFile&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;filename&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;os&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;O_RDWR&lt;/span&gt; &lt;span style="color:#111"&gt;|&lt;/span&gt; &lt;span style="color:#75af00"&gt;os&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;O_CREATE&lt;/span&gt; &lt;span style="color:#111"&gt;|&lt;/span&gt; &lt;span style="color:#75af00"&gt;os&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;O_TRUNC&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;0666&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt; &lt;span style="color:#f92672"&gt;!=&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;create&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;filename&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;failed!&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;defer&lt;/span&gt; &lt;span style="color:#75af00"&gt;f&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Close&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id="新建文件"&gt;新建文件&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75af00"&gt;f&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;os&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Create&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;filename&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt; &lt;span style="color:#f92672"&gt;!=&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;create&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;filename&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;failed!&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;defer&lt;/span&gt; &lt;span style="color:#75af00"&gt;f&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Close&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;注意：如果文件已经存在，那么 &lt;code&gt;os.Create()&lt;/code&gt; 会将文件清空。可以使用 &lt;code&gt;os.OpenFile()&lt;/code&gt; 新建文件， 参数 &lt;code&gt;flag&lt;/code&gt; 为 &lt;code&gt;os.O_CREATE | os.O_EXCL&lt;/code&gt;。如果文件已经存在，那么该函数就会返回错误。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75af00"&gt;f&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;os&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;OpenFile&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;filename&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;os&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;O_CREATE&lt;/span&gt; &lt;span style="color:#111"&gt;|&lt;/span&gt; &lt;span style="color:#75af00"&gt;os&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;O_EXCL&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;0666&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt; &lt;span style="color:#f92672"&gt;!=&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;create&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;filename&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;failed!&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;defer&lt;/span&gt; &lt;span style="color:#75af00"&gt;f&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Close&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id="读取文件"&gt;读取文件&lt;/h2&gt;
&lt;h3 id="读取全部内容"&gt;读取全部内容&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75af00"&gt;content&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#111"&gt;make&lt;/span&gt;&lt;span style="color:#111"&gt;([]&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;byte&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;1024&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75715e"&gt;//需要预先分配空间&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75af00"&gt;f&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;_&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;os&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Open&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;filename&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;defer&lt;/span&gt; &lt;span style="color:#75af00"&gt;f&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Close&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75af00"&gt;_&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;f&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Read&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;content&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt; &lt;span style="color:#f92672"&gt;!=&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;read&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;filename&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;failed!&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;读取文件内容可以使用 &lt;code&gt;File&lt;/code&gt; 的方法——&lt;code&gt;Read&lt;/code&gt;。但是使用该方法时需要预先分配空间，用于存储读取的文件内容。我们当然可以提前获取文件的大小，但是这种方式仍然不如 &lt;code&gt;ioutil.ReadAll()&lt;/code&gt; 方便。甚至可以直接使用 &lt;code&gt;ioutil.ReadFile()&lt;/code&gt;。&lt;/p&gt;</description><content:encoded><![CDATA[<h2 id="检测文件是否存在">检测文件是否存在</h2>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">//存在返回 true，不存在返回 false</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">fileIfExist</span><span style="color:#111">(</span><span style="color:#75af00">filename</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#00a8c8">bool</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">Stat</span><span style="color:#111">(</span><span style="color:#75af00">filename</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#00a8c8">nil</span> <span style="color:#f92672">!=</span> <span style="color:#75af00">err</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">filename</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;is not exist!&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#00a8c8">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">IsNotExist</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#00a8c8">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#00a8c8">true</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="打开文件">打开文件</h2>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">f</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">Open</span><span style="color:#111">(</span><span style="color:#75af00">filename</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#00a8c8">nil</span> <span style="color:#f92672">!=</span> <span style="color:#75af00">err</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;open&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">filename</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;failed!&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">defer</span> <span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span></code></pre></div><p>如果文件不存在，就会返回错误，如果存在就以只读的方式打开文件。</p>
<p>还可以使用 <code>os.OpenFile()</code> 打开文件，达到不存在就新建，存在就清空（<code>os.O_TRUNC</code>）的目的。当然，也可以不清空文件（<code>os.O_APPEND</code>）。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">f</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">OpenFile</span><span style="color:#111">(</span><span style="color:#75af00">filename</span><span style="color:#111">,</span> <span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">O_RDWR</span> <span style="color:#111">|</span> <span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">O_CREATE</span> <span style="color:#111">|</span> <span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">O_TRUNC</span><span style="color:#111">,</span> <span style="color:#ae81ff">0666</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#00a8c8">nil</span> <span style="color:#f92672">!=</span> <span style="color:#75af00">err</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;create&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">filename</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;failed!&#34;</span><span style="color:#111">)</span>    
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">defer</span> <span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span></code></pre></div><h2 id="新建文件">新建文件</h2>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">f</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">Create</span><span style="color:#111">(</span><span style="color:#75af00">filename</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#00a8c8">nil</span> <span style="color:#f92672">!=</span> <span style="color:#75af00">err</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;create&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">filename</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;failed!&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">defer</span> <span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span></code></pre></div><p>注意：如果文件已经存在，那么 <code>os.Create()</code> 会将文件清空。可以使用 <code>os.OpenFile()</code> 新建文件， 参数 <code>flag</code> 为 <code>os.O_CREATE | os.O_EXCL</code>。如果文件已经存在，那么该函数就会返回错误。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">f</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">OpenFile</span><span style="color:#111">(</span><span style="color:#75af00">filename</span><span style="color:#111">,</span> <span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">O_CREATE</span> <span style="color:#111">|</span> <span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">O_EXCL</span><span style="color:#111">,</span> <span style="color:#ae81ff">0666</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#00a8c8">nil</span> <span style="color:#f92672">!=</span> <span style="color:#75af00">err</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;create&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">filename</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;failed!&#34;</span><span style="color:#111">)</span>    
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">defer</span> <span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span></code></pre></div><h2 id="读取文件">读取文件</h2>
<h3 id="读取全部内容">读取全部内容</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">content</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">([]</span><span style="color:#00a8c8">byte</span><span style="color:#111">,</span> <span style="color:#ae81ff">1024</span><span style="color:#111">)</span>   <span style="color:#75715e">//需要预先分配空间</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">f</span><span style="color:#111">,</span> <span style="color:#75af00">_</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">Open</span><span style="color:#111">(</span><span style="color:#75af00">filename</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">defer</span> <span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">Read</span><span style="color:#111">(</span><span style="color:#75af00">content</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#00a8c8">nil</span> <span style="color:#f92672">!=</span> <span style="color:#75af00">err</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;read&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">filename</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;failed!&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>读取文件内容可以使用 <code>File</code> 的方法——<code>Read</code>。但是使用该方法时需要预先分配空间，用于存储读取的文件内容。我们当然可以提前获取文件的大小，但是这种方式仍然不如 <code>ioutil.ReadAll()</code> 方便。甚至可以直接使用 <code>ioutil.ReadFile()</code>。</p>
<p><code>ioutil.ReadAll()</code>：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">f</span><span style="color:#111">,</span> <span style="color:#75af00">_</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">Open</span><span style="color:#111">(</span><span style="color:#75af00">filename</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">defer</span> <span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">content</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">ioutil</span><span style="color:#111">.</span><span style="color:#75af00">ReadAll</span><span style="color:#111">(</span><span style="color:#75af00">f</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#00a8c8">nil</span> <span style="color:#f92672">!=</span> <span style="color:#75af00">err</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;read&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">filename</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;failed!&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#111">string</span><span style="color:#111">(</span><span style="color:#75af00">content</span><span style="color:#111">))</span>
</span></span></code></pre></div><p><code>ioutil.ReadFile()</code>：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">content</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">ioutil</span><span style="color:#111">.</span><span style="color:#75af00">ReadFile</span><span style="color:#111">(</span><span style="color:#75af00">filename</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#00a8c8">nil</span> <span style="color:#f92672">!=</span> <span style="color:#75af00">err</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;read&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">filename</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;failed!&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#111">string</span><span style="color:#111">(</span><span style="color:#75af00">content</span><span style="color:#111">))</span>
</span></span></code></pre></div><h3 id="按行读取">按行读取</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">f</span><span style="color:#111">,</span> <span style="color:#75af00">_</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">Open</span><span style="color:#111">(</span><span style="color:#75af00">filename</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">defer</span> <span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">scanner</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">bufio</span><span style="color:#111">.</span><span style="color:#75af00">NewScanner</span><span style="color:#111">(</span><span style="color:#75af00">f</span><span style="color:#111">)</span> <span style="color:#75715e">//按行读取</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">for</span> <span style="color:#75af00">scanner</span><span style="color:#111">.</span><span style="color:#75af00">Scan</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">scanner</span><span style="color:#111">.</span><span style="color:#75af00">Text</span><span style="color:#111">())</span> <span style="color:#75715e">//输出文件内容</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="写入文件">写入文件</h2>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">f</span><span style="color:#111">,</span> <span style="color:#75af00">_</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">OpenFile</span><span style="color:#111">(</span><span style="color:#75af00">filename</span><span style="color:#111">,</span> <span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">O_WRONLY</span> <span style="color:#111">|</span> <span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">O_APPEND</span><span style="color:#111">,</span> <span style="color:#ae81ff">0666</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">defer</span> <span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">WriteString</span><span style="color:#111">(</span><span style="color:#d88200">&#34;target_compile_option&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#00a8c8">nil</span> <span style="color:#f92672">!=</span> <span style="color:#75af00">err</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>这里使用 <code>os.OpenFile()</code> 以追加的方式打开文件。为什么不使用 <code>os.Open()</code> 打开文件呢？因为 <code>os.Open()</code> 是以只读的方式打开文件，无法向文件写入数据。</p>
<p>我们也可以使用 <code>ioutil.WriteFile()</code> 写文件。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">writeContent</span> <span style="color:#f92672">:=</span> <span style="color:#d88200">&#34;write file test&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">ioutil</span><span style="color:#111">.</span><span style="color:#75af00">WriteFile</span><span style="color:#111">(</span><span style="color:#75af00">filename</span><span style="color:#111">,</span> <span style="color:#111">[]</span><span style="color:#111">byte</span><span style="color:#111">(</span><span style="color:#75af00">writeContent</span><span style="color:#111">),</span> <span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">ModePerm</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#00a8c8">nil</span> <span style="color:#f92672">!=</span> <span style="color:#75af00">err</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;write&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">filename</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;failed!&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>注意：使用 <code>ioutil.WriteFile(filename string, data []byte, perm os.FileMode)</code> 向文件中写入时，如果文件存在，文件会先被清空，然后再写入。如果文件不存在，就会以 <code>perm</code> 权限先创建文件，然后再写入。</p>
<h2 id="关闭文件">关闭文件</h2>
<p>直接调用 <code>File</code> 的 <code>Close()</code> 方法。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">f</span><span style="color:#111">,</span> <span style="color:#75af00">_</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">Open</span><span style="color:#111">(</span><span style="color:#75af00">filename</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span></code></pre></div><p>最好使用 <code>defer</code> 关键字执行 <code>Close()</code> 方法，这样能够保证函数退出时文件能被关闭。</p>
<h2 id="删除文件">删除文件</h2>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">Remove</span><span style="color:#111">(</span><span style="color:#75af00">filename</span><span style="color:#111">)</span>
</span></span></code></pre></div><p>删除文件前确保文件没有被其他程序使用。如果在当前程序中该文件已被打开，需要先关闭（<code>Close()</code>）文件。</p>
]]></content:encoded><category>go</category><category>go</category></item><item><title>golang函数</title><link>https://daemon365.dev/post/go/golang_function/</link><pubDate>Sat, 22 Jun 2019 00:00:00 +0800</pubDate><guid>https://daemon365.dev/post/go/golang_function/</guid><description>&lt;h2 id="函数声明"&gt;函数声明&lt;/h2&gt;
&lt;p&gt;&lt;strong&gt;函数声明包括函数名、形式参数列表、返回值列表（可省略）以及函数体。&lt;/strong&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;function&lt;/span&gt;&lt;span style="color:#f92672"&gt;-&lt;/span&gt;&lt;span style="color:#75af00"&gt;name&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;param&lt;/span&gt;&lt;span style="color:#f92672"&gt;...&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;result&lt;/span&gt;&lt;span style="color:#f92672"&gt;...&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;body&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;形式参数列表描述了函数的参数名以及参数类型。这些参数作为局部变量，其值由参数调用者提供。返回值列表描述了函数返回值的变量名以及类型。如果函数返回一个无名变量或者没有返回值，返回值列表的括号是可以省略的。如果一个函数声明不包括返回值列表，那么函数体执行完毕后，不会返回任何值。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;hypot&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;x&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;y&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;float64&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;float64&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt; &lt;span style="color:#75af00"&gt;math&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Sqrt&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;x&lt;/span&gt;&lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;x&lt;/span&gt; &lt;span style="color:#f92672"&gt;+&lt;/span&gt; &lt;span style="color:#75af00"&gt;y&lt;/span&gt;&lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;y&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;hypot&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;3&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;4&lt;/span&gt;&lt;span style="color:#111"&gt;))&lt;/span&gt; &lt;span style="color:#75715e"&gt;// &amp;#34;5&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id="递归"&gt;递归&lt;/h2&gt;
&lt;p&gt;函数可以是递归的，这意味着函数可以直接或间接的调用自身。对许多问题而言，递归是一种强有力的技术，例如处理递归的数据结构。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;a&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;i&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;int&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;res&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;int&lt;/span&gt;&lt;span style="color:#111"&gt;){&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;i&lt;/span&gt; &lt;span style="color:#f92672"&gt;==&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;1&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt; &lt;span style="color:#75af00"&gt;i&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt; &lt;span style="color:#75af00"&gt;i&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt; &lt;span style="color:#75af00"&gt;a&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;i&lt;/span&gt; &lt;span style="color:#f92672"&gt;-&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;1&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;a&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;5&lt;/span&gt;&lt;span style="color:#111"&gt;))&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 120&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id="多返回值"&gt;多返回值&lt;/h2&gt;
&lt;p&gt;在Go中，一个函数可以返回多个值。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;calculation&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;a&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt;&lt;span style="color:#75af00"&gt;b&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;int&lt;/span&gt;&lt;span style="color:#111"&gt;)(&lt;/span&gt;&lt;span style="color:#75af00"&gt;add&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt;&lt;span style="color:#75af00"&gt;sub&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;int&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;add&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#75af00"&gt;a&lt;/span&gt; &lt;span style="color:#f92672"&gt;+&lt;/span&gt; &lt;span style="color:#75af00"&gt;b&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;sub&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#75af00"&gt;a&lt;/span&gt; &lt;span style="color:#f92672"&gt;-&lt;/span&gt; &lt;span style="color:#75af00"&gt;b&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id="错误"&gt;错误&lt;/h2&gt;
&lt;p&gt;在Go中有一部分函数总是能成功的运行，对各种可能的输入都做了良好的处理，使得运行时几乎不会失败，除非遇到灾难性的、不可预料的情况，比如运行时的内存溢出。导致这种错误的原因很复杂，难以处理，从错误中恢复的可能性也很低。&lt;/p&gt;
&lt;p&gt;panic是来自被调函数的信号，表示发生了某个已知的bug。一个良好的程序永远不应该发生panic异常。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75af00"&gt;value&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;ok&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;cache&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Lookup&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;key&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#111"&gt;!&lt;/span&gt;&lt;span style="color:#75af00"&gt;ok&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// ...cache[key] does not exist…&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id="错误处理策略"&gt;错误处理策略&lt;/h3&gt;
&lt;p&gt;当一次函数调用返回错误时，调用者有应该选择何时的方式处理错误。根据情况的不同，有很多处理方式.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75af00"&gt;resp&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt;&lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;http&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Get&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;https://www.google.com&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;!=&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;err&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id="文件结尾错误eof"&gt;文件结尾错误（EOF）&lt;/h3&gt;
&lt;p&gt;函数经常会返回多种错误，这对终端用户来说可能会很有趣，但对程序而言，这使得情况变得复杂。很多时候，程序必须根据错误类型，作出不同的响应。让我们考虑这样一个例子：从文件中读取n个字节。如果n等于文件的长度，读取过程的任何错误都表示失败。如果n小于文件的长度，调用者会重复的读取固定大小的数据直到文件结束。这会导致调用者必须分别处理由文件结束引起的各种错误。基于这样的原因，io包保证任何由文件结束引起的读取失败都返回同一个错误——io.EOF，该错误在io包中定义：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;package&lt;/span&gt; &lt;span style="color:#75af00"&gt;io&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;import&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;errors&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;// EOF is the error returned by Read when no more input is available.&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;var&lt;/span&gt; &lt;span style="color:#75af00"&gt;EOF&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#75af00"&gt;errors&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;New&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;EOF&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;调用者只需通过简单的比较，就可以检测出这个错误。下面的例子展示了如何从标准输入中读取字符，以及判断文件结束。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75af00"&gt;in&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;bufio&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;NewReader&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;os&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Stdin&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;for&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;r&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;_&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;in&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;ReadRune&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;==&lt;/span&gt; &lt;span style="color:#75af00"&gt;io&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;EOF&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;break&lt;/span&gt; &lt;span style="color:#75715e"&gt;// finished reading&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;!=&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Errorf&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;read failed:%v&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// ...use r…&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;因为文件结束这种错误不需要更多的描述，所以io.EOF有固定的错误信息——“EOF”。对于其他错误，我们可能需要在错误信息中描述错误的类型和数量，这使得我们不能像io.EOF一样采用固定的错误信息。在7.11节中，我们会提出更系统的方法区分某些固定的错误值。&lt;/p&gt;</description><content:encoded><![CDATA[<h2 id="函数声明">函数声明</h2>
<p><strong>函数声明包括函数名、形式参数列表、返回值列表（可省略）以及函数体。</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">function</span><span style="color:#f92672">-</span><span style="color:#75af00">name</span><span style="color:#111">(</span><span style="color:#75af00">param</span><span style="color:#f92672">...</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#75af00">result</span><span style="color:#f92672">...</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">body</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>形式参数列表描述了函数的参数名以及参数类型。这些参数作为局部变量，其值由参数调用者提供。返回值列表描述了函数返回值的变量名以及类型。如果函数返回一个无名变量或者没有返回值，返回值列表的括号是可以省略的。如果一个函数声明不包括返回值列表，那么函数体执行完毕后，不会返回任何值。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">hypot</span><span style="color:#111">(</span><span style="color:#75af00">x</span><span style="color:#111">,</span> <span style="color:#75af00">y</span> <span style="color:#00a8c8">float64</span><span style="color:#111">)</span> <span style="color:#00a8c8">float64</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#75af00">math</span><span style="color:#111">.</span><span style="color:#75af00">Sqrt</span><span style="color:#111">(</span><span style="color:#75af00">x</span><span style="color:#f92672">*</span><span style="color:#75af00">x</span> <span style="color:#f92672">+</span> <span style="color:#75af00">y</span><span style="color:#f92672">*</span><span style="color:#75af00">y</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">hypot</span><span style="color:#111">(</span><span style="color:#ae81ff">3</span><span style="color:#111">,</span><span style="color:#ae81ff">4</span><span style="color:#111">))</span> <span style="color:#75715e">// &#34;5&#34;</span>
</span></span></code></pre></div><h2 id="递归">递归</h2>
<p>函数可以是递归的，这意味着函数可以直接或间接的调用自身。对许多问题而言，递归是一种强有力的技术，例如处理递归的数据结构。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">a</span><span style="color:#111">(</span><span style="color:#75af00">i</span> <span style="color:#00a8c8">int</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#75af00">res</span> <span style="color:#00a8c8">int</span><span style="color:#111">){</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">i</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">i</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#75af00">i</span> <span style="color:#f92672">*</span> <span style="color:#75af00">a</span><span style="color:#111">(</span><span style="color:#75af00">i</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">a</span><span style="color:#111">(</span><span style="color:#ae81ff">5</span><span style="color:#111">))</span> <span style="color:#75715e">// 120</span>
</span></span></code></pre></div><h2 id="多返回值">多返回值</h2>
<p>在Go中，一个函数可以返回多个值。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">calculation</span><span style="color:#111">(</span><span style="color:#75af00">a</span><span style="color:#111">,</span><span style="color:#75af00">b</span> <span style="color:#00a8c8">int</span><span style="color:#111">)(</span><span style="color:#75af00">add</span><span style="color:#111">,</span><span style="color:#75af00">sub</span> <span style="color:#00a8c8">int</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">add</span> <span style="color:#111">=</span> <span style="color:#75af00">a</span> <span style="color:#f92672">+</span> <span style="color:#75af00">b</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">sub</span> <span style="color:#111">=</span> <span style="color:#75af00">a</span> <span style="color:#f92672">-</span> <span style="color:#75af00">b</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="错误">错误</h2>
<p>在Go中有一部分函数总是能成功的运行，对各种可能的输入都做了良好的处理，使得运行时几乎不会失败，除非遇到灾难性的、不可预料的情况，比如运行时的内存溢出。导致这种错误的原因很复杂，难以处理，从错误中恢复的可能性也很低。</p>
<p>panic是来自被调函数的信号，表示发生了某个已知的bug。一个良好的程序永远不应该发生panic异常。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">value</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">cache</span><span style="color:#111">.</span><span style="color:#75af00">Lookup</span><span style="color:#111">(</span><span style="color:#75af00">key</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ...cache[key] does not exist…</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="错误处理策略">错误处理策略</h3>
<p>当一次函数调用返回错误时，调用者有应该选择何时的方式处理错误。根据情况的不同，有很多处理方式.</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">resp</span><span style="color:#111">,</span><span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Get</span><span style="color:#111">(</span><span style="color:#d88200">&#34;https://www.google.com&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="文件结尾错误eof">文件结尾错误（EOF）</h3>
<p>函数经常会返回多种错误，这对终端用户来说可能会很有趣，但对程序而言，这使得情况变得复杂。很多时候，程序必须根据错误类型，作出不同的响应。让我们考虑这样一个例子：从文件中读取n个字节。如果n等于文件的长度，读取过程的任何错误都表示失败。如果n小于文件的长度，调用者会重复的读取固定大小的数据直到文件结束。这会导致调用者必须分别处理由文件结束引起的各种错误。基于这样的原因，io包保证任何由文件结束引起的读取失败都返回同一个错误——io.EOF，该错误在io包中定义：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">io</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#d88200">&#34;errors&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// EOF is the error returned by Read when no more input is available.</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">var</span> <span style="color:#75af00">EOF</span> <span style="color:#111">=</span> <span style="color:#75af00">errors</span><span style="color:#111">.</span><span style="color:#75af00">New</span><span style="color:#111">(</span><span style="color:#d88200">&#34;EOF&#34;</span><span style="color:#111">)</span>
</span></span></code></pre></div><p>调用者只需通过简单的比较，就可以检测出这个错误。下面的例子展示了如何从标准输入中读取字符，以及判断文件结束。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">in</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">bufio</span><span style="color:#111">.</span><span style="color:#75af00">NewReader</span><span style="color:#111">(</span><span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">Stdin</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">for</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">r</span><span style="color:#111">,</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">in</span><span style="color:#111">.</span><span style="color:#75af00">ReadRune</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">==</span> <span style="color:#75af00">io</span><span style="color:#111">.</span><span style="color:#75af00">EOF</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">break</span> <span style="color:#75715e">// finished reading</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;read failed:%v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ...use r…</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>因为文件结束这种错误不需要更多的描述，所以io.EOF有固定的错误信息——“EOF”。对于其他错误，我们可能需要在错误信息中描述错误的类型和数量，这使得我们不能像io.EOF一样采用固定的错误信息。在7.11节中，我们会提出更系统的方法区分某些固定的错误值。</p>
<h2 id="函数值">函数值</h2>
<p>在Go中，函数被看作第一类值（first-class values）：函数像其他值一样，拥有类型，可以被赋值给其他变量，传递给函数，从函数返回。对函数值（function value）的调用类似函数调用。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">add</span><span style="color:#111">(</span><span style="color:#75af00">a</span><span style="color:#111">,</span><span style="color:#75af00">b</span> <span style="color:#00a8c8">int</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#75af00">sum</span> <span style="color:#00a8c8">int</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">sum</span> <span style="color:#111">=</span> <span style="color:#75af00">a</span> <span style="color:#f92672">+</span> <span style="color:#75af00">b</span> 
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">f</span> <span style="color:#111">=</span> <span style="color:#75af00">add</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">sum</span><span style="color:#111">(</span><span style="color:#ae81ff">1</span><span style="color:#111">,</span><span style="color:#ae81ff">2</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>函数类型的零值是nil。调用值为nil的函数值会引起panic错误：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">var</span> <span style="color:#75af00">f</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#00a8c8">int</span><span style="color:#111">)</span> <span style="color:#00a8c8">int</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">f</span><span style="color:#111">(</span><span style="color:#ae81ff">3</span><span style="color:#111">)</span> <span style="color:#75715e">// 此处f的值为nil, 会引起panic错误</span>
</span></span></code></pre></div><h2 id="匿名函数">匿名函数</h2>
<p>拥有函数名的函数只能在包级语法块中被声明，通过函数字面量（function literal），我们可绕过这一限制，在任何表达式中表示一个函数值。函数字面量的语法和函数声明相似，区别在于func关键字后没有函数名。函数值字面量是一种表达式，它的值被成为匿名函数（anonymous function）。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">squares</span><span style="color:#111">()</span> <span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#00a8c8">int</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">var</span> <span style="color:#75af00">x</span> <span style="color:#00a8c8">int</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#00a8c8">int</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">x</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">x</span> <span style="color:#f92672">*</span> <span style="color:#75af00">x</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">f</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">squares</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">f</span><span style="color:#111">())</span> <span style="color:#75715e">// &#34;1&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">f</span><span style="color:#111">())</span> <span style="color:#75715e">// &#34;4&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">f</span><span style="color:#111">())</span> <span style="color:#75715e">// &#34;9&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">f</span><span style="color:#111">())</span> <span style="color:#75715e">// &#34;16&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="可变参数">可变参数</h2>
<p>参数数量可变的函数称为为可变参数函数。典型的例子就是fmt.Printf和类似函数。Printf首先接收一个的必备参数，之后接收任意个数的后续参数。</p>
<p>在声明可变参数函数时，需要在参数列表的最后一个参数类型之前加上省略符号“&hellip;”，这表示该函数会接收任意数量的该类型参数。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">sum</span><span style="color:#111">(</span><span style="color:#ae81ff">1</span><span style="color:#111">,</span><span style="color:#ae81ff">2</span><span style="color:#111">,</span><span style="color:#ae81ff">3</span><span style="color:#111">,</span><span style="color:#ae81ff">4</span><span style="color:#111">,</span><span style="color:#ae81ff">5</span><span style="color:#111">))</span> <span style="color:#75715e">// 15</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">var</span> <span style="color:#75af00">sli</span> <span style="color:#111">=</span> <span style="color:#111">[]</span><span style="color:#00a8c8">int</span><span style="color:#111">{</span><span style="color:#ae81ff">1</span><span style="color:#111">,</span><span style="color:#ae81ff">2</span><span style="color:#111">,</span><span style="color:#ae81ff">3</span><span style="color:#111">,</span><span style="color:#ae81ff">4</span><span style="color:#111">,</span><span style="color:#ae81ff">5</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">sli</span><span style="color:#111">)</span>		<span style="color:#75715e">// [1 2 3 4 5]</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">sum</span><span style="color:#111">(</span><span style="color:#75af00">sli</span><span style="color:#f92672">...</span><span style="color:#111">))</span> <span style="color:#75715e">// 15</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">sum</span><span style="color:#111">(</span><span style="color:#75af00">values</span> <span style="color:#f92672">...</span><span style="color:#00a8c8">int</span><span style="color:#111">)</span> <span style="color:#00a8c8">int</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">sum</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">v</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">values</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">sum</span> <span style="color:#f92672">+=</span> <span style="color:#75af00">v</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">sum</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="panic异常">Panic异常</h2>
<p>Go的类型系统会在编译时捕获很多错误，但有些错误只能在运行时检查，如数组访问越界、空指针引用等。这些运行时错误会引起painc异常。</p>
<p>一般而言，<strong>当panic异常发生时，程序会中断运行</strong>，并执行此goroute上的defer函数。</p>
<p>当某些不应该发生的场景发生时，我们就应该调用panic。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">name</span> <span style="color:#f92672">:=</span> <span style="color:#d88200">&#34;zhaohaiyu&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">switch</span> <span style="color:#75af00">name</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">case</span> <span style="color:#d88200">&#34;zhy&#34;</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;zhy&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">case</span> <span style="color:#d88200">&#34;haiyuzhao&#34;</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;haiyuzhao&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">default</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#d88200">&#34;没有这个名字&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span></code></pre></div><p>虽然Go的panic机制类似于其他语言的异常，但panic的适用场景有一些不同。由于panic会引起程序的崩溃，因此panic一般用于严重错误，如程序内部的逻辑不一致。</p>
<h2 id="recover捕获异常">Recover捕获异常</h2>
<p>通常来说，不应该对panic异常做任何处理，但有时，也许我们可以从异常中恢复，至少我们可以在程序崩溃前，做一些操作。</p>
<p>如果在deferred函数中调用了内置函数recover，并且定义该defer语句的函数发生了panic异常，recover会使程序从panic中恢复，并返回panic value。导致panic异常的函数不会继续运行，但能正常返回。在未发生panic时调用recover，recover会返回nil。</p>
<p>让我们以语言解析器为例，说明recover的使用场景。考虑到语言解析器的复杂性，即使某个语言解析器目前工作正常，也无法肯定它没有漏洞。因此，当某个异常出现时，我们不会选择让解析器崩溃，而是会将panic异常当作普通的解析错误，并附加额外信息提醒用户报告此错误。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">defer</span> <span style="color:#00a8c8">func</span> <span style="color:#111">()</span>  <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">p</span> <span style="color:#f92672">:=</span> <span style="color:#111">recover</span><span style="color:#111">();</span>  <span style="color:#75af00">p</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">p</span><span style="color:#111">)</span>  <span style="color:#75715e">// 主动抛错</span>
</span></span><span style="display:flex;"><span>            	<span style="color:#75715e">// 可以进行写日志等操作</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#d88200">&#34;主动抛错&#34;</span><span style="color:#111">)</span>
</span></span></code></pre></div>]]></content:encoded><category>go</category><category>go</category></item><item><title>golang基础类型</title><link>https://daemon365.dev/post/go/golang_basic_types/</link><pubDate>Sat, 22 Jun 2019 00:00:00 +0800</pubDate><guid>https://daemon365.dev/post/go/golang_basic_types/</guid><description>&lt;h2 id="整型"&gt;整型&lt;/h2&gt;
&lt;p&gt;Go语言同时提供了有符号和无符号类型的整数运算。这里有&lt;strong&gt;int8&lt;/strong&gt;、&lt;strong&gt;int16&lt;/strong&gt;、&lt;strong&gt;int32&lt;/strong&gt;和&lt;strong&gt;int64&lt;/strong&gt;四种截然不同大小的有符号整数类型，分别对应8、16、32、64bit大小的有符号整数，与此对应的是&lt;strong&gt;uint8&lt;/strong&gt;、&lt;strong&gt;uint16&lt;/strong&gt;、&lt;strong&gt;uint32&lt;/strong&gt;和&lt;strong&gt;uint64&lt;/strong&gt;四种无符号整数类型。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Unicode字符rune类型是和int32等价的类型，通常用于表示一个Unicode码点&lt;/strong&gt;。这两个名称可以互换使用。同样byte也是uint8类型的等价类型，byte类型一般用于强调数值是一个原始的数据而不是一个小的整数。&lt;/p&gt;
&lt;p&gt;下面是Go语言中关于算术运算、逻辑运算和比较运算的二元运算符，它们按照优先级递减的顺序排列：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;*&lt;/span&gt; &lt;span style="color:#f92672"&gt;/&lt;/span&gt; &lt;span style="color:#f92672"&gt;%&lt;/span&gt; &lt;span style="color:#111"&gt;&amp;gt;&lt;/span&gt; &lt;span style="color:#f92672"&gt;&amp;amp;&lt;/span&gt; &lt;span style="color:#f92672"&gt;&amp;amp;^&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;+&lt;/span&gt; &lt;span style="color:#f92672"&gt;-&lt;/span&gt; &lt;span style="color:#111"&gt;|&lt;/span&gt; &lt;span style="color:#111"&gt;^&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;==&lt;/span&gt; &lt;span style="color:#f92672"&gt;!=&lt;/span&gt; &lt;span style="color:#f92672"&gt;&amp;gt;=&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;&amp;amp;&amp;amp;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;||&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;两个相同的整数类型可以使用下面的二元比较运算符进行比较；比较表达式的结果是布尔类型。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;==&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 等于&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;!=&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 不等于&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;&amp;lt;&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 小于&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;&amp;lt;=&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 小于等于&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;&amp;gt;&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 大于&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;&amp;gt;=&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 大于等于&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id="浮点型"&gt;浮点型&lt;/h2&gt;
&lt;p&gt;Go语言提供了两种精度的浮点数，&lt;strong&gt;float32&lt;/strong&gt;和&lt;strong&gt;float64&lt;/strong&gt;。它们的算术规范由&lt;strong&gt;IEEE754浮点数&lt;/strong&gt;国际标准定义，该浮点数规范被所有现代的CPU支持。&lt;/p&gt;
&lt;p&gt;float32类型的浮点数可以提供大约6个十进制数的精度，而float64则可以提供约15个十进制数的精度；通常应该优先使用float64类型，因为float32类型的累计计算误差很容易扩散，&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;var&lt;/span&gt; &lt;span style="color:#75af00"&gt;f&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;float32&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;212213&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;f&lt;/span&gt; &lt;span style="color:#f92672"&gt;==&lt;/span&gt; &lt;span style="color:#75af00"&gt;f&lt;/span&gt; &lt;span style="color:#f92672"&gt;+&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;1&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id="复数"&gt;复数&lt;/h2&gt;
&lt;p&gt;Go语言提供了两种精度的复数类型：&lt;strong&gt;complex64&lt;/strong&gt;和&lt;strong&gt;complex128&lt;/strong&gt;，分别对应float32和float64两种浮点数精度。内置的complex函数用于构建复数，内建的real和imag函数分别返回复数的实部和虚部：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;var&lt;/span&gt; &lt;span style="color:#75af00"&gt;x&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;complex128&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#111"&gt;complex&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;1&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;2&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 1+2i&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;var&lt;/span&gt; &lt;span style="color:#75af00"&gt;y&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;complex128&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#111"&gt;complex&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;3&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;4&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 3+4i&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;x&lt;/span&gt;&lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;y&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75715e"&gt;// &amp;#34;(-5+10i)&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#111"&gt;real&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;x&lt;/span&gt;&lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;y&lt;/span&gt;&lt;span style="color:#111"&gt;))&lt;/span&gt; &lt;span style="color:#75715e"&gt;// &amp;#34;-5&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#111"&gt;imag&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;x&lt;/span&gt;&lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;y&lt;/span&gt;&lt;span style="color:#111"&gt;))&lt;/span&gt; &lt;span style="color:#75715e"&gt;// &amp;#34;10&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id="4布尔型"&gt;4.布尔型&lt;/h2&gt;
&lt;p&gt;一个布尔类型的值只有两种：&lt;strong&gt;true&lt;/strong&gt;和&lt;strong&gt;false&lt;/strong&gt;。if和for语句的条件部分都是布尔类型的值，并且==和&amp;lt;等比较操作也会产生布尔型的值, 布尔值可以和&amp;amp;&amp;amp;（AND）和||（OR）操作符结合&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;!&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;true&lt;/span&gt; &lt;span style="color:#75715e"&gt;// flase&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75af00"&gt;a&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;10&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75af00"&gt;a&lt;/span&gt; &lt;span style="color:#111"&gt;&amp;gt;&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;1&lt;/span&gt; &lt;span style="color:#75715e"&gt;// true&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id="字符串"&gt;字符串&lt;/h2&gt;
&lt;p&gt;&lt;strong&gt;一个字符串是一个不可改变的字节序列&lt;/strong&gt;。字符串可以包含任意的数据，包括byte值0，但是通常是用来包含人类可读的文本。文本字符串通常被解释为&lt;strong&gt;采用UTF8编码的Unicode码点（rune）序列&lt;/strong&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75af00"&gt;s&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;hello, world&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#111"&gt;len&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;s&lt;/span&gt;&lt;span style="color:#111"&gt;))&lt;/span&gt; &lt;span style="color:#75715e"&gt;// &amp;#34;12&amp;#34; len() 长度&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;s&lt;/span&gt;&lt;span style="color:#111"&gt;[&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;0&lt;/span&gt;&lt;span style="color:#111"&gt;],&lt;/span&gt; &lt;span style="color:#75af00"&gt;s&lt;/span&gt;&lt;span style="color:#111"&gt;[&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;7&lt;/span&gt;&lt;span style="color:#111"&gt;])&lt;/span&gt; &lt;span style="color:#75715e"&gt;// &amp;#34;104 119&amp;#34; (&amp;#39;h&amp;#39; and &amp;#39;w&amp;#39;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;字符串值也可以用字符串面值方式编写，只要将一系列字节序列包含在双引号即可：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;Hello, 世界&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;img src="https://daemon365.dev/Users/zhaohaiyu/img/877190903_1600071551280_B5224ACBE813EE6BA0B389CA43E206A8.png" alt=""&gt;&lt;/p&gt;
&lt;p&gt;因为Go语言源文件总是用UTF8编码，并且Go语言的文本字符串也以UTF8编码的方式处理，因此我们可以将Unicode码点也写到字符串面值中。&lt;/p&gt;
&lt;p&gt;在一个双引号包含的字符串面值中，可以用以反斜杠\开头的转义序列插入任意的数据。下面的换行、回车和制表符等是常见的ASCII控制代码的转义方式：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;\&lt;/span&gt;&lt;span style="color:#75af00"&gt;a&lt;/span&gt; &lt;span style="color:#75af00"&gt;响铃&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;\&lt;/span&gt;&lt;span style="color:#75af00"&gt;b&lt;/span&gt; &lt;span style="color:#75af00"&gt;退格&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;\&lt;/span&gt;&lt;span style="color:#75af00"&gt;f&lt;/span&gt; &lt;span style="color:#75af00"&gt;换页&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;\&lt;/span&gt;&lt;span style="color:#75af00"&gt;n&lt;/span&gt; &lt;span style="color:#75af00"&gt;换行&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;\&lt;/span&gt;&lt;span style="color:#75af00"&gt;r&lt;/span&gt; &lt;span style="color:#75af00"&gt;回车&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;\&lt;/span&gt;&lt;span style="color:#75af00"&gt;t&lt;/span&gt; &lt;span style="color:#75af00"&gt;制表符&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;\&lt;/span&gt;&lt;span style="color:#75af00"&gt;v&lt;/span&gt; &lt;span style="color:#75af00"&gt;垂直制表符&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;\&amp;#39;&lt;/span&gt; &lt;span style="color:#75af00"&gt;单引号&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;只用在&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#39;\&amp;#39;&amp;#39;&lt;/span&gt; &lt;span style="color:#75af00"&gt;形式的rune符号面值中&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;\&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34; 双引号 (只用在 &amp;#34;&lt;/span&gt;&lt;span style="color:#f92672"&gt;...&lt;/span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&amp;#34;&lt;/span&gt; &lt;span style="color:#75af00"&gt;形式的字符串面值中&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;\\&lt;/span&gt; &lt;span style="color:#75af00"&gt;反斜杠&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id="unicode"&gt;Unicode&lt;/h3&gt;
&lt;p&gt;因为计算机只能处理数字，如果要处理文本，就必须先把文本转换为数字才能处理。最早的计算机在设计时采用8个比特（bit）作为一个字节（byte）。一个字节能表示的最大的整数就是255（2^8-1=255），而ASCII编码，占用0 - 127用来表示大小写英文字母、数字和一些符号，这个编码表被称为&lt;a href="https://baike.baidu.com/item/ASCII%E7%BC%96%E7%A0%81/3712529"&gt;ASCII编码&lt;/a&gt;，比如大写字母A的编码是65，小写字母z的编码是122。&lt;/p&gt;</description><content:encoded><![CDATA[<h2 id="整型">整型</h2>
<p>Go语言同时提供了有符号和无符号类型的整数运算。这里有<strong>int8</strong>、<strong>int16</strong>、<strong>int32</strong>和<strong>int64</strong>四种截然不同大小的有符号整数类型，分别对应8、16、32、64bit大小的有符号整数，与此对应的是<strong>uint8</strong>、<strong>uint16</strong>、<strong>uint32</strong>和<strong>uint64</strong>四种无符号整数类型。</p>
<p><strong>Unicode字符rune类型是和int32等价的类型，通常用于表示一个Unicode码点</strong>。这两个名称可以互换使用。同样byte也是uint8类型的等价类型，byte类型一般用于强调数值是一个原始的数据而不是一个小的整数。</p>
<p>下面是Go语言中关于算术运算、逻辑运算和比较运算的二元运算符，它们按照优先级递减的顺序排列：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">*</span>      <span style="color:#f92672">/</span>      <span style="color:#f92672">%</span>      <span style="color:#111">&gt;</span>     <span style="color:#f92672">&amp;</span>       <span style="color:#f92672">&amp;^</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>      <span style="color:#f92672">-</span>      <span style="color:#111">|</span>      <span style="color:#111">^</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">==</span>     <span style="color:#f92672">!=</span>           <span style="color:#f92672">&gt;=</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&amp;&amp;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">||</span>
</span></span></code></pre></div><p>两个相同的整数类型可以使用下面的二元比较运算符进行比较；比较表达式的结果是布尔类型。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">==</span>    <span style="color:#75715e">// 等于</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">!=</span>    <span style="color:#75715e">// 不等于</span>
</span></span><span style="display:flex;"><span><span style="color:#111">&lt;</span>     <span style="color:#75715e">// 小于</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;=</span>    <span style="color:#75715e">// 小于等于</span>
</span></span><span style="display:flex;"><span><span style="color:#111">&gt;</span>     <span style="color:#75715e">// 大于</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&gt;=</span>    <span style="color:#75715e">// 大于等于</span>
</span></span></code></pre></div><h2 id="浮点型">浮点型</h2>
<p>Go语言提供了两种精度的浮点数，<strong>float32</strong>和<strong>float64</strong>。它们的算术规范由<strong>IEEE754浮点数</strong>国际标准定义，该浮点数规范被所有现代的CPU支持。</p>
<p>float32类型的浮点数可以提供大约6个十进制数的精度，而float64则可以提供约15个十进制数的精度；通常应该优先使用float64类型，因为float32类型的累计计算误差很容易扩散，</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">var</span> <span style="color:#75af00">f</span> <span style="color:#00a8c8">float32</span> <span style="color:#111">=</span> <span style="color:#ae81ff">212213</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">f</span> <span style="color:#f92672">==</span> <span style="color:#75af00">f</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span><span style="color:#111">)</span>
</span></span></code></pre></div><h2 id="复数">复数</h2>
<p>Go语言提供了两种精度的复数类型：<strong>complex64</strong>和<strong>complex128</strong>，分别对应float32和float64两种浮点数精度。内置的complex函数用于构建复数，内建的real和imag函数分别返回复数的实部和虚部：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">var</span> <span style="color:#75af00">x</span> <span style="color:#00a8c8">complex128</span> <span style="color:#111">=</span> <span style="color:#111">complex</span><span style="color:#111">(</span><span style="color:#ae81ff">1</span><span style="color:#111">,</span> <span style="color:#ae81ff">2</span><span style="color:#111">)</span> <span style="color:#75715e">// 1+2i</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">var</span> <span style="color:#75af00">y</span> <span style="color:#00a8c8">complex128</span> <span style="color:#111">=</span> <span style="color:#111">complex</span><span style="color:#111">(</span><span style="color:#ae81ff">3</span><span style="color:#111">,</span> <span style="color:#ae81ff">4</span><span style="color:#111">)</span> <span style="color:#75715e">// 3+4i</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">x</span><span style="color:#f92672">*</span><span style="color:#75af00">y</span><span style="color:#111">)</span>                 <span style="color:#75715e">// &#34;(-5+10i)&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#111">real</span><span style="color:#111">(</span><span style="color:#75af00">x</span><span style="color:#f92672">*</span><span style="color:#75af00">y</span><span style="color:#111">))</span>           <span style="color:#75715e">// &#34;-5&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#111">imag</span><span style="color:#111">(</span><span style="color:#75af00">x</span><span style="color:#f92672">*</span><span style="color:#75af00">y</span><span style="color:#111">))</span>           <span style="color:#75715e">// &#34;10&#34;</span>
</span></span></code></pre></div><h2 id="4布尔型">4.布尔型</h2>
<p>一个布尔类型的值只有两种：<strong>true</strong>和<strong>false</strong>。if和for语句的条件部分都是布尔类型的值，并且==和&lt;等比较操作也会产生布尔型的值, 布尔值可以和&amp;&amp;（AND）和||（OR）操作符结合</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#111">!</span><span style="color:#00a8c8">true</span> <span style="color:#75715e">// flase</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">a</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">10</span> 
</span></span><span style="display:flex;"><span><span style="color:#75af00">a</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">1</span>  <span style="color:#75715e">// true</span>
</span></span></code></pre></div><h2 id="字符串">字符串</h2>
<p><strong>一个字符串是一个不可改变的字节序列</strong>。字符串可以包含任意的数据，包括byte值0，但是通常是用来包含人类可读的文本。文本字符串通常被解释为<strong>采用UTF8编码的Unicode码点（rune）序列</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">s</span> <span style="color:#f92672">:=</span> <span style="color:#d88200">&#34;hello, world&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">s</span><span style="color:#111">))</span>     <span style="color:#75715e">// &#34;12&#34; len() 长度</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">s</span><span style="color:#111">[</span><span style="color:#ae81ff">0</span><span style="color:#111">],</span> <span style="color:#75af00">s</span><span style="color:#111">[</span><span style="color:#ae81ff">7</span><span style="color:#111">])</span> <span style="color:#75715e">// &#34;104 119&#34; (&#39;h&#39; and &#39;w&#39;)</span>
</span></span></code></pre></div><p>字符串值也可以用字符串面值方式编写，只要将一系列字节序列包含在双引号即可：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#d88200">&#34;Hello, 世界&#34;</span>
</span></span></code></pre></div><p><img src="/Users/zhaohaiyu/img/877190903_1600071551280_B5224ACBE813EE6BA0B389CA43E206A8.png" alt=""></p>
<p>因为Go语言源文件总是用UTF8编码，并且Go语言的文本字符串也以UTF8编码的方式处理，因此我们可以将Unicode码点也写到字符串面值中。</p>
<p>在一个双引号包含的字符串面值中，可以用以反斜杠\开头的转义序列插入任意的数据。下面的换行、回车和制表符等是常见的ASCII控制代码的转义方式：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">\</span><span style="color:#75af00">a</span>      <span style="color:#75af00">响铃</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">\</span><span style="color:#75af00">b</span>      <span style="color:#75af00">退格</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">\</span><span style="color:#75af00">f</span>      <span style="color:#75af00">换页</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">\</span><span style="color:#75af00">n</span>      <span style="color:#75af00">换行</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">\</span><span style="color:#75af00">r</span>      <span style="color:#75af00">回车</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">\</span><span style="color:#75af00">t</span>      <span style="color:#75af00">制表符</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">\</span><span style="color:#75af00">v</span>      <span style="color:#75af00">垂直制表符</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">\&#39;</span>      <span style="color:#75af00">单引号</span> <span style="color:#111">(</span><span style="color:#75af00">只用在</span> <span style="color:#d88200">&#39;\&#39;&#39;</span> <span style="color:#75af00">形式的rune符号面值中</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">\</span><span style="color:#d88200">&#34;      双引号 (只用在 &#34;</span><span style="color:#f92672">...</span><span style="color:#960050;background-color:#1e0010">&#34;</span> <span style="color:#75af00">形式的字符串面值中</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">\\</span>      <span style="color:#75af00">反斜杠</span>
</span></span></code></pre></div><h3 id="unicode">Unicode</h3>
<p>因为计算机只能处理数字，如果要处理文本，就必须先把文本转换为数字才能处理。最早的计算机在设计时采用8个比特（bit）作为一个字节（byte）。一个字节能表示的最大的整数就是255（2^8-1=255），而ASCII编码，占用0 - 127用来表示大小写英文字母、数字和一些符号，这个编码表被称为<a href="https://baike.baidu.com/item/ASCII%E7%BC%96%E7%A0%81/3712529">ASCII编码</a>，比如大写字母A的编码是65，小写字母z的编码是122。</p>
<p>如果要表示中文，显然一个字节是不够的，至少需要两个字节，而且还不能和ASCII编码冲突，所以，中国制定了<a href="https://baike.baidu.com/item/GB2312/483170">GB2312</a>编码，用来把中文编进去。</p>
<p>类似的，日文和韩文等其他语言也有这个问题。为了统一所有文字的编码，Unicode应运而生。Unicode把所有语言都统一到一套编码里，这样就不会再有乱码问题了。</p>
<p>Unicode通常用两个字节表示一个字符，原有的英文编码从单字节变成双字节，只需要把高字节全部填为0就可以。</p>
<h3 id="utf-8">UTF-8</h3>
<p>UTF-8（8位元，Universal Character Set/Unicode Transformation Format）是针对Unicode的一种可变长度字符编码。它可以用来表示Unicode标准中的任何字符，而且其编码中的第一个字节仍与<a href="https://baike.baidu.com/item/ASCII/309296">ASCII</a>相容，使得原来处理ASCII字符的软件无须或只进行少部份修改后，便可继续使用。因此，它逐渐成为<a href="https://baike.baidu.com/item/%E7%94%B5%E5%AD%90%E9%82%AE%E4%BB%B6/111106">电子邮件</a>、网页及其他存储或传送文字的应用中，优先采用的编码。</p>
<h3 id="字符串和byte切片">字符串和Byte切片</h3>
<p>标准库中有四个包对字符串处理尤为重要：<strong>bytes</strong>、<strong>strings</strong>、<strong>strconv</strong>和<strong>unicode</strong>包。</p>
<ul>
<li>strings包提供了许多如字符串的查询、替换、比较、截断、拆分和合并等功能。</li>
<li>bytes包也提供了很多类似功能的函数，但是针对和字符串有着相同结构的[]byte类型。因为字符串是只读的，因此逐步构建字符串会导致很多分配和复制。在这种情况下，使用bytes.Buffer类型将会更有效，稍后我们将展示。</li>
<li>strconv包提供了布尔型、整型数、浮点数和对应字符串的相互转换，还提供了双引号转义相关的转换。</li>
<li>unicode包提供了IsDigit、IsLetter、IsUpper和IsLower等类似功能，它们用于给字符分类。每个函数有一个单一的rune类型的参数，然后返回一个布尔值。而像ToUpper和ToLower之类的转换函数将用于rune字符的大小写转换。所有的这些函数都是遵循Unicode标准定义的字母、数字等分类规范。strings包也有类似的函数，它们是ToUpper和ToLower，将原始字符串的每个字符都做相应的转换，然后返回新的字符串。</li>
<li>path和path/filepath包提供了关于文件路径名更一般的函数操作。使用斜杠分隔路径可以在任何操作系统上工作。斜杠本身不应该用于文件名，但是在其他一些领域可能会用于文件名，例如URL路径组件。相比之下，path/filepath包则使用操作系统本身的路径规则，例如POSIX系统使用/foo/bar，而Microsoft Windows使用c:\foo\bar等。</li>
<li>当向bytes.Buffer添加任意字符的UTF8编码时，最好使用bytes.Buffer的WriteRune方法，但是WriteByte方法对于写入类似&rsquo;[&lsquo;和&rsquo;]&lsquo;等ASCII字符则会更加有效。</li>
<li>bytes.Buffer类型有着很多实用的功能，我们在第七章讨论接口时将会涉及到，我们将看看如何将它用作一个I/O的输入和输出对象，例如当做Fprintf的io.Writer输出对象，或者当作io.Reader类型的输入源对象。</li>
</ul>
<h3 id="字符串和数字的转换">字符串和数字的转换</h3>
<p>除了字符串、字符、字节之间的转换，字符串和数值之间的转换也比较常见。由strconv包提供这类转换功能。</p>
<p>将一个整数转为字符串，一种方法是用fmt.Sprintf返回一个格式化的字符串；另一个方法是用strconv.Itoa(“整数到ASCII”)：</p>
<pre tabindex="0"><code>x := 123
y := fmt.Sprintf(&#34;%d&#34;, x)
fmt.Println(y, strconv.Itoa(x)) // &#34;123 123&#34;
</code></pre><p>FormatInt和FormatUint函数可以用不同的进制来格式化数字：</p>
<pre tabindex="0"><code>fmt.Println(strconv.FormatInt(int64(x), 2)) // &#34;1111011&#34;
</code></pre><p>fmt.Printf函数的%b、%d、%o和%x等参数提供功能往往比strconv包的Format函数方便很多，特别是在需要包含附加额外信息的时候：</p>
<pre tabindex="0"><code>s := fmt.Sprintf(&#34;x=%b&#34;, x) // &#34;x=1111011&#34;
</code></pre><p>如果要将一个字符串解析为整数，可以使用strconv包的Atoi或ParseInt函数，还有用于解析无符号整数的ParseUint函数：</p>
<pre tabindex="0"><code>x, err := strconv.Atoi(&#34;123&#34;)             // x is an int
y, err := strconv.ParseInt(&#34;123&#34;, 10, 64) // base 10, up to 64 bits
</code></pre><p>ParseInt函数的第三个参数是用于指定整型数的大小；例如16表示int16，0则表示int。在任何情况下，返回的结果y总是int64类型，你可以通过强制类型转换将它转为更小的整数类型。</p>
<h2 id="常量">常量</h2>
<p>常量表达式的值在编译期计算，而不是在运行期。每种常量的潜在类型都是基础类型：boolean、string、浮点型或整型。常量不可改变,一个常量的声明也可以包含一个类型和一个值，但是如果没有显式指明类型，那么将从右边的表达式推断类型。</p>
<p>const 声明:</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">const</span>  <span style="color:#75af00">a</span> <span style="color:#111">=</span> <span style="color:#ae81ff">10</span>				<span style="color:#75715e">// 整型</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">const</span>  <span style="color:#75af00">p</span> <span style="color:#111">=</span> <span style="color:#ae81ff">3.1415926</span> 		<span style="color:#75715e">// 浮点型</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">const</span>  <span style="color:#75af00">str</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;zhaohaiyu&#34;</span>	<span style="color:#75715e">// 字符串</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">const</span>  <span style="color:#75af00">flag</span> <span style="color:#111">=</span> <span style="color:#00a8c8">true</span>			<span style="color:#75715e">// 布尔型</span>
</span></span></code></pre></div><p>如果是批量声明的常量，除了第一个外其它的常量右边的初始化表达式都可以省略，如果省略初始化表达式则表示使用前面常量的初始化表达式写法，对应的常量类型也一样的。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">const</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">a</span> <span style="color:#111">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">b</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">c</span> <span style="color:#111">=</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">d</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">a</span><span style="color:#111">,</span> <span style="color:#75af00">b</span><span style="color:#111">,</span> <span style="color:#75af00">c</span><span style="color:#111">,</span> <span style="color:#75af00">d</span><span style="color:#111">)</span> <span style="color:#75715e">// &#34;1 1 2 2&#34;</span>
</span></span></code></pre></div><h3 id="iota-常量生成器">iota 常量生成器</h3>
<p>常量声明可以使用iota常量生成器初始化，它用于生成一组以相似规则初始化的常量，但是不用每行都写一遍初始化表达式。在一个const声明语句中，在第一个声明的常量所在的行，iota将会被置为0，然后在每一个有常量声明的行加一。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">const</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">a</span> <span style="color:#111">=</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">+</span> <span style="color:#00a8c8">iota</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">b</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">c</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">d</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">a</span><span style="color:#111">,</span><span style="color:#75af00">b</span><span style="color:#111">,</span><span style="color:#75af00">c</span><span style="color:#111">,</span><span style="color:#75af00">d</span><span style="color:#111">)</span> <span style="color:#75715e">// 1,2,3,4</span>
</span></span></code></pre></div>]]></content:encoded><category>go</category><category>go</category></item><item><title>golang基础结构</title><link>https://daemon365.dev/post/go/golang_infrastructure/</link><pubDate>Sat, 22 Jun 2019 00:00:00 +0800</pubDate><guid>https://daemon365.dev/post/go/golang_infrastructure/</guid><description>&lt;h2 id="命名"&gt;命名&lt;/h2&gt;
&lt;p&gt;Go语言中的&lt;strong&gt;函数名&lt;/strong&gt;、&lt;strong&gt;变量名&lt;/strong&gt;、&lt;strong&gt;常量名&lt;/strong&gt;、&lt;strong&gt;类型名&lt;/strong&gt;、&lt;strong&gt;语句标号&lt;/strong&gt;和&lt;strong&gt;包名&lt;/strong&gt;等所有的命名,都遵循一个简单的命名规则：一个名字必须以一个字母（Unicode字母）或下划线开头,后面可以跟任意数量的&lt;strong&gt;字母&lt;/strong&gt;、&lt;strong&gt;数字&lt;/strong&gt;或&lt;strong&gt;下划线&lt;/strong&gt;.大写字母和小写字母是不同的：heapSort和Heapsort是两个不同的名字.&lt;/p&gt;
&lt;p&gt;Go语言的&lt;strong&gt;关键字&lt;/strong&gt;有25个,关键字&lt;strong&gt;不能用于自定义名字&lt;/strong&gt;. 分别为:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;break&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;default&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;interface&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;select&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;case&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;defer&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;go&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;map&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;struct&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;chan&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;else&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;goto&lt;/span&gt; &lt;span style="color:#f92672"&gt;package&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;switch&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;const&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;fallthrough&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;range&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;type&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;continue&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;for&lt;/span&gt; &lt;span style="color:#f92672"&gt;import&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;var&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;还有大约30多个预定义的名字,这些内部预先定义的名字并不是关键字，你可以在定义中重新使用它们。在一些特殊的场景中重新定义它们也是有意义的，但是也要注意避免过度而引起语义混乱.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75af00"&gt;内建常量&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;true&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;false&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;iota&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75af00"&gt;内建类型&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;int&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;int8&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;int16&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;int32&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;int64&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;uint&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;uint8&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;uint16&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;uint32&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;uint64&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;uintptr&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;float32&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;float64&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;complex128&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;complex64&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;bool&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;byte&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;rune&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;string&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;error&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75af00"&gt;内建函数&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#75af00"&gt;make&lt;/span&gt; &lt;span style="color:#75af00"&gt;len&lt;/span&gt; &lt;span style="color:#75af00"&gt;cap&lt;/span&gt; &lt;span style="color:#75af00"&gt;new&lt;/span&gt; &lt;span style="color:#75af00"&gt;append&lt;/span&gt; &lt;span style="color:#75af00"&gt;copy&lt;/span&gt; &lt;span style="color:#75af00"&gt;close&lt;/span&gt; &lt;span style="color:#75af00"&gt;delete&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;complex&lt;/span&gt; &lt;span style="color:#75af00"&gt;real&lt;/span&gt; &lt;span style="color:#75af00"&gt;imag&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;panic&lt;/span&gt; &lt;span style="color:#75af00"&gt;recover&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;在习惯上，Go语言程序员推荐使用 &lt;em&gt;&lt;strong&gt;驼峰式&lt;/strong&gt;&lt;/em&gt; 命名，当名字有几个单词组成的时优先使用大小写分隔，而不是优先用下划线分隔。&lt;/p&gt;
&lt;h2 id="声明"&gt;声明&lt;/h2&gt;
&lt;p&gt;Go语言主要有四种类型的声明语句：&lt;strong&gt;var&lt;/strong&gt;、&lt;strong&gt;const&lt;/strong&gt;、&lt;strong&gt;type&lt;/strong&gt;和&lt;strong&gt;func&lt;/strong&gt;，分别对应&lt;strong&gt;变量&lt;/strong&gt;、&lt;strong&gt;常量&lt;/strong&gt;、&lt;strong&gt;类型&lt;/strong&gt;和&lt;strong&gt;函数实体对象&lt;/strong&gt;的声明。&lt;/p&gt;
&lt;p&gt;一个Go语言编写的程序对应一个或多个以.go为文件后缀名的源文件中。每个源文件以包的声明语句开始，说明该源文件是属于哪个包。包声明语句之后是import语句导入依赖的其它包，然后是包一级的类型、变量、常量、函数的声明语句.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;package&lt;/span&gt; &lt;span style="color:#75af00"&gt;main&lt;/span&gt; &lt;span style="color:#75715e"&gt;// main包&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;import&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;fmt&amp;#34;&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 引入fmt内部包&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;const&lt;/span&gt; &lt;span style="color:#75af00"&gt;price&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;212.0&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 浮点型常量&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;main&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;var&lt;/span&gt; &lt;span style="color:#75af00"&gt;f&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#75af00"&gt;price&lt;/span&gt; &lt;span style="color:#75715e"&gt;// f浮点型变量&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;var&lt;/span&gt; &lt;span style="color:#75af00"&gt;c&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;f&lt;/span&gt; &lt;span style="color:#f92672"&gt;-&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;32&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;5&lt;/span&gt; &lt;span style="color:#f92672"&gt;/&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;9&lt;/span&gt; &lt;span style="color:#75715e"&gt;// c浮点型变量&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Printf&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;f = %g c = %g\n&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;f&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;c&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75715e"&gt;// %g为浮点型占位符&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Printf&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;f:%T,c:%T&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;f&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;c&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75715e"&gt;// %T为打印类型 结果:f:float64,c:float64&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id="变量"&gt;变量&lt;/h2&gt;
&lt;p&gt;var声明语句可以创建一个特定类型的变量，然后给变量附加一个名字，并且设置变量的初始值。变量声明的一般语法如下：&lt;/p&gt;
&lt;p&gt;var 变量名字 类型 = 表达式&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;// 例如&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;var&lt;/span&gt; &lt;span style="color:#75af00"&gt;name&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;string&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;zhy&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;其中“&lt;em&gt;类型&lt;/em&gt;”或“&lt;em&gt;= 表达式&lt;/em&gt;”两个部分可以省略其中的一个。如果省略的是类型信息，那么将根据初始化表达式来推导变量的类型信息。如果初始化表达式被省略，那么将用零值初始化该变量。 数值类型变量对应的零值是0，布尔类型变量对应的零值是false，字符串类型对应的零值是空字符串，接口或引用类型（包括slice、指针、map、chan和函数）变量对应的零值是nil。数组或结构体等聚合类型对应的零值是每个元素或字段都是对应该类型的零值。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;var&lt;/span&gt; &lt;span style="color:#75af00"&gt;s&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;string&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;s&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75715e"&gt;// &amp;#34;&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;也可以在一个声明语句中同时声明一组变量，或用一组初始化表达式声明并初始化一组变量。如果省略每个变量的类型，将可以声明多个类型不同的变量（&lt;strong&gt;类型由初始化表达式推导&lt;/strong&gt;）：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;var&lt;/span&gt; &lt;span style="color:#75af00"&gt;i&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;j&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;k&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;int&lt;/span&gt; &lt;span style="color:#75715e"&gt;// int, int, int&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;var&lt;/span&gt; &lt;span style="color:#75af00"&gt;b&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;f&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;s&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;true&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;2.3&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;four&amp;#34;&lt;/span&gt; &lt;span style="color:#75715e"&gt;// bool, float64, string&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;一组变量也可以通过调用一个函数，由&lt;strong&gt;函数返回的多个返回值&lt;/strong&gt;初始化：&lt;/p&gt;</description><content:encoded><![CDATA[<h2 id="命名">命名</h2>
<p>Go语言中的<strong>函数名</strong>、<strong>变量名</strong>、<strong>常量名</strong>、<strong>类型名</strong>、<strong>语句标号</strong>和<strong>包名</strong>等所有的命名,都遵循一个简单的命名规则：一个名字必须以一个字母（Unicode字母）或下划线开头,后面可以跟任意数量的<strong>字母</strong>、<strong>数字</strong>或<strong>下划线</strong>.大写字母和小写字母是不同的：heapSort和Heapsort是两个不同的名字.</p>
<p>Go语言的<strong>关键字</strong>有25个,关键字<strong>不能用于自定义名字</strong>. 分别为:</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">break</span>      <span style="color:#00a8c8">default</span>       <span style="color:#00a8c8">func</span>     <span style="color:#00a8c8">interface</span>   <span style="color:#00a8c8">select</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">case</span>       <span style="color:#00a8c8">defer</span>         <span style="color:#00a8c8">go</span>       <span style="color:#00a8c8">map</span>         <span style="color:#00a8c8">struct</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">chan</span>       <span style="color:#00a8c8">else</span>          <span style="color:#00a8c8">goto</span>     <span style="color:#f92672">package</span>     <span style="color:#00a8c8">switch</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">const</span>      <span style="color:#00a8c8">fallthrough</span>   <span style="color:#00a8c8">if</span>       <span style="color:#00a8c8">range</span>       <span style="color:#00a8c8">type</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">continue</span>   <span style="color:#00a8c8">for</span>           <span style="color:#f92672">import</span>   <span style="color:#00a8c8">return</span>      <span style="color:#00a8c8">var</span>
</span></span></code></pre></div><p>还有大约30多个预定义的名字,这些内部预先定义的名字并不是关键字，你可以在定义中重新使用它们。在一些特殊的场景中重新定义它们也是有意义的，但是也要注意避免过度而引起语义混乱.</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">内建常量</span><span style="color:#111">:</span> <span style="color:#00a8c8">true</span> <span style="color:#00a8c8">false</span> <span style="color:#00a8c8">iota</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">内建类型</span><span style="color:#111">:</span> <span style="color:#00a8c8">int</span> <span style="color:#00a8c8">int8</span> <span style="color:#00a8c8">int16</span> <span style="color:#00a8c8">int32</span> <span style="color:#00a8c8">int64</span>
</span></span><span style="display:flex;"><span>          <span style="color:#00a8c8">uint</span> <span style="color:#00a8c8">uint8</span> <span style="color:#00a8c8">uint16</span> <span style="color:#00a8c8">uint32</span> <span style="color:#00a8c8">uint64</span> <span style="color:#00a8c8">uintptr</span>
</span></span><span style="display:flex;"><span>          <span style="color:#00a8c8">float32</span> <span style="color:#00a8c8">float64</span> <span style="color:#00a8c8">complex128</span> <span style="color:#00a8c8">complex64</span>
</span></span><span style="display:flex;"><span>          <span style="color:#00a8c8">bool</span> <span style="color:#00a8c8">byte</span> <span style="color:#00a8c8">rune</span> <span style="color:#00a8c8">string</span> <span style="color:#00a8c8">error</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">内建函数</span><span style="color:#111">:</span> <span style="color:#75af00">make</span> <span style="color:#75af00">len</span> <span style="color:#75af00">cap</span> <span style="color:#75af00">new</span> <span style="color:#75af00">append</span> <span style="color:#75af00">copy</span> <span style="color:#75af00">close</span> <span style="color:#75af00">delete</span>
</span></span><span style="display:flex;"><span>          <span style="color:#75af00">complex</span> <span style="color:#75af00">real</span> <span style="color:#75af00">imag</span>
</span></span><span style="display:flex;"><span>          <span style="color:#75af00">panic</span> <span style="color:#75af00">recover</span>
</span></span></code></pre></div><p>在习惯上，Go语言程序员推荐使用 <em><strong>驼峰式</strong></em> 命名，当名字有几个单词组成的时优先使用大小写分隔，而不是优先用下划线分隔。</p>
<h2 id="声明">声明</h2>
<p>Go语言主要有四种类型的声明语句：<strong>var</strong>、<strong>const</strong>、<strong>type</strong>和<strong>func</strong>，分别对应<strong>变量</strong>、<strong>常量</strong>、<strong>类型</strong>和<strong>函数实体对象</strong>的声明。</p>
<p>一个Go语言编写的程序对应一个或多个以.go为文件后缀名的源文件中。每个源文件以包的声明语句开始，说明该源文件是属于哪个包。包声明语句之后是import语句导入依赖的其它包，然后是包一级的类型、变量、常量、函数的声明语句.</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span> <span style="color:#75715e">// main包</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#d88200">&#34;fmt&#34;</span> <span style="color:#75715e">// 引入fmt内部包</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">const</span> <span style="color:#75af00">price</span> <span style="color:#111">=</span> <span style="color:#ae81ff">212.0</span> <span style="color:#75715e">// 浮点型常量</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">var</span> <span style="color:#75af00">f</span> <span style="color:#111">=</span> <span style="color:#75af00">price</span>                        <span style="color:#75715e">// f浮点型变量</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">var</span> <span style="color:#75af00">c</span> <span style="color:#111">=</span> <span style="color:#111">(</span><span style="color:#75af00">f</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">32</span><span style="color:#111">)</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">5</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">9</span>             <span style="color:#75715e">// c浮点型变量</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;f = %g  c = %g\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">f</span><span style="color:#111">,</span> <span style="color:#75af00">c</span><span style="color:#111">)</span> <span style="color:#75715e">// %g为浮点型占位符</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;f:%T,c:%T&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">f</span><span style="color:#111">,</span> <span style="color:#75af00">c</span><span style="color:#111">)</span>        <span style="color:#75715e">// %T为打印类型  结果:f:float64,c:float64</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="变量">变量</h2>
<p>var声明语句可以创建一个特定类型的变量，然后给变量附加一个名字，并且设置变量的初始值。变量声明的一般语法如下：</p>
<p>var 变量名字 类型 = 表达式</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// 例如</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">var</span> <span style="color:#75af00">name</span> <span style="color:#00a8c8">string</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;zhy&#34;</span>
</span></span></code></pre></div><p>其中“<em>类型</em>”或“<em>= 表达式</em>”两个部分可以省略其中的一个。如果省略的是类型信息，那么将根据初始化表达式来推导变量的类型信息。如果初始化表达式被省略，那么将用零值初始化该变量。 数值类型变量对应的零值是0，布尔类型变量对应的零值是false，字符串类型对应的零值是空字符串，接口或引用类型（包括slice、指针、map、chan和函数）变量对应的零值是nil。数组或结构体等聚合类型对应的零值是每个元素或字段都是对应该类型的零值。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">var</span> <span style="color:#75af00">s</span> <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">s</span><span style="color:#111">)</span> <span style="color:#75715e">// &#34;&#34;</span>
</span></span></code></pre></div><p>也可以在一个声明语句中同时声明一组变量，或用一组初始化表达式声明并初始化一组变量。如果省略每个变量的类型，将可以声明多个类型不同的变量（<strong>类型由初始化表达式推导</strong>）：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">var</span> <span style="color:#75af00">i</span><span style="color:#111">,</span> <span style="color:#75af00">j</span><span style="color:#111">,</span> <span style="color:#75af00">k</span> <span style="color:#00a8c8">int</span>                 <span style="color:#75715e">// int, int, int</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">var</span> <span style="color:#75af00">b</span><span style="color:#111">,</span> <span style="color:#75af00">f</span><span style="color:#111">,</span> <span style="color:#75af00">s</span> <span style="color:#111">=</span> <span style="color:#00a8c8">true</span><span style="color:#111">,</span> <span style="color:#ae81ff">2.3</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;four&#34;</span> <span style="color:#75715e">// bool, float64, string</span>
</span></span></code></pre></div><p>一组变量也可以通过调用一个函数，由<strong>函数返回的多个返回值</strong>初始化：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">var</span> <span style="color:#75af00">f</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">Open</span><span style="color:#111">(</span><span style="color:#d88200">&#34;./project.log&#34;</span><span style="color:#111">)</span>  <span style="color:#75715e">// 打开文件 f为句柄 err为错误</span>
</span></span></code></pre></div><h3 id="简短变量声明">简短变量声明</h3>
<p>在函数内部，有一种称为简短变量声明语句的形式可用于声明和初始化局部变量。它以“<strong>名字 := 表达式</strong>”形式声明变量，变量的类型根据表达式来自动推导。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">name</span> <span style="color:#f92672">:=</span> <span style="color:#d88200">&#34;zhy&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">f</span><span style="color:#111">,</span><span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">Open</span><span style="color:#111">(</span><span style="color:#d88200">&#34;./project.log&#34;</span><span style="color:#111">)</span>
</span></span></code></pre></div><h3 id="指针">指针</h3>
<p><strong>一个变量对应一个保存了变量对应类型值的内存空间</strong>。<strong>一个指针的值是另一个变量的地址</strong>。一个指针对应变量在内存中的存储位置。并不是每一个值都会有一个内存地址，但是对于每一个变量必然有对应的内存地址。通过指针，我们可以直接读或更新对应变量的值，而不需要知道该变量的名字（如果变量有名字的话）。指针的定义为*+类型比如*int等,或者<strong>把变量的地址赋值给指针</strong>,编辑器会自动推到指针的类型</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">var</span> <span style="color:#75af00">number</span> <span style="color:#f92672">*</span><span style="color:#00a8c8">int</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">var</span> <span style="color:#75af00">a</span> <span style="color:#111">=</span> <span style="color:#ae81ff">100</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">var</span> <span style="color:#75af00">b</span> <span style="color:#111">=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">a</span> <span style="color:#75715e">// &amp;为取值符</span>
</span></span></code></pre></div><p>用*+指针变量出去所指变量的值</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">p</span><span style="color:#111">)</span>  <span style="color:#75715e">// 0</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">b</span><span style="color:#111">)</span>  <span style="color:#75715e">// 100</span>
</span></span></code></pre></div><h3 id="new初始化">New初始化</h3>
<p>另一个创建变量的方法是调用用内建的new函数。表达式new(T)将创建一个T类型的匿名变量，初始化为T类型的零值，然后返回变量地址，返回的指针类型为*T。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">p</span> <span style="color:#f92672">:=</span> <span style="color:#111">new</span><span style="color:#111">(</span><span style="color:#00a8c8">int</span><span style="color:#111">)</span>   <span style="color:#75715e">// p, *int 类型, 指向匿名的 int 变量</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">p</span><span style="color:#111">)</span> <span style="color:#75715e">// &#34;0&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">*</span><span style="color:#75af00">p</span> <span style="color:#111">=</span> <span style="color:#ae81ff">2</span>          <span style="color:#75715e">// 设置 int 匿名变量的值为 2</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">p</span><span style="color:#111">)</span> <span style="color:#75715e">// &#34;2&#34;</span>
</span></span></code></pre></div><h3 id="变量的生命周期">变量的生命周期</h3>
<p>变量的生命周期指的是在程序运行期间变量有效存在的时间间隔。对于在包一级声明的变量来说，它们的生命周期和整个程序的运行周期是一致的。而相比之下，局部变量的声明周期则是动态的：**每次从创建一个新变量的声明语句开始，直到该变量不再被引用为止，然后变量的存储空间可能被回收。**函数的参数变量和返回值变量都是局部变量。它们在函数每次被调用的时候创建。</p>
<h2 id="赋值">赋值</h2>
<ul>
<li>直接赋值x = 100</li>
<li>通过指针赋值*p = &ldquo;zhy&rdquo;</li>
<li>结构体赋值stu.name = &ldquo;zhy&rdquo;</li>
<li>数组切片赋值lst[1] = lst[1] + 1</li>
<li>二元运算符x *= 6等同于x = x * 6</li>
<li>自加自减x++x&ndash;</li>
<li>交换赋值x,y = y,x</li>
<li>函数赋值f, err = os.Open(&ldquo;project.log&rdquo;)</li>
</ul>
<h2 id="类型">类型</h2>
<p>一个类型声明语句创建了一个新的类型名称，和现有类型具有相同的底层结构。新命名的类型提供了一个方法，用来分隔不同概念的类型，这样即使它们底层类型相同也是不兼容的。</p>
<pre tabindex="0"><code>type 类型名字 底层类型
</code></pre><h2 id="包">包</h2>
<p>Go语言中的包和其他语言的库或模块的概念类似，目的都是为了支持<strong>模块化、封装、单独编译和代码重用</strong>。一个<strong>包的源代码保存在一个或多个以.go为文件后缀名的源文件</strong>中，通常一个包所在目录路径的后缀是包的导入路径；</p>
<h2 id="作用域">作用域</h2>
<p>一个声明语句将程序中的实体和一个名字关联，比如一个函数或一个变量。声明语句的作用域是指<strong>源代码中可以有效使用这个名字的范围</strong>。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">f</span><span style="color:#111">()</span> <span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">var</span> <span style="color:#75af00">g</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;g&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">f</span> <span style="color:#f92672">:=</span> <span style="color:#d88200">&#34;f&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">f</span><span style="color:#111">)</span> <span style="color:#75715e">// main函数的作用域</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">g</span><span style="color:#111">)</span> <span style="color:#75715e">// g包作用域</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">h</span><span style="color:#111">)</span> <span style="color:#75715e">// pinic报错 没有找到</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>用:=声明变量,<strong>只能在函数内使用</strong>,在全局使用会报错</p>
]]></content:encoded><category>go</category><category>go</category></item><item><title>golang复杂数据结构</title><link>https://daemon365.dev/post/go/golang_complex_data_structure/</link><pubDate>Sat, 22 Jun 2019 00:00:00 +0800</pubDate><guid>https://daemon365.dev/post/go/golang_complex_data_structure/</guid><description>&lt;h2 id="数组"&gt;数组&lt;/h2&gt;
&lt;p&gt;**数组是一个由固定长度的特定类型元素组成的序列，一个数组可以由零个或多个元素组成。**因为数组的长度是固定的，因此在Go语言中很少直接使用数组。&lt;/p&gt;
&lt;p&gt;数组的每个元素可以通过索引下标来访问，索引下标的范围是从0开始到数组长度减1的位置。内置的len函数将返回数组中元素的个数。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;var&lt;/span&gt; &lt;span style="color:#75af00"&gt;a&lt;/span&gt; &lt;span style="color:#111"&gt;[&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;3&lt;/span&gt;&lt;span style="color:#111"&gt;]&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;int&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 长度为3的数组&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;a&lt;/span&gt;&lt;span style="color:#111"&gt;[&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;0&lt;/span&gt;&lt;span style="color:#111"&gt;])&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 打印第一个数据&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;a&lt;/span&gt;&lt;span style="color:#111"&gt;[&lt;/span&gt;&lt;span style="color:#111"&gt;len&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;a&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;&lt;span style="color:#f92672"&gt;-&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;1&lt;/span&gt;&lt;span style="color:#111"&gt;])&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 打印最后一个数据&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;for&lt;/span&gt; &lt;span style="color:#75af00"&gt;i&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;v&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;range&lt;/span&gt; &lt;span style="color:#75af00"&gt;a&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Printf&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;%d %d\n&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;i&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;v&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 循环数组 i为索引 v为数据&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;strong&gt;默认情况下，数组的每个元素都被初始化为元素类型对应的零值&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;数组的初始化:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;var&lt;/span&gt; &lt;span style="color:#75af00"&gt;a&lt;/span&gt; &lt;span style="color:#111"&gt;[&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;3&lt;/span&gt;&lt;span style="color:#111"&gt;]&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;int&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#111"&gt;[&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;3&lt;/span&gt;&lt;span style="color:#111"&gt;]&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;int&lt;/span&gt;&lt;span style="color:#111"&gt;{&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;1&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;2&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;3&lt;/span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75af00"&gt;b&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#111"&gt;[&lt;/span&gt;&lt;span style="color:#f92672"&gt;...&lt;/span&gt;&lt;span style="color:#111"&gt;]&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;int&lt;/span&gt;&lt;span style="color:#111"&gt;{&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;1&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;2&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;3&lt;/span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75af00"&gt;a&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#111"&gt;[&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;4&lt;/span&gt;&lt;span style="color:#111"&gt;]&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;int&lt;/span&gt;&lt;span style="color:#111"&gt;{&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;1&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;2&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;3&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;4&lt;/span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt; &lt;span style="color:#75715e"&gt;// panic 数据初始化就是定长了 长度不能变化&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id="切片"&gt;切片&lt;/h2&gt;
&lt;p&gt;Slice（切片）代表变长的序列，序列中每个元素都有相同的类型。一个slice类型一般写作[]T，其中T代表slice中元素的类型；slice的语法和数组很像，只是没有固定长度而已。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;一个slice由三个部分构成：指针、长度和容量&lt;/strong&gt;。指针指向第一个slice元素对应的底层数组元素的地址，要注意的是slice的第一个元素并不一定就是数组的第一个元素。长度对应slice中元素的数目；长度不能超过容量，容量一般是从slice的开始位置到底层数据的结尾位置。内置的len和cap函数分别返回slice的长度和容量。&lt;/p&gt;
&lt;p&gt;多个slice之间可以共享底层的数据，并且引用的数组部分区间可能重叠。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;使用make()函数构造切片&lt;/strong&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;make&lt;/span&gt;&lt;span style="color:#111"&gt;([]&lt;/span&gt;&lt;span style="color:#75af00"&gt;T&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;size&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;cap&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75715e"&gt;// T:切片类型 size 切片数量 cap 切片容量&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;strong&gt;append()方法为切片添加元素&lt;/strong&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75af00"&gt;sli&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#111"&gt;make&lt;/span&gt;&lt;span style="color:#111"&gt;([]&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;int&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;0&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;10&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75af00"&gt;sli&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#111"&gt;append&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;sli&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;1&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 添加一个 1&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75af00"&gt;arr&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#111"&gt;[&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;4&lt;/span&gt;&lt;span style="color:#111"&gt;]&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;int&lt;/span&gt;&lt;span style="color:#111"&gt;{&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;6&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;7&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;8&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;9&lt;/span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75af00"&gt;sli&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#111"&gt;append&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;sle&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt;&lt;span style="color:#75af00"&gt;arr&lt;/span&gt;&lt;span style="color:#f92672"&gt;...&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 把arr打散并全部添加 添加多个&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;sli&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75715e"&gt;// [1 6 7 8 9]&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;strong&gt;从切片中删除元素&lt;/strong&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;// 从切片中删除元素&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75af00"&gt;a&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#111"&gt;[]&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;int&lt;/span&gt;&lt;span style="color:#111"&gt;{&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;30&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;31&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;32&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;33&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;34&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;35&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;36&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;37&lt;/span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;// 要删除索引为2的元素&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75af00"&gt;a&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#111"&gt;append&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;a&lt;/span&gt;&lt;span style="color:#111"&gt;[:&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;2&lt;/span&gt;&lt;span style="color:#111"&gt;],&lt;/span&gt; &lt;span style="color:#75af00"&gt;a&lt;/span&gt;&lt;span style="color:#111"&gt;[&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;3&lt;/span&gt;&lt;span style="color:#111"&gt;:]&lt;/span&gt;&lt;span style="color:#f92672"&gt;...&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;a&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75715e"&gt;//[30 31 33 34 35 36 37]&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;strong&gt;切片的扩容策略&lt;/strong&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;growslice&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;et&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;_type&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;old&lt;/span&gt; &lt;span style="color:#75af00"&gt;slice&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;cap&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;int&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75af00"&gt;slice&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;newcap&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;old&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;cap&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;doublecap&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;newcap&lt;/span&gt; &lt;span style="color:#f92672"&gt;+&lt;/span&gt; &lt;span style="color:#75af00"&gt;newcap&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;cap&lt;/span&gt; &lt;span style="color:#111"&gt;&amp;gt;&lt;/span&gt; &lt;span style="color:#75af00"&gt;doublecap&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;newcap&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#75af00"&gt;cap&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;else&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;old&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;len&lt;/span&gt; &lt;span style="color:#111"&gt;&amp;lt;&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;1024&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;newcap&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#75af00"&gt;doublecap&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;else&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;for&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;0&lt;/span&gt; &lt;span style="color:#111"&gt;&amp;lt;&lt;/span&gt; &lt;span style="color:#75af00"&gt;newcap&lt;/span&gt; &lt;span style="color:#f92672"&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span style="color:#75af00"&gt;newcap&lt;/span&gt; &lt;span style="color:#111"&gt;&amp;lt;&lt;/span&gt; &lt;span style="color:#75af00"&gt;cap&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;newcap&lt;/span&gt; &lt;span style="color:#f92672"&gt;+=&lt;/span&gt; &lt;span style="color:#75af00"&gt;newcap&lt;/span&gt; &lt;span style="color:#f92672"&gt;/&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;4&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;newcap&lt;/span&gt; &lt;span style="color:#f92672"&gt;&amp;lt;=&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;0&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;newcap&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#75af00"&gt;cap&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;在分配内存空间之前需要先确定新的切片容量，Go 语言根据切片的当前容量选择不同的策略进行扩容：&lt;/p&gt;</description><content:encoded><![CDATA[<h2 id="数组">数组</h2>
<p>**数组是一个由固定长度的特定类型元素组成的序列，一个数组可以由零个或多个元素组成。**因为数组的长度是固定的，因此在Go语言中很少直接使用数组。</p>
<p>数组的每个元素可以通过索引下标来访问，索引下标的范围是从0开始到数组长度减1的位置。内置的len函数将返回数组中元素的个数。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">var</span> <span style="color:#75af00">a</span> <span style="color:#111">[</span><span style="color:#ae81ff">3</span><span style="color:#111">]</span><span style="color:#00a8c8">int</span>             <span style="color:#75715e">// 长度为3的数组</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">a</span><span style="color:#111">[</span><span style="color:#ae81ff">0</span><span style="color:#111">])</span>        <span style="color:#75715e">// 打印第一个数据</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">a</span><span style="color:#111">[</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">a</span><span style="color:#111">)</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">])</span> <span style="color:#75715e">// 打印最后一个数据</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">for</span> <span style="color:#75af00">i</span><span style="color:#111">,</span> <span style="color:#75af00">v</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">a</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;%d %d\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">i</span><span style="color:#111">,</span> <span style="color:#75af00">v</span><span style="color:#111">)</span> <span style="color:#75715e">// 循环数组 i为索引 v为数据</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p><strong>默认情况下，数组的每个元素都被初始化为元素类型对应的零值</strong></p>
<p>数组的初始化:</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">var</span> <span style="color:#75af00">a</span> <span style="color:#111">[</span><span style="color:#ae81ff">3</span><span style="color:#111">]</span><span style="color:#00a8c8">int</span> <span style="color:#111">=</span> <span style="color:#111">[</span><span style="color:#ae81ff">3</span><span style="color:#111">]</span><span style="color:#00a8c8">int</span><span style="color:#111">{</span><span style="color:#ae81ff">1</span><span style="color:#111">,</span> <span style="color:#ae81ff">2</span><span style="color:#111">,</span> <span style="color:#ae81ff">3</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">b</span> <span style="color:#f92672">:=</span> <span style="color:#111">[</span><span style="color:#f92672">...</span><span style="color:#111">]</span><span style="color:#00a8c8">int</span><span style="color:#111">{</span><span style="color:#ae81ff">1</span><span style="color:#111">,</span> <span style="color:#ae81ff">2</span><span style="color:#111">,</span> <span style="color:#ae81ff">3</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">a</span> <span style="color:#111">=</span> <span style="color:#111">[</span><span style="color:#ae81ff">4</span><span style="color:#111">]</span><span style="color:#00a8c8">int</span><span style="color:#111">{</span><span style="color:#ae81ff">1</span><span style="color:#111">,</span> <span style="color:#ae81ff">2</span><span style="color:#111">,</span> <span style="color:#ae81ff">3</span><span style="color:#111">,</span> <span style="color:#ae81ff">4</span><span style="color:#111">}</span> <span style="color:#75715e">// panic 数据初始化就是定长了  长度不能变化</span>
</span></span></code></pre></div><h2 id="切片">切片</h2>
<p>Slice（切片）代表变长的序列，序列中每个元素都有相同的类型。一个slice类型一般写作[]T，其中T代表slice中元素的类型；slice的语法和数组很像，只是没有固定长度而已。</p>
<p><strong>一个slice由三个部分构成：指针、长度和容量</strong>。指针指向第一个slice元素对应的底层数组元素的地址，要注意的是slice的第一个元素并不一定就是数组的第一个元素。长度对应slice中元素的数目；长度不能超过容量，容量一般是从slice的开始位置到底层数据的结尾位置。内置的len和cap函数分别返回slice的长度和容量。</p>
<p>多个slice之间可以共享底层的数据，并且引用的数组部分区间可能重叠。</p>
<p><strong>使用make()函数构造切片</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#111">make</span><span style="color:#111">([]</span><span style="color:#75af00">T</span><span style="color:#111">,</span> <span style="color:#75af00">size</span><span style="color:#111">,</span> <span style="color:#75af00">cap</span><span style="color:#111">)</span>   <span style="color:#75715e">// T:切片类型  size 切片数量  cap 切片容量</span>
</span></span></code></pre></div><p><strong>append()方法为切片添加元素</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">sli</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">([]</span><span style="color:#00a8c8">int</span><span style="color:#111">,</span><span style="color:#ae81ff">0</span><span style="color:#111">,</span><span style="color:#ae81ff">10</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">sli</span> <span style="color:#111">=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">sli</span><span style="color:#111">,</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span>	 <span style="color:#75715e">// 添加一个 1</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">arr</span> <span style="color:#f92672">:=</span> <span style="color:#111">[</span><span style="color:#ae81ff">4</span><span style="color:#111">]</span><span style="color:#00a8c8">int</span><span style="color:#111">{</span><span style="color:#ae81ff">6</span><span style="color:#111">,</span><span style="color:#ae81ff">7</span><span style="color:#111">,</span><span style="color:#ae81ff">8</span><span style="color:#111">,</span><span style="color:#ae81ff">9</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">sli</span> <span style="color:#111">=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">sle</span><span style="color:#111">,</span><span style="color:#75af00">arr</span><span style="color:#f92672">...</span><span style="color:#111">)</span> <span style="color:#75715e">// 把arr打散并全部添加  添加多个</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">sli</span><span style="color:#111">)</span>    <span style="color:#75715e">// [1 6 7 8 9]</span>
</span></span></code></pre></div><p><strong>从切片中删除元素</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// 从切片中删除元素</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">a</span> <span style="color:#f92672">:=</span> <span style="color:#111">[]</span><span style="color:#00a8c8">int</span><span style="color:#111">{</span><span style="color:#ae81ff">30</span><span style="color:#111">,</span> <span style="color:#ae81ff">31</span><span style="color:#111">,</span> <span style="color:#ae81ff">32</span><span style="color:#111">,</span> <span style="color:#ae81ff">33</span><span style="color:#111">,</span> <span style="color:#ae81ff">34</span><span style="color:#111">,</span> <span style="color:#ae81ff">35</span><span style="color:#111">,</span> <span style="color:#ae81ff">36</span><span style="color:#111">,</span> <span style="color:#ae81ff">37</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 要删除索引为2的元素</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">a</span> <span style="color:#111">=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">a</span><span style="color:#111">[:</span><span style="color:#ae81ff">2</span><span style="color:#111">],</span> <span style="color:#75af00">a</span><span style="color:#111">[</span><span style="color:#ae81ff">3</span><span style="color:#111">:]</span><span style="color:#f92672">...</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">a</span><span style="color:#111">)</span> <span style="color:#75715e">//[30 31 33 34 35 36 37]</span>
</span></span></code></pre></div><p><strong>切片的扩容策略</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">growslice</span><span style="color:#111">(</span><span style="color:#75af00">et</span> <span style="color:#f92672">*</span><span style="color:#75af00">_type</span><span style="color:#111">,</span> <span style="color:#75af00">old</span> <span style="color:#75af00">slice</span><span style="color:#111">,</span> <span style="color:#75af00">cap</span> <span style="color:#00a8c8">int</span><span style="color:#111">)</span> <span style="color:#75af00">slice</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">newcap</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">old</span><span style="color:#111">.</span><span style="color:#75af00">cap</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">doublecap</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">newcap</span> <span style="color:#f92672">+</span> <span style="color:#75af00">newcap</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">cap</span> <span style="color:#111">&gt;</span> <span style="color:#75af00">doublecap</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">newcap</span> <span style="color:#111">=</span> <span style="color:#75af00">cap</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">old</span><span style="color:#111">.</span><span style="color:#75af00">len</span> <span style="color:#111">&lt;</span> <span style="color:#ae81ff">1024</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">newcap</span> <span style="color:#111">=</span> <span style="color:#75af00">doublecap</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">for</span> <span style="color:#ae81ff">0</span> <span style="color:#111">&lt;</span> <span style="color:#75af00">newcap</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">newcap</span> <span style="color:#111">&lt;</span> <span style="color:#75af00">cap</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">newcap</span> <span style="color:#f92672">+=</span> <span style="color:#75af00">newcap</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">4</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">newcap</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">newcap</span> <span style="color:#111">=</span> <span style="color:#75af00">cap</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span></code></pre></div><p>在分配内存空间之前需要先确定新的切片容量，Go 语言根据切片的当前容量选择不同的策略进行扩容：</p>
<ol>
<li>如果期望容量大于当前容量的两倍就会使用期望容量；</li>
<li>如果当前切片容量小于 1024 就会将容量翻倍；</li>
<li>如果当前切片容量大于 1024 就会每次增加 25% 的容量，直到新容量大于期望容量；</li>
</ol>
<h2 id="map">MAP</h2>
<p>哈希表是一种巧妙并且实用的数据结构。它是一个<strong>无序的key/value对的集合</strong>，其中所有的key都是不同的，然后通过给定的key可以在常数时间复杂度内检索、更新或删除对应的value。在Go语言中，一个map就是一个哈希表的引用，map类型可以写为map[K]V，其中K和V分别对应key和value。</p>
<ul>
<li>初始化:</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">m</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#00a8c8">string</span><span style="color:#111">]</span><span style="color:#00a8c8">int</span><span style="color:#111">)</span>
</span></span></code></pre></div><ul>
<li>赋值初始化</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">m</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#00a8c8">string</span><span style="color:#111">]</span><span style="color:#00a8c8">int</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d88200">&#34;zhy&#34;</span><span style="color:#111">:</span>   <span style="color:#ae81ff">18</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d88200">&#34;who&#34;</span><span style="color:#111">:</span> <span style="color:#ae81ff">30</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 直接赋值相当于</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">ages</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#00a8c8">string</span><span style="color:#111">]</span><span style="color:#00a8c8">int</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">ages</span><span style="color:#111">[</span><span style="color:#d88200">&#34;zhy&#34;</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#ae81ff">18</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">ages</span><span style="color:#111">[</span><span style="color:#d88200">&#34;who&#34;</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#ae81ff">30</span>
</span></span></code></pre></div><p>**Map的迭代顺序是不确定的，并且不同的哈希函数实现可能导致不同的遍历顺序。**遍历的顺序是随机的，每一次遍历的顺序都不相同。</p>
<p>如果要有序:</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// 用sort进项排序</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">var</span> <span style="color:#75af00">names</span> <span style="color:#111">[]</span><span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">for</span> <span style="color:#75af00">name</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">ages</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">names</span> <span style="color:#111">=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">names</span><span style="color:#111">,</span> <span style="color:#75af00">name</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">sort</span><span style="color:#111">.</span><span style="color:#75af00">Strings</span><span style="color:#111">(</span><span style="color:#75af00">names</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">name</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">names</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;%s\t%d\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">name</span><span style="color:#111">,</span> <span style="color:#75af00">ages</span><span style="color:#111">[</span><span style="color:#75af00">name</span><span style="color:#111">])</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="结构体">结构体</h2>
<p><strong>结构体是一种聚合的数据类型，是由零个或多个任意类型的值聚合成的实体。每个值称为结构体的成员。</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">people</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">name</span> <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">age</span> <span style="color:#00a8c8">uint8</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">hobby</span> <span style="color:#111">[]</span><span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">address</span> <span style="color:#00a8c8">string</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">sex</span> <span style="color:#00a8c8">uint8</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">var</span> <span style="color:#75af00">zhy</span> <span style="color:#75af00">people</span>
</span></span></code></pre></div><p><strong>结构体赋值</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">h</span> <span style="color:#f92672">:=</span> <span style="color:#111">[]</span><span style="color:#00a8c8">string</span><span style="color:#111">{</span><span style="color:#d88200">&#34;唱&#34;</span><span style="color:#111">,</span><span style="color:#d88200">&#34;跳&#34;</span><span style="color:#111">,</span><span style="color:#d88200">&#34;RAP&#34;</span><span style="color:#111">,</span><span style="color:#d88200">&#34;篮球&#34;</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">zhy</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">people</span><span style="color:#111">{</span><span style="color:#d88200">&#34;zhaohaiyu&#34;</span><span style="color:#111">,</span><span style="color:#ae81ff">18</span><span style="color:#111">,</span><span style="color:#75af00">h</span><span style="color:#111">,</span><span style="color:#d88200">&#34;地球&#34;</span><span style="color:#111">,</span><span style="color:#ae81ff">1</span><span style="color:#111">}</span>
</span></span></code></pre></div><p>或者</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">var</span> <span style="color:#75af00">zhy</span> <span style="color:#75af00">people</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">zhy</span><span style="color:#111">.</span><span style="color:#75af00">name</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;zhaohaiyu&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">zhy</span><span style="color:#111">.</span><span style="color:#75af00">age</span> <span style="color:#111">=</span> <span style="color:#ae81ff">18</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">zhy</span><span style="color:#111">.</span><span style="color:#75af00">hobby</span> <span style="color:#111">=</span> <span style="color:#75af00">h</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">zhy</span><span style="color:#111">.</span><span style="color:#75af00">address</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;地球&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">zhy</span><span style="color:#111">.</span><span style="color:#75af00">sex</span> <span style="color:#111">=</span> <span style="color:#ae81ff">1</span>
</span></span></code></pre></div><h3 id="结构体比较">结构体比较</h3>
<p>如果结构体的全部成员都是可以比较的，那么结构体也是可以比较的，那样的话两个结构体将可以使用或!=运算符进行比较。相等比较运算符将比较两个结构体的每个成员，因此下面两个比较的表达式是等价的：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Point</span> <span style="color:#00a8c8">struct</span><span style="color:#111">{</span> <span style="color:#75af00">X</span><span style="color:#111">,</span> <span style="color:#75af00">Y</span> <span style="color:#00a8c8">int</span> <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">p</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">Point</span><span style="color:#111">{</span><span style="color:#ae81ff">1</span><span style="color:#111">,</span> <span style="color:#ae81ff">2</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">q</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">Point</span><span style="color:#111">{</span><span style="color:#ae81ff">2</span><span style="color:#111">,</span> <span style="color:#ae81ff">1</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">X</span> <span style="color:#f92672">==</span> <span style="color:#75af00">q</span><span style="color:#111">.</span><span style="color:#75af00">X</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">Y</span> <span style="color:#f92672">==</span> <span style="color:#75af00">q</span><span style="color:#111">.</span><span style="color:#75af00">Y</span><span style="color:#111">)</span> <span style="color:#75715e">// &#34;false&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">p</span> <span style="color:#f92672">==</span> <span style="color:#75af00">q</span><span style="color:#111">)</span>                   <span style="color:#75715e">// &#34;false&#34;</span>
</span></span></code></pre></div><h3 id="结构体的继承">结构体的继承</h3>
<p>在java,python,cpp等语言中都有类的继承的概念,go语言中没有类.用结构体的嵌套实现继承.</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">animal</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">name</span> <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">age</span> <span style="color:#00a8c8">int</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">people</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">address</span> <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">animal</span> <span style="color:#75af00">animal</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">var</span> <span style="color:#75af00">zhy</span> <span style="color:#111">=</span> <span style="color:#75af00">people</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">address</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;地球&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">animal</span><span style="color:#111">:</span>  <span style="color:#75af00">animal</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">name</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;zhaohaiyu&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">age</span><span style="color:#111">:</span>  <span style="color:#ae81ff">18</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">},</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">zhy</span><span style="color:#111">.</span><span style="color:#75af00">animal</span><span style="color:#111">)</span>  <span style="color:#75715e">// {zhaohaiyu 18}</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">zhy</span><span style="color:#111">.</span><span style="color:#75af00">animal</span><span style="color:#111">.</span><span style="color:#75af00">name</span><span style="color:#111">)</span> <span style="color:#75715e">// zhaohaiyu</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">zhy</span><span style="color:#111">.</span><span style="color:#75af00">animal</span><span style="color:#111">.</span><span style="color:#75af00">age</span><span style="color:#111">)</span>  <span style="color:#75715e">// 18</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">zhy</span><span style="color:#111">.</span><span style="color:#75af00">address</span><span style="color:#111">)</span> <span style="color:#75715e">//地球</span>
</span></span></code></pre></div><h2 id="json">JSON</h2>
<p>JSON(JavaScript Object Notation, JS 对象简谱) 是一种轻量级的数据交换格式。它基于ECMAScript(欧洲计算机协会制定的js规范)的一个子集，采用完全独立于编程语言的文本格式来存储和表示数据。简洁和清晰的层次结构使得 JSON 成为理想的数据交换语言。 易于人阅读和编写，同时也易于机器解析和生成，并有效地提升网络传输效率。</p>
<p>Go语言对于这些标准格式的编码和解码都有良好的支持，由标准库中的<strong>encoding/json</strong>包提供支持</p>
<p>JSON是对JavaScript中各种类型的值——字符串、数字、布尔值和对象——Unicode本文编码。它可以用有效可读的方式表示第三章的基础数据类型和本章的数组、slice、结构体和map等聚合数据类型。</p>
<ul>
<li>各类型的json数据</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">boolean</span>         <span style="color:#00a8c8">true</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">number</span>          <span style="color:#f92672">-</span><span style="color:#ae81ff">273.15</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">string</span>          <span style="color:#d88200">&#34;hello world!!!!&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">array</span>           <span style="color:#111">[</span><span style="color:#d88200">&#34;i&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;you&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;her&#34;</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">object</span>          <span style="color:#111">{</span><span style="color:#d88200">&#34;year&#34;</span><span style="color:#111">:</span> <span style="color:#ae81ff">2020</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#d88200">&#34;event&#34;</span><span style="color:#111">:</span><span style="color:#d88200">&#34;huawei&#34;</span><span style="color:#111">,</span><span style="color:#d88200">&#34;American virus&#34;</span><span style="color:#111">,</span><span style="color:#d88200">&#34;Trump is crazy&#34;</span><span style="color:#111">}</span>
</span></span></code></pre></div><ul>
<li>go语言结构体成员Tag来指定对应的JSON名字。同样，在解码的时候也需要做同样的处理</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">People</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">Name</span> <span style="color:#00a8c8">string</span> <span style="color:#d88200">`json:&#34;name&#34;`</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">Age</span> <span style="color:#00a8c8">int</span> <span style="color:#d88200">`json:&#34;age&#34;`</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">PhoneNumber</span> <span style="color:#00a8c8">string</span> <span style="color:#d88200">`json:&#34;phone_number&#34;`</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><ul>
<li>要将结构体的数据发给游览器前端或者安卓,IOS,APP等进行展示,因为go语言首字母小写只能本包用,在外部包要首字母大写,包括结构体和结构体成员.而且go语言崇尚驼峰体命名,而很多语言崇尚下划线命名.所有我们要用tag把json数据的成员变成首字母小写以及下划线命名.</li>
</ul>
]]></content:encoded><category>go</category><category>go</category></item><item><title>golang接口</title><link>https://daemon365.dev/post/go/golang_interface/</link><pubDate>Sat, 22 Jun 2019 00:00:00 +0800</pubDate><guid>https://daemon365.dev/post/go/golang_interface/</guid><description>&lt;h2 id="接口的定义"&gt;接口的定义&lt;/h2&gt;
&lt;p&gt;接口类型是对其它类型行为的抽象和概括；因为接口类型不会和特定的实现细节绑定在一起，通过这种抽象的方式我们可以让我们的函数更加灵活和更具有适应能力。&lt;/p&gt;
&lt;p&gt;很多面向对象的语言都有相似的接口概念，但Go语言中接口类型的独特之处在于它是满足隐式实现的。也就是说，我们没有必要对于给定的具体类型定义所有满足的接口类型；简单地拥有一些必需的方法就足够了。这种设计可以让你创建一个新的接口类型满足已经存在的具体类型却不会去改变这些类型的定义；当我们使用的类型来自于不受我们控制的包时这种设计尤其有用。&lt;/p&gt;
&lt;p&gt;接口（interface）定义了一个对象的行为规范，只定义规范不实现，由具体的对象来实现规范的细节。接口类型是一种抽象的类型。它不会暴露出它所代表的对象的内部值的结构和这个对象支持的基础操作的集合；它们只会展示出它们自己的方法。也就是说当你有看到一个接口类型的值时，你不知道它是什么，唯一知道的就是可以通过它的方法来做什么。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;package&lt;/span&gt; &lt;span style="color:#75af00"&gt;main&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;import&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;fmt&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;type&lt;/span&gt; &lt;span style="color:#75af00"&gt;canSay&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;interface&lt;/span&gt;&lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;Say&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;type&lt;/span&gt; &lt;span style="color:#75af00"&gt;dog&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;struct&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;name&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;string&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;type&lt;/span&gt; &lt;span style="color:#75af00"&gt;cat&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;struct&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;name&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;string&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;d&lt;/span&gt; &lt;span style="color:#75af00"&gt;dog&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75af00"&gt;Say&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;d&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;name&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;say&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;main&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;var&lt;/span&gt; &lt;span style="color:#75af00"&gt;tom2&lt;/span&gt; &lt;span style="color:#75af00"&gt;canSay&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;tom&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;dog&lt;/span&gt;&lt;span style="color:#111"&gt;{&lt;/span&gt;&lt;span style="color:#75af00"&gt;name&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;汤姆&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;tom2&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#75af00"&gt;tom&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;tom2&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Say&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 汤姆 say&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;mi&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;cat&lt;/span&gt;&lt;span style="color:#111"&gt;{&lt;/span&gt;&lt;span style="color:#75af00"&gt;name&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;猫咪&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;tom2&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#75af00"&gt;mi&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 报错 因为cat没有实现接口规定的say方法&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id="接口值"&gt;接口值&lt;/h2&gt;
&lt;p&gt;接口值，由两个部分组成，一个具体的类型和那个类型的值。它们被称为接口的动态类型和动态值。在我们的概念模型中，一些提供每个类型信息的值被称为类型描述符，比如类型的名称和方法。在一个接口值中，类型部分代表与之相关类型的描述符。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;package&lt;/span&gt; &lt;span style="color:#75af00"&gt;main&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;import&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;bytes&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;fmt&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;io&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;os&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;main&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;var&lt;/span&gt; &lt;span style="color:#75af00"&gt;w&lt;/span&gt; &lt;span style="color:#75af00"&gt;io&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Writer&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Printf&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;类型:%T,值:%v\n&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt;&lt;span style="color:#75af00"&gt;w&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt;&lt;span style="color:#75af00"&gt;w&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 类型:,值:&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;w&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#75af00"&gt;os&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Stdout&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Printf&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;类型:%T,值:%v\n&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt;&lt;span style="color:#75af00"&gt;w&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt;&lt;span style="color:#75af00"&gt;w&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 类型:*os.File,值:&amp;amp;{0xc00007e280}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;w&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#111"&gt;new&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;bytes&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Buffer&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Printf&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;类型:%T,值:%v\n&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt;&lt;span style="color:#75af00"&gt;w&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt;&lt;span style="color:#75af00"&gt;w&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 类型:*bytes.Buffer,值:&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;w&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Printf&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;类型:%T,值:%v\n&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt;&lt;span style="color:#75af00"&gt;w&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt;&lt;span style="color:#75af00"&gt;w&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 类型: 类型:&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;strong&gt;一个包含nil指针的接口不是nil接口&lt;/strong&gt;&lt;/p&gt;
&lt;h2 id="类型断言"&gt;类型断言&lt;/h2&gt;
&lt;p&gt;类型断言是一个使用在接口值上的操作。语法上它看起来像x.(T)被称为断言类型，这里x表示一个接口的类型和T表示一个类型。一个类型断言检查它操作对象的动态类型是否和断言的类型匹配。&lt;/p&gt;
&lt;p&gt;x.(T)T表示类型&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;package&lt;/span&gt; &lt;span style="color:#75af00"&gt;main&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;import&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;bytes&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;fmt&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;io&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;os&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;main&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;var&lt;/span&gt; &lt;span style="color:#75af00"&gt;w&lt;/span&gt; &lt;span style="color:#75af00"&gt;io&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Writer&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;w&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#75af00"&gt;os&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Stdout&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;f&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;w&lt;/span&gt;&lt;span style="color:#111"&gt;.(&lt;/span&gt;&lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;os&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;File&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Printf&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;类型%T,值:%v\n&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt;&lt;span style="color:#75af00"&gt;f&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt;&lt;span style="color:#75af00"&gt;f&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 类型*os.File,值:&amp;amp;{0xc00014a280}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;c&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;w&lt;/span&gt;&lt;span style="color:#111"&gt;.(&lt;/span&gt;&lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;bytes&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Buffer&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Printf&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;类型%T,值:%v\n&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt;&lt;span style="color:#75af00"&gt;c&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt;&lt;span style="color:#75af00"&gt;c&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75715e"&gt;// panic&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;判断是什么类型:&lt;/p&gt;</description><content:encoded><![CDATA[<h2 id="接口的定义">接口的定义</h2>
<p>接口类型是对其它类型行为的抽象和概括；因为接口类型不会和特定的实现细节绑定在一起，通过这种抽象的方式我们可以让我们的函数更加灵活和更具有适应能力。</p>
<p>很多面向对象的语言都有相似的接口概念，但Go语言中接口类型的独特之处在于它是满足隐式实现的。也就是说，我们没有必要对于给定的具体类型定义所有满足的接口类型；简单地拥有一些必需的方法就足够了。这种设计可以让你创建一个新的接口类型满足已经存在的具体类型却不会去改变这些类型的定义；当我们使用的类型来自于不受我们控制的包时这种设计尤其有用。</p>
<p>接口（interface）定义了一个对象的行为规范，只定义规范不实现，由具体的对象来实现规范的细节。接口类型是一种抽象的类型。它不会暴露出它所代表的对象的内部值的结构和这个对象支持的基础操作的集合；它们只会展示出它们自己的方法。也就是说当你有看到一个接口类型的值时，你不知道它是什么，唯一知道的就是可以通过它的方法来做什么。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">canSay</span> <span style="color:#00a8c8">interface</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Say</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">dog</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">name</span> <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">cat</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">name</span> <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">d</span> <span style="color:#75af00">dog</span><span style="color:#111">)</span> <span style="color:#75af00">Say</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">d</span><span style="color:#111">.</span><span style="color:#75af00">name</span><span style="color:#111">,</span><span style="color:#d88200">&#34;say&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">var</span> <span style="color:#75af00">tom2</span> <span style="color:#75af00">canSay</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">tom</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">dog</span><span style="color:#111">{</span><span style="color:#75af00">name</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;汤姆&#34;</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">tom2</span> <span style="color:#111">=</span> <span style="color:#75af00">tom</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">tom2</span><span style="color:#111">.</span><span style="color:#75af00">Say</span><span style="color:#111">()</span> <span style="color:#75715e">// 汤姆 say</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">mi</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">cat</span><span style="color:#111">{</span><span style="color:#75af00">name</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;猫咪&#34;</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">tom2</span> <span style="color:#111">=</span> <span style="color:#75af00">mi</span>  <span style="color:#75715e">// 报错 因为cat没有实现接口规定的say方法</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="接口值">接口值</h2>
<p>接口值，由两个部分组成，一个具体的类型和那个类型的值。它们被称为接口的动态类型和动态值。在我们的概念模型中，一些提供每个类型信息的值被称为类型描述符，比如类型的名称和方法。在一个接口值中，类型部分代表与之相关类型的描述符。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;bytes&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;io&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">var</span> <span style="color:#75af00">w</span> <span style="color:#75af00">io</span><span style="color:#111">.</span><span style="color:#75af00">Writer</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;类型:%T,值:%v\n&#34;</span><span style="color:#111">,</span><span style="color:#75af00">w</span><span style="color:#111">,</span><span style="color:#75af00">w</span><span style="color:#111">)</span> <span style="color:#75715e">// 类型:,值:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">w</span> <span style="color:#111">=</span> <span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">Stdout</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;类型:%T,值:%v\n&#34;</span><span style="color:#111">,</span><span style="color:#75af00">w</span><span style="color:#111">,</span><span style="color:#75af00">w</span><span style="color:#111">)</span> <span style="color:#75715e">// 类型:*os.File,值:&amp;{0xc00007e280}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">w</span> <span style="color:#111">=</span> <span style="color:#111">new</span><span style="color:#111">(</span><span style="color:#75af00">bytes</span><span style="color:#111">.</span><span style="color:#75af00">Buffer</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;类型:%T,值:%v\n&#34;</span><span style="color:#111">,</span><span style="color:#75af00">w</span><span style="color:#111">,</span><span style="color:#75af00">w</span><span style="color:#111">)</span> <span style="color:#75715e">// 类型:*bytes.Buffer,值:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">w</span> <span style="color:#111">=</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;类型:%T,值:%v\n&#34;</span><span style="color:#111">,</span><span style="color:#75af00">w</span><span style="color:#111">,</span><span style="color:#75af00">w</span><span style="color:#111">)</span> <span style="color:#75715e">// 类型: 类型:</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p><strong>一个包含nil指针的接口不是nil接口</strong></p>
<h2 id="类型断言">类型断言</h2>
<p>类型断言是一个使用在接口值上的操作。语法上它看起来像x.(T)被称为断言类型，这里x表示一个接口的类型和T表示一个类型。一个类型断言检查它操作对象的动态类型是否和断言的类型匹配。</p>
<p>x.(T)T表示类型</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;bytes&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;io&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">var</span> <span style="color:#75af00">w</span> <span style="color:#75af00">io</span><span style="color:#111">.</span><span style="color:#75af00">Writer</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">w</span> <span style="color:#111">=</span> <span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">Stdout</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">f</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">w</span><span style="color:#111">.(</span><span style="color:#f92672">*</span><span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">File</span><span style="color:#111">)</span> 
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;类型%T,值:%v\n&#34;</span><span style="color:#111">,</span><span style="color:#75af00">f</span><span style="color:#111">,</span><span style="color:#75af00">f</span><span style="color:#111">)</span> <span style="color:#75715e">// 类型*os.File,值:&amp;{0xc00014a280}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">c</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">w</span><span style="color:#111">.(</span><span style="color:#f92672">*</span><span style="color:#75af00">bytes</span><span style="color:#111">.</span><span style="color:#75af00">Buffer</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;类型%T,值:%v\n&#34;</span><span style="color:#111">,</span><span style="color:#75af00">c</span><span style="color:#111">,</span><span style="color:#75af00">c</span><span style="color:#111">)</span> <span style="color:#75715e">// panic</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>判断是什么类型:</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">judgeType</span><span style="color:#111">(</span><span style="color:#75af00">x</span> <span style="color:#00a8c8">interface</span><span style="color:#111">{})</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">switch</span> <span style="color:#75af00">v</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">x</span><span style="color:#111">.(</span><span style="color:#00a8c8">type</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">case</span> <span style="color:#00a8c8">string</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;is string:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">v</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">case</span> <span style="color:#00a8c8">int</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;is int:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">v</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">case</span> <span style="color:#00a8c8">bool</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;is bool:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">v</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">default</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;donot know &#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">judgeType</span><span style="color:#111">(</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span>      <span style="color:#75715e">// is int:1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">judgeType</span><span style="color:#111">(</span><span style="color:#00a8c8">true</span><span style="color:#111">)</span>   <span style="color:#75715e">// is bool:true</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">judgeType</span><span style="color:#111">(</span><span style="color:#d88200">&#34;true&#34;</span><span style="color:#111">)</span> <span style="color:#75715e">// is string:true</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">judgeType</span><span style="color:#111">(</span><span style="color:#ae81ff">1.22</span><span style="color:#111">)</span>   <span style="color:#75715e">// donot know</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="空接口">空接口</h2>
<h3 id="空接口的定义">空接口的定义</h3>
<p>空接口是<strong>没有定义任何方法的接口。因此任何类型都实现了空接口。空接口类型的变量可以存储任意类型的变量。</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">var</span> <span style="color:#75af00">test</span> <span style="color:#00a8c8">interface</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">t1</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">test</span> <span style="color:#111">=</span> <span style="color:#75af00">t1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;类型:%T 值:%v\n&#34;</span><span style="color:#111">,</span><span style="color:#75af00">test</span><span style="color:#111">,</span><span style="color:#75af00">test</span><span style="color:#111">)</span> <span style="color:#75715e">// 类型:int 值:1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">t2</span> <span style="color:#f92672">:=</span> <span style="color:#d88200">&#34;zhaohaiyu&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">test</span> <span style="color:#111">=</span> <span style="color:#75af00">t2</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;类型:%T 值:%v\n&#34;</span><span style="color:#111">,</span><span style="color:#75af00">test</span><span style="color:#111">,</span><span style="color:#75af00">test</span><span style="color:#111">)</span> <span style="color:#75715e">// 类型:string 值:zhaohaiyu</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">t3</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">false</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">test</span> <span style="color:#111">=</span> <span style="color:#75af00">t3</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;类型:%T 值:%v\n&#34;</span><span style="color:#111">,</span><span style="color:#75af00">test</span><span style="color:#111">,</span><span style="color:#75af00">test</span><span style="color:#111">)</span> <span style="color:#75715e">// 类型:bool 值:false</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">t4</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">3.14</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">test</span> <span style="color:#111">=</span> <span style="color:#75af00">t4</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;类型:%T 值:%v\n&#34;</span><span style="color:#111">,</span><span style="color:#75af00">test</span><span style="color:#111">,</span><span style="color:#75af00">test</span><span style="color:#111">)</span> <span style="color:#75715e">// 类型:float64 值:3.14</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="空接口的应用">空接口的应用</h3>
<ol>
<li><strong>空接口作为函数的参数</strong></li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">show</span><span style="color:#111">(</span><span style="color:#75af00">test</span> <span style="color:#00a8c8">interface</span><span style="color:#111">{})</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;类型:%T 值:%v\n&#34;</span><span style="color:#111">,</span><span style="color:#75af00">test</span><span style="color:#111">,</span><span style="color:#75af00">test</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><ol start="2">
<li><strong>空接口作为map的值</strong></li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">var</span> <span style="color:#75af00">studentInfo</span> <span style="color:#111">=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#00a8c8">string</span><span style="color:#111">]</span><span style="color:#00a8c8">interface</span><span style="color:#111">{})</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">studentInfo</span><span style="color:#111">[</span><span style="color:#d88200">&#34;name&#34;</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;赵海宇&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">studentInfo</span><span style="color:#111">[</span><span style="color:#d88200">&#34;age&#34;</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#ae81ff">18</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">studentInfo</span><span style="color:#111">)</span> <span style="color:#75715e">// map[age:18 name:赵海宇]</span>
</span></span></code></pre></div>]]></content:encoded><category>go</category><category>go</category></item><item><title>golang方法</title><link>https://daemon365.dev/post/go/golang_method/</link><pubDate>Sat, 22 Jun 2019 00:00:00 +0800</pubDate><guid>https://daemon365.dev/post/go/golang_method/</guid><description>&lt;h2 id="方法声明"&gt;方法声明&lt;/h2&gt;
&lt;p&gt;在函数声明时，在其名字之前放上一个变量，即是一个方法。这个附加的参数会将该函数附加到这种类型上，即相当于为这种类型定义了一个独占的方法。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;package&lt;/span&gt; &lt;span style="color:#75af00"&gt;main&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;import&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;fmt&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;type&lt;/span&gt; &lt;span style="color:#75af00"&gt;People&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;struct&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;name&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;string&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;age&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;uint8&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;p&lt;/span&gt; &lt;span style="color:#75af00"&gt;People&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75af00"&gt;SayHello&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;p&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;name&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;: hello world&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;p&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;age&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;20&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;main&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;p&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;People&lt;/span&gt;&lt;span style="color:#111"&gt;{&lt;/span&gt;&lt;span style="color:#75af00"&gt;name&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;zhaohaiyu&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;age&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;18&lt;/span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;p&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;SayHello&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#75715e"&gt;// zhaohaiyu : hello world&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;p&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;age&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75715e"&gt;//18&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id="基于指针对象的方法"&gt;基于指针对象的方法&lt;/h2&gt;
&lt;p&gt;当调用一个函数时，会对其每一个参数值进行拷贝，如果一个函数需要更新一个变量，或者函数的其中一个参数实在太大我们希望能够避免进行这种默认的拷贝，这种情况下我们就需要用到指针了。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;package&lt;/span&gt; &lt;span style="color:#75af00"&gt;main&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;import&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;fmt&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;type&lt;/span&gt; &lt;span style="color:#75af00"&gt;People&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;struct&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;name&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;string&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;age&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;uint8&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;p&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;People&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75af00"&gt;SayHello&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;p&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;name&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;: hello world&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;p&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;age&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;20&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;main&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;p&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;People&lt;/span&gt;&lt;span style="color:#111"&gt;{&lt;/span&gt;&lt;span style="color:#75af00"&gt;name&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;zhaohaiyu&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;age&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;18&lt;/span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;p&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;SayHello&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#75715e"&gt;// zhaohaiyu : hello world&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;p&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;age&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 20&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;调用时p为person的结构体对象,SayHello是People结构体指针的方法,在go中可以直接调用,亦可以(&amp;amp;p).SayHello()&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Nil也是一个合法的接收器类型&lt;/strong&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;package&lt;/span&gt; &lt;span style="color:#75af00"&gt;main&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;import&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;fmt&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;type&lt;/span&gt; &lt;span style="color:#75af00"&gt;MySlice&lt;/span&gt; &lt;span style="color:#111"&gt;[]&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;int&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;m&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;MySlice&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75af00"&gt;sum&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;int&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;var&lt;/span&gt; &lt;span style="color:#75af00"&gt;num&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;int&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;for&lt;/span&gt; &lt;span style="color:#75af00"&gt;_&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;i&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;range&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;m&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;num&lt;/span&gt; &lt;span style="color:#f92672"&gt;+=&lt;/span&gt; &lt;span style="color:#75af00"&gt;i&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt; &lt;span style="color:#75af00"&gt;num&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;main&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;m&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;MySlice&lt;/span&gt;&lt;span style="color:#111"&gt;{&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;1&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;2&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;3&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;4&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;5&lt;/span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;m&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;sum&lt;/span&gt;&lt;span style="color:#111"&gt;())&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 15&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;m&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;m&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;sum&lt;/span&gt;&lt;span style="color:#111"&gt;())&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 0&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id="封装"&gt;封装&lt;/h2&gt;
&lt;p&gt;一个对象的变量或者方法如果对调用方是不可见的话，一般就被定义为“封装”。封装有时候也被叫做信息隐藏，同时也是面向对象编程最关键的一个方面。&lt;/p&gt;
&lt;p&gt;Go语言只有一种控制可见性的手段：大写首字母的标识符会从定义它们的包中被导出，小写字母的则不会。这种限制包内成员的方式同样适用于struct或者一个类型的方法。因而如果我们想要封装一个对象，我们必须将其定义为一个struct。&lt;/p&gt;</description><content:encoded><![CDATA[<h2 id="方法声明">方法声明</h2>
<p>在函数声明时，在其名字之前放上一个变量，即是一个方法。这个附加的参数会将该函数附加到这种类型上，即相当于为这种类型定义了一个独占的方法。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">People</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">name</span> <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">age</span>  <span style="color:#00a8c8">uint8</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">p</span> <span style="color:#75af00">People</span><span style="color:#111">)</span> <span style="color:#75af00">SayHello</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">name</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;: hello world&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">age</span> <span style="color:#111">=</span> <span style="color:#ae81ff">20</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">p</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">People</span><span style="color:#111">{</span><span style="color:#75af00">name</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;zhaohaiyu&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">age</span><span style="color:#111">:</span> <span style="color:#ae81ff">18</span><span style="color:#111">}</span> 
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">SayHello</span><span style="color:#111">()</span>   <span style="color:#75715e">// zhaohaiyu : hello world</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">age</span><span style="color:#111">)</span>	<span style="color:#75715e">//18</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="基于指针对象的方法">基于指针对象的方法</h2>
<p>当调用一个函数时，会对其每一个参数值进行拷贝，如果一个函数需要更新一个变量，或者函数的其中一个参数实在太大我们希望能够避免进行这种默认的拷贝，这种情况下我们就需要用到指针了。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">People</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">name</span> <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">age</span>  <span style="color:#00a8c8">uint8</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">p</span> <span style="color:#f92672">*</span><span style="color:#75af00">People</span><span style="color:#111">)</span> <span style="color:#75af00">SayHello</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">name</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;: hello world&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">age</span> <span style="color:#111">=</span> <span style="color:#ae81ff">20</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">p</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">People</span><span style="color:#111">{</span><span style="color:#75af00">name</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;zhaohaiyu&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">age</span><span style="color:#111">:</span> <span style="color:#ae81ff">18</span><span style="color:#111">}</span> 
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">SayHello</span><span style="color:#111">()</span>   <span style="color:#75715e">// zhaohaiyu : hello world</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">age</span><span style="color:#111">)</span>	<span style="color:#75715e">// 20</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>调用时p为person的结构体对象,SayHello是People结构体指针的方法,在go中可以直接调用,亦可以(&amp;p).SayHello()</p>
<p><strong>Nil也是一个合法的接收器类型</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">MySlice</span> <span style="color:#111">[]</span><span style="color:#00a8c8">int</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">m</span> <span style="color:#f92672">*</span><span style="color:#75af00">MySlice</span><span style="color:#111">)</span> <span style="color:#75af00">sum</span><span style="color:#111">()</span> <span style="color:#00a8c8">int</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">var</span> <span style="color:#75af00">num</span> <span style="color:#00a8c8">int</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">i</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#f92672">*</span><span style="color:#75af00">m</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">num</span> <span style="color:#f92672">+=</span> <span style="color:#75af00">i</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">num</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">m</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">MySlice</span><span style="color:#111">{</span><span style="color:#ae81ff">1</span><span style="color:#111">,</span><span style="color:#ae81ff">2</span><span style="color:#111">,</span><span style="color:#ae81ff">3</span><span style="color:#111">,</span><span style="color:#ae81ff">4</span><span style="color:#111">,</span><span style="color:#ae81ff">5</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">sum</span><span style="color:#111">())</span> <span style="color:#75715e">// 15</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">m</span> <span style="color:#111">=</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">sum</span><span style="color:#111">())</span> <span style="color:#75715e">// 0</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="封装">封装</h2>
<p>一个对象的变量或者方法如果对调用方是不可见的话，一般就被定义为“封装”。封装有时候也被叫做信息隐藏，同时也是面向对象编程最关键的一个方面。</p>
<p>Go语言只有一种控制可见性的手段：大写首字母的标识符会从定义它们的包中被导出，小写字母的则不会。这种限制包内成员的方式同样适用于struct或者一个类型的方法。因而如果我们想要封装一个对象，我们必须将其定义为一个struct。</p>
<p>这也就是前面的小节中IntSet被定义为struct类型的原因，尽管它只有一个字段：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">IntSet</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">words</span> <span style="color:#111">[]</span><span style="color:#00a8c8">uint64</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>当然，我们也可以把IntSet定义为一个slice类型，尽管这样我们就需要把代码中所有方法里用到的s.words用*s替换掉了：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">IntSet</span> <span style="color:#111">[]</span><span style="color:#00a8c8">uint64</span>
</span></span></code></pre></div>]]></content:encoded><category>go</category><category>go</category></item><item><title>golang time包</title><link>https://daemon365.dev/post/go/golang_time_package/</link><pubDate>Fri, 21 Jun 2019 00:00:00 +0800</pubDate><guid>https://daemon365.dev/post/go/golang_time_package/</guid><description>&lt;h2 id="时间类型"&gt;时间类型&lt;/h2&gt;
&lt;p&gt;time.Time类型表示时间。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;demo&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;now&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;time&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Now&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#75715e"&gt;//获取当前时间&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Printf&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;Now:%v\n&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;now&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75715e"&gt;// Now:2020-08-19 21:53:31.1633023 +0800 CST m=+0.003989401&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;year&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;now&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Year&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#75715e"&gt;//年&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;month&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;now&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Month&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#75715e"&gt;//月&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;day&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;now&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Day&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#75715e"&gt;//日&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;hour&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;now&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Hour&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#75715e"&gt;//小时&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;minute&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;now&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Minute&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#75715e"&gt;//分钟&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;second&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;now&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Second&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#75715e"&gt;//秒&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Printf&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;%d-%02d-%02d %02d:%02d:%02d\n&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;year&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;month&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;day&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;hour&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;minute&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;second&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 2020-08-19 21:53:31&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id="时间戳"&gt;时间戳&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;stamp&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;now&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;time&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Now&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#75715e"&gt;//获取当前时间&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;timestamp1&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;now&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Unix&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#75715e"&gt;//时间戳&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;timestamp2&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;now&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;UnixNano&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#75715e"&gt;//纳秒时间戳&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Printf&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;秒时间戳:%v\n&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;timestamp1&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 秒时间戳:1597845356&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Printf&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;纳秒时间戳:%v\n&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;timestamp2&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 纳秒时间戳:1597845356562315400&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;使用time.Unix()函数可以将时间戳转为时间格式。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;demo2&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;timestamp&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;int64&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;timeObj&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;time&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Unix&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;1462032000&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;0&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75715e"&gt;//将时间戳转为时间格式&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;timeObj&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 2016-05-01 00:00:00 +0800 CST&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id="时间格式化"&gt;时间格式化&lt;/h2&gt;
&lt;p&gt;时间类型有一个自带的方法Format进行格式化，需要注意的是Go语言中格式化时间模板不是常见的Y-m-d H:M:S而是使用Go的诞生时间2006年1月2号15点04分&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;demo4&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;now&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;time&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Now&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;now&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Format&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;2006-01-02 15:04:05.000 Mon Jan&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;))&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 2020-08-19 22:02:46.296 Wed Aug&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;now&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Format&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;2006-01-02 03:04:05.000 PM Mon Jan&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;))&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 2020-08-19 10:02:46.296 PM Wed Aug&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;now&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Format&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;2006*01*02&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;))&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 2020*08*19&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;strong&gt;解析字符串格式的时间&lt;/strong&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;// 加载时区&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75af00"&gt;loc&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;time&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;LoadLocation&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;Asia/Shanghai&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;!=&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;err&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;// 解析字符串时间&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75af00"&gt;timeObj&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;time&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;ParseInLocation&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;2006/01/02 15:04:05&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;2016/04/30 22:00:00&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;loc&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;!=&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;err&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;timeObj&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 2016-04-30 22:00:00 +0800 CST&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;timeObj&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Unix&lt;/span&gt;&lt;span style="color:#111"&gt;())&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 1462024800&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id="时间操作"&gt;时间操作&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;func (t Time) Add(d Duration) Time加时间&lt;/li&gt;
&lt;li&gt;func (t Time) Sub(u Time) Duration减时间&lt;/li&gt;
&lt;li&gt;func (t Time) Before(u Time) bool在u之前&lt;/li&gt;
&lt;li&gt;func (t Time) After(u Time) bool在u之后&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;package&lt;/span&gt; &lt;span style="color:#75af00"&gt;main&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;import&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;fmt&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;time&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;formatDemo&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;now&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;time&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Now&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;now&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Format&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;2006-01-02 15:04:05.000 Mon Jan&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;))&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 2020-08-19 22:02:46.296 Wed Aug&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;now&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Format&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;2006-01-02 03:04:05.000 PM Mon Jan&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;))&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 2020-08-19 10:02:46.296 PM Wed Aug&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;now&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Format&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;2006*01*02&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;))&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 2020*08*19&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;main&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// 加载时区&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;loc&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;time&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;LoadLocation&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;Asia/Shanghai&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;!=&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;err&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// 解析字符串时间&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;timeObj&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;time&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;ParseInLocation&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;2006/01/02 15:04:05&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;2016/04/30 22:00:00&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;loc&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;!=&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;err&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;timeObj&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 2016-04-30 22:00:00 +0800 CST&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;now&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;time&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Now&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;a&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;now&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Add&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;time&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Hour&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;a&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 2020-08-19 23:15:30.0153059 +0800 CST m=+3600.002023801&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;s&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;now&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Sub&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;timeObj&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;s&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 37728h15m30.0153059s&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;now&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Before&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;timeObj&lt;/span&gt;&lt;span style="color:#111"&gt;))&lt;/span&gt; &lt;span style="color:#75715e"&gt;// false&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;now&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;After&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;timeObj&lt;/span&gt;&lt;span style="color:#111"&gt;))&lt;/span&gt; &lt;span style="color:#75715e"&gt;// true&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id="定时器"&gt;定时器&lt;/h2&gt;
&lt;p&gt;使用time.Tick(时间间隔)来设置定时器，定时器的本质上是一个channel&lt;/p&gt;</description><content:encoded><![CDATA[<h2 id="时间类型">时间类型</h2>
<p>time.Time类型表示时间。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">demo</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">now</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Now</span><span style="color:#111">()</span> <span style="color:#75715e">//获取当前时间</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Now:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">now</span><span style="color:#111">)</span>  <span style="color:#75715e">// Now:2020-08-19 21:53:31.1633023 +0800 CST m=+0.003989401</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">year</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">now</span><span style="color:#111">.</span><span style="color:#75af00">Year</span><span style="color:#111">()</span>     <span style="color:#75715e">//年</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">month</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">now</span><span style="color:#111">.</span><span style="color:#75af00">Month</span><span style="color:#111">()</span>   <span style="color:#75715e">//月</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">day</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">now</span><span style="color:#111">.</span><span style="color:#75af00">Day</span><span style="color:#111">()</span>       <span style="color:#75715e">//日</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">hour</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">now</span><span style="color:#111">.</span><span style="color:#75af00">Hour</span><span style="color:#111">()</span>     <span style="color:#75715e">//小时</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">minute</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">now</span><span style="color:#111">.</span><span style="color:#75af00">Minute</span><span style="color:#111">()</span> <span style="color:#75715e">//分钟</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">second</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">now</span><span style="color:#111">.</span><span style="color:#75af00">Second</span><span style="color:#111">()</span> <span style="color:#75715e">//秒</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;%d-%02d-%02d %02d:%02d:%02d\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">year</span><span style="color:#111">,</span> <span style="color:#75af00">month</span><span style="color:#111">,</span> <span style="color:#75af00">day</span><span style="color:#111">,</span> <span style="color:#75af00">hour</span><span style="color:#111">,</span> <span style="color:#75af00">minute</span><span style="color:#111">,</span> <span style="color:#75af00">second</span><span style="color:#111">)</span> <span style="color:#75715e">// 2020-08-19 21:53:31</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="时间戳">时间戳</h2>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">stamp</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">now</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Now</span><span style="color:#111">()</span>            <span style="color:#75715e">//获取当前时间</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">timestamp1</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">now</span><span style="color:#111">.</span><span style="color:#75af00">Unix</span><span style="color:#111">()</span>     <span style="color:#75715e">//时间戳</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">timestamp2</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">now</span><span style="color:#111">.</span><span style="color:#75af00">UnixNano</span><span style="color:#111">()</span> <span style="color:#75715e">//纳秒时间戳</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;秒时间戳:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">timestamp1</span><span style="color:#111">)</span> <span style="color:#75715e">// 秒时间戳:1597845356</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;纳秒时间戳:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">timestamp2</span><span style="color:#111">)</span> <span style="color:#75715e">// 纳秒时间戳:1597845356562315400</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>使用time.Unix()函数可以将时间戳转为时间格式。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">demo2</span><span style="color:#111">(</span><span style="color:#75af00">timestamp</span> <span style="color:#00a8c8">int64</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">timeObj</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Unix</span><span style="color:#111">(</span><span style="color:#ae81ff">1462032000</span><span style="color:#111">,</span> <span style="color:#ae81ff">0</span><span style="color:#111">)</span> <span style="color:#75715e">//将时间戳转为时间格式</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">timeObj</span><span style="color:#111">)</span> <span style="color:#75715e">// 2016-05-01 00:00:00 +0800 CST</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="时间格式化">时间格式化</h2>
<p>时间类型有一个自带的方法Format进行格式化，需要注意的是Go语言中格式化时间模板不是常见的Y-m-d H:M:S而是使用Go的诞生时间2006年1月2号15点04分</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">demo4</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">now</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Now</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">now</span><span style="color:#111">.</span><span style="color:#75af00">Format</span><span style="color:#111">(</span><span style="color:#d88200">&#34;2006-01-02 15:04:05.000 Mon Jan&#34;</span><span style="color:#111">))</span> <span style="color:#75715e">// 2020-08-19 22:02:46.296 Wed Aug</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">now</span><span style="color:#111">.</span><span style="color:#75af00">Format</span><span style="color:#111">(</span><span style="color:#d88200">&#34;2006-01-02 03:04:05.000 PM Mon Jan&#34;</span><span style="color:#111">))</span> <span style="color:#75715e">// 2020-08-19 10:02:46.296 PM Wed Aug</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">now</span><span style="color:#111">.</span><span style="color:#75af00">Format</span><span style="color:#111">(</span><span style="color:#d88200">&#34;2006*01*02&#34;</span><span style="color:#111">))</span> <span style="color:#75715e">// 2020*08*19</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p><strong>解析字符串格式的时间</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// 加载时区</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">loc</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">LoadLocation</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Asia/Shanghai&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 解析字符串时间</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">timeObj</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">ParseInLocation</span><span style="color:#111">(</span><span style="color:#d88200">&#34;2006/01/02 15:04:05&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;2016/04/30 22:00:00&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">loc</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">timeObj</span><span style="color:#111">)</span> <span style="color:#75715e">// 2016-04-30 22:00:00 +0800 CST</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">timeObj</span><span style="color:#111">.</span><span style="color:#75af00">Unix</span><span style="color:#111">())</span> <span style="color:#75715e">// 1462024800</span>
</span></span></code></pre></div><h2 id="时间操作">时间操作</h2>
<ul>
<li>func (t Time) Add(d Duration) Time加时间</li>
<li>func (t Time) Sub(u Time) Duration减时间</li>
<li>func (t Time) Before(u Time) bool在u之前</li>
<li>func (t Time) After(u Time) bool在u之后</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">formatDemo</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">now</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Now</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">now</span><span style="color:#111">.</span><span style="color:#75af00">Format</span><span style="color:#111">(</span><span style="color:#d88200">&#34;2006-01-02 15:04:05.000 Mon Jan&#34;</span><span style="color:#111">))</span>    <span style="color:#75715e">// 2020-08-19 22:02:46.296 Wed Aug</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">now</span><span style="color:#111">.</span><span style="color:#75af00">Format</span><span style="color:#111">(</span><span style="color:#d88200">&#34;2006-01-02 03:04:05.000 PM Mon Jan&#34;</span><span style="color:#111">))</span> <span style="color:#75715e">// 2020-08-19 10:02:46.296 PM Wed Aug</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">now</span><span style="color:#111">.</span><span style="color:#75af00">Format</span><span style="color:#111">(</span><span style="color:#d88200">&#34;2006*01*02&#34;</span><span style="color:#111">))</span>                         <span style="color:#75715e">// 2020*08*19</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 加载时区</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">loc</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">LoadLocation</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Asia/Shanghai&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 解析字符串时间</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">timeObj</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">ParseInLocation</span><span style="color:#111">(</span><span style="color:#d88200">&#34;2006/01/02 15:04:05&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;2016/04/30 22:00:00&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">loc</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">timeObj</span><span style="color:#111">)</span> <span style="color:#75715e">// 2016-04-30 22:00:00 +0800 CST</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">now</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Now</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">a</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">now</span><span style="color:#111">.</span><span style="color:#75af00">Add</span><span style="color:#111">(</span><span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Hour</span><span style="color:#111">)</span> 
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">a</span><span style="color:#111">)</span>   <span style="color:#75715e">// 2020-08-19 23:15:30.0153059 +0800 CST m=+3600.002023801</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">s</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">now</span><span style="color:#111">.</span><span style="color:#75af00">Sub</span><span style="color:#111">(</span><span style="color:#75af00">timeObj</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">s</span><span style="color:#111">)</span> <span style="color:#75715e">// 37728h15m30.0153059s</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">now</span><span style="color:#111">.</span><span style="color:#75af00">Before</span><span style="color:#111">(</span><span style="color:#75af00">timeObj</span><span style="color:#111">))</span> <span style="color:#75715e">// false</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">now</span><span style="color:#111">.</span><span style="color:#75af00">After</span><span style="color:#111">(</span><span style="color:#75af00">timeObj</span><span style="color:#111">))</span> <span style="color:#75715e">// true</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="定时器">定时器</h2>
<p>使用time.Tick(时间间隔)来设置定时器，定时器的本质上是一个channel</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">tickDemo</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ticker</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Tick</span><span style="color:#111">(</span><span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Second</span><span style="color:#111">)</span> <span style="color:#75715e">//定义一个1秒间隔的定时器</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">i</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">ticker</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">i</span><span style="color:#111">)</span> <span style="color:#75715e">//每秒都会打印时间</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div>]]></content:encoded><category>go</category><category>go</category></item><item><title>golang error错误处理</title><link>https://daemon365.dev/post/go/golang_error_error_handling/</link><pubDate>Thu, 20 Jun 2019 00:00:00 +0800</pubDate><guid>https://daemon365.dev/post/go/golang_error_error_handling/</guid><description>&lt;h2 id="error定义"&gt;error定义&lt;/h2&gt;
&lt;h3 id="数据结构"&gt;数据结构&lt;/h3&gt;
&lt;p&gt;go语言error是一普通的值，实现方式为简单一个接口。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;// The error built-in interface type is the conventional interface for&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;// representing an error condition, with the nil value representing no error.&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;type&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;error&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;interface&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;Error&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;string&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;创建error&lt;/p&gt;
&lt;p&gt;使用&lt;code&gt;errors.New()&lt;/code&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;// New returns an error that formats as the given text.&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;// Each call to New returns a distinct error value even if the text is identical.&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;New&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;text&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;string&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;error&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt; &lt;span style="color:#f92672"&gt;&amp;amp;&lt;/span&gt;&lt;span style="color:#75af00"&gt;errorString&lt;/span&gt;&lt;span style="color:#111"&gt;{&lt;/span&gt;&lt;span style="color:#75af00"&gt;text&lt;/span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;// errorString is a trivial implementation of error.&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;type&lt;/span&gt; &lt;span style="color:#75af00"&gt;errorString&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;struct&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;s&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;string&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;e&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;errorString&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75af00"&gt;Error&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;string&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt; &lt;span style="color:#75af00"&gt;e&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;s&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;返回的是errorString结构体 实现了error接口的Error()方法&lt;/p&gt;</description><content:encoded><![CDATA[<h2 id="error定义">error定义</h2>
<h3 id="数据结构">数据结构</h3>
<p>go语言error是一普通的值，实现方式为简单一个接口。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// The error built-in interface type is the conventional interface for</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// representing an error condition, with the nil value representing no error.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#00a8c8">error</span> <span style="color:#00a8c8">interface</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">Error</span><span style="color:#111">()</span> <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>创建error</p>
<p>使用<code>errors.New()</code></p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// New returns an error that formats as the given text.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Each call to New returns a distinct error value even if the text is identical.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">New</span><span style="color:#111">(</span><span style="color:#75af00">text</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">errorString</span><span style="color:#111">{</span><span style="color:#75af00">text</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// errorString is a trivial implementation of error.</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">errorString</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">s</span> <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">e</span> <span style="color:#f92672">*</span><span style="color:#75af00">errorString</span><span style="color:#111">)</span> <span style="color:#75af00">Error</span><span style="color:#111">()</span> <span style="color:#00a8c8">string</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">s</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>返回的是errorString结构体 实现了error接口的Error()方法</p>
<p>使用<code>fmt.Errorf（）</code>创建</p>
<p>创建方式为把字符串拼接起来，然后调用errors.New().</p>
<h3 id="基础库中的自定义的error">基础库中的自定义的error</h3>
<p>bufio中的错误：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">ErrTooLong</span>         <span style="color:#111">=</span> <span style="color:#75af00">errors</span><span style="color:#111">.</span><span style="color:#75af00">New</span><span style="color:#111">(</span><span style="color:#d88200">&#34;bufio.Scanner: token too long&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">ErrNegativeAdvance</span> <span style="color:#111">=</span> <span style="color:#75af00">errors</span><span style="color:#111">.</span><span style="color:#75af00">New</span><span style="color:#111">(</span><span style="color:#d88200">&#34;bufio.Scanner: SplitFunc returns negative advance count&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">ErrAdvanceTooFar</span>   <span style="color:#111">=</span> <span style="color:#75af00">errors</span><span style="color:#111">.</span><span style="color:#75af00">New</span><span style="color:#111">(</span><span style="color:#d88200">&#34;bufio.Scanner: SplitFunc returns advance count beyond input&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">ErrBadReadCount</span>    <span style="color:#111">=</span> <span style="color:#75af00">errors</span><span style="color:#111">.</span><span style="color:#75af00">New</span><span style="color:#111">(</span><span style="color:#d88200">&#34;bufio.Scanner: Read returned impossible count&#34;</span><span style="color:#111">)</span>
</span></span></code></pre></div><h2 id="error的比较">error的比较</h2>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d88200">&#34;errors&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">errorString</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">s</span> <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">new</span><span style="color:#111">(</span><span style="color:#75af00">s</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">errorString</span><span style="color:#111">{</span><span style="color:#75af00">s</span><span style="color:#111">:</span> <span style="color:#75af00">s</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">e</span> <span style="color:#f92672">*</span><span style="color:#75af00">errorString</span><span style="color:#111">)</span> <span style="color:#75af00">Error</span><span style="color:#111">()</span> <span style="color:#00a8c8">string</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">s</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">error1</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">errors</span><span style="color:#111">.</span><span style="color:#75af00">New</span><span style="color:#111">(</span><span style="color:#d88200">&#34;test&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">error2</span> <span style="color:#f92672">:=</span> <span style="color:#111">new</span><span style="color:#111">(</span><span style="color:#d88200">&#34;test&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">error1</span> <span style="color:#f92672">==</span> <span style="color:#75af00">error2</span><span style="color:#111">)</span> <span style="color:#75715e">// false</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// 比较结构体</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">errorString</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">s</span> <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">new</span><span style="color:#111">(</span><span style="color:#75af00">s</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">errorString</span><span style="color:#111">{</span><span style="color:#75af00">s</span><span style="color:#111">:</span> <span style="color:#75af00">s</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">e</span> <span style="color:#f92672">*</span><span style="color:#75af00">errorString</span><span style="color:#111">)</span> <span style="color:#75af00">Error</span><span style="color:#111">()</span> <span style="color:#00a8c8">string</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">s</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">error1</span> <span style="color:#f92672">:=</span> <span style="color:#111">new</span><span style="color:#111">(</span><span style="color:#d88200">&#34;test&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">error1</span> <span style="color:#f92672">==</span> <span style="color:#111">new</span><span style="color:#111">(</span><span style="color:#d88200">&#34;test&#34;</span><span style="color:#111">))</span> <span style="color:#75715e">// false</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">errorString</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">s</span> <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">new</span><span style="color:#111">(</span><span style="color:#75af00">s</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#75af00">errorString</span><span style="color:#111">{</span><span style="color:#75af00">s</span><span style="color:#111">:</span> <span style="color:#75af00">s</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">e</span> <span style="color:#75af00">errorString</span><span style="color:#111">)</span> <span style="color:#75af00">Error</span><span style="color:#111">()</span> <span style="color:#00a8c8">string</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">s</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">error1</span> <span style="color:#f92672">:=</span> <span style="color:#111">new</span><span style="color:#111">(</span><span style="color:#d88200">&#34;test&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">error1</span> <span style="color:#f92672">==</span> <span style="color:#111">new</span><span style="color:#111">(</span><span style="color:#d88200">&#34;test&#34;</span><span style="color:#111">))</span> <span style="color:#75715e">// true</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p><strong>error对比为对比对比实现interface的结构体类型 和结构体本身</strong></p>
<h2 id="error-or-exception">Error or Exception</h2>
<h3 id="处理错误的演进">处理错误的演进</h3>
<ol>
<li>C</li>
</ol>
<ul>
<li>单返回值，一般通过传递指针作为入参，返回值为 int 表示成功还是失败。</li>
</ul>
<ol start="2">
<li>C++</li>
</ol>
<ul>
<li>引入了 exception，但是无法知道被调用方会抛出什么异常。</li>
</ul>
<ol start="3">
<li>Java</li>
</ol>
<ul>
<li>引入了 checked exception，方法的所有者必须申明，调用者必须处理。在启动时抛出大量的异常是司空见惯的事情，并在它们的调用堆栈中尽职地记录下来。Java 异常不再是异常，而是变得司空见惯了。它们从良性到灾难性都有使用，异常的严重性由函数的调用者来区分</li>
</ul>
<ol start="4">
<li>go</li>
</ol>
<ul>
<li>
<p>Go 的处理异常逻辑是不引入 exception，支持多参数返回，所以你很容易的在函数签名中带上实现了 error interface 的对象，交由调用者来判定。</p>
</li>
<li>
<p>如果一个函数返回了 value, error，你不能对这个 value 做任何假设，必须先判定 error。唯一可以忽略 error 的是，如果你连 value 也不关心。</p>
</li>
<li>
<p>Go 中有 panic 的机制，如果你认为和其他语言的 exception 一样，那你就错了。当我们抛出异常的时候，相当于你把 exception 扔给了调用者来处理。比如，你在 C++ 中，把 string 转为 int，如果转换失败，会抛出异常。或者在 java 中转换 string 为 date 失败时，会抛出异常。</p>
</li>
<li>
<p>Go panic 意味着 fatal error(就是挂了)。不能假设调用者来解决 panic，意味着代码不能继续运行。</p>
</li>
<li>
<p>使用多个返回值和一个简单的约定，Go 解决了让程序员知道什么时候出了问题，并为真正的异常情况保留了 panic。</p>
</li>
</ul>
<h3 id="代码对比">代码对比</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">Positive</span><span style="color:#111">(</span><span style="color:#75af00">x</span> <span style="color:#00a8c8">int</span><span style="color:#111">)</span> <span style="color:#00a8c8">bool</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#75af00">x</span> <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">Check</span><span style="color:#111">(</span><span style="color:#75af00">x</span> <span style="color:#00a8c8">int</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">Positive</span><span style="color:#111">(</span><span style="color:#75af00">x</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;正数&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;负数&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">Check</span><span style="color:#111">(</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span> <span style="color:#75715e">// 负数</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">Check</span><span style="color:#111">(</span><span style="color:#ae81ff">0</span><span style="color:#111">)</span>  <span style="color:#75715e">// 正数 bug</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">Check</span><span style="color:#111">(</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span>  <span style="color:#75715e">// 正数</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">Positive</span><span style="color:#111">(</span><span style="color:#75af00">x</span> <span style="color:#00a8c8">int</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#00a8c8">bool</span><span style="color:#111">,</span> <span style="color:#00a8c8">bool</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">x</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#00a8c8">false</span><span style="color:#111">,</span> <span style="color:#00a8c8">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#75af00">x</span> <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#00a8c8">true</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">Check</span><span style="color:#111">(</span><span style="color:#75af00">x</span> <span style="color:#00a8c8">int</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">t</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">Positive</span><span style="color:#111">(</span><span style="color:#75af00">x</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;零&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">t</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;正数&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;负数&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">Check</span><span style="color:#111">(</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span> <span style="color:#75715e">// 负数</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">Check</span><span style="color:#111">(</span><span style="color:#ae81ff">0</span><span style="color:#111">)</span>  <span style="color:#75715e">// 零</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">Check</span><span style="color:#111">(</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span>  <span style="color:#75715e">// 正数</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d88200">&#34;errors&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">Positive</span><span style="color:#111">(</span><span style="color:#75af00">x</span> <span style="color:#00a8c8">int</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#00a8c8">bool</span><span style="color:#111">,</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">x</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#00a8c8">false</span><span style="color:#111">,</span> <span style="color:#75af00">errors</span><span style="color:#111">.</span><span style="color:#75af00">New</span><span style="color:#111">(</span><span style="color:#d88200">&#34;为零&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#75af00">x</span> <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">Check</span><span style="color:#111">(</span><span style="color:#75af00">x</span> <span style="color:#00a8c8">int</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">t</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">Positive</span><span style="color:#111">(</span><span style="color:#75af00">x</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">t</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;正数&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;负数&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">Check</span><span style="color:#111">(</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span> <span style="color:#75715e">// 负数</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">Check</span><span style="color:#111">(</span><span style="color:#ae81ff">0</span><span style="color:#111">)</span>  <span style="color:#75715e">// 为零</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">Check</span><span style="color:#111">(</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span>  <span style="color:#75715e">// 正数</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="error使用">error使用</h3>
<p>对于真正意外的情况，那些表示不可恢复的程序错误，例如索引越界、不可恢复的环境问题、栈溢出，我们才使用 panic。对于其他的错误情况，我们应该是期望使用 error 来进行判定。</p>
<ul>
<li>
<p>简单。</p>
</li>
<li>
<p>考虑失败，而不是成功。</p>
</li>
<li>
<p>没有隐藏的控制流。</p>
</li>
<li>
<p>完全交给你来控制 error。</p>
</li>
<li>
<p>Error are values。</p>
</li>
</ul>
<h2 id="sentinel-error">Sentinel Error</h2>
<p>预定义的特定错误，我们叫为 sentinel error，这个名字来源于计算机编程中使用一个特定值来表示不可能进行进一步处理的做法。所以对于 Go，我们使用特定的值来表示错误。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">==</span> <span style="color:#75af00">ErrSomething</span> <span style="color:#111">{</span> <span style="color:#960050;background-color:#1e0010">…</span> <span style="color:#111">}</span>
</span></span></code></pre></div><p>类似的 <code>io.EOF</code>，更底层的 <code>syscall.ENOENT</code>。</p>
<p>使用 sentinel 值是最不灵活的错误处理策略，因为调用方必须使用 == 将结果与预先声明的值进行比较。当您想要提供更多的上下文时，这就出现了一个问题，因为返回一个不同的错误将破坏相等性检查。</p>
<p>甚至是一些有意义的 fmt.Errorf 携带一些上下文，也会破坏调用者的 == ，调用者将被迫查看 error.Error() 方法的输出，以查看它是否与特定的字符串匹配。</p>
<ul>
<li>不依赖检查 error.Error 的输出。</li>
</ul>
<p>不应该依赖检测 error.Error 的输出，Error 方法存在于 error 接口主要用于方便程序员使用，但不是程序(编写测试可能会依赖这个返回)。这个输出的字符串用于记录日志、输出到 stdout 等。</p>
<ul>
<li>Sentinel errors 成为你 API 公共部分。</li>
</ul>
<p>如果您的公共函数或方法返回一个特定值的错误，那么该值必须是公共的，当然要有文档记录，这会增加 API 的表面积。</p>
<p>如果 API 定义了一个返回特定错误的 interface，则该接口的所有实现都将被限制为仅返回该错误，即使它们可以提供更具描述性的错误。</p>
<p>比如 io.Reader。像 io.Copy 这类函数需要 reader 的实现者比如返回 io.EOF 来告诉调用者没有更多数据了，但这又不是错误。</p>
<ul>
<li>Sentinel errors 在两个包之间创建了依赖。</li>
</ul>
<p>sentinel errors 最糟糕的问题是它们在两个包之间创建了源代码依赖关系。例如，检查错误是否等于 io.EOF，您的代码必须导入 io 包。这个特定的例子听起来并不那么糟糕，因为它非常常见，但是想象一下，当项目中的许多包导出错误值时，存在耦合，项目中的其他包必须导入这些错误值才能检查特定的错误条件(in the form of an import loop)。</p>
<ul>
<li>结论: 尽可能避免 sentinel errors。</li>
</ul>
<p>我的建议是避免在编写的代码中使用 sentinel errors。在标准库中有一些使用它们的情况，但这不是一个您应该模仿的模式。</p>
<h2 id="错误类型">错误类型</h2>
<p>Error type 是实现了 error 接口的自定义类型。例如 MyError 类型记录了文件和行号以展示发生了什么。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Myerror</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">line</span> <span style="color:#00a8c8">int</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">file</span> <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">s</span>    <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">e</span> <span style="color:#f92672">*</span><span style="color:#75af00">Myerror</span><span style="color:#111">)</span> <span style="color:#75af00">Error</span><span style="color:#111">()</span> <span style="color:#00a8c8">string</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">s</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">new</span><span style="color:#111">(</span><span style="color:#75af00">file</span> <span style="color:#00a8c8">string</span><span style="color:#111">,</span> <span style="color:#75af00">line</span> <span style="color:#00a8c8">int</span><span style="color:#111">,</span> <span style="color:#75af00">s</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">Myerror</span><span style="color:#111">{</span><span style="color:#75af00">line</span><span style="color:#111">:</span> <span style="color:#75af00">line</span><span style="color:#111">,</span> <span style="color:#75af00">file</span><span style="color:#111">:</span> <span style="color:#75af00">file</span><span style="color:#111">,</span> <span style="color:#75af00">s</span><span style="color:#111">:</span> <span style="color:#75af00">s</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>因为 MyError 是一个 type，调用者可以使用断言转换成这个类型，来获取更多的上下文信息。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#111">new</span><span style="color:#111">(</span><span style="color:#d88200">&#34;main.go&#34;</span><span style="color:#111">,</span> <span style="color:#ae81ff">23</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;test error&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">switch</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">err</span><span style="color:#111">.(</span><span style="color:#00a8c8">type</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">case</span> <span style="color:#00a8c8">nil</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;err is nil&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">case</span> <span style="color:#f92672">*</span><span style="color:#75af00">Myerror</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;type is *Myerror err line :&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">.</span><span style="color:#75af00">line</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">default</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;None of them&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 结果:type is *Myerror err line : 23</span>
</span></span></code></pre></div><p>与错误值相比，错误类型的一大改进是它们能够包装底层错误以提供更多上下文。</p>
<p>一个不错的例子就是 os.PathError 他提供了底层执行了什么操作、那个路径出了什么问题。</p>
<p>调用者要使用类型断言和类型 switch，就要让自定义的 error 变为 public。这种模型会导致和调用者产生强耦合，从而导致 API 变得脆弱。</p>
<p>结论是尽量避免使用 error types，虽然错误类型比 sentinel errors 更好，因为它们可以捕获关于出错的更多上下文，但是 error types 共享 error values 许多相同的问题。</p>
<p>因此，我的建议是避免错误类型，或者至少避免将它们作为公共 API 的一部分。</p>
<h3 id="非透明的error">非透明的error</h3>
<p>在我看来，这是最灵活的错误处理策略，因为它要求代码和调用者之间的耦合最少。</p>
<p>我将这种风格称为不透明错误处理，因为虽然您知道发生了错误，但您没有能力看到错误的内部。作为调用者，关于操作的结果，您所知道的就是它起作用了，或者没有起作用(成功还是失败)。</p>
<p>这就是不透明错误处理的全部功能–只需返回错误而不假设其内容</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#d88200">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">test</span><span style="color:#111">()</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">f</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">Open</span><span style="color:#111">(</span><span style="color:#d88200">&#34;filename.txt&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// use f </span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>为行为而不是类型断言错误  在少数情况下，这种二分错误处理方法是不够的。例如，与进程外的世界进行交互(如网络活动)，需要调用方调查错误的性质，以确定重试该操作是否合理。在这种情况下，我们可以断言错误实现了特定的行为，而不是断言错误是特定的类型或值。考虑这个例子：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// 封装内部</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">temporary</span> <span style="color:#00a8c8">interface</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">Temporary</span><span style="color:#111">()</span> <span style="color:#00a8c8">bool</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">IsTemporary</span><span style="color:#111">(</span><span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#00a8c8">bool</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">te</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">err</span><span style="color:#111">.(</span><span style="color:#75af00">temporary</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">te</span><span style="color:#111">.</span><span style="color:#75af00">Temporary</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// net包的error</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Error</span> <span style="color:#00a8c8">interface</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">error</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">Timeout</span><span style="color:#111">()</span> <span style="color:#00a8c8">bool</span>   <span style="color:#75715e">// Is the error a timeout?</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">Temporary</span><span style="color:#111">()</span> <span style="color:#00a8c8">bool</span> <span style="color:#75715e">// Is the error temporary?</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 错误处理</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#75af00">nerr</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">err</span><span style="color:#111">.(</span><span style="color:#75af00">net</span><span style="color:#111">.</span><span style="color:#75af00">Error</span><span style="color:#111">);</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">nerr</span><span style="color:#111">.</span><span style="color:#75af00">Temporary</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 处理</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="handling-error">Handling Error</h2>
<p>无错误的正常流程代码，将成为一条直线，而不是缩进的代码。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">f</span><span style="color:#111">,</span><span style="color:#75af00">err</span>  <span style="color:#f92672">:=</span> <span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">Open</span><span style="color:#111">(</span><span style="color:#d88200">&#34;file&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 处理错误</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 逻辑</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">f</span><span style="color:#111">,</span><span style="color:#75af00">err</span>  <span style="color:#111">=</span> <span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">Open</span><span style="color:#111">(</span><span style="color:#d88200">&#34;file2&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 处理错误</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 逻辑</span>
</span></span></code></pre></div><p>通过消除错误消除错误处理</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// 改进前</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">AutoRusquest</span><span style="color:#111">()</span> <span style="color:#111">(</span><span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">Anto</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>  <span style="color:#111">}</span>  
</span></span><span style="display:flex;"><span>  <span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 改进后</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">AutoRusquest</span><span style="color:#111">()</span> <span style="color:#111">(</span><span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#75af00">Anto</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">AutoRusquest</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// log </span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 统计行数</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">Countlines</span><span style="color:#111">(</span><span style="color:#75af00">r</span> <span style="color:#75af00">io</span><span style="color:#111">.</span><span style="color:#75af00">Reader</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#00a8c8">int</span><span style="color:#111">,</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">var</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">br</span>    <span style="color:#111">=</span> <span style="color:#75af00">bufio</span><span style="color:#111">.</span><span style="color:#75af00">NewReader</span><span style="color:#111">(</span><span style="color:#75af00">r</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">lines</span> <span style="color:#00a8c8">int</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">err</span>   <span style="color:#00a8c8">error</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">for</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">br</span><span style="color:#111">.</span><span style="color:#75af00">ReadString</span><span style="color:#111">(</span><span style="color:#d88200">&#39;\n&#39;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">lines</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">break</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#75af00">io</span><span style="color:#111">.</span><span style="color:#75af00">EOF</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#75af00">lines</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 改进后</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">Countlines</span><span style="color:#111">(</span><span style="color:#75af00">r</span> <span style="color:#75af00">io</span><span style="color:#111">.</span><span style="color:#75af00">Reader</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#00a8c8">int</span><span style="color:#111">,</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">sr</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">bufio</span><span style="color:#111">.</span><span style="color:#75af00">NewScanner</span><span style="color:#111">(</span><span style="color:#75af00">r</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">lines</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">for</span> <span style="color:#75af00">sr</span><span style="color:#111">.</span><span style="color:#75af00">Scan</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">lines</span> <span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#75af00">lines</span><span style="color:#111">,</span><span style="color:#75af00">sr</span><span style="color:#111">.</span><span style="color:#75af00">Err</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="wrap-errors">Wrap errors</h2>
<h3 id="传统error的问题">传统error的问题</h3>
<p>还记得之前我们 auth 的代码吧，如果 Auto 返回错误，则 Aut0Request 会将错误返回给调用方，调用者可能也会这样做，依此类推。在程序的顶部，程序的主体将把错误打印到屏幕或日志文件中，打印出来的只是：没有这样的文件或目录。</p>
<p>没有生成错误的 file:line 信息。没有导致错误的调用堆栈的堆栈跟踪。这段代码的作者将被迫进行长时间的代码分割，以发现是哪个代码路径触发了文件未找到错误。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">AutoRusquest</span><span style="color:#111">()</span> <span style="color:#111">(</span><span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">Anto</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;auto failed:%v&#34;</span><span style="color:#111">,</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>  <span style="color:#111">}</span>  
</span></span><span style="display:flex;"><span>  <span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>但是正如我们前面看到的，这种模式与 sentinel errors 或 type assertions 的使用不兼容，因为将错误值转换为字符串，将其与另一个字符串合并，然后将其转换回 fmt.Errorf 破坏了原始错误，导致等值判定失败。</p>
<p>你应该只处理一次错误。处理错误意味着检查错误值，并做出单个决策。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">WriteAll</span><span style="color:#111">(</span><span style="color:#75af00">w</span> <span style="color:#75af00">io</span><span style="color:#111">.</span><span style="color:#75af00">Writer</span><span style="color:#111">,</span> <span style="color:#75af00">buf</span> <span style="color:#111">[]</span><span style="color:#00a8c8">byte</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">w</span><span style="color:#111">.</span><span style="color:#75af00">Write</span><span style="color:#111">(</span><span style="color:#75af00">buf</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>我们经常发现类似的代码，在错误处理中，带了两个任务: 记录日志并且再次返回错误。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">WriteAll</span><span style="color:#111">(</span><span style="color:#75af00">w</span> <span style="color:#75af00">io</span><span style="color:#111">.</span><span style="color:#75af00">Writer</span><span style="color:#111">,</span> <span style="color:#75af00">buf</span> <span style="color:#111">[]</span><span style="color:#00a8c8">byte</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">w</span><span style="color:#111">.</span><span style="color:#75af00">Write</span><span style="color:#111">(</span><span style="color:#75af00">buf</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Panicln</span><span style="color:#111">(</span><span style="color:#d88200">&#34;write buf failed:&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>在这个例子中，如果在 w.Write 过程中发生了一个错误，那么一行代码将被写入日志文件中，记录错误发生的文件和行，并且错误也会返回给调用者，调用者可能会记录并返回它，一直返回到程序的顶部。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">WriteConfig</span><span style="color:#111">(</span><span style="color:#75af00">w</span> <span style="color:#f92672">*</span><span style="color:#75af00">io</span><span style="color:#111">.</span><span style="color:#75af00">Writer</span><span style="color:#111">,</span><span style="color:#75af00">config</span> <span style="color:#f92672">*</span><span style="color:#75af00">Config</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75af00">buf</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">json</span><span style="color:#111">.</span><span style="color:#75af00">Marshal</span><span style="color:#111">(</span><span style="color:#75af00">conf</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;could not marshal config: %V&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>  <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">Writeall</span><span style="color:#111">(</span><span style="color:#75af00">w</span><span style="color:#111">,</span> <span style="color:#75af00">buf</span><span style="color:#111">);</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;could not write config: %v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>  <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">Writeconfig</span><span style="color:#111">(</span><span style="color:#75af00">f</span><span style="color:#111">,</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">conf</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">unable to write: io.EOF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">could not write config: io.EOF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span></code></pre></div><p>Go 中的错误处理契约规定，在出现错误的情况下，不能对其他返回值的内容做出任何假设。由于 JSON 序列化失败，buf 的内容是未知的，可能它不包含任何内容，但更糟糕的是，它可能包含一个半写的 JSON 片段。</p>
<p>由于程序员在检查并记录错误后忘记 return，损坏的缓冲区将被传递给 WriteAll，这可能会成功，因此配置文件将被错误地写入。但是，该函数返回的结果是正确的。</p>
<h3 id="栈处理错误">栈处理错误</h3>
<p>日志记录与错误无关且对调试没有帮助的信息应被视为噪音，应予以质疑。记录的原因是因为某些东西失败了，而日志包含了答案。</p>
<ul>
<li>
<p>错误要被日志记录。</p>
</li>
<li>
<p>应用程序处理错误，保证100%完整性。</p>
</li>
<li>
<p>之后不再报告当前错误。</p>
</li>
</ul>
<p>包:github.com/pkg/errors</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">Readconfig</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">Exit</span><span style="color:#111">(</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">Readfile</span><span style="color:#111">(</span><span style="color:#75af00">path</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#111">([]</span><span style="color:#00a8c8">byte</span><span style="color:#111">,</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">f</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">Open</span><span style="color:#111">(</span><span style="color:#75af00">path</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">errors</span><span style="color:#111">.</span><span style="color:#75af00">Wrap</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;open failed&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">defer</span> <span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">buf</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">ioutil</span><span style="color:#111">.</span><span style="color:#75af00">ReadAll</span><span style="color:#111">(</span><span style="color:#75af00">f</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">errors</span><span style="color:#111">.</span><span style="color:#75af00">Wrap</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;read failed&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#75af00">buf</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">Readconfig</span><span style="color:#111">()</span> <span style="color:#111">([]</span><span style="color:#00a8c8">byte</span><span style="color:#111">,</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">home</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">Getenv</span><span style="color:#111">(</span><span style="color:#d88200">&#34;HOME&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">config</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">Readfile</span><span style="color:#111">(</span><span style="color:#75af00">filepath</span><span style="color:#111">.</span><span style="color:#75af00">Join</span><span style="color:#111">(</span><span style="color:#75af00">home</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;settings.xml&#34;</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#75af00">config</span><span style="color:#111">,</span> <span style="color:#75af00">errors</span><span style="color:#111">.</span><span style="color:#75af00">WithMessage</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;could not read config&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">could not read config: open failed: open /Users/zhaohaiyu/settings.xml: no such file or directory
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">exit status 1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">Readconfig</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;original error: %T -&gt; %v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">errors</span><span style="color:#111">.</span><span style="color:#75af00">Cause</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">),</span> <span style="color:#75af00">errors</span><span style="color:#111">.</span><span style="color:#75af00">Cause</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;stack trace: \n%+v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">Exit</span><span style="color:#111">(</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">original error: *os.PathError -&gt; open /Users/zhaohaiyu/settings.xml: no such file or directory
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">stack trace: 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">open /Users/zhaohaiyu/settings.xml: no such file or directory
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">open failed
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">main.Readfile
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        /Users/zhaohaiyu/code/test/main.go:35
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">main.Readconfig
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        /Users/zhaohaiyu/code/test/main.go:51
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">main.main
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        /Users/zhaohaiyu/code/test/main.go:22
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">runtime.main
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        /usr/local/Cellar/go/1.15.3/libexec/src/runtime/proc.go:204
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">runtime.goexit
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        /usr/local/Cellar/go/1.15.3/libexec/src/runtime/asm_amd64.s:1374
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">could not read config
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">exit status 1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span></code></pre></div><p>通过使用 pkg/errors 包，您可以向错误值添加上下文，这种方式既可以由人也可以由机器检查。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">errors</span><span style="color:#111">.</span><span style="color:#75af00">Wrap</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;read failed&#34;</span><span style="color:#111">)</span>
</span></span></code></pre></div><h3 id="wrap-errors使用">wrap errors使用</h3>
<ol>
<li>在你的应用代码中，使用 errors.New 或者 errros.Errorf 返回错误。</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">parseargs</span><span style="color:#111">(</span><span style="color:#75af00">args</span> <span style="color:#111">[]</span><span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">args</span><span style="color:#111">)</span> <span style="color:#111">&lt;</span> <span style="color:#ae81ff">3</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">errors</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;not enough arguments, expected at Least&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><ol start="2">
<li>如果调用其他的函数，通常简单的直接返回。</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><ol start="3">
<li>如果和其他库进行协作，考虑使用 errors.Wrap 或者 errors.Wrapf 保存堆栈信息。同样适用于和标准库协作的时候。</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">f</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">Open</span><span style="color:#111">(</span><span style="color:#75af00">file</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#75af00">errors</span><span style="color:#111">.</span><span style="color:#75af00">Wrapf</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;open %s failed&#34;</span><span style="color:#111">,</span><span style="color:#75af00">file</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><ol start="4">
<li>
<p>直接返回错误，而不是每个错误产生的地方到处打日志。</p>
</li>
<li>
<p>在程序的顶部或者是工作的 goroutine 顶部(请求入口)，使用 %+v 把堆栈详情记录。</p>
</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">app</span><span style="color:#111">.</span><span style="color:#75af00">Run</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;FATAL:%+v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">Exit</span><span style="color:#111">(</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><ol start="6">
<li>使用 errors.Cause 获取 root error，再进行和 sentinel error 判定。</li>
</ol>
<h3 id="总结">总结:</h3>
<ul>
<li>
<p>Packages that are reusable across many projects only return root error values.（选择 wrap error 是只有 applications 可以选择应用的策略。具有最高可重用性的包只能返回根错误值。此机制与 Go 标准库中使用的相同(kit 库的 sql.ErrNoRows)。）</p>
</li>
<li>
<p>If the error is not going to be handled, wrap and return up the call stack.（这是关于函数/方法调用返回的每个错误的基本问题。如果函数/方法不打算处理错误，那么用足够的上下文 wrap errors 并将其返回到调用堆栈中。例如，额外的上下文可以是使用的输入参数或失败的查询语句。确定您记录的上下文是足够多还是太多的一个好方法是检查日志并验证它们在开发期间是否为您工作。）</p>
</li>
<li>
<p>Once an error is handled, it is not allowed to be passed up the call stack any longer.（ 一旦确定函数/方法将处理错误，错误就不再是错误。如果函数/方法仍然需要发出返回，则它不能返回错误值。它应该只返回零(比如降级处理中，你返回了降级数据，然后需要 return nil)。）</p>
</li>
</ul>
<h2 id="go113-error">Go1.13 error</h2>
<p>1
函数在调用栈中添加信息向上传递错误，例如对错误发生时发生的情况的简要描述。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;decompress %v:%v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">name</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>使用创建新错误 fmt.Errorf 丢弃原始错误中除文本外的所有内容。正如我们在上面的QueryError 中看到的那样，我们有时可能需要定义一个包含底层错误的新错误类型，并将其保存以供代码检查。这里是 QueryError：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">QueryError</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">Query</span> <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">Err</span>   <span style="color:#00a8c8">error</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>程序可以查看 QueryError \p值以根据底层错误做出决策。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#75af00">e</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">err</span><span style="color:#111">.(</span><span style="color:#f92672">*</span><span style="color:#75af00">Queryerror</span><span style="color:#111">);</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">Err</span> <span style="color:#f92672">==</span> <span style="color:#75af00">ErrPermission</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//query failed because of a permission problem</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>go1.13为 errors 和 fmt 标准库包引入了新特性，以简化处理包含其他错误的错误。其中最重要的是: 包含另一个错误的 error 可以实现返回底层错误的 Unwrap 方法。如果 e1.Unwrap() 返回 e2，那么我们说 e1 包装 e2，您可以展开 e1 以获得 e2。</p>
<p>按照此约定，我们可以为上面的 QueryError 类型指定一个 Unwrap 方法，该方法返回其包含的错误:</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">e</span> <span style="color:#f92672">*</span><span style="color:#75af00">Queryerror</span><span style="color:#111">)</span> <span style="color:#75af00">Unwrap</span><span style="color:#111">()</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span> <span style="color:#00a8c8">return</span> <span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">Err</span> <span style="color:#111">}</span>
</span></span></code></pre></div><p>go1.13 errors 包包含两个用于检查错误的新函数：Is 和 As。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// Similar to:</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// if err = Errnotfound {...}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#75af00">errors</span><span style="color:#111">.</span><span style="color:#75af00">Is</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#75af00">Errnotfound</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// something wasnt found</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Similar to</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// if e, ok := err.(*Queryerror); ok {...}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">var</span> <span style="color:#75af00">e</span> <span style="color:#f92672">*</span><span style="color:#75af00">Queryerror</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Note: *Queryerror is the type of the error</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#75af00">errorsAs</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">e</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// err is a *Queryerror, and e is set to the errors value</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="wrapping-errors-with-w">Wrapping errors with %w</h3>
<p>如前所述，使用 fmt.Errorf 向错误添加附加信息。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;decompress %v:%v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">name</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>在 Go 1.13中 fmt.Errorf 支持新的 %w 谓词。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;decompress %v:%w&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">name</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>用 %w 包装错误可用于 errors.Is 以及 errors.As</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;access denied: % W&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">Errpermission</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#75af00">errors</span><span style="color:#111">.</span><span style="color:#75af00">Is</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#75af00">Errpermission</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ...</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="go2介绍">Go2介绍</h2>
<p><a href="https://go.googlesource.com/proposal/+/master/design/29934-error-values.md">https://go.googlesource.com/proposal/+/master/design/29934-error-values.md</a></p>
<h2 id="原文地址">原文地址</h2>
<ul>
<li><a href="https://www.zhaohaiyu.com/post/go/go-error/">https://www.zhaohaiyu.com/post/go/go-error/</a></li>
</ul>
<h2 id="参考文章">参考文章</h2>
<ul>
<li><a href="https://u.geekbang.org/subject/go">https://u.geekbang.org/subject/go</a></li>
<li><a href="https://lailin.xyz/post/go-training-03.html">https://lailin.xyz/post/go-training-03.html</a></li>
</ul>
]]></content:encoded><category>go</category><category>go</category></item><item><title>golang fmt包</title><link>https://daemon365.dev/post/go/golang_fmt_package/</link><pubDate>Thu, 20 Jun 2019 00:00:00 +0800</pubDate><guid>https://daemon365.dev/post/go/golang_fmt_package/</guid><description>&lt;h2 id="fmt"&gt;fmt&lt;/h2&gt;
&lt;p&gt;fmt包实现了类似C语言printf和scanf的格式化I/O。主要分为向外输出内容和获取输入内容两大部分。&lt;/p&gt;
&lt;h2 id="向外输出"&gt;向外输出&lt;/h2&gt;
&lt;p&gt;标准库fmt提供了以下几种输出相关函数。&lt;/p&gt;
&lt;h3 id="print"&gt;Print&lt;/h3&gt;
&lt;p&gt;Print系列函数会将内容输出到系统的标准输出，区别在于Print函数直接输出内容，Printf函数支持格式化输出字符串，Println函数会在输出内容的结尾添加一个换行符。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;Print&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;a&lt;/span&gt; &lt;span style="color:#f92672"&gt;...&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;interface&lt;/span&gt;&lt;span style="color:#111"&gt;{})&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;n&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;int&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;error&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;Printf&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;format&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;string&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;a&lt;/span&gt; &lt;span style="color:#f92672"&gt;...&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;interface&lt;/span&gt;&lt;span style="color:#111"&gt;{})&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;n&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;int&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;error&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;a&lt;/span&gt; &lt;span style="color:#f92672"&gt;...&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;interface&lt;/span&gt;&lt;span style="color:#111"&gt;{})&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;n&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;int&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;error&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id="fprint"&gt;Fprint&lt;/h3&gt;
&lt;p&gt;Fprint系列函数会将内容输出到一个io.Writer接口类型的变量w中，我们通常用这个函数往文件中写入内容。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;Fprint&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;w&lt;/span&gt; &lt;span style="color:#75af00"&gt;io&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Writer&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;a&lt;/span&gt; &lt;span style="color:#f92672"&gt;...&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;interface&lt;/span&gt;&lt;span style="color:#111"&gt;{})&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;n&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;int&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;error&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;Fprintf&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;w&lt;/span&gt; &lt;span style="color:#75af00"&gt;io&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Writer&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;format&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;string&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;a&lt;/span&gt; &lt;span style="color:#f92672"&gt;...&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;interface&lt;/span&gt;&lt;span style="color:#111"&gt;{})&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;n&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;int&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;error&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;Fprintln&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;w&lt;/span&gt; &lt;span style="color:#75af00"&gt;io&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Writer&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;a&lt;/span&gt; &lt;span style="color:#f92672"&gt;...&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;interface&lt;/span&gt;&lt;span style="color:#111"&gt;{})&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;n&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;int&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;error&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id="sprint"&gt;Sprint&lt;/h3&gt;
&lt;p&gt;Sprint系列函数会把传入的数据生成并返回一个字符串。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;Sprint&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;a&lt;/span&gt; &lt;span style="color:#f92672"&gt;...&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;interface&lt;/span&gt;&lt;span style="color:#111"&gt;{})&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;string&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;Sprintf&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;format&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;string&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;a&lt;/span&gt; &lt;span style="color:#f92672"&gt;...&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;interface&lt;/span&gt;&lt;span style="color:#111"&gt;{})&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;string&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;Sprintln&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;a&lt;/span&gt; &lt;span style="color:#f92672"&gt;...&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;interface&lt;/span&gt;&lt;span style="color:#111"&gt;{})&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;string&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id="errorf"&gt;Errorf&lt;/h3&gt;
&lt;p&gt;Errorf函数根据format参数生成格式化字符串并返回一个包含该字符串的错误。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;Errorf&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;format&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;string&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;a&lt;/span&gt; &lt;span style="color:#f92672"&gt;...&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;interface&lt;/span&gt;&lt;span style="color:#111"&gt;{})&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;error&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id="格式化占位符"&gt;格式化占位符&lt;/h2&gt;
&lt;p&gt;*printf系列函数都支持format格式化参数，在这里我们按照占位符将被替换的变量类型划分，方便查询和记忆。&lt;/p&gt;
&lt;h3 id="通用占位符"&gt;通用占位符&lt;/h3&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;占位符&lt;/th&gt;
&lt;th&gt;说明&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;%v&lt;/td&gt;
&lt;td&gt;值的默认格式表示&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;%+v&lt;/td&gt;
&lt;td&gt;类似%v，但输出结构体时会添加字段名&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;%#v&lt;/td&gt;
&lt;td&gt;值的Go语法表示&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;%T&lt;/td&gt;
&lt;td&gt;打印值的类型&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;%%&lt;/td&gt;
&lt;td&gt;百分号&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h3 id="布尔型"&gt;布尔型&lt;/h3&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;占位符&lt;/th&gt;
&lt;th&gt;说明&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;%t&lt;/td&gt;
&lt;td&gt;true或false&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h3 id="整型"&gt;整型&lt;/h3&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;占位符&lt;/th&gt;
&lt;th&gt;说明&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;%b&lt;/td&gt;
&lt;td&gt;表示为二进制&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;%c&lt;/td&gt;
&lt;td&gt;该值对应的unicode码值&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;%d&lt;/td&gt;
&lt;td&gt;表示为十进制&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;%o&lt;/td&gt;
&lt;td&gt;表示为八进制&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;%x&lt;/td&gt;
&lt;td&gt;表示为十六进制，使用a-f&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;%X&lt;/td&gt;
&lt;td&gt;表示为十六进制，使用A-F&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;%U&lt;/td&gt;
&lt;td&gt;表示为Unicode格式：U+1234，等价于”U+%04X”&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;%q&lt;/td&gt;
&lt;td&gt;该值对应的单引号括起来的go语法字符字面值，必要时会采用安全的转义表示&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h3 id="浮点数与复数"&gt;浮点数与复数&lt;/h3&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;占位符&lt;/th&gt;
&lt;th&gt;说明&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;%b&lt;/td&gt;
&lt;td&gt;无小数部分、二进制指数的科学计数法，如-123456p-78&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;%e&lt;/td&gt;
&lt;td&gt;科学计数法，如-1234.456e+78&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;%E&lt;/td&gt;
&lt;td&gt;科学计数法，如-1234.456E+78&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;%f&lt;/td&gt;
&lt;td&gt;有小数部分但无指数部分，如123.456&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;%F&lt;/td&gt;
&lt;td&gt;等价于%f&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;%g&lt;/td&gt;
&lt;td&gt;根据实际情况采用%e或%f格式（以获得更简洁、准确的输出）&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;%G&lt;/td&gt;
&lt;td&gt;根据实际情况采用%E或%F格式（以获得更简洁、准确的输出）&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h3 id="字符串和byte"&gt;字符串和[]byte&lt;/h3&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;占位符&lt;/th&gt;
&lt;th&gt;说明&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;%s&lt;/td&gt;
&lt;td&gt;直接输出字符串或者[]byte&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;%q&lt;/td&gt;
&lt;td&gt;该值对应的双引号括起来的go语法字符串字面值，必要时会采用安全的转义表示&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;%x&lt;/td&gt;
&lt;td&gt;每个字节用两字符十六进制数表示（使用a-f）&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;%X&lt;/td&gt;
&lt;td&gt;每个字节用两字符十六进制数表示（使用A-F）&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h3 id="指针"&gt;指针&lt;/h3&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;占位符&lt;/th&gt;
&lt;th&gt;说明&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;%p&lt;/td&gt;
&lt;td&gt;表示为十六进制，并加上前导的0x&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h3 id="宽度标识符"&gt;宽度标识符&lt;/h3&gt;
&lt;p&gt;宽度通过一个紧跟在百分号后面的十进制数指定，如果未指定宽度，则表示值时除必需之外不作填充。精度通过（可选的）宽度后跟点号后跟的十进制数指定。如果未指定精度，会使用默认精度；如果点号后没有跟数字，表示精度为0。举例如下：&lt;/p&gt;</description><content:encoded><![CDATA[<h2 id="fmt">fmt</h2>
<p>fmt包实现了类似C语言printf和scanf的格式化I/O。主要分为向外输出内容和获取输入内容两大部分。</p>
<h2 id="向外输出">向外输出</h2>
<p>标准库fmt提供了以下几种输出相关函数。</p>
<h3 id="print">Print</h3>
<p>Print系列函数会将内容输出到系统的标准输出，区别在于Print函数直接输出内容，Printf函数支持格式化输出字符串，Println函数会在输出内容的结尾添加一个换行符。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">Print</span><span style="color:#111">(</span><span style="color:#75af00">a</span> <span style="color:#f92672">...</span><span style="color:#00a8c8">interface</span><span style="color:#111">{})</span> <span style="color:#111">(</span><span style="color:#75af00">n</span> <span style="color:#00a8c8">int</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#75af00">format</span> <span style="color:#00a8c8">string</span><span style="color:#111">,</span> <span style="color:#75af00">a</span> <span style="color:#f92672">...</span><span style="color:#00a8c8">interface</span><span style="color:#111">{})</span> <span style="color:#111">(</span><span style="color:#75af00">n</span> <span style="color:#00a8c8">int</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">a</span> <span style="color:#f92672">...</span><span style="color:#00a8c8">interface</span><span style="color:#111">{})</span> <span style="color:#111">(</span><span style="color:#75af00">n</span> <span style="color:#00a8c8">int</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span>
</span></span></code></pre></div><h3 id="fprint">Fprint</h3>
<p>Fprint系列函数会将内容输出到一个io.Writer接口类型的变量w中，我们通常用这个函数往文件中写入内容。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">Fprint</span><span style="color:#111">(</span><span style="color:#75af00">w</span> <span style="color:#75af00">io</span><span style="color:#111">.</span><span style="color:#75af00">Writer</span><span style="color:#111">,</span> <span style="color:#75af00">a</span> <span style="color:#f92672">...</span><span style="color:#00a8c8">interface</span><span style="color:#111">{})</span> <span style="color:#111">(</span><span style="color:#75af00">n</span> <span style="color:#00a8c8">int</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">Fprintf</span><span style="color:#111">(</span><span style="color:#75af00">w</span> <span style="color:#75af00">io</span><span style="color:#111">.</span><span style="color:#75af00">Writer</span><span style="color:#111">,</span> <span style="color:#75af00">format</span> <span style="color:#00a8c8">string</span><span style="color:#111">,</span> <span style="color:#75af00">a</span> <span style="color:#f92672">...</span><span style="color:#00a8c8">interface</span><span style="color:#111">{})</span> <span style="color:#111">(</span><span style="color:#75af00">n</span> <span style="color:#00a8c8">int</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">Fprintln</span><span style="color:#111">(</span><span style="color:#75af00">w</span> <span style="color:#75af00">io</span><span style="color:#111">.</span><span style="color:#75af00">Writer</span><span style="color:#111">,</span> <span style="color:#75af00">a</span> <span style="color:#f92672">...</span><span style="color:#00a8c8">interface</span><span style="color:#111">{})</span> <span style="color:#111">(</span><span style="color:#75af00">n</span> <span style="color:#00a8c8">int</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span>
</span></span></code></pre></div><h3 id="sprint">Sprint</h3>
<p>Sprint系列函数会把传入的数据生成并返回一个字符串。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">Sprint</span><span style="color:#111">(</span><span style="color:#75af00">a</span> <span style="color:#f92672">...</span><span style="color:#00a8c8">interface</span><span style="color:#111">{})</span> <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">Sprintf</span><span style="color:#111">(</span><span style="color:#75af00">format</span> <span style="color:#00a8c8">string</span><span style="color:#111">,</span> <span style="color:#75af00">a</span> <span style="color:#f92672">...</span><span style="color:#00a8c8">interface</span><span style="color:#111">{})</span> <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">Sprintln</span><span style="color:#111">(</span><span style="color:#75af00">a</span> <span style="color:#f92672">...</span><span style="color:#00a8c8">interface</span><span style="color:#111">{})</span> <span style="color:#00a8c8">string</span>
</span></span></code></pre></div><h3 id="errorf">Errorf</h3>
<p>Errorf函数根据format参数生成格式化字符串并返回一个包含该字符串的错误。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#75af00">format</span> <span style="color:#00a8c8">string</span><span style="color:#111">,</span> <span style="color:#75af00">a</span> <span style="color:#f92672">...</span><span style="color:#00a8c8">interface</span><span style="color:#111">{})</span> <span style="color:#00a8c8">error</span>
</span></span></code></pre></div><h2 id="格式化占位符">格式化占位符</h2>
<p>*printf系列函数都支持format格式化参数，在这里我们按照占位符将被替换的变量类型划分，方便查询和记忆。</p>
<h3 id="通用占位符">通用占位符</h3>
<table>
  <thead>
      <tr>
          <th>占位符</th>
          <th>说明</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>%v</td>
          <td>值的默认格式表示</td>
      </tr>
      <tr>
          <td>%+v</td>
          <td>类似%v，但输出结构体时会添加字段名</td>
      </tr>
      <tr>
          <td>%#v</td>
          <td>值的Go语法表示</td>
      </tr>
      <tr>
          <td>%T</td>
          <td>打印值的类型</td>
      </tr>
      <tr>
          <td>%%</td>
          <td>百分号</td>
      </tr>
  </tbody>
</table>
<h3 id="布尔型">布尔型</h3>
<table>
  <thead>
      <tr>
          <th>占位符</th>
          <th>说明</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>%t</td>
          <td>true或false</td>
      </tr>
  </tbody>
</table>
<h3 id="整型">整型</h3>
<table>
  <thead>
      <tr>
          <th>占位符</th>
          <th>说明</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>%b</td>
          <td>表示为二进制</td>
      </tr>
      <tr>
          <td>%c</td>
          <td>该值对应的unicode码值</td>
      </tr>
      <tr>
          <td>%d</td>
          <td>表示为十进制</td>
      </tr>
      <tr>
          <td>%o</td>
          <td>表示为八进制</td>
      </tr>
      <tr>
          <td>%x</td>
          <td>表示为十六进制，使用a-f</td>
      </tr>
      <tr>
          <td>%X</td>
          <td>表示为十六进制，使用A-F</td>
      </tr>
      <tr>
          <td>%U</td>
          <td>表示为Unicode格式：U+1234，等价于”U+%04X”</td>
      </tr>
      <tr>
          <td>%q</td>
          <td>该值对应的单引号括起来的go语法字符字面值，必要时会采用安全的转义表示</td>
      </tr>
  </tbody>
</table>
<h3 id="浮点数与复数">浮点数与复数</h3>
<table>
  <thead>
      <tr>
          <th>占位符</th>
          <th>说明</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>%b</td>
          <td>无小数部分、二进制指数的科学计数法，如-123456p-78</td>
      </tr>
      <tr>
          <td>%e</td>
          <td>科学计数法，如-1234.456e+78</td>
      </tr>
      <tr>
          <td>%E</td>
          <td>科学计数法，如-1234.456E+78</td>
      </tr>
      <tr>
          <td>%f</td>
          <td>有小数部分但无指数部分，如123.456</td>
      </tr>
      <tr>
          <td>%F</td>
          <td>等价于%f</td>
      </tr>
      <tr>
          <td>%g</td>
          <td>根据实际情况采用%e或%f格式（以获得更简洁、准确的输出）</td>
      </tr>
      <tr>
          <td>%G</td>
          <td>根据实际情况采用%E或%F格式（以获得更简洁、准确的输出）</td>
      </tr>
  </tbody>
</table>
<h3 id="字符串和byte">字符串和[]byte</h3>
<table>
  <thead>
      <tr>
          <th>占位符</th>
          <th>说明</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>%s</td>
          <td>直接输出字符串或者[]byte</td>
      </tr>
      <tr>
          <td>%q</td>
          <td>该值对应的双引号括起来的go语法字符串字面值，必要时会采用安全的转义表示</td>
      </tr>
      <tr>
          <td>%x</td>
          <td>每个字节用两字符十六进制数表示（使用a-f）</td>
      </tr>
      <tr>
          <td>%X</td>
          <td>每个字节用两字符十六进制数表示（使用A-F）</td>
      </tr>
  </tbody>
</table>
<h3 id="指针">指针</h3>
<table>
  <thead>
      <tr>
          <th>占位符</th>
          <th>说明</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>%p</td>
          <td>表示为十六进制，并加上前导的0x</td>
      </tr>
  </tbody>
</table>
<h3 id="宽度标识符">宽度标识符</h3>
<p>宽度通过一个紧跟在百分号后面的十进制数指定，如果未指定宽度，则表示值时除必需之外不作填充。精度通过（可选的）宽度后跟点号后跟的十进制数指定。如果未指定精度，会使用默认精度；如果点号后没有跟数字，表示精度为0。举例如下：</p>
<table>
  <thead>
      <tr>
          <th>占位符</th>
          <th>说明</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>%f</td>
          <td>默认宽度，默认精度</td>
      </tr>
      <tr>
          <td>%9f</td>
          <td>宽度9，默认精度</td>
      </tr>
      <tr>
          <td>%.2f</td>
          <td>默认宽度，精度2</td>
      </tr>
      <tr>
          <td>%9.2f</td>
          <td>宽度9，精度2</td>
      </tr>
      <tr>
          <td>%9.f</td>
          <td>宽度9，精度0</td>
      </tr>
  </tbody>
</table>
<h3 id="其他falg">其他falg</h3>
<table>
  <thead>
      <tr>
          <th>占位符</th>
          <th>说明</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>’+’</td>
          <td>总是输出数值的正负号；对%q（%+q）会生成全部是ASCII字符的输出（通过转义）；</td>
      </tr>
      <tr>
          <td>’ ‘</td>
          <td>对数值，正数前加空格而负数前加负号；对字符串采用%x或%X时（% x或% X）会给各打印的字节之间加空格</td>
      </tr>
      <tr>
          <td>’-’</td>
          <td>在输出右边填充空白而不是默认的左边（即从默认的右对齐切换为左对齐）；</td>
      </tr>
      <tr>
          <td>’#’</td>
          <td>八进制数前加0（%#o），十六进制数前加0x（%#x）或0X（%#X），指针去掉前面的0x（%#p）对%q（%#q），对%U（%#U）会输出空格和单引号括起来的go字面值；</td>
      </tr>
      <tr>
          <td>‘0’</td>
          <td>使用0而不是空格填充，对于数值类型会把填充的0放在正负号后面；</td>
      </tr>
  </tbody>
</table>
<h2 id="获取输入">获取输入</h2>
<p>Go语言fmt包下有fmt.Scan、fmt.Scanf、fmt.Scanln三个函数，可以在程序运行过程中从标准输入获取用户的输入。</p>
<h3 id="fmtscan">fmt.Scan</h3>
<p>函数定签名如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">Scan</span><span style="color:#111">(</span><span style="color:#75af00">a</span> <span style="color:#f92672">...</span><span style="color:#00a8c8">interface</span><span style="color:#111">{})</span> <span style="color:#111">(</span><span style="color:#75af00">n</span> <span style="color:#00a8c8">int</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span>
</span></span></code></pre></div><ul>
<li>Scan从标准输入扫描文本，读取由空白符分隔的值保存到传递给本函数的参数中，换行符视为空白符。</li>
<li>本函数返回成功扫描的数据个数和遇到的任何错误。如果读取的数据个数比提供的参数少，会返回一个错误报告原因。</li>
</ul>
<p>具体代码示例如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">var</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">name</span>    <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">age</span>     <span style="color:#00a8c8">int</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">married</span> <span style="color:#00a8c8">bool</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Scan</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">name</span><span style="color:#111">,</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">age</span><span style="color:#111">,</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">married</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;扫描结果 name:%s age:%d married:%t \n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">name</span><span style="color:#111">,</span> <span style="color:#75af00">age</span><span style="color:#111">,</span> <span style="color:#75af00">married</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>将上面的代码编译后在终端执行，在终端依次输入小王子、28和false使用空格分隔。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">$</span> <span style="color:#111">.</span><span style="color:#f92672">/</span><span style="color:#75af00">scan_demo</span> 
</span></span><span style="display:flex;"><span><span style="color:#75af00">小王子</span> <span style="color:#ae81ff">28</span> <span style="color:#00a8c8">false</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">扫描结果</span> <span style="color:#75af00">name</span><span style="color:#111">:</span><span style="color:#75af00">小王子</span> <span style="color:#75af00">age</span><span style="color:#111">:</span><span style="color:#ae81ff">28</span> <span style="color:#75af00">married</span><span style="color:#111">:</span><span style="color:#00a8c8">false</span>
</span></span></code></pre></div><p>fmt.Scan从标准输入中扫描用户输入的数据，将以空白符分隔的数据分别存入指定的参数。</p>
<h3 id="fmtscanf">fmt.Scanf</h3>
<p>函数签名如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">Scanf</span><span style="color:#111">(</span><span style="color:#75af00">format</span> <span style="color:#00a8c8">string</span><span style="color:#111">,</span> <span style="color:#75af00">a</span> <span style="color:#f92672">...</span><span style="color:#00a8c8">interface</span><span style="color:#111">{})</span> <span style="color:#111">(</span><span style="color:#75af00">n</span> <span style="color:#00a8c8">int</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span>
</span></span></code></pre></div><ul>
<li>Scanf从标准输入扫描文本，根据format参数指定的格式去读取由空白符分隔的值保存到传递给本函数的参数中。</li>
<li>本函数返回成功扫描的数据个数和遇到的任何错误。</li>
</ul>
<p>代码示例如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">var</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">name</span>    <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">age</span>     <span style="color:#00a8c8">int</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">married</span> <span style="color:#00a8c8">bool</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Scanf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;1:%s 2:%d 3:%t&#34;</span><span style="color:#111">,</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">name</span><span style="color:#111">,</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">age</span><span style="color:#111">,</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">married</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;扫描结果 name:%s age:%d married:%t \n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">name</span><span style="color:#111">,</span> <span style="color:#75af00">age</span><span style="color:#111">,</span> <span style="color:#75af00">married</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>将上面的代码编译后在终端执行，在终端按照指定的格式依次输入小王子、28和false。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">$</span> <span style="color:#111">.</span><span style="color:#f92672">/</span><span style="color:#75af00">scan_demo</span> 
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span><span style="color:#111">:</span><span style="color:#75af00">zhy</span> <span style="color:#ae81ff">2</span><span style="color:#111">:</span><span style="color:#ae81ff">18</span> <span style="color:#ae81ff">3</span><span style="color:#111">:</span><span style="color:#00a8c8">false</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">扫描结果</span> <span style="color:#75af00">name</span><span style="color:#111">:</span><span style="color:#75af00">zhy</span> <span style="color:#75af00">age</span><span style="color:#111">:</span><span style="color:#ae81ff">18</span> <span style="color:#75af00">married</span><span style="color:#111">:</span><span style="color:#00a8c8">false</span>
</span></span></code></pre></div><p>fmt.Scanf不同于fmt.Scan简单的以空格作为输入数据的分隔符，fmt.Scanf为输入数据指定了具体的输入内容格式，只有按照格式输入数据才会被扫描并存入对应变量。</p>
<p>例如，我们还是按照上个示例中以空格分隔的方式输入，fmt.Scanf就不能正确扫描到输入的数据。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">$</span> <span style="color:#111">.</span><span style="color:#f92672">/</span><span style="color:#75af00">scan_demo</span> 
</span></span><span style="display:flex;"><span><span style="color:#75af00">zhy</span> <span style="color:#ae81ff">18</span> <span style="color:#00a8c8">false</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">扫描结果</span> <span style="color:#75af00">zhy</span><span style="color:#111">:</span> <span style="color:#75af00">age</span><span style="color:#111">:</span><span style="color:#ae81ff">0</span> <span style="color:#75af00">married</span><span style="color:#111">:</span><span style="color:#00a8c8">false</span>
</span></span></code></pre></div><h3 id="fmtscanln">fmt.Scanln</h3>
<p>函数签名如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">Scanln</span><span style="color:#111">(</span><span style="color:#75af00">a</span> <span style="color:#f92672">...</span><span style="color:#00a8c8">interface</span><span style="color:#111">{})</span> <span style="color:#111">(</span><span style="color:#75af00">n</span> <span style="color:#00a8c8">int</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span>
</span></span></code></pre></div><ul>
<li>Scanln类似Scan，它在遇到换行时才停止扫描。最后一个数据后面必须有换行或者到达结束位置。</li>
<li>本函数返回成功扫描的数据个数和遇到的任何错误。</li>
</ul>
<p>具体代码示例如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">var</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">name</span>    <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">age</span>     <span style="color:#00a8c8">int</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">married</span> <span style="color:#00a8c8">bool</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Scanln</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">name</span><span style="color:#111">,</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">age</span><span style="color:#111">,</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">married</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;扫描结果 name:%s age:%d married:%t \n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">name</span><span style="color:#111">,</span> <span style="color:#75af00">age</span><span style="color:#111">,</span> <span style="color:#75af00">married</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><pre tabindex="0"><code>$ ./scan_demo 
zhy 18 false
扫描结果 name:zhy age:28 married:false
</code></pre><p>fmt.Scanln遇到回车就结束扫描了，这个比较常用。</p>
<h3 id="bufionewreader">bufio.NewReader</h3>
<p>有时候我们想完整获取输入的内容，而输入的内容可能包含空格，这种情况下可以使用bufio包来实现。示例代码如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">bufioDemo</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">reader</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">bufio</span><span style="color:#111">.</span><span style="color:#75af00">NewReader</span><span style="color:#111">(</span><span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">Stdin</span><span style="color:#111">)</span> <span style="color:#75715e">// 从标准输入生成读对象</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Print</span><span style="color:#111">(</span><span style="color:#d88200">&#34;请输入内容：&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">text</span><span style="color:#111">,</span> <span style="color:#75af00">_</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">reader</span><span style="color:#111">.</span><span style="color:#75af00">ReadString</span><span style="color:#111">(</span><span style="color:#d88200">&#39;\n&#39;</span><span style="color:#111">)</span> <span style="color:#75715e">// 读到换行</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">text</span> <span style="color:#111">=</span> <span style="color:#75af00">strings</span><span style="color:#111">.</span><span style="color:#75af00">TrimSpace</span><span style="color:#111">(</span><span style="color:#75af00">text</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;%#v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">text</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="fscan系列">Fscan系列</h3>
<p>这几个函数功能分别类似于fmt.Scan、fmt.Scanf、fmt.Scanln三个函数，只不过它们不是从标准输入中读取数据而是从io.Reader中读取数据。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">Fscan</span><span style="color:#111">(</span><span style="color:#75af00">r</span> <span style="color:#75af00">io</span><span style="color:#111">.</span><span style="color:#75af00">Reader</span><span style="color:#111">,</span> <span style="color:#75af00">a</span> <span style="color:#f92672">...</span><span style="color:#00a8c8">interface</span><span style="color:#111">{})</span> <span style="color:#111">(</span><span style="color:#75af00">n</span> <span style="color:#00a8c8">int</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">Fscanln</span><span style="color:#111">(</span><span style="color:#75af00">r</span> <span style="color:#75af00">io</span><span style="color:#111">.</span><span style="color:#75af00">Reader</span><span style="color:#111">,</span> <span style="color:#75af00">a</span> <span style="color:#f92672">...</span><span style="color:#00a8c8">interface</span><span style="color:#111">{})</span> <span style="color:#111">(</span><span style="color:#75af00">n</span> <span style="color:#00a8c8">int</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">Fscanf</span><span style="color:#111">(</span><span style="color:#75af00">r</span> <span style="color:#75af00">io</span><span style="color:#111">.</span><span style="color:#75af00">Reader</span><span style="color:#111">,</span> <span style="color:#75af00">format</span> <span style="color:#00a8c8">string</span><span style="color:#111">,</span> <span style="color:#75af00">a</span> <span style="color:#f92672">...</span><span style="color:#00a8c8">interface</span><span style="color:#111">{})</span> <span style="color:#111">(</span><span style="color:#75af00">n</span> <span style="color:#00a8c8">int</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span>
</span></span></code></pre></div><h3 id="sscan系列">Sscan系列</h3>
<p>这几个函数功能分别类似于fmt.Scan、fmt.Scanf、fmt.Scanln三个函数，只不过它们不是从标准输入中读取数据而是从指定字符串中读取数据。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">Sscan</span><span style="color:#111">(</span><span style="color:#75af00">str</span> <span style="color:#00a8c8">string</span><span style="color:#111">,</span> <span style="color:#75af00">a</span> <span style="color:#f92672">...</span><span style="color:#00a8c8">interface</span><span style="color:#111">{})</span> <span style="color:#111">(</span><span style="color:#75af00">n</span> <span style="color:#00a8c8">int</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">Sscanln</span><span style="color:#111">(</span><span style="color:#75af00">str</span> <span style="color:#00a8c8">string</span><span style="color:#111">,</span> <span style="color:#75af00">a</span> <span style="color:#f92672">...</span><span style="color:#00a8c8">interface</span><span style="color:#111">{})</span> <span style="color:#111">(</span><span style="color:#75af00">n</span> <span style="color:#00a8c8">int</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">Sscanf</span><span style="color:#111">(</span><span style="color:#75af00">str</span> <span style="color:#00a8c8">string</span><span style="color:#111">,</span> <span style="color:#75af00">format</span> <span style="color:#00a8c8">string</span><span style="color:#111">,</span> <span style="color:#75af00">a</span> <span style="color:#f92672">...</span><span style="color:#00a8c8">interface</span><span style="color:#111">{})</span> <span style="color:#111">(</span><span style="color:#75af00">n</span> <span style="color:#00a8c8">int</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span>
</span></span></code></pre></div><p>参考文章:<a href="https://www.liwenzhou.com/posts/Go/go_fmt/">https://www.liwenzhou.com/posts/Go/go_fmt/</a></p>
]]></content:encoded><category>go</category><category>go</category></item></channel></rss>