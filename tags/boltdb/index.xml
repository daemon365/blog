<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/"><channel><title>Boltdb on Daemon365</title><link>https://daemon365.dev/tags/boltdb/</link><description>Don't let yourself stop.</description><generator>Hugo -- gohugo.io</generator><language>zh-cn</language><lastBuildDate>Sat, 15 Jun 2024 16:14:00 +0800</lastBuildDate><atom:link href="https://daemon365.dev/tags/boltdb/index.xml" rel="self" type="application/rss+xml"/><item><title>boltdb 原理</title><link>https://daemon365.dev/post/cloud/boltdb_principles/</link><pubDate>Sat, 15 Jun 2024 16:14:00 +0800</pubDate><guid>https://daemon365.dev/post/cloud/boltdb_principles/</guid><description>&lt;h2 id="简介"&gt;简介&lt;/h2&gt;
&lt;p&gt;介绍及简单使用：https://www.cnblogs.com/daemon365/p/17690167.html
源码地址：https://github.com/etcd-io/bbolt&lt;/p&gt;
&lt;h2 id="page"&gt;page&lt;/h2&gt;
&lt;p&gt;因为 boltdb 是要落盘的，所以就要操作文件。为了提高效率，boltdb 会和其他数据库一样，会按 页（page）来操作文件。而且 boltdb 使用了 linux 的 &lt;a href="https://man7.org/linux/man-pages/man2/mmap.2.html"&gt;mmap&lt;/a&gt; 来内存映射操作文件，这样可以提高效率。&lt;/p&gt;
&lt;p&gt;在 linux 中，每个 page 的大小是 4KB。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-BASH" data-lang="BASH"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;getconf PAGESIZE
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#ae81ff"&gt;4096&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;对应的每页在我们的代理里也应该有一个数据结构，来存储数据。这个数据结构就是 &lt;code&gt;page&lt;/code&gt;。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;type&lt;/span&gt; &lt;span style="color:#75af00"&gt;Pgid&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;uint64&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;type&lt;/span&gt; &lt;span style="color:#75af00"&gt;Page&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;struct&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;id&lt;/span&gt; &lt;span style="color:#75af00"&gt;Pgid&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;flags&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;uint16&lt;/span&gt; &lt;span style="color:#75715e"&gt;// page 类型&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;count&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;uint16&lt;/span&gt; &lt;span style="color:#75715e"&gt;// page 中的元素数量&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;overflow&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;uint32&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 是否有后序页，如果有，overflow 表示后续页的数量&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;const&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;BranchPageFlag&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;0x01&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;LeafPageFlag&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;0x02&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;MetaPageFlag&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;0x04&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;FreelistPageFlag&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;0x10&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;code&gt;Page&lt;/code&gt; 里面有一个 &lt;code&gt;flags&lt;/code&gt; 字段，用来标识这个 page 是什么类型的。boltdb 里面有四种类型的 page, 分别是 分支页（BranchPageFlag）、叶子页（LeafPageFlag）、元数据页（MetaPageFlag）、空闲列表页（FreelistPageFlag）。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;分支页：由于 boltdb 使用的是 B+ 树，所以分支页用来存储 key 和子节点的指针。&lt;/li&gt;
&lt;li&gt;叶子页：叶子页用来存储 key 和 value。&lt;/li&gt;
&lt;li&gt;元数据页：元数据页用来存储 boltdb 的元数据，比如 boltdb 的版本号、boltdb 的根节点等。&lt;/li&gt;
&lt;li&gt;空闲列表页：由于 boltdb 使用 copy on write，所以当一个 page 被删除的时候，boltdb 并不会立即释放这个 page，而是把这个 page 加入到空闲列表页中，等到需要新的 page 的时候，再从空闲列表页中取出一个 page。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;在 page 之后会存储对用的结构，比如 meta 或者 freelist。先读取 page 判断自己的结构（定长的：8 + 2 + 2 +4），然后再根据不同的数据类型读取其他的结构（比如BranchPage）。&lt;/p&gt;</description><content:encoded><![CDATA[<h2 id="简介">简介</h2>
<p>介绍及简单使用：https://www.cnblogs.com/daemon365/p/17690167.html
源码地址：https://github.com/etcd-io/bbolt</p>
<h2 id="page">page</h2>
<p>因为 boltdb 是要落盘的，所以就要操作文件。为了提高效率，boltdb 会和其他数据库一样，会按 页（page）来操作文件。而且 boltdb 使用了 linux 的 <a href="https://man7.org/linux/man-pages/man2/mmap.2.html">mmap</a> 来内存映射操作文件，这样可以提高效率。</p>
<p>在 linux 中，每个 page 的大小是 4KB。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-BASH" data-lang="BASH"><span style="display:flex;"><span>getconf PAGESIZE
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">4096</span>
</span></span></code></pre></div><p>对应的每页在我们的代理里也应该有一个数据结构，来存储数据。这个数据结构就是 <code>page</code>。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Pgid</span> <span style="color:#00a8c8">uint64</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Page</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">id</span>       <span style="color:#75af00">Pgid</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">flags</span>    <span style="color:#00a8c8">uint16</span> <span style="color:#75715e">// page 类型</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">count</span>    <span style="color:#00a8c8">uint16</span> <span style="color:#75715e">// page 中的元素数量</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">overflow</span> <span style="color:#00a8c8">uint32</span> <span style="color:#75715e">// 是否有后序页，如果有，overflow 表示后续页的数量</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">const</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">BranchPageFlag</span>   <span style="color:#111">=</span> <span style="color:#ae81ff">0x01</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">LeafPageFlag</span>     <span style="color:#111">=</span> <span style="color:#ae81ff">0x02</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">MetaPageFlag</span>     <span style="color:#111">=</span> <span style="color:#ae81ff">0x04</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">FreelistPageFlag</span> <span style="color:#111">=</span> <span style="color:#ae81ff">0x10</span> 
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span></code></pre></div><p><code>Page</code> 里面有一个 <code>flags</code> 字段，用来标识这个 page 是什么类型的。boltdb 里面有四种类型的 page, 分别是 分支页（BranchPageFlag）、叶子页（LeafPageFlag）、元数据页（MetaPageFlag）、空闲列表页（FreelistPageFlag）。</p>
<ul>
<li>分支页：由于 boltdb 使用的是 B+ 树，所以分支页用来存储 key 和子节点的指针。</li>
<li>叶子页：叶子页用来存储 key 和 value。</li>
<li>元数据页：元数据页用来存储 boltdb 的元数据，比如 boltdb 的版本号、boltdb 的根节点等。</li>
<li>空闲列表页：由于 boltdb 使用 copy on write，所以当一个 page 被删除的时候，boltdb 并不会立即释放这个 page，而是把这个 page 加入到空闲列表页中，等到需要新的 page 的时候，再从空闲列表页中取出一个 page。</li>
</ul>
<p>在 page 之后会存储对用的结构，比如 meta 或者 freelist。先读取 page 判断自己的结构（定长的：8 + 2 + 2 +4），然后再根据不同的数据类型读取其他的结构（比如BranchPage）。</p>
<p><img src="/images/eebaffa3-116e-40f0-95be-2dfc0ee58bd6.png" alt=""></p>
<h3 id="branchpage--leafpage">BranchPage &amp;&amp; LeafPage</h3>
<p>这两个分别存储 B+ tree 的分支页和叶子页。对应结构为：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// branchPageElement represents a node on a branch page.</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">branchPageElement</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">pos</span>   <span style="color:#00a8c8">uint32</span> <span style="color:#75715e">// 真实数据对应的偏移量</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ksize</span> <span style="color:#00a8c8">uint32</span> <span style="color:#75715e">// key 的大小</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">pgid</span>  <span style="color:#75af00">Pgid</span> <span style="color:#75715e">// 指向 page 的 id</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// leafPageElement represents a node on a leaf page.</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">leafPageElement</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">flags</span> <span style="color:#00a8c8">uint32</span> <span style="color:#75715e">// 是否是一个 bucket</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">pos</span>   <span style="color:#00a8c8">uint32</span> <span style="color:#75715e">// 真实数据对应的偏移量</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ksize</span> <span style="color:#00a8c8">uint32</span> <span style="color:#75715e">// key 的大小</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">vsize</span> <span style="color:#00a8c8">uint32</span> <span style="color:#75715e">// value 的大小</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>对应的存储方式为:</p>
<p><img src="/images/c5206aef-62de-447a-880a-3024a75f4b3d.png" alt=""></p>
<p>从 page 中拿取数据：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">p</span> <span style="color:#f92672">*</span><span style="color:#75af00">Page</span><span style="color:#111">)</span> <span style="color:#75af00">LeafPageElements</span><span style="color:#111">()</span> <span style="color:#111">[]</span><span style="color:#75af00">leafPageElement</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">count</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 从 page 的指针 加上 page 的大小，就是第一个元素的地址</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">data</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">UnsafeAdd</span><span style="color:#111">(</span><span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">(</span><span style="color:#75af00">p</span><span style="color:#111">),</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Sizeof</span><span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">p</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 转换为 slice</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">elems</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Slice</span><span style="color:#111">((</span><span style="color:#f92672">*</span><span style="color:#75af00">leafPageElement</span><span style="color:#111">)(</span><span style="color:#75af00">data</span><span style="color:#111">),</span> <span style="color:#111">int</span><span style="color:#111">(</span><span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">count</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">elems</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">p</span> <span style="color:#f92672">*</span><span style="color:#75af00">Page</span><span style="color:#111">)</span> <span style="color:#75af00">BranchPageElements</span><span style="color:#111">()</span> <span style="color:#111">[]</span><span style="color:#75af00">branchPageElement</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">count</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">data</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">UnsafeAdd</span><span style="color:#111">(</span><span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">(</span><span style="color:#75af00">p</span><span style="color:#111">),</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Sizeof</span><span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">p</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">elems</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Slice</span><span style="color:#111">((</span><span style="color:#f92672">*</span><span style="color:#75af00">branchPageElement</span><span style="color:#111">)(</span><span style="color:#75af00">data</span><span style="color:#111">),</span> <span style="color:#111">int</span><span style="color:#111">(</span><span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">count</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">elems</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="metapage">MetaPage</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Meta</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">magic</span>    <span style="color:#00a8c8">uint32</span> <span style="color:#75715e">// boltdb 的魔数</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">version</span>  <span style="color:#00a8c8">uint32</span> <span style="color:#75715e">// boltdb 的版本</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">pageSize</span> <span style="color:#00a8c8">uint32</span> <span style="color:#75715e">// boltdb 的 page 大小 ，该值和操作系统默认的页大小保持一致</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">flags</span>    <span style="color:#00a8c8">uint32</span> 
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">root</span>     <span style="color:#75af00">InBucket</span> <span style="color:#75715e">// boltdb 的根节点</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">freelist</span> <span style="color:#75af00">Pgid</span>   <span style="color:#75715e">// 空闲页的 id</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">pgid</span>     <span style="color:#75af00">Pgid</span> <span style="color:#75715e">// 当前 page 的 id</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">txid</span>     <span style="color:#75af00">Txid</span> <span style="color:#75715e">// 当前事务的 id</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">checksum</span> <span style="color:#00a8c8">uint64</span> <span style="color:#75715e">// 用作校验的校验和</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>它是如何写到 page 中的和从 page 中读取的呢？</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// 把 meta 写到 page 中</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">m</span> <span style="color:#f92672">*</span><span style="color:#75af00">Meta</span><span style="color:#111">)</span> <span style="color:#75af00">Write</span><span style="color:#111">(</span><span style="color:#75af00">p</span> <span style="color:#f92672">*</span><span style="color:#75af00">Page</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 检查 root bucket 的 pgid 是否有效。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 如果 root.root 的 pgid 大于或等于 m.pgid，这是不合理的，因为这意味着它引用了一个尚未分配的 pgid。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">root</span><span style="color:#111">.</span><span style="color:#75af00">root</span> <span style="color:#f92672">&gt;=</span> <span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">pgid</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Sprintf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;root bucket pgid (%d) above high water mark (%d)&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">root</span><span style="color:#111">.</span><span style="color:#75af00">root</span><span style="color:#111">,</span> <span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">pgid</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	  <span style="color:#75715e">// 检查 freelist 的 pgid 是否有效。</span>
</span></span><span style="display:flex;"><span>	  <span style="color:#75715e">// 如果 freelist 的 pgid 大于或等于 m.pgid 且 freelist 不是 PgidNoFreelist，</span>
</span></span><span style="display:flex;"><span>	  <span style="color:#75715e">// 这同样表示它引用了一个尚未分配的 pgid，这是不合理的。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#00a8c8">if</span> <span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">freelist</span> <span style="color:#f92672">&gt;=</span> <span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">pgid</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">freelist</span> <span style="color:#f92672">!=</span> <span style="color:#75af00">PgidNoFreelist</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Sprintf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;freelist pgid (%d) above high water mark (%d)&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">freelist</span><span style="color:#111">,</span> <span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">pgid</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 指定 pageId 和 page 类型</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">id</span> <span style="color:#111">=</span> <span style="color:#75af00">Pgid</span><span style="color:#111">(</span><span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">txid</span> <span style="color:#f92672">%</span> <span style="color:#ae81ff">2</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">SetFlags</span><span style="color:#111">(</span><span style="color:#75af00">MetaPageFlag</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 计算校验和</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">checksum</span> <span style="color:#111">=</span> <span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">Sum64</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">Copy</span><span style="color:#111">(</span><span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">Meta</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 从 page 中读取 meta</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">p</span> <span style="color:#f92672">*</span><span style="color:#75af00">Page</span><span style="color:#111">)</span> <span style="color:#75af00">Meta</span><span style="color:#111">()</span> <span style="color:#f92672">*</span><span style="color:#75af00">Meta</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">Meta</span><span style="color:#111">)(</span><span style="color:#75af00">UnsafeAdd</span><span style="color:#111">(</span><span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">(</span><span style="color:#75af00">p</span><span style="color:#111">),</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Sizeof</span><span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">p</span><span style="color:#111">)))</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 把 meta 的数据拷贝到 page 中</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">m</span> <span style="color:#f92672">*</span><span style="color:#75af00">Meta</span><span style="color:#111">)</span> <span style="color:#75af00">Copy</span><span style="color:#111">(</span><span style="color:#75af00">dest</span> <span style="color:#f92672">*</span><span style="color:#75af00">Meta</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">*</span><span style="color:#75af00">dest</span> <span style="color:#111">=</span> <span style="color:#f92672">*</span><span style="color:#75af00">m</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 计算校验和</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">m</span> <span style="color:#f92672">*</span><span style="color:#75af00">Meta</span><span style="color:#111">)</span> <span style="color:#75af00">Sum64</span><span style="color:#111">()</span> <span style="color:#00a8c8">uint64</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">var</span> <span style="color:#75af00">h</span> <span style="color:#111">=</span> <span style="color:#75af00">fnv</span><span style="color:#111">.</span><span style="color:#75af00">New64a</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">_</span> <span style="color:#111">=</span> <span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">Write</span><span style="color:#111">((</span><span style="color:#f92672">*</span><span style="color:#111">[</span><span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Offsetof</span><span style="color:#111">(</span><span style="color:#75af00">Meta</span><span style="color:#111">{}.</span><span style="color:#75af00">checksum</span><span style="color:#111">)]</span><span style="color:#00a8c8">byte</span><span style="color:#111">)(</span><span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">(</span><span style="color:#75af00">m</span><span style="color:#111">))[:])</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">Sum64</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="freelistpage">FreelistPage</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">freelist</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 表示 freelist 的类型，可能会有不同的策略或实现。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">freelistType</span> <span style="color:#75af00">FreelistType</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 存储所有已释放且可供分配的页面ID。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">ids</span> <span style="color:#111">[]</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 记录哪个事务ID分配了特定的页面ID。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">allocs</span> <span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">]</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Txid</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 记录即将被释放的页面ID及其所属的事务ID。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">pending</span> <span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Txid</span><span style="color:#111">]</span><span style="color:#f92672">*</span><span style="color:#75af00">txPending</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 快速查找所有空闲和待处理页面ID的缓存。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">cache</span> <span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">]</span><span style="color:#00a8c8">struct</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 按连续页面大小分类的空闲页面，键是连续页面的大小，值是具有相同大小的起始页面ID的集合。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">freemaps</span> <span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#00a8c8">uint64</span><span style="color:#111">]</span><span style="color:#75af00">pidSet</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 正向映射，键是起始页面ID，值是其span大小。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">forwardMap</span> <span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">]</span><span style="color:#00a8c8">uint64</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 反向映射，键是结束页面ID，值是其span大小。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">backwardMap</span> <span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">]</span><span style="color:#00a8c8">uint64</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 空闲页面的计数（基于哈希图的版本）。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">freePagesCount</span> <span style="color:#00a8c8">uint64</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 分配函数，根据提供的事务ID和需求的页面数量分配页面。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">allocate</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">txid</span> <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Txid</span><span style="color:#111">,</span> <span style="color:#75af00">n</span> <span style="color:#00a8c8">int</span><span style="color:#111">)</span> <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 返回当前空闲页面数量的函数。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">free_count</span> <span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#00a8c8">int</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 合并连续空闲页面的函数。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">mergeSpans</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">ids</span> <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgids</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 获取所有空闲页面ID的函数。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">getFreePageIDs</span> <span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#111">[]</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 读取一系列页面ID并初始化 freelist 的函数。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">readIDs</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">pgids</span> <span style="color:#111">[]</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// FreelistType 定义了 freelist 后端的类型，用字符串表示不同的实现策略。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">FreelistType</span> <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 未来的开发计划：</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//  1. 默认改为使用 `FreelistMapType`；</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//  2. 移除 `FreelistArrayType`，不再公开 `FreelistMapType`，</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//     并从 `DB` 和 `Options` 结构体中移除 `FreelistType` 字段。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">const</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// FreelistArrayType 表示 freelist 的后端类型为数组。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 这种类型可能适用于需要按顺序访问空闲页的场景。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">FreelistArrayType</span> <span style="color:#111">=</span> <span style="color:#75af00">FreelistType</span><span style="color:#111">(</span><span style="color:#d88200">&#34;array&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// FreelistMapType 表示 freelist 的后端类型为哈希映射。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 这种类型提供了更快的查找速度，适合于频繁、随机地访问空闲页的情况。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">FreelistMapType</span> <span style="color:#111">=</span> <span style="color:#75af00">FreelistType</span><span style="color:#111">(</span><span style="color:#d88200">&#34;hashmap&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span></code></pre></div><p>把 freelist 写到 page 中：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// write 将空闲和待处理的页面ID写入到 freelist 页面。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 在程序崩溃的事件中，所有待处理的ID都将变成空闲的，因此这些ID都需要被保存到磁盘上。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">f</span> <span style="color:#f92672">*</span><span style="color:#75af00">freelist</span><span style="color:#111">)</span> <span style="color:#75af00">write</span><span style="color:#111">(</span><span style="color:#75af00">p</span> <span style="color:#f92672">*</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Page</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> 	<span style="color:#75715e">// 设置页头中的页类型标识</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">SetFlags</span><span style="color:#111">(</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">FreelistPageFlag</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 获取需要保存的 PageID 数量。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">l</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">count</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">l</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 没有 id 需要保存，直接返回。</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">SetCount</span><span style="color:#111">(</span><span style="color:#111">uint16</span><span style="color:#111">(</span><span style="color:#75af00">l</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#00a8c8">if</span> <span style="color:#75af00">l</span> <span style="color:#111">&lt;</span> <span style="color:#ae81ff">0xFFFF</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 如果数量小于 0xFFFF</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 将 id 数量写入到页头中</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">SetCount</span><span style="color:#111">(</span><span style="color:#111">uint16</span><span style="color:#111">(</span><span style="color:#75af00">l</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 计算指针头</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">data</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">UnsafeAdd</span><span style="color:#111">(</span><span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">(</span><span style="color:#75af00">p</span><span style="color:#111">),</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Sizeof</span><span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">p</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 开辟一个 slice 用来存储 id</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">ids</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Slice</span><span style="color:#111">((</span><span style="color:#f92672">*</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">)(</span><span style="color:#75af00">data</span><span style="color:#111">),</span> <span style="color:#75af00">l</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 将 id 拷贝到 page 中</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">copyall</span><span style="color:#111">(</span><span style="color:#75af00">ids</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 如果数量大于 0xFFFF ，则需要分多个 page 来保存</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 先设置本页的数量为 0xFFFF</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">SetCount</span><span style="color:#111">(</span><span style="color:#ae81ff">0xFFFF</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 计算指针头 </span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">data</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">UnsafeAdd</span><span style="color:#111">(</span><span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">(</span><span style="color:#75af00">p</span><span style="color:#111">),</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Sizeof</span><span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">p</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">ids</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Slice</span><span style="color:#111">((</span><span style="color:#f92672">*</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">)(</span><span style="color:#75af00">data</span><span style="color:#111">),</span> <span style="color:#75af00">l</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 将ID数量存储在第一个元素中</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">ids</span><span style="color:#111">[</span><span style="color:#ae81ff">0</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">(</span><span style="color:#75af00">l</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 将剩余的 id 拷贝到 page 中</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">copyall</span><span style="color:#111">(</span><span style="color:#75af00">ids</span><span style="color:#111">[</span><span style="color:#ae81ff">1</span><span style="color:#111">:])</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// copyall 将所有空闲的ID和所有待处理的ID复制到一个排序后的列表中。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// f.count 返回目标数组 dst 需要的最小长度。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">f</span> <span style="color:#f92672">*</span><span style="color:#75af00">freelist</span><span style="color:#111">)</span> <span style="color:#75af00">copyall</span><span style="color:#111">(</span><span style="color:#75af00">dst</span> <span style="color:#111">[]</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 创建一个切片用于存放待处理的ID，容量预设为待处理ID的数量。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">m</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgids</span><span style="color:#111">,</span> <span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">pending_count</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 遍历所有待处理事务，并将它们的ID加入到切片 m 中。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">txp</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">pending</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">m</span> <span style="color:#111">=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">m</span><span style="color:#111">,</span> <span style="color:#75af00">txp</span><span style="color:#111">.</span><span style="color:#75af00">ids</span><span style="color:#f92672">...</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 对切片 m 进行排序。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">sort</span><span style="color:#111">.</span><span style="color:#75af00">Sort</span><span style="color:#111">(</span><span style="color:#75af00">m</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 将已经空闲的ID和刚排序的待处理ID合并到目标切片 dst 中。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Mergepgids</span><span style="color:#111">(</span><span style="color:#75af00">dst</span><span style="color:#111">,</span> <span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">getFreePageIDs</span><span style="color:#111">(),</span> <span style="color:#75af00">m</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Mergepgids 将两个已排序列表 a 和 b 的并集复制到 dst 中。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 如果 dst 的长度不足以容纳结果，会触发 panic。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">Mergepgids</span><span style="color:#111">(</span><span style="color:#75af00">dst</span><span style="color:#111">,</span> <span style="color:#75af00">a</span><span style="color:#111">,</span> <span style="color:#75af00">b</span> <span style="color:#75af00">Pgids</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 检查目标切片 dst 是否足够大以容纳 a 和 b 的所有元素。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">dst</span><span style="color:#111">)</span> <span style="color:#111">&lt;</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">a</span><span style="color:#111">)</span><span style="color:#f92672">+</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">b</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;mergepgids bad len %d &lt; %d + %d&#34;</span><span style="color:#111">,</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">dst</span><span style="color:#111">),</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">a</span><span style="color:#111">),</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">b</span><span style="color:#111">)))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 如果其中一个列表为空，则直接将另一个列表复制到 dst 中。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">a</span><span style="color:#111">)</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">copy</span><span style="color:#111">(</span><span style="color:#75af00">dst</span><span style="color:#111">,</span> <span style="color:#75af00">b</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">b</span><span style="color:#111">)</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">copy</span><span style="color:#111">(</span><span style="color:#75af00">dst</span><span style="color:#111">,</span> <span style="color:#75af00">a</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 初始化一个切片 merged 来存储最终合并的结果。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">merged</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">dst</span><span style="color:#111">[:</span><span style="color:#ae81ff">0</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 确定哪个列表的起始值更小，并将其设为 lead，另一个设为 follow。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">lead</span><span style="color:#111">,</span> <span style="color:#75af00">follow</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">a</span><span style="color:#111">,</span> <span style="color:#75af00">b</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">b</span><span style="color:#111">[</span><span style="color:#ae81ff">0</span><span style="color:#111">]</span> <span style="color:#111">&lt;</span> <span style="color:#75af00">a</span><span style="color:#111">[</span><span style="color:#ae81ff">0</span><span style="color:#111">]</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">lead</span><span style="color:#111">,</span> <span style="color:#75af00">follow</span> <span style="color:#111">=</span> <span style="color:#75af00">b</span><span style="color:#111">,</span> <span style="color:#75af00">a</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 循环合并，直到 lead 为空。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">for</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">lead</span><span style="color:#111">)</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 合并 lead 中所有小于 follow[0] 的元素。</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">n</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">sort</span><span style="color:#111">.</span><span style="color:#75af00">Search</span><span style="color:#111">(</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">lead</span><span style="color:#111">),</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">i</span> <span style="color:#00a8c8">int</span><span style="color:#111">)</span> <span style="color:#00a8c8">bool</span> <span style="color:#111">{</span> <span style="color:#00a8c8">return</span> <span style="color:#75af00">lead</span><span style="color:#111">[</span><span style="color:#75af00">i</span><span style="color:#111">]</span> <span style="color:#111">&gt;</span> <span style="color:#75af00">follow</span><span style="color:#111">[</span><span style="color:#ae81ff">0</span><span style="color:#111">]</span> <span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">merged</span> <span style="color:#111">=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">merged</span><span style="color:#111">,</span> <span style="color:#75af00">lead</span><span style="color:#111">[:</span><span style="color:#75af00">n</span><span style="color:#111">]</span><span style="color:#f92672">...</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#75af00">n</span> <span style="color:#f92672">&gt;=</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">lead</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">break</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 交换 lead 和 follow，继续合并过程。</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">lead</span><span style="color:#111">,</span> <span style="color:#75af00">follow</span> <span style="color:#111">=</span> <span style="color:#75af00">follow</span><span style="color:#111">,</span> <span style="color:#75af00">lead</span><span style="color:#111">[</span><span style="color:#75af00">n</span><span style="color:#111">:]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 将剩余的 follow 元素加入到 merged 中。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">_</span> <span style="color:#111">=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">merged</span><span style="color:#111">,</span> <span style="color:#75af00">follow</span><span style="color:#f92672">...</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>从 page 中读取 freelist：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// read 从 freelist 页面读取页面ID。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">f</span> <span style="color:#f92672">*</span><span style="color:#75af00">freelist</span><span style="color:#111">)</span> <span style="color:#75af00">read</span><span style="color:#111">(</span><span style="color:#75af00">p</span> <span style="color:#f92672">*</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Page</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 首先检查是否为 freelist 页面，如果不是则抛出错误。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">IsFreelistPage</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Sprintf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;invalid freelist page: %d, page type is %s&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">Id</span><span style="color:#111">(),</span> <span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">Typ</span><span style="color:#111">()))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 从页面获取 freelist 页面的ID列表。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">ids</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">FreelistPageIds</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 如果获取的ID列表为空，将 f.ids 设置为 nil，表示没有空闲页面。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">ids</span><span style="color:#111">)</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">ids</span> <span style="color:#111">=</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 如果ID列表不为空，则创建一个新切片并复制这些ID，以避免直接修改原始页面数据。</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">idsCopy</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">([]</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">,</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">ids</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">copy</span><span style="color:#111">(</span><span style="color:#75af00">idsCopy</span><span style="color:#111">,</span> <span style="color:#75af00">ids</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 确保复制的ID列表是排序的。</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">sort</span><span style="color:#111">.</span><span style="color:#75af00">Sort</span><span style="color:#111">(</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgids</span><span style="color:#111">(</span><span style="color:#75af00">idsCopy</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 将排序后的ID列表读入 freelist 结构。</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">readIDs</span><span style="color:#111">(</span><span style="color:#75af00">idsCopy</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// hashmapReadIDs 读取输入的 pgids 并初始化 freelist（基于哈希映射的版本）。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">f</span> <span style="color:#f92672">*</span><span style="color:#75af00">freelist</span><span style="color:#111">)</span> <span style="color:#75af00">hashmapReadIDs</span><span style="color:#111">(</span><span style="color:#75af00">pgids</span> <span style="color:#111">[]</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 初始化 freelist。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">init</span><span style="color:#111">(</span><span style="color:#75af00">pgids</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 重建页面缓存。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">reindex</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// reindex 基于可用和待处理的空闲列表重建自由缓存。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">f</span> <span style="color:#f92672">*</span><span style="color:#75af00">freelist</span><span style="color:#111">)</span> <span style="color:#75af00">reindex</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 获取所有空闲页面ID。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">ids</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">getFreePageIDs</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 创建一个新的缓存映射。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">cache</span> <span style="color:#111">=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">]</span><span style="color:#00a8c8">struct</span><span style="color:#111">{},</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">ids</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 将所有空闲ID添加到缓存中。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">id</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">ids</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">cache</span><span style="color:#111">[</span><span style="color:#75af00">id</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#00a8c8">struct</span><span style="color:#111">{}{}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 将所有待处理的空闲ID也添加到缓存中。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">txp</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">pending</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">pendingID</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">txp</span><span style="color:#111">.</span><span style="color:#75af00">ids</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">cache</span><span style="color:#111">[</span><span style="color:#75af00">pendingID</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#00a8c8">struct</span><span style="color:#111">{}{}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>分配页：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// hashmapAllocate 根据传入的事务ID和请求的页面数量，分配页面。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">f</span> <span style="color:#f92672">*</span><span style="color:#75af00">freelist</span><span style="color:#111">)</span> <span style="color:#75af00">hashmapAllocate</span><span style="color:#111">(</span><span style="color:#75af00">txid</span> <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Txid</span><span style="color:#111">,</span> <span style="color:#75af00">n</span> <span style="color:#00a8c8">int</span><span style="color:#111">)</span> <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">n</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 如果请求的页面数量为0，则直接返回0，表示没有分配任何页面。</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 检查是否存在完全匹配的空闲span。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">bm</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">freemaps</span><span style="color:#111">[</span><span style="color:#111">uint64</span><span style="color:#111">(</span><span style="color:#75af00">n</span><span style="color:#111">)];</span> <span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">for</span> <span style="color:#75af00">pid</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">bm</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 移除这个span。</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">delSpan</span><span style="color:#111">(</span><span style="color:#75af00">pid</span><span style="color:#111">,</span> <span style="color:#111">uint64</span><span style="color:#111">(</span><span style="color:#75af00">n</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 记录这个页面ID被哪个事务分配。</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">allocs</span><span style="color:#111">[</span><span style="color:#75af00">pid</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#75af00">txid</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 从缓存中移除已分配的页面。</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">for</span> <span style="color:#75af00">i</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">(</span><span style="color:#ae81ff">0</span><span style="color:#111">);</span> <span style="color:#75af00">i</span> <span style="color:#111">&lt;</span> <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">(</span><span style="color:#75af00">n</span><span style="color:#111">);</span> <span style="color:#75af00">i</span><span style="color:#f92672">++</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#111">delete</span><span style="color:#111">(</span><span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">cache</span><span style="color:#111">,</span> <span style="color:#75af00">pid</span><span style="color:#f92672">+</span><span style="color:#75af00">i</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#75af00">pid</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 在映射中查找大于请求大小的更大span。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">size</span><span style="color:#111">,</span> <span style="color:#75af00">bm</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">freemaps</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">size</span> <span style="color:#111">&lt;</span> <span style="color:#111">uint64</span><span style="color:#111">(</span><span style="color:#75af00">n</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">continue</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">for</span> <span style="color:#75af00">pid</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">bm</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 移除找到的大span。</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">delSpan</span><span style="color:#111">(</span><span style="color:#75af00">pid</span><span style="color:#111">,</span> <span style="color:#75af00">size</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 记录页面分配。</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">allocs</span><span style="color:#111">[</span><span style="color:#75af00">pid</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#75af00">txid</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 计算剩余的span大小，并添加回 freelist。</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">remain</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">size</span> <span style="color:#f92672">-</span> <span style="color:#111">uint64</span><span style="color:#111">(</span><span style="color:#75af00">n</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">addSpan</span><span style="color:#111">(</span><span style="color:#75af00">pid</span><span style="color:#f92672">+</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">(</span><span style="color:#75af00">n</span><span style="color:#111">),</span> <span style="color:#75af00">remain</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 从缓存中移除已分配的页面。</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">for</span> <span style="color:#75af00">i</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">(</span><span style="color:#ae81ff">0</span><span style="color:#111">);</span> <span style="color:#75af00">i</span> <span style="color:#111">&lt;</span> <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">(</span><span style="color:#75af00">n</span><span style="color:#111">);</span> <span style="color:#75af00">i</span><span style="color:#f92672">++</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#111">delete</span><span style="color:#111">(</span><span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">cache</span><span style="color:#111">,</span> <span style="color:#75af00">pid</span><span style="color:#f92672">+</span><span style="color:#75af00">i</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#75af00">pid</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// delSpan 从 freelist 中删除一个span。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">f</span> <span style="color:#f92672">*</span><span style="color:#75af00">freelist</span><span style="color:#111">)</span> <span style="color:#75af00">delSpan</span><span style="color:#111">(</span><span style="color:#75af00">start</span> <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">,</span> <span style="color:#75af00">size</span> <span style="color:#00a8c8">uint64</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 更新前向和后向映射，移除对应的条目。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">delete</span><span style="color:#111">(</span><span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">forwardMap</span><span style="color:#111">,</span> <span style="color:#75af00">start</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">delete</span><span style="color:#111">(</span><span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">backwardMap</span><span style="color:#111">,</span> <span style="color:#75af00">start</span><span style="color:#f92672">+</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">(</span><span style="color:#75af00">size</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 从 freemaps 中移除span。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">delete</span><span style="color:#111">(</span><span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">freemaps</span><span style="color:#111">[</span><span style="color:#75af00">size</span><span style="color:#111">],</span> <span style="color:#75af00">start</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">freemaps</span><span style="color:#111">[</span><span style="color:#75af00">size</span><span style="color:#111">])</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 如果某个大小的span已经没有其他项，从 freemaps 中完全移除这个大小。</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">delete</span><span style="color:#111">(</span><span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">freemaps</span><span style="color:#111">,</span> <span style="color:#75af00">size</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 更新空闲页面计数。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">freePagesCount</span> <span style="color:#f92672">-=</span> <span style="color:#75af00">size</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// addSpan 向 freelist 中添加一个新的span。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">f</span> <span style="color:#f92672">*</span><span style="color:#75af00">freelist</span><span style="color:#111">)</span> <span style="color:#75af00">addSpan</span><span style="color:#111">(</span><span style="color:#75af00">start</span> <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">,</span> <span style="color:#75af00">size</span> <span style="color:#00a8c8">uint64</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 更新前向和后向映射。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">backwardMap</span><span style="color:#111">[</span><span style="color:#75af00">start</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">+</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">(</span><span style="color:#75af00">size</span><span style="color:#111">)]</span> <span style="color:#111">=</span> <span style="color:#75af00">size</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">forwardMap</span><span style="color:#111">[</span><span style="color:#75af00">start</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#75af00">size</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 确保 freemaps 中存在对应大小的映射。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">freemaps</span><span style="color:#111">[</span><span style="color:#75af00">size</span><span style="color:#111">];</span> <span style="color:#111">!</span><span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">freemaps</span><span style="color:#111">[</span><span style="color:#75af00">size</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">]</span><span style="color:#00a8c8">struct</span><span style="color:#111">{})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 添加新的span到 freemaps。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">freemaps</span><span style="color:#111">[</span><span style="color:#75af00">size</span><span style="color:#111">][</span><span style="color:#75af00">start</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#00a8c8">struct</span><span style="color:#111">{}{}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 更新空闲页面计数。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">freePagesCount</span> <span style="color:#f92672">+=</span> <span style="color:#75af00">size</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="node">Node</h2>
<p>page 的操作跟多都是基于磁盘设计的，在内存中使用这些数据结构并不是很方便。所以 boltdb 会把 page 的数据结构转换为 node 的数据结构，这样在内存中操作就会方便很多。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">node</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">bucket</span>     <span style="color:#f92672">*</span><span style="color:#75af00">Bucket</span> <span style="color:#75715e">// bucket 的指针</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">isLeaf</span>     <span style="color:#00a8c8">bool</span> <span style="color:#75715e">// 是否是叶子节点</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">unbalanced</span> <span style="color:#00a8c8">bool</span> <span style="color:#75715e">// 是否平衡</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">spilled</span>    <span style="color:#00a8c8">bool</span> <span style="color:#75715e">// 是否溢出</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">key</span>        <span style="color:#111">[]</span><span style="color:#00a8c8">byte</span> <span style="color:#75715e">// 该 node 的起始 key</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">pgid</span>       <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span> <span style="color:#75715e">// 该 node 对应的 page id</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">parent</span>     <span style="color:#f92672">*</span><span style="color:#75af00">node</span> <span style="color:#75715e">// 父节点</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">children</span>   <span style="color:#75af00">nodes</span> <span style="color:#75715e">// 子节点</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">inodes</span>     <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Inodes</span> <span style="color:#75715e">// 存储键值对的结构体数组</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Inode</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">flags</span> <span style="color:#00a8c8">uint32</span> <span style="color:#75715e">// 用于 leaf node 是否是一个 bucket （subbucket）</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">pgid</span>  <span style="color:#75af00">Pgid</span>	<span style="color:#75715e">// 用于 branch node, 子节点的 page id</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">key</span>   <span style="color:#111">[]</span><span style="color:#00a8c8">byte</span> <span style="color:#75715e">// key</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">value</span> <span style="color:#111">[]</span><span style="color:#00a8c8">byte</span> <span style="color:#75715e">// value</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Inodes</span> <span style="color:#111">[]</span><span style="color:#75af00">Inode</span>
</span></span></code></pre></div><h3 id="page-to-node">page to node</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">n</span> <span style="color:#f92672">*</span><span style="color:#75af00">node</span><span style="color:#111">)</span> <span style="color:#75af00">read</span><span style="color:#111">(</span><span style="color:#75af00">p</span> <span style="color:#f92672">*</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Page</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">pgid</span> <span style="color:#111">=</span> <span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">Id</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">isLeaf</span> <span style="color:#111">=</span> <span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">IsLeafPage</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 读取 inodes</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">inodes</span> <span style="color:#111">=</span> <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">ReadInodeFromPage</span><span style="color:#111">(</span><span style="color:#75af00">p</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 保存第一个键，以便在将节点写入到父节点时能够找到这个节点。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">inodes</span><span style="color:#111">)</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">key</span> <span style="color:#111">=</span> <span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">inodes</span><span style="color:#111">[</span><span style="color:#ae81ff">0</span><span style="color:#111">].</span><span style="color:#75af00">Key</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Assert</span><span style="color:#111">(</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">key</span><span style="color:#111">)</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;read: zero-length node key&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">key</span> <span style="color:#111">=</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">ReadInodeFromPage</span><span style="color:#111">(</span><span style="color:#75af00">p</span> <span style="color:#f92672">*</span><span style="color:#75af00">Page</span><span style="color:#111">)</span> <span style="color:#75af00">Inodes</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">inodes</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#75af00">Inodes</span><span style="color:#111">,</span> <span style="color:#111">int</span><span style="color:#111">(</span><span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">Count</span><span style="color:#111">()))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">isLeaf</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">IsLeafPage</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span><span style="color:#111">;</span> <span style="color:#75af00">i</span> <span style="color:#111">&lt;</span> <span style="color:#111">int</span><span style="color:#111">(</span><span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">Count</span><span style="color:#111">());</span> <span style="color:#75af00">i</span><span style="color:#f92672">++</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">inode</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">inodes</span><span style="color:#111">[</span><span style="color:#75af00">i</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">isLeaf</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 转换为 leafPageElement 结构</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">elem</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">LeafPageElement</span><span style="color:#111">(</span><span style="color:#111">uint16</span><span style="color:#111">(</span><span style="color:#75af00">i</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">inode</span><span style="color:#111">.</span><span style="color:#75af00">SetFlags</span><span style="color:#111">(</span><span style="color:#75af00">elem</span><span style="color:#111">.</span><span style="color:#75af00">Flags</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">inode</span><span style="color:#111">.</span><span style="color:#75af00">SetKey</span><span style="color:#111">(</span><span style="color:#75af00">elem</span><span style="color:#111">.</span><span style="color:#75af00">Key</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">inode</span><span style="color:#111">.</span><span style="color:#75af00">SetValue</span><span style="color:#111">(</span><span style="color:#75af00">elem</span><span style="color:#111">.</span><span style="color:#75af00">Value</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 转换为 branchPageElement 结构</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">elem</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">BranchPageElement</span><span style="color:#111">(</span><span style="color:#111">uint16</span><span style="color:#111">(</span><span style="color:#75af00">i</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">inode</span><span style="color:#111">.</span><span style="color:#75af00">SetPgid</span><span style="color:#111">(</span><span style="color:#75af00">elem</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">inode</span><span style="color:#111">.</span><span style="color:#75af00">SetKey</span><span style="color:#111">(</span><span style="color:#75af00">elem</span><span style="color:#111">.</span><span style="color:#75af00">Key</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">Assert</span><span style="color:#111">(</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">inode</span><span style="color:#111">.</span><span style="color:#75af00">Key</span><span style="color:#111">())</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;read: zero-length inode key&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">inodes</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="node-to-page">node to page</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// write writes the items onto one or more pages.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// The page should have p.id (might be 0 for meta or bucket-inline page) and p.overflow set</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// and the rest should be zeroed.</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">n</span> <span style="color:#f92672">*</span><span style="color:#75af00">node</span><span style="color:#111">)</span> <span style="color:#75af00">write</span><span style="color:#111">(</span><span style="color:#75af00">p</span> <span style="color:#f92672">*</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Page</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Assert</span><span style="color:#111">(</span><span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">Count</span><span style="color:#111">()</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">Flags</span><span style="color:#111">()</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;node cannot be written into a not empty page&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Initialize page.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">isLeaf</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">SetFlags</span><span style="color:#111">(</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">LeafPageFlag</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">SetFlags</span><span style="color:#111">(</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">BranchPageFlag</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">inodes</span><span style="color:#111">)</span> <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0xFFFF</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Sprintf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;inode overflow: %d (pgid=%d)&#34;</span><span style="color:#111">,</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">inodes</span><span style="color:#111">),</span> <span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">Id</span><span style="color:#111">()))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">SetCount</span><span style="color:#111">(</span><span style="color:#111">uint16</span><span style="color:#111">(</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">inodes</span><span style="color:#111">)))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Stop here if there are no items to write.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">Count</span><span style="color:#111">()</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 将node的inodes写入page</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">WriteInodeToPage</span><span style="color:#111">(</span><span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">inodes</span><span style="color:#111">,</span> <span style="color:#75af00">p</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// DEBUG ONLY: n.dump()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">WriteInodeToPage</span><span style="color:#111">(</span><span style="color:#75af00">inodes</span> <span style="color:#75af00">Inodes</span><span style="color:#111">,</span> <span style="color:#75af00">p</span> <span style="color:#f92672">*</span><span style="color:#75af00">Page</span><span style="color:#111">)</span> <span style="color:#00a8c8">uint32</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 计算写入的初始偏移量。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">off</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Sizeof</span><span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">p</span><span style="color:#111">)</span> <span style="color:#f92672">+</span> <span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">PageElementSize</span><span style="color:#111">()</span><span style="color:#f92672">*</span><span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">inodes</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">isLeaf</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">IsLeafPage</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">i</span><span style="color:#111">,</span> <span style="color:#75af00">item</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">inodes</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">Assert</span><span style="color:#111">(</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">item</span><span style="color:#111">.</span><span style="color:#75af00">Key</span><span style="color:#111">())</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;write: zero-length inode key&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 创建一个足够大小的切片来存放键和值。</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">sz</span> <span style="color:#f92672">:=</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">item</span><span style="color:#111">.</span><span style="color:#75af00">Key</span><span style="color:#111">())</span> <span style="color:#f92672">+</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">item</span><span style="color:#111">.</span><span style="color:#75af00">Value</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">b</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">UnsafeByteSlice</span><span style="color:#111">(</span><span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">(</span><span style="color:#75af00">p</span><span style="color:#111">),</span> <span style="color:#75af00">off</span><span style="color:#111">,</span> <span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#75af00">sz</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">off</span> <span style="color:#f92672">+=</span> <span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">sz</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Write the page element.</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">isLeaf</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">elem</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">LeafPageElement</span><span style="color:#111">(</span><span style="color:#111">uint16</span><span style="color:#111">(</span><span style="color:#75af00">i</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">elem</span><span style="color:#111">.</span><span style="color:#75af00">SetPos</span><span style="color:#111">(</span><span style="color:#111">uint32</span><span style="color:#111">(</span><span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">b</span><span style="color:#111">[</span><span style="color:#ae81ff">0</span><span style="color:#111">]))</span> <span style="color:#f92672">-</span> <span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">(</span><span style="color:#75af00">elem</span><span style="color:#111">))))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">elem</span><span style="color:#111">.</span><span style="color:#75af00">SetFlags</span><span style="color:#111">(</span><span style="color:#75af00">item</span><span style="color:#111">.</span><span style="color:#75af00">Flags</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">elem</span><span style="color:#111">.</span><span style="color:#75af00">SetKsize</span><span style="color:#111">(</span><span style="color:#111">uint32</span><span style="color:#111">(</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">item</span><span style="color:#111">.</span><span style="color:#75af00">Key</span><span style="color:#111">())))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">elem</span><span style="color:#111">.</span><span style="color:#75af00">SetVsize</span><span style="color:#111">(</span><span style="color:#111">uint32</span><span style="color:#111">(</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">item</span><span style="color:#111">.</span><span style="color:#75af00">Value</span><span style="color:#111">())))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">elem</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">BranchPageElement</span><span style="color:#111">(</span><span style="color:#111">uint16</span><span style="color:#111">(</span><span style="color:#75af00">i</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">elem</span><span style="color:#111">.</span><span style="color:#75af00">SetPos</span><span style="color:#111">(</span><span style="color:#111">uint32</span><span style="color:#111">(</span><span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">b</span><span style="color:#111">[</span><span style="color:#ae81ff">0</span><span style="color:#111">]))</span> <span style="color:#f92672">-</span> <span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">(</span><span style="color:#75af00">elem</span><span style="color:#111">))))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">elem</span><span style="color:#111">.</span><span style="color:#75af00">SetKsize</span><span style="color:#111">(</span><span style="color:#111">uint32</span><span style="color:#111">(</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">item</span><span style="color:#111">.</span><span style="color:#75af00">Key</span><span style="color:#111">())))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">elem</span><span style="color:#111">.</span><span style="color:#75af00">SetPgid</span><span style="color:#111">(</span><span style="color:#75af00">item</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">Assert</span><span style="color:#111">(</span><span style="color:#75af00">elem</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">()</span> <span style="color:#f92672">!=</span> <span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">Id</span><span style="color:#111">(),</span> <span style="color:#d88200">&#34;write: circular dependency occurred&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 将键和值数据写入到页面的末尾。</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">l</span> <span style="color:#f92672">:=</span> <span style="color:#111">copy</span><span style="color:#111">(</span><span style="color:#75af00">b</span><span style="color:#111">,</span> <span style="color:#75af00">item</span><span style="color:#111">.</span><span style="color:#75af00">Key</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">copy</span><span style="color:#111">(</span><span style="color:#75af00">b</span><span style="color:#111">[</span><span style="color:#75af00">l</span><span style="color:#111">:],</span> <span style="color:#75af00">item</span><span style="color:#111">.</span><span style="color:#75af00">Value</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#111">uint32</span><span style="color:#111">(</span><span style="color:#75af00">off</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="bucket">Bucket</h2>
<p>Bucket 是 boltdb 的上层的数据结构，每个 bucket 都有一个完成的 B+ 树。将多个 page 联合起来。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Bucket</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">*</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">InBucket</span>             
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">tx</span>       <span style="color:#f92672">*</span><span style="color:#75af00">Tx</span>                    <span style="color:#75715e">// 指向关联事务的指针，将 bucket 与其事务上下文连接。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">buckets</span>  <span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#00a8c8">string</span><span style="color:#111">]</span><span style="color:#f92672">*</span><span style="color:#75af00">Bucket</span>     <span style="color:#75715e">// 子 bucket 缓存；允许通过名字快速访问子 bucket。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">page</span>     <span style="color:#f92672">*</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Page</span>           <span style="color:#75715e">// 内联页面的引用，用于直接存储少量数据或作为数据节点的入口点。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">rootNode</span> <span style="color:#f92672">*</span><span style="color:#75af00">node</span>                  <span style="color:#75715e">// 根页面的已实例化节点，如果 bucket 直接存储在内存中，则此节点将被激活。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">nodes</span>    <span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">]</span><span style="color:#f92672">*</span><span style="color:#75af00">node</span>  <span style="color:#75715e">// 节点缓存，用于快速访问已加载的页面节点，避免重复读取磁盘。</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 设置节点分裂时的填充阈值。默认情况下，bucket 将填充至 50%，</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 但如果你知道你的写入工作负载主要是追加操作，提高这个比例可能会有用。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    // 这个设置不会跨事务持久化，因此每个事务都必须设置它。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">FillPercent</span> <span style="color:#00a8c8">float64</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">InBucket</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">root</span>     <span style="color:#75af00">Pgid</span>   <span style="color:#75715e">// bucket 根级页面的页面ID。如果 bucket 是内联的，则此值为 0。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">sequence</span> <span style="color:#00a8c8">uint64</span> <span style="color:#75715e">// 单调递增的序列号，用于 NextSequence() 函数。</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>Bucket 有可能是 node，也可能是 page。查找某页面的键值对时，首先检查 Bucket.nodes 缓存是否有对应的 node，如果没有，再从 page 中查找。
Bucket.FillPercent 记录 node 的填充百分比。当 node 的已用空间超过其容量的某个百分比后，节点必须分裂，以减少在 B+ Tree 中插入键值对时触发再平衡的概率。默认值是 50%，仅当大量写入操作在尾部添加时，增大该值才有帮助。</p>
<p>bucket 存储方式：</p>
<p><img src="/images/04c8dda1-ff6f-4ae5-9162-bf31819e9a9c.png" alt=""></p>
<h3 id="遍历-cursor">遍历 cursor</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Cursor</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">bucket</span> <span style="color:#f92672">*</span><span style="color:#75af00">Bucket</span>  
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">stack</span>  <span style="color:#111">[]</span><span style="color:#75af00">elemRef</span> 
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">elemRef</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">page</span>  <span style="color:#f92672">*</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Page</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">node</span>  <span style="color:#f92672">*</span><span style="color:#75af00">node</span>        
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">index</span> <span style="color:#00a8c8">int</span>    
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>cursor 分为三类，定位到某一个元素的位置、在当前位置从前往后找、在当前位置从后往前找。方法为：First、Last、Next、Prev 等。</p>
<h4 id="seek">Seek</h4>
<p>如果该键存在，它会返回该键及其对应的值；如果键不存在，它则返回最近的后续键。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// Seek 方法使用B树搜索将光标移动到给定的键并返回它。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 如果键不存在，则使用下一个键。如果没有更多的键，返回nil。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 返回的键和值只在事务的生命周期内有效。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">Cursor</span><span style="color:#111">)</span> <span style="color:#75af00">Seek</span><span style="color:#111">(</span><span style="color:#75af00">seek</span> <span style="color:#111">[]</span><span style="color:#00a8c8">byte</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#75af00">key</span> <span style="color:#111">[]</span><span style="color:#00a8c8">byte</span><span style="color:#111">,</span> <span style="color:#75af00">value</span> <span style="color:#111">[]</span><span style="color:#00a8c8">byte</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 确保数据库事务没有关闭</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Assert</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">bucket</span><span style="color:#111">.</span><span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">db</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;tx closed&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 调用内部的seek方法，获取键和值</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">k</span><span style="color:#111">,</span> <span style="color:#75af00">v</span><span style="color:#111">,</span> <span style="color:#75af00">flags</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">seek</span><span style="color:#111">(</span><span style="color:#75af00">seek</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 检查是否位于页面的最后一个元素之后，如果是，则移动到下一个元素。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">ref</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">stack</span><span style="color:#111">[</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">stack</span><span style="color:#111">)</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">];</span> <span style="color:#75af00">ref</span><span style="color:#111">.</span><span style="color:#75af00">index</span> <span style="color:#f92672">&gt;=</span> <span style="color:#75af00">ref</span><span style="color:#111">.</span><span style="color:#75af00">count</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">k</span><span style="color:#111">,</span> <span style="color:#75af00">v</span><span style="color:#111">,</span> <span style="color:#75af00">flags</span> <span style="color:#111">=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">next</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 如果k为nil，表示未找到键，返回nil。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">k</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#00a8c8">if</span> <span style="color:#111">(</span><span style="color:#75af00">flags</span> <span style="color:#f92672">&amp;</span> <span style="color:#111">uint32</span><span style="color:#111">(</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">BucketLeafFlag</span><span style="color:#111">))</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 如果是叶子节点，返回键和nil值。</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">k</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 返回找到的键和值。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#75af00">k</span><span style="color:#111">,</span> <span style="color:#75af00">v</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// seek 方法将光标移动到给定的键，并返回该键。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 如果键不存在，则使用下一个键。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">Cursor</span><span style="color:#111">)</span> <span style="color:#75af00">seek</span><span style="color:#111">(</span><span style="color:#75af00">seek</span> <span style="color:#111">[]</span><span style="color:#00a8c8">byte</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#75af00">key</span> <span style="color:#111">[]</span><span style="color:#00a8c8">byte</span><span style="color:#111">,</span> <span style="color:#75af00">value</span> <span style="color:#111">[]</span><span style="color:#00a8c8">byte</span><span style="color:#111">,</span> <span style="color:#75af00">flags</span> <span style="color:#00a8c8">uint32</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 从根页面/节点开始，遍历到正确的页面。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">stack</span> <span style="color:#111">=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">stack</span><span style="color:#111">[:</span><span style="color:#ae81ff">0</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">search</span><span style="color:#111">(</span><span style="color:#75af00">seek</span><span style="color:#111">,</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">bucket</span><span style="color:#111">.</span><span style="color:#75af00">RootPage</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 如果是桶，则返回nil值。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">keyValue</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>search</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// search 方法递归地对给定的页面/节点进行二分搜索，直到找到给定的键。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">Cursor</span><span style="color:#111">)</span> <span style="color:#75af00">search</span><span style="color:#111">(</span><span style="color:#75af00">key</span> <span style="color:#111">[]</span><span style="color:#00a8c8">byte</span><span style="color:#111">,</span> <span style="color:#75af00">pgId</span> <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">p</span><span style="color:#111">,</span> <span style="color:#75af00">n</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">bucket</span><span style="color:#111">.</span><span style="color:#75af00">pageNode</span><span style="color:#111">(</span><span style="color:#75af00">pgId</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">p</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#111">!</span><span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">IsBranchPage</span><span style="color:#111">()</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#111">!</span><span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">IsLeafPage</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Sprintf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;invalid page type: %d: %x&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">Id</span><span style="color:#111">(),</span> <span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">Flags</span><span style="color:#111">()))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">e</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">elemRef</span><span style="color:#111">{</span><span style="color:#75af00">page</span><span style="color:#111">:</span> <span style="color:#75af00">p</span><span style="color:#111">,</span> <span style="color:#75af00">node</span><span style="color:#111">:</span> <span style="color:#75af00">n</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">stack</span> <span style="color:#111">=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">stack</span><span style="color:#111">,</span> <span style="color:#75af00">e</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 如果我们位于叶节点页面上，则在该页面内部继续查找特定节点。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">isLeaf</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">nsearch</span><span style="color:#111">(</span><span style="color:#75af00">key</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 如果是节点，继续在节点内部搜索。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">n</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">searchNode</span><span style="color:#111">(</span><span style="color:#75af00">key</span><span style="color:#111">,</span> <span style="color:#75af00">n</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 如果是页面，继续在页面内部搜索。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">searchPage</span><span style="color:#111">(</span><span style="color:#75af00">key</span><span style="color:#111">,</span> <span style="color:#75af00">p</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">Cursor</span><span style="color:#111">)</span> <span style="color:#75af00">searchNode</span><span style="color:#111">(</span><span style="color:#75af00">key</span> <span style="color:#111">[]</span><span style="color:#00a8c8">byte</span><span style="color:#111">,</span> <span style="color:#75af00">n</span> <span style="color:#f92672">*</span><span style="color:#75af00">node</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">var</span> <span style="color:#75af00">exact</span> <span style="color:#00a8c8">bool</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 使用二分搜索确定键的位置。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">index</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">sort</span><span style="color:#111">.</span><span style="color:#75af00">Search</span><span style="color:#111">(</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">inodes</span><span style="color:#111">),</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">i</span> <span style="color:#00a8c8">int</span><span style="color:#111">)</span> <span style="color:#00a8c8">bool</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">ret</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">bytes</span><span style="color:#111">.</span><span style="color:#75af00">Compare</span><span style="color:#111">(</span><span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">inodes</span><span style="color:#111">[</span><span style="color:#75af00">i</span><span style="color:#111">].</span><span style="color:#75af00">Key</span><span style="color:#111">(),</span> <span style="color:#75af00">key</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#75af00">ret</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75af00">exact</span> <span style="color:#111">=</span> <span style="color:#00a8c8">true</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">ret</span> <span style="color:#f92672">!=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">exact</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">index</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">index</span><span style="color:#f92672">--</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">stack</span><span style="color:#111">[</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">stack</span><span style="color:#111">)</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">].</span><span style="color:#75af00">index</span> <span style="color:#111">=</span> <span style="color:#75af00">index</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 递归搜索到下一页。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">search</span><span style="color:#111">(</span><span style="color:#75af00">key</span><span style="color:#111">,</span> <span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">inodes</span><span style="color:#111">[</span><span style="color:#75af00">index</span><span style="color:#111">].</span><span style="color:#75af00">Pgid</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">Cursor</span><span style="color:#111">)</span> <span style="color:#75af00">searchPage</span><span style="color:#111">(</span><span style="color:#75af00">key</span> <span style="color:#111">[]</span><span style="color:#00a8c8">byte</span><span style="color:#111">,</span> <span style="color:#75af00">p</span> <span style="color:#f92672">*</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Page</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 对页面进行二分搜索以确定正确的范围。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">inodes</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">BranchPageElements</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">var</span> <span style="color:#75af00">exact</span> <span style="color:#00a8c8">bool</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">index</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">sort</span><span style="color:#111">.</span><span style="color:#75af00">Search</span><span style="color:#111">(</span><span style="color:#111">int</span><span style="color:#111">(</span><span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">Count</span><span style="color:#111">()),</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">i</span> <span style="color:#00a8c8">int</span><span style="color:#111">)</span> <span style="color:#00a8c8">bool</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">ret</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">bytes</span><span style="color:#111">.</span><span style="color:#75af00">Compare</span><span style="color:#111">(</span><span style="color:#75af00">inodes</span><span style="color:#111">[</span><span style="color:#75af00">i</span><span style="color:#111">].</span><span style="color:#75af00">Key</span><span style="color:#111">(),</span> <span style="color:#75af00">key</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#75af00">ret</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75af00">exact</span> <span style="color:#111">=</span> <span style="color:#00a8c8">true</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">ret</span> <span style="color:#f92672">!=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">exact</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">index</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">index</span><span style="color:#f92672">--</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">stack</span><span style="color:#111">[</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">stack</span><span style="color:#111">)</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">].</span><span style="color:#75af00">index</span> <span style="color:#111">=</span> <span style="color:#75af00">index</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 递归搜索到下一页。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">search</span><span style="color:#111">(</span><span style="color:#75af00">key</span><span style="color:#111">,</span> <span style="color:#75af00">inodes</span><span style="color:#111">[</span><span style="color:#75af00">index</span><span style="color:#111">].</span><span style="color:#75af00">Pgid</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">Cursor</span><span style="color:#111">)</span> <span style="color:#75af00">nsearch</span><span style="color:#111">(</span><span style="color:#75af00">key</span> <span style="color:#111">[]</span><span style="color:#00a8c8">byte</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">e</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">stack</span><span style="color:#111">[</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">stack</span><span style="color:#111">)</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">p</span><span style="color:#111">,</span> <span style="color:#75af00">n</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">page</span><span style="color:#111">,</span> <span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">node</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// If we have a node then search its inodes.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">n</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">index</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">sort</span><span style="color:#111">.</span><span style="color:#75af00">Search</span><span style="color:#111">(</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">inodes</span><span style="color:#111">),</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">i</span> <span style="color:#00a8c8">int</span><span style="color:#111">)</span> <span style="color:#00a8c8">bool</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#75af00">bytes</span><span style="color:#111">.</span><span style="color:#75af00">Compare</span><span style="color:#111">(</span><span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">inodes</span><span style="color:#111">[</span><span style="color:#75af00">i</span><span style="color:#111">].</span><span style="color:#75af00">Key</span><span style="color:#111">(),</span> <span style="color:#75af00">key</span><span style="color:#111">)</span> <span style="color:#f92672">!=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">index</span> <span style="color:#111">=</span> <span style="color:#75af00">index</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// If we have a page then search its leaf elements.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">inodes</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">LeafPageElements</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">index</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">sort</span><span style="color:#111">.</span><span style="color:#75af00">Search</span><span style="color:#111">(</span><span style="color:#111">int</span><span style="color:#111">(</span><span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">Count</span><span style="color:#111">()),</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">i</span> <span style="color:#00a8c8">int</span><span style="color:#111">)</span> <span style="color:#00a8c8">bool</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">bytes</span><span style="color:#111">.</span><span style="color:#75af00">Compare</span><span style="color:#111">(</span><span style="color:#75af00">inodes</span><span style="color:#111">[</span><span style="color:#75af00">i</span><span style="color:#111">].</span><span style="color:#75af00">Key</span><span style="color:#111">(),</span> <span style="color:#75af00">key</span><span style="color:#111">)</span> <span style="color:#f92672">!=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">index</span> <span style="color:#111">=</span> <span style="color:#75af00">index</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>keyValue</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">Cursor</span><span style="color:#111">)</span> <span style="color:#75af00">keyValue</span><span style="color:#111">()</span> <span style="color:#111">([]</span><span style="color:#00a8c8">byte</span><span style="color:#111">,</span> <span style="color:#111">[]</span><span style="color:#00a8c8">byte</span><span style="color:#111">,</span> <span style="color:#00a8c8">uint32</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ref</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">stack</span><span style="color:#111">[</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">stack</span><span style="color:#111">)</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 如果索引超出范围，则返回nil。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">ref</span><span style="color:#111">.</span><span style="color:#75af00">count</span><span style="color:#111">()</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">||</span> <span style="color:#75af00">ref</span><span style="color:#111">.</span><span style="color:#75af00">index</span> <span style="color:#f92672">&gt;=</span> <span style="color:#75af00">ref</span><span style="color:#111">.</span><span style="color:#75af00">count</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//  从node中获取键值对。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">ref</span><span style="color:#111">.</span><span style="color:#75af00">node</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">inode</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">ref</span><span style="color:#111">.</span><span style="color:#75af00">node</span><span style="color:#111">.</span><span style="color:#75af00">inodes</span><span style="color:#111">[</span><span style="color:#75af00">ref</span><span style="color:#111">.</span><span style="color:#75af00">index</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">inode</span><span style="color:#111">.</span><span style="color:#75af00">Key</span><span style="color:#111">(),</span> <span style="color:#75af00">inode</span><span style="color:#111">.</span><span style="color:#75af00">Value</span><span style="color:#111">(),</span> <span style="color:#75af00">inode</span><span style="color:#111">.</span><span style="color:#75af00">Flags</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 从 page 中获取键值对。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">elem</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">ref</span><span style="color:#111">.</span><span style="color:#75af00">page</span><span style="color:#111">.</span><span style="color:#75af00">LeafPageElement</span><span style="color:#111">(</span><span style="color:#111">uint16</span><span style="color:#111">(</span><span style="color:#75af00">ref</span><span style="color:#111">.</span><span style="color:#75af00">index</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">elem</span><span style="color:#111">.</span><span style="color:#75af00">Key</span><span style="color:#111">(),</span> <span style="color:#75af00">elem</span><span style="color:#111">.</span><span style="color:#75af00">Value</span><span style="color:#111">(),</span> <span style="color:#75af00">elem</span><span style="color:#111">.</span><span style="color:#75af00">Flags</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="创建-bucket-如果不存在">创建 bucket 如果不存在</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// CreateBucketIfNotExists 如果指定的存储桶不存在，则创建它，并返回一个对它的引用。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 如果存储桶名为空或太长，则返回错误。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 存储桶实例仅在事务的生命周期内有效。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">b</span> <span style="color:#f92672">*</span><span style="color:#75af00">Bucket</span><span style="color:#111">)</span> <span style="color:#75af00">CreateBucketIfNotExists</span><span style="color:#111">(</span><span style="color:#75af00">key</span> <span style="color:#111">[]</span><span style="color:#00a8c8">byte</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#75af00">rb</span> <span style="color:#f92672">*</span><span style="color:#75af00">Bucket</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 如果日志不是被丢弃，记录创建存储桶的尝试。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">lg</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">Logger</span><span style="color:#111">();</span> <span style="color:#75af00">lg</span> <span style="color:#f92672">!=</span> <span style="color:#75af00">discardLogger</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">lg</span><span style="color:#111">.</span><span style="color:#75af00">Debugf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Creating bucket if not exist %q&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">key</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">defer</span> <span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75af00">lg</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Creating bucket if not exist %q failed: %v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">key</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75af00">lg</span><span style="color:#111">.</span><span style="color:#75af00">Debugf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Creating bucket if not exist %q successfully&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">key</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 检查数据库是否关闭，检查事务是否可写，检查键名是否为空。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">db</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">errors</span><span style="color:#111">.</span><span style="color:#75af00">ErrTxClosed</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">writable</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">errors</span><span style="color:#111">.</span><span style="color:#75af00">ErrTxNotWritable</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#00a8c8">if</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">key</span><span style="color:#111">)</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">errors</span><span style="color:#111">.</span><span style="color:#75af00">ErrBucketNameRequired</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 使用克隆的键而不是原始键，以避免内存泄漏。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">newKey</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">cloneBytes</span><span style="color:#111">(</span><span style="color:#75af00">key</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 检查键是否已存在。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">buckets</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#75af00">child</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">buckets</span><span style="color:#111">[</span><span style="color:#111">string</span><span style="color:#111">(</span><span style="color:#75af00">newKey</span><span style="color:#111">)];</span> <span style="color:#75af00">child</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">return</span> <span style="color:#75af00">child</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 使用光标寻找正确的位置。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">c</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">Cursor</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">k</span><span style="color:#111">,</span> <span style="color:#75af00">v</span><span style="color:#111">,</span> <span style="color:#75af00">flags</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">seek</span><span style="color:#111">(</span><span style="color:#75af00">newKey</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 如果找到的键相同，检查是否已有相同名字的非存储桶键。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">bytes</span><span style="color:#111">.</span><span style="color:#75af00">Equal</span><span style="color:#111">(</span><span style="color:#75af00">newKey</span><span style="color:#111">,</span> <span style="color:#75af00">k</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#111">(</span><span style="color:#75af00">flags</span> <span style="color:#f92672">&amp;</span> <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">BucketLeafFlag</span><span style="color:#111">)</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">var</span> <span style="color:#75af00">child</span> <span style="color:#111">=</span> <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">openBucket</span><span style="color:#111">(</span><span style="color:#75af00">v</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">if</span> <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">buckets</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">buckets</span><span style="color:#111">[</span><span style="color:#111">string</span><span style="color:#111">(</span><span style="color:#75af00">newKey</span><span style="color:#111">)]</span> <span style="color:#111">=</span> <span style="color:#75af00">child</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">return</span> <span style="color:#75af00">child</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">errors</span><span style="color:#111">.</span><span style="color:#75af00">ErrIncompatibleValue</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 创建空的内联存储桶。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">var</span> <span style="color:#75af00">bucket</span> <span style="color:#111">=</span> <span style="color:#75af00">Bucket</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">InBucket</span><span style="color:#111">:</span>    <span style="color:#f92672">&amp;</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">InBucket</span><span style="color:#111">{},</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">rootNode</span><span style="color:#111">:</span>    <span style="color:#f92672">&amp;</span><span style="color:#75af00">node</span><span style="color:#111">{</span><span style="color:#75af00">isLeaf</span><span style="color:#111">:</span> <span style="color:#00a8c8">true</span><span style="color:#111">},</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">FillPercent</span><span style="color:#111">:</span> <span style="color:#75af00">DefaultFillPercent</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">var</span> <span style="color:#75af00">value</span> <span style="color:#111">=</span> <span style="color:#75af00">bucket</span><span style="color:#111">.</span><span style="color:#75af00">write</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 在当前节点上插入键、值、标志。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">node</span><span style="color:#111">().</span><span style="color:#75af00">put</span><span style="color:#111">(</span><span style="color:#75af00">newKey</span><span style="color:#111">,</span> <span style="color:#75af00">newKey</span><span style="color:#111">,</span> <span style="color:#75af00">value</span><span style="color:#111">,</span> <span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">BucketLeafFlag</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 如果存在内联页面，取消引用它，使得存储桶被视为常规非内联存储桶。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">page</span> <span style="color:#111">=</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 返回新创建的存储桶。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">Bucket</span><span style="color:#111">(</span><span style="color:#75af00">newKey</span><span style="color:#111">),</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// node方法返回光标当前定位的节点。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">Cursor</span><span style="color:#111">)</span> <span style="color:#75af00">node</span><span style="color:#111">()</span> <span style="color:#f92672">*</span><span style="color:#75af00">node</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 确保光标栈长度大于0，否则抛出异常。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Assert</span><span style="color:#111">(</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">stack</span><span style="color:#111">)</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;accessing a node with a zero-length cursor stack&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 如果栈顶是叶子节点，直接返回该节点。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">ref</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">stack</span><span style="color:#111">[</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">stack</span><span style="color:#111">)</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">];</span> <span style="color:#75af00">ref</span><span style="color:#111">.</span><span style="color:#75af00">node</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">ref</span><span style="color:#111">.</span><span style="color:#75af00">isLeaf</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">ref</span><span style="color:#111">.</span><span style="color:#75af00">node</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 从根开始，向下遍历层级结构。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">var</span> <span style="color:#75af00">n</span> <span style="color:#111">=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">stack</span><span style="color:#111">[</span><span style="color:#ae81ff">0</span><span style="color:#111">].</span><span style="color:#75af00">node</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">n</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">n</span> <span style="color:#111">=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">bucket</span><span style="color:#111">.</span><span style="color:#75af00">node</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">stack</span><span style="color:#111">[</span><span style="color:#ae81ff">0</span><span style="color:#111">].</span><span style="color:#75af00">page</span><span style="color:#111">.</span><span style="color:#75af00">Id</span><span style="color:#111">(),</span> <span style="color:#00a8c8">nil</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">ref</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">stack</span><span style="color:#111">[:</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">stack</span><span style="color:#111">)</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">]</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Assert</span><span style="color:#111">(!</span><span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">isLeaf</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;expected branch node&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">n</span> <span style="color:#111">=</span> <span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">childAt</span><span style="color:#111">(</span><span style="color:#75af00">ref</span><span style="color:#111">.</span><span style="color:#75af00">index</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Assert</span><span style="color:#111">(</span><span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">isLeaf</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;expected leaf node&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#75af00">n</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// put方法在节点中插入键值对。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">n</span> <span style="color:#f92672">*</span><span style="color:#75af00">node</span><span style="color:#111">)</span> <span style="color:#75af00">put</span><span style="color:#111">(</span><span style="color:#75af00">oldKey</span><span style="color:#111">,</span> <span style="color:#75af00">newKey</span><span style="color:#111">,</span> <span style="color:#75af00">value</span> <span style="color:#111">[]</span><span style="color:#00a8c8">byte</span><span style="color:#111">,</span> <span style="color:#75af00">pgId</span> <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">,</span> <span style="color:#75af00">flags</span> <span style="color:#00a8c8">uint32</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 检查pgId是否超出限制。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">pgId</span> <span style="color:#f92672">&gt;=</span> <span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">bucket</span><span style="color:#111">.</span><span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">meta</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Sprintf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;pgId (%d) above high water mark (%d)&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">pgId</span><span style="color:#111">,</span> <span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">bucket</span><span style="color:#111">.</span><span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">meta</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">()))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#00a8c8">if</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">oldKey</span><span style="color:#111">)</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#d88200">&#34;put: zero-length old key&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#00a8c8">if</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">newKey</span><span style="color:#111">)</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#d88200">&#34;put: zero-length new key&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 寻找插入的位置。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">index</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">sort</span><span style="color:#111">.</span><span style="color:#75af00">Search</span><span style="color:#111">(</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">inodes</span><span style="color:#111">),</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">i</span> <span style="color:#00a8c8">int</span><span style="color:#111">)</span> <span style="color:#00a8c8">bool</span> <span style="color:#111">{</span> <span style="color:#00a8c8">return</span> <span style="color:#75af00">bytes</span><span style="color:#111">.</span><span style="color:#75af00">Compare</span><span style="color:#111">(</span><span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">inodes</span><span style="color:#111">[</span><span style="color:#75af00">i</span><span style="color:#111">].</span><span style="color:#75af00">Key</span><span style="color:#111">(),</span> <span style="color:#75af00">oldKey</span><span style="color:#111">)</span> <span style="color:#f92672">!=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> <span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 如果没有找到确切匹配，增加容量并移动节点。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">exact</span> <span style="color:#f92672">:=</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">inodes</span><span style="color:#111">)</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">index</span> <span style="color:#111">&lt;</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">inodes</span><span style="color:#111">)</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">bytes</span><span style="color:#111">.</span><span style="color:#75af00">Equal</span><span style="color:#111">(</span><span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">inodes</span><span style="color:#111">[</span><span style="color:#75af00">index</span><span style="color:#111">].</span><span style="color:#75af00">Key</span><span style="color:#111">(),</span> <span style="color:#75af00">oldKey</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">exact</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">inodes</span> <span style="color:#111">=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">inodes</span><span style="color:#111">,</span> <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Inode</span><span style="color:#111">{})</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">copy</span><span style="color:#111">(</span><span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">inodes</span><span style="color:#111">[</span><span style="color:#75af00">index</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span><span style="color:#111">:],</span> <span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">inodes</span><span style="color:#111">[</span><span style="color:#75af00">index</span><span style="color:#111">:])</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 设置inode的属性。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">inode</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">inodes</span><span style="color:#111">[</span><span style="color:#75af00">index</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">inode</span><span style="color:#111">.</span><span style="color:#75af00">SetFlags</span><span style="color:#111">(</span><span style="color:#75af00">flags</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">inode</span><span style="color:#111">.</span><span style="color:#75af00">SetKey</span><span style="color:#111">(</span><span style="color:#75af00">newKey</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">inode</span><span style="color:#111">.</span><span style="color:#75af00">SetValue</span><span style="color:#111">(</span><span style="color:#75af00">value</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">inode</span><span style="color:#111">.</span><span style="color:#75af00">SetPgid</span><span style="color:#111">(</span><span style="color:#75af00">pgId</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Assert</span><span style="color:#111">(</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">inode</span><span style="color:#111">.</span><span style="color:#75af00">Key</span><span style="color:#111">())</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;put: zero-length inode key&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Bucket方法通过名称检索嵌套桶。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 如果桶不存在，返回nil。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 返回的桶实例只在事务生命周期内有效。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">b</span> <span style="color:#f92672">*</span><span style="color:#75af00">Bucket</span><span style="color:#111">)</span> <span style="color:#75af00">Bucket</span><span style="color:#111">(</span><span style="color:#75af00">name</span> <span style="color:#111">[]</span><span style="color:#00a8c8">byte</span><span style="color:#111">)</span> <span style="color:#f92672">*</span><span style="color:#75af00">Bucket</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 如果已有桶缓存，则直接返回对应桶。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">buckets</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#75af00">child</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">buckets</span><span style="color:#111">[</span><span style="color:#111">string</span><span style="color:#111">(</span><span style="color:#75af00">name</span><span style="color:#111">)];</span> <span style="color:#75af00">child</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">return</span> <span style="color:#75af00">child</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 移动光标到键位置。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">c</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">Cursor</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">k</span><span style="color:#111">,</span> <span style="color:#75af00">v</span><span style="color:#111">,</span> <span style="color:#75af00">flags</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">seek</span><span style="color:#111">(</span><span style="color:#75af00">name</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 如果键不存在或者不是桶标志，则返回nil。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">bytes</span><span style="color:#111">.</span><span style="color:#75af00">Equal</span><span style="color:#111">(</span><span style="color:#75af00">name</span><span style="color:#111">,</span> <span style="color:#75af00">k</span><span style="color:#111">)</span> <span style="color:#f92672">||</span> <span style="color:#111">(</span><span style="color:#75af00">flags</span> <span style="color:#f92672">&amp;</span> <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">BucketLeafFlag</span><span style="color:#111">)</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 否则创建并缓存桶。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">var</span> <span style="color:#75af00">child</span> <span style="color:#111">=</span> <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">openBucket</span><span style="color:#111">(</span><span style="color:#75af00">v</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">buckets</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">buckets</span><span style="color:#111">[</span><span style="color:#111">string</span><span style="color:#111">(</span><span style="color:#75af00">name</span><span style="color:#111">)]</span> <span style="color:#111">=</span> <span style="color:#75af00">child</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#75af00">child</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="插入-keyvalue">插入 key/value</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">b</span> <span style="color:#f92672">*</span><span style="color:#75af00">Bucket</span><span style="color:#111">)</span> <span style="color:#75af00">Put</span><span style="color:#111">(</span><span style="color:#75af00">key</span> <span style="color:#111">[]</span><span style="color:#00a8c8">byte</span><span style="color:#111">,</span> <span style="color:#75af00">value</span> <span style="color:#111">[]</span><span style="color:#00a8c8">byte</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">lg</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">Logger</span><span style="color:#111">();</span> <span style="color:#75af00">lg</span> <span style="color:#f92672">!=</span> <span style="color:#75af00">discardLogger</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">lg</span><span style="color:#111">.</span><span style="color:#75af00">Debugf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Putting key %q&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">key</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">defer</span> <span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">lg</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Putting key %q failed: %v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">key</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">lg</span><span style="color:#111">.</span><span style="color:#75af00">Debugf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Putting key %q successfully&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">key</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">db</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">errors</span><span style="color:#111">.</span><span style="color:#75af00">ErrTxClosed</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">Writable</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">errors</span><span style="color:#111">.</span><span style="color:#75af00">ErrTxNotWritable</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#00a8c8">if</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">key</span><span style="color:#111">)</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">errors</span><span style="color:#111">.</span><span style="color:#75af00">ErrKeyRequired</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#00a8c8">if</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">key</span><span style="color:#111">)</span> <span style="color:#111">&gt;</span> <span style="color:#75af00">MaxKeySize</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">errors</span><span style="color:#111">.</span><span style="color:#75af00">ErrKeyTooLarge</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#00a8c8">if</span> <span style="color:#111">int64</span><span style="color:#111">(</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">value</span><span style="color:#111">))</span> <span style="color:#111">&gt;</span> <span style="color:#75af00">MaxValueSize</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">errors</span><span style="color:#111">.</span><span style="color:#75af00">ErrValueTooLarge</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">newKey</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">cloneBytes</span><span style="color:#111">(</span><span style="color:#75af00">key</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 移动光标到键位置。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">c</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">Cursor</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">k</span><span style="color:#111">,</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">flags</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">seek</span><span style="color:#111">(</span><span style="color:#75af00">newKey</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Return an error if there is an existing key with a bucket value.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">bytes</span><span style="color:#111">.</span><span style="color:#75af00">Equal</span><span style="color:#111">(</span><span style="color:#75af00">newKey</span><span style="color:#111">,</span> <span style="color:#75af00">k</span><span style="color:#111">)</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#111">(</span><span style="color:#75af00">flags</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">BucketLeafFlag</span><span style="color:#111">)</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">errors</span><span style="color:#111">.</span><span style="color:#75af00">ErrIncompatibleValue</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// gofail: var beforeBucketPut struct{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">node</span><span style="color:#111">().</span><span style="color:#75af00">put</span><span style="color:#111">(</span><span style="color:#75af00">newKey</span><span style="color:#111">,</span> <span style="color:#75af00">newKey</span><span style="color:#111">,</span> <span style="color:#75af00">value</span><span style="color:#111">,</span> <span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#ae81ff">0</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="事务">事务</h2>
<p>BoltDB 支持 ACID 事务，并采用了使用读写锁机制，支持多个读操作与一个写操作并发执行，让应用程序可以更简单的处理复杂操作。每个事务都有一个 txid，其中db.meta.txid 保存了最大的已提交的写事务 id。BoltDB 对写事务和读事务执行不同的 id 分配策略：</p>
<ol>
<li>读事务：txid == db.meta.txid；</li>
<li>写事务：txid == db.meta.txid + 1；</li>
<li>当写事务成功提交时，会更新了db.meta.txid为当前写事务 id。</li>
</ol>
<p>数据库初始化时会将页号为 0 和 1 的两个页面设置为meta页，每个事务会获得一个txid，并选取txid % 2的meta页做为该事务的读取对象，每次写数据后会交替更新meta页。当其中一个出现数据校验不一致时会使用另一个meta页。
BoltDB 的写操作都是在内存中进行，若事务未 commit 时出错，不会对数据库造成影响；若是在 commit 的过程中出错，BoltDB 写入文件的顺序也保证了不会造成影响：因为数据会写在新的 page 中不会覆盖原来的数据，且此时 meta中的信息不发生变化。</p>
<ol>
<li>开始一份写事务时，会拷贝一份 meta数据；</li>
<li>从 rootBucket 开始，遍历 B+ Tree 查找数据位置并修改；</li>
<li>修改操作完成后会进行事务 commit，此时会将数据写入新的 page；</li>
<li>最后更新meta的信息。</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// Tx 代表数据库上的一个只读或读写事务。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 只读事务可用于检索键值和创建光标。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 读写事务可以创建和删除桶以及创建和删除键。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// 重要：必须在使用完事务后提交或回滚事务。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 只有当没有事务在使用页面时，写入者才能回收这些页面。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 长时间运行的读事务可能会导致数据库迅速增长。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Tx</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">writable</span>       <span style="color:#00a8c8">bool</span>           <span style="color:#75715e">// 是否为可写事务</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">managed</span>        <span style="color:#00a8c8">bool</span>           <span style="color:#75715e">// 是否为管理事务</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">db</span>             <span style="color:#f92672">*</span><span style="color:#75af00">DB</span>            <span style="color:#75715e">// 关联的数据库实例</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">meta</span>           <span style="color:#f92672">*</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Meta</span>   <span style="color:#75715e">// 元数据指针</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">root</span>           <span style="color:#75af00">Bucket</span>         <span style="color:#75715e">// 根桶</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">pages</span>          <span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">]</span><span style="color:#f92672">*</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Page</span> <span style="color:#75715e">// 页面映射</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">stats</span>          <span style="color:#75af00">TxStats</span>        <span style="color:#75715e">// 事务统计</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">commitHandlers</span> <span style="color:#111">[]</span><span style="color:#00a8c8">func</span><span style="color:#111">()</span>       <span style="color:#75715e">// 提交处理程序列表</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// WriteFlag 指定写相关方法（如 WriteTo()）的标志。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Tx 使用指定的标志打开数据库文件以复制数据。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	// 默认情况下，此标志未设置，适合主要在内存中的工作负载。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 对于大于可用 RAM 的数据库，可以设置为 syscall.O_DIRECT 来避免淘汰页面缓存。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">WriteFlag</span> <span style="color:#00a8c8">int</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="begin">Begin</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// Begin 开始一个新事务。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 多个只读事务可以并发使用，但一次只能使用一个写事务。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 启动多个写事务会导致调用阻塞，并序列化直到当前写事务完成。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// 事务不应该彼此依赖。在同一个goroutine中打开一个读事务和一个写事务可能会导致写入者死锁，</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 因为数据库需要定期重新映射自身以应对增长，并且在读事务打开的时候无法进行。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// 如果需要长时间运行的读事务（例如，快照事务），你可能想要将DB.InitialMmapSize设置为足够大的值</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 以避免写事务的潜在阻塞。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// 重要：你必须在完成后关闭只读事务，否则数据库将无法回收旧页面。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">db</span> <span style="color:#f92672">*</span><span style="color:#75af00">DB</span><span style="color:#111">)</span> <span style="color:#75af00">Begin</span><span style="color:#111">(</span><span style="color:#75af00">writable</span> <span style="color:#00a8c8">bool</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#75af00">t</span> <span style="color:#f92672">*</span><span style="color:#75af00">Tx</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">lg</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">Logger</span><span style="color:#111">();</span> <span style="color:#75af00">lg</span> <span style="color:#f92672">!=</span> <span style="color:#75af00">discardLogger</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">lg</span><span style="color:#111">.</span><span style="color:#75af00">Debugf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Starting a new transaction [writable: %t]&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">writable</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">defer</span> <span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">lg</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Starting a new transaction [writable: %t] failed: %v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">writable</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">lg</span><span style="color:#111">.</span><span style="color:#75af00">Debugf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Starting a new transaction [writable: %t] successfully&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">writable</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">writable</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">beginRWTx</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">beginTx</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">db</span> <span style="color:#f92672">*</span><span style="color:#75af00">DB</span><span style="color:#111">)</span> <span style="color:#75af00">beginRWTx</span><span style="color:#111">()</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">Tx</span><span style="color:#111">,</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// If the database was opened with Options.ReadOnly, return an error.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">readOnly</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">berrors</span><span style="color:#111">.</span><span style="color:#75af00">ErrDatabaseReadOnly</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Obtain writer lock. This is released by the transaction when it closes.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// This enforces only one writer transaction at a time.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">rwlock</span><span style="color:#111">.</span><span style="color:#75af00">Lock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Once we have the writer lock then we can lock the meta pages so that</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// we can set up the transaction.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">metalock</span><span style="color:#111">.</span><span style="color:#75af00">Lock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">metalock</span><span style="color:#111">.</span><span style="color:#75af00">Unlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Exit if the database is not open yet.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">opened</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">rwlock</span><span style="color:#111">.</span><span style="color:#75af00">Unlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">berrors</span><span style="color:#111">.</span><span style="color:#75af00">ErrDatabaseNotOpen</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Exit if the database is not correctly mapped.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">data</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">rwlock</span><span style="color:#111">.</span><span style="color:#75af00">Unlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">berrors</span><span style="color:#111">.</span><span style="color:#75af00">ErrInvalidMapping</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Create a transaction associated with the database.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">t</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">Tx</span><span style="color:#111">{</span><span style="color:#75af00">writable</span><span style="color:#111">:</span> <span style="color:#00a8c8">true</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">init</span><span style="color:#111">(</span><span style="color:#75af00">db</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">rwtx</span> <span style="color:#111">=</span> <span style="color:#75af00">t</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">freePages</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">t</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// freePages 释放与已关闭的只读事务关联的任何页面。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">db</span> <span style="color:#f92672">*</span><span style="color:#75af00">DB</span><span style="color:#111">)</span> <span style="color:#75af00">freePages</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">sort</span><span style="color:#111">.</span><span style="color:#75af00">Sort</span><span style="color:#111">(</span><span style="color:#75af00">txsById</span><span style="color:#111">(</span><span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">txs</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">minid</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Txid</span><span style="color:#111">(</span><span style="color:#ae81ff">0xFFFFFFFFFFFFFFFF</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">txs</span><span style="color:#111">)</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">minid</span> <span style="color:#111">=</span> <span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">txs</span><span style="color:#111">[</span><span style="color:#ae81ff">0</span><span style="color:#111">].</span><span style="color:#75af00">meta</span><span style="color:#111">.</span><span style="color:#75af00">Txid</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">minid</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">freelist</span><span style="color:#111">.</span><span style="color:#75af00">release</span><span style="color:#111">(</span><span style="color:#75af00">minid</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">t</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">txs</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">freelist</span><span style="color:#111">.</span><span style="color:#75af00">releaseRange</span><span style="color:#111">(</span><span style="color:#75af00">minid</span><span style="color:#111">,</span> <span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">meta</span><span style="color:#111">.</span><span style="color:#75af00">Txid</span><span style="color:#111">()</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">minid</span> <span style="color:#111">=</span> <span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">meta</span><span style="color:#111">.</span><span style="color:#75af00">Txid</span><span style="color:#111">()</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">freelist</span><span style="color:#111">.</span><span style="color:#75af00">releaseRange</span><span style="color:#111">(</span><span style="color:#75af00">minid</span><span style="color:#111">,</span> <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Txid</span><span style="color:#111">(</span><span style="color:#ae81ff">0xFFFFFFFFFFFFFFFF</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">db</span> <span style="color:#f92672">*</span><span style="color:#75af00">DB</span><span style="color:#111">)</span> <span style="color:#75af00">beginTx</span><span style="color:#111">()</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">Tx</span><span style="color:#111">,</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Lock the meta pages while we initialize the transaction. We obtain</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// the meta lock before the mmap lock because that&#39;s the order that the</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// write transaction will obtain them.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">metalock</span><span style="color:#111">.</span><span style="color:#75af00">Lock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Obtain a read-only lock on the mmap. When the mmap is remapped it will</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// obtain a write lock so all transactions must finish before it can be</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// remapped.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">mmaplock</span><span style="color:#111">.</span><span style="color:#75af00">RLock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Exit if the database is not open yet.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">opened</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">mmaplock</span><span style="color:#111">.</span><span style="color:#75af00">RUnlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">metalock</span><span style="color:#111">.</span><span style="color:#75af00">Unlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">berrors</span><span style="color:#111">.</span><span style="color:#75af00">ErrDatabaseNotOpen</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Exit if the database is not correctly mapped.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">data</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">mmaplock</span><span style="color:#111">.</span><span style="color:#75af00">RUnlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">metalock</span><span style="color:#111">.</span><span style="color:#75af00">Unlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">berrors</span><span style="color:#111">.</span><span style="color:#75af00">ErrInvalidMapping</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Create a transaction associated with the database.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">t</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">Tx</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">init</span><span style="color:#111">(</span><span style="color:#75af00">db</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Keep track of transaction until it closes.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">txs</span> <span style="color:#111">=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">txs</span><span style="color:#111">,</span> <span style="color:#75af00">t</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">n</span> <span style="color:#f92672">:=</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">txs</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Unlock the meta pages.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">metalock</span><span style="color:#111">.</span><span style="color:#75af00">Unlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Update the transaction stats.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">statlock</span><span style="color:#111">.</span><span style="color:#75af00">Lock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">stats</span><span style="color:#111">.</span><span style="color:#75af00">TxN</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">stats</span><span style="color:#111">.</span><span style="color:#75af00">OpenTxN</span> <span style="color:#111">=</span> <span style="color:#75af00">n</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">statlock</span><span style="color:#111">.</span><span style="color:#75af00">Unlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">t</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="commit">Commit</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// Commit 将所有更改写入磁盘，更新元数据页，并关闭事务。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 如果磁盘写入发生错误，或者在只读事务上调用Commit，将返回错误。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">tx</span> <span style="color:#f92672">*</span><span style="color:#75af00">Tx</span><span style="color:#111">)</span> <span style="color:#75af00">Commit</span><span style="color:#111">()</span> <span style="color:#111">(</span><span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">txId</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">ID</span><span style="color:#111">()</span>  <span style="color:#75715e">// 获取事务ID</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">lg</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">Logger</span><span style="color:#111">()</span>  <span style="color:#75715e">// 获取日志记录器</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">lg</span> <span style="color:#f92672">!=</span> <span style="color:#75af00">discardLogger</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">lg</span><span style="color:#111">.</span><span style="color:#75af00">Debugf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Committing transaction %d&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">txId</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">defer</span> <span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75af00">lg</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Committing transaction failed: %v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75af00">lg</span><span style="color:#111">.</span><span style="color:#75af00">Debugf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Committing transaction %d successfully&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">txId</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 检查是否为管理事务，不允许提交。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Assert</span><span style="color:#111">(!</span><span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">managed</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;managed tx commit not allowed&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">db</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">berrors</span><span style="color:#111">.</span><span style="color:#75af00">ErrTxClosed</span>  <span style="color:#75715e">// 事务已关闭错误</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">writable</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">berrors</span><span style="color:#111">.</span><span style="color:#75af00">ErrTxNotWritable</span>  <span style="color:#75715e">// 非写事务错误</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// TODO: 使用向量化I/O写出脏页</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 重新平衡删除后的节点</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">var</span> <span style="color:#75af00">startTime</span> <span style="color:#111">=</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Now</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">root</span><span style="color:#111">.</span><span style="color:#75af00">rebalance</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">stats</span><span style="color:#111">.</span><span style="color:#75af00">GetRebalance</span><span style="color:#111">()</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">stats</span><span style="color:#111">.</span><span style="color:#75af00">IncRebalanceTime</span><span style="color:#111">(</span><span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Since</span><span style="color:#111">(</span><span style="color:#75af00">startTime</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">opgid</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">meta</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">()</span>  <span style="color:#75715e">// 获取旧的页面ID</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 将数据溢出到脏页</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">startTime</span> <span style="color:#111">=</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Now</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">root</span><span style="color:#111">.</span><span style="color:#75af00">spill</span><span style="color:#111">();</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">lg</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;spilling data onto dirty pages failed: %v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">rollback</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">stats</span><span style="color:#111">.</span><span style="color:#75af00">IncSpillTime</span><span style="color:#111">(</span><span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Since</span><span style="color:#111">(</span><span style="color:#75af00">startTime</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 释放旧的根桶</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">meta</span><span style="color:#111">.</span><span style="color:#75af00">RootBucket</span><span style="color:#111">().</span><span style="color:#75af00">SetRootPage</span><span style="color:#111">(</span><span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">root</span><span style="color:#111">.</span><span style="color:#75af00">RootPage</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 释放旧的自由列表，因为提交会写出一个新的自由列表</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">meta</span><span style="color:#111">.</span><span style="color:#75af00">Freelist</span><span style="color:#111">()</span> <span style="color:#f92672">!=</span> <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">PgidNoFreelist</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">freelist</span><span style="color:#111">.</span><span style="color:#75af00">free</span><span style="color:#111">(</span><span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">meta</span><span style="color:#111">.</span><span style="color:#75af00">Txid</span><span style="color:#111">(),</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">page</span><span style="color:#111">(</span><span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">meta</span><span style="color:#111">.</span><span style="color:#75af00">Freelist</span><span style="color:#111">()))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">NoFreelistSync</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">commitFreelist</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75af00">lg</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;committing freelist failed: %v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">meta</span><span style="color:#111">.</span><span style="color:#75af00">SetFreelist</span><span style="color:#111">(</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">PgidNoFreelist</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 如果高水位标记已上移，则尝试扩大数据库</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">meta</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">()</span> <span style="color:#111">&gt;</span> <span style="color:#75af00">opgid</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">grow</span><span style="color:#111">(</span><span style="color:#111">int</span><span style="color:#111">(</span><span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">meta</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">()</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span> <span style="color:#f92672">*</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">pageSize</span><span style="color:#111">);</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75af00">lg</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;growing db size failed, pgid: %d, pagesize: %d, error: %v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">meta</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">(),</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">pageSize</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">rollback</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 将脏页写入磁盘</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">startTime</span> <span style="color:#111">=</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Now</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">write</span><span style="color:#111">();</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">lg</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;writing data failed: %v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">rollback</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 如果启用了严格模式，则执行一致性检查</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">StrictMode</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">ch</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">Check</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">var</span> <span style="color:#75af00">errs</span> <span style="color:#111">[]</span><span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">for</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75af00">chkErr</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#75af00">ch</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#00a8c8">break</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75af00">errs</span> <span style="color:#111">=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">errs</span><span style="color:#111">,</span> <span style="color:#75af00">chkErr</span><span style="color:#111">.</span><span style="color:#75af00">Error</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">errs</span><span style="color:#111">)</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#d88200">&#34;check fail: &#34;</span> <span style="color:#f92672">+</span> <span style="color:#75af00">strings</span><span style="color:#111">.</span><span style="color:#75af00">Join</span><span style="color:#111">(</span><span style="color:#75af00">errs</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;\n&#34;</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 将元数据写入磁盘</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">writeMeta</span><span style="color:#111">();</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">lg</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;writeMeta failed: %v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">rollback</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">stats</span><span style="color:#111">.</span><span style="color:#75af00">IncWriteTime</span><span style="color:#111">(</span><span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Since</span><span style="color:#111">(</span><span style="color:#75af00">startTime</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 结束事务</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#111">close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 执行提交处理程序，锁已经移除</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">fn</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">commitHandlers</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">fn</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="rollback">Rollback</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// Rollback 关闭事务并忽略所有之前的更新。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 只读事务必须回滚而不是提交。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">tx</span> <span style="color:#f92672">*</span><span style="color:#75af00">Tx</span><span style="color:#111">)</span> <span style="color:#75af00">Rollback</span><span style="color:#111">()</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Assert</span><span style="color:#111">(!</span><span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">managed</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;managed tx rollback not allowed&#34;</span><span style="color:#111">)</span>  <span style="color:#75715e">// 断言此事务不是管理型事务</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">db</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">berrors</span><span style="color:#111">.</span><span style="color:#75af00">ErrTxClosed</span>  <span style="color:#75715e">// 如果数据库已关闭，返回错误</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">nonPhysicalRollback</span><span style="color:#111">()</span>  <span style="color:#75715e">// 执行非物理性回滚</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// nonPhysicalRollback 在用户直接调用Rollback时被调用，在这种情况下，我们不需要从磁盘重新加载自由页面。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">tx</span> <span style="color:#f92672">*</span><span style="color:#75af00">Tx</span><span style="color:#111">)</span> <span style="color:#75af00">nonPhysicalRollback</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">db</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span>  <span style="color:#75715e">// 如果数据库已关闭，直接返回</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">writable</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">freelist</span><span style="color:#111">.</span><span style="color:#75af00">rollback</span><span style="color:#111">(</span><span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">meta</span><span style="color:#111">.</span><span style="color:#75af00">Txid</span><span style="color:#111">())</span>  <span style="color:#75715e">// 如果事务是可写的，回滚自由列表</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#111">close</span><span style="color:#111">()</span>  <span style="color:#75715e">// 关闭事务</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// rollback 从给定的挂起事务中移除页面。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">f</span> <span style="color:#f92672">*</span><span style="color:#75af00">freelist</span><span style="color:#111">)</span> <span style="color:#75af00">rollback</span><span style="color:#111">(</span><span style="color:#75af00">txid</span> <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Txid</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 从缓存中移除页面ID。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">txp</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">pending</span><span style="color:#111">[</span><span style="color:#75af00">txid</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">txp</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span>  <span style="color:#75715e">// 如果没有挂起的事务，直接返回</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">var</span> <span style="color:#75af00">m</span> <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgids</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">for</span> <span style="color:#75af00">i</span><span style="color:#111">,</span> <span style="color:#75af00">pgid</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">txp</span><span style="color:#111">.</span><span style="color:#75af00">ids</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">delete</span><span style="color:#111">(</span><span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">cache</span><span style="color:#111">,</span> <span style="color:#75af00">pgid</span><span style="color:#111">)</span>  <span style="color:#75715e">// 从缓存中删除页面ID</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">tx</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">txp</span><span style="color:#111">.</span><span style="color:#75af00">alloctx</span><span style="color:#111">[</span><span style="color:#75af00">i</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#75af00">tx</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">continue</span>  <span style="color:#75715e">// 如果未分配事务ID，继续下一个</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#75af00">tx</span> <span style="color:#f92672">!=</span> <span style="color:#75af00">txid</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 如果待释放页面被中断，恢复页面回分配列表。</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">allocs</span><span style="color:#111">[</span><span style="color:#75af00">pgid</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#75af00">tx</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 如果释放的页面由此事务分配，可以安全地丢弃。</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75af00">m</span> <span style="color:#111">=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">m</span><span style="color:#111">,</span> <span style="color:#75af00">pgid</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 从挂起列表中移除页面，并将其标记为由txid分配的自由页面。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">delete</span><span style="color:#111">(</span><span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">pending</span><span style="color:#111">,</span> <span style="color:#75af00">txid</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">mergeSpans</span><span style="color:#111">(</span><span style="color:#75af00">m</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="view--update">View &amp;&amp; Update</h2>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// View 在管理的只读事务上下文中执行一个函数。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 从函数返回的任何错误都会从View()方法返回。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// 尝试在函数内手动回滚会导致panic。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">db</span> <span style="color:#f92672">*</span><span style="color:#75af00">DB</span><span style="color:#111">)</span> <span style="color:#75af00">View</span><span style="color:#111">(</span><span style="color:#75af00">fn</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">Tx</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">t</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">Begin</span><span style="color:#111">(</span><span style="color:#00a8c8">false</span><span style="color:#111">)</span>  <span style="color:#75715e">// 开始一个只读事务</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>  <span style="color:#75715e">// 如果无法开始事务，返回错误</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 确保在发生panic的情况下事务能够回滚。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">defer</span> <span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">db</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">rollback</span><span style="color:#111">()</span>  <span style="color:#75715e">// 执行回滚操作</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 标记为管理的事务，以便内部函数不能手动回滚。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">managed</span> <span style="color:#111">=</span> <span style="color:#00a8c8">true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 如果函数返回错误，则传递该错误。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">fn</span><span style="color:#111">(</span><span style="color:#75af00">t</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">managed</span> <span style="color:#111">=</span> <span style="color:#00a8c8">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">_</span> <span style="color:#111">=</span> <span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">Rollback</span><span style="color:#111">()</span>  <span style="color:#75715e">// 执行回滚</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">Rollback</span><span style="color:#111">()</span>  <span style="color:#75715e">// 完成后回滚事务</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Update 在读写管理事务的上下文中执行一个函数。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 如果函数没有返回错误，则提交事务。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 如果返回了错误，则整个事务被回滚。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 从函数返回的任何错误或从提交返回的错误都会从Update()方法返回。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// 尝试在函数内手动提交或回滚将导致panic。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">db</span> <span style="color:#f92672">*</span><span style="color:#75af00">DB</span><span style="color:#111">)</span> <span style="color:#75af00">Update</span><span style="color:#111">(</span><span style="color:#75af00">fn</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">Tx</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">t</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">Begin</span><span style="color:#111">(</span><span style="color:#00a8c8">true</span><span style="color:#111">)</span>  <span style="color:#75715e">// 开始一个读写事务</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>  <span style="color:#75715e">// 如果无法开始事务，返回错误</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 确保在发生panic的情况下事务能够回滚。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">defer</span> <span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">db</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">rollback</span><span style="color:#111">()</span>  <span style="color:#75715e">// 执行回滚操作</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 标记为管理的事务，以便内部函数不能手动提交。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">managed</span> <span style="color:#111">=</span> <span style="color:#00a8c8">true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 如果函数返回错误，则回滚并返回错误。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">fn</span><span style="color:#111">(</span><span style="color:#75af00">t</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">managed</span> <span style="color:#111">=</span> <span style="color:#00a8c8">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">_</span> <span style="color:#111">=</span> <span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">Rollback</span><span style="color:#111">()</span>  <span style="color:#75715e">// 执行回滚</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">Commit</span><span style="color:#111">()</span>  <span style="color:#75715e">// 无错误时提交事务</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="reference">Reference</h2>
<ul>
<li><a href="https://wingsxdu.com/posts/database/boltdb/">https://wingsxdu.com/posts/database/boltdb/</a></li>
<li><a href="https://jaydenwen123.github.io/boltdb/">https://jaydenwen123.github.io/boltdb/</a></li>
<li><a href="https://youjiali1995.github.io/storage/boltdb/">https://youjiali1995.github.io/storage/boltdb/</a></li>
<li><a href="https://www.cnblogs.com/huxiao-tee/p/4660352.html">https://www.cnblogs.com/huxiao-tee/p/4660352.html</a></li>
</ul>
]]></content:encoded><category>cloud</category><category>boltdb</category><category>etcd</category><category>golang</category><category>数据库</category><category>kubernetes</category><category>源码分析</category><category>事务</category></item><item><title>etcd watch 实现原理</title><link>https://daemon365.dev/post/cloud/etcd_watch_implementation_principle/</link><pubDate>Mon, 10 Jun 2024 14:16:00 +0800</pubDate><guid>https://daemon365.dev/post/cloud/etcd_watch_implementation_principle/</guid><description>&lt;h2 id="介绍"&gt;介绍&lt;/h2&gt;
&lt;p&gt;在 etcd 中，watch 是一个非常重要的特性，它可以让客户端监控 etcd 中的 key 或者一组 key，当 key 发生变化时，etcd 会通知客户端。本文将介绍 etcd watch 的实现原理。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-BASH" data-lang="BASH"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;etcdctl watch /test
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;# 当 /test 的值发生变化时，会输出如下信息&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;PUT
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;/test
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;a
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;PUT
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;/test
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;b
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;DELETE
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;/test
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id="watch-的-api"&gt;watch 的 api&lt;/h2&gt;
&lt;p&gt;etcd watch api 是由 grpc stream 实现的，客户端通过 grpc stream 发送 watch 请求，etcd 会将 key 的变化通过 stream 返回给客户端。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-protobuf" data-lang="protobuf"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;rpc&lt;/span&gt; &lt;span style="color:#111"&gt;Watch&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#111"&gt;stream&lt;/span&gt; &lt;span style="color:#111"&gt;WatchRequest&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;returns&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#111"&gt;stream&lt;/span&gt; &lt;span style="color:#111"&gt;WatchResponse&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;option&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#111"&gt;google.api.http&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#f92672"&gt;=&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt; &lt;span style="color:#111"&gt;post&lt;/span&gt;&lt;span style="color:#f92672"&gt;:&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;/v3/watch&amp;#34;&lt;/span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt; &lt;span style="color:#111"&gt;body&lt;/span&gt;&lt;span style="color:#f92672"&gt;:&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;*&amp;#34;&lt;/span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt; &lt;span style="color:#111"&gt;};&lt;/span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id="api-实现"&gt;api 实现&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;ws&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;watchServer&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75af00"&gt;Watch&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;stream&lt;/span&gt; &lt;span style="color:#75af00"&gt;pb&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Watch_WatchServer&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;error&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;sws&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;serverWatchStream&lt;/span&gt;&lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;lg&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#75af00"&gt;ws&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;lg&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;clusterID&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#75af00"&gt;ws&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;clusterID&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;memberID&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#75af00"&gt;ws&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;memberID&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;maxRequestBytes&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#75af00"&gt;ws&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;maxRequestBytes&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;sg&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#75af00"&gt;ws&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;sg&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;watchable&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#75af00"&gt;ws&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;watchable&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;ag&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#75af00"&gt;ws&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;ag&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;gRPCStream&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#75af00"&gt;stream&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;watchStream&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#75af00"&gt;ws&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;watchable&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;NewWatchStream&lt;/span&gt;&lt;span style="color:#111"&gt;(),&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// chan for sending control response like watcher created and canceled.&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;ctrlStream&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#111"&gt;make&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;chan&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;pb&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;WatchResponse&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;ctrlStreamBufLen&lt;/span&gt;&lt;span style="color:#111"&gt;),&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;progress&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#111"&gt;make&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;map&lt;/span&gt;&lt;span style="color:#111"&gt;[&lt;/span&gt;&lt;span style="color:#75af00"&gt;mvcc&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;WatchID&lt;/span&gt;&lt;span style="color:#111"&gt;]&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;bool&lt;/span&gt;&lt;span style="color:#111"&gt;),&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;prevKV&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#111"&gt;make&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;map&lt;/span&gt;&lt;span style="color:#111"&gt;[&lt;/span&gt;&lt;span style="color:#75af00"&gt;mvcc&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;WatchID&lt;/span&gt;&lt;span style="color:#111"&gt;]&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;bool&lt;/span&gt;&lt;span style="color:#111"&gt;),&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fragment&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#111"&gt;make&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;map&lt;/span&gt;&lt;span style="color:#111"&gt;[&lt;/span&gt;&lt;span style="color:#75af00"&gt;mvcc&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;WatchID&lt;/span&gt;&lt;span style="color:#111"&gt;]&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;bool&lt;/span&gt;&lt;span style="color:#111"&gt;),&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;closec&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#111"&gt;make&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;chan&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;struct&lt;/span&gt;&lt;span style="color:#111"&gt;{}),&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;sws&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;wg&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Add&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;1&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;go&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;func&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// 开启一个 goroutine 处理新的 event 然后发送给客户端&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;sws&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;sendLoop&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;sws&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;wg&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Done&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;errc&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#111"&gt;make&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;chan&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;error&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;1&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;go&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;func&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// 开启一个 goroutine 处理客户端发送的 watch 请求&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;rerr&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;sws&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;recvLoop&lt;/span&gt;&lt;span style="color:#111"&gt;();&lt;/span&gt; &lt;span style="color:#75af00"&gt;rerr&lt;/span&gt; &lt;span style="color:#f92672"&gt;!=&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;isClientCtxErr&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;stream&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Context&lt;/span&gt;&lt;span style="color:#111"&gt;().&lt;/span&gt;&lt;span style="color:#75af00"&gt;Err&lt;/span&gt;&lt;span style="color:#111"&gt;(),&lt;/span&gt; &lt;span style="color:#75af00"&gt;rerr&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;sws&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;lg&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Debug&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;failed to receive watch request from gRPC stream&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;zap&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Error&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;rerr&lt;/span&gt;&lt;span style="color:#111"&gt;))&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;else&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;sws&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;lg&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Warn&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;failed to receive watch request from gRPC stream&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;zap&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Error&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;rerr&lt;/span&gt;&lt;span style="color:#111"&gt;))&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;streamFailures&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;WithLabelValues&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;receive&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;watch&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;).&lt;/span&gt;&lt;span style="color:#75af00"&gt;Inc&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;errc&lt;/span&gt; &lt;span style="color:#f92672"&gt;&amp;lt;-&lt;/span&gt; &lt;span style="color:#75af00"&gt;rerr&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// 处理结束&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;select&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;case&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#f92672"&gt;&amp;lt;-&lt;/span&gt;&lt;span style="color:#75af00"&gt;errc&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;==&lt;/span&gt; &lt;span style="color:#75af00"&gt;context&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Canceled&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#75af00"&gt;rpctypes&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;ErrGRPCWatchCanceled&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;close&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;sws&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;ctrlStream&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;case&lt;/span&gt; &lt;span style="color:#f92672"&gt;&amp;lt;-&lt;/span&gt;&lt;span style="color:#75af00"&gt;stream&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Context&lt;/span&gt;&lt;span style="color:#111"&gt;().&lt;/span&gt;&lt;span style="color:#75af00"&gt;Done&lt;/span&gt;&lt;span style="color:#111"&gt;():&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#75af00"&gt;stream&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Context&lt;/span&gt;&lt;span style="color:#111"&gt;().&lt;/span&gt;&lt;span style="color:#75af00"&gt;Err&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;==&lt;/span&gt; &lt;span style="color:#75af00"&gt;context&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Canceled&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#75af00"&gt;rpctypes&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;ErrGRPCWatchCanceled&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;sws&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#111"&gt;close&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;这里 主要的逻辑是开启两个 goroutine，一个用于处理客户端发送的 watch 请求，另一个用于处理新的 event 然后发送给客户端。&lt;/p&gt;</description><content:encoded><![CDATA[<h2 id="介绍">介绍</h2>
<p>在 etcd 中，watch 是一个非常重要的特性，它可以让客户端监控 etcd 中的 key 或者一组 key，当 key 发生变化时，etcd 会通知客户端。本文将介绍 etcd watch 的实现原理。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-BASH" data-lang="BASH"><span style="display:flex;"><span>etcdctl watch /test
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 当 /test 的值发生变化时，会输出如下信息</span>
</span></span><span style="display:flex;"><span>PUT
</span></span><span style="display:flex;"><span>/test
</span></span><span style="display:flex;"><span>a
</span></span><span style="display:flex;"><span>PUT
</span></span><span style="display:flex;"><span>/test
</span></span><span style="display:flex;"><span>b
</span></span><span style="display:flex;"><span>DELETE
</span></span><span style="display:flex;"><span>/test
</span></span></code></pre></div><h2 id="watch-的-api">watch 的 api</h2>
<p>etcd watch api 是由 grpc stream 实现的，客户端通过 grpc stream 发送 watch 请求，etcd 会将 key 的变化通过 stream 返回给客户端。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-protobuf" data-lang="protobuf"><span style="display:flex;"><span><span style="color:#00a8c8">rpc</span> <span style="color:#111">Watch</span><span style="color:#111">(</span><span style="color:#111">stream</span> <span style="color:#111">WatchRequest</span><span style="color:#111">)</span> <span style="color:#00a8c8">returns</span> <span style="color:#111">(</span><span style="color:#111">stream</span> <span style="color:#111">WatchResponse</span><span style="color:#111">)</span> <span style="color:#111">{</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>      <span style="color:#00a8c8">option</span> <span style="color:#111">(</span><span style="color:#111">google.api.http</span><span style="color:#111">)</span> <span style="color:#f92672">=</span> <span style="color:#111">{</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>        <span style="color:#111">post</span><span style="color:#f92672">:</span> <span style="color:#d88200">&#34;/v3/watch&#34;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>        <span style="color:#111">body</span><span style="color:#f92672">:</span> <span style="color:#d88200">&#34;*&#34;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    <span style="color:#111">};</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#111">}</span><span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><h2 id="api-实现">api 实现</h2>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">ws</span> <span style="color:#f92672">*</span><span style="color:#75af00">watchServer</span><span style="color:#111">)</span> <span style="color:#75af00">Watch</span><span style="color:#111">(</span><span style="color:#75af00">stream</span> <span style="color:#75af00">pb</span><span style="color:#111">.</span><span style="color:#75af00">Watch_WatchServer</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">sws</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">serverWatchStream</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">lg</span><span style="color:#111">:</span> <span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">lg</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">clusterID</span><span style="color:#111">:</span> <span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">clusterID</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">memberID</span><span style="color:#111">:</span>  <span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">memberID</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">maxRequestBytes</span><span style="color:#111">:</span> <span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">maxRequestBytes</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">sg</span><span style="color:#111">:</span>        <span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">sg</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">watchable</span><span style="color:#111">:</span> <span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">watchable</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">ag</span><span style="color:#111">:</span>        <span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">ag</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">gRPCStream</span><span style="color:#111">:</span>  <span style="color:#75af00">stream</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">watchStream</span><span style="color:#111">:</span> <span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">watchable</span><span style="color:#111">.</span><span style="color:#75af00">NewWatchStream</span><span style="color:#111">(),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// chan for sending control response like watcher created and canceled.</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">ctrlStream</span><span style="color:#111">:</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">chan</span> <span style="color:#f92672">*</span><span style="color:#75af00">pb</span><span style="color:#111">.</span><span style="color:#75af00">WatchResponse</span><span style="color:#111">,</span> <span style="color:#75af00">ctrlStreamBufLen</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">progress</span><span style="color:#111">:</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#75af00">mvcc</span><span style="color:#111">.</span><span style="color:#75af00">WatchID</span><span style="color:#111">]</span><span style="color:#00a8c8">bool</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">prevKV</span><span style="color:#111">:</span>   <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#75af00">mvcc</span><span style="color:#111">.</span><span style="color:#75af00">WatchID</span><span style="color:#111">]</span><span style="color:#00a8c8">bool</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fragment</span><span style="color:#111">:</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#75af00">mvcc</span><span style="color:#111">.</span><span style="color:#75af00">WatchID</span><span style="color:#111">]</span><span style="color:#00a8c8">bool</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">closec</span><span style="color:#111">:</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">chan</span> <span style="color:#00a8c8">struct</span><span style="color:#111">{}),</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">wg</span><span style="color:#111">.</span><span style="color:#75af00">Add</span><span style="color:#111">(</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">go</span> <span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 开启一个 goroutine 处理新的 event 然后发送给客户端</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">sendLoop</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">wg</span><span style="color:#111">.</span><span style="color:#75af00">Done</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">errc</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">chan</span> <span style="color:#00a8c8">error</span><span style="color:#111">,</span> <span style="color:#ae81ff">1</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">go</span> <span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 开启一个 goroutine 处理客户端发送的 watch 请求</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">rerr</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">recvLoop</span><span style="color:#111">();</span> <span style="color:#75af00">rerr</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">isClientCtxErr</span><span style="color:#111">(</span><span style="color:#75af00">stream</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">().</span><span style="color:#75af00">Err</span><span style="color:#111">(),</span> <span style="color:#75af00">rerr</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">lg</span><span style="color:#111">.</span><span style="color:#75af00">Debug</span><span style="color:#111">(</span><span style="color:#d88200">&#34;failed to receive watch request from gRPC stream&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">Error</span><span style="color:#111">(</span><span style="color:#75af00">rerr</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">lg</span><span style="color:#111">.</span><span style="color:#75af00">Warn</span><span style="color:#111">(</span><span style="color:#d88200">&#34;failed to receive watch request from gRPC stream&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">Error</span><span style="color:#111">(</span><span style="color:#75af00">rerr</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">streamFailures</span><span style="color:#111">.</span><span style="color:#75af00">WithLabelValues</span><span style="color:#111">(</span><span style="color:#d88200">&#34;receive&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;watch&#34;</span><span style="color:#111">).</span><span style="color:#75af00">Inc</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">errc</span> <span style="color:#f92672">&lt;-</span> <span style="color:#75af00">rerr</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 处理结束</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">select</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">case</span> <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#f92672">&lt;-</span><span style="color:#75af00">errc</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">==</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Canceled</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">rpctypes</span><span style="color:#111">.</span><span style="color:#75af00">ErrGRPCWatchCanceled</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">close</span><span style="color:#111">(</span><span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">ctrlStream</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#75af00">stream</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">().</span><span style="color:#75af00">Done</span><span style="color:#111">():</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">stream</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">().</span><span style="color:#75af00">Err</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">==</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Canceled</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">rpctypes</span><span style="color:#111">.</span><span style="color:#75af00">ErrGRPCWatchCanceled</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#111">close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>这里 主要的逻辑是开启两个 goroutine，一个用于处理客户端发送的 watch 请求，另一个用于处理新的 event 然后发送给客户端。</p>
<h3 id="sendloop">sendLoop</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">sws</span> <span style="color:#f92672">*</span><span style="color:#75af00">serverWatchStream</span><span style="color:#111">)</span> <span style="color:#75af00">sendLoop</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// watch ids that are currently active</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ids</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#75af00">mvcc</span><span style="color:#111">.</span><span style="color:#75af00">WatchID</span><span style="color:#111">]</span><span style="color:#00a8c8">struct</span><span style="color:#111">{})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// watch responses pending on a watch id creation message</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">pending</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#75af00">mvcc</span><span style="color:#111">.</span><span style="color:#75af00">WatchID</span><span style="color:#111">][]</span><span style="color:#f92672">*</span><span style="color:#75af00">pb</span><span style="color:#111">.</span><span style="color:#75af00">WatchResponse</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">interval</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">GetProgressReportInterval</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">progressTicker</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">NewTicker</span><span style="color:#111">(</span><span style="color:#75af00">interval</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">progressTicker</span><span style="color:#111">.</span><span style="color:#75af00">Stop</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 清空chan ，清理待处理 event</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">for</span> <span style="color:#75af00">ws</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">watchStream</span><span style="color:#111">.</span><span style="color:#75af00">Chan</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">mvcc</span><span style="color:#111">.</span><span style="color:#75af00">ReportEventReceived</span><span style="color:#111">(</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">Events</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">wrs</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">pending</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">ws</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">wrs</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">mvcc</span><span style="color:#111">.</span><span style="color:#75af00">ReportEventReceived</span><span style="color:#111">(</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">Events</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">select</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">case</span> <span style="color:#75af00">wresp</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">watchStream</span><span style="color:#111">.</span><span style="color:#75af00">Chan</span><span style="color:#111">():</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 从 watchStream.Chan() 中获取 event</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 然后发送给客户端 </span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">evs</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">wresp</span><span style="color:#111">.</span><span style="color:#75af00">Events</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">events</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">([]</span><span style="color:#f92672">*</span><span style="color:#75af00">mvccpb</span><span style="color:#111">.</span><span style="color:#75af00">Event</span><span style="color:#111">,</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">evs</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">RLock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">needPrevKV</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">prevKV</span><span style="color:#111">[</span><span style="color:#75af00">wresp</span><span style="color:#111">.</span><span style="color:#75af00">WatchID</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">RUnlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">for</span> <span style="color:#75af00">i</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">evs</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">events</span><span style="color:#111">[</span><span style="color:#75af00">i</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">evs</span><span style="color:#111">[</span><span style="color:#75af00">i</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">if</span> <span style="color:#75af00">needPrevKV</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#111">!</span><span style="color:#75af00">IsCreateEvent</span><span style="color:#111">(</span><span style="color:#75af00">evs</span><span style="color:#111">[</span><span style="color:#75af00">i</span><span style="color:#111">])</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">opt</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">mvcc</span><span style="color:#111">.</span><span style="color:#75af00">RangeOptions</span><span style="color:#111">{</span><span style="color:#75af00">Rev</span><span style="color:#111">:</span> <span style="color:#75af00">evs</span><span style="color:#111">[</span><span style="color:#75af00">i</span><span style="color:#111">].</span><span style="color:#75af00">Kv</span><span style="color:#111">.</span><span style="color:#75af00">ModRevision</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">r</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">watchable</span><span style="color:#111">.</span><span style="color:#75af00">Range</span><span style="color:#111">(</span><span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">TODO</span><span style="color:#111">(),</span> <span style="color:#75af00">evs</span><span style="color:#111">[</span><span style="color:#75af00">i</span><span style="color:#111">].</span><span style="color:#75af00">Kv</span><span style="color:#111">.</span><span style="color:#75af00">Key</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">opt</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>					<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">KVs</span><span style="color:#111">)</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>						<span style="color:#75af00">events</span><span style="color:#111">[</span><span style="color:#75af00">i</span><span style="color:#111">].</span><span style="color:#75af00">PrevKv</span> <span style="color:#111">=</span> <span style="color:#f92672">&amp;</span><span style="color:#111">(</span><span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">KVs</span><span style="color:#111">[</span><span style="color:#ae81ff">0</span><span style="color:#111">])</span>
</span></span><span style="display:flex;"><span>					<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>				<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">canceled</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">wresp</span><span style="color:#111">.</span><span style="color:#75af00">CompactRevision</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">wr</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">pb</span><span style="color:#111">.</span><span style="color:#75af00">WatchResponse</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">Header</span><span style="color:#111">:</span>          <span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">newResponseHeader</span><span style="color:#111">(</span><span style="color:#75af00">wresp</span><span style="color:#111">.</span><span style="color:#75af00">Revision</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">WatchId</span><span style="color:#111">:</span>         <span style="color:#111">int64</span><span style="color:#111">(</span><span style="color:#75af00">wresp</span><span style="color:#111">.</span><span style="color:#75af00">WatchID</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">Events</span><span style="color:#111">:</span>          <span style="color:#75af00">events</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">CompactRevision</span><span style="color:#111">:</span> <span style="color:#75af00">wresp</span><span style="color:#111">.</span><span style="color:#75af00">CompactRevision</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">Canceled</span><span style="color:#111">:</span>        <span style="color:#75af00">canceled</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// Progress notifications can have WatchID -1</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// if they announce on behalf of multiple watchers</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">wresp</span><span style="color:#111">.</span><span style="color:#75af00">WatchID</span> <span style="color:#f92672">!=</span> <span style="color:#75af00">clientv3</span><span style="color:#111">.</span><span style="color:#75af00">InvalidWatchID</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">if</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">okID</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">ids</span><span style="color:#111">[</span><span style="color:#75af00">wresp</span><span style="color:#111">.</span><span style="color:#75af00">WatchID</span><span style="color:#111">];</span> <span style="color:#111">!</span><span style="color:#75af00">okID</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75715e">// buffer if id not yet announced</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">wrs</span> <span style="color:#f92672">:=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">pending</span><span style="color:#111">[</span><span style="color:#75af00">wresp</span><span style="color:#111">.</span><span style="color:#75af00">WatchID</span><span style="color:#111">],</span> <span style="color:#75af00">wr</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">pending</span><span style="color:#111">[</span><span style="color:#75af00">wresp</span><span style="color:#111">.</span><span style="color:#75af00">WatchID</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#75af00">wrs</span>
</span></span><span style="display:flex;"><span>					<span style="color:#00a8c8">continue</span>
</span></span><span style="display:flex;"><span>				<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">mvcc</span><span style="color:#111">.</span><span style="color:#75af00">ReportEventReceived</span><span style="color:#111">(</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">evs</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">RLock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">fragmented</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">fragment</span><span style="color:#111">[</span><span style="color:#75af00">wresp</span><span style="color:#111">.</span><span style="color:#75af00">WatchID</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">RUnlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">var</span> <span style="color:#75af00">serr</span> <span style="color:#00a8c8">error</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// gofail: var beforeSendWatchResponse struct{}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">fragmented</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#111">!</span><span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">serr</span> <span style="color:#111">=</span> <span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">gRPCStream</span><span style="color:#111">.</span><span style="color:#75af00">Send</span><span style="color:#111">(</span><span style="color:#75af00">wr</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">serr</span> <span style="color:#111">=</span> <span style="color:#75af00">sendFragments</span><span style="color:#111">(</span><span style="color:#75af00">wr</span><span style="color:#111">,</span> <span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">maxRequestBytes</span><span style="color:#111">,</span> <span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">gRPCStream</span><span style="color:#111">.</span><span style="color:#75af00">Send</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">serr</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">if</span> <span style="color:#75af00">isClientCtxErr</span><span style="color:#111">(</span><span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">gRPCStream</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">().</span><span style="color:#75af00">Err</span><span style="color:#111">(),</span> <span style="color:#75af00">serr</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">lg</span><span style="color:#111">.</span><span style="color:#75af00">Debug</span><span style="color:#111">(</span><span style="color:#d88200">&#34;failed to send watch response to gRPC stream&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">Error</span><span style="color:#111">(</span><span style="color:#75af00">serr</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>				<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">lg</span><span style="color:#111">.</span><span style="color:#75af00">Warn</span><span style="color:#111">(</span><span style="color:#d88200">&#34;failed to send watch response to gRPC stream&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">Error</span><span style="color:#111">(</span><span style="color:#75af00">serr</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">streamFailures</span><span style="color:#111">.</span><span style="color:#75af00">WithLabelValues</span><span style="color:#111">(</span><span style="color:#d88200">&#34;send&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;watch&#34;</span><span style="color:#111">).</span><span style="color:#75af00">Inc</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>				<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">Lock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">evs</span><span style="color:#111">)</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">progress</span><span style="color:#111">[</span><span style="color:#75af00">wresp</span><span style="color:#111">.</span><span style="color:#75af00">WatchID</span><span style="color:#111">]</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// elide next progress update if sent a key update</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">progress</span><span style="color:#111">[</span><span style="color:#75af00">wresp</span><span style="color:#111">.</span><span style="color:#75af00">WatchID</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#00a8c8">false</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">Unlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">case</span> <span style="color:#75af00">c</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">ctrlStream</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 处理客户端发送的 watch 请求</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">gRPCStream</span><span style="color:#111">.</span><span style="color:#75af00">Send</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">);</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">if</span> <span style="color:#75af00">isClientCtxErr</span><span style="color:#111">(</span><span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">gRPCStream</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">().</span><span style="color:#75af00">Err</span><span style="color:#111">(),</span> <span style="color:#75af00">err</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">lg</span><span style="color:#111">.</span><span style="color:#75af00">Debug</span><span style="color:#111">(</span><span style="color:#d88200">&#34;failed to send watch control response to gRPC stream&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">Error</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>				<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">lg</span><span style="color:#111">.</span><span style="color:#75af00">Warn</span><span style="color:#111">(</span><span style="color:#d88200">&#34;failed to send watch control response to gRPC stream&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">Error</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">streamFailures</span><span style="color:#111">.</span><span style="color:#75af00">WithLabelValues</span><span style="color:#111">(</span><span style="color:#d88200">&#34;send&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;watch&#34;</span><span style="color:#111">).</span><span style="color:#75af00">Inc</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>				<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// track id creation</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">wid</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">mvcc</span><span style="color:#111">.</span><span style="color:#75af00">WatchID</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">WatchId</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">verify</span><span style="color:#111">.</span><span style="color:#75af00">Assert</span><span style="color:#111">(!(</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">Canceled</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">Created</span><span style="color:#111">)</span> <span style="color:#f92672">||</span> <span style="color:#75af00">wid</span> <span style="color:#f92672">==</span> <span style="color:#75af00">clientv3</span><span style="color:#111">.</span><span style="color:#75af00">InvalidWatchID</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;unexpected watchId: %d, wanted: %d, since both &#39;Canceled&#39; and &#39;Created&#39; are true&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">wid</span><span style="color:#111">,</span> <span style="color:#75af00">clientv3</span><span style="color:#111">.</span><span style="color:#75af00">InvalidWatchID</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">Canceled</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">wid</span> <span style="color:#f92672">!=</span> <span style="color:#75af00">clientv3</span><span style="color:#111">.</span><span style="color:#75af00">InvalidWatchID</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#111">delete</span><span style="color:#111">(</span><span style="color:#75af00">ids</span><span style="color:#111">,</span> <span style="color:#75af00">wid</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">continue</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">Created</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// flush buffered events</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">ids</span><span style="color:#111">[</span><span style="color:#75af00">wid</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#00a8c8">struct</span><span style="color:#111">{}{}</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">v</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">pending</span><span style="color:#111">[</span><span style="color:#75af00">wid</span><span style="color:#111">]</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">mvcc</span><span style="color:#111">.</span><span style="color:#75af00">ReportEventReceived</span><span style="color:#111">(</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">v</span><span style="color:#111">.</span><span style="color:#75af00">Events</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>					<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">gRPCStream</span><span style="color:#111">.</span><span style="color:#75af00">Send</span><span style="color:#111">(</span><span style="color:#75af00">v</span><span style="color:#111">);</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>						<span style="color:#00a8c8">if</span> <span style="color:#75af00">isClientCtxErr</span><span style="color:#111">(</span><span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">gRPCStream</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">().</span><span style="color:#75af00">Err</span><span style="color:#111">(),</span> <span style="color:#75af00">err</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>							<span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">lg</span><span style="color:#111">.</span><span style="color:#75af00">Debug</span><span style="color:#111">(</span><span style="color:#d88200">&#34;failed to send pending watch response to gRPC stream&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">Error</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>						<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>							<span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">lg</span><span style="color:#111">.</span><span style="color:#75af00">Warn</span><span style="color:#111">(</span><span style="color:#d88200">&#34;failed to send pending watch response to gRPC stream&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">Error</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>							<span style="color:#75af00">streamFailures</span><span style="color:#111">.</span><span style="color:#75af00">WithLabelValues</span><span style="color:#111">(</span><span style="color:#d88200">&#34;send&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;watch&#34;</span><span style="color:#111">).</span><span style="color:#75af00">Inc</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>						<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>						<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>					<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>				<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>				<span style="color:#111">delete</span><span style="color:#111">(</span><span style="color:#75af00">pending</span><span style="color:#111">,</span> <span style="color:#75af00">wid</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#75af00">progressTicker</span><span style="color:#111">.</span><span style="color:#75af00">C</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">Lock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">for</span> <span style="color:#75af00">id</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">progress</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">if</span> <span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">watchStream</span><span style="color:#111">.</span><span style="color:#75af00">RequestProgress</span><span style="color:#111">(</span><span style="color:#75af00">id</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">progress</span><span style="color:#111">[</span><span style="color:#75af00">id</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#00a8c8">true</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">Unlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">closec</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>这里使用了 for select 循环：</p>
<ol>
<li>从 watchStream.Chan() 中获取 event 然后发送给客户端。</li>
<li>处理客户端发送的 watch 请求。</li>
<li>dispatch progress 事件。</li>
<li>处理结束。</li>
</ol>
<h3 id="recvloop">recvLoop</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">sws</span> <span style="color:#f92672">*</span><span style="color:#75af00">serverWatchStream</span><span style="color:#111">)</span> <span style="color:#75af00">recvLoop</span><span style="color:#111">()</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">req</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">gRPCStream</span><span style="color:#111">.</span><span style="color:#75af00">Recv</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">==</span> <span style="color:#75af00">io</span><span style="color:#111">.</span><span style="color:#75af00">EOF</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">switch</span> <span style="color:#75af00">uv</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">req</span><span style="color:#111">.</span><span style="color:#75af00">RequestUnion</span><span style="color:#111">.(</span><span style="color:#00a8c8">type</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">case</span> <span style="color:#f92672">*</span><span style="color:#75af00">pb</span><span style="color:#111">.</span><span style="color:#75af00">WatchRequest_CreateRequest</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">uv</span><span style="color:#111">.</span><span style="color:#75af00">CreateRequest</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">break</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">creq</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">uv</span><span style="color:#111">.</span><span style="color:#75af00">CreateRequest</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">creq</span><span style="color:#111">.</span><span style="color:#75af00">Key</span><span style="color:#111">)</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// \x00 is the smallest key</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">creq</span><span style="color:#111">.</span><span style="color:#75af00">Key</span> <span style="color:#111">=</span> <span style="color:#111">[]</span><span style="color:#00a8c8">byte</span><span style="color:#111">{</span><span style="color:#ae81ff">0</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">creq</span><span style="color:#111">.</span><span style="color:#75af00">RangeEnd</span><span style="color:#111">)</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// force nil since watchstream.Watch distinguishes</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// between nil and []byte{} for single key / &gt;=</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">creq</span><span style="color:#111">.</span><span style="color:#75af00">RangeEnd</span> <span style="color:#111">=</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">creq</span><span style="color:#111">.</span><span style="color:#75af00">RangeEnd</span><span style="color:#111">)</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">creq</span><span style="color:#111">.</span><span style="color:#75af00">RangeEnd</span><span style="color:#111">[</span><span style="color:#ae81ff">0</span><span style="color:#111">]</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// support  &gt;= key queries</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">creq</span><span style="color:#111">.</span><span style="color:#75af00">RangeEnd</span> <span style="color:#111">=</span> <span style="color:#111">[]</span><span style="color:#00a8c8">byte</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">isWatchPermitted</span><span style="color:#111">(</span><span style="color:#75af00">creq</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">var</span> <span style="color:#75af00">cancelReason</span> <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">switch</span> <span style="color:#75af00">err</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">case</span> <span style="color:#75af00">auth</span><span style="color:#111">.</span><span style="color:#75af00">ErrInvalidAuthToken</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">cancelReason</span> <span style="color:#111">=</span> <span style="color:#75af00">rpctypes</span><span style="color:#111">.</span><span style="color:#75af00">ErrGRPCInvalidAuthToken</span><span style="color:#111">.</span><span style="color:#75af00">Error</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">case</span> <span style="color:#75af00">auth</span><span style="color:#111">.</span><span style="color:#75af00">ErrAuthOldRevision</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">cancelReason</span> <span style="color:#111">=</span> <span style="color:#75af00">rpctypes</span><span style="color:#111">.</span><span style="color:#75af00">ErrGRPCAuthOldRevision</span><span style="color:#111">.</span><span style="color:#75af00">Error</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">case</span> <span style="color:#75af00">auth</span><span style="color:#111">.</span><span style="color:#75af00">ErrUserEmpty</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">cancelReason</span> <span style="color:#111">=</span> <span style="color:#75af00">rpctypes</span><span style="color:#111">.</span><span style="color:#75af00">ErrGRPCUserEmpty</span><span style="color:#111">.</span><span style="color:#75af00">Error</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">default</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>					<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#75af00">auth</span><span style="color:#111">.</span><span style="color:#75af00">ErrPermissionDenied</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>						<span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">lg</span><span style="color:#111">.</span><span style="color:#75af00">Error</span><span style="color:#111">(</span><span style="color:#d88200">&#34;unexpected error code&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">Error</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>					<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">cancelReason</span> <span style="color:#111">=</span> <span style="color:#75af00">rpctypes</span><span style="color:#111">.</span><span style="color:#75af00">ErrGRPCPermissionDenied</span><span style="color:#111">.</span><span style="color:#75af00">Error</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>				<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">wr</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">pb</span><span style="color:#111">.</span><span style="color:#75af00">WatchResponse</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">Header</span><span style="color:#111">:</span>       <span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">newResponseHeader</span><span style="color:#111">(</span><span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">watchStream</span><span style="color:#111">.</span><span style="color:#75af00">Rev</span><span style="color:#111">()),</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">WatchId</span><span style="color:#111">:</span>      <span style="color:#75af00">clientv3</span><span style="color:#111">.</span><span style="color:#75af00">InvalidWatchID</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">Canceled</span><span style="color:#111">:</span>     <span style="color:#00a8c8">true</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">Created</span><span style="color:#111">:</span>      <span style="color:#00a8c8">true</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">CancelReason</span><span style="color:#111">:</span> <span style="color:#75af00">cancelReason</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">select</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">case</span> <span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">ctrlStream</span> <span style="color:#f92672">&lt;-</span> <span style="color:#75af00">wr</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>					<span style="color:#00a8c8">continue</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">closec</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>					<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>				<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">filters</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">FiltersFromRequest</span><span style="color:#111">(</span><span style="color:#75af00">creq</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">wsrev</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">watchStream</span><span style="color:#111">.</span><span style="color:#75af00">Rev</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">rev</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">creq</span><span style="color:#111">.</span><span style="color:#75af00">StartRevision</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">rev</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">rev</span> <span style="color:#111">=</span> <span style="color:#75af00">wsrev</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">id</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">watchStream</span><span style="color:#111">.</span><span style="color:#75af00">Watch</span><span style="color:#111">(</span><span style="color:#75af00">mvcc</span><span style="color:#111">.</span><span style="color:#75af00">WatchID</span><span style="color:#111">(</span><span style="color:#75af00">creq</span><span style="color:#111">.</span><span style="color:#75af00">WatchId</span><span style="color:#111">),</span> <span style="color:#75af00">creq</span><span style="color:#111">.</span><span style="color:#75af00">Key</span><span style="color:#111">,</span> <span style="color:#75af00">creq</span><span style="color:#111">.</span><span style="color:#75af00">RangeEnd</span><span style="color:#111">,</span> <span style="color:#75af00">rev</span><span style="color:#111">,</span> <span style="color:#75af00">filters</span><span style="color:#f92672">...</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">Lock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">if</span> <span style="color:#75af00">creq</span><span style="color:#111">.</span><span style="color:#75af00">ProgressNotify</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">progress</span><span style="color:#111">[</span><span style="color:#75af00">id</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#00a8c8">true</span>
</span></span><span style="display:flex;"><span>				<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">if</span> <span style="color:#75af00">creq</span><span style="color:#111">.</span><span style="color:#75af00">PrevKv</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">prevKV</span><span style="color:#111">[</span><span style="color:#75af00">id</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#00a8c8">true</span>
</span></span><span style="display:flex;"><span>				<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">if</span> <span style="color:#75af00">creq</span><span style="color:#111">.</span><span style="color:#75af00">Fragment</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">fragment</span><span style="color:#111">[</span><span style="color:#75af00">id</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#00a8c8">true</span>
</span></span><span style="display:flex;"><span>				<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">Unlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">id</span> <span style="color:#111">=</span> <span style="color:#75af00">clientv3</span><span style="color:#111">.</span><span style="color:#75af00">InvalidWatchID</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">wr</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">pb</span><span style="color:#111">.</span><span style="color:#75af00">WatchResponse</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">Header</span><span style="color:#111">:</span>   <span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">newResponseHeader</span><span style="color:#111">(</span><span style="color:#75af00">wsrev</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">WatchId</span><span style="color:#111">:</span>  <span style="color:#111">int64</span><span style="color:#111">(</span><span style="color:#75af00">id</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">Created</span><span style="color:#111">:</span>  <span style="color:#00a8c8">true</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">Canceled</span><span style="color:#111">:</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">wr</span><span style="color:#111">.</span><span style="color:#75af00">CancelReason</span> <span style="color:#111">=</span> <span style="color:#75af00">err</span><span style="color:#111">.</span><span style="color:#75af00">Error</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">select</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">case</span> <span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">ctrlStream</span> <span style="color:#f92672">&lt;-</span> <span style="color:#75af00">wr</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">closec</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">case</span> <span style="color:#f92672">*</span><span style="color:#75af00">pb</span><span style="color:#111">.</span><span style="color:#75af00">WatchRequest_CancelRequest</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">uv</span><span style="color:#111">.</span><span style="color:#75af00">CancelRequest</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">id</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">uv</span><span style="color:#111">.</span><span style="color:#75af00">CancelRequest</span><span style="color:#111">.</span><span style="color:#75af00">WatchId</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">watchStream</span><span style="color:#111">.</span><span style="color:#75af00">Cancel</span><span style="color:#111">(</span><span style="color:#75af00">mvcc</span><span style="color:#111">.</span><span style="color:#75af00">WatchID</span><span style="color:#111">(</span><span style="color:#75af00">id</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">ctrlStream</span> <span style="color:#f92672">&lt;-</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">pb</span><span style="color:#111">.</span><span style="color:#75af00">WatchResponse</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>						<span style="color:#75af00">Header</span><span style="color:#111">:</span>   <span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">newResponseHeader</span><span style="color:#111">(</span><span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">watchStream</span><span style="color:#111">.</span><span style="color:#75af00">Rev</span><span style="color:#111">()),</span>
</span></span><span style="display:flex;"><span>						<span style="color:#75af00">WatchId</span><span style="color:#111">:</span>  <span style="color:#75af00">id</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>						<span style="color:#75af00">Canceled</span><span style="color:#111">:</span> <span style="color:#00a8c8">true</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>					<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">Lock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>					<span style="color:#111">delete</span><span style="color:#111">(</span><span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">progress</span><span style="color:#111">,</span> <span style="color:#75af00">mvcc</span><span style="color:#111">.</span><span style="color:#75af00">WatchID</span><span style="color:#111">(</span><span style="color:#75af00">id</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>					<span style="color:#111">delete</span><span style="color:#111">(</span><span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">prevKV</span><span style="color:#111">,</span> <span style="color:#75af00">mvcc</span><span style="color:#111">.</span><span style="color:#75af00">WatchID</span><span style="color:#111">(</span><span style="color:#75af00">id</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>					<span style="color:#111">delete</span><span style="color:#111">(</span><span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">fragment</span><span style="color:#111">,</span> <span style="color:#75af00">mvcc</span><span style="color:#111">.</span><span style="color:#75af00">WatchID</span><span style="color:#111">(</span><span style="color:#75af00">id</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">Unlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>				<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">case</span> <span style="color:#f92672">*</span><span style="color:#75af00">pb</span><span style="color:#111">.</span><span style="color:#75af00">WatchRequest_ProgressRequest</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">uv</span><span style="color:#111">.</span><span style="color:#75af00">ProgressRequest</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">Lock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">watchStream</span><span style="color:#111">.</span><span style="color:#75af00">RequestProgressAll</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">Unlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">default</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// we probably should not shutdown the entire stream when</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// receive an invalid command.</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// so just do nothing instead.</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">lg</span><span style="color:#111">.</span><span style="color:#75af00">Sugar</span><span style="color:#111">().</span><span style="color:#75af00">Infof</span><span style="color:#111">(</span><span style="color:#d88200">&#34;invalid watch request type %T received in gRPC stream&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">uv</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">continue</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>这里主要处理客户端发送的 watch 请求，然后发送给 ctrlStream。sendLoop 会从 ctrlStream 中获取 event 然后发送给客户端。</p>
<h2 id="watchstream">WatchStream</h2>
<p>这个 inferface 才是处理 watch 的主要逻辑</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// WatchStream 是一个接口，定义了一个流式处理watch请求的机制</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">WatchStream</span> <span style="color:#00a8c8">interface</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Watch 创建一个观察者。观察者会监听在给定的键或范围 [key, end) 上发生的事件或已发生的事件。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	// 整个事件历史都可以被观察到，除非被压缩。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 如果 &#34;startRev&#34; &lt;= 0，watch 将观察在当前修订版本之后的事件。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	// 返回的 &#34;id&#34; 是这个观察者的ID。它作为 WatchID 出现在通过 stream 通道发送到创建的观察者的事件中。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 当 WatchID 不等于 AutoWatchID 时，使用指定的 WatchID，否则返回自动生成的 WatchID。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Watch</span><span style="color:#111">(</span><span style="color:#75af00">id</span> <span style="color:#75af00">WatchID</span><span style="color:#111">,</span> <span style="color:#75af00">key</span><span style="color:#111">,</span> <span style="color:#75af00">end</span> <span style="color:#111">[]</span><span style="color:#00a8c8">byte</span><span style="color:#111">,</span> <span style="color:#75af00">startRev</span> <span style="color:#00a8c8">int64</span><span style="color:#111">,</span> <span style="color:#75af00">fcs</span> <span style="color:#f92672">...</span><span style="color:#75af00">FilterFunc</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#75af00">WatchID</span><span style="color:#111">,</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Chan 返回一个通道。所有的watch响应将被发送到这个返回的通道。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Chan</span><span style="color:#111">()</span> <span style="color:#f92672">&lt;-</span><span style="color:#00a8c8">chan</span> <span style="color:#75af00">WatchResponse</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// RequestProgress 请求给定ID的观察者的进度。响应只有在观察者当前同步时才会被发送。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 响应将通过与此流关联的 WatchResponse 通道发送，以确保正确的顺序。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 响应不包含事件。响应中的修订版本是观察者自同步以来的进度。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">RequestProgress</span><span style="color:#111">(</span><span style="color:#75af00">id</span> <span style="color:#75af00">WatchID</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// RequestProgressAll 请求所有共享此流的观察者的进度通知。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 如果所有观察者都已同步，将向此流的任意观察者发送带有watch ID -1的进度通知，并返回 true。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">RequestProgressAll</span><span style="color:#111">()</span> <span style="color:#00a8c8">bool</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Cancel 通过给定ID取消观察者。如果观察者不存在，将返回错误。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Cancel</span><span style="color:#111">(</span><span style="color:#75af00">id</span> <span style="color:#75af00">WatchID</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Close 关闭通道并释放所有相关资源。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Rev 返回流上观察到的KV的当前修订版本。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Rev</span><span style="color:#111">()</span> <span style="color:#00a8c8">int64</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// WatchResponse 表示一个watch操作的响应。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">WatchResponse</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// WatchID 是发送此响应的观察者的ID。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">WatchID</span> <span style="color:#75af00">WatchID</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Events 包含所有需要发送的事件。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Events</span> <span style="color:#111">[]</span><span style="color:#75af00">mvccpb</span><span style="color:#111">.</span><span style="color:#75af00">Event</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Revision 是创建watch响应时KV的修订版本。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 对于正常响应，修订版本应该与Events中最后一个修改的修订版本相同。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 对于延迟响应的未同步观察者，修订版本大于Events中最后一个修改的修订版本。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Revision</span> <span style="color:#00a8c8">int64</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// CompactRevision 在观察者由于压缩而被取消时设置。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">CompactRevision</span> <span style="color:#00a8c8">int64</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 实现了 WatchStream</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// watchStream 包含共享一个流通道发送被观察事件和其他控制事件的观察者集合。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">watchStream</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 可观察对象（例如KV存储）</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">watchable</span> <span style="color:#75af00">watchable</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 用于发送watch响应的通道</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ch</span>        <span style="color:#00a8c8">chan</span> <span style="color:#75af00">WatchResponse</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 互斥锁，保护以下字段</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">mu</span> <span style="color:#75af00">sync</span><span style="color:#111">.</span><span style="color:#75af00">Mutex</span> 
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// nextID 是为此流中下一个新观察者预分配的ID</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">nextID</span>   <span style="color:#75af00">WatchID</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 标志流是否已关闭</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">closed</span>   <span style="color:#00a8c8">bool</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 取消函数的映射，用于取消特定的观察者</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">cancels</span>  <span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#75af00">WatchID</span><span style="color:#111">]</span><span style="color:#75af00">cancelFunc</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 观察者的映射，根据观察者ID索引</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">watchers</span> <span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#75af00">WatchID</span><span style="color:#111">]</span><span style="color:#f92672">*</span><span style="color:#75af00">watcher</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Watch 在流中创建一个新的观察者并返回其 WatchID。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">ws</span> <span style="color:#f92672">*</span><span style="color:#75af00">watchStream</span><span style="color:#111">)</span> <span style="color:#75af00">Watch</span><span style="color:#111">(</span><span style="color:#75af00">id</span> <span style="color:#75af00">WatchID</span><span style="color:#111">,</span> <span style="color:#75af00">key</span><span style="color:#111">,</span> <span style="color:#75af00">end</span> <span style="color:#111">[]</span><span style="color:#00a8c8">byte</span><span style="color:#111">,</span> <span style="color:#75af00">startRev</span> <span style="color:#00a8c8">int64</span><span style="color:#111">,</span> <span style="color:#75af00">fcs</span> <span style="color:#f92672">...</span><span style="color:#75af00">FilterFunc</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#75af00">WatchID</span><span style="color:#111">,</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 防止键 &gt;= 结束键（按字典顺序）的错误范围</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 带有 &#39;WithFromKey&#39; 的watch请求具有空字节范围结束</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">end</span><span style="color:#111">)</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">bytes</span><span style="color:#111">.</span><span style="color:#75af00">Compare</span><span style="color:#111">(</span><span style="color:#75af00">key</span><span style="color:#111">,</span> <span style="color:#75af00">end</span><span style="color:#111">)</span> <span style="color:#f92672">!=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">,</span> <span style="color:#75af00">ErrEmptyWatcherRange</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 获取互斥锁</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">Lock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">Unlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 如果流已关闭，返回错误</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">closed</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">,</span> <span style="color:#75af00">ErrEmptyWatcherRange</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 自动生成 WatchID</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">id</span> <span style="color:#f92672">==</span> <span style="color:#75af00">clientv3</span><span style="color:#111">.</span><span style="color:#75af00">AutoWatchID</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">for</span> <span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">watchers</span><span style="color:#111">[</span><span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">nextID</span><span style="color:#111">]</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">nextID</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">id</span> <span style="color:#111">=</span> <span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">nextID</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">nextID</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#00a8c8">if</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">watchers</span><span style="color:#111">[</span><span style="color:#75af00">id</span><span style="color:#111">];</span> <span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">,</span> <span style="color:#75af00">ErrWatcherDuplicateID</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 创建新的观察者</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">w</span><span style="color:#111">,</span> <span style="color:#75af00">c</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">watchable</span><span style="color:#111">.</span><span style="color:#75af00">watch</span><span style="color:#111">(</span><span style="color:#75af00">key</span><span style="color:#111">,</span> <span style="color:#75af00">end</span><span style="color:#111">,</span> <span style="color:#75af00">startRev</span><span style="color:#111">,</span> <span style="color:#75af00">id</span><span style="color:#111">,</span> <span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">ch</span><span style="color:#111">,</span> <span style="color:#75af00">fcs</span><span style="color:#f92672">...</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 保存取消函数和观察者</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">cancels</span><span style="color:#111">[</span><span style="color:#75af00">id</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#75af00">c</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">watchers</span><span style="color:#111">[</span><span style="color:#75af00">id</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#75af00">w</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">id</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Chan 返回用于接收watch响应的通道。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">ws</span> <span style="color:#f92672">*</span><span style="color:#75af00">watchStream</span><span style="color:#111">)</span> <span style="color:#75af00">Chan</span><span style="color:#111">()</span> <span style="color:#f92672">&lt;-</span><span style="color:#00a8c8">chan</span> <span style="color:#75af00">WatchResponse</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">ch</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Cancel 取消具有给定ID的观察者。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">ws</span> <span style="color:#f92672">*</span><span style="color:#75af00">watchStream</span><span style="color:#111">)</span> <span style="color:#75af00">Cancel</span><span style="color:#111">(</span><span style="color:#75af00">id</span> <span style="color:#75af00">WatchID</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 获取互斥锁</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">Lock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">cancel</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">cancels</span><span style="color:#111">[</span><span style="color:#75af00">id</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">w</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">watchers</span><span style="color:#111">[</span><span style="color:#75af00">id</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ok</span> <span style="color:#111">=</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#111">!</span><span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">closed</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">Unlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 如果观察者不存在或流已关闭，返回错误</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">ErrWatcherNotExist</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">cancel</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 获取互斥锁</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">Lock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 在取消之前不删除观察者，以确保 Close() 调用时等待取消</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">ww</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">watchers</span><span style="color:#111">[</span><span style="color:#75af00">id</span><span style="color:#111">];</span> <span style="color:#75af00">ww</span> <span style="color:#f92672">==</span> <span style="color:#75af00">w</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">delete</span><span style="color:#111">(</span><span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">cancels</span><span style="color:#111">,</span> <span style="color:#75af00">id</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">delete</span><span style="color:#111">(</span><span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">watchers</span><span style="color:#111">,</span> <span style="color:#75af00">id</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">Unlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Close 关闭通道并释放所有相关资源。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">ws</span> <span style="color:#f92672">*</span><span style="color:#75af00">watchStream</span><span style="color:#111">)</span> <span style="color:#75af00">Close</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 获取互斥锁</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">Lock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">Unlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 取消所有观察者</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">cancel</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">cancels</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">cancel</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 标记流已关闭并关闭通道</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">closed</span> <span style="color:#111">=</span> <span style="color:#00a8c8">true</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">close</span><span style="color:#111">(</span><span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">ch</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">watchStreamGauge</span><span style="color:#111">.</span><span style="color:#75af00">Dec</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Rev 返回流上观察到的KV的当前修订版本。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">ws</span> <span style="color:#f92672">*</span><span style="color:#75af00">watchStream</span><span style="color:#111">)</span> <span style="color:#75af00">Rev</span><span style="color:#111">()</span> <span style="color:#00a8c8">int64</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 获取互斥锁</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">Lock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">Unlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">watchable</span><span style="color:#111">.</span><span style="color:#75af00">rev</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// RequestProgress 请求给定ID的观察者的进度。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">ws</span> <span style="color:#f92672">*</span><span style="color:#75af00">watchStream</span><span style="color:#111">)</span> <span style="color:#75af00">RequestProgress</span><span style="color:#111">(</span><span style="color:#75af00">id</span> <span style="color:#75af00">WatchID</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 获取互斥锁</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">Lock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">w</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">watchers</span><span style="color:#111">[</span><span style="color:#75af00">id</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">Unlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 如果观察者不存在，直接返回</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 请求进度</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">watchable</span><span style="color:#111">.</span><span style="color:#75af00">progress</span><span style="color:#111">(</span><span style="color:#75af00">w</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// RequestProgressAll 请求所有观察者的进度通知。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">ws</span> <span style="color:#f92672">*</span><span style="color:#75af00">watchStream</span><span style="color:#111">)</span> <span style="color:#75af00">RequestProgressAll</span><span style="color:#111">()</span> <span style="color:#00a8c8">bool</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 获取互斥锁</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">Lock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">Unlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">watchable</span><span style="color:#111">.</span><span style="color:#75af00">progressAll</span><span style="color:#111">(</span><span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">watchers</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><ol>
<li>Watch 方法：创建一个新的观察者，如果指定的范围不正确或观察者ID重复，则返回错误。否则，创建观察者并保存取消函数和观察者实例。</li>
<li>Chan 方法：返回用于接收watch响应的通道。</li>
<li>Cancel 方法：取消给定ID的观察者，删除相关的取消函数和观察者实例。</li>
<li>Close 方法：关闭所有观察者并释放资源。</li>
<li>Rev 方法：返回当前观察到的KV修订版本。</li>
<li>RequestProgress 方法：请求特定观察者的进度。</li>
<li>RequestProgressAll 方法：请求所有观察者的进度通知。</li>
</ol>
<p>可以可到 当调用 Watch 的时候 每个 watchId 都会调用 <code>watchable.watch</code> 并把自己 ch 放入进去</p>
<h2 id="watchable">watchable</h2>
<p><img src="/images/ad802824-86e0-42a7-b84d-d2dfe2076620.png" alt=""></p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// watchable 接口定义了可观察对象的行为</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">watchable</span> <span style="color:#00a8c8">interface</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// watch 创建一个新的观察者，用于监听指定键或范围[startRev, end)上的事件。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 返回观察者指针和取消函数。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">watch</span><span style="color:#111">(</span><span style="color:#75af00">key</span><span style="color:#111">,</span> <span style="color:#75af00">end</span> <span style="color:#111">[]</span><span style="color:#00a8c8">byte</span><span style="color:#111">,</span> <span style="color:#75af00">startRev</span> <span style="color:#00a8c8">int64</span><span style="color:#111">,</span> <span style="color:#75af00">id</span> <span style="color:#75af00">WatchID</span><span style="color:#111">,</span> <span style="color:#75af00">ch</span> <span style="color:#00a8c8">chan</span><span style="color:#f92672">&lt;-</span> <span style="color:#75af00">WatchResponse</span><span style="color:#111">,</span> <span style="color:#75af00">fcs</span> <span style="color:#f92672">...</span><span style="color:#75af00">FilterFunc</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">watcher</span><span style="color:#111">,</span> <span style="color:#75af00">cancelFunc</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// progress 通知特定观察者当前的进度。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">progress</span><span style="color:#111">(</span><span style="color:#75af00">w</span> <span style="color:#f92672">*</span><span style="color:#75af00">watcher</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// progressAll 通知所有观察者当前的进度。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 如果所有观察者都已同步，则返回 true。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">progressAll</span><span style="color:#111">(</span><span style="color:#75af00">watchers</span> <span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#75af00">WatchID</span><span style="color:#111">]</span><span style="color:#f92672">*</span><span style="color:#75af00">watcher</span><span style="color:#111">)</span> <span style="color:#00a8c8">bool</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// rev 返回当前观察到的修订版本。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">rev</span><span style="color:#111">()</span> <span style="color:#00a8c8">int64</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// watchableStore 是一个实现了 watchable 接口的结构体，代表一个可观察的存储</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">watchableStore</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// store 是一个指向基础存储的指针</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">*</span><span style="color:#75af00">store</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// mu 保护观察者组和批次。为了避免死锁，在锁定 store.mu 之前不应锁定 mu。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">mu</span> <span style="color:#75af00">sync</span><span style="color:#111">.</span><span style="color:#75af00">RWMutex</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// victims 是在 watch 通道上被阻塞的观察者批次</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">victims</span> <span style="color:#111">[]</span><span style="color:#75af00">watcherBatch</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">victimc</span> <span style="color:#00a8c8">chan</span> <span style="color:#00a8c8">struct</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// unsynced 包含所有需要同步已经发生的事件的未同步观察者</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">unsynced</span> <span style="color:#75af00">watcherGroup</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// synced 包含所有与存储进度同步的观察者</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 映射的键是观察者监听的键</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">synced</span> <span style="color:#75af00">watcherGroup</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// stopc 是一个用于停止操作的通道</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">stopc</span> <span style="color:#00a8c8">chan</span> <span style="color:#00a8c8">struct</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// wg 用于等待所有 goroutine 完成</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">wg</span> <span style="color:#75af00">sync</span><span style="color:#111">.</span><span style="color:#75af00">WaitGroup</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">s</span> <span style="color:#f92672">*</span><span style="color:#75af00">watchableStore</span><span style="color:#111">)</span> <span style="color:#75af00">watch</span><span style="color:#111">(</span><span style="color:#75af00">key</span><span style="color:#111">,</span> <span style="color:#75af00">end</span> <span style="color:#111">[]</span><span style="color:#00a8c8">byte</span><span style="color:#111">,</span> <span style="color:#75af00">startRev</span> <span style="color:#00a8c8">int64</span><span style="color:#111">,</span> <span style="color:#75af00">id</span> <span style="color:#75af00">WatchID</span><span style="color:#111">,</span> <span style="color:#75af00">ch</span> <span style="color:#00a8c8">chan</span><span style="color:#f92672">&lt;-</span> <span style="color:#75af00">WatchResponse</span><span style="color:#111">,</span> <span style="color:#75af00">fcs</span> <span style="color:#f92672">...</span><span style="color:#75af00">FilterFunc</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">watcher</span><span style="color:#111">,</span> <span style="color:#75af00">cancelFunc</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 创建一个新的观察者</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">wa</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">watcher</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">key</span><span style="color:#111">:</span>    <span style="color:#75af00">key</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">end</span><span style="color:#111">:</span>    <span style="color:#75af00">end</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">minRev</span><span style="color:#111">:</span> <span style="color:#75af00">startRev</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">id</span><span style="color:#111">:</span>     <span style="color:#75af00">id</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">ch</span><span style="color:#111">:</span>     <span style="color:#75af00">ch</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fcs</span><span style="color:#111">:</span>    <span style="color:#75af00">fcs</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 锁定 watchableStore 的互斥锁</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">Lock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 锁定 store 的读写锁用于获取当前修订版本</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">revMu</span><span style="color:#111">.</span><span style="color:#75af00">RLock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 判断观察者是否与当前存储修订版本同步</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">synced</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">startRev</span> <span style="color:#111">&gt;</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">store</span><span style="color:#111">.</span><span style="color:#75af00">currentRev</span> <span style="color:#f92672">||</span> <span style="color:#75af00">startRev</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">synced</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 如果同步，设置最小修订版本为当前修订版本的下一个版本</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">wa</span><span style="color:#111">.</span><span style="color:#75af00">minRev</span> <span style="color:#111">=</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">store</span><span style="color:#111">.</span><span style="color:#75af00">currentRev</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">startRev</span> <span style="color:#111">&gt;</span> <span style="color:#75af00">wa</span><span style="color:#111">.</span><span style="color:#75af00">minRev</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">wa</span><span style="color:#111">.</span><span style="color:#75af00">minRev</span> <span style="color:#111">=</span> <span style="color:#75af00">startRev</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 将观察者添加到同步观察者组中</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">synced</span><span style="color:#111">.</span><span style="color:#75af00">add</span><span style="color:#111">(</span><span style="color:#75af00">wa</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 如果未同步，增加慢速观察者计数器</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">slowWatcherGauge</span><span style="color:#111">.</span><span style="color:#75af00">Inc</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 将观察者添加到未同步观察者组中</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">unsynced</span><span style="color:#111">.</span><span style="color:#75af00">add</span><span style="color:#111">(</span><span style="color:#75af00">wa</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 解锁 store 的读写锁</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">revMu</span><span style="color:#111">.</span><span style="color:#75af00">RUnlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 解锁 watchableStore 的互斥锁</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">Unlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 增加观察者计数器</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">watcherGauge</span><span style="color:#111">.</span><span style="color:#75af00">Inc</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 返回观察者和取消函数</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">wa</span><span style="color:#111">,</span> <span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#111">{</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">cancelWatcher</span><span style="color:#111">(</span><span style="color:#75af00">wa</span><span style="color:#111">)</span> <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="newwatchablestore">newWatchableStore</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">newWatchableStore</span><span style="color:#111">(</span><span style="color:#75af00">lg</span> <span style="color:#f92672">*</span><span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">Logger</span><span style="color:#111">,</span> <span style="color:#75af00">b</span> <span style="color:#75af00">backend</span><span style="color:#111">.</span><span style="color:#75af00">Backend</span><span style="color:#111">,</span> <span style="color:#75af00">le</span> <span style="color:#75af00">lease</span><span style="color:#111">.</span><span style="color:#75af00">Lessor</span><span style="color:#111">,</span> <span style="color:#75af00">cfg</span> <span style="color:#75af00">StoreConfig</span><span style="color:#111">)</span> <span style="color:#f92672">*</span><span style="color:#75af00">watchableStore</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">lg</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">lg</span> <span style="color:#111">=</span> <span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">NewNop</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">s</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">watchableStore</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">store</span><span style="color:#111">:</span>    <span style="color:#75af00">NewStore</span><span style="color:#111">(</span><span style="color:#75af00">lg</span><span style="color:#111">,</span> <span style="color:#75af00">b</span><span style="color:#111">,</span> <span style="color:#75af00">le</span><span style="color:#111">,</span> <span style="color:#75af00">cfg</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">victimc</span><span style="color:#111">:</span>  <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">chan</span> <span style="color:#00a8c8">struct</span><span style="color:#111">{},</span> <span style="color:#ae81ff">1</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">unsynced</span><span style="color:#111">:</span> <span style="color:#75af00">newWatcherGroup</span><span style="color:#111">(),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">synced</span><span style="color:#111">:</span>   <span style="color:#75af00">newWatcherGroup</span><span style="color:#111">(),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">stopc</span><span style="color:#111">:</span>    <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">chan</span> <span style="color:#00a8c8">struct</span><span style="color:#111">{}),</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">store</span><span style="color:#111">.</span><span style="color:#75af00">ReadView</span> <span style="color:#111">=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">readView</span><span style="color:#111">{</span><span style="color:#75af00">s</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">store</span><span style="color:#111">.</span><span style="color:#75af00">WriteView</span> <span style="color:#111">=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">writeView</span><span style="color:#111">{</span><span style="color:#75af00">s</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">le</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// use this store as the deleter so revokes trigger watch events</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">le</span><span style="color:#111">.</span><span style="color:#75af00">SetRangeDeleter</span><span style="color:#111">(</span><span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#75af00">lease</span><span style="color:#111">.</span><span style="color:#75af00">TxnDelete</span> <span style="color:#111">{</span> <span style="color:#00a8c8">return</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">Write</span><span style="color:#111">(</span><span style="color:#75af00">traceutil</span><span style="color:#111">.</span><span style="color:#75af00">TODO</span><span style="color:#111">())</span> <span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">wg</span><span style="color:#111">.</span><span style="color:#75af00">Add</span><span style="color:#111">(</span><span style="color:#ae81ff">2</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">go</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">syncWatchersLoop</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">go</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">syncVictimsLoop</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">s</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="syncwatchersloop">syncWatchersLoop</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// syncWatchersLoop 每100毫秒同步一次unsynced集合中的观察者。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">s</span> <span style="color:#f92672">*</span><span style="color:#75af00">watchableStore</span><span style="color:#111">)</span> <span style="color:#75af00">syncWatchersLoop</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">wg</span><span style="color:#111">.</span><span style="color:#75af00">Done</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 设置等待时间为100毫秒</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">waitDuration</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">100</span> <span style="color:#f92672">*</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Millisecond</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">delayTicker</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">NewTicker</span><span style="color:#111">(</span><span style="color:#75af00">waitDuration</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">delayTicker</span><span style="color:#111">.</span><span style="color:#75af00">Stop</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 锁定以获取未同步观察者的数量</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">RLock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">st</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Now</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">lastUnsyncedWatchers</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">unsynced</span><span style="color:#111">.</span><span style="color:#75af00">size</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">RUnlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">unsyncedWatchers</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 如果有未同步观察者，同步这些观察者</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">lastUnsyncedWatchers</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">unsyncedWatchers</span> <span style="color:#111">=</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">syncWatchers</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">syncDuration</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Since</span><span style="color:#111">(</span><span style="color:#75af00">st</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 重置定时器</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">delayTicker</span><span style="color:#111">.</span><span style="color:#75af00">Reset</span><span style="color:#111">(</span><span style="color:#75af00">waitDuration</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 检查是否有更多待处理的工作</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">unsyncedWatchers</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">lastUnsyncedWatchers</span> <span style="color:#111">&gt;</span> <span style="color:#75af00">unsyncedWatchers</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 公平对待其他存储操作，通过延长时间来避免占用太多资源</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">delayTicker</span><span style="color:#111">.</span><span style="color:#75af00">Reset</span><span style="color:#111">(</span><span style="color:#75af00">syncDuration</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 等待定时器或停止信号</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">select</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#75af00">delayTicker</span><span style="color:#111">.</span><span style="color:#75af00">C</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">stopc</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// syncWatchers 通过以下步骤同步未同步的观察者：</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//  1. 从未同步观察者组中选择一组观察者</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//  2. 迭代该组以获取最小修订版本并移除压缩的观察者</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//  3. 使用最小修订版本获取所有键值对，并将这些事件发送给观察者</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//  4. 从未同步组中移除已同步的观察者，并移动到同步组中</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">s</span> <span style="color:#f92672">*</span><span style="color:#75af00">watchableStore</span><span style="color:#111">)</span> <span style="color:#75af00">syncWatchers</span><span style="color:#111">()</span> <span style="color:#00a8c8">int</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 锁定</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">Lock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">Unlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 如果没有未同步观察者，返回0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">unsynced</span><span style="color:#111">.</span><span style="color:#75af00">size</span><span style="color:#111">()</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 锁定存储的读写锁</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">store</span><span style="color:#111">.</span><span style="color:#75af00">revMu</span><span style="color:#111">.</span><span style="color:#75af00">RLock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">store</span><span style="color:#111">.</span><span style="color:#75af00">revMu</span><span style="color:#111">.</span><span style="color:#75af00">RUnlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 为了从未同步观察者中找到键值对，我们需要找到最小修订版本</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">curRev</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">store</span><span style="color:#111">.</span><span style="color:#75af00">currentRev</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">compactionRev</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">store</span><span style="color:#111">.</span><span style="color:#75af00">compactMainRev</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 选择一组观察者</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">wg</span><span style="color:#111">,</span> <span style="color:#75af00">minRev</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">unsynced</span><span style="color:#111">.</span><span style="color:#75af00">choose</span><span style="color:#111">(</span><span style="color:#75af00">maxWatchersPerSync</span><span style="color:#111">,</span> <span style="color:#75af00">curRev</span><span style="color:#111">,</span> <span style="color:#75af00">compactionRev</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">minBytes</span><span style="color:#111">,</span> <span style="color:#75af00">maxBytes</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">NewRevBytes</span><span style="color:#111">(),</span> <span style="color:#75af00">NewRevBytes</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">minBytes</span> <span style="color:#111">=</span> <span style="color:#75af00">RevToBytes</span><span style="color:#111">(</span><span style="color:#75af00">Revision</span><span style="color:#111">{</span><span style="color:#75af00">Main</span><span style="color:#111">:</span> <span style="color:#75af00">minRev</span><span style="color:#111">},</span> <span style="color:#75af00">minBytes</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">maxBytes</span> <span style="color:#111">=</span> <span style="color:#75af00">RevToBytes</span><span style="color:#111">(</span><span style="color:#75af00">Revision</span><span style="color:#111">{</span><span style="color:#75af00">Main</span><span style="color:#111">:</span> <span style="color:#75af00">curRev</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span><span style="color:#111">},</span> <span style="color:#75af00">maxBytes</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// UnsafeRange 返回键和值。在boltdb中，键是修订版本，值是实际的键值对。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">tx</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">store</span><span style="color:#111">.</span><span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">ReadTx</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">RLock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">revs</span><span style="color:#111">,</span> <span style="color:#75af00">vs</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">UnsafeRange</span><span style="color:#111">(</span><span style="color:#75af00">schema</span><span style="color:#111">.</span><span style="color:#75af00">Key</span><span style="color:#111">,</span> <span style="color:#75af00">minBytes</span><span style="color:#111">,</span> <span style="color:#75af00">maxBytes</span><span style="color:#111">,</span> <span style="color:#ae81ff">0</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">evs</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">kvsToEvents</span><span style="color:#111">(</span><span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">store</span><span style="color:#111">.</span><span style="color:#75af00">lg</span><span style="color:#111">,</span> <span style="color:#75af00">wg</span><span style="color:#111">,</span> <span style="color:#75af00">revs</span><span style="color:#111">,</span> <span style="color:#75af00">vs</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 必须在kvsToEvents之后解锁，因为vs（来自boltdb内存）不是深拷贝。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 我们只能在Unmarshal之后解锁，这将进行深拷贝。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 否则我们将在boltdb重新mmap期间触发SIGSEGV。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">RUnlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 创建一个新的观察者批次</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">victims</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#75af00">watcherBatch</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">wb</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">newWatcherBatch</span><span style="color:#111">(</span><span style="color:#75af00">wg</span><span style="color:#111">,</span> <span style="color:#75af00">evs</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">w</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">wg</span><span style="color:#111">.</span><span style="color:#75af00">watchers</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">w</span><span style="color:#111">.</span><span style="color:#75af00">minRev</span> <span style="color:#111">&lt;</span> <span style="color:#75af00">compactionRev</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 跳过因压缩而无法发送响应的观察者</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">continue</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">w</span><span style="color:#111">.</span><span style="color:#75af00">minRev</span> <span style="color:#111">=</span> <span style="color:#75af00">curRev</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">eb</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">wb</span><span style="color:#111">[</span><span style="color:#75af00">w</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 将未通知的观察者移至同步</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">synced</span><span style="color:#111">.</span><span style="color:#75af00">add</span><span style="color:#111">(</span><span style="color:#75af00">w</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">unsynced</span><span style="color:#111">.</span><span style="color:#111">delete</span><span style="color:#111">(</span><span style="color:#75af00">w</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">continue</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">eb</span><span style="color:#111">.</span><span style="color:#75af00">moreRev</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">w</span><span style="color:#111">.</span><span style="color:#75af00">minRev</span> <span style="color:#111">=</span> <span style="color:#75af00">eb</span><span style="color:#111">.</span><span style="color:#75af00">moreRev</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 发送响应</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">w</span><span style="color:#111">.</span><span style="color:#75af00">send</span><span style="color:#111">(</span><span style="color:#75af00">WatchResponse</span><span style="color:#111">{</span><span style="color:#75af00">WatchID</span><span style="color:#111">:</span> <span style="color:#75af00">w</span><span style="color:#111">.</span><span style="color:#75af00">id</span><span style="color:#111">,</span> <span style="color:#75af00">Events</span><span style="color:#111">:</span> <span style="color:#75af00">eb</span><span style="color:#111">.</span><span style="color:#75af00">evs</span><span style="color:#111">,</span> <span style="color:#75af00">Revision</span><span style="color:#111">:</span> <span style="color:#75af00">curRev</span><span style="color:#111">})</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">pendingEventsGauge</span><span style="color:#111">.</span><span style="color:#75af00">Add</span><span style="color:#111">(</span><span style="color:#111">float64</span><span style="color:#111">(</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">eb</span><span style="color:#111">.</span><span style="color:#75af00">evs</span><span style="color:#111">)))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">w</span><span style="color:#111">.</span><span style="color:#75af00">victim</span> <span style="color:#111">=</span> <span style="color:#00a8c8">true</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 处理受害者观察者</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">w</span><span style="color:#111">.</span><span style="color:#75af00">victim</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">victims</span><span style="color:#111">[</span><span style="color:#75af00">w</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#75af00">eb</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">eb</span><span style="color:#111">.</span><span style="color:#75af00">moreRev</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// 保持未同步状态；还有更多要读取</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">continue</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">synced</span><span style="color:#111">.</span><span style="color:#75af00">add</span><span style="color:#111">(</span><span style="color:#75af00">w</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">unsynced</span><span style="color:#111">.</span><span style="color:#111">delete</span><span style="color:#111">(</span><span style="color:#75af00">w</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">addVictim</span><span style="color:#111">(</span><span style="color:#75af00">victims</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 更新慢速观察者计数器</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">vsz</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">v</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">victims</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">vsz</span> <span style="color:#f92672">+=</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">v</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">slowWatcherGauge</span><span style="color:#111">.</span><span style="color:#75af00">Set</span><span style="color:#111">(</span><span style="color:#111">float64</span><span style="color:#111">(</span><span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">unsynced</span><span style="color:#111">.</span><span style="color:#75af00">size</span><span style="color:#111">()</span> <span style="color:#f92672">+</span> <span style="color:#75af00">vsz</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">unsynced</span><span style="color:#111">.</span><span style="color:#75af00">size</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h4 id="watcher--send">watcher &amp; send</h4>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">watcher</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// the watcher key</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">key</span> <span style="color:#111">[]</span><span style="color:#00a8c8">byte</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// end indicates the end of the range to watch.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// If end is set, the watcher is on a range.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">end</span> <span style="color:#111">[]</span><span style="color:#00a8c8">byte</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// victim is set when ch is blocked and undergoing victim processing</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">victim</span> <span style="color:#00a8c8">bool</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// compacted is set when the watcher is removed because of compaction</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">compacted</span> <span style="color:#00a8c8">bool</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// restore is true when the watcher is being restored from leader snapshot</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// which means that this watcher has just been moved from &#34;synced&#34; to &#34;unsynced&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// watcher group, possibly with a future revision when it was first added</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// to the synced watcher</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// &#34;unsynced&#34; watcher revision must always be &lt;= current revision,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// except when the watcher were to be moved from &#34;synced&#34; watcher group</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">restore</span> <span style="color:#00a8c8">bool</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// minRev is the minimum revision update the watcher will accept</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">minRev</span> <span style="color:#00a8c8">int64</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">id</span>     <span style="color:#75af00">WatchID</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fcs</span> <span style="color:#111">[]</span><span style="color:#75af00">FilterFunc</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// a chan to send out the watch response.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// The chan might be shared with other watchers.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ch</span> <span style="color:#00a8c8">chan</span><span style="color:#f92672">&lt;-</span> <span style="color:#75af00">WatchResponse</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">w</span> <span style="color:#f92672">*</span><span style="color:#75af00">watcher</span><span style="color:#111">)</span> <span style="color:#75af00">send</span><span style="color:#111">(</span><span style="color:#75af00">wr</span> <span style="color:#75af00">WatchResponse</span><span style="color:#111">)</span> <span style="color:#00a8c8">bool</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">progressEvent</span> <span style="color:#f92672">:=</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">wr</span><span style="color:#111">.</span><span style="color:#75af00">Events</span><span style="color:#111">)</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">w</span><span style="color:#111">.</span><span style="color:#75af00">fcs</span><span style="color:#111">)</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">ne</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">([]</span><span style="color:#75af00">mvccpb</span><span style="color:#111">.</span><span style="color:#75af00">Event</span><span style="color:#111">,</span> <span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">wr</span><span style="color:#111">.</span><span style="color:#75af00">Events</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">for</span> <span style="color:#75af00">i</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">wr</span><span style="color:#111">.</span><span style="color:#75af00">Events</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">filtered</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">false</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">filter</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">w</span><span style="color:#111">.</span><span style="color:#75af00">fcs</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">if</span> <span style="color:#75af00">filter</span><span style="color:#111">(</span><span style="color:#75af00">wr</span><span style="color:#111">.</span><span style="color:#75af00">Events</span><span style="color:#111">[</span><span style="color:#75af00">i</span><span style="color:#111">])</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">filtered</span> <span style="color:#111">=</span> <span style="color:#00a8c8">true</span>
</span></span><span style="display:flex;"><span>					<span style="color:#00a8c8">break</span>
</span></span><span style="display:flex;"><span>				<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">filtered</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">ne</span> <span style="color:#111">=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">ne</span><span style="color:#111">,</span> <span style="color:#75af00">wr</span><span style="color:#111">.</span><span style="color:#75af00">Events</span><span style="color:#111">[</span><span style="color:#75af00">i</span><span style="color:#111">])</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">wr</span><span style="color:#111">.</span><span style="color:#75af00">Events</span> <span style="color:#111">=</span> <span style="color:#75af00">ne</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// if all events are filtered out, we should send nothing.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">progressEvent</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">wr</span><span style="color:#111">.</span><span style="color:#75af00">Events</span><span style="color:#111">)</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">true</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">select</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">case</span> <span style="color:#75af00">w</span><span style="color:#111">.</span><span style="color:#75af00">ch</span> <span style="color:#f92672">&lt;-</span> <span style="color:#75af00">wr</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">true</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">default</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">false</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="syncvictimsloop">syncVictimsLoop</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// syncVictimsLoop 尝试将预先计算的观察者响应写入被阻塞的观察者通道</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">s</span> <span style="color:#f92672">*</span><span style="color:#75af00">watchableStore</span><span style="color:#111">)</span> <span style="color:#75af00">syncVictimsLoop</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">wg</span><span style="color:#111">.</span><span style="color:#75af00">Done</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 尝试更新所有受害者观察者</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">for</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">moveVictims</span><span style="color:#111">()</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 持续更新，直到所有受害者观察者都处理完毕</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 检查是否有受害者观察者</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">RLock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">isEmpty</span> <span style="color:#f92672">:=</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">victims</span><span style="color:#111">)</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">RUnlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">var</span> <span style="color:#75af00">tickc</span> <span style="color:#f92672">&lt;-</span><span style="color:#00a8c8">chan</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Time</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">isEmpty</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">tickc</span> <span style="color:#111">=</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">After</span><span style="color:#111">(</span><span style="color:#ae81ff">10</span> <span style="color:#f92672">*</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Millisecond</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 等待10毫秒或收到新的受害者通知或停止信号</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">select</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#75af00">tickc</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">victimc</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">stopc</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// moveVictims 尝试使用已存在的事件数据更新观察者</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">s</span> <span style="color:#f92672">*</span><span style="color:#75af00">watchableStore</span><span style="color:#111">)</span> <span style="color:#75af00">moveVictims</span><span style="color:#111">()</span> <span style="color:#111">(</span><span style="color:#75af00">moved</span> <span style="color:#00a8c8">int</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">Lock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">victims</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">victims</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">victims</span> <span style="color:#111">=</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">Unlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">var</span> <span style="color:#75af00">newVictim</span> <span style="color:#75af00">watcherBatch</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">wb</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">victims</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 再次尝试发送响应</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">for</span> <span style="color:#75af00">w</span><span style="color:#111">,</span> <span style="color:#75af00">eb</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">wb</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 观察者已观察到存储，直到但不包括 w.minRev</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">rev</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">w</span><span style="color:#111">.</span><span style="color:#75af00">minRev</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">w</span><span style="color:#111">.</span><span style="color:#75af00">send</span><span style="color:#111">(</span><span style="color:#75af00">WatchResponse</span><span style="color:#111">{</span><span style="color:#75af00">WatchID</span><span style="color:#111">:</span> <span style="color:#75af00">w</span><span style="color:#111">.</span><span style="color:#75af00">id</span><span style="color:#111">,</span> <span style="color:#75af00">Events</span><span style="color:#111">:</span> <span style="color:#75af00">eb</span><span style="color:#111">.</span><span style="color:#75af00">evs</span><span style="color:#111">,</span> <span style="color:#75af00">Revision</span><span style="color:#111">:</span> <span style="color:#75af00">rev</span><span style="color:#111">})</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">pendingEventsGauge</span><span style="color:#111">.</span><span style="color:#75af00">Add</span><span style="color:#111">(</span><span style="color:#111">float64</span><span style="color:#111">(</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">eb</span><span style="color:#111">.</span><span style="color:#75af00">evs</span><span style="color:#111">)))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">if</span> <span style="color:#75af00">newVictim</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">newVictim</span> <span style="color:#111">=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#75af00">watcherBatch</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">newVictim</span><span style="color:#111">[</span><span style="color:#75af00">w</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#75af00">eb</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">continue</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">moved</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 将完成的受害者观察者分配到未同步/同步组</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">Lock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">store</span><span style="color:#111">.</span><span style="color:#75af00">revMu</span><span style="color:#111">.</span><span style="color:#75af00">RLock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">curRev</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">store</span><span style="color:#111">.</span><span style="color:#75af00">currentRev</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">for</span> <span style="color:#75af00">w</span><span style="color:#111">,</span> <span style="color:#75af00">eb</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">wb</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">newVictim</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">newVictim</span><span style="color:#111">[</span><span style="color:#75af00">w</span><span style="color:#111">]</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// 无法发送watch响应，仍然是受害者</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">continue</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">w</span><span style="color:#111">.</span><span style="color:#75af00">victim</span> <span style="color:#111">=</span> <span style="color:#00a8c8">false</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">eb</span><span style="color:#111">.</span><span style="color:#75af00">moreRev</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">w</span><span style="color:#111">.</span><span style="color:#75af00">minRev</span> <span style="color:#111">=</span> <span style="color:#75af00">eb</span><span style="color:#111">.</span><span style="color:#75af00">moreRev</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">w</span><span style="color:#111">.</span><span style="color:#75af00">minRev</span> <span style="color:#f92672">&lt;=</span> <span style="color:#75af00">curRev</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">unsynced</span><span style="color:#111">.</span><span style="color:#75af00">add</span><span style="color:#111">(</span><span style="color:#75af00">w</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">slowWatcherGauge</span><span style="color:#111">.</span><span style="color:#75af00">Dec</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">synced</span><span style="color:#111">.</span><span style="color:#75af00">add</span><span style="color:#111">(</span><span style="color:#75af00">w</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">store</span><span style="color:#111">.</span><span style="color:#75af00">revMu</span><span style="color:#111">.</span><span style="color:#75af00">RUnlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">Unlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 如果仍然有未处理的受害者，重新添加到受害者列表中</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">newVictim</span><span style="color:#111">)</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">Lock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">victims</span> <span style="color:#111">=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">victims</span><span style="color:#111">,</span> <span style="color:#75af00">newVictim</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">Unlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">moved</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="reference">Reference</h2>
<ul>
<li><a href="https://blog.csdn.net/qq_24433609/article/details/120653747">https://blog.csdn.net/qq_24433609/article/details/120653747</a></li>
</ul>
]]></content:encoded><category>cloud</category><category>boltdb</category><category>etcd</category><category>golang</category><category>数据库</category><category>kubernetes</category></item><item><title>etcd MVCC 存储结构及流程</title><link>https://daemon365.dev/post/cloud/etcd_mvcc_storage_structure_and_process/</link><pubDate>Sun, 26 May 2024 18:00:00 +0800</pubDate><guid>https://daemon365.dev/post/cloud/etcd_mvcc_storage_structure_and_process/</guid><description>&lt;h2 id="什么是-mvcc"&gt;什么是 MVCC&lt;/h2&gt;
&lt;p&gt;MVCC 是 Multi-Version Concurrency Control 的缩写，即多版本并发控制。它是一种并发控制的方法，用于在数据库系统中实现事务的隔离性。MVCC 是一种乐观锁机制，它通过保存数据的多个版本来实现事务的隔禽性。在 etcd 中，MVCC 是用于实现数据的版本控制的。而且可以查看历史版本的数据。&lt;/p&gt;
&lt;h2 id="测试"&gt;测试&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-BASH" data-lang="BASH"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;# 添加数据&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;etcdctl put /test t1
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;OK
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;etcdctl put /test t2
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;OK
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;# 查看数据&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;etcdctl get /test
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;/test
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;t2
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;# 查看 json 格式数据&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;etcdctl get /test --write-out&lt;span style="color:#f92672"&gt;=&lt;/span&gt;json
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;# {&amp;#34;header&amp;#34;:{&amp;#34;cluster_id&amp;#34;:8735285696067307020,&amp;#34;member_id&amp;#34;:7131777314758672153,&amp;#34;revision&amp;#34;:15,&amp;#34;raft_term&amp;#34;:4},&amp;#34;kvs&amp;#34;:[{&amp;#34;key&amp;#34;:&amp;#34;L3Rlc3Q=&amp;#34;,&amp;#34;create_revision&amp;#34;:14,&amp;#34;mod_revision&amp;#34;:15,&amp;#34;version&amp;#34;:2,&amp;#34;value&amp;#34;:&amp;#34;dDI=&amp;#34;}],&amp;#34;count&amp;#34;:1}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;# 查看历史版本&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;etcdctl get /test --rev&lt;span style="color:#f92672"&gt;=&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;14&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;/test
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;t1
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;可以看到，通过 &lt;code&gt;--rev&lt;/code&gt; 参数可以查看历史版本的数据。也就是我第一次添加的数据。那么 json 中 revision 是什么意思呢？&lt;/p&gt;
&lt;h2 id="revision"&gt;revision&lt;/h2&gt;
&lt;p&gt;reversion 中是 etcd 中的一个概念，它是一个递增的整数，用于标识 etcd 中的数据版本。他是一个 int64 类型。没操作一次 etcd 数据（增，删，改），reversion 就会递增。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-BASH" data-lang="BASH"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;# 删除数据&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;etcdctl del /test
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#ae81ff"&gt;1&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;# 查看 revision&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;etcdctl get / -wjson
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;# {&amp;#34;header&amp;#34;:{&amp;#34;cluster_id&amp;#34;:8735285696067307020,&amp;#34;member_id&amp;#34;:7131777314758672153,&amp;#34;revision&amp;#34;:16,&amp;#34;raft_term&amp;#34;:4}}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;# 刚才是 15 现在是 16&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;# 添加 /test2 数据&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;etcdctl put /test2 t3
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;OK
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;# 查看 revision&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;etcdctl get / -wjson
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;# {&amp;#34;header&amp;#34;:{&amp;#34;cluster_id&amp;#34;:8735285696067307020,&amp;#34;member_id&amp;#34;:7131777314758672153,&amp;#34;revision&amp;#34;:17,&amp;#34;raft_term&amp;#34;:4}}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id="存储结构"&gt;存储结构&lt;/h2&gt;
&lt;p&gt;etcd mvcc 中，维护了两个数据结构，分别是 treeindex 和 &lt;a href="https://github.com/etcd-io/bbolt.git"&gt;boltDB&lt;/a&gt;。treeindex 是一个 B 树，用于存储 key 和 revision 之间的映射关系，它主要维护在内存中。而 boltDB 是一个 key-value 数据库，用于存储 key 和 value 之间的映射关系, 它主要维护在磁盘中, 用于持久化数据，虽然 boltdb 使用了 mmap 机制，但是它还是一个磁盘数据库。&lt;/p&gt;</description><content:encoded><![CDATA[<h2 id="什么是-mvcc">什么是 MVCC</h2>
<p>MVCC 是 Multi-Version Concurrency Control 的缩写，即多版本并发控制。它是一种并发控制的方法，用于在数据库系统中实现事务的隔离性。MVCC 是一种乐观锁机制，它通过保存数据的多个版本来实现事务的隔禽性。在 etcd 中，MVCC 是用于实现数据的版本控制的。而且可以查看历史版本的数据。</p>
<h2 id="测试">测试</h2>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-BASH" data-lang="BASH"><span style="display:flex;"><span><span style="color:#75715e"># 添加数据</span>
</span></span><span style="display:flex;"><span>etcdctl put /test t1
</span></span><span style="display:flex;"><span>OK
</span></span><span style="display:flex;"><span>etcdctl put /test t2
</span></span><span style="display:flex;"><span>OK
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看数据</span>
</span></span><span style="display:flex;"><span>etcdctl get /test
</span></span><span style="display:flex;"><span>/test
</span></span><span style="display:flex;"><span>t2
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看 json 格式数据</span>
</span></span><span style="display:flex;"><span>etcdctl get /test --write-out<span style="color:#f92672">=</span>json
</span></span><span style="display:flex;"><span><span style="color:#75715e"># {&#34;header&#34;:{&#34;cluster_id&#34;:8735285696067307020,&#34;member_id&#34;:7131777314758672153,&#34;revision&#34;:15,&#34;raft_term&#34;:4},&#34;kvs&#34;:[{&#34;key&#34;:&#34;L3Rlc3Q=&#34;,&#34;create_revision&#34;:14,&#34;mod_revision&#34;:15,&#34;version&#34;:2,&#34;value&#34;:&#34;dDI=&#34;}],&#34;count&#34;:1}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看历史版本</span>
</span></span><span style="display:flex;"><span>etcdctl get /test --rev<span style="color:#f92672">=</span><span style="color:#ae81ff">14</span>
</span></span><span style="display:flex;"><span>/test
</span></span><span style="display:flex;"><span>t1
</span></span></code></pre></div><p>可以看到，通过 <code>--rev</code> 参数可以查看历史版本的数据。也就是我第一次添加的数据。那么 json 中 revision 是什么意思呢？</p>
<h2 id="revision">revision</h2>
<p>reversion 中是 etcd 中的一个概念，它是一个递增的整数，用于标识 etcd 中的数据版本。他是一个 int64 类型。没操作一次 etcd 数据（增，删，改），reversion 就会递增。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-BASH" data-lang="BASH"><span style="display:flex;"><span><span style="color:#75715e"># 删除数据</span>
</span></span><span style="display:flex;"><span>etcdctl del /test
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看 revision</span>
</span></span><span style="display:flex;"><span>etcdctl get / -wjson
</span></span><span style="display:flex;"><span><span style="color:#75715e"># {&#34;header&#34;:{&#34;cluster_id&#34;:8735285696067307020,&#34;member_id&#34;:7131777314758672153,&#34;revision&#34;:16,&#34;raft_term&#34;:4}}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 刚才是 15 现在是 16</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 添加 /test2 数据</span>
</span></span><span style="display:flex;"><span>etcdctl put /test2 t3
</span></span><span style="display:flex;"><span>OK
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看 revision</span>
</span></span><span style="display:flex;"><span>etcdctl get / -wjson
</span></span><span style="display:flex;"><span><span style="color:#75715e"># {&#34;header&#34;:{&#34;cluster_id&#34;:8735285696067307020,&#34;member_id&#34;:7131777314758672153,&#34;revision&#34;:17,&#34;raft_term&#34;:4}}</span>
</span></span></code></pre></div><h2 id="存储结构">存储结构</h2>
<p>etcd mvcc 中，维护了两个数据结构，分别是 treeindex 和 <a href="https://github.com/etcd-io/bbolt.git">boltDB</a>。treeindex 是一个 B 树，用于存储 key 和 revision 之间的映射关系，它主要维护在内存中。而 boltDB 是一个 key-value 数据库，用于存储 key 和 value 之间的映射关系, 它主要维护在磁盘中, 用于持久化数据，虽然 boltdb 使用了 mmap 机制，但是它还是一个磁盘数据库。</p>
<h3 id="treeindex">treeindex</h3>
<p><strong>为什么 etcd 的 treeindex 使用 B-tree 而不使用哈希表、平衡二叉树？</strong></p>
<p>因为 etcd 需要范围查询，所以哈希表不适合。而且etcd 中的 key 过多，平衡二叉树的查询效率不高，所以使用 B tree。</p>
<p>b-tree:</p>
<p><img src="/images/97246cb8-633b-4ee2-a1a1-2ef0b4a059a4.png" alt=""></p>
<p>在 treeindex 中，数据的每个 key 是一个 keyIndex 结构，它保存了 key 和 revision 之间的映射关系。keyIndex 结构如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-GO" data-lang="GO"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">keyIndex</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">key</span>         <span style="color:#111">[]</span><span style="color:#00a8c8">byte</span> <span style="color:#75715e">// key 的值</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">modified</span>    <span style="color:#75af00">Revision</span> <span style="color:#75715e">// 最后一次修改的 main revision</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">generations</span> <span style="color:#111">[]</span><span style="color:#75af00">generation</span> <span style="color:#75715e">// 保存了 key 的历史版本 没删除一次然后添加一次就是一个 generation</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Revision</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 就是 revision 的值，比如上边的 15 等</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Main</span> <span style="color:#00a8c8">int64</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 子 revision 的值 主要是在事务中使用 比如事务中多个操作 那么就是 0 1 2 3 等</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Sub</span> <span style="color:#00a8c8">int64</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// generation 保存了 key 的历史版本</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">generation</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ver</span>     <span style="color:#00a8c8">int64</span> <span style="color:#75715e">// 版本号</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">created</span> <span style="color:#75af00">Revision</span> <span style="color:#75715e">// 最后一次被创建的 revision</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">revs</span>    <span style="color:#111">[]</span><span style="color:#75af00">Revision</span> <span style="color:#75715e">// 保存了 key 的历史 revision</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>在 treeindex 中，每个 keyIndex 保存了 key 的历史版本，而且每个 keyIndex 中的 generations 保存了 key 的历史版本。而且每个 generation 中的 revs 保存了 key 的历史 revision。这样就可以实现历史版本的查询。</p>
<p><strong>获取 resersion 的值</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-GO" data-lang="GO"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">ti</span> <span style="color:#f92672">*</span><span style="color:#75af00">treeIndex</span><span style="color:#111">)</span> <span style="color:#75af00">Get</span><span style="color:#111">(</span><span style="color:#75af00">key</span> <span style="color:#111">[]</span><span style="color:#00a8c8">byte</span><span style="color:#111">,</span> <span style="color:#75af00">atRev</span> <span style="color:#00a8c8">int64</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#75af00">modified</span><span style="color:#111">,</span> <span style="color:#75af00">created</span> <span style="color:#75af00">Revision</span><span style="color:#111">,</span> <span style="color:#75af00">ver</span> <span style="color:#00a8c8">int64</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ti</span><span style="color:#111">.</span><span style="color:#75af00">RLock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">ti</span><span style="color:#111">.</span><span style="color:#75af00">RUnlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">ti</span><span style="color:#111">.</span><span style="color:#75af00">unsafeGet</span><span style="color:#111">(</span><span style="color:#75af00">key</span><span style="color:#111">,</span> <span style="color:#75af00">atRev</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">ti</span> <span style="color:#f92672">*</span><span style="color:#75af00">treeIndex</span><span style="color:#111">)</span> <span style="color:#75af00">unsafeGet</span><span style="color:#111">(</span><span style="color:#75af00">key</span> <span style="color:#111">[]</span><span style="color:#00a8c8">byte</span><span style="color:#111">,</span> <span style="color:#75af00">atRev</span> <span style="color:#00a8c8">int64</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#75af00">modified</span><span style="color:#111">,</span> <span style="color:#75af00">created</span> <span style="color:#75af00">Revision</span><span style="color:#111">,</span> <span style="color:#75af00">ver</span> <span style="color:#00a8c8">int64</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">keyi</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">keyIndex</span><span style="color:#111">{</span><span style="color:#75af00">key</span><span style="color:#111">:</span> <span style="color:#75af00">key</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 从 B 树中获取 keyIndex</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">keyi</span> <span style="color:#111">=</span> <span style="color:#75af00">ti</span><span style="color:#111">.</span><span style="color:#75af00">keyIndex</span><span style="color:#111">(</span><span style="color:#75af00">keyi</span><span style="color:#111">);</span> <span style="color:#75af00">keyi</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">Revision</span><span style="color:#111">{},</span> <span style="color:#75af00">Revision</span><span style="color:#111">{},</span> <span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#75af00">ErrRevisionNotFound</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 从 keyIndex 中获取 revision</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">keyi</span><span style="color:#111">.</span><span style="color:#75af00">get</span><span style="color:#111">(</span><span style="color:#75af00">ti</span><span style="color:#111">.</span><span style="color:#75af00">lg</span><span style="color:#111">,</span> <span style="color:#75af00">atRev</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">ti</span> <span style="color:#f92672">*</span><span style="color:#75af00">treeIndex</span><span style="color:#111">)</span> <span style="color:#75af00">keyIndex</span><span style="color:#111">(</span><span style="color:#75af00">keyi</span> <span style="color:#f92672">*</span><span style="color:#75af00">keyIndex</span><span style="color:#111">)</span> <span style="color:#f92672">*</span><span style="color:#75af00">keyIndex</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">ki</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">ti</span><span style="color:#111">.</span><span style="color:#75af00">tree</span><span style="color:#111">.</span><span style="color:#75af00">Get</span><span style="color:#111">(</span><span style="color:#75af00">keyi</span><span style="color:#111">);</span> <span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">ki</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-GO" data-lang="GO"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">ki</span> <span style="color:#f92672">*</span><span style="color:#75af00">keyIndex</span><span style="color:#111">)</span> <span style="color:#75af00">get</span><span style="color:#111">(</span><span style="color:#75af00">lg</span> <span style="color:#f92672">*</span><span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">Logger</span><span style="color:#111">,</span> <span style="color:#75af00">atRev</span> <span style="color:#00a8c8">int64</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#75af00">modified</span><span style="color:#111">,</span> <span style="color:#75af00">created</span> <span style="color:#75af00">Revision</span><span style="color:#111">,</span> <span style="color:#75af00">ver</span> <span style="color:#00a8c8">int64</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">ki</span><span style="color:#111">.</span><span style="color:#75af00">isEmpty</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">lg</span><span style="color:#111">.</span><span style="color:#75af00">Panic</span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>			<span style="color:#d88200">&#34;&#39;get&#39; got an unexpected empty keyIndex&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">String</span><span style="color:#111">(</span><span style="color:#d88200">&#34;key&#34;</span><span style="color:#111">,</span> <span style="color:#111">string</span><span style="color:#111">(</span><span style="color:#75af00">ki</span><span style="color:#111">.</span><span style="color:#75af00">key</span><span style="color:#111">)),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 找到 key 的 generation</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">g</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">ki</span><span style="color:#111">.</span><span style="color:#75af00">findGeneration</span><span style="color:#111">(</span><span style="color:#75af00">atRev</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">isEmpty</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">Revision</span><span style="color:#111">{},</span> <span style="color:#75af00">Revision</span><span style="color:#111">{},</span> <span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#75af00">ErrRevisionNotFound</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 从 generation 中获取 revision 找到第一次小于 atRev 的 revision</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">n</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">walk</span><span style="color:#111">(</span><span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">rev</span> <span style="color:#75af00">Revision</span><span style="color:#111">)</span> <span style="color:#00a8c8">bool</span> <span style="color:#111">{</span> <span style="color:#00a8c8">return</span> <span style="color:#75af00">rev</span><span style="color:#111">.</span><span style="color:#75af00">Main</span> <span style="color:#111">&gt;</span> <span style="color:#75af00">atRev</span> <span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">n</span> <span style="color:#f92672">!=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">revs</span><span style="color:#111">[</span><span style="color:#75af00">n</span><span style="color:#111">],</span> <span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">created</span><span style="color:#111">,</span> <span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">ver</span> <span style="color:#f92672">-</span> <span style="color:#111">int64</span><span style="color:#111">(</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">revs</span><span style="color:#111">)</span><span style="color:#f92672">-</span><span style="color:#75af00">n</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">),</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">Revision</span><span style="color:#111">{},</span> <span style="color:#75af00">Revision</span><span style="color:#111">{},</span> <span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#75af00">ErrRevisionNotFound</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 基本的意思就是从后往前找到第一个 revision 小于 atRev 的 generation</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">ki</span> <span style="color:#f92672">*</span><span style="color:#75af00">keyIndex</span><span style="color:#111">)</span> <span style="color:#75af00">findGeneration</span><span style="color:#111">(</span><span style="color:#75af00">rev</span> <span style="color:#00a8c8">int64</span><span style="color:#111">)</span> <span style="color:#f92672">*</span><span style="color:#75af00">generation</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">lastg</span> <span style="color:#f92672">:=</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">ki</span><span style="color:#111">.</span><span style="color:#75af00">generations</span><span style="color:#111">)</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">cg</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">lastg</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">cg</span> <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">ki</span><span style="color:#111">.</span><span style="color:#75af00">generations</span><span style="color:#111">[</span><span style="color:#75af00">cg</span><span style="color:#111">].</span><span style="color:#75af00">revs</span><span style="color:#111">)</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">cg</span><span style="color:#f92672">--</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">continue</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">g</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">ki</span><span style="color:#111">.</span><span style="color:#75af00">generations</span><span style="color:#111">[</span><span style="color:#75af00">cg</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">cg</span> <span style="color:#f92672">!=</span> <span style="color:#75af00">lastg</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 如果当前 generation 的最后一个 revision 小于等于 rev 那么就返回 nil</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">tomb</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">revs</span><span style="color:#111">[</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">revs</span><span style="color:#111">)</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">].</span><span style="color:#75af00">Main</span><span style="color:#111">;</span> <span style="color:#75af00">tomb</span> <span style="color:#f92672">&lt;=</span> <span style="color:#75af00">rev</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">revs</span><span style="color:#111">[</span><span style="color:#ae81ff">0</span><span style="color:#111">].</span><span style="color:#75af00">Main</span> <span style="color:#f92672">&lt;=</span> <span style="color:#75af00">rev</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">ki</span><span style="color:#111">.</span><span style="color:#75af00">generations</span><span style="color:#111">[</span><span style="color:#75af00">cg</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">cg</span><span style="color:#f92672">--</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// walk 从后往前遍历 generation</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">g</span> <span style="color:#f92672">*</span><span style="color:#75af00">generation</span><span style="color:#111">)</span> <span style="color:#75af00">walk</span><span style="color:#111">(</span><span style="color:#75af00">f</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">rev</span> <span style="color:#75af00">Revision</span><span style="color:#111">)</span> <span style="color:#00a8c8">bool</span><span style="color:#111">)</span> <span style="color:#00a8c8">int</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">l</span> <span style="color:#f92672">:=</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">revs</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">i</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">revs</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">f</span><span style="color:#111">(</span><span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">revs</span><span style="color:#111">[</span><span style="color:#75af00">l</span><span style="color:#f92672">-</span><span style="color:#75af00">i</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">])</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#75af00">l</span> <span style="color:#f92672">-</span> <span style="color:#75af00">i</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="boltdb">boltdb</h3>
<p>上边的 treeindex 拿到 revision 之后，并没有拿到 value，那么如何拿到 value 呢？这就需要用到 boltdb 了。boltdb 是一个 key-value 数据库，用于存储 key 和 value 之间的映射关系。在 etcd 中，boltdb 主要用于持久化数据。
在 etcd 中，boltdb 报错的不是 etcd key-value 数据，而他的 ket 是 revision，value 是元数据。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-GO" data-lang="GO"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">tr</span> <span style="color:#f92672">*</span><span style="color:#75af00">storeTxnCommon</span><span style="color:#111">)</span> <span style="color:#75af00">rangeKeys</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">,</span> <span style="color:#75af00">key</span><span style="color:#111">,</span> <span style="color:#75af00">end</span> <span style="color:#111">[]</span><span style="color:#00a8c8">byte</span><span style="color:#111">,</span> <span style="color:#75af00">curRev</span> <span style="color:#00a8c8">int64</span><span style="color:#111">,</span> <span style="color:#75af00">ro</span> <span style="color:#75af00">RangeOptions</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">RangeResult</span><span style="color:#111">,</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">rev</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">ro</span><span style="color:#111">.</span><span style="color:#75af00">Rev</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 如果 rev 大于当前的 revision 那么就返回 ErrFutureRev</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">rev</span> <span style="color:#111">&gt;</span> <span style="color:#75af00">curRev</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">RangeResult</span><span style="color:#111">{</span><span style="color:#75af00">KVs</span><span style="color:#111">:</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">Count</span><span style="color:#111">:</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">,</span> <span style="color:#75af00">Rev</span><span style="color:#111">:</span> <span style="color:#75af00">curRev</span><span style="color:#111">},</span> <span style="color:#75af00">ErrFutureRev</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 如果 rev 小于等于 0 那么就是当前的 revision</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">rev</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">rev</span> <span style="color:#111">=</span> <span style="color:#75af00">curRev</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 如果 rev 小于 compactMainRev 那么就返回 ErrCompacted</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">rev</span> <span style="color:#111">&lt;</span> <span style="color:#75af00">tr</span><span style="color:#111">.</span><span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">compactMainRev</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">RangeResult</span><span style="color:#111">{</span><span style="color:#75af00">KVs</span><span style="color:#111">:</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">Count</span><span style="color:#111">:</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">,</span> <span style="color:#75af00">Rev</span><span style="color:#111">:</span> <span style="color:#ae81ff">0</span><span style="color:#111">},</span> <span style="color:#75af00">ErrCompacted</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 如果 re.Count 代表 count 操作 查出来直接返回数量就可以了 不需要在查 value</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">ro</span><span style="color:#111">.</span><span style="color:#75af00">Count</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">total</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">tr</span><span style="color:#111">.</span><span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">kvindex</span><span style="color:#111">.</span><span style="color:#75af00">CountRevisions</span><span style="color:#111">(</span><span style="color:#75af00">key</span><span style="color:#111">,</span> <span style="color:#75af00">end</span><span style="color:#111">,</span> <span style="color:#75af00">rev</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">tr</span><span style="color:#111">.</span><span style="color:#75af00">trace</span><span style="color:#111">.</span><span style="color:#75af00">Step</span><span style="color:#111">(</span><span style="color:#d88200">&#34;count revisions from in-memory index tree&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">RangeResult</span><span style="color:#111">{</span><span style="color:#75af00">KVs</span><span style="color:#111">:</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">Count</span><span style="color:#111">:</span> <span style="color:#75af00">total</span><span style="color:#111">,</span> <span style="color:#75af00">Rev</span><span style="color:#111">:</span> <span style="color:#75af00">curRev</span><span style="color:#111">},</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 查好需要的 revision 之后，从 boltdb 中查出 value ，revpairs 是从 treeindex 中查出来的 revisions</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">revpairs</span><span style="color:#111">,</span> <span style="color:#75af00">total</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">tr</span><span style="color:#111">.</span><span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">kvindex</span><span style="color:#111">.</span><span style="color:#75af00">Revisions</span><span style="color:#111">(</span><span style="color:#75af00">key</span><span style="color:#111">,</span> <span style="color:#75af00">end</span><span style="color:#111">,</span> <span style="color:#75af00">rev</span><span style="color:#111">,</span> <span style="color:#111">int</span><span style="color:#111">(</span><span style="color:#75af00">ro</span><span style="color:#111">.</span><span style="color:#75af00">Limit</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">tr</span><span style="color:#111">.</span><span style="color:#75af00">trace</span><span style="color:#111">.</span><span style="color:#75af00">Step</span><span style="color:#111">(</span><span style="color:#d88200">&#34;range keys from in-memory index tree&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">revpairs</span><span style="color:#111">)</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">RangeResult</span><span style="color:#111">{</span><span style="color:#75af00">KVs</span><span style="color:#111">:</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">Count</span><span style="color:#111">:</span> <span style="color:#75af00">total</span><span style="color:#111">,</span> <span style="color:#75af00">Rev</span><span style="color:#111">:</span> <span style="color:#75af00">curRev</span><span style="color:#111">},</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">limit</span> <span style="color:#f92672">:=</span> <span style="color:#111">int</span><span style="color:#111">(</span><span style="color:#75af00">ro</span><span style="color:#111">.</span><span style="color:#75af00">Limit</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">limit</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">||</span> <span style="color:#75af00">limit</span> <span style="color:#111">&gt;</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">revpairs</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">limit</span> <span style="color:#111">=</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">revpairs</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">kvs</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">([]</span><span style="color:#75af00">mvccpb</span><span style="color:#111">.</span><span style="color:#75af00">KeyValue</span><span style="color:#111">,</span> <span style="color:#75af00">limit</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">revBytes</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">NewRevBytes</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 对于每个 revision 从 boltdb 中查出 value</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">i</span><span style="color:#111">,</span> <span style="color:#75af00">revpair</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">revpairs</span><span style="color:#111">[:</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">kvs</span><span style="color:#111">)]</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">select</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#75af00">ctx</span><span style="color:#111">.</span><span style="color:#75af00">Done</span><span style="color:#111">():</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;rangeKeys: context cancelled: %w&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">ctx</span><span style="color:#111">.</span><span style="color:#75af00">Err</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">default</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 把 revision 转换成 bytes</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">revBytes</span> <span style="color:#111">=</span> <span style="color:#75af00">RevToBytes</span><span style="color:#111">(</span><span style="color:#75af00">revpair</span><span style="color:#111">,</span> <span style="color:#75af00">revBytes</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 从 boltdb 中查出 value</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">vs</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">tr</span><span style="color:#111">.</span><span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">UnsafeRange</span><span style="color:#111">(</span><span style="color:#75af00">schema</span><span style="color:#111">.</span><span style="color:#75af00">Key</span><span style="color:#111">,</span> <span style="color:#75af00">revBytes</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#ae81ff">0</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">vs</span><span style="color:#111">)</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">1</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">tr</span><span style="color:#111">.</span><span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">lg</span><span style="color:#111">.</span><span style="color:#75af00">Fatal</span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>				<span style="color:#d88200">&#34;range failed to find revision pair&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">Int64</span><span style="color:#111">(</span><span style="color:#d88200">&#34;revision-main&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">revpair</span><span style="color:#111">.</span><span style="color:#75af00">Main</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">Int64</span><span style="color:#111">(</span><span style="color:#d88200">&#34;revision-sub&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">revpair</span><span style="color:#111">.</span><span style="color:#75af00">Sub</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">Int64</span><span style="color:#111">(</span><span style="color:#d88200">&#34;revision-current&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">curRev</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">Int64</span><span style="color:#111">(</span><span style="color:#d88200">&#34;range-option-rev&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">ro</span><span style="color:#111">.</span><span style="color:#75af00">Rev</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">Int64</span><span style="color:#111">(</span><span style="color:#d88200">&#34;range-option-limit&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">ro</span><span style="color:#111">.</span><span style="color:#75af00">Limit</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">Binary</span><span style="color:#111">(</span><span style="color:#d88200">&#34;key&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">key</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">Binary</span><span style="color:#111">(</span><span style="color:#d88200">&#34;end&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">end</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">Int</span><span style="color:#111">(</span><span style="color:#d88200">&#34;len-revpairs&#34;</span><span style="color:#111">,</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">revpairs</span><span style="color:#111">)),</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">Int</span><span style="color:#111">(</span><span style="color:#d88200">&#34;len-values&#34;</span><span style="color:#111">,</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">vs</span><span style="color:#111">)),</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 把 value 转换成 mvccpb.KeyValue</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">kvs</span><span style="color:#111">[</span><span style="color:#75af00">i</span><span style="color:#111">].</span><span style="color:#75af00">Unmarshal</span><span style="color:#111">(</span><span style="color:#75af00">vs</span><span style="color:#111">[</span><span style="color:#ae81ff">0</span><span style="color:#111">]);</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">tr</span><span style="color:#111">.</span><span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">lg</span><span style="color:#111">.</span><span style="color:#75af00">Fatal</span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>				<span style="color:#d88200">&#34;failed to unmarshal mvccpb.KeyValue&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">Error</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">tr</span><span style="color:#111">.</span><span style="color:#75af00">trace</span><span style="color:#111">.</span><span style="color:#75af00">Step</span><span style="color:#111">(</span><span style="color:#d88200">&#34;range keys from bolt db&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">RangeResult</span><span style="color:#111">{</span><span style="color:#75af00">KVs</span><span style="color:#111">:</span> <span style="color:#75af00">kvs</span><span style="color:#111">,</span> <span style="color:#75af00">Count</span><span style="color:#111">:</span> <span style="color:#75af00">total</span><span style="color:#111">,</span> <span style="color:#75af00">Rev</span><span style="color:#111">:</span> <span style="color:#75af00">curRev</span><span style="color:#111">},</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// boltdb 的 key 结构 </span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">BucketKey</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Revision</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 墓碑标志 当删除的时候 先标记一下</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">tombstone</span> <span style="color:#00a8c8">bool</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-GO" data-lang="GO"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">baseReadTx</span> <span style="color:#f92672">*</span><span style="color:#75af00">baseReadTx</span><span style="color:#111">)</span> <span style="color:#75af00">UnsafeRange</span><span style="color:#111">(</span><span style="color:#75af00">bucketType</span> <span style="color:#75af00">Bucket</span><span style="color:#111">,</span> <span style="color:#75af00">key</span><span style="color:#111">,</span> <span style="color:#75af00">endKey</span> <span style="color:#111">[]</span><span style="color:#00a8c8">byte</span><span style="color:#111">,</span> <span style="color:#75af00">limit</span> <span style="color:#00a8c8">int64</span><span style="color:#111">)</span> <span style="color:#111">([][]</span><span style="color:#00a8c8">byte</span><span style="color:#111">,</span> <span style="color:#111">[][]</span><span style="color:#00a8c8">byte</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">endKey</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// forbid duplicates for single keys</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">limit</span> <span style="color:#111">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">limit</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">limit</span> <span style="color:#111">=</span> <span style="color:#75af00">math</span><span style="color:#111">.</span><span style="color:#75af00">MaxInt64</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">limit</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#111">!</span><span style="color:#75af00">bucketType</span><span style="color:#111">.</span><span style="color:#75af00">IsSafeRangeBucket</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#d88200">&#34;do not use unsafeRange on non-keys bucket&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 从缓存中拿出数据</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">keys</span><span style="color:#111">,</span> <span style="color:#75af00">vals</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">baseReadTx</span><span style="color:#111">.</span><span style="color:#75af00">buf</span><span style="color:#111">.</span><span style="color:#75af00">Range</span><span style="color:#111">(</span><span style="color:#75af00">bucketType</span><span style="color:#111">,</span> <span style="color:#75af00">key</span><span style="color:#111">,</span> <span style="color:#75af00">endKey</span><span style="color:#111">,</span> <span style="color:#75af00">limit</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#111">int64</span><span style="color:#111">(</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">keys</span><span style="color:#111">))</span> <span style="color:#f92672">==</span> <span style="color:#75af00">limit</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">keys</span><span style="color:#111">,</span> <span style="color:#75af00">vals</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// find/cache bucket</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">bn</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">bucketType</span><span style="color:#111">.</span><span style="color:#75af00">ID</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">baseReadTx</span><span style="color:#111">.</span><span style="color:#75af00">txMu</span><span style="color:#111">.</span><span style="color:#75af00">RLock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">bucket</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">baseReadTx</span><span style="color:#111">.</span><span style="color:#75af00">buckets</span><span style="color:#111">[</span><span style="color:#75af00">bn</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">baseReadTx</span><span style="color:#111">.</span><span style="color:#75af00">txMu</span><span style="color:#111">.</span><span style="color:#75af00">RUnlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">lockHeld</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">false</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">baseReadTx</span><span style="color:#111">.</span><span style="color:#75af00">txMu</span><span style="color:#111">.</span><span style="color:#75af00">Lock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">lockHeld</span> <span style="color:#111">=</span> <span style="color:#00a8c8">true</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">bucket</span> <span style="color:#111">=</span> <span style="color:#75af00">baseReadTx</span><span style="color:#111">.</span><span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">Bucket</span><span style="color:#111">(</span><span style="color:#75af00">bucketType</span><span style="color:#111">.</span><span style="color:#75af00">Name</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">baseReadTx</span><span style="color:#111">.</span><span style="color:#75af00">buckets</span><span style="color:#111">[</span><span style="color:#75af00">bn</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#75af00">bucket</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ignore missing bucket since may have been created in this batch</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">bucket</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">lockHeld</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">baseReadTx</span><span style="color:#111">.</span><span style="color:#75af00">txMu</span><span style="color:#111">.</span><span style="color:#75af00">Unlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">keys</span><span style="color:#111">,</span> <span style="color:#75af00">vals</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">lockHeld</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">baseReadTx</span><span style="color:#111">.</span><span style="color:#75af00">txMu</span><span style="color:#111">.</span><span style="color:#75af00">Lock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">c</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">bucket</span><span style="color:#111">.</span><span style="color:#75af00">Cursor</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">baseReadTx</span><span style="color:#111">.</span><span style="color:#75af00">txMu</span><span style="color:#111">.</span><span style="color:#75af00">Unlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 从 boltdb 中查出数据</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">k2</span><span style="color:#111">,</span> <span style="color:#75af00">v2</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">unsafeRange</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">,</span> <span style="color:#75af00">key</span><span style="color:#111">,</span> <span style="color:#75af00">endKey</span><span style="color:#111">,</span> <span style="color:#75af00">limit</span><span style="color:#f92672">-</span><span style="color:#111">int64</span><span style="color:#111">(</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">keys</span><span style="color:#111">)))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">k2</span><span style="color:#111">,</span> <span style="color:#75af00">keys</span><span style="color:#f92672">...</span><span style="color:#111">),</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">v2</span><span style="color:#111">,</span> <span style="color:#75af00">vals</span><span style="color:#f92672">...</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="流程">流程</h2>
<ol>
<li>用户通过 <code>etcdctl get /b</code> 命令获取数据</li>
<li>etcd 通过 treeindex 获取 key 的 revision 信息 <code>{man: 19, sub: 0}</code></li>
<li>etcd 通过 key = <code>{man: 19, sub: 0, tombstone: false}</code> 从 boltdb 中获取 value 值 他是一个protobuf 序列化的数据</li>
<li>etcd 将 value 值反序列化成 mvccpb.KeyValue</li>
<li>etcd 将 mvccpb.KeyValue 返回给用户</li>
</ol>
<p><img src="/images/658af763-0bf3-4af0-b7c9-3da26ed87db3.png" alt=""></p>
]]></content:encoded><category>cloud</category><category>boltdb</category><category>etcd</category><category>golang</category><category>数据库</category><category>kubernetes</category></item><item><title>boltdb 介绍</title><link>https://daemon365.dev/post/cloud/boltdb_basics/</link><pubDate>Wed, 08 May 2024 20:56:00 +0800</pubDate><guid>https://daemon365.dev/post/cloud/boltdb_basics/</guid><description>&lt;h2 id="介绍"&gt;介绍&lt;/h2&gt;
&lt;p&gt;&lt;code&gt;BoltDB&lt;/code&gt; 是一个用 Go 语言编写的嵌入式键/值数据库。以下是关于 BoltDB 的一些基本介绍：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;键/值存储&lt;/strong&gt;: BoltDB 为应用程序提供了简单的键/值存储接口。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;事务&lt;/strong&gt;: BoltDB 支持完整的 ACID 事务。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;嵌入式&lt;/strong&gt;: 与像 MySQL 或 PostgreSQL 这样的数据库系统不同，BoltDB 不运行在单独的服务器进程中。它作为一个库被直接嵌入到你的应用程序中。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;单文件存储&lt;/strong&gt;: 所有的数据都存储在一个文件中，这使得备份和迁移变得简单。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;高效的二进制存储&lt;/strong&gt;: 数据在磁盘上使用 B+ 树结构存储，这为随机读取提供了高性能。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;前缀扫描&lt;/strong&gt;: 可以很容易地按键的前缀进行扫描，这使得它适用于范围查询。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;没有外部依赖&lt;/strong&gt;: BoltDB 不依赖于任何外部系统或库。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;线程安全&lt;/strong&gt;: BoltDB 是线程安全的，可以在多个 goroutines 中并发地使用。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;BoltDB 特别适用于需要一个轻量级、高性能、易于部署和维护的数据库解决方案的场景。&lt;/p&gt;
&lt;p&gt;虽然 BoltDB 非常有用，但它也有其局限性。例如，它不支持分布式存储，也不适用于需要多节点复制或分片的场景。但对于许多应用程序，它提供了一个简单且高性能的存储解决方案。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;源码地址：&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href="https://github.com/boltdb/bolt"&gt;https://github.com/boltdb/bolt&lt;/a&gt; 这个项目已经不维护了, &lt;a href="https://etcd.io/"&gt;etcd&lt;/a&gt; 官方维护了一个 fork 库，api 是互通的: &lt;a href="https://github.com/etcd-io/bbolt"&gt;https://github.com/etcd-io/bbolt&lt;/a&gt;&lt;/p&gt;
&lt;h2 id="谁在使用"&gt;谁在使用&lt;/h2&gt;
&lt;p&gt;&lt;a href="https://github.com/etcd-io/etcd"&gt;etcd&lt;/a&gt;、&lt;a href="https://github.com/pingcap/tidb"&gt;tidb&lt;/a&gt;、&lt;a href="https://github.com/influxdata/influxdb"&gt;influxdb&lt;/a&gt;、&lt;a href="https://github.com/hashicorp/consul"&gt;consul&lt;/a&gt; &amp;hellip;&amp;hellip;&lt;/p&gt;
&lt;h2 id="架构图"&gt;架构图&lt;/h2&gt;
&lt;p&gt;&lt;img src="https://daemon365.dev/images/6f10d17d-ca52-4fd0-a600-e92a9fc99d36.png" alt="boltdb"&gt;&lt;/p&gt;
&lt;h2 id="引入"&gt;引入&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;go get go.etcd.io/bbolt
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id="使用"&gt;使用&lt;/h2&gt;
&lt;h3 id="open--a-database"&gt;open a database&lt;/h3&gt;
&lt;p&gt;Bolt 中的顶级对象是 DB。它在你的硬盘上表示为一个单独的文件，并代表了你数据的一个一致性快照。&lt;/p&gt;
&lt;p&gt;要打开你的数据库，只需使用 &lt;code&gt;bolt.Open()&lt;/code&gt; 函数：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-GO" data-lang="GO"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;package&lt;/span&gt; &lt;span style="color:#75af00"&gt;main&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;import&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;log&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;bolt&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;go.etcd.io/bbolt&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;main&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;db&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;bolt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Open&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;my.db&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;0600&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;!=&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;log&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Fatal&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;err&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;defer&lt;/span&gt; &lt;span style="color:#75af00"&gt;db&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Close&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;请注意，Bolt 在数据文件上获得一个文件锁，因此多个进程不能同时打开同一个数据库。打开一个已经打开的 Bolt 数据库会导致它挂起，直到另一个进程关闭它。为了防止无限期的等待，你可以向 &lt;code&gt;Open()&lt;/code&gt; 函数传递一个超时选项：&lt;/p&gt;</description><content:encoded><![CDATA[<h2 id="介绍">介绍</h2>
<p><code>BoltDB</code> 是一个用 Go 语言编写的嵌入式键/值数据库。以下是关于 BoltDB 的一些基本介绍：</p>
<ul>
<li><strong>键/值存储</strong>: BoltDB 为应用程序提供了简单的键/值存储接口。</li>
<li><strong>事务</strong>: BoltDB 支持完整的 ACID 事务。</li>
<li><strong>嵌入式</strong>: 与像 MySQL 或 PostgreSQL 这样的数据库系统不同，BoltDB 不运行在单独的服务器进程中。它作为一个库被直接嵌入到你的应用程序中。</li>
<li><strong>单文件存储</strong>: 所有的数据都存储在一个文件中，这使得备份和迁移变得简单。</li>
<li><strong>高效的二进制存储</strong>: 数据在磁盘上使用 B+ 树结构存储，这为随机读取提供了高性能。</li>
<li><strong>前缀扫描</strong>: 可以很容易地按键的前缀进行扫描，这使得它适用于范围查询。</li>
<li><strong>没有外部依赖</strong>: BoltDB 不依赖于任何外部系统或库。</li>
<li><strong>线程安全</strong>: BoltDB 是线程安全的，可以在多个 goroutines 中并发地使用。</li>
</ul>
<p>BoltDB 特别适用于需要一个轻量级、高性能、易于部署和维护的数据库解决方案的场景。</p>
<p>虽然 BoltDB 非常有用，但它也有其局限性。例如，它不支持分布式存储，也不适用于需要多节点复制或分片的场景。但对于许多应用程序，它提供了一个简单且高性能的存储解决方案。</p>
<p><strong>源码地址：</strong></p>
<p><a href="https://github.com/boltdb/bolt">https://github.com/boltdb/bolt</a> 这个项目已经不维护了,  <a href="https://etcd.io/">etcd</a> 官方维护了一个 fork 库，api 是互通的: <a href="https://github.com/etcd-io/bbolt">https://github.com/etcd-io/bbolt</a></p>
<h2 id="谁在使用">谁在使用</h2>
<p><a href="https://github.com/etcd-io/etcd">etcd</a>、<a href="https://github.com/pingcap/tidb">tidb</a>、<a href="https://github.com/influxdata/influxdb">influxdb</a>、<a href="https://github.com/hashicorp/consul">consul</a> &hellip;&hellip;</p>
<h2 id="架构图">架构图</h2>
<p><img src="/images/6f10d17d-ca52-4fd0-a600-e92a9fc99d36.png" alt="boltdb"></p>
<h2 id="引入">引入</h2>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>go get go.etcd.io/bbolt 
</span></span></code></pre></div><h2 id="使用">使用</h2>
<h3 id="open--a-database">open  a database</h3>
<p>Bolt 中的顶级对象是 DB。它在你的硬盘上表示为一个单独的文件，并代表了你数据的一个一致性快照。</p>
<p>要打开你的数据库，只需使用 <code>bolt.Open()</code> 函数：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-GO" data-lang="GO"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">bolt</span> <span style="color:#d88200">&#34;go.etcd.io/bbolt&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">db</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">bolt</span><span style="color:#111">.</span><span style="color:#75af00">Open</span><span style="color:#111">(</span><span style="color:#d88200">&#34;my.db&#34;</span><span style="color:#111">,</span> <span style="color:#ae81ff">0600</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Fatal</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>请注意，Bolt 在数据文件上获得一个文件锁，因此多个进程不能同时打开同一个数据库。打开一个已经打开的 Bolt 数据库会导致它挂起，直到另一个进程关闭它。为了防止无限期的等待，你可以向 <code>Open()</code> 函数传递一个超时选项：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-GO" data-lang="GO"><span style="display:flex;"><span><span style="color:#75af00">db</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">bolt</span><span style="color:#111">.</span><span style="color:#75af00">Open</span><span style="color:#111">(</span><span style="color:#d88200">&#34;my.db&#34;</span><span style="color:#111">,</span> <span style="color:#ae81ff">0600</span><span style="color:#111">,</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">bolt</span><span style="color:#111">.</span><span style="color:#75af00">Options</span><span style="color:#111">{</span><span style="color:#75af00">Timeout</span><span style="color:#111">:</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">*</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Second</span><span style="color:#111">})</span>
</span></span></code></pre></div><h3 id="transactions">Transactions</h3>
<p>Bolt一次只允许一个读写 transactions ，但允许您一次进行多个只读 transactions 。每一个 transactions 在开始时都能看到数据的一致视图。</p>
<p>单独的 transactions 和从它们创建的所有对象（例如桶、键）都不是线程安全的。要在多个goroutines中处理数据，您必须为每一个goroutine启动一个 transactions ，或使用锁来确保一次只有一个goroutine访问一个 transactions 。从数据库创建 transactions 是线程安全的。</p>
<p>transactions 不应相互依赖，并且通常不应在同一goroutine中同时打开。这可能会导致死锁，因为读写 transactions 需要定期重新映射数据文件，但在任何只读 transactions 打开时都不能这样做。即使是嵌套的只读 transactions 也可能导致死锁，因为子 transactions 可能阻止父 transactions 释放其资源。</p>
<h4 id="read-write-transactions">Read-write transactions</h4>
<p>要开始一个读写 transactions ，可以使用DB.Update()函数：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">Update</span><span style="color:#111">(</span><span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">tx</span> <span style="color:#f92672">*</span><span style="color:#75af00">bolt</span><span style="color:#111">.</span><span style="color:#75af00">Tx</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">})</span>
</span></span></code></pre></div><p>在闭包中，您可以看到数据库的一致视图。通过在最后返回nil来提交 transactions 。您还可以通过返回错误在任何时候回滚 transactions 。所有的数据库操作都允许在一个读写 transactions 中进行。</p>
<p>始终检查返回错误，因为它会报告任何可能导致您的 transactions 未完成的磁盘故障。如果您在闭包内返回错误，它将被传递。</p>
<h4 id="read-only-transactions">Read-only transactions</h4>
<p>要开始一个只读 transactions ，您可以使用DB.View()函数：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">View</span><span style="color:#111">(</span><span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">tx</span> <span style="color:#f92672">*</span><span style="color:#75af00">bolt</span><span style="color:#111">.</span><span style="color:#75af00">Tx</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">})</span>
</span></span></code></pre></div><p>在这个闭包内，您也可以看到数据库的一致视图，但在只读 transactions 中不允许进行变动操作。在一个只读 transactions 中，您只能检索桶、检索值和复制数据库。</p>
<h4 id="batch-read-write-transactions">Batch read-write transactions</h4>
<p>每个DB.Update()都会等待磁盘提交写入。这种开销可以通过使用DB.Batch()函数结合多个更新来最小化：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">Batch</span><span style="color:#111">(</span><span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">tx</span> <span style="color:#f92672">*</span><span style="color:#75af00">bolt</span><span style="color:#111">.</span><span style="color:#75af00">Tx</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">})</span>
</span></span></code></pre></div><p>并发的Batch调用会被机会性地组合成更大的 transactions 。只有当有多个goroutines调用它时，Batch才是有用的。</p>
<p>权衡之处在于，Batch在 transactions 的部分失败时可以多次调用给定的函数。该函数必须是幂等的，且只有在成功从DB.Batch()返回后，副作用才会生效。</p>
<p>例如：不要从函数内部显示消息，而是在封闭范围内设置变量：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">var</span> <span style="color:#75af00">id</span> <span style="color:#00a8c8">uint64</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">Batch</span><span style="color:#111">(</span><span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">tx</span> <span style="color:#f92672">*</span><span style="color:#75af00">bolt</span><span style="color:#111">.</span><span style="color:#75af00">Tx</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 在桶中查找最后一个键，解码为bigendian uint64，增加</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 一个，编码回[]byte，并添加新键。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">id</span> <span style="color:#111">=</span> <span style="color:#75af00">newValue</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">})</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Allocated ID %d&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">id</span><span style="color:#111">)</span>
</span></span></code></pre></div><h4 id="managing-transactions-manually">Managing transactions manually</h4>
<p>DB.View()和DB.Update()函数是DB.Begin()函数的包装。这些助手函数将启动 transactions 、执行函数，然后在返回错误时安全地关闭您的 transactions 。这是使用Bolt transactions 的推荐方法。</p>
<p>然而，有时您可能希望手动开始和结束您的 transactions 。您可以直接使用DB.Begin()函数，但请确保关闭 transactions 。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// 开始一个可写的 transactions 。</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">tx</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">Begin</span><span style="color:#111">(</span><span style="color:#00a8c8">true</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">defer</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">Rollback</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 使用 transactions ...</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">CreateBucket</span><span style="color:#111">([]</span><span style="color:#111">byte</span><span style="color:#111">(</span><span style="color:#d88200">&#34;MyBucket&#34;</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 提交 transactions 并检查错误。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">Commit</span><span style="color:#111">();</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>DB.Begin()的第一个参数是一个布尔值，表示 transactions 是否应该是可写的。</p>
<h3 id="using-buckets">Using buckets</h3>
<p>桶是数据库中的键/值对集合。一个桶中的所有键都必须是唯一的。您可以使用Tx.CreateBucket()函数创建一个桶：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">Update</span><span style="color:#111">(</span><span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">tx</span> <span style="color:#f92672">*</span><span style="color:#75af00">bolt</span><span style="color:#111">.</span><span style="color:#75af00">Tx</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">b</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">CreateBucket</span><span style="color:#111">([]</span><span style="color:#111">byte</span><span style="color:#111">(</span><span style="color:#d88200">&#34;MyBucket&#34;</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;create bucket: %s&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">})</span>
</span></span></code></pre></div><p>您可以使用Tx.Bucket()函数检索现有的桶：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">Update</span><span style="color:#111">(</span><span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">tx</span> <span style="color:#f92672">*</span><span style="color:#75af00">bolt</span><span style="color:#111">.</span><span style="color:#75af00">Tx</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">b</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">Bucket</span><span style="color:#111">([]</span><span style="color:#111">byte</span><span style="color:#111">(</span><span style="color:#d88200">&#34;MyBucket&#34;</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">b</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;bucket does not exist&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">})</span>
</span></span></code></pre></div><p>您还可以使用Tx.CreateBucketIfNotExists()函数只在桶不存在时创建一个桶。打开数据库后，为所有的顶级桶调用此函数是一种常见的模式，这样您可以保证它们存在于未来的 transactions 中。</p>
<p>要删除一个桶，只需调用Tx.DeleteBucket()函数。</p>
<h3 id="using-keyvalue-pairs">Using key/value pairs</h3>
<p>要将键/值对保存到存储桶，使用<code>Bucket.Put()</code>函数：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">Update</span><span style="color:#111">(</span><span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">tx</span> <span style="color:#f92672">*</span><span style="color:#75af00">bolt</span><span style="color:#111">.</span><span style="color:#75af00">Tx</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">b</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">Bucket</span><span style="color:#111">([]</span><span style="color:#111">byte</span><span style="color:#111">(</span><span style="color:#d88200">&#34;MyBucket&#34;</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">Put</span><span style="color:#111">([]</span><span style="color:#111">byte</span><span style="color:#111">(</span><span style="color:#d88200">&#34;answer&#34;</span><span style="color:#111">),</span> <span style="color:#111">[]</span><span style="color:#111">byte</span><span style="color:#111">(</span><span style="color:#d88200">&#34;42&#34;</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span><span style="color:#111">})</span>
</span></span></code></pre></div><p>这会在<code>MyBucket</code>存储桶中将&quot;answer&quot;键的值设置为&quot;42&quot;。要检索此值，我们可以使用<code>Bucket.Get()</code>函数：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">View</span><span style="color:#111">(</span><span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">tx</span> <span style="color:#f92672">*</span><span style="color:#75af00">bolt</span><span style="color:#111">.</span><span style="color:#75af00">Tx</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">b</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">Bucket</span><span style="color:#111">([]</span><span style="color:#111">byte</span><span style="color:#111">(</span><span style="color:#d88200">&#34;MyBucket&#34;</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">v</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">Get</span><span style="color:#111">([]</span><span style="color:#111">byte</span><span style="color:#111">(</span><span style="color:#d88200">&#34;answer&#34;</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;The answer is: %s\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">v</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">})</span>
</span></span></code></pre></div><p><code>Get()</code>函数不返回错误，因为其操作保证可以工作（除非有某种系统故障）。如果键存在，它将返回其字节切片值。如果不存在，则返回nil。重要的是要注意，您可以将零长度的值设置为一个键，这与键不存在是不同的。</p>
<p>使用<code>Bucket.Delete()</code>函数从存储桶中删除键：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">Update</span><span style="color:#111">(</span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">tx</span> <span style="color:#f92672">*</span><span style="color:#75af00">bolt</span><span style="color:#111">.</span><span style="color:#75af00">Tx</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">b</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">Bucket</span><span style="color:#111">([]</span><span style="color:#111">byte</span><span style="color:#111">(</span><span style="color:#d88200">&#34;MyBucket&#34;</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">Delete</span><span style="color:#111">([]</span><span style="color:#111">byte</span><span style="color:#111">(</span><span style="color:#d88200">&#34;answer&#34;</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span><span style="color:#111">})</span>
</span></span></code></pre></div><p>这将从<code>MyBucket</code>存储桶中删除答案键。</p>
<p>请注意，从<code>Get()</code>返回的值只在事务打开时有效。如果您需要在事务外部使用值，则必须使用<code>copy()</code>将其复制到另一个字节切片。</p>
<h3 id="autoincrementing-integer-for-the-bucket">Autoincrementing integer for the bucket</h3>
<p>通过使用<code>NextSequence()</code>函数，您可以让Bolt确定一个序列，该序列可以用作键/值对的唯一标识符。请参阅下面的示例。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-GO" data-lang="GO"><span style="display:flex;"><span><span style="color:#75715e">// CreateUser saves u to the store. The new user ID is set on u once the data is persisted.</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">s</span> <span style="color:#f92672">*</span><span style="color:#75af00">Store</span><span style="color:#111">)</span> <span style="color:#75af00">CreateUser</span><span style="color:#111">(</span><span style="color:#75af00">u</span> <span style="color:#f92672">*</span><span style="color:#75af00">User</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">Update</span><span style="color:#111">(</span><span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">tx</span> <span style="color:#f92672">*</span><span style="color:#75af00">bolt</span><span style="color:#111">.</span><span style="color:#75af00">Tx</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Retrieve the users bucket.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// This should be created when the DB is first opened.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">b</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">Bucket</span><span style="color:#111">([]</span><span style="color:#111">byte</span><span style="color:#111">(</span><span style="color:#d88200">&#34;users&#34;</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Generate ID for the user.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// This returns an error only if the Tx is closed or not writeable.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// That can&#39;t happen in an Update() call so I ignore the error check.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">id</span><span style="color:#111">,</span> <span style="color:#75af00">_</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">NextSequence</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">u</span><span style="color:#111">.</span><span style="color:#75af00">ID</span> <span style="color:#111">=</span> <span style="color:#111">int</span><span style="color:#111">(</span><span style="color:#75af00">id</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Marshal user data into bytes.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">buf</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">json</span><span style="color:#111">.</span><span style="color:#75af00">Marshal</span><span style="color:#111">(</span><span style="color:#75af00">u</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Persist bytes to users bucket.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">Put</span><span style="color:#111">(</span><span style="color:#75af00">itob</span><span style="color:#111">(</span><span style="color:#75af00">u</span><span style="color:#111">.</span><span style="color:#75af00">ID</span><span style="color:#111">),</span> <span style="color:#75af00">buf</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">})</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// itob returns an 8-byte big endian representation of v.</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">itob</span><span style="color:#111">(</span><span style="color:#75af00">v</span> <span style="color:#00a8c8">int</span><span style="color:#111">)</span> <span style="color:#111">[]</span><span style="color:#00a8c8">byte</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">b</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">([]</span><span style="color:#00a8c8">byte</span><span style="color:#111">,</span> <span style="color:#ae81ff">8</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">binary</span><span style="color:#111">.</span><span style="color:#75af00">BigEndian</span><span style="color:#111">.</span><span style="color:#75af00">PutUint64</span><span style="color:#111">(</span><span style="color:#75af00">b</span><span style="color:#111">,</span> <span style="color:#111">uint64</span><span style="color:#111">(</span><span style="color:#75af00">v</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#75af00">b</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">User</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">ID</span> <span style="color:#00a8c8">int</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="iterating-over-keys">Iterating over keys</h3>
<p>Bolt在存储桶内按字节排序存储其键。这使得对这些键进行顺序迭代非常快。要迭代键，我们将使用一个Cursor：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">View</span><span style="color:#111">(</span><span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">tx</span> <span style="color:#f92672">*</span><span style="color:#75af00">bolt</span><span style="color:#111">.</span><span style="color:#75af00">Tx</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Assume bucket exists and has keys</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">b</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">Bucket</span><span style="color:#111">([]</span><span style="color:#111">byte</span><span style="color:#111">(</span><span style="color:#d88200">&#34;MyBucket&#34;</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">c</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">Cursor</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">k</span><span style="color:#111">,</span> <span style="color:#75af00">v</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">First</span><span style="color:#111">();</span> <span style="color:#75af00">k</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span><span style="color:#111">;</span> <span style="color:#75af00">k</span><span style="color:#111">,</span> <span style="color:#75af00">v</span> <span style="color:#111">=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">Next</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;key=%s, value=%s\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">k</span><span style="color:#111">,</span> <span style="color:#75af00">v</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">})</span>
</span></span></code></pre></div><p>游标允许您移动到键列表中的特定点，并一次向前或向后移动一个键。</p>
<p>以下函数在游标上可用：</p>
<ul>
<li><code>First()</code> 移动到第一个键。</li>
<li><code>Last()</code> 移动到最后一个键。</li>
<li><code>Seek()</code> 移动到特定键。</li>
<li><code>Next()</code> 移动到下一个键。</li>
<li><code>Prev()</code> 移动到上一个键。 每个函数都有一个返回签名（key []byte, value []byte）。当您迭代到游标的末尾时，<code>Next()</code>将返回一个nil键。您必须使用<code>First()</code>、<code>Last()</code>或<code>Seek()</code>移动到某个位置，然后再调用<code>Next()</code>或<code>Prev()</code>。如果您没有移动到某个位置，那么这些函数将返回一个nil键。</li>
</ul>
<p>在迭代过程中，如果键不是nil，但值是nil，那么意味着键引用的是一个存储桶而不是一个值。使用<code>Bucket.Bucket()</code>来访问子存储桶。</p>
<h4 id="prefix-scans">Prefix scans</h4>
<p>要迭代键前缀，您可以结合使用<code>Seek()</code>和<code>bytes.HasPrefix()</code>：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">View</span><span style="color:#111">(</span><span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">tx</span> <span style="color:#f92672">*</span><span style="color:#75af00">bolt</span><span style="color:#111">.</span><span style="color:#75af00">Tx</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Assume bucket exists and has keys</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">c</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">Bucket</span><span style="color:#111">([]</span><span style="color:#111">byte</span><span style="color:#111">(</span><span style="color:#d88200">&#34;MyBucket&#34;</span><span style="color:#111">)).</span><span style="color:#75af00">Cursor</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">prefix</span> <span style="color:#f92672">:=</span> <span style="color:#111">[]</span><span style="color:#111">byte</span><span style="color:#111">(</span><span style="color:#d88200">&#34;1234&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">k</span><span style="color:#111">,</span> <span style="color:#75af00">v</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">Seek</span><span style="color:#111">(</span><span style="color:#75af00">prefix</span><span style="color:#111">);</span> <span style="color:#75af00">k</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">bytes</span><span style="color:#111">.</span><span style="color:#75af00">HasPrefix</span><span style="color:#111">(</span><span style="color:#75af00">k</span><span style="color:#111">,</span> <span style="color:#75af00">prefix</span><span style="color:#111">);</span> <span style="color:#75af00">k</span><span style="color:#111">,</span> <span style="color:#75af00">v</span> <span style="color:#111">=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">Next</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;key=%s, value=%s\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">k</span><span style="color:#111">,</span> <span style="color:#75af00">v</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">})</span>
</span></span></code></pre></div><h4 id="range-scans">Range scans</h4>
<p>另一个常见的用例是扫描范围，例如时间范围。如果您使用可排序的时间编码，例如RFC3339，那么您可以像这样查询特定的日期范围：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">View</span><span style="color:#111">(</span><span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">tx</span> <span style="color:#f92672">*</span><span style="color:#75af00">bolt</span><span style="color:#111">.</span><span style="color:#75af00">Tx</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Assume our events bucket exists and has RFC3339 encoded time keys.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">c</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">Bucket</span><span style="color:#111">([]</span><span style="color:#111">byte</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Events&#34;</span><span style="color:#111">)).</span><span style="color:#75af00">Cursor</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Our time range spans the 90&#39;s decade.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">min</span> <span style="color:#f92672">:=</span> <span style="color:#111">[]</span><span style="color:#111">byte</span><span style="color:#111">(</span><span style="color:#d88200">&#34;1990-01-01T00:00:00Z&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">max</span> <span style="color:#f92672">:=</span> <span style="color:#111">[]</span><span style="color:#111">byte</span><span style="color:#111">(</span><span style="color:#d88200">&#34;2000-01-01T00:00:00Z&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Iterate over the 90&#39;s.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">k</span><span style="color:#111">,</span> <span style="color:#75af00">v</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">Seek</span><span style="color:#111">(</span><span style="color:#75af00">min</span><span style="color:#111">);</span> <span style="color:#75af00">k</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">bytes</span><span style="color:#111">.</span><span style="color:#75af00">Compare</span><span style="color:#111">(</span><span style="color:#75af00">k</span><span style="color:#111">,</span> <span style="color:#75af00">max</span><span style="color:#111">)</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span><span style="color:#111">;</span> <span style="color:#75af00">k</span><span style="color:#111">,</span> <span style="color:#75af00">v</span> <span style="color:#111">=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">Next</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;%s: %s\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">k</span><span style="color:#111">,</span> <span style="color:#75af00">v</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">})</span>
</span></span></code></pre></div><p>请注意，虽然RFC3339是可排序的，但Golang的RFC3339Nano实现不使用小数点后固定数量的数字，因此不可排序。</p>
<h4 id="foreach">ForEach()</h4>
<p>如果您知道要在存储桶中迭代所有键，也可以使用<code>ForEach()</code>函数：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-GO" data-lang="GO"><span style="display:flex;"><span><span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">View</span><span style="color:#111">(</span><span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">tx</span> <span style="color:#f92672">*</span><span style="color:#75af00">bolt</span><span style="color:#111">.</span><span style="color:#75af00">Tx</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Assume bucket exists and has keys</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">b</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">Bucket</span><span style="color:#111">([]</span><span style="color:#111">byte</span><span style="color:#111">(</span><span style="color:#d88200">&#34;MyBucket&#34;</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">ForEach</span><span style="color:#111">(</span><span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">k</span><span style="color:#111">,</span> <span style="color:#75af00">v</span> <span style="color:#111">[]</span><span style="color:#00a8c8">byte</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;key=%s, value=%s\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">k</span><span style="color:#111">,</span> <span style="color:#75af00">v</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">})</span>
</span></span></code></pre></div><p>请注意，ForEach()中的键和值仅在事务打开时有效。如果您需要在事务之外使用键或值，您必须使用copy()将其复制到另一个字节切片。</p>
<h3 id="nested-buckets">Nested buckets</h3>
<p>以下是给定文档的中文翻译：</p>
<p>请注意，ForEach()中的键和值仅在事务打开时有效。如果您需要在事务之外使用键或值，您必须使用copy()将其复制到另一个字节切片。</p>
<p><strong>嵌套的桶</strong> 您还可以在键中存储一个桶，以创建嵌套的桶。该API与DB对象上的桶管理API相同：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">Bucket</span><span style="color:#111">)</span> <span style="color:#75af00">CreateBucket</span><span style="color:#111">(</span><span style="color:#75af00">key</span> <span style="color:#111">[]</span><span style="color:#00a8c8">byte</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">Bucket</span><span style="color:#111">,</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">Bucket</span><span style="color:#111">)</span> <span style="color:#75af00">CreateBucketIfNotExists</span><span style="color:#111">(</span><span style="color:#75af00">key</span> <span style="color:#111">[]</span><span style="color:#00a8c8">byte</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">Bucket</span><span style="color:#111">,</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">Bucket</span><span style="color:#111">)</span> <span style="color:#75af00">DeleteBucket</span><span style="color:#111">(</span><span style="color:#75af00">key</span> <span style="color:#111">[]</span><span style="color:#00a8c8">byte</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span>
</span></span></code></pre></div><p>假设您有一个多租户应用程序，其中根级别的桶是帐户桶。在此桶内是一系列自身为桶的帐户。在这个序列桶里，你可以拥有许多与账户自身相关的桶（如用户、笔记等），将信息隔离到逻辑分组中。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// createUser 在给定账户中创建一个新用户。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">createUser</span><span style="color:#111">(</span><span style="color:#75af00">accountID</span> <span style="color:#00a8c8">int</span><span style="color:#111">,</span> <span style="color:#75af00">u</span> <span style="color:#f92672">*</span><span style="color:#75af00">User</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 开始事务。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">tx</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">Begin</span><span style="color:#111">(</span><span style="color:#00a8c8">true</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">defer</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">Rollback</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 检索帐户的根桶。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 假设在设置帐户时已经创建了此桶。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">root</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">Bucket</span><span style="color:#111">([]</span><span style="color:#111">byte</span><span style="color:#111">(</span><span style="color:#75af00">strconv</span><span style="color:#111">.</span><span style="color:#75af00">FormatUint</span><span style="color:#111">(</span><span style="color:#75af00">accountID</span><span style="color:#111">,</span> <span style="color:#ae81ff">10</span><span style="color:#111">)))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 设置用户桶。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">bkt</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">root</span><span style="color:#111">.</span><span style="color:#75af00">CreateBucketIfNotExists</span><span style="color:#111">([]</span><span style="color:#111">byte</span><span style="color:#111">(</span><span style="color:#d88200">&#34;USERS&#34;</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 为新用户生成ID。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">userID</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">bkt</span><span style="color:#111">.</span><span style="color:#75af00">NextSequence</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">u</span><span style="color:#111">.</span><span style="color:#75af00">ID</span> <span style="color:#111">=</span> <span style="color:#75af00">userID</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 序列化并保存编码的用户。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">buf</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">json</span><span style="color:#111">.</span><span style="color:#75af00">Marshal</span><span style="color:#111">(</span><span style="color:#75af00">u</span><span style="color:#111">);</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">bkt</span><span style="color:#111">.</span><span style="color:#75af00">Put</span><span style="color:#111">([]</span><span style="color:#111">byte</span><span style="color:#111">(</span><span style="color:#75af00">strconv</span><span style="color:#111">.</span><span style="color:#75af00">FormatUint</span><span style="color:#111">(</span><span style="color:#75af00">u</span><span style="color:#111">.</span><span style="color:#75af00">ID</span><span style="color:#111">,</span> <span style="color:#ae81ff">10</span><span style="color:#111">)),</span> <span style="color:#75af00">buf</span><span style="color:#111">);</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 提交事务。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">Commit</span><span style="color:#111">();</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="数据库备份">数据库备份</h3>
<p>Bolt是一个单一的文件，所以备份很容易。您可以使用Tx.WriteTo()函数将数据库的一致视图写入一个写入器。如果您从只读事务中调用此函数，它将执行一个热备份，并且不会阻止您的其他数据库读取和写入。</p>
<p>默认情况下，它将使用一个常规的文件句柄，该句柄将利用操作系统的页面缓存。请查看Tx文档，了解有关优化大于RAM数据集的信息。</p>
<p>一个常见的用例是通过HTTP进行备份，这样您就可以使用像cURL这样的工具进行数据库备份：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">BackupHandleFunc</span><span style="color:#111">(</span><span style="color:#75af00">w</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">ResponseWriter</span><span style="color:#111">,</span> <span style="color:#75af00">req</span> <span style="color:#f92672">*</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Request</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">View</span><span style="color:#111">(</span><span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">tx</span> <span style="color:#f92672">*</span><span style="color:#75af00">bolt</span><span style="color:#111">.</span><span style="color:#75af00">Tx</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">w</span><span style="color:#111">.</span><span style="color:#75af00">Header</span><span style="color:#111">().</span><span style="color:#75af00">Set</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Content-Type&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;application/octet-stream&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">w</span><span style="color:#111">.</span><span style="color:#75af00">Header</span><span style="color:#111">().</span><span style="color:#75af00">Set</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Content-Disposition&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">`attachment; filename=&#34;my.db&#34;`</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">w</span><span style="color:#111">.</span><span style="color:#75af00">Header</span><span style="color:#111">().</span><span style="color:#75af00">Set</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Content-Length&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">strconv</span><span style="color:#111">.</span><span style="color:#75af00">Itoa</span><span style="color:#111">(</span><span style="color:#111">int</span><span style="color:#111">(</span><span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">Size</span><span style="color:#111">())))</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">WriteTo</span><span style="color:#111">(</span><span style="color:#75af00">w</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Error</span><span style="color:#111">(</span><span style="color:#75af00">w</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">.</span><span style="color:#75af00">Error</span><span style="color:#111">(),</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">StatusInternalServerError</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>然后你可以使用这个命令备份：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">$</span> <span style="color:#75af00">curl</span> <span style="color:#75af00">http</span><span style="color:#111">:</span><span style="color:#75715e">//localhost/backup &gt; my.db</span>
</span></span></code></pre></div><p>或者您可以打开您的浏览器访问http://localhost/backup，它将自动下载。</p>
<p>如果您想备份到另一个文件，您可以使用Tx.CopyFile()辅助函数。</p>
<p><strong>统计信息</strong> 数据库保持对其执行的许多内部操作的持续计数，这样您可以更好地了解正在发生的事情。通过在两个时间点获取这些统计的快照，我们可以看到在这个时间范围内执行了哪些操作。</p>
<p>例如，我们可以启动一个goroutine，每10秒记录一次统计信息：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">go</span> <span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 获取初始统计。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">prev</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">Stats</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">for</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 等待10秒。</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Sleep</span><span style="color:#111">(</span><span style="color:#ae81ff">10</span> <span style="color:#f92672">*</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Second</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 获取当前统计并对其进行差异处理。</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">stats</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">Stats</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">diff</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">stats</span><span style="color:#111">.</span><span style="color:#75af00">Sub</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">prev</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 将统计信息编码为JSON并打印到STDERR。</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">json</span><span style="color:#111">.</span><span style="color:#75af00">NewEncoder</span><span style="color:#111">(</span><span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">Stderr</span><span style="color:#111">).</span><span style="color:#75af00">Encode</span><span style="color:#111">(</span><span style="color:#75af00">diff</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 为下一个循环保存统计。</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">prev</span> <span style="color:#111">=</span> <span style="color:#75af00">stats</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}()</span>
</span></span></code></pre></div><p>将这些统计信息管道到像statsd这样的服务进行监控，或者提供一个HTTP端点来执行固定长度的样本，也很有用。</p>
<h3 id="只读模式">只读模式</h3>
<p>有时创建一个共享的、只读的Bolt数据库是很有用的。要做到这一点，打开数据库时设置Options.ReadOnly标志。只读模式使用共享锁，允许多个进程从数据库中读取，但它会阻止任何进程以读写模式打开数据库。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">db</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">bolt</span><span style="color:#111">.</span><span style="color:#75af00">Open</span><span style="color:#111">(</span><span style="color:#d88200">&#34;my.db&#34;</span><span style="color:#111">,</span> <span style="color:#ae81ff">0600</span><span style="color:#111">,</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">bolt</span><span style="color:#111">.</span><span style="color:#75af00">Options</span><span style="color:#111">{</span><span style="color:#75af00">ReadOnly</span><span style="color:#111">:</span> <span style="color:#00a8c8">true</span><span style="color:#111">})</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Fatal</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>希望这可以帮助您理解给定的文档！如果您有任何问题或需要进一步的澄清，请告诉我。</p>
<h2 id="referance">referance</h2>
<ul>
<li><a href="https://github.com/etcd-io/bbolt">https://github.com/etcd-io/bbolt</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/377572049">https://zhuanlan.zhihu.com/p/377572049</a></li>
</ul>
]]></content:encoded><category>cloud</category><category>boltdb</category><category>etcd</category><category>golang</category><category>数据库</category><category>kubernetes</category></item><item><title>golang操作etcd</title><link>https://daemon365.dev/post/go/golang_operates_etcd/</link><pubDate>Sun, 08 Jan 2023 20:56:00 +0800</pubDate><guid>https://daemon365.dev/post/go/golang_operates_etcd/</guid><description>&lt;p&gt;etcd是近几年比较火热的一个开源的、分布式的键值对数据存储系统，提供共享配置、服务的注册和发现，本文主要介绍etcd的安装和使用。&lt;/p&gt;
&lt;h2 id="etcd介绍"&gt;etcd介绍&lt;/h2&gt;
&lt;p&gt;&lt;a href="https://etcd.io/"&gt;etcd&lt;/a&gt;是使用Go语言开发的一个开源的、高可用的分布式key-value存储系统，可以用于配置共享和服务的注册和发现。&lt;/p&gt;
&lt;p&gt;类似项目有zookeeper和consul。&lt;/p&gt;
&lt;p&gt;etcd具有以下特点：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;完全复制：集群中的每个节点都可以使用完整的存档&lt;/li&gt;
&lt;li&gt;高可用性：Etcd可用于避免硬件的单点故障或网络问题&lt;/li&gt;
&lt;li&gt;一致性：每次读取都会返回跨多主机的最新写入&lt;/li&gt;
&lt;li&gt;简单：包括一个定义良好、面向用户的API（gRPC）&lt;/li&gt;
&lt;li&gt;安全：实现了带有可选的客户端证书身份验证的自动化TLS&lt;/li&gt;
&lt;li&gt;快速：每秒10000次写入的基准速度&lt;/li&gt;
&lt;li&gt;可靠：使用Raft算法实现了强一致、高可用的服务存储目录&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="etcd应用场景"&gt;etcd应用场景&lt;/h2&gt;
&lt;h3 id="服务发现"&gt;服务发现&lt;/h3&gt;
&lt;p&gt;服务发现要解决的也是分布式系统中最常见的问题之一，即在同一个分布式集群中的进程或服务，要如何才能找到对方并建立连接。本质上来说，服务发现就是想要了解集群中是否有进程在监听 udp 或 tcp 端口，并且通过名字就可以查找和连接。&lt;/p&gt;
&lt;h3 id="配置中心"&gt;配置中心&lt;/h3&gt;
&lt;p&gt;将一些配置信息放到 etcd 上进行集中管理。&lt;/p&gt;
&lt;p&gt;这类场景的使用方式通常是这样：应用在启动的时候主动从 etcd 获取一次配置信息，同时，在 etcd 节点上注册一个 Watcher 并等待，以后每次配置有更新的时候，etcd 都会实时通知订阅者，以此达到获取最新配置信息的目的。&lt;/p&gt;
&lt;h3 id="分布式锁"&gt;分布式锁&lt;/h3&gt;
&lt;p&gt;因为 etcd 使用 Raft 算法保持了数据的强一致性，某次操作存储到集群中的值必然是全局一致的，所以很容易实现分布式锁。锁服务有两种使用方式，一是保持独占，二是控制时序。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;保持独占即所有获取锁的用户最终只有一个可以得到&lt;/strong&gt;。etcd 为此提供了一套实现分布式锁原子操作 CAS（CompareAndSwap）的 API。通过设置prevExist值，可以保证在多个节点同时去创建某个目录时，只有一个成功。而创建成功的用户就可以认为是获得了锁。&lt;/li&gt;
&lt;li&gt;控制时序，即所有想要获得锁的用户都会被安排执行，但是&lt;strong&gt;获得锁的顺序也是全局唯一的，同时决定了执行顺序&lt;/strong&gt;。etcd 为此也提供了一套 API（自动创建有序键），对一个目录建值时指定为POST动作，这样 etcd 会自动在目录下生成一个当前最大的值为键，存储这个新的值（客户端编号）。同时还可以使用 API 按顺序列出所有当前目录下的键值。此时这些键的值就是客户端的时序，而这些键中存储的值可以是代表客户端的编号。&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="为什么用-etcd-而不用zookeeper"&gt;为什么用 etcd 而不用ZooKeeper？&lt;/h2&gt;
&lt;p&gt;etcd 实现的这些功能，ZooKeeper都能实现。那么为什么要用 etcd 而非直接使用ZooKeeper呢？&lt;/p&gt;
&lt;h3 id="为什么不选择zookeeper"&gt;为什么不选择ZooKeeper？&lt;/h3&gt;
&lt;ol&gt;
&lt;li&gt;部署维护复杂，其使用的Paxos强一致性算法复杂难懂。官方只提供了Java和C两种语言的接口。&lt;/li&gt;
&lt;li&gt;使用Java编写引入大量的依赖。运维人员维护起来比较麻烦。&lt;/li&gt;
&lt;li&gt;最近几年发展缓慢，不如etcd和consul等后起之秀。&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id="为什么选择etcd"&gt;为什么选择etcd？&lt;/h3&gt;
&lt;ol&gt;
&lt;li&gt;简单。使用 Go 语言编写部署简单；支持HTTP/JSON API,使用简单；使用 Raft 算法保证强一致性让用户易于理解。&lt;/li&gt;
&lt;li&gt;etcd 默认数据一更新就进行持久化。&lt;/li&gt;
&lt;li&gt;etcd 支持 SSL 客户端安全认证。&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;最后，etcd 作为一个年轻的项目，正在高速迭代和开发中，这既是一个优点，也是一个缺点。优点是它的未来具有无限的可能性，缺点是无法得到大项目长时间使用的检验。然而，目前CoreOS、Kubernetes和CloudFoundry等知名项目均在生产环境中使用了etcd，所以总的来说，etcd值得你去尝试。&lt;/p&gt;</description><content:encoded><![CDATA[<p>etcd是近几年比较火热的一个开源的、分布式的键值对数据存储系统，提供共享配置、服务的注册和发现，本文主要介绍etcd的安装和使用。</p>
<h2 id="etcd介绍">etcd介绍</h2>
<p><a href="https://etcd.io/">etcd</a>是使用Go语言开发的一个开源的、高可用的分布式key-value存储系统，可以用于配置共享和服务的注册和发现。</p>
<p>类似项目有zookeeper和consul。</p>
<p>etcd具有以下特点：</p>
<ul>
<li>完全复制：集群中的每个节点都可以使用完整的存档</li>
<li>高可用性：Etcd可用于避免硬件的单点故障或网络问题</li>
<li>一致性：每次读取都会返回跨多主机的最新写入</li>
<li>简单：包括一个定义良好、面向用户的API（gRPC）</li>
<li>安全：实现了带有可选的客户端证书身份验证的自动化TLS</li>
<li>快速：每秒10000次写入的基准速度</li>
<li>可靠：使用Raft算法实现了强一致、高可用的服务存储目录</li>
</ul>
<h2 id="etcd应用场景">etcd应用场景</h2>
<h3 id="服务发现">服务发现</h3>
<p>服务发现要解决的也是分布式系统中最常见的问题之一，即在同一个分布式集群中的进程或服务，要如何才能找到对方并建立连接。本质上来说，服务发现就是想要了解集群中是否有进程在监听 udp 或 tcp 端口，并且通过名字就可以查找和连接。</p>
<h3 id="配置中心">配置中心</h3>
<p>将一些配置信息放到 etcd 上进行集中管理。</p>
<p>这类场景的使用方式通常是这样：应用在启动的时候主动从 etcd 获取一次配置信息，同时，在 etcd 节点上注册一个 Watcher 并等待，以后每次配置有更新的时候，etcd 都会实时通知订阅者，以此达到获取最新配置信息的目的。</p>
<h3 id="分布式锁">分布式锁</h3>
<p>因为 etcd 使用 Raft 算法保持了数据的强一致性，某次操作存储到集群中的值必然是全局一致的，所以很容易实现分布式锁。锁服务有两种使用方式，一是保持独占，二是控制时序。</p>
<ul>
<li><strong>保持独占即所有获取锁的用户最终只有一个可以得到</strong>。etcd 为此提供了一套实现分布式锁原子操作 CAS（CompareAndSwap）的 API。通过设置prevExist值，可以保证在多个节点同时去创建某个目录时，只有一个成功。而创建成功的用户就可以认为是获得了锁。</li>
<li>控制时序，即所有想要获得锁的用户都会被安排执行，但是<strong>获得锁的顺序也是全局唯一的，同时决定了执行顺序</strong>。etcd 为此也提供了一套 API（自动创建有序键），对一个目录建值时指定为POST动作，这样 etcd 会自动在目录下生成一个当前最大的值为键，存储这个新的值（客户端编号）。同时还可以使用 API 按顺序列出所有当前目录下的键值。此时这些键的值就是客户端的时序，而这些键中存储的值可以是代表客户端的编号。</li>
</ul>
<h2 id="为什么用-etcd-而不用zookeeper">为什么用 etcd 而不用ZooKeeper？</h2>
<p>etcd 实现的这些功能，ZooKeeper都能实现。那么为什么要用 etcd 而非直接使用ZooKeeper呢？</p>
<h3 id="为什么不选择zookeeper">为什么不选择ZooKeeper？</h3>
<ol>
<li>部署维护复杂，其使用的Paxos强一致性算法复杂难懂。官方只提供了Java和C两种语言的接口。</li>
<li>使用Java编写引入大量的依赖。运维人员维护起来比较麻烦。</li>
<li>最近几年发展缓慢，不如etcd和consul等后起之秀。</li>
</ol>
<h3 id="为什么选择etcd">为什么选择etcd？</h3>
<ol>
<li>简单。使用 Go 语言编写部署简单；支持HTTP/JSON API,使用简单；使用 Raft 算法保证强一致性让用户易于理解。</li>
<li>etcd 默认数据一更新就进行持久化。</li>
<li>etcd 支持 SSL 客户端安全认证。</li>
</ol>
<p>最后，etcd 作为一个年轻的项目，正在高速迭代和开发中，这既是一个优点，也是一个缺点。优点是它的未来具有无限的可能性，缺点是无法得到大项目长时间使用的检验。然而，目前CoreOS、Kubernetes和CloudFoundry等知名项目均在生产环境中使用了etcd，所以总的来说，etcd值得你去尝试。</p>
<h2 id="etcd集群">etcd集群</h2>
<p>etcd 作为一个高可用键值存储系统，天生就是为集群化而设计的。由于 Raft 算法在做决策时需要多数节点的投票，所以 etcd 一般部署集群推荐奇数个节点，推荐的数量为 3、5 或者 7 个节点构成一个集群。</p>
<h3 id="搭建一个3节点集群示例">搭建一个3节点集群示例：</h3>
<p>在每个etcd节点指定集群成员，为了区分不同的集群最好同时配置一个独一无二的token。</p>
<p>下面是提前定义好的集群信息，其中n1、n2和n3表示3个不同的etcd节点。</p>
<pre tabindex="0"><code>TOKEN=token-01
CLUSTER_STATE=new
CLUSTER=n1=http://10.240.0.17:2380,n2=http://10.240.0.18:2380,n3=http://10.240.0.19:2380
</code></pre><p>在n1这台机器上执行以下命令来启动etcd：</p>
<pre tabindex="0"><code>etcd --data-dir=data.etcd --name n1 \
	--initial-advertise-peer-urls http://10.240.0.17:2380 --listen-peer-urls http://10.240.0.17:2380 \
	--advertise-client-urls http://10.240.0.17:2379 --listen-client-urls http://10.240.0.17:2379 \
	--initial-cluster ${CLUSTER} \
	--initial-cluster-state ${CLUSTER_STATE} --initial-cluster-token ${TOKEN}
</code></pre><p>在n2这台机器上执行以下命令启动etcd：</p>
<pre tabindex="0"><code>etcd --data-dir=data.etcd --name n2 \
	--initial-advertise-peer-urls http://10.240.0.18:2380 --listen-peer-urls http://10.240.0.18:2380 \
	--advertise-client-urls http://10.240.0.18:2379 --listen-client-urls http://10.240.0.18:2379 \
	--initial-cluster ${CLUSTER} \
	--initial-cluster-state ${CLUSTER_STATE} --initial-cluster-token ${TOKEN}
</code></pre><p>在n3这台机器上执行以下命令启动etcd：</p>
<pre tabindex="0"><code>etcd --data-dir=data.etcd --name n3 \
	--initial-advertise-peer-urls http://10.240.0.19:2380 --listen-peer-urls http://10.240.0.19:2380 \
	--advertise-client-urls http://10.240.0.19:2379 --listen-client-urls http://10.240.0.19:2379 \
	--initial-cluster ${CLUSTER} \
	--initial-cluster-state ${CLUSTER_STATE} --initial-cluster-token ${TOKEN}
</code></pre><p>etcd 官网提供了一个可以公网访问的 etcd 存储地址。你可以通过如下命令得到 etcd 服务的目录，并把它作为-discovery参数使用。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">curl</span> <span style="color:#75af00">https</span><span style="color:#111">:</span><span style="color:#75715e">//discovery.etcd.io/new?size=3</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">https</span><span style="color:#111">:</span><span style="color:#75715e">//discovery.etcd.io/a81b5818e67a6ea83e9d4daea5ecbc92</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75af00">grab</span> <span style="color:#75af00">this</span> <span style="color:#75af00">token</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">TOKEN</span><span style="color:#111">=</span><span style="color:#75af00">token</span><span style="color:#f92672">-</span><span style="color:#ae81ff">01</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">CLUSTER_STATE</span><span style="color:#111">=</span><span style="color:#75af00">new</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">DISCOVERY</span><span style="color:#111">=</span><span style="color:#75af00">https</span><span style="color:#111">:</span><span style="color:#75715e">//discovery.etcd.io/a81b5818e67a6ea83e9d4daea5ecbc92</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">etcd</span> <span style="color:#f92672">--</span><span style="color:#75af00">data</span><span style="color:#f92672">-</span><span style="color:#75af00">dir</span><span style="color:#111">=</span><span style="color:#75af00">data</span><span style="color:#111">.</span><span style="color:#75af00">etcd</span> <span style="color:#f92672">--</span><span style="color:#75af00">name</span> <span style="color:#75af00">n1</span> <span style="color:#960050;background-color:#1e0010">\</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">--</span><span style="color:#75af00">initial</span><span style="color:#f92672">-</span><span style="color:#75af00">advertise</span><span style="color:#f92672">-</span><span style="color:#75af00">peer</span><span style="color:#f92672">-</span><span style="color:#75af00">urls</span> <span style="color:#75af00">http</span><span style="color:#111">:</span><span style="color:#75715e">//10.240.0.17:2380 --listen-peer-urls http://10.240.0.17:2380 \</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">--</span><span style="color:#75af00">advertise</span><span style="color:#f92672">-</span><span style="color:#75af00">client</span><span style="color:#f92672">-</span><span style="color:#75af00">urls</span> <span style="color:#75af00">http</span><span style="color:#111">:</span><span style="color:#75715e">//10.240.0.17:2379 --listen-client-urls http://10.240.0.17:2379 \</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">--</span><span style="color:#75af00">discovery</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#111">{</span><span style="color:#75af00">DISCOVERY</span><span style="color:#111">}</span> <span style="color:#960050;background-color:#1e0010">\</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">--</span><span style="color:#75af00">initial</span><span style="color:#f92672">-</span><span style="color:#75af00">cluster</span><span style="color:#f92672">-</span><span style="color:#75af00">state</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#111">{</span><span style="color:#75af00">CLUSTER_STATE</span><span style="color:#111">}</span> <span style="color:#f92672">--</span><span style="color:#75af00">initial</span><span style="color:#f92672">-</span><span style="color:#75af00">cluster</span><span style="color:#f92672">-</span><span style="color:#75af00">token</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#111">{</span><span style="color:#75af00">TOKEN</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">etcd</span> <span style="color:#f92672">--</span><span style="color:#75af00">data</span><span style="color:#f92672">-</span><span style="color:#75af00">dir</span><span style="color:#111">=</span><span style="color:#75af00">data</span><span style="color:#111">.</span><span style="color:#75af00">etcd</span> <span style="color:#f92672">--</span><span style="color:#75af00">name</span> <span style="color:#75af00">n2</span> <span style="color:#960050;background-color:#1e0010">\</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">--</span><span style="color:#75af00">initial</span><span style="color:#f92672">-</span><span style="color:#75af00">advertise</span><span style="color:#f92672">-</span><span style="color:#75af00">peer</span><span style="color:#f92672">-</span><span style="color:#75af00">urls</span> <span style="color:#75af00">http</span><span style="color:#111">:</span><span style="color:#75715e">//10.240.0.18:2380 --listen-peer-urls http://10.240.0.18:2380 \</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">--</span><span style="color:#75af00">advertise</span><span style="color:#f92672">-</span><span style="color:#75af00">client</span><span style="color:#f92672">-</span><span style="color:#75af00">urls</span> <span style="color:#75af00">http</span><span style="color:#111">:</span><span style="color:#75715e">//10.240.0.18:2379 --listen-client-urls http://10.240.0.18:2379 \</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">--</span><span style="color:#75af00">discovery</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#111">{</span><span style="color:#75af00">DISCOVERY</span><span style="color:#111">}</span> <span style="color:#960050;background-color:#1e0010">\</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">--</span><span style="color:#75af00">initial</span><span style="color:#f92672">-</span><span style="color:#75af00">cluster</span><span style="color:#f92672">-</span><span style="color:#75af00">state</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#111">{</span><span style="color:#75af00">CLUSTER_STATE</span><span style="color:#111">}</span> <span style="color:#f92672">--</span><span style="color:#75af00">initial</span><span style="color:#f92672">-</span><span style="color:#75af00">cluster</span><span style="color:#f92672">-</span><span style="color:#75af00">token</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#111">{</span><span style="color:#75af00">TOKEN</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">etcd</span> <span style="color:#f92672">--</span><span style="color:#75af00">data</span><span style="color:#f92672">-</span><span style="color:#75af00">dir</span><span style="color:#111">=</span><span style="color:#75af00">data</span><span style="color:#111">.</span><span style="color:#75af00">etcd</span> <span style="color:#f92672">--</span><span style="color:#75af00">name</span> <span style="color:#75af00">n3</span> <span style="color:#960050;background-color:#1e0010">\</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">--</span><span style="color:#75af00">initial</span><span style="color:#f92672">-</span><span style="color:#75af00">advertise</span><span style="color:#f92672">-</span><span style="color:#75af00">peer</span><span style="color:#f92672">-</span><span style="color:#75af00">urls</span> <span style="color:#75af00">http</span><span style="color:#111">:</span><span style="color:#75715e">//10.240.0.19:2380 --listen-peer-urls http://10.240.0.19:2380 \</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">--</span><span style="color:#75af00">advertise</span><span style="color:#f92672">-</span><span style="color:#75af00">client</span><span style="color:#f92672">-</span><span style="color:#75af00">urls</span> <span style="color:#75af00">http</span><span style="color:#111">:</span><span style="color:#75715e">//10.240.0.19:2379 --listen-client-urls http:/10.240.0.19:2379 \</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">--</span><span style="color:#75af00">discovery</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#111">{</span><span style="color:#75af00">DISCOVERY</span><span style="color:#111">}</span> <span style="color:#960050;background-color:#1e0010">\</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">--</span><span style="color:#75af00">initial</span><span style="color:#f92672">-</span><span style="color:#75af00">cluster</span><span style="color:#f92672">-</span><span style="color:#75af00">state</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#111">{</span><span style="color:#75af00">CLUSTER_STATE</span><span style="color:#111">}</span> <span style="color:#f92672">--</span><span style="color:#75af00">initial</span><span style="color:#f92672">-</span><span style="color:#75af00">cluster</span><span style="color:#f92672">-</span><span style="color:#75af00">token</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#111">{</span><span style="color:#75af00">TOKEN</span><span style="color:#111">}</span>
</span></span></code></pre></div><p>到此etcd集群就搭建起来了，可以使用etcdctl来连接etcd。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#111">export</span> <span style="color:#111">ETCDCTL_API</span><span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span><span style="color:#111">HOST_1</span><span style="color:#f92672">=</span>10.240.0.17
</span></span><span style="display:flex;"><span><span style="color:#111">HOST_2</span><span style="color:#f92672">=</span>10.240.0.18
</span></span><span style="display:flex;"><span><span style="color:#111">HOST_3</span><span style="color:#f92672">=</span>10.240.0.19
</span></span><span style="display:flex;"><span><span style="color:#111">ENDPOINTS</span><span style="color:#f92672">=</span><span style="color:#111">$HOST_1</span>:2379,<span style="color:#111">$HOST_2</span>:2379,<span style="color:#111">$HOST_3</span>:2379
</span></span><span style="display:flex;"><span>etcdctl --endpoints<span style="color:#f92672">=</span><span style="color:#111">$ENDPOINTS</span> member list
</span></span></code></pre></div><h2 id="go语言操作etcd">Go语言操作etcd</h2>
<p>这里使用官方的<a href="https://github.com/etcd-io/etcd/tree/master/clientv3">etcd/clientv3</a>包来连接etcd并进行相关操作。</p>
<h3 id="安装">安装</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">go</span> <span style="color:#75af00">get</span> <span style="color:#00a8c8">go</span><span style="color:#111">.</span><span style="color:#75af00">etcd</span><span style="color:#111">.</span><span style="color:#75af00">io</span><span style="color:#f92672">/</span><span style="color:#75af00">etcd</span><span style="color:#f92672">/</span><span style="color:#75af00">clientv3</span>
</span></span></code></pre></div><h3 id="put和get操作">put和get操作</h3>
<p>put命令用来设置键值对数据，get命令用来根据key获取值。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;context&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;go.etcd.io/etcd/clientv3&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// etcd client put/get demo</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// use etcd/clientv3</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">cli</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">clientv3</span><span style="color:#111">.</span><span style="color:#75af00">New</span><span style="color:#111">(</span><span style="color:#75af00">clientv3</span><span style="color:#111">.</span><span style="color:#75af00">Config</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">Endpoints</span><span style="color:#111">:</span>   <span style="color:#111">[]</span><span style="color:#00a8c8">string</span><span style="color:#111">{</span><span style="color:#d88200">&#34;127.0.0.1:2379&#34;</span><span style="color:#111">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">DialTimeout</span><span style="color:#111">:</span> <span style="color:#ae81ff">5</span> <span style="color:#f92672">*</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Second</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// handle error!</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;connect to etcd failed, err:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;connect to etcd success&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">cli</span><span style="color:#111">.</span><span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// put</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">cancel</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">WithTimeout</span><span style="color:#111">(</span><span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Background</span><span style="color:#111">(),</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Second</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">cli</span><span style="color:#111">.</span><span style="color:#75af00">Put</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;q1mi&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;dsb&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">cancel</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;put to etcd failed, err:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// get</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">cancel</span> <span style="color:#111">=</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">WithTimeout</span><span style="color:#111">(</span><span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Background</span><span style="color:#111">(),</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Second</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">resp</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">cli</span><span style="color:#111">.</span><span style="color:#75af00">Get</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;q1mi&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">cancel</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;get from etcd failed, err:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">ev</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">resp</span><span style="color:#111">.</span><span style="color:#75af00">Kvs</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;%s:%s\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">ev</span><span style="color:#111">.</span><span style="color:#75af00">Key</span><span style="color:#111">,</span> <span style="color:#75af00">ev</span><span style="color:#111">.</span><span style="color:#75af00">Value</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="watch操作">watch操作</h3>
<p>watch用来获取未来更改的通知。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;context&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;go.etcd.io/etcd/clientv3&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// watch demo</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">cli</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">clientv3</span><span style="color:#111">.</span><span style="color:#75af00">New</span><span style="color:#111">(</span><span style="color:#75af00">clientv3</span><span style="color:#111">.</span><span style="color:#75af00">Config</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">Endpoints</span><span style="color:#111">:</span>   <span style="color:#111">[]</span><span style="color:#00a8c8">string</span><span style="color:#111">{</span><span style="color:#d88200">&#34;127.0.0.1:2379&#34;</span><span style="color:#111">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">DialTimeout</span><span style="color:#111">:</span> <span style="color:#ae81ff">5</span> <span style="color:#f92672">*</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Second</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;connect to etcd failed, err:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;connect to etcd success&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">cli</span><span style="color:#111">.</span><span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// watch key:q1mi change</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">rch</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">cli</span><span style="color:#111">.</span><span style="color:#75af00">Watch</span><span style="color:#111">(</span><span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Background</span><span style="color:#111">(),</span> <span style="color:#d88200">&#34;q1mi&#34;</span><span style="color:#111">)</span> <span style="color:#75715e">// &lt;-chan WatchResponse</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">wresp</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">rch</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">ev</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">wresp</span><span style="color:#111">.</span><span style="color:#75af00">Events</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Type: %s Key:%s Value:%s\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">ev</span><span style="color:#111">.</span><span style="color:#75af00">Type</span><span style="color:#111">,</span> <span style="color:#75af00">ev</span><span style="color:#111">.</span><span style="color:#75af00">Kv</span><span style="color:#111">.</span><span style="color:#75af00">Key</span><span style="color:#111">,</span> <span style="color:#75af00">ev</span><span style="color:#111">.</span><span style="color:#75af00">Kv</span><span style="color:#111">.</span><span style="color:#75af00">Value</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>将上面的代码保存编译执行，此时程序就会等待etcd中q1mi这个key的变化。</p>
<p>例如：我们打开终端执行以下命令修改、删除、设置q1mi这个key。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">etcd</span><span style="color:#111">&gt;</span> <span style="color:#75af00">etcdctl</span><span style="color:#111">.</span><span style="color:#75af00">exe</span> <span style="color:#f92672">--</span><span style="color:#75af00">endpoints</span><span style="color:#111">=</span><span style="color:#75af00">http</span><span style="color:#111">:</span><span style="color:#75715e">//127.0.0.1:2379 put q1mi &#34;dsb2&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">OK</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">etcd</span><span style="color:#111">&gt;</span> <span style="color:#75af00">etcdctl</span><span style="color:#111">.</span><span style="color:#75af00">exe</span> <span style="color:#f92672">--</span><span style="color:#75af00">endpoints</span><span style="color:#111">=</span><span style="color:#75af00">http</span><span style="color:#111">:</span><span style="color:#75715e">//127.0.0.1:2379 del q1mi</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">etcd</span><span style="color:#111">&gt;</span> <span style="color:#75af00">etcdctl</span><span style="color:#111">.</span><span style="color:#75af00">exe</span> <span style="color:#f92672">--</span><span style="color:#75af00">endpoints</span><span style="color:#111">=</span><span style="color:#75af00">http</span><span style="color:#111">:</span><span style="color:#75715e">//127.0.0.1:2379 put q1mi &#34;dsb3&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">OK</span>
</span></span></code></pre></div><p>上面的程序都能收到如下通知。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">watch</span><span style="color:#111">&gt;</span><span style="color:#75af00">watch</span><span style="color:#111">.</span><span style="color:#75af00">exe</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">connect</span> <span style="color:#75af00">to</span> <span style="color:#75af00">etcd</span> <span style="color:#75af00">success</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">Type</span><span style="color:#111">:</span> <span style="color:#75af00">PUT</span> <span style="color:#75af00">Key</span><span style="color:#111">:</span><span style="color:#75af00">q1mi</span> <span style="color:#75af00">Value</span><span style="color:#111">:</span><span style="color:#75af00">dsb2</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">Type</span><span style="color:#111">:</span> <span style="color:#75af00">DELETE</span> <span style="color:#75af00">Key</span><span style="color:#111">:</span><span style="color:#75af00">q1mi</span> <span style="color:#75af00">Value</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">Type</span><span style="color:#111">:</span> <span style="color:#75af00">PUT</span> <span style="color:#75af00">Key</span><span style="color:#111">:</span><span style="color:#75af00">q1mi</span> <span style="color:#75af00">Value</span><span style="color:#111">:</span><span style="color:#75af00">dsb3</span>
</span></span></code></pre></div><h3 id="lease租约">lease租约</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// etcd lease</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;context&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;go.etcd.io/etcd/clientv3&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">cli</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">clientv3</span><span style="color:#111">.</span><span style="color:#75af00">New</span><span style="color:#111">(</span><span style="color:#75af00">clientv3</span><span style="color:#111">.</span><span style="color:#75af00">Config</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">Endpoints</span><span style="color:#111">:</span>   <span style="color:#111">[]</span><span style="color:#00a8c8">string</span><span style="color:#111">{</span><span style="color:#d88200">&#34;127.0.0.1:2379&#34;</span><span style="color:#111">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">DialTimeout</span><span style="color:#111">:</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Second</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">5</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Fatal</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;connect to etcd success.&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">cli</span><span style="color:#111">.</span><span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 创建一个5秒的租约</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">resp</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">cli</span><span style="color:#111">.</span><span style="color:#75af00">Grant</span><span style="color:#111">(</span><span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">TODO</span><span style="color:#111">(),</span> <span style="color:#ae81ff">5</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Fatal</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 5秒钟之后, /nazha/ 这个key就会被移除</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">cli</span><span style="color:#111">.</span><span style="color:#75af00">Put</span><span style="color:#111">(</span><span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">TODO</span><span style="color:#111">(),</span> <span style="color:#d88200">&#34;/nazha/&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;dsb&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">clientv3</span><span style="color:#111">.</span><span style="color:#75af00">WithLease</span><span style="color:#111">(</span><span style="color:#75af00">resp</span><span style="color:#111">.</span><span style="color:#75af00">ID</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Fatal</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="keepalive">keepAlive</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;context&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;go.etcd.io/etcd/clientv3&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// etcd keepAlive</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">cli</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">clientv3</span><span style="color:#111">.</span><span style="color:#75af00">New</span><span style="color:#111">(</span><span style="color:#75af00">clientv3</span><span style="color:#111">.</span><span style="color:#75af00">Config</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">Endpoints</span><span style="color:#111">:</span>   <span style="color:#111">[]</span><span style="color:#00a8c8">string</span><span style="color:#111">{</span><span style="color:#d88200">&#34;127.0.0.1:2379&#34;</span><span style="color:#111">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">DialTimeout</span><span style="color:#111">:</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Second</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">5</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Fatal</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;connect to etcd success.&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">cli</span><span style="color:#111">.</span><span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">resp</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">cli</span><span style="color:#111">.</span><span style="color:#75af00">Grant</span><span style="color:#111">(</span><span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">TODO</span><span style="color:#111">(),</span> <span style="color:#ae81ff">5</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Fatal</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">cli</span><span style="color:#111">.</span><span style="color:#75af00">Put</span><span style="color:#111">(</span><span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">TODO</span><span style="color:#111">(),</span> <span style="color:#d88200">&#34;/nazha/&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;dsb&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">clientv3</span><span style="color:#111">.</span><span style="color:#75af00">WithLease</span><span style="color:#111">(</span><span style="color:#75af00">resp</span><span style="color:#111">.</span><span style="color:#75af00">ID</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Fatal</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// the key &#39;foo&#39; will be kept forever</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ch</span><span style="color:#111">,</span> <span style="color:#75af00">kaerr</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">cli</span><span style="color:#111">.</span><span style="color:#75af00">KeepAlive</span><span style="color:#111">(</span><span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">TODO</span><span style="color:#111">(),</span> <span style="color:#75af00">resp</span><span style="color:#111">.</span><span style="color:#75af00">ID</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">kaerr</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Fatal</span><span style="color:#111">(</span><span style="color:#75af00">kaerr</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">ka</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#75af00">ch</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;ttl:&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">ka</span><span style="color:#111">.</span><span style="color:#75af00">TTL</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="基于etcd实现分布式锁">基于etcd实现分布式锁</h3>
<p>go.etcd.io/etcd/clientv3/concurrency在etcd之上实现并发操作，如分布式锁、屏障和选举。</p>
<p>导入该包：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#d88200">&#34;go.etcd.io/etcd/clientv3/concurrency&#34;</span>
</span></span></code></pre></div><p>基于etcd实现的分布式锁示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">cli</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">clientv3</span><span style="color:#111">.</span><span style="color:#75af00">New</span><span style="color:#111">(</span><span style="color:#75af00">clientv3</span><span style="color:#111">.</span><span style="color:#75af00">Config</span><span style="color:#111">{</span><span style="color:#75af00">Endpoints</span><span style="color:#111">:</span> <span style="color:#75af00">endpoints</span><span style="color:#111">})</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Fatal</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">defer</span> <span style="color:#75af00">cli</span><span style="color:#111">.</span><span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 创建两个单独的会话用来演示锁竞争</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">s1</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">concurrency</span><span style="color:#111">.</span><span style="color:#75af00">NewSession</span><span style="color:#111">(</span><span style="color:#75af00">cli</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Fatal</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">defer</span> <span style="color:#75af00">s1</span><span style="color:#111">.</span><span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">m1</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">concurrency</span><span style="color:#111">.</span><span style="color:#75af00">NewMutex</span><span style="color:#111">(</span><span style="color:#75af00">s1</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;/my-lock/&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">s2</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">concurrency</span><span style="color:#111">.</span><span style="color:#75af00">NewSession</span><span style="color:#111">(</span><span style="color:#75af00">cli</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Fatal</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">defer</span> <span style="color:#75af00">s2</span><span style="color:#111">.</span><span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">m2</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">concurrency</span><span style="color:#111">.</span><span style="color:#75af00">NewMutex</span><span style="color:#111">(</span><span style="color:#75af00">s2</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;/my-lock/&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 会话s1获取锁</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">m1</span><span style="color:#111">.</span><span style="color:#75af00">Lock</span><span style="color:#111">(</span><span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">TODO</span><span style="color:#111">());</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Fatal</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;acquired lock for s1&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">m2Locked</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">chan</span> <span style="color:#00a8c8">struct</span><span style="color:#111">{})</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">go</span> <span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">defer</span> <span style="color:#111">close</span><span style="color:#111">(</span><span style="color:#75af00">m2Locked</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 等待直到会话s1释放了/my-lock/的锁</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">m2</span><span style="color:#111">.</span><span style="color:#75af00">Lock</span><span style="color:#111">(</span><span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">TODO</span><span style="color:#111">());</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Fatal</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}()</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">m1</span><span style="color:#111">.</span><span style="color:#75af00">Unlock</span><span style="color:#111">(</span><span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">TODO</span><span style="color:#111">());</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Fatal</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;released lock for s1&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;-</span><span style="color:#75af00">m2Locked</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;acquired lock for s2&#34;</span><span style="color:#111">)</span>
</span></span></code></pre></div><p>输出：</p>
<pre tabindex="0"><code>acquired lock for s1
released lock for s1
acquired lock for s2
</code></pre><p><a href="https://godoc.org/go.etcd.io/etcd/clientv3/concurrency">查看文档了解更多</a></p>
<h2 id="文章转自">文章转自</h2>
<ul>
<li><a href="https://www.liwenzhou.com/posts/Go/go_etcd/">https://www.liwenzhou.com/posts/Go/go_etcd/</a></li>
</ul>
]]></content:encoded><category>go</category><category>boltdb</category><category>etcd</category><category>golang</category><category>数据库</category><category>kubernetes</category></item></channel></rss>