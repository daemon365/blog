<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/"><channel><title>Redis on Daemon365</title><link>https://daemon365.dev/tags/redis/</link><description>Don't let yourself stop.</description><generator>Hugo -- gohugo.io</generator><language>zh-cn</language><lastBuildDate>Sun, 20 Aug 2023 00:00:00 +0800</lastBuildDate><atom:link href="https://daemon365.dev/tags/redis/index.xml" rel="self" type="application/rss+xml"/><item><title>redis主从同步</title><link>https://daemon365.dev/post/database/redis_master_slave_synchronization/</link><pubDate>Sun, 20 Aug 2023 00:00:00 +0800</pubDate><guid>https://daemon365.dev/post/database/redis_master_slave_synchronization/</guid><description>&lt;h2 id="redis主从同步"&gt;redis主从同步&lt;/h2&gt;
&lt;p&gt;&lt;img src="https://daemon365.dev/images/a9aeda50-50ab-4fe3-b94c-572cadf14613.png" alt=""&gt;&lt;/p&gt;
&lt;p&gt;原理：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;从服务器向主服务器发送 SYNC 命令。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;接到 SYNC 命令的主服务器会调用BGSAVE 命令，创建一个 RDB 文件，并使用缓冲区记录接下来执行的所有写命令。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;当主服务器执行完 BGSAVE 命令时，它会向从服务器发送 RDB 文件，而从服务器则会接收并载入这个文件。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;主服务器将缓冲区储存的所有写命令发送给从服务器执行。&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;- 1、在开启主从复制的时候，使用的是RDB方式的，同步主从数据的 2、同步开始之后，通过主库命令传播的方式，主动的复制方式实现 3、2.8以后实现PSYNC的机制，实现断线重连&lt;/p&gt;
&lt;h2 id="环境准备"&gt;环境准备&lt;/h2&gt;
&lt;p&gt;6380.conf&lt;/p&gt;
&lt;pre tabindex="0"&gt;&lt;code&gt;1、环境： 准备两个或两个以上redis实例 mkdir /data/638{0..2} #创建6380 6381 6382文件夹 配置文件示例： vim /data/6380/redis.conf port 6380 daemonize yes pidfile /data/6380/redis.pid loglevel notice logfile &amp;#34;/data/6380/redis.log&amp;#34; dbfilename dump.rdb dir /data/6380 protected-mode no
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;6381.conf&lt;/p&gt;
&lt;pre tabindex="0"&gt;&lt;code&gt;vim /data/6381/redis.conf port 6381 daemonize yes pidfile /data/6381/redis.pid loglevel notice logfile &amp;#34;/data/6381/redis.log&amp;#34; dbfilename dump.rdb dir /data/6381 protected-mode no
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;6382.conf&lt;/p&gt;
&lt;pre tabindex="0"&gt;&lt;code&gt;port 6382 daemonize yes pidfile /data/6382/redis.pid loglevel notice logfile &amp;#34;/data/6382/redis.log&amp;#34; dbfilename dump.rdb dir /data/6382 protected-mode no
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;启动三个redis实例&lt;/p&gt;</description><content:encoded><![CDATA[<h2 id="redis主从同步">redis主从同步</h2>
<p><img src="/images/a9aeda50-50ab-4fe3-b94c-572cadf14613.png" alt=""></p>
<p>原理：</p>
<ol>
<li>
<p>从服务器向主服务器发送 SYNC 命令。</p>
</li>
<li>
<p>接到 SYNC 命令的主服务器会调用BGSAVE 命令，创建一个 RDB 文件，并使用缓冲区记录接下来执行的所有写命令。</p>
</li>
<li>
<p>当主服务器执行完 BGSAVE 命令时，它会向从服务器发送 RDB 文件，而从服务器则会接收并载入这个文件。</p>
</li>
<li>
<p>主服务器将缓冲区储存的所有写命令发送给从服务器执行。</p>
</li>
</ol>
<p>&mdash;&mdash;&mdash;&mdash;- 1、在开启主从复制的时候，使用的是RDB方式的，同步主从数据的 2、同步开始之后，通过主库命令传播的方式，主动的复制方式实现 3、2.8以后实现PSYNC的机制，实现断线重连</p>
<h2 id="环境准备">环境准备</h2>
<p>6380.conf</p>
<pre tabindex="0"><code>1、环境： 准备两个或两个以上redis实例  mkdir /data/638{0..2} #创建6380 6381 6382文件夹  配置文件示例： vim   /data/6380/redis.conf port 6380 daemonize yes pidfile /data/6380/redis.pid loglevel notice logfile &#34;/data/6380/redis.log&#34; dbfilename dump.rdb dir /data/6380 protected-mode no
</code></pre><p>6381.conf</p>
<pre tabindex="0"><code>vim   /data/6381/redis.conf port 6381 daemonize yes pidfile /data/6381/redis.pid loglevel notice logfile &#34;/data/6381/redis.log&#34; dbfilename dump.rdb dir /data/6381 protected-mode no
</code></pre><p>6382.conf</p>
<pre tabindex="0"><code>port 6382 daemonize yes pidfile /data/6382/redis.pid loglevel notice logfile &#34;/data/6382/redis.log&#34; dbfilename dump.rdb dir /data/6382 protected-mode no
</code></pre><p>启动三个redis实例</p>
<pre tabindex="0"><code>redis-server /data/6380/redis.conf redis-server /data/6381/redis.conf redis-server /data/6382/redis.conf
</code></pre><p>主从规划</p>
<pre tabindex="0"><code>主节点：6380 从节点：6381、6382
</code></pre><h2 id="配置主从同步">配置主从同步</h2>
<p>6381/6382命令行</p>
<p>redis-cli -p 6381 SLAVEOF 127.0.0.1 6380 #指明主的地址</p>
<p>redis-cli -p 6382 SLAVEOF 127.0.0.1 6380 #指明主的地址</p>
<p>检查主从状态</p>
<p>从库：</p>
<pre tabindex="0"><code>127.0.0.1:6382&gt; info replication 127.0.0.1:6381&gt; info replication
</code></pre><p>主库：</p>
<pre tabindex="0"><code>127.0.0.1:6380&gt; info replication
</code></pre><h2 id="测试写入数据主库写入数据检查从库数据">测试写入数据，主库写入数据，检查从库数据</h2>
<pre tabindex="0"><code>主 127.0.0.1:6380&gt; set name chaoge   从 127.0.0.1:6381&gt;get name 
</code></pre><h2 id="手动进行主从复制故障切换">手动进行主从复制故障切换</h2>
<pre tabindex="0"><code>#关闭主库6380redis-cli -p 6380 shutdown
</code></pre><p>检查从库主从信息，此时master_link_status:down</p>
<pre tabindex="0"><code>redis-cli -p 6381 info replication redis-cli -p 6382 info replication
</code></pre><p><strong>既然主库挂了，我想要在6381 6382之间选一个新的主库</strong></p>
<p><strong>1.关闭6381的从库身份</strong></p>
<pre tabindex="0"><code>redis-cli -p 6381 info replication slaveof no one
</code></pre><p><strong>2.将6382设为6381的从库</strong></p>
<pre tabindex="0"><code>6382连接到6381： [root@db03 ~]## redis-cli -p 6382 127.0.0.1:6382&gt; SLAVEOF no one 127.0.0.1:6382&gt; SLAVEOF 127.0.0.1 6381
</code></pre><p>3.检查6382，6381的主从信息</p>
]]></content:encoded><category>database</category><category>redis</category></item><item><title>redis发布订阅</title><link>https://daemon365.dev/post/database/redis_publish_subscribe/</link><pubDate>Sat, 20 Aug 2022 00:00:00 +0800</pubDate><guid>https://daemon365.dev/post/database/redis_publish_subscribe/</guid><description>&lt;h2 id="什么是发布和订阅"&gt;什么是发布和订阅&lt;/h2&gt;
&lt;p&gt;Redis 发布订阅 (pub/sub) 是一种消息通信模式：发送者 (pub) 发送消息，订阅者 (sub) 接收消息。&lt;/p&gt;
&lt;p&gt;Redis 客户端可以订阅任意数量的频道。&lt;/p&gt;
&lt;h2 id="发布和订阅"&gt;发布和订阅&lt;/h2&gt;
&lt;p&gt;1、客户端可以订阅频道如下图&lt;/p&gt;
&lt;p&gt;&lt;img src="https://daemon365.dev/images/96a0c4ca-666f-475e-8dd0-bfbd37f4dbb6.png" alt=""&gt;&lt;/p&gt;
&lt;p&gt;2、当给这个频道发布消息后，消息就会发送给订阅的客户端&lt;/p&gt;
&lt;p&gt;&lt;img src="https://daemon365.dev/images/0c0ca636-05df-4d97-b2fe-fc3d48fba4aa.png" alt=""&gt;&lt;/p&gt;
&lt;h2 id="发布订阅命令行实现"&gt;发布订阅命令行实现&lt;/h2&gt;
&lt;p&gt;1、 打开一个客户端订阅channel1&lt;/p&gt;
&lt;p&gt;SUBSCRIBE channel1&lt;/p&gt;
&lt;p&gt;&lt;img src="https://daemon365.dev/images/8218b975-9bf5-4f05-afc9-675107cd6362.png" alt=""&gt;&lt;/p&gt;
&lt;p&gt;2、打开另一个客户端，给channel1发布消息hello&lt;/p&gt;
&lt;p&gt;publish channel1 hello&lt;/p&gt;
&lt;p&gt;&lt;img src="https://daemon365.dev/images/3948289f-dcd0-4f46-8b0d-b286f7cee2dd.png" alt=""&gt;&lt;/p&gt;
&lt;p&gt;返回的1是订阅者数量&lt;/p&gt;
&lt;p&gt;3、打开第一个客户端可以看到发送的消息&lt;/p&gt;
&lt;p&gt;&lt;img src="https://daemon365.dev/images/5196ef36-5138-45a4-b6d4-b299b4dc5933.png" alt=""&gt;&lt;/p&gt;
&lt;p&gt;注：发布的消息没有持久化，如果在订阅的客户端收不到hello，只能收到订阅后发布的消息&lt;/p&gt;</description><content:encoded><![CDATA[<h2 id="什么是发布和订阅">什么是发布和订阅</h2>
<p>Redis 发布订阅 (pub/sub) 是一种消息通信模式：发送者 (pub) 发送消息，订阅者 (sub) 接收消息。</p>
<p>Redis 客户端可以订阅任意数量的频道。</p>
<h2 id="发布和订阅">发布和订阅</h2>
<p>1、客户端可以订阅频道如下图</p>
<p><img src="/images/96a0c4ca-666f-475e-8dd0-bfbd37f4dbb6.png" alt=""></p>
<p>2、当给这个频道发布消息后，消息就会发送给订阅的客户端</p>
<p><img src="/images/0c0ca636-05df-4d97-b2fe-fc3d48fba4aa.png" alt=""></p>
<h2 id="发布订阅命令行实现">发布订阅命令行实现</h2>
<p>1、 打开一个客户端订阅channel1</p>
<p>SUBSCRIBE channel1</p>
<p><img src="/images/8218b975-9bf5-4f05-afc9-675107cd6362.png" alt=""></p>
<p>2、打开另一个客户端，给channel1发布消息hello</p>
<p>publish channel1 hello</p>
<p><img src="/images/3948289f-dcd0-4f46-8b0d-b286f7cee2dd.png" alt=""></p>
<p>返回的1是订阅者数量</p>
<p>3、打开第一个客户端可以看到发送的消息</p>
<p><img src="/images/5196ef36-5138-45a4-b6d4-b299b4dc5933.png" alt=""></p>
<p>注：发布的消息没有持久化，如果在订阅的客户端收不到hello，只能收到订阅后发布的消息</p>
]]></content:encoded><category>database</category><category>redis</category></item><item><title>分布式ID生成器及redis，etcd分布式锁</title><link>https://daemon365.dev/post/microservice/distributed_id_generator_and_redis__etcd_distributed_lock/</link><pubDate>Fri, 30 Apr 2021 00:00:00 +0800</pubDate><guid>https://daemon365.dev/post/microservice/distributed_id_generator_and_redis__etcd_distributed_lock/</guid><description>&lt;h2 id="分布式id生成器"&gt;分布式id生成器&lt;/h2&gt;
&lt;p&gt;有时我们需要能够生成类似MySQL自增ID这样不断增大，同时又不会重复的id。以支持业务中的高并发场景。比较典型的，电商促销时，短时间内会有大量的订单涌入到系统，比如每秒10w+。明星出轨时，会有大量热情的粉丝发微博以表心意，同样会在短时间内产生大量的消息。&lt;/p&gt;
&lt;p&gt;在插入数据库之前，我们需要给这些消息、订单先打上一个ID，然后再插入到我们的数据库。对这个id的要求是希望其中能带有一些时间信息，这样即使我们后端的系统对消息进行了分库分表，也能够以时间顺序对这些消息进行排序。&lt;/p&gt;
&lt;p&gt;&lt;em&gt;Twitter的snowflake算法是这种场景下的一个典型解法。先来看看snowflake是怎么一回事&lt;/em&gt;：&lt;/p&gt;
&lt;p&gt;&lt;img src="https://daemon365.dev/images/d0798666-9a18-403b-bdea-cdabfe94975e.png" alt=""&gt;&lt;/p&gt;
&lt;p&gt;&lt;em&gt;snowflake中的比特位分布&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;首先确定我们的数值是64位，int64类型，被划分为四部分，不含开头的第一个bit，因为这个bit是符号位。用41位来表示收到请求时的时间戳，单位为毫秒，然后五位来表示数据中心的id，然后再五位来表示机器的实例id，最后是12位的循环自增id（到达1111,1111,1111后会归0）。&lt;/p&gt;
&lt;p&gt;这样的机制可以支持我们在同一台机器上，同一毫秒内产生&lt;code&gt;2 ^ 12 = 4096&lt;/code&gt;条消息。一秒共409.6万条消息。从值域上来讲完全够用了。&lt;/p&gt;
&lt;p&gt;数据中心加上实例id共有10位，可以支持我们每数据中心部署32台机器，所有数据中心共1024台实例。&lt;/p&gt;
&lt;p&gt;表示&lt;code&gt;timestamp&lt;/code&gt;的41位，可以支持我们使用69年。当然，我们的时间毫秒计数不会真的从1970年开始记，那样我们的系统跑到&lt;code&gt;2039/9/7 23:47:35&lt;/code&gt;就不能用了，所以这里的&lt;code&gt;timestamp&lt;/code&gt;实际上只是相对于某个时间的增量，比如我们的系统上线是2018-08-01，那么我们可以把这个timestamp当作是从&lt;code&gt;2018-08-01 00:00:00.000&lt;/code&gt;的偏移量。&lt;/p&gt;
&lt;h3 id="worker_id分配"&gt;worker_id分配&lt;/h3&gt;
&lt;p&gt;&lt;code&gt;timestamp&lt;/code&gt;，&lt;code&gt;datacenter_id&lt;/code&gt;，&lt;code&gt;worker_id&lt;/code&gt;和&lt;code&gt;sequence_id&lt;/code&gt;这四个字段中，&lt;code&gt;timestamp&lt;/code&gt;和&lt;code&gt;sequence_id&lt;/code&gt;是由程序在运行期生成的。但&lt;code&gt;datacenter_id&lt;/code&gt;和&lt;code&gt;worker_id&lt;/code&gt;需要我们在部署阶段就能够获取得到，并且一旦程序启动之后，就是不可更改的了（想想，如果可以随意更改，可能被不慎修改，造成最终生成的id有冲突）。&lt;/p&gt;
&lt;p&gt;一般不同数据中心的机器，会提供对应的获取数据中心id的API，所以&lt;code&gt;datacenter_id&lt;/code&gt;我们可以在部署阶段轻松地获取到。而worker_id是我们逻辑上给机器分配的一个id，这个要怎么办呢？比较简单的想法是由能够提供这种自增id功能的工具来支持，比如MySQL:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;mysql&amp;gt; insert into a &lt;span style="color:#f92672"&gt;(&lt;/span&gt;ip&lt;span style="color:#f92672"&gt;)&lt;/span&gt; values&lt;span style="color:#f92672"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;10.1.2.101&amp;#34;&lt;/span&gt;&lt;span style="color:#f92672"&gt;)&lt;/span&gt;&lt;span style="color:#111"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;Query OK, &lt;span style="color:#ae81ff"&gt;1&lt;/span&gt; row affected &lt;span style="color:#f92672"&gt;(&lt;/span&gt;0.00 sec&lt;span style="color:#f92672"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;mysql&amp;gt; &lt;span style="color:#00a8c8"&gt;select&lt;/span&gt; last_insert_id&lt;span style="color:#f92672"&gt;()&lt;/span&gt;&lt;span style="color:#111"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;+------------------+
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;|&lt;/span&gt; last_insert_id&lt;span style="color:#f92672"&gt;()&lt;/span&gt; &lt;span style="color:#111"&gt;|&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;+------------------+
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;|&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;2&lt;/span&gt; &lt;span style="color:#111"&gt;|&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;+------------------+
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#ae81ff"&gt;1&lt;/span&gt; row in &lt;span style="color:#111"&gt;set&lt;/span&gt; &lt;span style="color:#f92672"&gt;(&lt;/span&gt;0.00 sec&lt;span style="color:#f92672"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;从MySQL中获取到&lt;code&gt;worker_id&lt;/code&gt;之后，就把这个&lt;code&gt;worker_id&lt;/code&gt;直接持久化到本地，以避免每次上线时都需要获取新的&lt;code&gt;worker_id&lt;/code&gt;。让单实例的&lt;code&gt;worker_id&lt;/code&gt;可以始终保持不变。&lt;/p&gt;
&lt;p&gt;当然，使用MySQL相当于给我们简单的id生成服务增加了一个外部依赖。依赖越多，我们的服务的可运维性就越差。&lt;/p&gt;
&lt;p&gt;考虑到集群中即使有单个id生成服务的实例挂了，也就是损失一段时间的一部分id，所以我们也可以更简单暴力一些，把&lt;code&gt;worker_id&lt;/code&gt;直接写在worker的配置中，上线时，由部署脚本完成&lt;code&gt;worker_id&lt;/code&gt;字段替换。&lt;/p&gt;
&lt;h3 id="开源实例"&gt;开源实例&lt;/h3&gt;
&lt;h4 id="标准snowflake实现"&gt;标准snowflake实现&lt;/h4&gt;
&lt;p&gt;&lt;code&gt;github.com/bwmarrin/snowflake&lt;/code&gt; 是一个相当轻量化的snowflake的Go实现。其文档对各位使用的定义见&lt;em&gt;图 6-2&lt;/em&gt;所示。&lt;/p&gt;
&lt;p&gt;&lt;img src="https://daemon365.dev/images/ae01d265-414e-4c7a-ab33-bb94ac47b6fb.png" alt=""&gt;&lt;/p&gt;
&lt;p&gt;&lt;em&gt;图 6-2 snowflake库&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;和标准的snowflake完全一致。使用上比较简单：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;package&lt;/span&gt; &lt;span style="color:#75af00"&gt;main&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;import&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;fmt&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;os&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;github.com/bwmarrin/snowflake&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;main&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;n&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;snowflake&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;NewNode&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;1&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;!=&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;err&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;os&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Exit&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;1&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;for&lt;/span&gt; &lt;span style="color:#75af00"&gt;i&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;0&lt;/span&gt;&lt;span style="color:#111"&gt;;&lt;/span&gt; &lt;span style="color:#75af00"&gt;i&lt;/span&gt; &lt;span style="color:#111"&gt;&amp;lt;&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;3&lt;/span&gt;&lt;span style="color:#111"&gt;;&lt;/span&gt; &lt;span style="color:#75af00"&gt;i&lt;/span&gt;&lt;span style="color:#f92672"&gt;++&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;id&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;n&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Generate&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;id&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;id&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;node: &amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;id&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Node&lt;/span&gt;&lt;span style="color:#111"&gt;(),&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;step: &amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;id&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Step&lt;/span&gt;&lt;span style="color:#111"&gt;(),&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;time: &amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;id&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Time&lt;/span&gt;&lt;span style="color:#111"&gt;(),&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;\n&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;当然，这个库也给我们留好了定制的后路，其中预留了一些可定制字段：&lt;/p&gt;</description><content:encoded><![CDATA[<h2 id="分布式id生成器">分布式id生成器</h2>
<p>有时我们需要能够生成类似MySQL自增ID这样不断增大，同时又不会重复的id。以支持业务中的高并发场景。比较典型的，电商促销时，短时间内会有大量的订单涌入到系统，比如每秒10w+。明星出轨时，会有大量热情的粉丝发微博以表心意，同样会在短时间内产生大量的消息。</p>
<p>在插入数据库之前，我们需要给这些消息、订单先打上一个ID，然后再插入到我们的数据库。对这个id的要求是希望其中能带有一些时间信息，这样即使我们后端的系统对消息进行了分库分表，也能够以时间顺序对这些消息进行排序。</p>
<p><em>Twitter的snowflake算法是这种场景下的一个典型解法。先来看看snowflake是怎么一回事</em>：</p>
<p><img src="/images/d0798666-9a18-403b-bdea-cdabfe94975e.png" alt=""></p>
<p><em>snowflake中的比特位分布</em></p>
<p>首先确定我们的数值是64位，int64类型，被划分为四部分，不含开头的第一个bit，因为这个bit是符号位。用41位来表示收到请求时的时间戳，单位为毫秒，然后五位来表示数据中心的id，然后再五位来表示机器的实例id，最后是12位的循环自增id（到达1111,1111,1111后会归0）。</p>
<p>这样的机制可以支持我们在同一台机器上，同一毫秒内产生<code>2 ^ 12 = 4096</code>条消息。一秒共409.6万条消息。从值域上来讲完全够用了。</p>
<p>数据中心加上实例id共有10位，可以支持我们每数据中心部署32台机器，所有数据中心共1024台实例。</p>
<p>表示<code>timestamp</code>的41位，可以支持我们使用69年。当然，我们的时间毫秒计数不会真的从1970年开始记，那样我们的系统跑到<code>2039/9/7 23:47:35</code>就不能用了，所以这里的<code>timestamp</code>实际上只是相对于某个时间的增量，比如我们的系统上线是2018-08-01，那么我们可以把这个timestamp当作是从<code>2018-08-01 00:00:00.000</code>的偏移量。</p>
<h3 id="worker_id分配">worker_id分配</h3>
<p><code>timestamp</code>，<code>datacenter_id</code>，<code>worker_id</code>和<code>sequence_id</code>这四个字段中，<code>timestamp</code>和<code>sequence_id</code>是由程序在运行期生成的。但<code>datacenter_id</code>和<code>worker_id</code>需要我们在部署阶段就能够获取得到，并且一旦程序启动之后，就是不可更改的了（想想，如果可以随意更改，可能被不慎修改，造成最终生成的id有冲突）。</p>
<p>一般不同数据中心的机器，会提供对应的获取数据中心id的API，所以<code>datacenter_id</code>我们可以在部署阶段轻松地获取到。而worker_id是我们逻辑上给机器分配的一个id，这个要怎么办呢？比较简单的想法是由能够提供这种自增id功能的工具来支持，比如MySQL:</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>mysql&gt; insert into a <span style="color:#f92672">(</span>ip<span style="color:#f92672">)</span> values<span style="color:#f92672">(</span><span style="color:#d88200">&#34;10.1.2.101&#34;</span><span style="color:#f92672">)</span><span style="color:#111">;</span>
</span></span><span style="display:flex;"><span>Query OK, <span style="color:#ae81ff">1</span> row affected <span style="color:#f92672">(</span>0.00 sec<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>mysql&gt; <span style="color:#00a8c8">select</span> last_insert_id<span style="color:#f92672">()</span><span style="color:#111">;</span>
</span></span><span style="display:flex;"><span>+------------------+
</span></span><span style="display:flex;"><span><span style="color:#111">|</span> last_insert_id<span style="color:#f92672">()</span> <span style="color:#111">|</span>
</span></span><span style="display:flex;"><span>+------------------+
</span></span><span style="display:flex;"><span><span style="color:#111">|</span>                <span style="color:#ae81ff">2</span> <span style="color:#111">|</span>
</span></span><span style="display:flex;"><span>+------------------+
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span> row in <span style="color:#111">set</span> <span style="color:#f92672">(</span>0.00 sec<span style="color:#f92672">)</span>
</span></span></code></pre></div><p>从MySQL中获取到<code>worker_id</code>之后，就把这个<code>worker_id</code>直接持久化到本地，以避免每次上线时都需要获取新的<code>worker_id</code>。让单实例的<code>worker_id</code>可以始终保持不变。</p>
<p>当然，使用MySQL相当于给我们简单的id生成服务增加了一个外部依赖。依赖越多，我们的服务的可运维性就越差。</p>
<p>考虑到集群中即使有单个id生成服务的实例挂了，也就是损失一段时间的一部分id，所以我们也可以更简单暴力一些，把<code>worker_id</code>直接写在worker的配置中，上线时，由部署脚本完成<code>worker_id</code>字段替换。</p>
<h3 id="开源实例">开源实例</h3>
<h4 id="标准snowflake实现">标准snowflake实现</h4>
<p><code>github.com/bwmarrin/snowflake</code> 是一个相当轻量化的snowflake的Go实现。其文档对各位使用的定义见<em>图 6-2</em>所示。</p>
<p><img src="/images/ae01d265-414e-4c7a-ab33-bb94ac47b6fb.png" alt=""></p>
<p><em>图 6-2 snowflake库</em></p>
<p>和标准的snowflake完全一致。使用上比较简单：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d88200">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#d88200">&#34;github.com/bwmarrin/snowflake&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">n</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">snowflake</span><span style="color:#111">.</span><span style="color:#75af00">NewNode</span><span style="color:#111">(</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">println</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">Exit</span><span style="color:#111">(</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">for</span> <span style="color:#75af00">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span><span style="color:#111">;</span> <span style="color:#75af00">i</span> <span style="color:#111">&lt;</span> <span style="color:#ae81ff">3</span><span style="color:#111">;</span> <span style="color:#75af00">i</span><span style="color:#f92672">++</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">id</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">Generate</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;id&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">id</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>            <span style="color:#d88200">&#34;node: &#34;</span><span style="color:#111">,</span> <span style="color:#75af00">id</span><span style="color:#111">.</span><span style="color:#75af00">Node</span><span style="color:#111">(),</span>
</span></span><span style="display:flex;"><span>            <span style="color:#d88200">&#34;step: &#34;</span><span style="color:#111">,</span> <span style="color:#75af00">id</span><span style="color:#111">.</span><span style="color:#75af00">Step</span><span style="color:#111">(),</span>
</span></span><span style="display:flex;"><span>            <span style="color:#d88200">&#34;time: &#34;</span><span style="color:#111">,</span> <span style="color:#75af00">id</span><span style="color:#111">.</span><span style="color:#75af00">Time</span><span style="color:#111">(),</span>
</span></span><span style="display:flex;"><span>            <span style="color:#d88200">&#34;\n&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>当然，这个库也给我们留好了定制的后路，其中预留了一些可定制字段：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>    <span style="color:#75715e">// Epoch is set to the twitter snowflake epoch of Nov 04 2010 01:42:54 UTC</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// You may customize this to set a different epoch for your application.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">Epoch</span> <span style="color:#00a8c8">int64</span> <span style="color:#111">=</span> <span style="color:#ae81ff">1288834974657</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Number of bits to use for Node</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Remember, you have a total 22 bits to share between Node/Step</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">NodeBits</span> <span style="color:#00a8c8">uint8</span> <span style="color:#111">=</span> <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Number of bits to use for Step</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Remember, you have a total 22 bits to share between Node/Step</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">StepBits</span> <span style="color:#00a8c8">uint8</span> <span style="color:#111">=</span> <span style="color:#ae81ff">12</span>
</span></span></code></pre></div><p><code>Epoch</code>就是本节开头讲的起始时间，<code>NodeBits</code>指的是机器编号的位长，<code>StepBits</code>指的是自增序列的位长。</p>
<h4 id="sonyflake">sonyflake</h4>
<p>sonyflake是Sony公司的一个开源项目，基本思路和snowflake差不多，不过位分配上稍有不同，见<em>图 6-3</em>：</p>
<p><img src="/images/aaed5ffb-d920-4e59-955f-8e52540d5351.png" alt=""></p>
<p><em>图 6-3 sonyflake</em></p>
<p>这里的时间只用了39个bit，但时间的单位变成了10ms，所以理论上比41位表示的时间还要久(174年)。</p>
<p><code>Sequence ID</code>和之前的定义一致，<code>Machine ID</code>其实就是节点id。<code>sonyflake</code>与众不同的地方在于其在启动阶段的配置参数：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">NewSonyflake</span><span style="color:#111">(</span><span style="color:#75af00">st</span> <span style="color:#75af00">Settings</span><span style="color:#111">)</span> <span style="color:#f92672">*</span><span style="color:#75af00">Sonyflake</span>
</span></span></code></pre></div><p><code>Settings</code>数据结构如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Settings</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">StartTime</span>      <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Time</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">MachineID</span>      <span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#111">(</span><span style="color:#00a8c8">uint16</span><span style="color:#111">,</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">CheckMachineID</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#00a8c8">uint16</span><span style="color:#111">)</span> <span style="color:#00a8c8">bool</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p><code>StartTime</code>选项和我们之前的<code>Epoch</code>差不多，如果不设置的话，默认是从<code>2014-09-01 00:00:00 +0000 UTC</code>开始。</p>
<p><code>MachineID</code>可以由用户自定义的函数，如果用户不定义的话，会默认将本机IP的低16位作为<code>machine id</code>。</p>
<p><code>CheckMachineID</code>是由用户提供的检查<code>MachineID</code>是否冲突的函数。这里的设计还是比较巧妙的，如果有另外的中心化存储并支持检查重复的存储，那我们就可以按照自己的想法随意定制这个检查<code>MachineID</code>是否冲突的逻辑。如果公司有现成的Redis集群，那么我们可以很轻松地用Redis的集合类型来检查冲突。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>redis 127.0.0.1:6379&gt; SADD base64_encoding_of_last16bits <span style="color:#111">MzI0Mgo</span><span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">(</span>integer<span style="color:#f92672">)</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>redis 127.0.0.1:6379&gt; SADD base64_encoding_of_last16bits <span style="color:#111">MzI0Mgo</span><span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">(</span>integer<span style="color:#f92672">)</span> <span style="color:#ae81ff">0</span>
</span></span></code></pre></div><p>使用起来也比较简单，有一些逻辑简单的函数就略去实现了：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d88200">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d88200">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#d88200">&#34;github.com/sony/sonyflake&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">getMachineID</span><span style="color:#111">()</span> <span style="color:#111">(</span><span style="color:#00a8c8">uint16</span><span style="color:#111">,</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">var</span> <span style="color:#75af00">machineID</span> <span style="color:#00a8c8">uint16</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">var</span> <span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">machineID</span> <span style="color:#111">=</span> <span style="color:#75af00">readMachineIDFromLocalFile</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">machineID</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">machineID</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">generateMachineID</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">return</span> <span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#75af00">machineID</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">checkMachineID</span><span style="color:#111">(</span><span style="color:#75af00">machineID</span> <span style="color:#00a8c8">uint16</span><span style="color:#111">)</span> <span style="color:#00a8c8">bool</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">saddResult</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">saddMachineIDToRedisSet</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#f92672">||</span> <span style="color:#75af00">saddResult</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#00a8c8">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">saveMachineIDToLocalFile</span><span style="color:#111">(</span><span style="color:#75af00">machineID</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#00a8c8">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#00a8c8">false</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">t</span><span style="color:#111">,</span> <span style="color:#75af00">_</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Parse</span><span style="color:#111">(</span><span style="color:#d88200">&#34;2006-01-02&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;2018-01-01&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">settings</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">sonyflake</span><span style="color:#111">.</span><span style="color:#75af00">Settings</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">StartTime</span><span style="color:#111">:</span>      <span style="color:#75af00">t</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">MachineID</span><span style="color:#111">:</span>      <span style="color:#75af00">getMachineID</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">CheckMachineID</span><span style="color:#111">:</span> <span style="color:#75af00">checkMachineID</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">sf</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">sonyflake</span><span style="color:#111">.</span><span style="color:#75af00">NewSonyflake</span><span style="color:#111">(</span><span style="color:#75af00">settings</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">id</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">sf</span><span style="color:#111">.</span><span style="color:#75af00">NextID</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">Exit</span><span style="color:#111">(</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">id</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="分布式锁">分布式锁</h2>
<p>在单机程序并发或并行修改全局变量时，需要对修改行为加锁以创造临界区。为什么需要加锁呢？我们看看在不加锁的情况下并发计数会发生什么情况：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d88200">&#34;sync&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 全局变量</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">var</span> <span style="color:#75af00">counter</span> <span style="color:#00a8c8">int</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">var</span> <span style="color:#75af00">wg</span> <span style="color:#75af00">sync</span><span style="color:#111">.</span><span style="color:#75af00">WaitGroup</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">for</span> <span style="color:#75af00">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span><span style="color:#111">;</span> <span style="color:#75af00">i</span> <span style="color:#111">&lt;</span> <span style="color:#ae81ff">1000</span><span style="color:#111">;</span> <span style="color:#75af00">i</span><span style="color:#f92672">++</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">wg</span><span style="color:#111">.</span><span style="color:#75af00">Add</span><span style="color:#111">(</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">go</span> <span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">defer</span> <span style="color:#75af00">wg</span><span style="color:#111">.</span><span style="color:#75af00">Done</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75af00">counter</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">wg</span><span style="color:#111">.</span><span style="color:#75af00">Wait</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">println</span><span style="color:#111">(</span><span style="color:#75af00">counter</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>多次运行会得到不同的结果：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>❯❯❯ go run local_lock.go
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">945</span>
</span></span><span style="display:flex;"><span>❯❯❯ go run local_lock.go
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">937</span>
</span></span><span style="display:flex;"><span>❯❯❯ go run local_lock.go
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">959</span>
</span></span></code></pre></div><h3 id="基于redis的setnx">基于Redis的setnx</h3>
<p>在分布式场景下，我们也需要这种“抢占”的逻辑，这时候怎么办呢？我们可以使用Redis提供的<code>setnx</code>命令：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;github.com/go-redis/redis&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;github.com/gofrs/uuid&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 声明一个全局的rdb变量</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">var</span> <span style="color:#75af00">rdb</span> <span style="color:#f92672">*</span><span style="color:#75af00">redis</span><span style="color:#111">.</span><span style="color:#75af00">Client</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 初始化连接</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">initClient</span><span style="color:#111">()</span> <span style="color:#111">(</span><span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">rdb</span> <span style="color:#111">=</span> <span style="color:#75af00">redis</span><span style="color:#111">.</span><span style="color:#75af00">NewClient</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">redis</span><span style="color:#111">.</span><span style="color:#75af00">Options</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">Addr</span><span style="color:#111">:</span>     <span style="color:#d88200">&#34;localhost:6379&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">Password</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;zhy1996&#34;</span><span style="color:#111">,</span> <span style="color:#75715e">// no password set</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">DB</span><span style="color:#111">:</span>       <span style="color:#ae81ff">0</span><span style="color:#111">,</span>         <span style="color:#75715e">// use default DB</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">rdb</span><span style="color:#111">.</span><span style="color:#75af00">Ping</span><span style="color:#111">().</span><span style="color:#75af00">Result</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">var</span> <span style="color:#75af00">unlock_lua</span> <span style="color:#111">=</span> <span style="color:#d88200">`
</span></span></span><span style="display:flex;"><span><span style="color:#d88200">if redis.call(&#34;get&#34;,KEYS[1]) == ARGV[1] then
</span></span></span><span style="display:flex;"><span><span style="color:#d88200">	return redis.call(&#34;del&#34;,KEYS[1])
</span></span></span><span style="display:flex;"><span><span style="color:#d88200">else
</span></span></span><span style="display:flex;"><span><span style="color:#d88200">	return 0
</span></span></span><span style="display:flex;"><span><span style="color:#d88200">end
</span></span></span><span style="display:flex;"><span><span style="color:#d88200">`</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">Lock</span><span style="color:#111">(</span><span style="color:#75af00">key</span><span style="color:#111">,</span> <span style="color:#75af00">value</span> <span style="color:#00a8c8">string</span><span style="color:#111">,</span> <span style="color:#75af00">expiration</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Duration</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#00a8c8">bool</span><span style="color:#111">,</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">is</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">rdb</span><span style="color:#111">.</span><span style="color:#75af00">SetNX</span><span style="color:#111">(</span><span style="color:#75af00">key</span><span style="color:#111">,</span> <span style="color:#75af00">value</span><span style="color:#111">,</span> <span style="color:#75af00">expiration</span><span style="color:#111">).</span><span style="color:#75af00">Result</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">false</span><span style="color:#111">,</span> <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;redis setnx failed&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">is</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">UnLock</span><span style="color:#111">(</span><span style="color:#75af00">key</span><span style="color:#111">,</span> <span style="color:#75af00">value</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#00a8c8">bool</span><span style="color:#111">,</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">res</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">rdb</span><span style="color:#111">.</span><span style="color:#75af00">Eval</span><span style="color:#111">(</span><span style="color:#75af00">unlock_lua</span><span style="color:#111">,</span> <span style="color:#111">[]</span><span style="color:#00a8c8">string</span><span style="color:#111">{</span><span style="color:#75af00">key</span><span style="color:#111">},</span> <span style="color:#75af00">value</span><span style="color:#111">).</span><span style="color:#75af00">Result</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">false</span><span style="color:#111">,</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">v</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">res</span><span style="color:#111">.(</span><span style="color:#00a8c8">int64</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">false</span><span style="color:#111">,</span> <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;lua script return is not int&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">v</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">false</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">true</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">initClient</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ul</span><span style="color:#111">,</span> <span style="color:#75af00">_</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">uuid</span><span style="color:#111">.</span><span style="color:#75af00">NewV4</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">value</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">ul</span><span style="color:#111">.</span><span style="color:#75af00">String</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span><span style="color:#111">;</span> <span style="color:#75af00">i</span> <span style="color:#111">&lt;</span> <span style="color:#ae81ff">10</span><span style="color:#111">;</span> <span style="color:#75af00">i</span><span style="color:#f92672">++</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">is</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">Lock</span><span style="color:#111">(</span><span style="color:#d88200">&#34;lock_1&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">value</span><span style="color:#111">,</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Second</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;是否拿到锁:&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">is</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">res</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">UnLock</span><span style="color:#111">(</span><span style="color:#d88200">&#34;lock_1&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">value</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;解锁:&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">res</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>看看运行结果：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>是否拿到锁: <span style="color:#111">true</span>
</span></span><span style="display:flex;"><span>是否拿到锁: <span style="color:#111">false</span>
</span></span><span style="display:flex;"><span>是否拿到锁: <span style="color:#111">false</span>
</span></span><span style="display:flex;"><span>是否拿到锁: <span style="color:#111">false</span>
</span></span><span style="display:flex;"><span>是否拿到锁: <span style="color:#111">false</span>
</span></span><span style="display:flex;"><span>是否拿到锁: <span style="color:#111">false</span>
</span></span><span style="display:flex;"><span>是否拿到锁: <span style="color:#111">false</span>
</span></span><span style="display:flex;"><span>是否拿到锁: <span style="color:#111">false</span>
</span></span><span style="display:flex;"><span>是否拿到锁: <span style="color:#111">false</span>
</span></span><span style="display:flex;"><span>是否拿到锁: <span style="color:#111">false</span>
</span></span><span style="display:flex;"><span>解锁: <span style="color:#111">true</span>
</span></span></code></pre></div><p>通过代码和执行结果可以看到，我们远程调用<code>setnx</code>实际上和单机的trylock非常相似，如果获取锁失败，那么相关的任务逻辑就不应该继续向前执行。</p>
<p><code>setnx</code>很适合在高并发场景下，用来争抢一些“唯一”的资源。比如交易撮合系统中卖家发起订单，而多个买家会对其进行并发争抢。这种场景我们没有办法依赖具体的时间来判断先后，因为不管是用户设备的时间，还是分布式场景下的各台机器的时间，都是没有办法在合并后保证正确的时序的。哪怕是我们同一个机房的集群，不同的机器的系统时间可能也会有细微的差别。</p>
<p>所以，我们需要依赖于这些请求到达Redis节点的顺序来做正确的抢锁操作。如果用户的网络环境比较差，那也只能自求多福了。</p>
<h3 id="基于etcd">基于etcd</h3>
<p>etcd是分布式系统中，功能上与ZooKeeper类似的组件，这两年越来越火了。上面基于ZooKeeper我们实现了分布式阻塞锁，基于etcd，也可以实现类似的功能：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d88200">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#d88200">&#34;github.com/zieckey/etcdsync&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">m</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">etcdsync</span><span style="color:#111">.</span><span style="color:#75af00">New</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/lock&#34;</span><span style="color:#111">,</span> <span style="color:#ae81ff">10</span><span style="color:#111">,</span> <span style="color:#111">[]</span><span style="color:#00a8c8">string</span><span style="color:#111">{</span><span style="color:#d88200">&#34;http://127.0.0.1:2379&#34;</span><span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">m</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#f92672">||</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;etcdsync.New failed&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">Lock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;etcdsync.Lock failed&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;etcdsync.Lock OK&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Get the lock. Do something here.&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">Unlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;etcdsync.Unlock failed&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;etcdsync.Unlock OK&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>etcd中没有像ZooKeeper那样的Sequence节点。所以其锁实现和基于ZooKeeper实现的有所不同。在上述示例代码中使用的etcdsync的Lock流程是：</p>
<ol>
<li>先检查<code>/lock</code>路径下是否有值，如果有值，说明锁已经被别人抢了</li>
<li>如果没有值，那么写入自己的值。写入成功返回，说明加锁成功。写入时如果节点被其它节点写入过了，那么会导致加锁失败，这时候到 3</li>
<li>watch <code>/lock</code>下的事件，此时陷入阻塞</li>
<li>当<code>/lock</code>路径下发生事件时，当前进程被唤醒。检查发生的事件是否是删除事件（说明锁被持有者主动unlock），或者过期事件（说明锁过期失效）。如果是的话，那么回到 1，走抢锁流程。</li>
</ol>
<p>值得一提的是，在etcdv3的API中官方已经提供了可以直接使用的锁API，读者可以查阅etcd的文档做进一步的学习。</p>
<p>参考文章：《go语言高级编程》</p>
]]></content:encoded><category>microservice</category><category>redis</category><category>etcd</category></item><item><title>redis持久化</title><link>https://daemon365.dev/post/database/redis_persistence/</link><pubDate>Sat, 21 Mar 2020 00:00:00 +0800</pubDate><guid>https://daemon365.dev/post/database/redis_persistence/</guid><description>&lt;p&gt;Redis是一种内存型数据库，一旦服务器进程退出，数据库的数据就会丢失，为了解决这个问题，Redis提供了两种持久化的方案，将内存中的数据保存到磁盘中，避免数据的丢失。&lt;/p&gt;
&lt;h2 id="rdb持久化"&gt;RDB持久化&lt;/h2&gt;
&lt;p&gt;redis提供了RDB持久化的功能，这个功能可以将redis在内存中的的状态保存到硬盘中，它可以&lt;strong&gt;手动执行。&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;也可以再redis.conf中配置，&lt;strong&gt;定期执行&lt;/strong&gt;。&lt;/p&gt;
&lt;p&gt;RDB持久化产生的RDB文件是一个&lt;strong&gt;经过压缩&lt;/strong&gt;的&lt;strong&gt;二进制文件&lt;/strong&gt;，这个文件被保存在硬盘中，redis可以通过这个文件还原数据库当时的状态。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;内存数据保存到磁盘&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;在指定的时间间隔内生成数据集的时间点快照（point-in-time snapshot）&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;优点：速度快，适合做备份，主从复制就是基于RDB持久化功能实现&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;rdb通过再redis中使用save命令触发 rdb&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;ol&gt;
&lt;li&gt;rdb配置参数： &lt;code&gt;dir /data/6379/ dbfilename dbmp.rdb&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;每过900秒 有1个操作就进行持久化 save 900秒 1个修改类的操作 save 300秒 10个操作 save 60秒 10000个操作 &lt;code&gt;save 900 1 save 300 10 save 60 10000&lt;/code&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id="redis持久化之rdb实践"&gt;redis持久化之RDB实践&lt;/h3&gt;
&lt;p&gt;1.启动redis服务端,准备配置文件&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;daemonize yes port &lt;span style="color:#ae81ff"&gt;6379&lt;/span&gt; logfile /data/6379/redis.log dir /data/6379 &lt;span style="color:#75715e"&gt;#定义持久化文件存储位置 &lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;dbfilename dbmp.rdb &lt;span style="color:#75715e"&gt;#rdb持久化文件 &lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;bind&lt;/span&gt; 10.0.0.10 127.0.0.1 &lt;span style="color:#75715e"&gt;#redis绑定地址 &lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;requirepass redhat &lt;span style="color:#75715e"&gt;#redis登录密码 &lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;save &lt;span style="color:#ae81ff"&gt;900&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;1&lt;/span&gt; &lt;span style="color:#75715e"&gt;#rdb机制 每900秒 有1个修改记录 &lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;save &lt;span style="color:#ae81ff"&gt;300&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;10&lt;/span&gt; &lt;span style="color:#75715e"&gt;#每300秒 10个修改记录 &lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;save &lt;span style="color:#ae81ff"&gt;60&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;10000&lt;/span&gt; &lt;span style="color:#75715e"&gt;#每60秒内 10000修改记录&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;2.启动redis服务端&lt;/p&gt;
&lt;p&gt;3.登录redis设置一个key&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;redis-cli -a redhat
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;4.此时检查目录，/data/6379底下没有dbmp.rdb文件&lt;/p&gt;
&lt;p&gt;5.通过save触发持久化，将数据写入RDB文件&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;127.0.0.1:6379&amp;gt; &lt;span style="color:#111"&gt;set&lt;/span&gt; age &lt;span style="color:#ae81ff"&gt;18&lt;/span&gt; OK 127.0.0.1:6379&amp;gt; save OK
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id="aof持久化"&gt;AOF持久化&lt;/h2&gt;
&lt;p&gt;AOF（append-only log file）&lt;/p&gt;</description><content:encoded><![CDATA[<p>Redis是一种内存型数据库，一旦服务器进程退出，数据库的数据就会丢失，为了解决这个问题，Redis提供了两种持久化的方案，将内存中的数据保存到磁盘中，避免数据的丢失。</p>
<h2 id="rdb持久化">RDB持久化</h2>
<p>redis提供了RDB持久化的功能，这个功能可以将redis在内存中的的状态保存到硬盘中，它可以<strong>手动执行。</strong></p>
<p>也可以再redis.conf中配置，<strong>定期执行</strong>。</p>
<p>RDB持久化产生的RDB文件是一个<strong>经过压缩</strong>的<strong>二进制文件</strong>，这个文件被保存在硬盘中，redis可以通过这个文件还原数据库当时的状态。</p>
<ul>
<li>
<p>内存数据保存到磁盘</p>
</li>
<li>
<p>在指定的时间间隔内生成数据集的时间点快照（point-in-time snapshot）</p>
</li>
<li>
<p>优点：速度快，适合做备份，主从复制就是基于RDB持久化功能实现</p>
</li>
<li>
<p>rdb通过再redis中使用save命令触发 rdb</p>
</li>
</ul>
<ol>
<li>rdb配置参数： <code>dir /data/6379/ dbfilename dbmp.rdb</code></li>
<li>每过900秒 有1个操作就进行持久化 save 900秒 1个修改类的操作 save 300秒 10个操作 save 60秒 10000个操作  <code>save 900 1 save 300 10 save 60 10000</code></li>
</ol>
<h3 id="redis持久化之rdb实践">redis持久化之RDB实践</h3>
<p>1.启动redis服务端,准备配置文件</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>daemonize yes port <span style="color:#ae81ff">6379</span> logfile /data/6379/redis.log dir /data/6379    <span style="color:#75715e">#定义持久化文件存储位置 </span>
</span></span><span style="display:flex;"><span>dbfilename dbmp.rdb        <span style="color:#75715e">#rdb持久化文件 </span>
</span></span><span style="display:flex;"><span><span style="color:#111">bind</span> 10.0.0.10 127.0.0.1   <span style="color:#75715e">#redis绑定地址 </span>
</span></span><span style="display:flex;"><span>requirepass redhat         <span style="color:#75715e">#redis登录密码 </span>
</span></span><span style="display:flex;"><span>save <span style="color:#ae81ff">900</span> <span style="color:#ae81ff">1</span>                 <span style="color:#75715e">#rdb机制 每900秒 有1个修改记录 </span>
</span></span><span style="display:flex;"><span>save <span style="color:#ae81ff">300</span> <span style="color:#ae81ff">10</span>                <span style="color:#75715e">#每300秒       10个修改记录 </span>
</span></span><span style="display:flex;"><span>save <span style="color:#ae81ff">60</span> <span style="color:#ae81ff">10000</span>              <span style="color:#75715e">#每60秒内     10000修改记录</span>
</span></span></code></pre></div><p>2.启动redis服务端</p>
<p>3.登录redis设置一个key</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>redis-cli -a redhat
</span></span></code></pre></div><p>4.此时检查目录，/data/6379底下没有dbmp.rdb文件</p>
<p>5.通过save触发持久化，将数据写入RDB文件</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>127.0.0.1:6379&gt; <span style="color:#111">set</span> age <span style="color:#ae81ff">18</span> OK 127.0.0.1:6379&gt; save OK
</span></span></code></pre></div><h2 id="aof持久化">AOF持久化</h2>
<p>AOF（append-only log file）</p>
<ul>
<li>
<p>记录服务器执行的所有变更操作命令（例如set del等），并在服务器启动时，通过重新执行这些命令来还原数据集</p>
</li>
<li>
<p>AOF 文件中的命令全部以redis协议的格式保存，新命令追加到文件末尾。</p>
</li>
<li>
<p>优点：最大程序保证数据不丢</p>
</li>
<li>
<p>缺点：日志记录非常大</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>redis-client   写入数据  &gt;  redis-server   同步命令   &gt;  AOF文件
</span></span></code></pre></div><p>配置参数</p>
<pre tabindex="0"><code>AOF持久化配置，两条参数  
appendonly yes appendfsync always   总是修改类的操作  
everysec   每秒做一次持久化  no     依赖于系统自带的缓存大小机制
</code></pre><h3 id="redis持久化之aof实践">redis持久化之AOF实践</h3>
<p>1.准备aof配置文件 redis.conf</p>
<pre tabindex="0"><code>daemonize yes
port 6379 
logfile /data/6379/redis.log 
dir /data/6379 
dbfilename dbmp.rdb 
requirepass redhat 
save 900 1 
save 300 10 
save 60 10000 
appendonly yes 
appendfsync everysec
</code></pre><p>2.启动redis服务</p>
<pre tabindex="0"><code>redis-server /etc/redis.conf
</code></pre><p>3.检查redis数据目录/data/6379/是否产生了aof文件</p>
<pre tabindex="0"><code>[root@web02 6379]## ls appendonly.aof dbmp.rdb redis.log
</code></pre><p>4.登录redis-cli，写入数据，实时检查aof文件信息</p>
<pre tabindex="0"><code>[root@web02 6379]## tail -f appendonly.aof
</code></pre><p>5.设置新key，检查aof信息，然后关闭redis，检查数据是否持久化</p>
<pre tabindex="0"><code>redis-cli -a redhat shutdown  redis-server /etc/redis.conf  redis-cli -a redhat
</code></pre><h2 id="redis-持久化方式有哪些有什么区别">redis 持久化方式有哪些？有什么区别</h2>
<ul>
<li>
<p>rdb：基于快照的持久化，速度更快，一般用作备份，主从复制也是依赖于rdb持久化功能</p>
</li>
<li>
<p>aof：以追加的方式记录redis操作日志的文件。可以最大程度的保证redis数据安全，类似于mysql的binlog</p>
</li>
</ul>
<h2 id="redis不重启切换rdb备份到aof备份">redis不重启，切换RDB备份到AOF备份</h2>
<h3 id="确保redis版本在22以上">确保redis版本在2.2以上</h3>
<pre tabindex="0"><code>[root@pyyuc /data 22:23:30]#redis-server -v
Redis server v=4.0.10 sha=00000000:0 malloc=jemalloc-4.0.3 bits=64 build=64cb6afcf41664c
</code></pre><p>本文在redis4.0中，通过config set命令，达到不重启redis服务，从RDB持久化切换为AOF</p>
<h3 id="实验环境准备">实验环境准备</h3>
<p>redis.conf服务端配置文件</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#75af00">daemonize yes</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">port 6379</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">logfile /data/6379/redis.log</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">dir /data/6379</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">dbfilename  dbmp.rdb</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">save 900 1                    #rdb机制 每900秒 有1个修改记录</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">save 300 10                    #每300秒        10个修改记录</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">save 60  10000                #每60秒内        10000修改记录</span>
</span></span></code></pre></div><p>启动redis服务端</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#75af00">redis-server redis.conf</span>
</span></span></code></pre></div><p>登录redis-cli插入数据，手动持久化</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>127.0.0.1:6379&gt; <span style="color:#111">set</span> name chaoge
</span></span><span style="display:flex;"><span>OK
</span></span><span style="display:flex;"><span>127.0.0.1:6379&gt; <span style="color:#111">set</span> age <span style="color:#ae81ff">18</span>
</span></span><span style="display:flex;"><span>OK
</span></span><span style="display:flex;"><span>127.0.0.1:6379&gt; <span style="color:#111">set</span> addr shahe
</span></span><span style="display:flex;"><span>OK
</span></span><span style="display:flex;"><span>127.0.0.1:6379&gt; save
</span></span><span style="display:flex;"><span>OK
</span></span></code></pre></div><p>检查RDB文件</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@pyyuc /data 22:34:16<span style="color:#f92672">]</span><span style="color:#75715e">#ls 6379/</span>
</span></span><span style="display:flex;"><span>dbmp.rdb  redis.log
</span></span></code></pre></div><h3 id="备份这个rdb文件保证数据安全">备份这个rdb文件，保证数据安全</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@pyyuc /data/6379 22:35:38<span style="color:#f92672">]</span><span style="color:#75715e">#cp dbmp.rdb /opt/</span>
</span></span></code></pre></div><h3 id="执行命令开启aof持久化">执行命令，开启AOF持久化</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>127.0.0.1:6379&gt; CONFIG <span style="color:#111">set</span> appendonly yes   <span style="color:#75715e">#开启AOF功能</span>
</span></span><span style="display:flex;"><span>OK
</span></span><span style="display:flex;"><span>127.0.0.1:6379&gt; CONFIG SET save <span style="color:#d88200">&#34;&#34;</span>  <span style="color:#75715e">#关闭RDB功能</span>
</span></span><span style="display:flex;"><span>OK
</span></span></code></pre></div><h3 id="确保数据库的key数量正确">确保数据库的key数量正确</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>127.0.0.1:6379&gt; keys *
</span></span><span style="display:flex;"><span>1<span style="color:#f92672">)</span> <span style="color:#d88200">&#34;addr&#34;</span>
</span></span><span style="display:flex;"><span>2<span style="color:#f92672">)</span> <span style="color:#d88200">&#34;age&#34;</span>
</span></span><span style="display:flex;"><span>3<span style="color:#f92672">)</span> <span style="color:#d88200">&#34;name&#34;</span>
</span></span></code></pre></div><h3 id="确保插入新的keyaof文件会记录">确保插入新的key，AOF文件会记录</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>127.0.0.1:6379&gt; <span style="color:#111">set</span> title golang
</span></span><span style="display:flex;"><span>OK
</span></span></code></pre></div><p><strong>此时RDB已经正确切换AOF，注意还得修改redis.conf添加AOF设置，不然重启后，通过config set的配置将丢失</strong></p>
]]></content:encoded><category>database</category><category>redis</category></item><item><title>redis基础</title><link>https://daemon365.dev/post/database/redis_basics/</link><pubDate>Fri, 20 Mar 2020 00:00:00 +0800</pubDate><guid>https://daemon365.dev/post/database/redis_basics/</guid><description>&lt;h2 id="redis介绍"&gt;redis介绍&lt;/h2&gt;
&lt;p&gt;Redis 是完全开源的，遵守 BSD 协议，是一个高性能的 key-value 数据库。&lt;/p&gt;
&lt;p&gt;Redis 与其他 key - value 缓存产品有以下三个特点：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Redis支持数据的持久化，可以将内存中的数据保存在磁盘中，重启的时候可以再次加载进行使用。&lt;/li&gt;
&lt;li&gt;Redis不仅仅支持简单的key-value类型的数据，同时还提供list，set，zset，hash等数据结构的存储。&lt;/li&gt;
&lt;li&gt;Redis支持数据的备份，即master-slave模式的数据备份。&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id="redis的安装"&gt;redis的安装&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;brew install redis&lt;span style="color:#f92672"&gt;(&lt;/span&gt;mac&lt;span style="color:#f92672"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;yum install redis&lt;span style="color:#f92672"&gt;(&lt;/span&gt;centos&lt;span style="color:#f92672"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;apt-get install redis&lt;span style="color:#f92672"&gt;(&lt;/span&gt;ubuntu&lt;span style="color:#f92672"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id="redis的命令网站"&gt;redis的命令网站&lt;/h2&gt;
&lt;p&gt;&lt;a href="http://doc.redisfans.com/"&gt;Redis 命令参考 — Redis 命令参考 (redisfans.com)&lt;/a&gt;&lt;/p&gt;
&lt;h2 id="redis的基本操作"&gt;redis的基本操作&lt;/h2&gt;
&lt;h3 id="redis的五大数据类型"&gt;redis的五大数据类型&lt;/h3&gt;
&lt;p&gt;redis的五大数据类型是: &lt;strong&gt;String(字符串)、Hash(哈希)、List(列表)、Set(集合)、和zset(sorted set:有序集合)&lt;/strong&gt;&lt;/p&gt;
&lt;h3 id="redis键操作"&gt;redis键操作&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;keys *&lt;/code&gt;查看当前库所有key (匹配：keys *1)&lt;/li&gt;
&lt;li&gt;&lt;code&gt;exists key&lt;/code&gt;判断某个key是否存在&lt;/li&gt;
&lt;li&gt;&lt;code&gt;type key&lt;/code&gt; 查看你的key是什么类型&lt;/li&gt;
&lt;li&gt;&lt;code&gt;del key&lt;/code&gt; 删除指定的key数据&lt;/li&gt;
&lt;li&gt;&lt;code&gt;unlink key&lt;/code&gt; 根据value选择非阻塞删除 仅将keys从keyspace元数据中删除，真正的删除会在后续异步操作。&lt;/li&gt;
&lt;li&gt;&lt;code&gt;expire key 10 &lt;/code&gt; 10秒钟：为给定的key设置过期时间&lt;/li&gt;
&lt;li&gt;&lt;code&gt;ttl key&lt;/code&gt; 查看还有多少秒过期，-1表示永不过期，-2表示已过期&lt;/li&gt;
&lt;li&gt;&lt;code&gt;select&lt;/code&gt;命令切换数据库&lt;/li&gt;
&lt;li&gt;&lt;code&gt;dbsize&lt;/code&gt;查看当前数据库的key的数量&lt;/li&gt;
&lt;li&gt;&lt;code&gt;flushdb&lt;/code&gt;清空当前库&lt;/li&gt;
&lt;li&gt;&lt;code&gt;flushall&lt;/code&gt;通杀全部库&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id="字符串string"&gt;字符串(String)&lt;/h3&gt;
&lt;h4 id="简介"&gt;简介&lt;/h4&gt;
&lt;p&gt;String是Redis最基本的类型，你可以理解成与Memcached一模一样的类型，一个key对应一个value。&lt;/p&gt;
&lt;p&gt;String类型是二进制安全的。意味着Redis的string可以包含任何数据。比如jpg图片或者序列化的对象。&lt;/p&gt;</description><content:encoded><![CDATA[<h2 id="redis介绍">redis介绍</h2>
<p>Redis 是完全开源的，遵守 BSD 协议，是一个高性能的 key-value 数据库。</p>
<p>Redis 与其他 key - value 缓存产品有以下三个特点：</p>
<ul>
<li>Redis支持数据的持久化，可以将内存中的数据保存在磁盘中，重启的时候可以再次加载进行使用。</li>
<li>Redis不仅仅支持简单的key-value类型的数据，同时还提供list，set，zset，hash等数据结构的存储。</li>
<li>Redis支持数据的备份，即master-slave模式的数据备份。</li>
</ul>
<h3 id="redis的安装">redis的安装</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>brew install redis<span style="color:#f92672">(</span>mac<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>yum install redis<span style="color:#f92672">(</span>centos<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>apt-get install redis<span style="color:#f92672">(</span>ubuntu<span style="color:#f92672">)</span>
</span></span></code></pre></div><h2 id="redis的命令网站">redis的命令网站</h2>
<p><a href="http://doc.redisfans.com/">Redis 命令参考 — Redis 命令参考 (redisfans.com)</a></p>
<h2 id="redis的基本操作">redis的基本操作</h2>
<h3 id="redis的五大数据类型">redis的五大数据类型</h3>
<p>redis的五大数据类型是: <strong>String(字符串)、Hash(哈希)、List(列表)、Set(集合)、和zset(sorted set:有序集合)</strong></p>
<h3 id="redis键操作">redis键操作</h3>
<ul>
<li><code>keys *</code>查看当前库所有key   (匹配：keys *1)</li>
<li><code>exists key</code>判断某个key是否存在</li>
<li><code>type key</code> 查看你的key是什么类型</li>
<li><code>del key</code>    删除指定的key数据</li>
<li><code>unlink key</code>  根据value选择非阻塞删除   仅将keys从keyspace元数据中删除，真正的删除会在后续异步操作。</li>
<li><code>expire key 10 </code> 10秒钟：为给定的key设置过期时间</li>
<li><code>ttl key</code> 查看还有多少秒过期，-1表示永不过期，-2表示已过期</li>
<li><code>select</code>命令切换数据库</li>
<li><code>dbsize</code>查看当前数据库的key的数量</li>
<li><code>flushdb</code>清空当前库</li>
<li><code>flushall</code>通杀全部库</li>
</ul>
<h3 id="字符串string">字符串(String)</h3>
<h4 id="简介">简介</h4>
<p>String是Redis最基本的类型，你可以理解成与Memcached一模一样的类型，一个key对应一个value。</p>
<p>String类型是二进制安全的。意味着Redis的string可以包含任何数据。比如jpg图片或者序列化的对象。</p>
<p>String类型是Redis最基本的数据类型，一个Redis中字符串value最多可以是512M</p>
<h4 id="常用命令">常用命令</h4>
<ul>
<li><code>set  &lt;key&gt;&lt;value&gt;</code>添加键值对</li>
<li><code>get  &lt;key&gt;</code>查询对应键值</li>
<li><code>append  &lt;key&gt;&lt;value&gt;</code>将给定的<value> 追加到原值的末尾</li>
<li><code>strlen  &lt;key&gt;</code>获得值的长度</li>
<li><code>setnx  &lt;key&gt;&lt;value&gt;</code>只有在 key 不存在时   设置 key 的值</li>
<li><code>incr  &lt;key&gt;  </code>将 key 中储存的数字值增1 只能对数字值操作，如果为空，新增值为1</li>
<li><code>decr  &lt;key&gt;</code> 将 key 中储存的数字值减1  只能对数字值操作，如果为空，新增值为-1</li>
<li><code>incrby / decrby  &lt;key&gt;&lt;步长&gt;</code>将 key 中储存的数字值增减。自定义步长。</li>
</ul>
<h4 id="数据结构">数据结构</h4>
<p>String的数据结构为简单动态字符串(Simple Dynamic String,缩写SDS)。是可以修改的字符串，内部结构实现上类似于Java的ArrayList，采用预分配冗余空间的方式来减少内存的频繁分配.</p>
<p><img src="/images/f5606772-f15c-49ef-9c08-6b7f1e6495ea.png" alt=""></p>
<p>如图中所示，内部为当前字符串实际分配的空间capacity一般要高于实际字符串长度len。当字符串长度小于1M时，扩容都是加倍现有的空间，如果超过1M，扩容时一次只会多扩1M的空间。需要注意的是字符串最大长度为512M。</p>
<h3 id="列表list">列表(List)</h3>
<h4 id="简介-1">简介</h4>
<p>单键多值</p>
<p>Redis 列表是简单的字符串列表，按照插入顺序排序。你可以添加一个元素到列表的头部（左边）或者尾部（右边）。</p>
<p>它的底层实际是个双向链表，对两端的操作性能很高，通过索引下标的操作中间的节点性能会较差。</p>
<p><img src="/images/e7492d9c-c6d9-4de0-83b5-fd6482bc3c51.png" alt=""></p>
<h4 id="常用命令-1">常用命令</h4>
<ul>
<li><code>lpush/rpush  &lt;key&gt;&lt;value1&gt;&lt;value2&gt;&lt;value3&gt; ....</code> 从左边/右边插入一个或多个值。</li>
<li><code>lpop/rpop  &lt;key&gt;</code>从左边/右边吐出一个值。值在键在，值光键亡。</li>
<li><code>rpoplpush  &lt;key1&gt;&lt;key2&gt;</code>从<key1>列表右边吐出一个值，插到<key2>列表左边。</li>
<li><code>lrange &lt;key&gt;&lt;start&gt;&lt;stop&gt;</code>  按照索引下标获得元素(从左到右)</li>
<li><code>lrange mylist 0 -1</code>  0左边第一个，-1右边第一个，（0-1表示获取所有）</li>
<li><code>lindex &lt;key&gt;&lt;index&gt;</code>按照索引下标获得元素(从左到右)</li>
<li><code>llen &lt;key&gt;</code>获得列表长度</li>
<li><code>linsert &lt;key&gt;  before &lt;value&gt;&lt;newvalue&gt;</code>在<value>的后面插入<newvalue>插入值</li>
<li><code>lrem &lt;key&gt;&lt;n&gt;&lt;value&gt;</code>从左边删除n个value(从左到右)</li>
<li><code>lset&lt;key&gt;&lt;index&gt;&lt;value&gt;</code>将列表key下标为index的值替换成value</li>
</ul>
<h4 id="数据结构-1">数据结构</h4>
<p>List的数据结构为快速链表quickList。</p>
<p>首先在列表元素较少的情况下会使用一块连续的内存存储，这个结构是ziplist，也即是压缩列表。它将所有的元素紧挨着一起存储，分配的是一块连续的内存。当数据量比较多的时候才会改成quicklist。因为普通的链表需要的附加指针空间太大，会比较浪费空间。比如这个列表里存的只是int类型的数据，结构上还需要两个额外的指针prev和next。</p>
<p><img src="/images/810b0d87-7a3c-416a-87ac-66ad441e8a0a.png" alt=""></p>
<p>Redis将链表和ziplist结合起来组成了quicklist。也就是将多个ziplist使用双向指针串起来使用。这样既满足了快速的插入删除性能，又不会出现太大的空间冗余。</p>
<h3 id="集合set">集合(Set)</h3>
<h4 id="简介-2">简介</h4>
<p>Redis set对外提供的功能与list类似是一个列表的功能，特殊之处在于set是可以****自动排重****的，当你需要存储一个列表数据，又不希望出现重复数据时，set是一个很好的选择，并且set提供了判断某个成员是否在一个set集合内的重要接口，这个也是list所不能提供的。</p>
<p>Redis的Set是string类型的无序集合。它底层其实是一个value为null的hash表，所以添加，删除，查找的****复杂度都是O(1)****。</p>
<p>一个算法，随着数据的增加，执行时间的长短，如果是O(1)，数据增加，查找数据的时间不变</p>
<h4 id="常用命令-2">常用命令</h4>
<ul>
<li><code>sadd &lt;key&gt;&lt;value1&gt;&lt;value2&gt; ..... </code>将一个或多个 member 元素加入到集合 key 中，已经存在的 member 元素将被忽略</li>
<li><code>smembers &lt;key&gt;</code>取出该集合的所有值。</li>
<li><code>sismember &lt;key&gt;&lt;value&gt;</code>判断集合<key>是否为含有该<value>值，有1，没有0</li>
<li><code>scard&lt;key&gt;</code>返回该集合的元素个数。</li>
<li><code>srem &lt;key&gt;&lt;value1&gt;&lt;value2&gt; ....</code> 删除集合中的某个元素。</li>
<li><code>spop &lt;key&gt;</code><em><strong>*随机从该集合中吐出一个值。*</strong></em></li>
<li><code>srandmember &lt;key&gt;&lt;n&gt;</code>随机从该集合中取出n个值。不会从集合中删除 。</li>
<li><code>smove &lt;source&gt;&lt;destination&gt;</code>value把集合中一个值从一个集合移动到另一个集合</li>
<li><code>sinter &lt;key1&gt;&lt;key2&gt;</code>返回两个集合的交集元素。</li>
<li><code>sunion &lt;key1&gt;&lt;key2&gt;</code>返回两个集合的并集元素。</li>
<li><code>sdiff &lt;key1&gt;&lt;key2&gt;</code>返回两个集合的****差集****元素(key1中的，不包含key2中的)</li>
</ul>
<h4 id="数据结构-2">数据结构</h4>
<p>Set数据结构是dict字典，字典是用哈希表实现的。
Java中HashSet的内部实现使用的是HashMap，只不过所有的value都指向同一个对象。Redis的set结构也是一样，它的内部也使用hash结构，所有的value都指向同一个内部值。</p>
<h3 id="哈希hash">哈希(Hash)</h3>
<h4 id="简介-3">简介</h4>
<p>Redis hash 是一个键值对集合。</p>
<p>Redis hash是一个string类型的field和value的映射表，hash特别适合用于存储对象。</p>
<h4 id="常用命令-3">常用命令</h4>
<ul>
<li><code>hset &lt;key&gt;&lt;field&gt;&lt;value&gt;</code>给<key>集合中的  <field>键赋值<value></li>
<li><code>hget &lt;key1&gt;&lt;field&gt;</code>从<key1>集合<field>取出 value</li>
<li><code>hmset &lt;key1&gt;&lt;field1&gt;&lt;value1&gt;&lt;field2&gt;&lt;value2&gt;... </code>批量设置hash的值</li>
<li><code>hexists&lt;key1&gt;&lt;field&gt;</code>查看哈希表 key 中，给定域 field 是否存在。</li>
<li><code>hkeys &lt;key&gt;</code>列出该hash集合的所有field</li>
<li><code>hvals &lt;key&gt;</code>列出该hash集合的所有value</li>
<li><code>hincrby &lt;key&gt;&lt;field&gt;&lt;increment&gt;</code>为哈希表 key 中的域 field 的值加上增量 1  -1</li>
<li><code>hsetnx &lt;key&gt;&lt;field&gt;&lt;value&gt;</code>将哈希表 key 中的域 field 的值设置为 value ，当且仅当域 field 不存在 .</li>
</ul>
<h4 id="数据结构-3">数据结构</h4>
<p>Hash类型对应的数据结构是两种：ziplist（压缩列表），hashtable（哈希表）。当field-value长度较短且个数较少时，使用ziplist，否则使用hashtable。</p>
<h3 id="有序集合zsetsorted-set">有序集合Zset(sorted set)</h3>
<h4 id="简介-4">简介</h4>
<p>Redis有序集合zset与普通集合set非常相似，是一个没有重复元素的字符串集合。</p>
<p>不同之处是有序集合的每个成员都关联了一个****评分（score）****,这个评分（score）被用来按照从最低分到最高分的方式排序集合中的成员。集合的成员是唯一的，但是评分可以是重复了 。</p>
<p>因为元素是有序的, 所以你也可以很快的根据评分（score）或者次序（position）来获取一个范围的元素。</p>
<p>访问有序集合的中间元素也是非常快的,因此你能够使用有序集合作为一个没有重复成员的智能列表。</p>
<h4 id="常用命令-4">常用命令</h4>
<ul>
<li><code>zadd  &lt;key&gt;&lt;score1&gt;&lt;value1&gt;&lt;score2&gt;&lt;value2&gt;… </code>将一个或多个 member 元素及其 score 值加入到有序集 key 当中。</li>
<li><code>zrange &lt;key&gt;&lt;start&gt;&lt;stop&gt;  [WITHSCORES] </code>   返回有序集 key 中，下标在<start><stop>之间的元素带WITHSCORES，可以让分数一起和值返回到结果集。</li>
<li><code>zrangebyscore key minmax [withscores] [limit offset count]</code> 返回有序集 key 中，所有 score 值介于 min 和 max 之间(包括等于 min 或 max )的成员。有序集成员按 score 值递增(从小到大)次序排列。</li>
<li><code>zrevrangebyscore key maxmin [withscores] [limit offset count] </code>         同上，改为从大到小排列。</li>
<li><code>zincrby &lt;key&gt;&lt;increment&gt;&lt;value&gt;</code>    为元素的score加上增量</li>
<li><code>zrem  &lt;key&gt;&lt;value&gt;</code>删除该集合下，指定值的元素</li>
<li><code>zcount &lt;key&gt;&lt;min&gt;&lt;max&gt;</code>统计该集合，分数区间内的元素个数</li>
<li><code>zrank &lt;key&gt;&lt;value&gt;</code>返回该值在集合中的排名，从0开始。</li>
</ul>
<h4 id="数据结构-4">数据结构</h4>
<p>SortedSet(zset)是Redis提供的一个非常特别的数据结构，一方面它等价于Java的数据结构Map&lt;String, Double&gt;，可以给每一个元素value赋予一个权重score，另一方面它又类似于TreeSet，内部的元素会按照权重score进行排序，可以得到每个元素的名次，还可以通过score的范围来获取元素的列表。</p>
<p>zset底层使用了两个数据结构</p>
<ol>
<li>hash，hash的作用就是关联元素value和权重score，保障元素value的唯一性，可以通过元素value找到相应的score值。</li>
<li>跳跃表，跳跃表的目的在于给元素value排序，根据score的范围获取元素列表。</li>
</ol>
<h2 id="redis新数据类型">Redis新数据类型</h2>
<h3 id="bitmaps">Bitmaps</h3>
<h4 id="简介-5">简介</h4>
<p>现代计算机用二进制（位） 作为信息的基础单位， 1个字节等于8位， 例如“abc”字符串是由3个字节组成， 但实际在计算机存储时将其用二进制表示， “abc”分别对应的ASCII码分别是97、 98、 99， 对应的二进制分别是01100001、 01100010和01100011，如下图</p>
<p><img src="/images/4ba572ec-0cd0-471d-8321-46012e72f259.png" alt=""></p>
<p>合理地使用操作位能够有效地提高内存使用率和开发效率。</p>
<p>Redis提供了Bitmaps这个“数据类型”可以实现对位的操作：</p>
<ol>
<li>Bitmaps本身不是一种数据类型， 实际上它就是字符串（key-value） ， 但是它可以对字符串的位进行操作。</li>
<li>Bitmaps单独提供了一套命令， 所以在Redis中使用Bitmaps和使用字符串的方法不太相同。 可以把Bitmaps想象成一个以位为单位的数组， 数组的每个单元只能存储0和1， 数组的下标在Bitmaps中叫做偏移量。</li>
</ol>
<p><img src="/images/38fcab8e-c732-4d37-9712-712a307f36d1.png" alt=""></p>
<h4 id="命令">命令</h4>
<ol>
<li>setbit</li>
</ol>
<p>（1）格式</p>
<p><code>setbit&lt;key&gt;&lt;offset&gt;&lt;value&gt;</code>设置Bitmaps中某个偏移量的值（0或1）</p>
<p><img src="/images/82e8f396-ad55-40db-b4b5-6dc9201c6e33.png" alt=""></p>
<p>*offset:偏移量从0开始</p>
<p>（2）实例</p>
<p>每个独立用户是否访问过网站存放在Bitmaps中， 将访问的用户记做1， 没有访问的用户记做0， 用偏移量作为用户的id。</p>
<p>设置键的第offset个位的值（从0算起） ， 假设现在有20个用户，userid=1， 6， 11， 15， 19的用户对网站进行了访问， 那么当前Bitmaps初始化结果如图</p>
<p><img src="/images/b881197f-9c5a-44f1-a9ec-2f68364ca122.png" alt=""></p>
<p>unique:users:20201106代表2020-11-06这天的独立访问用户的Bitmaps</p>
<p><img src="/images/906ce509-1af2-45c6-9238-4ba96f69eef0.png" alt=""></p>
<p>注：</p>
<p>很多应用的用户id以一个指定数字（例如10000） 开头， 直接将用户id和Bitmaps的偏移量对应势必会造成一定的浪费， 通常的做法是每次做setbit操作时将用户id减去这个指定数字。</p>
<p>在第一次初始化Bitmaps时， 假如偏移量非常大， 那么整个初始化过程执行会比较慢， 可能会造成Redis的阻塞。</p>
<ol start="2">
<li>getbit</li>
</ol>
<p>（1）格式
getbit<key><offset>获取Bitmaps中某个偏移量的值</p>
<p>获取键的第offset位的值（从0开始算）</p>
<p>（2）实例
获取id=8的用户是否在2020-11-06这天访问过， 返回0说明没有访问过</p>
<p><img src="/images/7585a845-40ec-4482-8c9f-03e904de86f1.png" alt=""></p>
<p>注：因为100根本不存在，所以也是返回0</p>
<ol start="3">
<li>bitcount</li>
</ol>
<p>统计字符串被设置为1的bit数。一般情况下，给定的整个字符串都会被进行计数，通过指定额外的 start 或 end 参数，可以让计数只在特定的位上进行。start 和 end 参数的设置，都可以使用负数值：比如 -1 表示最后一个位，而 -2 表示倒数第二个位，start、end 是指bit组的字节的下标数，二者皆包含。
（1）格式
bitcount<key>[start end] 统计字符串从start字节到end字节比特值为1的数量</p>
<p>（2）实例
计算2022-11-06这天的独立访问用户数量</p>
<p>start和end代表起始和结束字节数， 下面操作计算用户id在第1个字节到第3个字节之间的独立访问用户数， 对应的用户id是11， 15， 19。</p>
<pre tabindex="0"><code>举例： K1 【01000001 01000000  00000000 00100001】，对应【0，1，2，3】
bitcount K1 1 2  ： 统计下标1、2字节组中bit=1的个数，即01000000  00000000
--》bitcount K1 1 2 　　--》1

bitcount K1 1 3  ： 统计下标1、2字节组中bit=1的个数，即01000000  00000000 00100001
--》bitcount K1 1 3　　--》3

bitcount K1 0 -2  ： 统计下标0到下标倒数第2，字节组中bit=1的个数，即01000001  01000000   00000000
--》bitcount K1 0 -2　　--》3
</code></pre><p>注意：redis的setbit设置或清除的是bit位置，而bitcount计算的是byte位置。</p>
<ol start="4">
<li>bitop</li>
</ol>
<p>(1)格式
bitop  and(or/not/xor) <destkey> [key…]</p>
<p><img src="/images/8a7cd908-8bf4-4a7e-8811-9c572487fea9.png" alt=""></p>
<p>bitop是一个复合操作， 它可以做多个Bitmaps的and（交集） 、 or（并集） 、 not（非） 、 xor（异或） 操作并将结果保存在destkey中。</p>
<p>(2)实例</p>
<p>2020-11-04 日访问网站的userid=1,2,5,9。</p>
<p>setbit unique:users:20201104 1 1</p>
<p>setbit unique:users:20201104 2 1</p>
<p>setbit unique:users:20201104 5 1</p>
<p>setbit unique:users:20201104 9 1</p>
<p>2020-11-03 日访问网站的userid=0,1,4,9。</p>
<p>setbit unique:users:20201103 0 1</p>
<p>setbit unique:users:20201103 1 1</p>
<p>setbit unique:users:20201103 4 1</p>
<p>setbit unique:users:20201103 9 1</p>
<p>计算出两天都访问过网站的用户数量</p>
<p>bitop and unique:users:and:20201104_03</p>
<p>unique:users:20201103unique:users:20201104</p>
<p><img src="/images/06377b31-60a0-455e-97c8-7febdf1a07ea.png" alt=""></p>
<p><img src="/images/7ee5ed4d-b2bd-43d4-b7a7-5c26c7562a28.png" alt=""></p>
<p>计算出任意一天都访问过网站的用户数量（例如月活跃就是类似这种） ， 可以使用or求并集</p>
<p><img src="/images/0a8dfb0f-51f5-4caa-a615-0304b5f4bbf9.png" alt=""></p>
<h4 id="bitmaps与set对比">Bitmaps与set对比</h4>
<p>假设网站有1亿用户， 每天独立访问的用户有5千万， 如果每天用集合类型和Bitmaps分别存储活跃用户可以得到表</p>
<table>
  <thead>
      <tr>
          <th>set和Bitmaps存储一天活跃用户对比</th>
          <th></th>
          <th></th>
          <th></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>数据类型</td>
          <td>每个用户id占用空间</td>
          <td>需要存储的用户量</td>
          <td>全部内存量</td>
      </tr>
      <tr>
          <td>集合类型</td>
          <td>64位</td>
          <td>50000000</td>
          <td>64位*50000000 = 400MB</td>
      </tr>
      <tr>
          <td>Bitmaps</td>
          <td>1位</td>
          <td>100000000</td>
          <td>1位*100000000 = 12.5MB</td>
      </tr>
  </tbody>
</table>
<p>很明显， 这种情况下使用Bitmaps能节省很多的内存空间， 尤其是随着时间推移节省的内存还是非常可观的</p>
<table>
  <thead>
      <tr>
          <th>set和Bitmaps存储独立用户空间对比</th>
          <th></th>
          <th></th>
          <th></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>数据类型</td>
          <td>一天</td>
          <td>一个月</td>
          <td>一年</td>
      </tr>
      <tr>
          <td>集合类型</td>
          <td>400MB</td>
          <td>12GB</td>
          <td>144GB</td>
      </tr>
      <tr>
          <td>Bitmaps</td>
          <td>12.5MB</td>
          <td>375MB</td>
          <td>4.5GB</td>
      </tr>
  </tbody>
</table>
<p>但Bitmaps并不是万金油， 假如该网站每天的独立访问用户很少， 例如只有10万（大量的僵尸用户） ， 那么两者的对比如下表所示， 很显然， 这时候使用Bitmaps就不太合适了， 因为基本上大部分位都是0。</p>
<table>
  <thead>
      <tr>
          <th>set和Bitmaps存储一天活跃用户对比（独立用户比较少）</th>
          <th></th>
          <th></th>
          <th></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>数据类型</td>
          <td>每个userid占用空间</td>
          <td>需要存储的用户量</td>
          <td>全部内存量</td>
      </tr>
      <tr>
          <td>集合类型</td>
          <td>64位</td>
          <td>100000</td>
          <td>64位*100000 = 800KB</td>
      </tr>
      <tr>
          <td>Bitmaps</td>
          <td>1位</td>
          <td>100000000</td>
          <td>1位*100000000 = 12.5MB</td>
      </tr>
  </tbody>
</table>
<h3 id="hyperloglog">HyperLogLog</h3>
<h4 id="简介-6">简介</h4>
<p>在工作当中，我们经常会遇到与统计相关的功能需求，比如统计网站PV（PageView页面访问量）,可以使用Redis的incr、incrby轻松实现。
但像UV（UniqueVisitor，独立访客）、独立IP数、搜索记录数等需要去重和计数的问题如何解决？这种求集合中不重复元素个数的问题称为基数问题。
解决基数问题有很多种方案：
（1）数据存储在MySQL表中，使用distinct count计算不重复个数</p>
<p>（2）使用Redis提供的hash、set、bitmaps等数据结构来处理</p>
<p>以上的方案结果精确，但随着数据不断增加，导致占用空间越来越大，对于非常大的数据集是不切实际的。</p>
<p>能否能够降低一定的精度来平衡存储空间？Redis推出了HyperLogLog</p>
<p>Redis HyperLogLog 是用来做基数统计的算法，HyperLogLog 的优点是，在输入元素的数量或者体积非常非常大时，计算基数所需的空间总是固定的、并且是很小的。</p>
<p>在 Redis 里面，每个 HyperLogLog 键只需要花费 12 KB 内存，就可以计算接近 2^64 个不同元素的基数。这和计算基数时，元素越多耗费内存就越多的集合形成鲜明对比。</p>
<p>但是，因为 HyperLogLog 只会根据输入元素来计算基数，而不会储存输入元素本身，所以 HyperLogLog 不能像集合那样，返回输入的各个元素。</p>
<p>什么是基数?</p>
<p>比如数据集 {1, 3, 5, 7, 5, 7, 8}， 那么这个数据集的基数集为 {1, 3, 5 ,7, 8}, 基数(不重复元素)为5。 基数估计就是在误差可接受的范围内，快速计算基数。</p>
<h4 id="命令-1">命令</h4>
<p>1、pfadd</p>
<p>（1）格式</p>
<p>pfadd <key>&lt; element&gt; [element &hellip;]  添加指定元素到 HyperLogLog 中</p>
<p><img src="/images/62e21699-dc0f-46bd-82cb-029f3222fbc7.png" alt=""></p>
<p>（2）实例</p>
<p><img src="/images/c2f7d56a-b3f5-4a35-9b22-d974527449b0.png" alt=""></p>
<p>​	将所有元素添加到指定HyperLogLog数据结构中。如果执行命令后HLL估计的近似基数发生变化，则返回1，否则返回0。</p>
<p>2、pfcount</p>
<p>（1）格式</p>
<p>pfcount<key> [key &hellip;] 计算HLL的近似基数，可以计算多个HLL，比如用HLL存储每天的UV，计算一周的UV可以使用7天的UV合并计算即可</p>
<p><img src="/images/f809026c-fc64-48fe-be04-706e6cc41f44.png" alt=""></p>
<p>（2）实例</p>
<p><img src="/images/f5b58b59-9932-4057-bd8f-60432b157770.png" alt=""></p>
<p>3、pfmerge</p>
<p>（1）格式</p>
<p>pfmerge<destkey><sourcekey> [sourcekey &hellip;]  将一个或多个HLL合并后的结果存储在另一个HLL中，比如每月活跃用户可以使用每天的活跃用户来合并计算可得</p>
<p><img src="/images/631183a5-9ff4-48b7-ac89-fbdd7789d129.png" alt=""></p>
<p>（2）实例</p>
<p><img src="/images/dfd3ee89-78e6-42ce-a229-dc9cefd1cec4.png" alt=""></p>
<h3 id="geospatial">Geospatial</h3>
<h4 id="简介-7">简介</h4>
<p>Redis 3.2 中增加了对GEO类型的支持。GEO，Geographic，地理信息的缩写。该类型，就是元素的2维坐标，在地图上就是经纬度。redis基于该类型，提供了经纬度设置，查询，范围查询，距离查询，经纬度Hash等常见操作。</p>
<h4 id="命令-2">命令</h4>
<p>1、geoadd</p>
<p>（1）格式</p>
<p>geoadd<key>&lt; longitude&gt;<latitude><member> [longitude latitude member&hellip;]  添加地理位置（经度，纬度，名称）</p>
<p><img src="/images/05ef798c-3889-4c03-91d4-90b1f15c9956.png" alt=""></p>
<p>2）实例</p>
<p>geoadd china:city 121.47 31.23 shanghai</p>
<p>geoadd china:city 106.50 29.53 chongqing 114.05 22.52 shenzhen 116.38 39.90 beijing</p>
<p><img src="/images/8ac8b0f3-9cfb-40e5-9cb9-8ef5b49ec1b6.png" alt=""></p>
<p>两极无法直接添加，一般会下载城市数据，直接通过 Java 程序一次性导入。</p>
<p>有效的经度从 -180 度到 180 度。有效的纬度从 -85.05112878 度到 85.05112878 度。</p>
<p>当坐标位置超出指定范围时，该命令将会返回一个错误。</p>
<p>已经添加的数据，是无法再次往里面添加的。</p>
<p>2、geopos</p>
<p>（1）格式</p>
<p>geopos  <key><member> [member&hellip;]  获得指定地区的坐标值</p>
<p><img src="/images/d0233779-9639-4787-8e99-3283ac7e855e.png" alt=""></p>
<p>（2）实例</p>
<p><img src="/images/71ab3c6c-66ca-4a71-b6d2-f16555a3e548.png" alt=""></p>
<p>3、geodist</p>
<p>（1）格式</p>
<p>geodist<key><member1><member2>  [m|km|ft|mi ]  获取两个位置之间的直线距离</p>
<p><img src="/images/ed4cb462-5939-4c09-9392-bd6c6b50dec6.png" alt=""></p>
<p>（2）实例</p>
<p>获取两个位置之间的直线距离</p>
<p><img src="/images/c5817ee3-a137-430a-9734-c3a51179382f.png" alt=""></p>
<p>单位：</p>
<p>m 表示单位为米[默认值]。</p>
<p>km 表示单位为千米。</p>
<p>mi 表示单位为英里。</p>
<p>ft 表示单位为英尺。</p>
<p>如果用户没有显式地指定单位参数， 那么 GEODIST 默认使用米作为单位</p>
<p>4、georadius</p>
<p>（1）格式</p>
<p>georadius<key>&lt; longitude&gt;<latitude>radius m|km|ft|mi  以给定的经纬度为中心，找出某一半径内的元素</p>
<p><img src="/images/63d0253a-d296-4b59-9b3a-0cda8db7167f.png" alt=""></p>
<p>经度 纬度 距离 单位</p>
<p>（2）实例</p>
<p><img src="/images/bd56b575-3eab-442e-aa42-fb8768d47bb1.png" alt=""></p>
]]></content:encoded><category>database</category><category>redis</category></item><item><title>golang redis</title><link>https://daemon365.dev/post/go/golang_redis/</link><pubDate>Sun, 12 Jan 2020 00:00:00 +0800</pubDate><guid>https://daemon365.dev/post/go/golang_redis/</guid><description>&lt;h2 id="安装"&gt;安装&lt;/h2&gt;
&lt;p&gt;下载第三方包:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;go get -u github.com/go-redis/redis/v9
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id="连接"&gt;连接&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;// 定义一个rdis客户端&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;var&lt;/span&gt; &lt;span style="color:#75af00"&gt;redisdb&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;redis&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Client&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;// 初始化&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;initClient&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;error&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;redisdb&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#75af00"&gt;redis&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;NewClient&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#f92672"&gt;&amp;amp;&lt;/span&gt;&lt;span style="color:#75af00"&gt;redis&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Options&lt;/span&gt;&lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;Addr&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;localhost:6379&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75715e"&gt;// post端口&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;Password&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 密码&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;DB&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;0&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 使用redis的库&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;})&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;_&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#75af00"&gt;redisdb&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Ping&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;context&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Background&lt;/span&gt;&lt;span style="color:#111"&gt;()).&lt;/span&gt;&lt;span style="color:#75af00"&gt;Result&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;!=&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;连接失败&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id="使用"&gt;使用&lt;/h2&gt;
&lt;h3 id="setget示例"&gt;set/get示例&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;redisExample&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;ctx&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;context&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Background&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;redisdb&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Set&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;ctx&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;score&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;100&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;0&lt;/span&gt;&lt;span style="color:#111"&gt;).&lt;/span&gt;&lt;span style="color:#75af00"&gt;Err&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;!=&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Printf&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;set score failed, err:%v\n&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;val&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;redisdb&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Get&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;ctx&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;score&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;).&lt;/span&gt;&lt;span style="color:#75af00"&gt;Result&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;!=&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Printf&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;get score failed, err:%v\n&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;score&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;val&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;val2&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;redisdb&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Get&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;ctx&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;name&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;).&lt;/span&gt;&lt;span style="color:#75af00"&gt;Result&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;==&lt;/span&gt; &lt;span style="color:#75af00"&gt;redis&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Nil&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;name does not exist&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;else&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;!=&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Printf&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;get name failed, err:%v\n&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;else&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;name&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;val2&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id="zset示例"&gt;zset示例&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;redisExample2&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;ctx&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;context&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Background&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;zsetKey&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;language_rank&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;languages&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#111"&gt;[]&lt;/span&gt;&lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;redis&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Z&lt;/span&gt;&lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f92672"&gt;&amp;amp;&lt;/span&gt;&lt;span style="color:#75af00"&gt;redis&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Z&lt;/span&gt;&lt;span style="color:#111"&gt;{&lt;/span&gt;&lt;span style="color:#75af00"&gt;Score&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;90.0&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;Member&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;Golang&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;},&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f92672"&gt;&amp;amp;&lt;/span&gt;&lt;span style="color:#75af00"&gt;redis&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Z&lt;/span&gt;&lt;span style="color:#111"&gt;{&lt;/span&gt;&lt;span style="color:#75af00"&gt;Score&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;98.0&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;Member&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;Java&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;},&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f92672"&gt;&amp;amp;&lt;/span&gt;&lt;span style="color:#75af00"&gt;redis&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Z&lt;/span&gt;&lt;span style="color:#111"&gt;{&lt;/span&gt;&lt;span style="color:#75af00"&gt;Score&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;95.0&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;Member&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;Python&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;},&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f92672"&gt;&amp;amp;&lt;/span&gt;&lt;span style="color:#75af00"&gt;redis&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Z&lt;/span&gt;&lt;span style="color:#111"&gt;{&lt;/span&gt;&lt;span style="color:#75af00"&gt;Score&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;97.0&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;Member&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;JavaScript&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;},&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f92672"&gt;&amp;amp;&lt;/span&gt;&lt;span style="color:#75af00"&gt;redis&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Z&lt;/span&gt;&lt;span style="color:#111"&gt;{&lt;/span&gt;&lt;span style="color:#75af00"&gt;Score&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;99.0&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;Member&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;C/C++&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;},&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// ZADD&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;num&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;redisdb&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;ZAdd&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;ctx&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;zsetKey&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;languages&lt;/span&gt;&lt;span style="color:#f92672"&gt;...&lt;/span&gt;&lt;span style="color:#111"&gt;).&lt;/span&gt;&lt;span style="color:#75af00"&gt;Result&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;!=&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Printf&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;zadd failed, err:%v\n&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Printf&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;zadd %d succ.\n&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;num&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// 把Golang的分数加10&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;newScore&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;redisdb&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;ZIncrBy&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;ctx&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;zsetKey&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;10.0&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;Golang&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;).&lt;/span&gt;&lt;span style="color:#75af00"&gt;Result&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;!=&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Printf&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;zincrby failed, err:%v\n&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Printf&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;Golang&amp;#39;s score is %f now.\n&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;newScore&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// 取分数最高的3个&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;ret&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;redisdb&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;ZRevRangeWithScores&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;ctx&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;zsetKey&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;0&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;2&lt;/span&gt;&lt;span style="color:#111"&gt;).&lt;/span&gt;&lt;span style="color:#75af00"&gt;Result&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;!=&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Printf&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;zrevrange failed, err:%v\n&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;for&lt;/span&gt; &lt;span style="color:#75af00"&gt;_&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;z&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;range&lt;/span&gt; &lt;span style="color:#75af00"&gt;ret&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;z&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Member&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;z&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Score&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// 取95~100分的&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;op&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#f92672"&gt;&amp;amp;&lt;/span&gt;&lt;span style="color:#75af00"&gt;redis&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;ZRangeBy&lt;/span&gt;&lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;Min&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;95&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;Max&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;100&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;ret&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#75af00"&gt;redisdb&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;ZRangeByScoreWithScores&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;ctx&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;zsetKey&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;op&lt;/span&gt;&lt;span style="color:#111"&gt;).&lt;/span&gt;&lt;span style="color:#75af00"&gt;Result&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;!=&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Printf&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;zrangebyscore failed, err:%v\n&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;for&lt;/span&gt; &lt;span style="color:#75af00"&gt;_&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;z&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;range&lt;/span&gt; &lt;span style="color:#75af00"&gt;ret&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;z&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Member&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;z&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Score&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;输出结果如下：&lt;/p&gt;</description><content:encoded><![CDATA[<h2 id="安装">安装</h2>
<p>下载第三方包:</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>go get -u github.com/go-redis/redis/v9
</span></span></code></pre></div><h2 id="连接">连接</h2>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// 定义一个rdis客户端</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">var</span> <span style="color:#75af00">redisdb</span> <span style="color:#f92672">*</span><span style="color:#75af00">redis</span><span style="color:#111">.</span><span style="color:#75af00">Client</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 初始化</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">initClient</span><span style="color:#111">()</span> <span style="color:#111">(</span><span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">redisdb</span> <span style="color:#111">=</span> <span style="color:#75af00">redis</span><span style="color:#111">.</span><span style="color:#75af00">NewClient</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">redis</span><span style="color:#111">.</span><span style="color:#75af00">Options</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">Addr</span><span style="color:#111">:</span>     <span style="color:#d88200">&#34;localhost:6379&#34;</span><span style="color:#111">,</span> <span style="color:#75715e">// post端口</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">Password</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;&#34;</span><span style="color:#111">,</span> <span style="color:#75715e">// 密码</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">DB</span><span style="color:#111">:</span>       <span style="color:#ae81ff">0</span><span style="color:#111">,</span>  <span style="color:#75715e">// 使用redis的库</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">redisdb</span><span style="color:#111">.</span><span style="color:#75af00">Ping</span><span style="color:#111">(</span><span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Background</span><span style="color:#111">()).</span><span style="color:#75af00">Result</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;连接失败&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="使用">使用</h2>
<h3 id="setget示例">set/get示例</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">redisExample</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ctx</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Background</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">redisdb</span><span style="color:#111">.</span><span style="color:#75af00">Set</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;score&#34;</span><span style="color:#111">,</span> <span style="color:#ae81ff">100</span><span style="color:#111">,</span> <span style="color:#ae81ff">0</span><span style="color:#111">).</span><span style="color:#75af00">Err</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;set score failed, err:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">val</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">redisdb</span><span style="color:#111">.</span><span style="color:#75af00">Get</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;score&#34;</span><span style="color:#111">).</span><span style="color:#75af00">Result</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;get score failed, err:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;score&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">val</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">val2</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">redisdb</span><span style="color:#111">.</span><span style="color:#75af00">Get</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;name&#34;</span><span style="color:#111">).</span><span style="color:#75af00">Result</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">==</span> <span style="color:#75af00">redis</span><span style="color:#111">.</span><span style="color:#75af00">Nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;name does not exist&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;get name failed, err:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;name&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">val2</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="zset示例">zset示例</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">redisExample2</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ctx</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Background</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">zsetKey</span> <span style="color:#f92672">:=</span> <span style="color:#d88200">&#34;language_rank&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">languages</span> <span style="color:#f92672">:=</span> <span style="color:#111">[]</span><span style="color:#f92672">*</span><span style="color:#75af00">redis</span><span style="color:#111">.</span><span style="color:#75af00">Z</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">&amp;</span><span style="color:#75af00">redis</span><span style="color:#111">.</span><span style="color:#75af00">Z</span><span style="color:#111">{</span><span style="color:#75af00">Score</span><span style="color:#111">:</span> <span style="color:#ae81ff">90.0</span><span style="color:#111">,</span> <span style="color:#75af00">Member</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;Golang&#34;</span><span style="color:#111">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">&amp;</span><span style="color:#75af00">redis</span><span style="color:#111">.</span><span style="color:#75af00">Z</span><span style="color:#111">{</span><span style="color:#75af00">Score</span><span style="color:#111">:</span> <span style="color:#ae81ff">98.0</span><span style="color:#111">,</span> <span style="color:#75af00">Member</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;Java&#34;</span><span style="color:#111">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">&amp;</span><span style="color:#75af00">redis</span><span style="color:#111">.</span><span style="color:#75af00">Z</span><span style="color:#111">{</span><span style="color:#75af00">Score</span><span style="color:#111">:</span> <span style="color:#ae81ff">95.0</span><span style="color:#111">,</span> <span style="color:#75af00">Member</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;Python&#34;</span><span style="color:#111">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">&amp;</span><span style="color:#75af00">redis</span><span style="color:#111">.</span><span style="color:#75af00">Z</span><span style="color:#111">{</span><span style="color:#75af00">Score</span><span style="color:#111">:</span> <span style="color:#ae81ff">97.0</span><span style="color:#111">,</span> <span style="color:#75af00">Member</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;JavaScript&#34;</span><span style="color:#111">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">&amp;</span><span style="color:#75af00">redis</span><span style="color:#111">.</span><span style="color:#75af00">Z</span><span style="color:#111">{</span><span style="color:#75af00">Score</span><span style="color:#111">:</span> <span style="color:#ae81ff">99.0</span><span style="color:#111">,</span> <span style="color:#75af00">Member</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;C/C++&#34;</span><span style="color:#111">},</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ZADD</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">num</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">redisdb</span><span style="color:#111">.</span><span style="color:#75af00">ZAdd</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">zsetKey</span><span style="color:#111">,</span> <span style="color:#75af00">languages</span><span style="color:#f92672">...</span><span style="color:#111">).</span><span style="color:#75af00">Result</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;zadd failed, err:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;zadd %d succ.\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">num</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 把Golang的分数加10</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">newScore</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">redisdb</span><span style="color:#111">.</span><span style="color:#75af00">ZIncrBy</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">zsetKey</span><span style="color:#111">,</span> <span style="color:#ae81ff">10.0</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Golang&#34;</span><span style="color:#111">).</span><span style="color:#75af00">Result</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;zincrby failed, err:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Golang&#39;s score is %f now.\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">newScore</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 取分数最高的3个</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ret</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">redisdb</span><span style="color:#111">.</span><span style="color:#75af00">ZRevRangeWithScores</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">zsetKey</span><span style="color:#111">,</span> <span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#ae81ff">2</span><span style="color:#111">).</span><span style="color:#75af00">Result</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;zrevrange failed, err:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">z</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">ret</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">z</span><span style="color:#111">.</span><span style="color:#75af00">Member</span><span style="color:#111">,</span> <span style="color:#75af00">z</span><span style="color:#111">.</span><span style="color:#75af00">Score</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 取95~100分的</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">op</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">redis</span><span style="color:#111">.</span><span style="color:#75af00">ZRangeBy</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">Min</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;95&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">Max</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;100&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ret</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">redisdb</span><span style="color:#111">.</span><span style="color:#75af00">ZRangeByScoreWithScores</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">zsetKey</span><span style="color:#111">,</span> <span style="color:#75af00">op</span><span style="color:#111">).</span><span style="color:#75af00">Result</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;zrangebyscore failed, err:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">z</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">ret</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">z</span><span style="color:#111">.</span><span style="color:#75af00">Member</span><span style="color:#111">,</span> <span style="color:#75af00">z</span><span style="color:#111">.</span><span style="color:#75af00">Score</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>输出结果如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ ./06redis_demo 
</span></span><span style="display:flex;"><span>zadd <span style="color:#ae81ff">0</span> succ.
</span></span><span style="display:flex;"><span>Golang<span style="color:#960050;background-color:#1e0010">&#39;</span>s score is 100.000000 now.
</span></span><span style="display:flex;"><span>Golang <span style="color:#ae81ff">100</span>
</span></span><span style="display:flex;"><span>C/C++ <span style="color:#ae81ff">99</span>
</span></span><span style="display:flex;"><span>Java <span style="color:#ae81ff">98</span>
</span></span><span style="display:flex;"><span>JavaScript <span style="color:#ae81ff">97</span>
</span></span><span style="display:flex;"><span>Java <span style="color:#ae81ff">98</span>
</span></span><span style="display:flex;"><span>C/C++ <span style="color:#ae81ff">99</span>
</span></span><span style="display:flex;"><span>Golang <span style="color:#ae81ff">100</span>
</span></span></code></pre></div>]]></content:encoded><category>go</category><category>golang</category><category>redis</category></item></channel></rss>