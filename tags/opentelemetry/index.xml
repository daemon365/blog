<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/"><channel><title>Opentelemetry on Daemon365</title><link>https://daemon365.dev/tags/opentelemetry/</link><description>Don't let yourself stop.</description><generator>Hugo -- gohugo.io</generator><language>zh-cn</language><lastBuildDate>Mon, 23 Aug 2021 18:11:50 +0800</lastBuildDate><atom:link href="https://daemon365.dev/tags/opentelemetry/index.xml" rel="self" type="application/rss+xml"/><item><title>基于 OpenTelemetry 的链路追踪</title><link>https://daemon365.dev/post/kratos/link_tracing_based_on_opentelemetry/</link><pubDate>Mon, 23 Aug 2021 18:11:50 +0800</pubDate><guid>https://daemon365.dev/post/kratos/link_tracing_based_on_opentelemetry/</guid><description>&lt;h2 id="链路追踪的前世今生"&gt;链路追踪的前世今生&lt;/h2&gt;
&lt;blockquote&gt;
&lt;p&gt;分布式跟踪（也称为分布式请求跟踪）是一种用于分析和监控应用程序的方法，尤其是使用微服务架构构建的应用程序。分布式跟踪有助于精确定位故障发生的位置以及导致性能差的原因。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id="起源"&gt;起源&lt;/h3&gt;
&lt;p&gt;链路追踪(Distributed Tracing)　一词最早出现于谷歌发布的论文 &lt;strong&gt;《Dapper, a Large-Scale Distributed Systems Tracing Infrastructure》&lt;/strong&gt; 中,这篇论文对于实现链路追踪,对于后来出现的 Jaeger、Zipkin 等开源分布式追踪项目设计理念仍有很深的影响。&lt;/p&gt;
&lt;p&gt;微服务架构是一个分布式的架构,会有很多个不同的服务。不同的服务之前相互调用,如果出现了错误由于一个请求经过了 N 个服务。随着业务的增加越来越多的服务之间的调用，如果没有一个工具去记录调用链，解决问题的时候就会像下面图片里小猫咪玩的毛线球一样，毫无头绪，无从下手&lt;/p&gt;
&lt;p&gt;&lt;img src="https://daemon365.dev/images/26c28252-3065-4999-8d40-41a67e678b53.png" alt=""&gt;&lt;/p&gt;
&lt;p&gt;所以需要有一个工具能够清楚的了解一个请求经过了哪些服务,顺序是如何,从而能够轻易的定位问题。&lt;/p&gt;
&lt;p&gt;&lt;img src="https://daemon365.dev/images/a4b9b782-7d21-4857-a59f-7b2b5b27b5a6.png" alt=""&gt;&lt;/p&gt;
&lt;h3 id="百家争艳"&gt;百家争艳&lt;/h3&gt;
&lt;p&gt;从谷歌发布 &lt;strong&gt;Dapper&lt;/strong&gt; 后，分布式链路追踪工具越来越多，以下简单列举了一些常用的链路追踪系统&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Skywalking&lt;/li&gt;
&lt;li&gt;阿里 鹰眼&lt;/li&gt;
&lt;li&gt;大众点评 CAT&lt;/li&gt;
&lt;li&gt;Twitter Zipkin&lt;/li&gt;
&lt;li&gt;Naver pinpoint&lt;/li&gt;
&lt;li&gt;Uber Jaeger&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id="争锋相对"&gt;争锋相对？&lt;/h3&gt;
&lt;p&gt;随着链路追踪工具越来越多，开源领域主要分为两派，一派是以 &lt;strong&gt;CNCF技术委员&lt;/strong&gt; 会为主的 &lt;strong&gt;OpenTracing&lt;/strong&gt; 的规范，例如 jaeger zipkin 都是遵循了&lt;strong&gt;OpenTracing&lt;/strong&gt; 的规范。而另一派则是谷歌作为发起者的 &lt;strong&gt;OpenCensus&lt;/strong&gt;，而且谷歌本身还是最早提出链路追踪概念的公司，后期连微软也加入了 &lt;strong&gt;OpenCensus&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src="https://daemon365.dev/images/9d8532dc-9595-4754-80b3-11d9963c2fca.png" alt=""&gt;&lt;/p&gt;
&lt;h3 id="opentelemetry-诞生"&gt;OpenTelemetry 诞生&lt;/h3&gt;
&lt;blockquote&gt;
&lt;p&gt;OpenTelemetric 是一组 API、SDK、模组和集成，专为创建和管理‎‎遥测数据‎‎（如追踪、指标和日志）而设&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;微软加入 &lt;strong&gt;OpenCensus&lt;/strong&gt; 后，直接打破了之前平衡的局面，间接的导致了 &lt;strong&gt;OpenTelemetry&lt;/strong&gt; 的诞生
谷歌和微软下定决心结束江湖之乱，首要的问题是如何整合两个两个社区已有的项目，OpenTelemetry 主要的理念就是，兼容 &lt;strong&gt;OpenCensus&lt;/strong&gt; 和 &lt;strong&gt;OpenTracing&lt;/strong&gt; ，可以让使用者无需改动或者很小的改动就可以接入 &lt;strong&gt;OpenTelemetry&lt;/strong&gt;&lt;/p&gt;
&lt;h2 id="kratos-的链路追踪实践"&gt;Kratos 的链路追踪实践&lt;/h2&gt;
&lt;blockquote&gt;
&lt;p&gt;Kratos 一套轻量级 Go 微服务框架，包含大量微服务相关框架及工具。&lt;/p&gt;</description><content:encoded><![CDATA[<h2 id="链路追踪的前世今生">链路追踪的前世今生</h2>
<blockquote>
<p>分布式跟踪（也称为分布式请求跟踪）是一种用于分析和监控应用程序的方法，尤其是使用微服务架构构建的应用程序。分布式跟踪有助于精确定位故障发生的位置以及导致性能差的原因。</p>
</blockquote>
<h3 id="起源">起源</h3>
<p>链路追踪(Distributed Tracing)　一词最早出现于谷歌发布的论文 <strong>《Dapper, a Large-Scale Distributed Systems Tracing Infrastructure》</strong> 中,这篇论文对于实现链路追踪,对于后来出现的 Jaeger、Zipkin 等开源分布式追踪项目设计理念仍有很深的影响。</p>
<p>微服务架构是一个分布式的架构,会有很多个不同的服务。不同的服务之前相互调用,如果出现了错误由于一个请求经过了 N 个服务。随着业务的增加越来越多的服务之间的调用，如果没有一个工具去记录调用链，解决问题的时候就会像下面图片里小猫咪玩的毛线球一样，毫无头绪，无从下手</p>
<p><img src="/images/26c28252-3065-4999-8d40-41a67e678b53.png" alt=""></p>
<p>所以需要有一个工具能够清楚的了解一个请求经过了哪些服务,顺序是如何,从而能够轻易的定位问题。</p>
<p><img src="/images/a4b9b782-7d21-4857-a59f-7b2b5b27b5a6.png" alt=""></p>
<h3 id="百家争艳">百家争艳</h3>
<p>从谷歌发布 <strong>Dapper</strong> 后，分布式链路追踪工具越来越多，以下简单列举了一些常用的链路追踪系统</p>
<ul>
<li>Skywalking</li>
<li>阿里 鹰眼</li>
<li>大众点评 CAT</li>
<li>Twitter Zipkin</li>
<li>Naver pinpoint</li>
<li>Uber Jaeger</li>
</ul>
<h3 id="争锋相对">争锋相对？</h3>
<p>随着链路追踪工具越来越多，开源领域主要分为两派，一派是以 <strong>CNCF技术委员</strong> 会为主的  <strong>OpenTracing</strong> 的规范，例如 jaeger zipkin 都是遵循了<strong>OpenTracing</strong> 的规范。而另一派则是谷歌作为发起者的 <strong>OpenCensus</strong>，而且谷歌本身还是最早提出链路追踪概念的公司，后期连微软也加入了 <strong>OpenCensus</strong></p>
<p><img src="/images/9d8532dc-9595-4754-80b3-11d9963c2fca.png" alt=""></p>
<h3 id="opentelemetry-诞生">OpenTelemetry 诞生</h3>
<blockquote>
<p>OpenTelemetric 是一组 API、SDK、模组和集成，专为创建和管理‎‎遥测数据‎‎（如追踪、指标和日志）而设</p>
</blockquote>
<p>微软加入 <strong>OpenCensus</strong> 后，直接打破了之前平衡的局面，间接的导致了 <strong>OpenTelemetry</strong> 的诞生
谷歌和微软下定决心结束江湖之乱，首要的问题是如何整合两个两个社区已有的项目，OpenTelemetry 主要的理念就是，兼容 <strong>OpenCensus</strong> 和 <strong>OpenTracing</strong> ，可以让使用者无需改动或者很小的改动就可以接入 <strong>OpenTelemetry</strong></p>
<h2 id="kratos-的链路追踪实践">Kratos 的链路追踪实践</h2>
<blockquote>
<p>Kratos 一套轻量级 Go 微服务框架，包含大量微服务相关框架及工具。</p>
</blockquote>
<h3 id="tracing-中间件">tracing 中间件</h3>
<p>kratos 框架提供的自带中间件中有一个名为 <strong>tracing</strong> 中间件，它基于 <strong>Opentelemetry</strong> 实现了kratos 框架的链路追踪功能，中间件的代码可以从 <strong><a href="https://github.com/go-kratos/kratos/tree/main/middleware/tracing">middleware/tracing</a></strong> 中看到。</p>
<h4 id="实现原理">实现原理</h4>
<p>kratos 的链路追踪中间件由三个文件组成 <strong>carrie.go</strong>,<strong>tracer.go</strong>,<strong>tracing.go</strong>。client和 server 的实现原理基本相同，本文以 server 实现进行原理解析。</p>
<ol>
<li>首先当请求进入时，<strong>tracing</strong> 中间件会被调用,首先调用了 <strong>tracer.go</strong> 中的 <strong>NewTracer</strong> 方法</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// Server returns a new server middleware for OpenTelemetry.</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">Server</span><span style="color:#111">(</span><span style="color:#75af00">opts</span> <span style="color:#f92672">...</span><span style="color:#75af00">Option</span><span style="color:#111">)</span> <span style="color:#75af00">middleware</span><span style="color:#111">.</span><span style="color:#75af00">Middleware</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 调用 tracer.go 中的 NewTracer 传入了一个 SpanKindServer 和配置项</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">tracer</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">NewTracer</span><span style="color:#111">(</span><span style="color:#75af00">trace</span><span style="color:#111">.</span><span style="color:#75af00">SpanKindServer</span><span style="color:#111">,</span> <span style="color:#75af00">opts</span><span style="color:#f92672">...</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// ... 省略代码</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><ol start="2">
<li><strong>tracer.go</strong> 中的 <strong>NewTracer</strong> 方法被调用后会返回一个 <strong>Tracer</strong>,实现如下</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">NewTracer</span><span style="color:#111">(</span><span style="color:#75af00">kind</span> <span style="color:#75af00">trace</span><span style="color:#111">.</span><span style="color:#75af00">SpanKind</span><span style="color:#111">,</span> <span style="color:#75af00">opts</span> <span style="color:#f92672">...</span><span style="color:#75af00">Option</span><span style="color:#111">)</span> <span style="color:#f92672">*</span><span style="color:#75af00">Tracer</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">options</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">options</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">o</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">opts</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">o</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">options</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 判断是否存在 otel 追踪提供者配置，如果存在则设置</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">options</span><span style="color:#111">.</span><span style="color:#75af00">TracerProvider</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">otel</span><span style="color:#111">.</span><span style="color:#75af00">SetTracerProvider</span><span style="color:#111">(</span><span style="color:#75af00">options</span><span style="color:#111">.</span><span style="color:#75af00">TracerProvider</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	判断是否存在 Propagators 设置，如果存在设置则覆盖，不存在则设置一个默认的TextMapPropagator
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	注意如果没有设置默认的TextMapPropagator,链路信息则无法正确的传递
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	*/</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">options</span><span style="color:#111">.</span><span style="color:#75af00">Propagators</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">otel</span><span style="color:#111">.</span><span style="color:#75af00">SetTextMapPropagator</span><span style="color:#111">(</span><span style="color:#75af00">options</span><span style="color:#111">.</span><span style="color:#75af00">Propagators</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>	<span style="color:#75af00">otel</span><span style="color:#111">.</span><span style="color:#75af00">SetTextMapPropagator</span><span style="color:#111">(</span><span style="color:#75af00">propagation</span><span style="color:#111">.</span><span style="color:#75af00">NewCompositeTextMapPropagator</span><span style="color:#111">(</span><span style="color:#75af00">propagation</span><span style="color:#111">.</span><span style="color:#75af00">Baggage</span><span style="color:#111">{},</span> <span style="color:#75af00">propagation</span><span style="color:#111">.</span><span style="color:#75af00">TraceContext</span><span style="color:#111">{}))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">var</span> <span style="color:#75af00">name</span> <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 判断当前中间件的类型，是 server 还是 client</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">kind</span> <span style="color:#f92672">==</span> <span style="color:#75af00">trace</span><span style="color:#111">.</span><span style="color:#75af00">SpanKindServer</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">name</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;server&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#00a8c8">if</span> <span style="color:#75af00">kind</span> <span style="color:#f92672">==</span> <span style="color:#75af00">trace</span><span style="color:#111">.</span><span style="color:#75af00">SpanKindClient</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">name</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;client&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Sprintf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;unsupported span kind: %v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">kind</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 调用 otel包的 Tracer 方法 传入 name 用来创建一个 tracer 实例</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">tracer</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">otel</span><span style="color:#111">.</span><span style="color:#75af00">Tracer</span><span style="color:#111">(</span><span style="color:#75af00">name</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">Tracer</span><span style="color:#111">{</span><span style="color:#75af00">tracer</span><span style="color:#111">:</span> <span style="color:#75af00">tracer</span><span style="color:#111">,</span> <span style="color:#75af00">kind</span><span style="color:#111">:</span> <span style="color:#75af00">kind</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><ol start="3">
<li>判断当前请求类型，处理需要采集的数据，并调用 <strong>tracer.go</strong> 中的 <strong>Start</strong> 方法</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">var</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">component</span> <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">operation</span> <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">carrier</span>   <span style="color:#75af00">propagation</span><span style="color:#111">.</span><span style="color:#75af00">TextMapCarrier</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 判断请求类型</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#75af00">info</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">FromServerContext</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">);</span> <span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// HTTP</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">component</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;HTTP&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 取出请求的地址</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">operation</span> <span style="color:#111">=</span> <span style="color:#75af00">info</span><span style="color:#111">.</span><span style="color:#75af00">Request</span><span style="color:#111">.</span><span style="color:#75af00">RequestURI</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 调用 otel/propagation包中的 HeaderCarrier，会处理 http.Header 以用来满足TextMapCarrier interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// TextMapCarrier 是一个文本映射载体，用于承载信息</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">carrier</span> <span style="color:#111">=</span> <span style="color:#75af00">propagation</span><span style="color:#111">.</span><span style="color:#75af00">HeaderCarrier</span><span style="color:#111">(</span><span style="color:#75af00">info</span><span style="color:#111">.</span><span style="color:#75af00">Request</span><span style="color:#111">.</span><span style="color:#75af00">Header</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// otel.GetTextMapPropagator().Extract() 方法用于将文本映射载体，读取到上下文中</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ctx</span> <span style="color:#111">=</span> <span style="color:#75af00">otel</span><span style="color:#111">.</span><span style="color:#75af00">GetTextMapPropagator</span><span style="color:#111">().</span><span style="color:#75af00">Extract</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">propagation</span><span style="color:#111">.</span><span style="color:#75af00">HeaderCarrier</span><span style="color:#111">(</span><span style="color:#75af00">info</span><span style="color:#111">.</span><span style="color:#75af00">Request</span><span style="color:#111">.</span><span style="color:#75af00">Header</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#00a8c8">if</span> <span style="color:#75af00">info</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">grpc</span><span style="color:#111">.</span><span style="color:#75af00">FromServerContext</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">);</span> <span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Grpc</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">component</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;gRPC&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">operation</span> <span style="color:#111">=</span> <span style="color:#75af00">info</span><span style="color:#111">.</span><span style="color:#75af00">FullMethod</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	// 调用 grpc/metadata包中metadata.FromIncomingContext(ctx)传入 ctx，转换 grpc 的元数据</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">md</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">metadata</span><span style="color:#111">.</span><span style="color:#75af00">FromIncomingContext</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">);</span> <span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 调用carrier.go 中的 MetadataCarrier 将 MD 转换 成文本映射载体</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">carrier</span> <span style="color:#111">=</span> <span style="color:#75af00">MetadataCarrier</span><span style="color:#111">(</span><span style="color:#75af00">md</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 调用 tracer.Start 方法</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">span</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">tracer</span><span style="color:#111">.</span><span style="color:#75af00">Start</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">component</span><span style="color:#111">,</span> <span style="color:#75af00">operation</span><span style="color:#111">,</span> <span style="color:#75af00">carrier</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// ... 省略代码</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><ol start="4">
<li>调用 <strong>tracing.go</strong> 中的 <strong>Start</strong> 方法</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">t</span> <span style="color:#f92672">*</span><span style="color:#75af00">Tracer</span><span style="color:#111">)</span> <span style="color:#75af00">Start</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">,</span> <span style="color:#75af00">component</span> <span style="color:#00a8c8">string</span><span style="color:#111">,</span> <span style="color:#75af00">operation</span> <span style="color:#00a8c8">string</span><span style="color:#111">,</span> <span style="color:#75af00">carrier</span> <span style="color:#75af00">propagation</span><span style="color:#111">.</span><span style="color:#75af00">TextMapCarrier</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">,</span> <span style="color:#75af00">trace</span><span style="color:#111">.</span><span style="color:#75af00">Span</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 判断当前中间件如果是 server则将 carrier 注入到上下文中</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">kind</span> <span style="color:#f92672">==</span> <span style="color:#75af00">trace</span><span style="color:#111">.</span><span style="color:#75af00">SpanKindServer</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">ctx</span> <span style="color:#111">=</span> <span style="color:#75af00">otel</span><span style="color:#111">.</span><span style="color:#75af00">GetTextMapPropagator</span><span style="color:#111">().</span><span style="color:#75af00">Extract</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">carrier</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 调用otel/tracer 包中的 start 方法，用来创建一个 span</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">span</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">tracer</span><span style="color:#111">.</span><span style="color:#75af00">Start</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// tracing.go 中声明的请求路由作为 spanName</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">operation</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 设置 span 的属性，设置了一个 component，component的值为请求类型</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">trace</span><span style="color:#111">.</span><span style="color:#75af00">WithAttributes</span><span style="color:#111">(</span><span style="color:#75af00">attribute</span><span style="color:#111">.</span><span style="color:#75af00">String</span><span style="color:#111">(</span><span style="color:#d88200">&#34;component&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">component</span><span style="color:#111">)),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 设置 span种类</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">trace</span><span style="color:#111">.</span><span style="color:#75af00">WithSpanKind</span><span style="color:#111">(</span><span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">kind</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 判断如果当前中间件是 client 则将 carrier 注入到请求里面</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">kind</span> <span style="color:#f92672">==</span> <span style="color:#75af00">trace</span><span style="color:#111">.</span><span style="color:#75af00">SpanKindClient</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">otel</span><span style="color:#111">.</span><span style="color:#75af00">GetTextMapPropagator</span><span style="color:#111">().</span><span style="color:#75af00">Inject</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">carrier</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">span</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><ol start="5">
<li><strong>defer</strong> 声明了一个闭包方法</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-golang" data-lang="golang"><span style="display:flex;"><span><span style="color:#75715e">// 这个地方要注意，需要使用闭包，因为 defer 的参数是实时计算的如果异常发生，err 会一直为 nil</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// https://github.com/go-kratos/kratos/issues/927</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">defer</span> <span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#111">{</span> <span style="color:#75af00">tracer</span><span style="color:#111">.</span><span style="color:#75af00">End</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">span</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span> <span style="color:#111">}()</span>
</span></span></code></pre></div><ol start="6">
<li>中间件继续执行</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// tracing.go 69行</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">reply</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">handler</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">req</span><span style="color:#111">)</span>
</span></span></code></pre></div><ol start="7">
<li>中间件调用结束 <strong>defer</strong> 中的闭包被调用后执行了 <strong>tracer.go</strong> 中的 <strong>End</strong> 方法</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">t</span> <span style="color:#f92672">*</span><span style="color:#75af00">Tracer</span><span style="color:#111">)</span> <span style="color:#75af00">End</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">,</span> <span style="color:#75af00">span</span> <span style="color:#75af00">trace</span><span style="color:#111">.</span><span style="color:#75af00">Span</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 判断是否有异常发生，如果有则设置一些异常信息</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 记录异常</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">span</span><span style="color:#111">.</span><span style="color:#75af00">RecordError</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 设置span 属性</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">span</span><span style="color:#111">.</span><span style="color:#75af00">SetAttributes</span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 设置事件为异常</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">attribute</span><span style="color:#111">.</span><span style="color:#75af00">String</span><span style="color:#111">(</span><span style="color:#d88200">&#34;event&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;error&#34;</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 设置 message 为 err.Error().</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">attribute</span><span style="color:#111">.</span><span style="color:#75af00">String</span><span style="color:#111">(</span><span style="color:#d88200">&#34;message&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">.</span><span style="color:#75af00">Error</span><span style="color:#111">()),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">//设置了 span 的状态</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">span</span><span style="color:#111">.</span><span style="color:#75af00">SetStatus</span><span style="color:#111">(</span><span style="color:#75af00">codes</span><span style="color:#111">.</span><span style="color:#75af00">Error</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">.</span><span style="color:#75af00">Error</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 如果没有发生异常，span 状态则为 ok</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">span</span><span style="color:#111">.</span><span style="color:#75af00">SetStatus</span><span style="color:#111">(</span><span style="color:#75af00">codes</span><span style="color:#111">.</span><span style="color:#75af00">Ok</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;OK&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 中止 span</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">span</span><span style="color:#111">.</span><span style="color:#75af00">End</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h4 id="如何使用">如何使用</h4>
<p>tracing 中间件的使用示例可以从  <a href="https://github.com/go-kratos/kratos/tree/main/examples/traces">kratos/examples/traces</a> ,该示例简单的实现了跨服务间的链路追踪,以下代码片段包含部分示例代码。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// https://github.com/go-kratos/kratos/blob/7f835db398c9d0332e69b81bad4c652b4b45ae2e/examples/traces/app/message/main.go#L38</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 首先调用otel 库方法，得到一个 TracerProvider</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">tracerProvider</span><span style="color:#111">(</span><span style="color:#75af00">url</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">tracesdk</span><span style="color:#111">.</span><span style="color:#75af00">TracerProvider</span><span style="color:#111">,</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// examples/traces 中使用的是 jaeger，其他方式可以查看 opentelemetry 官方示例</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">exp</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">jaeger</span><span style="color:#111">.</span><span style="color:#75af00">NewRawExporter</span><span style="color:#111">(</span><span style="color:#75af00">jaeger</span><span style="color:#111">.</span><span style="color:#75af00">WithCollectorEndpoint</span><span style="color:#111">(</span><span style="color:#75af00">jaeger</span><span style="color:#111">.</span><span style="color:#75af00">WithEndpoint</span><span style="color:#111">(</span><span style="color:#75af00">url</span><span style="color:#111">)))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">tp</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">tracesdk</span><span style="color:#111">.</span><span style="color:#75af00">NewTracerProvider</span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">tracesdk</span><span style="color:#111">.</span><span style="color:#75af00">WithSampler</span><span style="color:#111">(</span><span style="color:#75af00">tracesdk</span><span style="color:#111">.</span><span style="color:#75af00">AlwaysSample</span><span style="color:#111">()),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 设置 Batcher，注册jaeger导出程序</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">tracesdk</span><span style="color:#111">.</span><span style="color:#75af00">WithBatcher</span><span style="color:#111">(</span><span style="color:#75af00">exp</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 记录一些默认信息</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">tracesdk</span><span style="color:#111">.</span><span style="color:#75af00">WithResource</span><span style="color:#111">(</span><span style="color:#75af00">resource</span><span style="color:#111">.</span><span style="color:#75af00">NewWithAttributes</span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">semconv</span><span style="color:#111">.</span><span style="color:#75af00">ServiceNameKey</span><span style="color:#111">.</span><span style="color:#75af00">String</span><span style="color:#111">(</span><span style="color:#75af00">pb</span><span style="color:#111">.</span><span style="color:#75af00">User_ServiceDesc</span><span style="color:#111">.</span><span style="color:#75af00">ServiceName</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">attribute</span><span style="color:#111">.</span><span style="color:#75af00">String</span><span style="color:#111">(</span><span style="color:#d88200">&#34;environment&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;development&#34;</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">attribute</span><span style="color:#111">.</span><span style="color:#75af00">Int64</span><span style="color:#111">(</span><span style="color:#d88200">&#34;ID&#34;</span><span style="color:#111">,</span> <span style="color:#ae81ff">1</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">)),</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">tp</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h4 id="在-grpcserver-中使用">在 grpc/server 中使用</h4>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// https://github.com/go-kratos/kratos/blob/main/examples/traces/app/message/main.go</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">grpcSrv</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">grpc</span><span style="color:#111">.</span><span style="color:#75af00">NewServer</span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">grpc</span><span style="color:#111">.</span><span style="color:#75af00">Address</span><span style="color:#111">(</span><span style="color:#d88200">&#34;:9000&#34;</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">grpc</span><span style="color:#111">.</span><span style="color:#75af00">Middleware</span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Configuring tracing Middleware</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">tracing</span><span style="color:#111">.</span><span style="color:#75af00">Server</span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">tracing</span><span style="color:#111">.</span><span style="color:#75af00">WithTracerProvider</span><span style="color:#111">(</span><span style="color:#75af00">tp</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">),</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span></code></pre></div><h4 id="在-grpcclient-中使用">在 grpc/client 中使用</h4>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// https://github.com/go-kratos/kratos/blob/149fc0195eb62ee1fbc2728adb92e1bcd1a12c4e/examples/traces/app/user/main.go#L63</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">conn</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">grpc</span><span style="color:#111">.</span><span style="color:#75af00">DialInsecure</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">grpc</span><span style="color:#111">.</span><span style="color:#75af00">WithEndpoint</span><span style="color:#111">(</span><span style="color:#d88200">&#34;127.0.0.1:9000&#34;</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">grpc</span><span style="color:#111">.</span><span style="color:#75af00">WithMiddleware</span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">tracing</span><span style="color:#111">.</span><span style="color:#75af00">Client</span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">tracing</span><span style="color:#111">.</span><span style="color:#75af00">WithTracerProvider</span><span style="color:#111">(</span><span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">tracer</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">tracing</span><span style="color:#111">.</span><span style="color:#75af00">WithPropagators</span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">propagation</span><span style="color:#111">.</span><span style="color:#75af00">NewCompositeTextMapPropagator</span><span style="color:#111">(</span><span style="color:#75af00">propagation</span><span style="color:#111">.</span><span style="color:#75af00">Baggage</span><span style="color:#111">{},</span> <span style="color:#75af00">propagation</span><span style="color:#111">.</span><span style="color:#75af00">TraceContext</span><span style="color:#111">{}),</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">grpc</span><span style="color:#111">.</span><span style="color:#75af00">WithTimeout</span><span style="color:#111">(</span><span style="color:#ae81ff">2</span><span style="color:#f92672">*</span><span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Second</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span></code></pre></div><h4 id="在-httpserver-中使用">在 http/server 中使用</h4>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// https://github.com/go-kratos/kratos/blob/main/examples/traces/app/user/main.go</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">httpSrv</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">NewServer</span><span style="color:#111">(</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Address</span><span style="color:#111">(</span><span style="color:#d88200">&#34;:8000&#34;</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">httpSrv</span><span style="color:#111">.</span><span style="color:#75af00">HandlePrefix</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">pb</span><span style="color:#111">.</span><span style="color:#75af00">NewUserHandler</span><span style="color:#111">(</span><span style="color:#75af00">s</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Middleware</span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Configuring tracing middleware</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">tracing</span><span style="color:#111">.</span><span style="color:#75af00">Server</span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">tracing</span><span style="color:#111">.</span><span style="color:#75af00">WithTracerProvider</span><span style="color:#111">(</span><span style="color:#75af00">tp</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">tracing</span><span style="color:#111">.</span><span style="color:#75af00">WithPropagators</span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">propagation</span><span style="color:#111">.</span><span style="color:#75af00">NewCompositeTextMapPropagator</span><span style="color:#111">(</span><span style="color:#75af00">propagation</span><span style="color:#111">.</span><span style="color:#75af00">Baggage</span><span style="color:#111">{},</span> <span style="color:#75af00">propagation</span><span style="color:#111">.</span><span style="color:#75af00">TraceContext</span><span style="color:#111">{}),</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">),</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span></code></pre></div><h4 id="在-httpclient-中使用">在 http/client 中使用</h4>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">NewClient</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">WithMiddleware</span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">tracing</span><span style="color:#111">.</span><span style="color:#75af00">Client</span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">tracing</span><span style="color:#111">.</span><span style="color:#75af00">WithTracerProvider</span><span style="color:#111">(</span><span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">tracer</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">),</span>
</span></span><span style="display:flex;"><span><span style="color:#111">))</span>
</span></span></code></pre></div><h4 id="如何实现一个其他场景的-tracing">如何实现一个其他场景的 tracing</h4>
<p>我们可以借鉴 <strong>kratos</strong> 的 <strong>tracing</strong> 中间件的代码来实现例如数据库的 <strong>tracing</strong>，如下面的代码片段，作者借鉴了<strong>tracing</strong> 中间件，实现了 <strong>qmgo</strong> 库操作 <strong>MongoDB</strong> 数据库的 <strong>tracing</strong>。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">mongoTracer</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">,</span><span style="color:#75af00">tp</span> <span style="color:#75af00">trace</span><span style="color:#111">.</span><span style="color:#75af00">TracerProvider</span><span style="color:#111">,</span> <span style="color:#75af00">command</span> <span style="color:#00a8c8">interface</span><span style="color:#111">{})</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">var</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">commandName</span> <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">failure</span>     <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">nanos</span>       <span style="color:#00a8c8">int64</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">reply</span>       <span style="color:#75af00">bson</span><span style="color:#111">.</span><span style="color:#75af00">Raw</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">queryId</span>     <span style="color:#00a8c8">int64</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">eventName</span>   <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">otel</span><span style="color:#111">.</span><span style="color:#75af00">SetTracerProvider</span><span style="color:#111">(</span><span style="color:#75af00">tp</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">reply</span> <span style="color:#111">=</span> <span style="color:#75af00">bson</span><span style="color:#111">.</span><span style="color:#75af00">Raw</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">switch</span> <span style="color:#75af00">value</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">command</span><span style="color:#111">.(</span><span style="color:#00a8c8">type</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">case</span> <span style="color:#f92672">*</span><span style="color:#75af00">event</span><span style="color:#111">.</span><span style="color:#75af00">CommandStartedEvent</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">commandName</span> <span style="color:#111">=</span> <span style="color:#75af00">value</span><span style="color:#111">.</span><span style="color:#75af00">CommandName</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">reply</span> <span style="color:#111">=</span> <span style="color:#75af00">value</span><span style="color:#111">.</span><span style="color:#75af00">Command</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">queryId</span> <span style="color:#111">=</span> <span style="color:#75af00">value</span><span style="color:#111">.</span><span style="color:#75af00">RequestID</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">eventName</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;CommandStartedEvent&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">case</span> <span style="color:#f92672">*</span><span style="color:#75af00">event</span><span style="color:#111">.</span><span style="color:#75af00">CommandSucceededEvent</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">commandName</span> <span style="color:#111">=</span> <span style="color:#75af00">value</span><span style="color:#111">.</span><span style="color:#75af00">CommandName</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">nanos</span> <span style="color:#111">=</span> <span style="color:#75af00">value</span><span style="color:#111">.</span><span style="color:#75af00">DurationNanos</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">queryId</span> <span style="color:#111">=</span> <span style="color:#75af00">value</span><span style="color:#111">.</span><span style="color:#75af00">RequestID</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">eventName</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;CommandSucceededEvent&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">case</span> <span style="color:#f92672">*</span><span style="color:#75af00">event</span><span style="color:#111">.</span><span style="color:#75af00">CommandFailedEvent</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">commandName</span> <span style="color:#111">=</span> <span style="color:#75af00">value</span><span style="color:#111">.</span><span style="color:#75af00">CommandName</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">failure</span> <span style="color:#111">=</span> <span style="color:#75af00">value</span><span style="color:#111">.</span><span style="color:#75af00">Failure</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">nanos</span> <span style="color:#111">=</span> <span style="color:#75af00">value</span><span style="color:#111">.</span><span style="color:#75af00">DurationNanos</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">queryId</span> <span style="color:#111">=</span> <span style="color:#75af00">value</span><span style="color:#111">.</span><span style="color:#75af00">RequestID</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">eventName</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;CommandFailedEvent&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">duration</span><span style="color:#111">,</span> <span style="color:#75af00">_</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">ParseDuration</span><span style="color:#111">(</span><span style="color:#75af00">strconv</span><span style="color:#111">.</span><span style="color:#75af00">FormatInt</span><span style="color:#111">(</span><span style="color:#75af00">nanos</span><span style="color:#111">,</span> <span style="color:#ae81ff">10</span><span style="color:#111">)</span> <span style="color:#f92672">+</span> <span style="color:#d88200">&#34;ns&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">tracer</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">otel</span><span style="color:#111">.</span><span style="color:#75af00">Tracer</span><span style="color:#111">(</span><span style="color:#d88200">&#34;mongodb&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">kind</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">trace</span><span style="color:#111">.</span><span style="color:#75af00">SpanKindServer</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">span</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">tracer</span><span style="color:#111">.</span><span style="color:#75af00">Start</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">commandName</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">trace</span><span style="color:#111">.</span><span style="color:#75af00">WithAttributes</span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">attribute</span><span style="color:#111">.</span><span style="color:#75af00">String</span><span style="color:#111">(</span><span style="color:#d88200">&#34;event&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">eventName</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">attribute</span><span style="color:#111">.</span><span style="color:#75af00">String</span><span style="color:#111">(</span><span style="color:#d88200">&#34;command&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">commandName</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">attribute</span><span style="color:#111">.</span><span style="color:#75af00">String</span><span style="color:#111">(</span><span style="color:#d88200">&#34;query&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">reply</span><span style="color:#111">.</span><span style="color:#75af00">String</span><span style="color:#111">()),</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">attribute</span><span style="color:#111">.</span><span style="color:#75af00">Int64</span><span style="color:#111">(</span><span style="color:#d88200">&#34;queryId&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">queryId</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">attribute</span><span style="color:#111">.</span><span style="color:#75af00">String</span><span style="color:#111">(</span><span style="color:#d88200">&#34;ms&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">duration</span><span style="color:#111">.</span><span style="color:#75af00">String</span><span style="color:#111">()),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">trace</span><span style="color:#111">.</span><span style="color:#75af00">WithSpanKind</span><span style="color:#111">(</span><span style="color:#75af00">kind</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">failure</span> <span style="color:#f92672">!=</span> <span style="color:#d88200">&#34;&#34;</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">span</span><span style="color:#111">.</span><span style="color:#75af00">RecordError</span><span style="color:#111">(</span><span style="color:#75af00">errors</span><span style="color:#111">.</span><span style="color:#75af00">New</span><span style="color:#111">(</span><span style="color:#75af00">failure</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">span</span><span style="color:#111">.</span><span style="color:#75af00">End</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="文章转自">文章转自</h2>
<ul>
<li><a href="https://go-kratos.dev/blog/go-kratos-opentelemetry-practice">https://go-kratos.dev/blog/go-kratos-opentelemetry-practice</a></li>
</ul>
<hr>
<p><img src="/images/e229d439-abe8-46dc-ade5-1ed23e0f6e9f.png" alt=""></p>
<p><img src="/images/ff1c163e-73c7-4fe7-b4d5-bb380f48f38c.gif" alt=""></p>
]]></content:encoded><category>kratos</category><category>go</category><category>kratos</category><category>opentelemetry</category></item></channel></rss>