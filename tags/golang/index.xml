<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/"><channel><title>Golang on Daemon365</title><link>https://daemon365.dev/tags/golang/</link><description>Don't let yourself stop.</description><generator>Hugo -- gohugo.io</generator><language>zh-cn</language><lastBuildDate>Sat, 15 Jun 2024 16:14:00 +0800</lastBuildDate><atom:link href="https://daemon365.dev/tags/golang/index.xml" rel="self" type="application/rss+xml"/><item><title>boltdb 原理</title><link>https://daemon365.dev/post/cloud/boltdb_principles/</link><pubDate>Sat, 15 Jun 2024 16:14:00 +0800</pubDate><guid>https://daemon365.dev/post/cloud/boltdb_principles/</guid><description>&lt;h2 id="简介"&gt;简介&lt;/h2&gt;
&lt;p&gt;介绍及简单使用：https://www.cnblogs.com/daemon365/p/17690167.html
源码地址：https://github.com/etcd-io/bbolt&lt;/p&gt;
&lt;h2 id="page"&gt;page&lt;/h2&gt;
&lt;p&gt;因为 boltdb 是要落盘的，所以就要操作文件。为了提高效率，boltdb 会和其他数据库一样，会按 页（page）来操作文件。而且 boltdb 使用了 linux 的 &lt;a href="https://man7.org/linux/man-pages/man2/mmap.2.html"&gt;mmap&lt;/a&gt; 来内存映射操作文件，这样可以提高效率。&lt;/p&gt;
&lt;p&gt;在 linux 中，每个 page 的大小是 4KB。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-BASH" data-lang="BASH"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;getconf PAGESIZE
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#ae81ff"&gt;4096&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;对应的每页在我们的代理里也应该有一个数据结构，来存储数据。这个数据结构就是 &lt;code&gt;page&lt;/code&gt;。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;type&lt;/span&gt; &lt;span style="color:#75af00"&gt;Pgid&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;uint64&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;type&lt;/span&gt; &lt;span style="color:#75af00"&gt;Page&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;struct&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;id&lt;/span&gt; &lt;span style="color:#75af00"&gt;Pgid&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;flags&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;uint16&lt;/span&gt; &lt;span style="color:#75715e"&gt;// page 类型&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;count&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;uint16&lt;/span&gt; &lt;span style="color:#75715e"&gt;// page 中的元素数量&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;overflow&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;uint32&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 是否有后序页，如果有，overflow 表示后续页的数量&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;const&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;BranchPageFlag&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;0x01&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;LeafPageFlag&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;0x02&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;MetaPageFlag&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;0x04&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;FreelistPageFlag&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;0x10&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;code&gt;Page&lt;/code&gt; 里面有一个 &lt;code&gt;flags&lt;/code&gt; 字段，用来标识这个 page 是什么类型的。boltdb 里面有四种类型的 page, 分别是 分支页（BranchPageFlag）、叶子页（LeafPageFlag）、元数据页（MetaPageFlag）、空闲列表页（FreelistPageFlag）。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;分支页：由于 boltdb 使用的是 B+ 树，所以分支页用来存储 key 和子节点的指针。&lt;/li&gt;
&lt;li&gt;叶子页：叶子页用来存储 key 和 value。&lt;/li&gt;
&lt;li&gt;元数据页：元数据页用来存储 boltdb 的元数据，比如 boltdb 的版本号、boltdb 的根节点等。&lt;/li&gt;
&lt;li&gt;空闲列表页：由于 boltdb 使用 copy on write，所以当一个 page 被删除的时候，boltdb 并不会立即释放这个 page，而是把这个 page 加入到空闲列表页中，等到需要新的 page 的时候，再从空闲列表页中取出一个 page。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;在 page 之后会存储对用的结构，比如 meta 或者 freelist。先读取 page 判断自己的结构（定长的：8 + 2 + 2 +4），然后再根据不同的数据类型读取其他的结构（比如BranchPage）。&lt;/p&gt;</description><content:encoded><![CDATA[<h2 id="简介">简介</h2>
<p>介绍及简单使用：https://www.cnblogs.com/daemon365/p/17690167.html
源码地址：https://github.com/etcd-io/bbolt</p>
<h2 id="page">page</h2>
<p>因为 boltdb 是要落盘的，所以就要操作文件。为了提高效率，boltdb 会和其他数据库一样，会按 页（page）来操作文件。而且 boltdb 使用了 linux 的 <a href="https://man7.org/linux/man-pages/man2/mmap.2.html">mmap</a> 来内存映射操作文件，这样可以提高效率。</p>
<p>在 linux 中，每个 page 的大小是 4KB。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-BASH" data-lang="BASH"><span style="display:flex;"><span>getconf PAGESIZE
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">4096</span>
</span></span></code></pre></div><p>对应的每页在我们的代理里也应该有一个数据结构，来存储数据。这个数据结构就是 <code>page</code>。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Pgid</span> <span style="color:#00a8c8">uint64</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Page</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">id</span>       <span style="color:#75af00">Pgid</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">flags</span>    <span style="color:#00a8c8">uint16</span> <span style="color:#75715e">// page 类型</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">count</span>    <span style="color:#00a8c8">uint16</span> <span style="color:#75715e">// page 中的元素数量</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">overflow</span> <span style="color:#00a8c8">uint32</span> <span style="color:#75715e">// 是否有后序页，如果有，overflow 表示后续页的数量</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">const</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">BranchPageFlag</span>   <span style="color:#111">=</span> <span style="color:#ae81ff">0x01</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">LeafPageFlag</span>     <span style="color:#111">=</span> <span style="color:#ae81ff">0x02</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">MetaPageFlag</span>     <span style="color:#111">=</span> <span style="color:#ae81ff">0x04</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">FreelistPageFlag</span> <span style="color:#111">=</span> <span style="color:#ae81ff">0x10</span> 
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span></code></pre></div><p><code>Page</code> 里面有一个 <code>flags</code> 字段，用来标识这个 page 是什么类型的。boltdb 里面有四种类型的 page, 分别是 分支页（BranchPageFlag）、叶子页（LeafPageFlag）、元数据页（MetaPageFlag）、空闲列表页（FreelistPageFlag）。</p>
<ul>
<li>分支页：由于 boltdb 使用的是 B+ 树，所以分支页用来存储 key 和子节点的指针。</li>
<li>叶子页：叶子页用来存储 key 和 value。</li>
<li>元数据页：元数据页用来存储 boltdb 的元数据，比如 boltdb 的版本号、boltdb 的根节点等。</li>
<li>空闲列表页：由于 boltdb 使用 copy on write，所以当一个 page 被删除的时候，boltdb 并不会立即释放这个 page，而是把这个 page 加入到空闲列表页中，等到需要新的 page 的时候，再从空闲列表页中取出一个 page。</li>
</ul>
<p>在 page 之后会存储对用的结构，比如 meta 或者 freelist。先读取 page 判断自己的结构（定长的：8 + 2 + 2 +4），然后再根据不同的数据类型读取其他的结构（比如BranchPage）。</p>
<p><img src="/images/eebaffa3-116e-40f0-95be-2dfc0ee58bd6.png" alt=""></p>
<h3 id="branchpage--leafpage">BranchPage &amp;&amp; LeafPage</h3>
<p>这两个分别存储 B+ tree 的分支页和叶子页。对应结构为：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// branchPageElement represents a node on a branch page.</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">branchPageElement</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">pos</span>   <span style="color:#00a8c8">uint32</span> <span style="color:#75715e">// 真实数据对应的偏移量</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ksize</span> <span style="color:#00a8c8">uint32</span> <span style="color:#75715e">// key 的大小</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">pgid</span>  <span style="color:#75af00">Pgid</span> <span style="color:#75715e">// 指向 page 的 id</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// leafPageElement represents a node on a leaf page.</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">leafPageElement</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">flags</span> <span style="color:#00a8c8">uint32</span> <span style="color:#75715e">// 是否是一个 bucket</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">pos</span>   <span style="color:#00a8c8">uint32</span> <span style="color:#75715e">// 真实数据对应的偏移量</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ksize</span> <span style="color:#00a8c8">uint32</span> <span style="color:#75715e">// key 的大小</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">vsize</span> <span style="color:#00a8c8">uint32</span> <span style="color:#75715e">// value 的大小</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>对应的存储方式为:</p>
<p><img src="/images/c5206aef-62de-447a-880a-3024a75f4b3d.png" alt=""></p>
<p>从 page 中拿取数据：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">p</span> <span style="color:#f92672">*</span><span style="color:#75af00">Page</span><span style="color:#111">)</span> <span style="color:#75af00">LeafPageElements</span><span style="color:#111">()</span> <span style="color:#111">[]</span><span style="color:#75af00">leafPageElement</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">count</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 从 page 的指针 加上 page 的大小，就是第一个元素的地址</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">data</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">UnsafeAdd</span><span style="color:#111">(</span><span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">(</span><span style="color:#75af00">p</span><span style="color:#111">),</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Sizeof</span><span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">p</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 转换为 slice</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">elems</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Slice</span><span style="color:#111">((</span><span style="color:#f92672">*</span><span style="color:#75af00">leafPageElement</span><span style="color:#111">)(</span><span style="color:#75af00">data</span><span style="color:#111">),</span> <span style="color:#111">int</span><span style="color:#111">(</span><span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">count</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">elems</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">p</span> <span style="color:#f92672">*</span><span style="color:#75af00">Page</span><span style="color:#111">)</span> <span style="color:#75af00">BranchPageElements</span><span style="color:#111">()</span> <span style="color:#111">[]</span><span style="color:#75af00">branchPageElement</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">count</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">data</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">UnsafeAdd</span><span style="color:#111">(</span><span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">(</span><span style="color:#75af00">p</span><span style="color:#111">),</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Sizeof</span><span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">p</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">elems</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Slice</span><span style="color:#111">((</span><span style="color:#f92672">*</span><span style="color:#75af00">branchPageElement</span><span style="color:#111">)(</span><span style="color:#75af00">data</span><span style="color:#111">),</span> <span style="color:#111">int</span><span style="color:#111">(</span><span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">count</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">elems</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="metapage">MetaPage</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Meta</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">magic</span>    <span style="color:#00a8c8">uint32</span> <span style="color:#75715e">// boltdb 的魔数</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">version</span>  <span style="color:#00a8c8">uint32</span> <span style="color:#75715e">// boltdb 的版本</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">pageSize</span> <span style="color:#00a8c8">uint32</span> <span style="color:#75715e">// boltdb 的 page 大小 ，该值和操作系统默认的页大小保持一致</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">flags</span>    <span style="color:#00a8c8">uint32</span> 
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">root</span>     <span style="color:#75af00">InBucket</span> <span style="color:#75715e">// boltdb 的根节点</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">freelist</span> <span style="color:#75af00">Pgid</span>   <span style="color:#75715e">// 空闲页的 id</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">pgid</span>     <span style="color:#75af00">Pgid</span> <span style="color:#75715e">// 当前 page 的 id</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">txid</span>     <span style="color:#75af00">Txid</span> <span style="color:#75715e">// 当前事务的 id</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">checksum</span> <span style="color:#00a8c8">uint64</span> <span style="color:#75715e">// 用作校验的校验和</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>它是如何写到 page 中的和从 page 中读取的呢？</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// 把 meta 写到 page 中</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">m</span> <span style="color:#f92672">*</span><span style="color:#75af00">Meta</span><span style="color:#111">)</span> <span style="color:#75af00">Write</span><span style="color:#111">(</span><span style="color:#75af00">p</span> <span style="color:#f92672">*</span><span style="color:#75af00">Page</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 检查 root bucket 的 pgid 是否有效。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 如果 root.root 的 pgid 大于或等于 m.pgid，这是不合理的，因为这意味着它引用了一个尚未分配的 pgid。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">root</span><span style="color:#111">.</span><span style="color:#75af00">root</span> <span style="color:#f92672">&gt;=</span> <span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">pgid</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Sprintf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;root bucket pgid (%d) above high water mark (%d)&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">root</span><span style="color:#111">.</span><span style="color:#75af00">root</span><span style="color:#111">,</span> <span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">pgid</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	  <span style="color:#75715e">// 检查 freelist 的 pgid 是否有效。</span>
</span></span><span style="display:flex;"><span>	  <span style="color:#75715e">// 如果 freelist 的 pgid 大于或等于 m.pgid 且 freelist 不是 PgidNoFreelist，</span>
</span></span><span style="display:flex;"><span>	  <span style="color:#75715e">// 这同样表示它引用了一个尚未分配的 pgid，这是不合理的。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#00a8c8">if</span> <span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">freelist</span> <span style="color:#f92672">&gt;=</span> <span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">pgid</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">freelist</span> <span style="color:#f92672">!=</span> <span style="color:#75af00">PgidNoFreelist</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Sprintf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;freelist pgid (%d) above high water mark (%d)&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">freelist</span><span style="color:#111">,</span> <span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">pgid</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 指定 pageId 和 page 类型</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">id</span> <span style="color:#111">=</span> <span style="color:#75af00">Pgid</span><span style="color:#111">(</span><span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">txid</span> <span style="color:#f92672">%</span> <span style="color:#ae81ff">2</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">SetFlags</span><span style="color:#111">(</span><span style="color:#75af00">MetaPageFlag</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 计算校验和</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">checksum</span> <span style="color:#111">=</span> <span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">Sum64</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">Copy</span><span style="color:#111">(</span><span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">Meta</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 从 page 中读取 meta</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">p</span> <span style="color:#f92672">*</span><span style="color:#75af00">Page</span><span style="color:#111">)</span> <span style="color:#75af00">Meta</span><span style="color:#111">()</span> <span style="color:#f92672">*</span><span style="color:#75af00">Meta</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">Meta</span><span style="color:#111">)(</span><span style="color:#75af00">UnsafeAdd</span><span style="color:#111">(</span><span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">(</span><span style="color:#75af00">p</span><span style="color:#111">),</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Sizeof</span><span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">p</span><span style="color:#111">)))</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 把 meta 的数据拷贝到 page 中</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">m</span> <span style="color:#f92672">*</span><span style="color:#75af00">Meta</span><span style="color:#111">)</span> <span style="color:#75af00">Copy</span><span style="color:#111">(</span><span style="color:#75af00">dest</span> <span style="color:#f92672">*</span><span style="color:#75af00">Meta</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">*</span><span style="color:#75af00">dest</span> <span style="color:#111">=</span> <span style="color:#f92672">*</span><span style="color:#75af00">m</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 计算校验和</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">m</span> <span style="color:#f92672">*</span><span style="color:#75af00">Meta</span><span style="color:#111">)</span> <span style="color:#75af00">Sum64</span><span style="color:#111">()</span> <span style="color:#00a8c8">uint64</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">var</span> <span style="color:#75af00">h</span> <span style="color:#111">=</span> <span style="color:#75af00">fnv</span><span style="color:#111">.</span><span style="color:#75af00">New64a</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">_</span> <span style="color:#111">=</span> <span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">Write</span><span style="color:#111">((</span><span style="color:#f92672">*</span><span style="color:#111">[</span><span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Offsetof</span><span style="color:#111">(</span><span style="color:#75af00">Meta</span><span style="color:#111">{}.</span><span style="color:#75af00">checksum</span><span style="color:#111">)]</span><span style="color:#00a8c8">byte</span><span style="color:#111">)(</span><span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">(</span><span style="color:#75af00">m</span><span style="color:#111">))[:])</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">Sum64</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="freelistpage">FreelistPage</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">freelist</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 表示 freelist 的类型，可能会有不同的策略或实现。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">freelistType</span> <span style="color:#75af00">FreelistType</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 存储所有已释放且可供分配的页面ID。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">ids</span> <span style="color:#111">[]</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 记录哪个事务ID分配了特定的页面ID。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">allocs</span> <span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">]</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Txid</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 记录即将被释放的页面ID及其所属的事务ID。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">pending</span> <span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Txid</span><span style="color:#111">]</span><span style="color:#f92672">*</span><span style="color:#75af00">txPending</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 快速查找所有空闲和待处理页面ID的缓存。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">cache</span> <span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">]</span><span style="color:#00a8c8">struct</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 按连续页面大小分类的空闲页面，键是连续页面的大小，值是具有相同大小的起始页面ID的集合。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">freemaps</span> <span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#00a8c8">uint64</span><span style="color:#111">]</span><span style="color:#75af00">pidSet</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 正向映射，键是起始页面ID，值是其span大小。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">forwardMap</span> <span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">]</span><span style="color:#00a8c8">uint64</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 反向映射，键是结束页面ID，值是其span大小。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">backwardMap</span> <span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">]</span><span style="color:#00a8c8">uint64</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 空闲页面的计数（基于哈希图的版本）。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">freePagesCount</span> <span style="color:#00a8c8">uint64</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 分配函数，根据提供的事务ID和需求的页面数量分配页面。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">allocate</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">txid</span> <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Txid</span><span style="color:#111">,</span> <span style="color:#75af00">n</span> <span style="color:#00a8c8">int</span><span style="color:#111">)</span> <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 返回当前空闲页面数量的函数。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">free_count</span> <span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#00a8c8">int</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 合并连续空闲页面的函数。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">mergeSpans</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">ids</span> <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgids</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 获取所有空闲页面ID的函数。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">getFreePageIDs</span> <span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#111">[]</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 读取一系列页面ID并初始化 freelist 的函数。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">readIDs</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">pgids</span> <span style="color:#111">[]</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// FreelistType 定义了 freelist 后端的类型，用字符串表示不同的实现策略。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">FreelistType</span> <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 未来的开发计划：</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//  1. 默认改为使用 `FreelistMapType`；</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//  2. 移除 `FreelistArrayType`，不再公开 `FreelistMapType`，</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//     并从 `DB` 和 `Options` 结构体中移除 `FreelistType` 字段。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">const</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// FreelistArrayType 表示 freelist 的后端类型为数组。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 这种类型可能适用于需要按顺序访问空闲页的场景。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">FreelistArrayType</span> <span style="color:#111">=</span> <span style="color:#75af00">FreelistType</span><span style="color:#111">(</span><span style="color:#d88200">&#34;array&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// FreelistMapType 表示 freelist 的后端类型为哈希映射。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 这种类型提供了更快的查找速度，适合于频繁、随机地访问空闲页的情况。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">FreelistMapType</span> <span style="color:#111">=</span> <span style="color:#75af00">FreelistType</span><span style="color:#111">(</span><span style="color:#d88200">&#34;hashmap&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span></code></pre></div><p>把 freelist 写到 page 中：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// write 将空闲和待处理的页面ID写入到 freelist 页面。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 在程序崩溃的事件中，所有待处理的ID都将变成空闲的，因此这些ID都需要被保存到磁盘上。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">f</span> <span style="color:#f92672">*</span><span style="color:#75af00">freelist</span><span style="color:#111">)</span> <span style="color:#75af00">write</span><span style="color:#111">(</span><span style="color:#75af00">p</span> <span style="color:#f92672">*</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Page</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> 	<span style="color:#75715e">// 设置页头中的页类型标识</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">SetFlags</span><span style="color:#111">(</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">FreelistPageFlag</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 获取需要保存的 PageID 数量。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">l</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">count</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">l</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 没有 id 需要保存，直接返回。</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">SetCount</span><span style="color:#111">(</span><span style="color:#111">uint16</span><span style="color:#111">(</span><span style="color:#75af00">l</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#00a8c8">if</span> <span style="color:#75af00">l</span> <span style="color:#111">&lt;</span> <span style="color:#ae81ff">0xFFFF</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 如果数量小于 0xFFFF</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 将 id 数量写入到页头中</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">SetCount</span><span style="color:#111">(</span><span style="color:#111">uint16</span><span style="color:#111">(</span><span style="color:#75af00">l</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 计算指针头</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">data</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">UnsafeAdd</span><span style="color:#111">(</span><span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">(</span><span style="color:#75af00">p</span><span style="color:#111">),</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Sizeof</span><span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">p</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 开辟一个 slice 用来存储 id</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">ids</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Slice</span><span style="color:#111">((</span><span style="color:#f92672">*</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">)(</span><span style="color:#75af00">data</span><span style="color:#111">),</span> <span style="color:#75af00">l</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 将 id 拷贝到 page 中</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">copyall</span><span style="color:#111">(</span><span style="color:#75af00">ids</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 如果数量大于 0xFFFF ，则需要分多个 page 来保存</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 先设置本页的数量为 0xFFFF</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">SetCount</span><span style="color:#111">(</span><span style="color:#ae81ff">0xFFFF</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 计算指针头 </span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">data</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">UnsafeAdd</span><span style="color:#111">(</span><span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">(</span><span style="color:#75af00">p</span><span style="color:#111">),</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Sizeof</span><span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">p</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">ids</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Slice</span><span style="color:#111">((</span><span style="color:#f92672">*</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">)(</span><span style="color:#75af00">data</span><span style="color:#111">),</span> <span style="color:#75af00">l</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 将ID数量存储在第一个元素中</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">ids</span><span style="color:#111">[</span><span style="color:#ae81ff">0</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">(</span><span style="color:#75af00">l</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 将剩余的 id 拷贝到 page 中</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">copyall</span><span style="color:#111">(</span><span style="color:#75af00">ids</span><span style="color:#111">[</span><span style="color:#ae81ff">1</span><span style="color:#111">:])</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// copyall 将所有空闲的ID和所有待处理的ID复制到一个排序后的列表中。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// f.count 返回目标数组 dst 需要的最小长度。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">f</span> <span style="color:#f92672">*</span><span style="color:#75af00">freelist</span><span style="color:#111">)</span> <span style="color:#75af00">copyall</span><span style="color:#111">(</span><span style="color:#75af00">dst</span> <span style="color:#111">[]</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 创建一个切片用于存放待处理的ID，容量预设为待处理ID的数量。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">m</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgids</span><span style="color:#111">,</span> <span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">pending_count</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 遍历所有待处理事务，并将它们的ID加入到切片 m 中。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">txp</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">pending</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">m</span> <span style="color:#111">=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">m</span><span style="color:#111">,</span> <span style="color:#75af00">txp</span><span style="color:#111">.</span><span style="color:#75af00">ids</span><span style="color:#f92672">...</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 对切片 m 进行排序。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">sort</span><span style="color:#111">.</span><span style="color:#75af00">Sort</span><span style="color:#111">(</span><span style="color:#75af00">m</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 将已经空闲的ID和刚排序的待处理ID合并到目标切片 dst 中。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Mergepgids</span><span style="color:#111">(</span><span style="color:#75af00">dst</span><span style="color:#111">,</span> <span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">getFreePageIDs</span><span style="color:#111">(),</span> <span style="color:#75af00">m</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Mergepgids 将两个已排序列表 a 和 b 的并集复制到 dst 中。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 如果 dst 的长度不足以容纳结果，会触发 panic。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">Mergepgids</span><span style="color:#111">(</span><span style="color:#75af00">dst</span><span style="color:#111">,</span> <span style="color:#75af00">a</span><span style="color:#111">,</span> <span style="color:#75af00">b</span> <span style="color:#75af00">Pgids</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 检查目标切片 dst 是否足够大以容纳 a 和 b 的所有元素。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">dst</span><span style="color:#111">)</span> <span style="color:#111">&lt;</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">a</span><span style="color:#111">)</span><span style="color:#f92672">+</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">b</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;mergepgids bad len %d &lt; %d + %d&#34;</span><span style="color:#111">,</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">dst</span><span style="color:#111">),</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">a</span><span style="color:#111">),</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">b</span><span style="color:#111">)))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 如果其中一个列表为空，则直接将另一个列表复制到 dst 中。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">a</span><span style="color:#111">)</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">copy</span><span style="color:#111">(</span><span style="color:#75af00">dst</span><span style="color:#111">,</span> <span style="color:#75af00">b</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">b</span><span style="color:#111">)</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">copy</span><span style="color:#111">(</span><span style="color:#75af00">dst</span><span style="color:#111">,</span> <span style="color:#75af00">a</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 初始化一个切片 merged 来存储最终合并的结果。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">merged</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">dst</span><span style="color:#111">[:</span><span style="color:#ae81ff">0</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 确定哪个列表的起始值更小，并将其设为 lead，另一个设为 follow。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">lead</span><span style="color:#111">,</span> <span style="color:#75af00">follow</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">a</span><span style="color:#111">,</span> <span style="color:#75af00">b</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">b</span><span style="color:#111">[</span><span style="color:#ae81ff">0</span><span style="color:#111">]</span> <span style="color:#111">&lt;</span> <span style="color:#75af00">a</span><span style="color:#111">[</span><span style="color:#ae81ff">0</span><span style="color:#111">]</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">lead</span><span style="color:#111">,</span> <span style="color:#75af00">follow</span> <span style="color:#111">=</span> <span style="color:#75af00">b</span><span style="color:#111">,</span> <span style="color:#75af00">a</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 循环合并，直到 lead 为空。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">for</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">lead</span><span style="color:#111">)</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 合并 lead 中所有小于 follow[0] 的元素。</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">n</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">sort</span><span style="color:#111">.</span><span style="color:#75af00">Search</span><span style="color:#111">(</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">lead</span><span style="color:#111">),</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">i</span> <span style="color:#00a8c8">int</span><span style="color:#111">)</span> <span style="color:#00a8c8">bool</span> <span style="color:#111">{</span> <span style="color:#00a8c8">return</span> <span style="color:#75af00">lead</span><span style="color:#111">[</span><span style="color:#75af00">i</span><span style="color:#111">]</span> <span style="color:#111">&gt;</span> <span style="color:#75af00">follow</span><span style="color:#111">[</span><span style="color:#ae81ff">0</span><span style="color:#111">]</span> <span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">merged</span> <span style="color:#111">=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">merged</span><span style="color:#111">,</span> <span style="color:#75af00">lead</span><span style="color:#111">[:</span><span style="color:#75af00">n</span><span style="color:#111">]</span><span style="color:#f92672">...</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#75af00">n</span> <span style="color:#f92672">&gt;=</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">lead</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">break</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 交换 lead 和 follow，继续合并过程。</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">lead</span><span style="color:#111">,</span> <span style="color:#75af00">follow</span> <span style="color:#111">=</span> <span style="color:#75af00">follow</span><span style="color:#111">,</span> <span style="color:#75af00">lead</span><span style="color:#111">[</span><span style="color:#75af00">n</span><span style="color:#111">:]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 将剩余的 follow 元素加入到 merged 中。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">_</span> <span style="color:#111">=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">merged</span><span style="color:#111">,</span> <span style="color:#75af00">follow</span><span style="color:#f92672">...</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>从 page 中读取 freelist：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// read 从 freelist 页面读取页面ID。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">f</span> <span style="color:#f92672">*</span><span style="color:#75af00">freelist</span><span style="color:#111">)</span> <span style="color:#75af00">read</span><span style="color:#111">(</span><span style="color:#75af00">p</span> <span style="color:#f92672">*</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Page</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 首先检查是否为 freelist 页面，如果不是则抛出错误。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">IsFreelistPage</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Sprintf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;invalid freelist page: %d, page type is %s&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">Id</span><span style="color:#111">(),</span> <span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">Typ</span><span style="color:#111">()))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 从页面获取 freelist 页面的ID列表。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">ids</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">FreelistPageIds</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 如果获取的ID列表为空，将 f.ids 设置为 nil，表示没有空闲页面。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">ids</span><span style="color:#111">)</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">ids</span> <span style="color:#111">=</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 如果ID列表不为空，则创建一个新切片并复制这些ID，以避免直接修改原始页面数据。</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">idsCopy</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">([]</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">,</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">ids</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">copy</span><span style="color:#111">(</span><span style="color:#75af00">idsCopy</span><span style="color:#111">,</span> <span style="color:#75af00">ids</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 确保复制的ID列表是排序的。</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">sort</span><span style="color:#111">.</span><span style="color:#75af00">Sort</span><span style="color:#111">(</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgids</span><span style="color:#111">(</span><span style="color:#75af00">idsCopy</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 将排序后的ID列表读入 freelist 结构。</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">readIDs</span><span style="color:#111">(</span><span style="color:#75af00">idsCopy</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// hashmapReadIDs 读取输入的 pgids 并初始化 freelist（基于哈希映射的版本）。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">f</span> <span style="color:#f92672">*</span><span style="color:#75af00">freelist</span><span style="color:#111">)</span> <span style="color:#75af00">hashmapReadIDs</span><span style="color:#111">(</span><span style="color:#75af00">pgids</span> <span style="color:#111">[]</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 初始化 freelist。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">init</span><span style="color:#111">(</span><span style="color:#75af00">pgids</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 重建页面缓存。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">reindex</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// reindex 基于可用和待处理的空闲列表重建自由缓存。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">f</span> <span style="color:#f92672">*</span><span style="color:#75af00">freelist</span><span style="color:#111">)</span> <span style="color:#75af00">reindex</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 获取所有空闲页面ID。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">ids</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">getFreePageIDs</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 创建一个新的缓存映射。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">cache</span> <span style="color:#111">=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">]</span><span style="color:#00a8c8">struct</span><span style="color:#111">{},</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">ids</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 将所有空闲ID添加到缓存中。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">id</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">ids</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">cache</span><span style="color:#111">[</span><span style="color:#75af00">id</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#00a8c8">struct</span><span style="color:#111">{}{}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 将所有待处理的空闲ID也添加到缓存中。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">txp</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">pending</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">pendingID</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">txp</span><span style="color:#111">.</span><span style="color:#75af00">ids</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">cache</span><span style="color:#111">[</span><span style="color:#75af00">pendingID</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#00a8c8">struct</span><span style="color:#111">{}{}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>分配页：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// hashmapAllocate 根据传入的事务ID和请求的页面数量，分配页面。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">f</span> <span style="color:#f92672">*</span><span style="color:#75af00">freelist</span><span style="color:#111">)</span> <span style="color:#75af00">hashmapAllocate</span><span style="color:#111">(</span><span style="color:#75af00">txid</span> <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Txid</span><span style="color:#111">,</span> <span style="color:#75af00">n</span> <span style="color:#00a8c8">int</span><span style="color:#111">)</span> <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">n</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 如果请求的页面数量为0，则直接返回0，表示没有分配任何页面。</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 检查是否存在完全匹配的空闲span。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">bm</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">freemaps</span><span style="color:#111">[</span><span style="color:#111">uint64</span><span style="color:#111">(</span><span style="color:#75af00">n</span><span style="color:#111">)];</span> <span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">for</span> <span style="color:#75af00">pid</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">bm</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 移除这个span。</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">delSpan</span><span style="color:#111">(</span><span style="color:#75af00">pid</span><span style="color:#111">,</span> <span style="color:#111">uint64</span><span style="color:#111">(</span><span style="color:#75af00">n</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 记录这个页面ID被哪个事务分配。</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">allocs</span><span style="color:#111">[</span><span style="color:#75af00">pid</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#75af00">txid</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 从缓存中移除已分配的页面。</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">for</span> <span style="color:#75af00">i</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">(</span><span style="color:#ae81ff">0</span><span style="color:#111">);</span> <span style="color:#75af00">i</span> <span style="color:#111">&lt;</span> <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">(</span><span style="color:#75af00">n</span><span style="color:#111">);</span> <span style="color:#75af00">i</span><span style="color:#f92672">++</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#111">delete</span><span style="color:#111">(</span><span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">cache</span><span style="color:#111">,</span> <span style="color:#75af00">pid</span><span style="color:#f92672">+</span><span style="color:#75af00">i</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#75af00">pid</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 在映射中查找大于请求大小的更大span。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">size</span><span style="color:#111">,</span> <span style="color:#75af00">bm</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">freemaps</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">size</span> <span style="color:#111">&lt;</span> <span style="color:#111">uint64</span><span style="color:#111">(</span><span style="color:#75af00">n</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">continue</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">for</span> <span style="color:#75af00">pid</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">bm</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 移除找到的大span。</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">delSpan</span><span style="color:#111">(</span><span style="color:#75af00">pid</span><span style="color:#111">,</span> <span style="color:#75af00">size</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 记录页面分配。</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">allocs</span><span style="color:#111">[</span><span style="color:#75af00">pid</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#75af00">txid</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 计算剩余的span大小，并添加回 freelist。</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">remain</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">size</span> <span style="color:#f92672">-</span> <span style="color:#111">uint64</span><span style="color:#111">(</span><span style="color:#75af00">n</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">addSpan</span><span style="color:#111">(</span><span style="color:#75af00">pid</span><span style="color:#f92672">+</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">(</span><span style="color:#75af00">n</span><span style="color:#111">),</span> <span style="color:#75af00">remain</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 从缓存中移除已分配的页面。</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">for</span> <span style="color:#75af00">i</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">(</span><span style="color:#ae81ff">0</span><span style="color:#111">);</span> <span style="color:#75af00">i</span> <span style="color:#111">&lt;</span> <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">(</span><span style="color:#75af00">n</span><span style="color:#111">);</span> <span style="color:#75af00">i</span><span style="color:#f92672">++</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#111">delete</span><span style="color:#111">(</span><span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">cache</span><span style="color:#111">,</span> <span style="color:#75af00">pid</span><span style="color:#f92672">+</span><span style="color:#75af00">i</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#75af00">pid</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// delSpan 从 freelist 中删除一个span。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">f</span> <span style="color:#f92672">*</span><span style="color:#75af00">freelist</span><span style="color:#111">)</span> <span style="color:#75af00">delSpan</span><span style="color:#111">(</span><span style="color:#75af00">start</span> <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">,</span> <span style="color:#75af00">size</span> <span style="color:#00a8c8">uint64</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 更新前向和后向映射，移除对应的条目。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">delete</span><span style="color:#111">(</span><span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">forwardMap</span><span style="color:#111">,</span> <span style="color:#75af00">start</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">delete</span><span style="color:#111">(</span><span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">backwardMap</span><span style="color:#111">,</span> <span style="color:#75af00">start</span><span style="color:#f92672">+</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">(</span><span style="color:#75af00">size</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 从 freemaps 中移除span。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">delete</span><span style="color:#111">(</span><span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">freemaps</span><span style="color:#111">[</span><span style="color:#75af00">size</span><span style="color:#111">],</span> <span style="color:#75af00">start</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">freemaps</span><span style="color:#111">[</span><span style="color:#75af00">size</span><span style="color:#111">])</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 如果某个大小的span已经没有其他项，从 freemaps 中完全移除这个大小。</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">delete</span><span style="color:#111">(</span><span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">freemaps</span><span style="color:#111">,</span> <span style="color:#75af00">size</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 更新空闲页面计数。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">freePagesCount</span> <span style="color:#f92672">-=</span> <span style="color:#75af00">size</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// addSpan 向 freelist 中添加一个新的span。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">f</span> <span style="color:#f92672">*</span><span style="color:#75af00">freelist</span><span style="color:#111">)</span> <span style="color:#75af00">addSpan</span><span style="color:#111">(</span><span style="color:#75af00">start</span> <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">,</span> <span style="color:#75af00">size</span> <span style="color:#00a8c8">uint64</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 更新前向和后向映射。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">backwardMap</span><span style="color:#111">[</span><span style="color:#75af00">start</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">+</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">(</span><span style="color:#75af00">size</span><span style="color:#111">)]</span> <span style="color:#111">=</span> <span style="color:#75af00">size</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">forwardMap</span><span style="color:#111">[</span><span style="color:#75af00">start</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#75af00">size</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 确保 freemaps 中存在对应大小的映射。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">freemaps</span><span style="color:#111">[</span><span style="color:#75af00">size</span><span style="color:#111">];</span> <span style="color:#111">!</span><span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">freemaps</span><span style="color:#111">[</span><span style="color:#75af00">size</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">]</span><span style="color:#00a8c8">struct</span><span style="color:#111">{})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 添加新的span到 freemaps。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">freemaps</span><span style="color:#111">[</span><span style="color:#75af00">size</span><span style="color:#111">][</span><span style="color:#75af00">start</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#00a8c8">struct</span><span style="color:#111">{}{}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 更新空闲页面计数。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">freePagesCount</span> <span style="color:#f92672">+=</span> <span style="color:#75af00">size</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="node">Node</h2>
<p>page 的操作跟多都是基于磁盘设计的，在内存中使用这些数据结构并不是很方便。所以 boltdb 会把 page 的数据结构转换为 node 的数据结构，这样在内存中操作就会方便很多。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">node</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">bucket</span>     <span style="color:#f92672">*</span><span style="color:#75af00">Bucket</span> <span style="color:#75715e">// bucket 的指针</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">isLeaf</span>     <span style="color:#00a8c8">bool</span> <span style="color:#75715e">// 是否是叶子节点</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">unbalanced</span> <span style="color:#00a8c8">bool</span> <span style="color:#75715e">// 是否平衡</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">spilled</span>    <span style="color:#00a8c8">bool</span> <span style="color:#75715e">// 是否溢出</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">key</span>        <span style="color:#111">[]</span><span style="color:#00a8c8">byte</span> <span style="color:#75715e">// 该 node 的起始 key</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">pgid</span>       <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span> <span style="color:#75715e">// 该 node 对应的 page id</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">parent</span>     <span style="color:#f92672">*</span><span style="color:#75af00">node</span> <span style="color:#75715e">// 父节点</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">children</span>   <span style="color:#75af00">nodes</span> <span style="color:#75715e">// 子节点</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">inodes</span>     <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Inodes</span> <span style="color:#75715e">// 存储键值对的结构体数组</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Inode</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">flags</span> <span style="color:#00a8c8">uint32</span> <span style="color:#75715e">// 用于 leaf node 是否是一个 bucket （subbucket）</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">pgid</span>  <span style="color:#75af00">Pgid</span>	<span style="color:#75715e">// 用于 branch node, 子节点的 page id</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">key</span>   <span style="color:#111">[]</span><span style="color:#00a8c8">byte</span> <span style="color:#75715e">// key</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">value</span> <span style="color:#111">[]</span><span style="color:#00a8c8">byte</span> <span style="color:#75715e">// value</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Inodes</span> <span style="color:#111">[]</span><span style="color:#75af00">Inode</span>
</span></span></code></pre></div><h3 id="page-to-node">page to node</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">n</span> <span style="color:#f92672">*</span><span style="color:#75af00">node</span><span style="color:#111">)</span> <span style="color:#75af00">read</span><span style="color:#111">(</span><span style="color:#75af00">p</span> <span style="color:#f92672">*</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Page</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">pgid</span> <span style="color:#111">=</span> <span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">Id</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">isLeaf</span> <span style="color:#111">=</span> <span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">IsLeafPage</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 读取 inodes</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">inodes</span> <span style="color:#111">=</span> <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">ReadInodeFromPage</span><span style="color:#111">(</span><span style="color:#75af00">p</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 保存第一个键，以便在将节点写入到父节点时能够找到这个节点。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">inodes</span><span style="color:#111">)</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">key</span> <span style="color:#111">=</span> <span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">inodes</span><span style="color:#111">[</span><span style="color:#ae81ff">0</span><span style="color:#111">].</span><span style="color:#75af00">Key</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Assert</span><span style="color:#111">(</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">key</span><span style="color:#111">)</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;read: zero-length node key&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">key</span> <span style="color:#111">=</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">ReadInodeFromPage</span><span style="color:#111">(</span><span style="color:#75af00">p</span> <span style="color:#f92672">*</span><span style="color:#75af00">Page</span><span style="color:#111">)</span> <span style="color:#75af00">Inodes</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">inodes</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#75af00">Inodes</span><span style="color:#111">,</span> <span style="color:#111">int</span><span style="color:#111">(</span><span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">Count</span><span style="color:#111">()))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">isLeaf</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">IsLeafPage</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span><span style="color:#111">;</span> <span style="color:#75af00">i</span> <span style="color:#111">&lt;</span> <span style="color:#111">int</span><span style="color:#111">(</span><span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">Count</span><span style="color:#111">());</span> <span style="color:#75af00">i</span><span style="color:#f92672">++</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">inode</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">inodes</span><span style="color:#111">[</span><span style="color:#75af00">i</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">isLeaf</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 转换为 leafPageElement 结构</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">elem</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">LeafPageElement</span><span style="color:#111">(</span><span style="color:#111">uint16</span><span style="color:#111">(</span><span style="color:#75af00">i</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">inode</span><span style="color:#111">.</span><span style="color:#75af00">SetFlags</span><span style="color:#111">(</span><span style="color:#75af00">elem</span><span style="color:#111">.</span><span style="color:#75af00">Flags</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">inode</span><span style="color:#111">.</span><span style="color:#75af00">SetKey</span><span style="color:#111">(</span><span style="color:#75af00">elem</span><span style="color:#111">.</span><span style="color:#75af00">Key</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">inode</span><span style="color:#111">.</span><span style="color:#75af00">SetValue</span><span style="color:#111">(</span><span style="color:#75af00">elem</span><span style="color:#111">.</span><span style="color:#75af00">Value</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 转换为 branchPageElement 结构</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">elem</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">BranchPageElement</span><span style="color:#111">(</span><span style="color:#111">uint16</span><span style="color:#111">(</span><span style="color:#75af00">i</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">inode</span><span style="color:#111">.</span><span style="color:#75af00">SetPgid</span><span style="color:#111">(</span><span style="color:#75af00">elem</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">inode</span><span style="color:#111">.</span><span style="color:#75af00">SetKey</span><span style="color:#111">(</span><span style="color:#75af00">elem</span><span style="color:#111">.</span><span style="color:#75af00">Key</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">Assert</span><span style="color:#111">(</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">inode</span><span style="color:#111">.</span><span style="color:#75af00">Key</span><span style="color:#111">())</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;read: zero-length inode key&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">inodes</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="node-to-page">node to page</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// write writes the items onto one or more pages.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// The page should have p.id (might be 0 for meta or bucket-inline page) and p.overflow set</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// and the rest should be zeroed.</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">n</span> <span style="color:#f92672">*</span><span style="color:#75af00">node</span><span style="color:#111">)</span> <span style="color:#75af00">write</span><span style="color:#111">(</span><span style="color:#75af00">p</span> <span style="color:#f92672">*</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Page</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Assert</span><span style="color:#111">(</span><span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">Count</span><span style="color:#111">()</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">Flags</span><span style="color:#111">()</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;node cannot be written into a not empty page&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Initialize page.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">isLeaf</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">SetFlags</span><span style="color:#111">(</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">LeafPageFlag</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">SetFlags</span><span style="color:#111">(</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">BranchPageFlag</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">inodes</span><span style="color:#111">)</span> <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0xFFFF</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Sprintf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;inode overflow: %d (pgid=%d)&#34;</span><span style="color:#111">,</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">inodes</span><span style="color:#111">),</span> <span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">Id</span><span style="color:#111">()))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">SetCount</span><span style="color:#111">(</span><span style="color:#111">uint16</span><span style="color:#111">(</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">inodes</span><span style="color:#111">)))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Stop here if there are no items to write.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">Count</span><span style="color:#111">()</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 将node的inodes写入page</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">WriteInodeToPage</span><span style="color:#111">(</span><span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">inodes</span><span style="color:#111">,</span> <span style="color:#75af00">p</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// DEBUG ONLY: n.dump()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">WriteInodeToPage</span><span style="color:#111">(</span><span style="color:#75af00">inodes</span> <span style="color:#75af00">Inodes</span><span style="color:#111">,</span> <span style="color:#75af00">p</span> <span style="color:#f92672">*</span><span style="color:#75af00">Page</span><span style="color:#111">)</span> <span style="color:#00a8c8">uint32</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 计算写入的初始偏移量。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">off</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Sizeof</span><span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">p</span><span style="color:#111">)</span> <span style="color:#f92672">+</span> <span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">PageElementSize</span><span style="color:#111">()</span><span style="color:#f92672">*</span><span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">inodes</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">isLeaf</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">IsLeafPage</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">i</span><span style="color:#111">,</span> <span style="color:#75af00">item</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">inodes</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">Assert</span><span style="color:#111">(</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">item</span><span style="color:#111">.</span><span style="color:#75af00">Key</span><span style="color:#111">())</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;write: zero-length inode key&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 创建一个足够大小的切片来存放键和值。</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">sz</span> <span style="color:#f92672">:=</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">item</span><span style="color:#111">.</span><span style="color:#75af00">Key</span><span style="color:#111">())</span> <span style="color:#f92672">+</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">item</span><span style="color:#111">.</span><span style="color:#75af00">Value</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">b</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">UnsafeByteSlice</span><span style="color:#111">(</span><span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">(</span><span style="color:#75af00">p</span><span style="color:#111">),</span> <span style="color:#75af00">off</span><span style="color:#111">,</span> <span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#75af00">sz</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">off</span> <span style="color:#f92672">+=</span> <span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">sz</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Write the page element.</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">isLeaf</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">elem</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">LeafPageElement</span><span style="color:#111">(</span><span style="color:#111">uint16</span><span style="color:#111">(</span><span style="color:#75af00">i</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">elem</span><span style="color:#111">.</span><span style="color:#75af00">SetPos</span><span style="color:#111">(</span><span style="color:#111">uint32</span><span style="color:#111">(</span><span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">b</span><span style="color:#111">[</span><span style="color:#ae81ff">0</span><span style="color:#111">]))</span> <span style="color:#f92672">-</span> <span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">(</span><span style="color:#75af00">elem</span><span style="color:#111">))))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">elem</span><span style="color:#111">.</span><span style="color:#75af00">SetFlags</span><span style="color:#111">(</span><span style="color:#75af00">item</span><span style="color:#111">.</span><span style="color:#75af00">Flags</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">elem</span><span style="color:#111">.</span><span style="color:#75af00">SetKsize</span><span style="color:#111">(</span><span style="color:#111">uint32</span><span style="color:#111">(</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">item</span><span style="color:#111">.</span><span style="color:#75af00">Key</span><span style="color:#111">())))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">elem</span><span style="color:#111">.</span><span style="color:#75af00">SetVsize</span><span style="color:#111">(</span><span style="color:#111">uint32</span><span style="color:#111">(</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">item</span><span style="color:#111">.</span><span style="color:#75af00">Value</span><span style="color:#111">())))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">elem</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">BranchPageElement</span><span style="color:#111">(</span><span style="color:#111">uint16</span><span style="color:#111">(</span><span style="color:#75af00">i</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">elem</span><span style="color:#111">.</span><span style="color:#75af00">SetPos</span><span style="color:#111">(</span><span style="color:#111">uint32</span><span style="color:#111">(</span><span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">b</span><span style="color:#111">[</span><span style="color:#ae81ff">0</span><span style="color:#111">]))</span> <span style="color:#f92672">-</span> <span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">(</span><span style="color:#75af00">elem</span><span style="color:#111">))))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">elem</span><span style="color:#111">.</span><span style="color:#75af00">SetKsize</span><span style="color:#111">(</span><span style="color:#111">uint32</span><span style="color:#111">(</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">item</span><span style="color:#111">.</span><span style="color:#75af00">Key</span><span style="color:#111">())))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">elem</span><span style="color:#111">.</span><span style="color:#75af00">SetPgid</span><span style="color:#111">(</span><span style="color:#75af00">item</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">Assert</span><span style="color:#111">(</span><span style="color:#75af00">elem</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">()</span> <span style="color:#f92672">!=</span> <span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">Id</span><span style="color:#111">(),</span> <span style="color:#d88200">&#34;write: circular dependency occurred&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 将键和值数据写入到页面的末尾。</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">l</span> <span style="color:#f92672">:=</span> <span style="color:#111">copy</span><span style="color:#111">(</span><span style="color:#75af00">b</span><span style="color:#111">,</span> <span style="color:#75af00">item</span><span style="color:#111">.</span><span style="color:#75af00">Key</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">copy</span><span style="color:#111">(</span><span style="color:#75af00">b</span><span style="color:#111">[</span><span style="color:#75af00">l</span><span style="color:#111">:],</span> <span style="color:#75af00">item</span><span style="color:#111">.</span><span style="color:#75af00">Value</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#111">uint32</span><span style="color:#111">(</span><span style="color:#75af00">off</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="bucket">Bucket</h2>
<p>Bucket 是 boltdb 的上层的数据结构，每个 bucket 都有一个完成的 B+ 树。将多个 page 联合起来。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Bucket</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">*</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">InBucket</span>             
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">tx</span>       <span style="color:#f92672">*</span><span style="color:#75af00">Tx</span>                    <span style="color:#75715e">// 指向关联事务的指针，将 bucket 与其事务上下文连接。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">buckets</span>  <span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#00a8c8">string</span><span style="color:#111">]</span><span style="color:#f92672">*</span><span style="color:#75af00">Bucket</span>     <span style="color:#75715e">// 子 bucket 缓存；允许通过名字快速访问子 bucket。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">page</span>     <span style="color:#f92672">*</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Page</span>           <span style="color:#75715e">// 内联页面的引用，用于直接存储少量数据或作为数据节点的入口点。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">rootNode</span> <span style="color:#f92672">*</span><span style="color:#75af00">node</span>                  <span style="color:#75715e">// 根页面的已实例化节点，如果 bucket 直接存储在内存中，则此节点将被激活。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">nodes</span>    <span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">]</span><span style="color:#f92672">*</span><span style="color:#75af00">node</span>  <span style="color:#75715e">// 节点缓存，用于快速访问已加载的页面节点，避免重复读取磁盘。</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 设置节点分裂时的填充阈值。默认情况下，bucket 将填充至 50%，</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 但如果你知道你的写入工作负载主要是追加操作，提高这个比例可能会有用。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    // 这个设置不会跨事务持久化，因此每个事务都必须设置它。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">FillPercent</span> <span style="color:#00a8c8">float64</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">InBucket</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">root</span>     <span style="color:#75af00">Pgid</span>   <span style="color:#75715e">// bucket 根级页面的页面ID。如果 bucket 是内联的，则此值为 0。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">sequence</span> <span style="color:#00a8c8">uint64</span> <span style="color:#75715e">// 单调递增的序列号，用于 NextSequence() 函数。</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>Bucket 有可能是 node，也可能是 page。查找某页面的键值对时，首先检查 Bucket.nodes 缓存是否有对应的 node，如果没有，再从 page 中查找。
Bucket.FillPercent 记录 node 的填充百分比。当 node 的已用空间超过其容量的某个百分比后，节点必须分裂，以减少在 B+ Tree 中插入键值对时触发再平衡的概率。默认值是 50%，仅当大量写入操作在尾部添加时，增大该值才有帮助。</p>
<p>bucket 存储方式：</p>
<p><img src="/images/04c8dda1-ff6f-4ae5-9162-bf31819e9a9c.png" alt=""></p>
<h3 id="遍历-cursor">遍历 cursor</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Cursor</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">bucket</span> <span style="color:#f92672">*</span><span style="color:#75af00">Bucket</span>  
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">stack</span>  <span style="color:#111">[]</span><span style="color:#75af00">elemRef</span> 
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">elemRef</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">page</span>  <span style="color:#f92672">*</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Page</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">node</span>  <span style="color:#f92672">*</span><span style="color:#75af00">node</span>        
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">index</span> <span style="color:#00a8c8">int</span>    
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>cursor 分为三类，定位到某一个元素的位置、在当前位置从前往后找、在当前位置从后往前找。方法为：First、Last、Next、Prev 等。</p>
<h4 id="seek">Seek</h4>
<p>如果该键存在，它会返回该键及其对应的值；如果键不存在，它则返回最近的后续键。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// Seek 方法使用B树搜索将光标移动到给定的键并返回它。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 如果键不存在，则使用下一个键。如果没有更多的键，返回nil。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 返回的键和值只在事务的生命周期内有效。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">Cursor</span><span style="color:#111">)</span> <span style="color:#75af00">Seek</span><span style="color:#111">(</span><span style="color:#75af00">seek</span> <span style="color:#111">[]</span><span style="color:#00a8c8">byte</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#75af00">key</span> <span style="color:#111">[]</span><span style="color:#00a8c8">byte</span><span style="color:#111">,</span> <span style="color:#75af00">value</span> <span style="color:#111">[]</span><span style="color:#00a8c8">byte</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 确保数据库事务没有关闭</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Assert</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">bucket</span><span style="color:#111">.</span><span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">db</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;tx closed&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 调用内部的seek方法，获取键和值</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">k</span><span style="color:#111">,</span> <span style="color:#75af00">v</span><span style="color:#111">,</span> <span style="color:#75af00">flags</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">seek</span><span style="color:#111">(</span><span style="color:#75af00">seek</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 检查是否位于页面的最后一个元素之后，如果是，则移动到下一个元素。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">ref</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">stack</span><span style="color:#111">[</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">stack</span><span style="color:#111">)</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">];</span> <span style="color:#75af00">ref</span><span style="color:#111">.</span><span style="color:#75af00">index</span> <span style="color:#f92672">&gt;=</span> <span style="color:#75af00">ref</span><span style="color:#111">.</span><span style="color:#75af00">count</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">k</span><span style="color:#111">,</span> <span style="color:#75af00">v</span><span style="color:#111">,</span> <span style="color:#75af00">flags</span> <span style="color:#111">=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">next</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 如果k为nil，表示未找到键，返回nil。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">k</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#00a8c8">if</span> <span style="color:#111">(</span><span style="color:#75af00">flags</span> <span style="color:#f92672">&amp;</span> <span style="color:#111">uint32</span><span style="color:#111">(</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">BucketLeafFlag</span><span style="color:#111">))</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 如果是叶子节点，返回键和nil值。</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">k</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 返回找到的键和值。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#75af00">k</span><span style="color:#111">,</span> <span style="color:#75af00">v</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// seek 方法将光标移动到给定的键，并返回该键。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 如果键不存在，则使用下一个键。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">Cursor</span><span style="color:#111">)</span> <span style="color:#75af00">seek</span><span style="color:#111">(</span><span style="color:#75af00">seek</span> <span style="color:#111">[]</span><span style="color:#00a8c8">byte</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#75af00">key</span> <span style="color:#111">[]</span><span style="color:#00a8c8">byte</span><span style="color:#111">,</span> <span style="color:#75af00">value</span> <span style="color:#111">[]</span><span style="color:#00a8c8">byte</span><span style="color:#111">,</span> <span style="color:#75af00">flags</span> <span style="color:#00a8c8">uint32</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 从根页面/节点开始，遍历到正确的页面。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">stack</span> <span style="color:#111">=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">stack</span><span style="color:#111">[:</span><span style="color:#ae81ff">0</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">search</span><span style="color:#111">(</span><span style="color:#75af00">seek</span><span style="color:#111">,</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">bucket</span><span style="color:#111">.</span><span style="color:#75af00">RootPage</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 如果是桶，则返回nil值。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">keyValue</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>search</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// search 方法递归地对给定的页面/节点进行二分搜索，直到找到给定的键。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">Cursor</span><span style="color:#111">)</span> <span style="color:#75af00">search</span><span style="color:#111">(</span><span style="color:#75af00">key</span> <span style="color:#111">[]</span><span style="color:#00a8c8">byte</span><span style="color:#111">,</span> <span style="color:#75af00">pgId</span> <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">p</span><span style="color:#111">,</span> <span style="color:#75af00">n</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">bucket</span><span style="color:#111">.</span><span style="color:#75af00">pageNode</span><span style="color:#111">(</span><span style="color:#75af00">pgId</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">p</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#111">!</span><span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">IsBranchPage</span><span style="color:#111">()</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#111">!</span><span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">IsLeafPage</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Sprintf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;invalid page type: %d: %x&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">Id</span><span style="color:#111">(),</span> <span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">Flags</span><span style="color:#111">()))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">e</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">elemRef</span><span style="color:#111">{</span><span style="color:#75af00">page</span><span style="color:#111">:</span> <span style="color:#75af00">p</span><span style="color:#111">,</span> <span style="color:#75af00">node</span><span style="color:#111">:</span> <span style="color:#75af00">n</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">stack</span> <span style="color:#111">=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">stack</span><span style="color:#111">,</span> <span style="color:#75af00">e</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 如果我们位于叶节点页面上，则在该页面内部继续查找特定节点。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">isLeaf</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">nsearch</span><span style="color:#111">(</span><span style="color:#75af00">key</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 如果是节点，继续在节点内部搜索。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">n</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">searchNode</span><span style="color:#111">(</span><span style="color:#75af00">key</span><span style="color:#111">,</span> <span style="color:#75af00">n</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 如果是页面，继续在页面内部搜索。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">searchPage</span><span style="color:#111">(</span><span style="color:#75af00">key</span><span style="color:#111">,</span> <span style="color:#75af00">p</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">Cursor</span><span style="color:#111">)</span> <span style="color:#75af00">searchNode</span><span style="color:#111">(</span><span style="color:#75af00">key</span> <span style="color:#111">[]</span><span style="color:#00a8c8">byte</span><span style="color:#111">,</span> <span style="color:#75af00">n</span> <span style="color:#f92672">*</span><span style="color:#75af00">node</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">var</span> <span style="color:#75af00">exact</span> <span style="color:#00a8c8">bool</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 使用二分搜索确定键的位置。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">index</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">sort</span><span style="color:#111">.</span><span style="color:#75af00">Search</span><span style="color:#111">(</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">inodes</span><span style="color:#111">),</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">i</span> <span style="color:#00a8c8">int</span><span style="color:#111">)</span> <span style="color:#00a8c8">bool</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">ret</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">bytes</span><span style="color:#111">.</span><span style="color:#75af00">Compare</span><span style="color:#111">(</span><span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">inodes</span><span style="color:#111">[</span><span style="color:#75af00">i</span><span style="color:#111">].</span><span style="color:#75af00">Key</span><span style="color:#111">(),</span> <span style="color:#75af00">key</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#75af00">ret</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75af00">exact</span> <span style="color:#111">=</span> <span style="color:#00a8c8">true</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">ret</span> <span style="color:#f92672">!=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">exact</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">index</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">index</span><span style="color:#f92672">--</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">stack</span><span style="color:#111">[</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">stack</span><span style="color:#111">)</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">].</span><span style="color:#75af00">index</span> <span style="color:#111">=</span> <span style="color:#75af00">index</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 递归搜索到下一页。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">search</span><span style="color:#111">(</span><span style="color:#75af00">key</span><span style="color:#111">,</span> <span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">inodes</span><span style="color:#111">[</span><span style="color:#75af00">index</span><span style="color:#111">].</span><span style="color:#75af00">Pgid</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">Cursor</span><span style="color:#111">)</span> <span style="color:#75af00">searchPage</span><span style="color:#111">(</span><span style="color:#75af00">key</span> <span style="color:#111">[]</span><span style="color:#00a8c8">byte</span><span style="color:#111">,</span> <span style="color:#75af00">p</span> <span style="color:#f92672">*</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Page</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 对页面进行二分搜索以确定正确的范围。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">inodes</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">BranchPageElements</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">var</span> <span style="color:#75af00">exact</span> <span style="color:#00a8c8">bool</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">index</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">sort</span><span style="color:#111">.</span><span style="color:#75af00">Search</span><span style="color:#111">(</span><span style="color:#111">int</span><span style="color:#111">(</span><span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">Count</span><span style="color:#111">()),</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">i</span> <span style="color:#00a8c8">int</span><span style="color:#111">)</span> <span style="color:#00a8c8">bool</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">ret</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">bytes</span><span style="color:#111">.</span><span style="color:#75af00">Compare</span><span style="color:#111">(</span><span style="color:#75af00">inodes</span><span style="color:#111">[</span><span style="color:#75af00">i</span><span style="color:#111">].</span><span style="color:#75af00">Key</span><span style="color:#111">(),</span> <span style="color:#75af00">key</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#75af00">ret</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75af00">exact</span> <span style="color:#111">=</span> <span style="color:#00a8c8">true</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">ret</span> <span style="color:#f92672">!=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">exact</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">index</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">index</span><span style="color:#f92672">--</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">stack</span><span style="color:#111">[</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">stack</span><span style="color:#111">)</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">].</span><span style="color:#75af00">index</span> <span style="color:#111">=</span> <span style="color:#75af00">index</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 递归搜索到下一页。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">search</span><span style="color:#111">(</span><span style="color:#75af00">key</span><span style="color:#111">,</span> <span style="color:#75af00">inodes</span><span style="color:#111">[</span><span style="color:#75af00">index</span><span style="color:#111">].</span><span style="color:#75af00">Pgid</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">Cursor</span><span style="color:#111">)</span> <span style="color:#75af00">nsearch</span><span style="color:#111">(</span><span style="color:#75af00">key</span> <span style="color:#111">[]</span><span style="color:#00a8c8">byte</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">e</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">stack</span><span style="color:#111">[</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">stack</span><span style="color:#111">)</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">p</span><span style="color:#111">,</span> <span style="color:#75af00">n</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">page</span><span style="color:#111">,</span> <span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">node</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// If we have a node then search its inodes.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">n</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">index</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">sort</span><span style="color:#111">.</span><span style="color:#75af00">Search</span><span style="color:#111">(</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">inodes</span><span style="color:#111">),</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">i</span> <span style="color:#00a8c8">int</span><span style="color:#111">)</span> <span style="color:#00a8c8">bool</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#75af00">bytes</span><span style="color:#111">.</span><span style="color:#75af00">Compare</span><span style="color:#111">(</span><span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">inodes</span><span style="color:#111">[</span><span style="color:#75af00">i</span><span style="color:#111">].</span><span style="color:#75af00">Key</span><span style="color:#111">(),</span> <span style="color:#75af00">key</span><span style="color:#111">)</span> <span style="color:#f92672">!=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">index</span> <span style="color:#111">=</span> <span style="color:#75af00">index</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// If we have a page then search its leaf elements.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">inodes</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">LeafPageElements</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">index</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">sort</span><span style="color:#111">.</span><span style="color:#75af00">Search</span><span style="color:#111">(</span><span style="color:#111">int</span><span style="color:#111">(</span><span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">Count</span><span style="color:#111">()),</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">i</span> <span style="color:#00a8c8">int</span><span style="color:#111">)</span> <span style="color:#00a8c8">bool</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">bytes</span><span style="color:#111">.</span><span style="color:#75af00">Compare</span><span style="color:#111">(</span><span style="color:#75af00">inodes</span><span style="color:#111">[</span><span style="color:#75af00">i</span><span style="color:#111">].</span><span style="color:#75af00">Key</span><span style="color:#111">(),</span> <span style="color:#75af00">key</span><span style="color:#111">)</span> <span style="color:#f92672">!=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">index</span> <span style="color:#111">=</span> <span style="color:#75af00">index</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>keyValue</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">Cursor</span><span style="color:#111">)</span> <span style="color:#75af00">keyValue</span><span style="color:#111">()</span> <span style="color:#111">([]</span><span style="color:#00a8c8">byte</span><span style="color:#111">,</span> <span style="color:#111">[]</span><span style="color:#00a8c8">byte</span><span style="color:#111">,</span> <span style="color:#00a8c8">uint32</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ref</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">stack</span><span style="color:#111">[</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">stack</span><span style="color:#111">)</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 如果索引超出范围，则返回nil。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">ref</span><span style="color:#111">.</span><span style="color:#75af00">count</span><span style="color:#111">()</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">||</span> <span style="color:#75af00">ref</span><span style="color:#111">.</span><span style="color:#75af00">index</span> <span style="color:#f92672">&gt;=</span> <span style="color:#75af00">ref</span><span style="color:#111">.</span><span style="color:#75af00">count</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//  从node中获取键值对。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">ref</span><span style="color:#111">.</span><span style="color:#75af00">node</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">inode</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">ref</span><span style="color:#111">.</span><span style="color:#75af00">node</span><span style="color:#111">.</span><span style="color:#75af00">inodes</span><span style="color:#111">[</span><span style="color:#75af00">ref</span><span style="color:#111">.</span><span style="color:#75af00">index</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">inode</span><span style="color:#111">.</span><span style="color:#75af00">Key</span><span style="color:#111">(),</span> <span style="color:#75af00">inode</span><span style="color:#111">.</span><span style="color:#75af00">Value</span><span style="color:#111">(),</span> <span style="color:#75af00">inode</span><span style="color:#111">.</span><span style="color:#75af00">Flags</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 从 page 中获取键值对。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">elem</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">ref</span><span style="color:#111">.</span><span style="color:#75af00">page</span><span style="color:#111">.</span><span style="color:#75af00">LeafPageElement</span><span style="color:#111">(</span><span style="color:#111">uint16</span><span style="color:#111">(</span><span style="color:#75af00">ref</span><span style="color:#111">.</span><span style="color:#75af00">index</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">elem</span><span style="color:#111">.</span><span style="color:#75af00">Key</span><span style="color:#111">(),</span> <span style="color:#75af00">elem</span><span style="color:#111">.</span><span style="color:#75af00">Value</span><span style="color:#111">(),</span> <span style="color:#75af00">elem</span><span style="color:#111">.</span><span style="color:#75af00">Flags</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="创建-bucket-如果不存在">创建 bucket 如果不存在</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// CreateBucketIfNotExists 如果指定的存储桶不存在，则创建它，并返回一个对它的引用。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 如果存储桶名为空或太长，则返回错误。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 存储桶实例仅在事务的生命周期内有效。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">b</span> <span style="color:#f92672">*</span><span style="color:#75af00">Bucket</span><span style="color:#111">)</span> <span style="color:#75af00">CreateBucketIfNotExists</span><span style="color:#111">(</span><span style="color:#75af00">key</span> <span style="color:#111">[]</span><span style="color:#00a8c8">byte</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#75af00">rb</span> <span style="color:#f92672">*</span><span style="color:#75af00">Bucket</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 如果日志不是被丢弃，记录创建存储桶的尝试。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">lg</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">Logger</span><span style="color:#111">();</span> <span style="color:#75af00">lg</span> <span style="color:#f92672">!=</span> <span style="color:#75af00">discardLogger</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">lg</span><span style="color:#111">.</span><span style="color:#75af00">Debugf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Creating bucket if not exist %q&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">key</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">defer</span> <span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75af00">lg</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Creating bucket if not exist %q failed: %v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">key</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75af00">lg</span><span style="color:#111">.</span><span style="color:#75af00">Debugf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Creating bucket if not exist %q successfully&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">key</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 检查数据库是否关闭，检查事务是否可写，检查键名是否为空。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">db</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">errors</span><span style="color:#111">.</span><span style="color:#75af00">ErrTxClosed</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">writable</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">errors</span><span style="color:#111">.</span><span style="color:#75af00">ErrTxNotWritable</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#00a8c8">if</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">key</span><span style="color:#111">)</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">errors</span><span style="color:#111">.</span><span style="color:#75af00">ErrBucketNameRequired</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 使用克隆的键而不是原始键，以避免内存泄漏。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">newKey</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">cloneBytes</span><span style="color:#111">(</span><span style="color:#75af00">key</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 检查键是否已存在。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">buckets</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#75af00">child</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">buckets</span><span style="color:#111">[</span><span style="color:#111">string</span><span style="color:#111">(</span><span style="color:#75af00">newKey</span><span style="color:#111">)];</span> <span style="color:#75af00">child</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">return</span> <span style="color:#75af00">child</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 使用光标寻找正确的位置。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">c</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">Cursor</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">k</span><span style="color:#111">,</span> <span style="color:#75af00">v</span><span style="color:#111">,</span> <span style="color:#75af00">flags</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">seek</span><span style="color:#111">(</span><span style="color:#75af00">newKey</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 如果找到的键相同，检查是否已有相同名字的非存储桶键。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">bytes</span><span style="color:#111">.</span><span style="color:#75af00">Equal</span><span style="color:#111">(</span><span style="color:#75af00">newKey</span><span style="color:#111">,</span> <span style="color:#75af00">k</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#111">(</span><span style="color:#75af00">flags</span> <span style="color:#f92672">&amp;</span> <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">BucketLeafFlag</span><span style="color:#111">)</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">var</span> <span style="color:#75af00">child</span> <span style="color:#111">=</span> <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">openBucket</span><span style="color:#111">(</span><span style="color:#75af00">v</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">if</span> <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">buckets</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">buckets</span><span style="color:#111">[</span><span style="color:#111">string</span><span style="color:#111">(</span><span style="color:#75af00">newKey</span><span style="color:#111">)]</span> <span style="color:#111">=</span> <span style="color:#75af00">child</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">return</span> <span style="color:#75af00">child</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">errors</span><span style="color:#111">.</span><span style="color:#75af00">ErrIncompatibleValue</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 创建空的内联存储桶。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">var</span> <span style="color:#75af00">bucket</span> <span style="color:#111">=</span> <span style="color:#75af00">Bucket</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">InBucket</span><span style="color:#111">:</span>    <span style="color:#f92672">&amp;</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">InBucket</span><span style="color:#111">{},</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">rootNode</span><span style="color:#111">:</span>    <span style="color:#f92672">&amp;</span><span style="color:#75af00">node</span><span style="color:#111">{</span><span style="color:#75af00">isLeaf</span><span style="color:#111">:</span> <span style="color:#00a8c8">true</span><span style="color:#111">},</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">FillPercent</span><span style="color:#111">:</span> <span style="color:#75af00">DefaultFillPercent</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">var</span> <span style="color:#75af00">value</span> <span style="color:#111">=</span> <span style="color:#75af00">bucket</span><span style="color:#111">.</span><span style="color:#75af00">write</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 在当前节点上插入键、值、标志。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">node</span><span style="color:#111">().</span><span style="color:#75af00">put</span><span style="color:#111">(</span><span style="color:#75af00">newKey</span><span style="color:#111">,</span> <span style="color:#75af00">newKey</span><span style="color:#111">,</span> <span style="color:#75af00">value</span><span style="color:#111">,</span> <span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">BucketLeafFlag</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 如果存在内联页面，取消引用它，使得存储桶被视为常规非内联存储桶。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">page</span> <span style="color:#111">=</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 返回新创建的存储桶。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">Bucket</span><span style="color:#111">(</span><span style="color:#75af00">newKey</span><span style="color:#111">),</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// node方法返回光标当前定位的节点。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">Cursor</span><span style="color:#111">)</span> <span style="color:#75af00">node</span><span style="color:#111">()</span> <span style="color:#f92672">*</span><span style="color:#75af00">node</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 确保光标栈长度大于0，否则抛出异常。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Assert</span><span style="color:#111">(</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">stack</span><span style="color:#111">)</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;accessing a node with a zero-length cursor stack&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 如果栈顶是叶子节点，直接返回该节点。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">ref</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">stack</span><span style="color:#111">[</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">stack</span><span style="color:#111">)</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">];</span> <span style="color:#75af00">ref</span><span style="color:#111">.</span><span style="color:#75af00">node</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">ref</span><span style="color:#111">.</span><span style="color:#75af00">isLeaf</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">ref</span><span style="color:#111">.</span><span style="color:#75af00">node</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 从根开始，向下遍历层级结构。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">var</span> <span style="color:#75af00">n</span> <span style="color:#111">=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">stack</span><span style="color:#111">[</span><span style="color:#ae81ff">0</span><span style="color:#111">].</span><span style="color:#75af00">node</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">n</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">n</span> <span style="color:#111">=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">bucket</span><span style="color:#111">.</span><span style="color:#75af00">node</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">stack</span><span style="color:#111">[</span><span style="color:#ae81ff">0</span><span style="color:#111">].</span><span style="color:#75af00">page</span><span style="color:#111">.</span><span style="color:#75af00">Id</span><span style="color:#111">(),</span> <span style="color:#00a8c8">nil</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">ref</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">stack</span><span style="color:#111">[:</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">stack</span><span style="color:#111">)</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">]</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Assert</span><span style="color:#111">(!</span><span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">isLeaf</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;expected branch node&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">n</span> <span style="color:#111">=</span> <span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">childAt</span><span style="color:#111">(</span><span style="color:#75af00">ref</span><span style="color:#111">.</span><span style="color:#75af00">index</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Assert</span><span style="color:#111">(</span><span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">isLeaf</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;expected leaf node&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#75af00">n</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// put方法在节点中插入键值对。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">n</span> <span style="color:#f92672">*</span><span style="color:#75af00">node</span><span style="color:#111">)</span> <span style="color:#75af00">put</span><span style="color:#111">(</span><span style="color:#75af00">oldKey</span><span style="color:#111">,</span> <span style="color:#75af00">newKey</span><span style="color:#111">,</span> <span style="color:#75af00">value</span> <span style="color:#111">[]</span><span style="color:#00a8c8">byte</span><span style="color:#111">,</span> <span style="color:#75af00">pgId</span> <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">,</span> <span style="color:#75af00">flags</span> <span style="color:#00a8c8">uint32</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 检查pgId是否超出限制。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">pgId</span> <span style="color:#f92672">&gt;=</span> <span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">bucket</span><span style="color:#111">.</span><span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">meta</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Sprintf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;pgId (%d) above high water mark (%d)&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">pgId</span><span style="color:#111">,</span> <span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">bucket</span><span style="color:#111">.</span><span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">meta</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">()))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#00a8c8">if</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">oldKey</span><span style="color:#111">)</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#d88200">&#34;put: zero-length old key&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#00a8c8">if</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">newKey</span><span style="color:#111">)</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#d88200">&#34;put: zero-length new key&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 寻找插入的位置。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">index</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">sort</span><span style="color:#111">.</span><span style="color:#75af00">Search</span><span style="color:#111">(</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">inodes</span><span style="color:#111">),</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">i</span> <span style="color:#00a8c8">int</span><span style="color:#111">)</span> <span style="color:#00a8c8">bool</span> <span style="color:#111">{</span> <span style="color:#00a8c8">return</span> <span style="color:#75af00">bytes</span><span style="color:#111">.</span><span style="color:#75af00">Compare</span><span style="color:#111">(</span><span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">inodes</span><span style="color:#111">[</span><span style="color:#75af00">i</span><span style="color:#111">].</span><span style="color:#75af00">Key</span><span style="color:#111">(),</span> <span style="color:#75af00">oldKey</span><span style="color:#111">)</span> <span style="color:#f92672">!=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> <span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 如果没有找到确切匹配，增加容量并移动节点。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">exact</span> <span style="color:#f92672">:=</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">inodes</span><span style="color:#111">)</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">index</span> <span style="color:#111">&lt;</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">inodes</span><span style="color:#111">)</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">bytes</span><span style="color:#111">.</span><span style="color:#75af00">Equal</span><span style="color:#111">(</span><span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">inodes</span><span style="color:#111">[</span><span style="color:#75af00">index</span><span style="color:#111">].</span><span style="color:#75af00">Key</span><span style="color:#111">(),</span> <span style="color:#75af00">oldKey</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">exact</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">inodes</span> <span style="color:#111">=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">inodes</span><span style="color:#111">,</span> <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Inode</span><span style="color:#111">{})</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">copy</span><span style="color:#111">(</span><span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">inodes</span><span style="color:#111">[</span><span style="color:#75af00">index</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span><span style="color:#111">:],</span> <span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">inodes</span><span style="color:#111">[</span><span style="color:#75af00">index</span><span style="color:#111">:])</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 设置inode的属性。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">inode</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">inodes</span><span style="color:#111">[</span><span style="color:#75af00">index</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">inode</span><span style="color:#111">.</span><span style="color:#75af00">SetFlags</span><span style="color:#111">(</span><span style="color:#75af00">flags</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">inode</span><span style="color:#111">.</span><span style="color:#75af00">SetKey</span><span style="color:#111">(</span><span style="color:#75af00">newKey</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">inode</span><span style="color:#111">.</span><span style="color:#75af00">SetValue</span><span style="color:#111">(</span><span style="color:#75af00">value</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">inode</span><span style="color:#111">.</span><span style="color:#75af00">SetPgid</span><span style="color:#111">(</span><span style="color:#75af00">pgId</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Assert</span><span style="color:#111">(</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">inode</span><span style="color:#111">.</span><span style="color:#75af00">Key</span><span style="color:#111">())</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;put: zero-length inode key&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Bucket方法通过名称检索嵌套桶。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 如果桶不存在，返回nil。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 返回的桶实例只在事务生命周期内有效。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">b</span> <span style="color:#f92672">*</span><span style="color:#75af00">Bucket</span><span style="color:#111">)</span> <span style="color:#75af00">Bucket</span><span style="color:#111">(</span><span style="color:#75af00">name</span> <span style="color:#111">[]</span><span style="color:#00a8c8">byte</span><span style="color:#111">)</span> <span style="color:#f92672">*</span><span style="color:#75af00">Bucket</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 如果已有桶缓存，则直接返回对应桶。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">buckets</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#75af00">child</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">buckets</span><span style="color:#111">[</span><span style="color:#111">string</span><span style="color:#111">(</span><span style="color:#75af00">name</span><span style="color:#111">)];</span> <span style="color:#75af00">child</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">return</span> <span style="color:#75af00">child</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 移动光标到键位置。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">c</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">Cursor</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">k</span><span style="color:#111">,</span> <span style="color:#75af00">v</span><span style="color:#111">,</span> <span style="color:#75af00">flags</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">seek</span><span style="color:#111">(</span><span style="color:#75af00">name</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 如果键不存在或者不是桶标志，则返回nil。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">bytes</span><span style="color:#111">.</span><span style="color:#75af00">Equal</span><span style="color:#111">(</span><span style="color:#75af00">name</span><span style="color:#111">,</span> <span style="color:#75af00">k</span><span style="color:#111">)</span> <span style="color:#f92672">||</span> <span style="color:#111">(</span><span style="color:#75af00">flags</span> <span style="color:#f92672">&amp;</span> <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">BucketLeafFlag</span><span style="color:#111">)</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 否则创建并缓存桶。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">var</span> <span style="color:#75af00">child</span> <span style="color:#111">=</span> <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">openBucket</span><span style="color:#111">(</span><span style="color:#75af00">v</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">buckets</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">buckets</span><span style="color:#111">[</span><span style="color:#111">string</span><span style="color:#111">(</span><span style="color:#75af00">name</span><span style="color:#111">)]</span> <span style="color:#111">=</span> <span style="color:#75af00">child</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#75af00">child</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="插入-keyvalue">插入 key/value</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">b</span> <span style="color:#f92672">*</span><span style="color:#75af00">Bucket</span><span style="color:#111">)</span> <span style="color:#75af00">Put</span><span style="color:#111">(</span><span style="color:#75af00">key</span> <span style="color:#111">[]</span><span style="color:#00a8c8">byte</span><span style="color:#111">,</span> <span style="color:#75af00">value</span> <span style="color:#111">[]</span><span style="color:#00a8c8">byte</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">lg</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">Logger</span><span style="color:#111">();</span> <span style="color:#75af00">lg</span> <span style="color:#f92672">!=</span> <span style="color:#75af00">discardLogger</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">lg</span><span style="color:#111">.</span><span style="color:#75af00">Debugf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Putting key %q&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">key</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">defer</span> <span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">lg</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Putting key %q failed: %v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">key</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">lg</span><span style="color:#111">.</span><span style="color:#75af00">Debugf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Putting key %q successfully&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">key</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">db</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">errors</span><span style="color:#111">.</span><span style="color:#75af00">ErrTxClosed</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">Writable</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">errors</span><span style="color:#111">.</span><span style="color:#75af00">ErrTxNotWritable</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#00a8c8">if</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">key</span><span style="color:#111">)</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">errors</span><span style="color:#111">.</span><span style="color:#75af00">ErrKeyRequired</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#00a8c8">if</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">key</span><span style="color:#111">)</span> <span style="color:#111">&gt;</span> <span style="color:#75af00">MaxKeySize</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">errors</span><span style="color:#111">.</span><span style="color:#75af00">ErrKeyTooLarge</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#00a8c8">if</span> <span style="color:#111">int64</span><span style="color:#111">(</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">value</span><span style="color:#111">))</span> <span style="color:#111">&gt;</span> <span style="color:#75af00">MaxValueSize</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">errors</span><span style="color:#111">.</span><span style="color:#75af00">ErrValueTooLarge</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">newKey</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">cloneBytes</span><span style="color:#111">(</span><span style="color:#75af00">key</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 移动光标到键位置。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">c</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">Cursor</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">k</span><span style="color:#111">,</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">flags</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">seek</span><span style="color:#111">(</span><span style="color:#75af00">newKey</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Return an error if there is an existing key with a bucket value.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">bytes</span><span style="color:#111">.</span><span style="color:#75af00">Equal</span><span style="color:#111">(</span><span style="color:#75af00">newKey</span><span style="color:#111">,</span> <span style="color:#75af00">k</span><span style="color:#111">)</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#111">(</span><span style="color:#75af00">flags</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">BucketLeafFlag</span><span style="color:#111">)</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">errors</span><span style="color:#111">.</span><span style="color:#75af00">ErrIncompatibleValue</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// gofail: var beforeBucketPut struct{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">node</span><span style="color:#111">().</span><span style="color:#75af00">put</span><span style="color:#111">(</span><span style="color:#75af00">newKey</span><span style="color:#111">,</span> <span style="color:#75af00">newKey</span><span style="color:#111">,</span> <span style="color:#75af00">value</span><span style="color:#111">,</span> <span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#ae81ff">0</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="事务">事务</h2>
<p>BoltDB 支持 ACID 事务，并采用了使用读写锁机制，支持多个读操作与一个写操作并发执行，让应用程序可以更简单的处理复杂操作。每个事务都有一个 txid，其中db.meta.txid 保存了最大的已提交的写事务 id。BoltDB 对写事务和读事务执行不同的 id 分配策略：</p>
<ol>
<li>读事务：txid == db.meta.txid；</li>
<li>写事务：txid == db.meta.txid + 1；</li>
<li>当写事务成功提交时，会更新了db.meta.txid为当前写事务 id。</li>
</ol>
<p>数据库初始化时会将页号为 0 和 1 的两个页面设置为meta页，每个事务会获得一个txid，并选取txid % 2的meta页做为该事务的读取对象，每次写数据后会交替更新meta页。当其中一个出现数据校验不一致时会使用另一个meta页。
BoltDB 的写操作都是在内存中进行，若事务未 commit 时出错，不会对数据库造成影响；若是在 commit 的过程中出错，BoltDB 写入文件的顺序也保证了不会造成影响：因为数据会写在新的 page 中不会覆盖原来的数据，且此时 meta中的信息不发生变化。</p>
<ol>
<li>开始一份写事务时，会拷贝一份 meta数据；</li>
<li>从 rootBucket 开始，遍历 B+ Tree 查找数据位置并修改；</li>
<li>修改操作完成后会进行事务 commit，此时会将数据写入新的 page；</li>
<li>最后更新meta的信息。</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// Tx 代表数据库上的一个只读或读写事务。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 只读事务可用于检索键值和创建光标。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 读写事务可以创建和删除桶以及创建和删除键。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// 重要：必须在使用完事务后提交或回滚事务。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 只有当没有事务在使用页面时，写入者才能回收这些页面。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 长时间运行的读事务可能会导致数据库迅速增长。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Tx</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">writable</span>       <span style="color:#00a8c8">bool</span>           <span style="color:#75715e">// 是否为可写事务</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">managed</span>        <span style="color:#00a8c8">bool</span>           <span style="color:#75715e">// 是否为管理事务</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">db</span>             <span style="color:#f92672">*</span><span style="color:#75af00">DB</span>            <span style="color:#75715e">// 关联的数据库实例</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">meta</span>           <span style="color:#f92672">*</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Meta</span>   <span style="color:#75715e">// 元数据指针</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">root</span>           <span style="color:#75af00">Bucket</span>         <span style="color:#75715e">// 根桶</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">pages</span>          <span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">]</span><span style="color:#f92672">*</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Page</span> <span style="color:#75715e">// 页面映射</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">stats</span>          <span style="color:#75af00">TxStats</span>        <span style="color:#75715e">// 事务统计</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">commitHandlers</span> <span style="color:#111">[]</span><span style="color:#00a8c8">func</span><span style="color:#111">()</span>       <span style="color:#75715e">// 提交处理程序列表</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// WriteFlag 指定写相关方法（如 WriteTo()）的标志。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Tx 使用指定的标志打开数据库文件以复制数据。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	// 默认情况下，此标志未设置，适合主要在内存中的工作负载。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 对于大于可用 RAM 的数据库，可以设置为 syscall.O_DIRECT 来避免淘汰页面缓存。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">WriteFlag</span> <span style="color:#00a8c8">int</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="begin">Begin</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// Begin 开始一个新事务。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 多个只读事务可以并发使用，但一次只能使用一个写事务。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 启动多个写事务会导致调用阻塞，并序列化直到当前写事务完成。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// 事务不应该彼此依赖。在同一个goroutine中打开一个读事务和一个写事务可能会导致写入者死锁，</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 因为数据库需要定期重新映射自身以应对增长，并且在读事务打开的时候无法进行。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// 如果需要长时间运行的读事务（例如，快照事务），你可能想要将DB.InitialMmapSize设置为足够大的值</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 以避免写事务的潜在阻塞。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// 重要：你必须在完成后关闭只读事务，否则数据库将无法回收旧页面。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">db</span> <span style="color:#f92672">*</span><span style="color:#75af00">DB</span><span style="color:#111">)</span> <span style="color:#75af00">Begin</span><span style="color:#111">(</span><span style="color:#75af00">writable</span> <span style="color:#00a8c8">bool</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#75af00">t</span> <span style="color:#f92672">*</span><span style="color:#75af00">Tx</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">lg</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">Logger</span><span style="color:#111">();</span> <span style="color:#75af00">lg</span> <span style="color:#f92672">!=</span> <span style="color:#75af00">discardLogger</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">lg</span><span style="color:#111">.</span><span style="color:#75af00">Debugf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Starting a new transaction [writable: %t]&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">writable</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">defer</span> <span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">lg</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Starting a new transaction [writable: %t] failed: %v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">writable</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">lg</span><span style="color:#111">.</span><span style="color:#75af00">Debugf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Starting a new transaction [writable: %t] successfully&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">writable</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">writable</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">beginRWTx</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">beginTx</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">db</span> <span style="color:#f92672">*</span><span style="color:#75af00">DB</span><span style="color:#111">)</span> <span style="color:#75af00">beginRWTx</span><span style="color:#111">()</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">Tx</span><span style="color:#111">,</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// If the database was opened with Options.ReadOnly, return an error.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">readOnly</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">berrors</span><span style="color:#111">.</span><span style="color:#75af00">ErrDatabaseReadOnly</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Obtain writer lock. This is released by the transaction when it closes.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// This enforces only one writer transaction at a time.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">rwlock</span><span style="color:#111">.</span><span style="color:#75af00">Lock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Once we have the writer lock then we can lock the meta pages so that</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// we can set up the transaction.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">metalock</span><span style="color:#111">.</span><span style="color:#75af00">Lock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">metalock</span><span style="color:#111">.</span><span style="color:#75af00">Unlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Exit if the database is not open yet.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">opened</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">rwlock</span><span style="color:#111">.</span><span style="color:#75af00">Unlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">berrors</span><span style="color:#111">.</span><span style="color:#75af00">ErrDatabaseNotOpen</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Exit if the database is not correctly mapped.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">data</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">rwlock</span><span style="color:#111">.</span><span style="color:#75af00">Unlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">berrors</span><span style="color:#111">.</span><span style="color:#75af00">ErrInvalidMapping</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Create a transaction associated with the database.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">t</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">Tx</span><span style="color:#111">{</span><span style="color:#75af00">writable</span><span style="color:#111">:</span> <span style="color:#00a8c8">true</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">init</span><span style="color:#111">(</span><span style="color:#75af00">db</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">rwtx</span> <span style="color:#111">=</span> <span style="color:#75af00">t</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">freePages</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">t</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// freePages 释放与已关闭的只读事务关联的任何页面。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">db</span> <span style="color:#f92672">*</span><span style="color:#75af00">DB</span><span style="color:#111">)</span> <span style="color:#75af00">freePages</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">sort</span><span style="color:#111">.</span><span style="color:#75af00">Sort</span><span style="color:#111">(</span><span style="color:#75af00">txsById</span><span style="color:#111">(</span><span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">txs</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">minid</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Txid</span><span style="color:#111">(</span><span style="color:#ae81ff">0xFFFFFFFFFFFFFFFF</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">txs</span><span style="color:#111">)</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">minid</span> <span style="color:#111">=</span> <span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">txs</span><span style="color:#111">[</span><span style="color:#ae81ff">0</span><span style="color:#111">].</span><span style="color:#75af00">meta</span><span style="color:#111">.</span><span style="color:#75af00">Txid</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">minid</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">freelist</span><span style="color:#111">.</span><span style="color:#75af00">release</span><span style="color:#111">(</span><span style="color:#75af00">minid</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">t</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">txs</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">freelist</span><span style="color:#111">.</span><span style="color:#75af00">releaseRange</span><span style="color:#111">(</span><span style="color:#75af00">minid</span><span style="color:#111">,</span> <span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">meta</span><span style="color:#111">.</span><span style="color:#75af00">Txid</span><span style="color:#111">()</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">minid</span> <span style="color:#111">=</span> <span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">meta</span><span style="color:#111">.</span><span style="color:#75af00">Txid</span><span style="color:#111">()</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">freelist</span><span style="color:#111">.</span><span style="color:#75af00">releaseRange</span><span style="color:#111">(</span><span style="color:#75af00">minid</span><span style="color:#111">,</span> <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Txid</span><span style="color:#111">(</span><span style="color:#ae81ff">0xFFFFFFFFFFFFFFFF</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">db</span> <span style="color:#f92672">*</span><span style="color:#75af00">DB</span><span style="color:#111">)</span> <span style="color:#75af00">beginTx</span><span style="color:#111">()</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">Tx</span><span style="color:#111">,</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Lock the meta pages while we initialize the transaction. We obtain</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// the meta lock before the mmap lock because that&#39;s the order that the</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// write transaction will obtain them.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">metalock</span><span style="color:#111">.</span><span style="color:#75af00">Lock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Obtain a read-only lock on the mmap. When the mmap is remapped it will</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// obtain a write lock so all transactions must finish before it can be</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// remapped.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">mmaplock</span><span style="color:#111">.</span><span style="color:#75af00">RLock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Exit if the database is not open yet.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">opened</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">mmaplock</span><span style="color:#111">.</span><span style="color:#75af00">RUnlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">metalock</span><span style="color:#111">.</span><span style="color:#75af00">Unlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">berrors</span><span style="color:#111">.</span><span style="color:#75af00">ErrDatabaseNotOpen</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Exit if the database is not correctly mapped.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">data</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">mmaplock</span><span style="color:#111">.</span><span style="color:#75af00">RUnlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">metalock</span><span style="color:#111">.</span><span style="color:#75af00">Unlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">berrors</span><span style="color:#111">.</span><span style="color:#75af00">ErrInvalidMapping</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Create a transaction associated with the database.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">t</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">Tx</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">init</span><span style="color:#111">(</span><span style="color:#75af00">db</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Keep track of transaction until it closes.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">txs</span> <span style="color:#111">=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">txs</span><span style="color:#111">,</span> <span style="color:#75af00">t</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">n</span> <span style="color:#f92672">:=</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">txs</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Unlock the meta pages.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">metalock</span><span style="color:#111">.</span><span style="color:#75af00">Unlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Update the transaction stats.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">statlock</span><span style="color:#111">.</span><span style="color:#75af00">Lock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">stats</span><span style="color:#111">.</span><span style="color:#75af00">TxN</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">stats</span><span style="color:#111">.</span><span style="color:#75af00">OpenTxN</span> <span style="color:#111">=</span> <span style="color:#75af00">n</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">statlock</span><span style="color:#111">.</span><span style="color:#75af00">Unlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">t</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="commit">Commit</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// Commit 将所有更改写入磁盘，更新元数据页，并关闭事务。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 如果磁盘写入发生错误，或者在只读事务上调用Commit，将返回错误。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">tx</span> <span style="color:#f92672">*</span><span style="color:#75af00">Tx</span><span style="color:#111">)</span> <span style="color:#75af00">Commit</span><span style="color:#111">()</span> <span style="color:#111">(</span><span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">txId</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">ID</span><span style="color:#111">()</span>  <span style="color:#75715e">// 获取事务ID</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">lg</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">Logger</span><span style="color:#111">()</span>  <span style="color:#75715e">// 获取日志记录器</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">lg</span> <span style="color:#f92672">!=</span> <span style="color:#75af00">discardLogger</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">lg</span><span style="color:#111">.</span><span style="color:#75af00">Debugf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Committing transaction %d&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">txId</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">defer</span> <span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75af00">lg</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Committing transaction failed: %v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75af00">lg</span><span style="color:#111">.</span><span style="color:#75af00">Debugf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Committing transaction %d successfully&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">txId</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 检查是否为管理事务，不允许提交。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Assert</span><span style="color:#111">(!</span><span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">managed</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;managed tx commit not allowed&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">db</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">berrors</span><span style="color:#111">.</span><span style="color:#75af00">ErrTxClosed</span>  <span style="color:#75715e">// 事务已关闭错误</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">writable</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">berrors</span><span style="color:#111">.</span><span style="color:#75af00">ErrTxNotWritable</span>  <span style="color:#75715e">// 非写事务错误</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// TODO: 使用向量化I/O写出脏页</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 重新平衡删除后的节点</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">var</span> <span style="color:#75af00">startTime</span> <span style="color:#111">=</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Now</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">root</span><span style="color:#111">.</span><span style="color:#75af00">rebalance</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">stats</span><span style="color:#111">.</span><span style="color:#75af00">GetRebalance</span><span style="color:#111">()</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">stats</span><span style="color:#111">.</span><span style="color:#75af00">IncRebalanceTime</span><span style="color:#111">(</span><span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Since</span><span style="color:#111">(</span><span style="color:#75af00">startTime</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">opgid</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">meta</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">()</span>  <span style="color:#75715e">// 获取旧的页面ID</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 将数据溢出到脏页</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">startTime</span> <span style="color:#111">=</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Now</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">root</span><span style="color:#111">.</span><span style="color:#75af00">spill</span><span style="color:#111">();</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">lg</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;spilling data onto dirty pages failed: %v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">rollback</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">stats</span><span style="color:#111">.</span><span style="color:#75af00">IncSpillTime</span><span style="color:#111">(</span><span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Since</span><span style="color:#111">(</span><span style="color:#75af00">startTime</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 释放旧的根桶</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">meta</span><span style="color:#111">.</span><span style="color:#75af00">RootBucket</span><span style="color:#111">().</span><span style="color:#75af00">SetRootPage</span><span style="color:#111">(</span><span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">root</span><span style="color:#111">.</span><span style="color:#75af00">RootPage</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 释放旧的自由列表，因为提交会写出一个新的自由列表</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">meta</span><span style="color:#111">.</span><span style="color:#75af00">Freelist</span><span style="color:#111">()</span> <span style="color:#f92672">!=</span> <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">PgidNoFreelist</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">freelist</span><span style="color:#111">.</span><span style="color:#75af00">free</span><span style="color:#111">(</span><span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">meta</span><span style="color:#111">.</span><span style="color:#75af00">Txid</span><span style="color:#111">(),</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">page</span><span style="color:#111">(</span><span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">meta</span><span style="color:#111">.</span><span style="color:#75af00">Freelist</span><span style="color:#111">()))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">NoFreelistSync</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">commitFreelist</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75af00">lg</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;committing freelist failed: %v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">meta</span><span style="color:#111">.</span><span style="color:#75af00">SetFreelist</span><span style="color:#111">(</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">PgidNoFreelist</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 如果高水位标记已上移，则尝试扩大数据库</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">meta</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">()</span> <span style="color:#111">&gt;</span> <span style="color:#75af00">opgid</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">grow</span><span style="color:#111">(</span><span style="color:#111">int</span><span style="color:#111">(</span><span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">meta</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">()</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span> <span style="color:#f92672">*</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">pageSize</span><span style="color:#111">);</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75af00">lg</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;growing db size failed, pgid: %d, pagesize: %d, error: %v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">meta</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">(),</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">pageSize</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">rollback</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 将脏页写入磁盘</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">startTime</span> <span style="color:#111">=</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Now</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">write</span><span style="color:#111">();</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">lg</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;writing data failed: %v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">rollback</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 如果启用了严格模式，则执行一致性检查</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">StrictMode</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">ch</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">Check</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">var</span> <span style="color:#75af00">errs</span> <span style="color:#111">[]</span><span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">for</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75af00">chkErr</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#75af00">ch</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#00a8c8">break</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75af00">errs</span> <span style="color:#111">=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">errs</span><span style="color:#111">,</span> <span style="color:#75af00">chkErr</span><span style="color:#111">.</span><span style="color:#75af00">Error</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">errs</span><span style="color:#111">)</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#d88200">&#34;check fail: &#34;</span> <span style="color:#f92672">+</span> <span style="color:#75af00">strings</span><span style="color:#111">.</span><span style="color:#75af00">Join</span><span style="color:#111">(</span><span style="color:#75af00">errs</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;\n&#34;</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 将元数据写入磁盘</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">writeMeta</span><span style="color:#111">();</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">lg</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;writeMeta failed: %v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">rollback</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">stats</span><span style="color:#111">.</span><span style="color:#75af00">IncWriteTime</span><span style="color:#111">(</span><span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Since</span><span style="color:#111">(</span><span style="color:#75af00">startTime</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 结束事务</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#111">close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 执行提交处理程序，锁已经移除</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">fn</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">commitHandlers</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">fn</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="rollback">Rollback</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// Rollback 关闭事务并忽略所有之前的更新。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 只读事务必须回滚而不是提交。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">tx</span> <span style="color:#f92672">*</span><span style="color:#75af00">Tx</span><span style="color:#111">)</span> <span style="color:#75af00">Rollback</span><span style="color:#111">()</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Assert</span><span style="color:#111">(!</span><span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">managed</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;managed tx rollback not allowed&#34;</span><span style="color:#111">)</span>  <span style="color:#75715e">// 断言此事务不是管理型事务</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">db</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">berrors</span><span style="color:#111">.</span><span style="color:#75af00">ErrTxClosed</span>  <span style="color:#75715e">// 如果数据库已关闭，返回错误</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">nonPhysicalRollback</span><span style="color:#111">()</span>  <span style="color:#75715e">// 执行非物理性回滚</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// nonPhysicalRollback 在用户直接调用Rollback时被调用，在这种情况下，我们不需要从磁盘重新加载自由页面。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">tx</span> <span style="color:#f92672">*</span><span style="color:#75af00">Tx</span><span style="color:#111">)</span> <span style="color:#75af00">nonPhysicalRollback</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">db</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span>  <span style="color:#75715e">// 如果数据库已关闭，直接返回</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">writable</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">freelist</span><span style="color:#111">.</span><span style="color:#75af00">rollback</span><span style="color:#111">(</span><span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">meta</span><span style="color:#111">.</span><span style="color:#75af00">Txid</span><span style="color:#111">())</span>  <span style="color:#75715e">// 如果事务是可写的，回滚自由列表</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#111">close</span><span style="color:#111">()</span>  <span style="color:#75715e">// 关闭事务</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// rollback 从给定的挂起事务中移除页面。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">f</span> <span style="color:#f92672">*</span><span style="color:#75af00">freelist</span><span style="color:#111">)</span> <span style="color:#75af00">rollback</span><span style="color:#111">(</span><span style="color:#75af00">txid</span> <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Txid</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 从缓存中移除页面ID。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">txp</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">pending</span><span style="color:#111">[</span><span style="color:#75af00">txid</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">txp</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span>  <span style="color:#75715e">// 如果没有挂起的事务，直接返回</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">var</span> <span style="color:#75af00">m</span> <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgids</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">for</span> <span style="color:#75af00">i</span><span style="color:#111">,</span> <span style="color:#75af00">pgid</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">txp</span><span style="color:#111">.</span><span style="color:#75af00">ids</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">delete</span><span style="color:#111">(</span><span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">cache</span><span style="color:#111">,</span> <span style="color:#75af00">pgid</span><span style="color:#111">)</span>  <span style="color:#75715e">// 从缓存中删除页面ID</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">tx</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">txp</span><span style="color:#111">.</span><span style="color:#75af00">alloctx</span><span style="color:#111">[</span><span style="color:#75af00">i</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#75af00">tx</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">continue</span>  <span style="color:#75715e">// 如果未分配事务ID，继续下一个</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#75af00">tx</span> <span style="color:#f92672">!=</span> <span style="color:#75af00">txid</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 如果待释放页面被中断，恢复页面回分配列表。</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">allocs</span><span style="color:#111">[</span><span style="color:#75af00">pgid</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#75af00">tx</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 如果释放的页面由此事务分配，可以安全地丢弃。</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75af00">m</span> <span style="color:#111">=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">m</span><span style="color:#111">,</span> <span style="color:#75af00">pgid</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 从挂起列表中移除页面，并将其标记为由txid分配的自由页面。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">delete</span><span style="color:#111">(</span><span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">pending</span><span style="color:#111">,</span> <span style="color:#75af00">txid</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">mergeSpans</span><span style="color:#111">(</span><span style="color:#75af00">m</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="view--update">View &amp;&amp; Update</h2>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// View 在管理的只读事务上下文中执行一个函数。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 从函数返回的任何错误都会从View()方法返回。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// 尝试在函数内手动回滚会导致panic。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">db</span> <span style="color:#f92672">*</span><span style="color:#75af00">DB</span><span style="color:#111">)</span> <span style="color:#75af00">View</span><span style="color:#111">(</span><span style="color:#75af00">fn</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">Tx</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">t</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">Begin</span><span style="color:#111">(</span><span style="color:#00a8c8">false</span><span style="color:#111">)</span>  <span style="color:#75715e">// 开始一个只读事务</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>  <span style="color:#75715e">// 如果无法开始事务，返回错误</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 确保在发生panic的情况下事务能够回滚。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">defer</span> <span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">db</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">rollback</span><span style="color:#111">()</span>  <span style="color:#75715e">// 执行回滚操作</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 标记为管理的事务，以便内部函数不能手动回滚。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">managed</span> <span style="color:#111">=</span> <span style="color:#00a8c8">true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 如果函数返回错误，则传递该错误。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">fn</span><span style="color:#111">(</span><span style="color:#75af00">t</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">managed</span> <span style="color:#111">=</span> <span style="color:#00a8c8">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">_</span> <span style="color:#111">=</span> <span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">Rollback</span><span style="color:#111">()</span>  <span style="color:#75715e">// 执行回滚</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">Rollback</span><span style="color:#111">()</span>  <span style="color:#75715e">// 完成后回滚事务</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Update 在读写管理事务的上下文中执行一个函数。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 如果函数没有返回错误，则提交事务。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 如果返回了错误，则整个事务被回滚。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 从函数返回的任何错误或从提交返回的错误都会从Update()方法返回。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// 尝试在函数内手动提交或回滚将导致panic。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">db</span> <span style="color:#f92672">*</span><span style="color:#75af00">DB</span><span style="color:#111">)</span> <span style="color:#75af00">Update</span><span style="color:#111">(</span><span style="color:#75af00">fn</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">Tx</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">t</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">Begin</span><span style="color:#111">(</span><span style="color:#00a8c8">true</span><span style="color:#111">)</span>  <span style="color:#75715e">// 开始一个读写事务</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>  <span style="color:#75715e">// 如果无法开始事务，返回错误</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 确保在发生panic的情况下事务能够回滚。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">defer</span> <span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">db</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">rollback</span><span style="color:#111">()</span>  <span style="color:#75715e">// 执行回滚操作</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 标记为管理的事务，以便内部函数不能手动提交。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">managed</span> <span style="color:#111">=</span> <span style="color:#00a8c8">true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 如果函数返回错误，则回滚并返回错误。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">fn</span><span style="color:#111">(</span><span style="color:#75af00">t</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">managed</span> <span style="color:#111">=</span> <span style="color:#00a8c8">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">_</span> <span style="color:#111">=</span> <span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">Rollback</span><span style="color:#111">()</span>  <span style="color:#75715e">// 执行回滚</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">Commit</span><span style="color:#111">()</span>  <span style="color:#75715e">// 无错误时提交事务</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="reference">Reference</h2>
<ul>
<li><a href="https://wingsxdu.com/posts/database/boltdb/">https://wingsxdu.com/posts/database/boltdb/</a></li>
<li><a href="https://jaydenwen123.github.io/boltdb/">https://jaydenwen123.github.io/boltdb/</a></li>
<li><a href="https://youjiali1995.github.io/storage/boltdb/">https://youjiali1995.github.io/storage/boltdb/</a></li>
<li><a href="https://www.cnblogs.com/huxiao-tee/p/4660352.html">https://www.cnblogs.com/huxiao-tee/p/4660352.html</a></li>
</ul>
]]></content:encoded><category>cloud</category><category>boltdb</category><category>etcd</category><category>golang</category><category>数据库</category><category>kubernetes</category><category>源码分析</category><category>事务</category></item><item><title>etcd watch 实现原理</title><link>https://daemon365.dev/post/cloud/etcd_watch_implementation_principle/</link><pubDate>Mon, 10 Jun 2024 14:16:00 +0800</pubDate><guid>https://daemon365.dev/post/cloud/etcd_watch_implementation_principle/</guid><description>&lt;h2 id="介绍"&gt;介绍&lt;/h2&gt;
&lt;p&gt;在 etcd 中，watch 是一个非常重要的特性，它可以让客户端监控 etcd 中的 key 或者一组 key，当 key 发生变化时，etcd 会通知客户端。本文将介绍 etcd watch 的实现原理。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-BASH" data-lang="BASH"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;etcdctl watch /test
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;# 当 /test 的值发生变化时，会输出如下信息&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;PUT
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;/test
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;a
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;PUT
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;/test
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;b
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;DELETE
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;/test
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id="watch-的-api"&gt;watch 的 api&lt;/h2&gt;
&lt;p&gt;etcd watch api 是由 grpc stream 实现的，客户端通过 grpc stream 发送 watch 请求，etcd 会将 key 的变化通过 stream 返回给客户端。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-protobuf" data-lang="protobuf"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;rpc&lt;/span&gt; &lt;span style="color:#111"&gt;Watch&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#111"&gt;stream&lt;/span&gt; &lt;span style="color:#111"&gt;WatchRequest&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;returns&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#111"&gt;stream&lt;/span&gt; &lt;span style="color:#111"&gt;WatchResponse&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;option&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#111"&gt;google.api.http&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#f92672"&gt;=&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt; &lt;span style="color:#111"&gt;post&lt;/span&gt;&lt;span style="color:#f92672"&gt;:&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;/v3/watch&amp;#34;&lt;/span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt; &lt;span style="color:#111"&gt;body&lt;/span&gt;&lt;span style="color:#f92672"&gt;:&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;*&amp;#34;&lt;/span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt; &lt;span style="color:#111"&gt;};&lt;/span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id="api-实现"&gt;api 实现&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;ws&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;watchServer&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75af00"&gt;Watch&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;stream&lt;/span&gt; &lt;span style="color:#75af00"&gt;pb&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Watch_WatchServer&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;error&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;sws&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;serverWatchStream&lt;/span&gt;&lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;lg&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#75af00"&gt;ws&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;lg&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;clusterID&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#75af00"&gt;ws&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;clusterID&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;memberID&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#75af00"&gt;ws&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;memberID&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;maxRequestBytes&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#75af00"&gt;ws&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;maxRequestBytes&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;sg&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#75af00"&gt;ws&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;sg&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;watchable&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#75af00"&gt;ws&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;watchable&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;ag&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#75af00"&gt;ws&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;ag&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;gRPCStream&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#75af00"&gt;stream&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;watchStream&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#75af00"&gt;ws&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;watchable&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;NewWatchStream&lt;/span&gt;&lt;span style="color:#111"&gt;(),&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// chan for sending control response like watcher created and canceled.&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;ctrlStream&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#111"&gt;make&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;chan&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;pb&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;WatchResponse&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;ctrlStreamBufLen&lt;/span&gt;&lt;span style="color:#111"&gt;),&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;progress&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#111"&gt;make&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;map&lt;/span&gt;&lt;span style="color:#111"&gt;[&lt;/span&gt;&lt;span style="color:#75af00"&gt;mvcc&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;WatchID&lt;/span&gt;&lt;span style="color:#111"&gt;]&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;bool&lt;/span&gt;&lt;span style="color:#111"&gt;),&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;prevKV&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#111"&gt;make&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;map&lt;/span&gt;&lt;span style="color:#111"&gt;[&lt;/span&gt;&lt;span style="color:#75af00"&gt;mvcc&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;WatchID&lt;/span&gt;&lt;span style="color:#111"&gt;]&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;bool&lt;/span&gt;&lt;span style="color:#111"&gt;),&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fragment&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#111"&gt;make&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;map&lt;/span&gt;&lt;span style="color:#111"&gt;[&lt;/span&gt;&lt;span style="color:#75af00"&gt;mvcc&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;WatchID&lt;/span&gt;&lt;span style="color:#111"&gt;]&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;bool&lt;/span&gt;&lt;span style="color:#111"&gt;),&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;closec&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#111"&gt;make&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;chan&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;struct&lt;/span&gt;&lt;span style="color:#111"&gt;{}),&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;sws&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;wg&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Add&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;1&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;go&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;func&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// 开启一个 goroutine 处理新的 event 然后发送给客户端&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;sws&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;sendLoop&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;sws&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;wg&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Done&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;errc&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#111"&gt;make&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;chan&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;error&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;1&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;go&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;func&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// 开启一个 goroutine 处理客户端发送的 watch 请求&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;rerr&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;sws&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;recvLoop&lt;/span&gt;&lt;span style="color:#111"&gt;();&lt;/span&gt; &lt;span style="color:#75af00"&gt;rerr&lt;/span&gt; &lt;span style="color:#f92672"&gt;!=&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;isClientCtxErr&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;stream&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Context&lt;/span&gt;&lt;span style="color:#111"&gt;().&lt;/span&gt;&lt;span style="color:#75af00"&gt;Err&lt;/span&gt;&lt;span style="color:#111"&gt;(),&lt;/span&gt; &lt;span style="color:#75af00"&gt;rerr&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;sws&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;lg&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Debug&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;failed to receive watch request from gRPC stream&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;zap&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Error&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;rerr&lt;/span&gt;&lt;span style="color:#111"&gt;))&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;else&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;sws&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;lg&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Warn&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;failed to receive watch request from gRPC stream&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;zap&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Error&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;rerr&lt;/span&gt;&lt;span style="color:#111"&gt;))&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;streamFailures&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;WithLabelValues&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;receive&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;watch&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;).&lt;/span&gt;&lt;span style="color:#75af00"&gt;Inc&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;errc&lt;/span&gt; &lt;span style="color:#f92672"&gt;&amp;lt;-&lt;/span&gt; &lt;span style="color:#75af00"&gt;rerr&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// 处理结束&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;select&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;case&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#f92672"&gt;&amp;lt;-&lt;/span&gt;&lt;span style="color:#75af00"&gt;errc&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;==&lt;/span&gt; &lt;span style="color:#75af00"&gt;context&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Canceled&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#75af00"&gt;rpctypes&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;ErrGRPCWatchCanceled&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;close&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;sws&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;ctrlStream&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;case&lt;/span&gt; &lt;span style="color:#f92672"&gt;&amp;lt;-&lt;/span&gt;&lt;span style="color:#75af00"&gt;stream&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Context&lt;/span&gt;&lt;span style="color:#111"&gt;().&lt;/span&gt;&lt;span style="color:#75af00"&gt;Done&lt;/span&gt;&lt;span style="color:#111"&gt;():&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#75af00"&gt;stream&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Context&lt;/span&gt;&lt;span style="color:#111"&gt;().&lt;/span&gt;&lt;span style="color:#75af00"&gt;Err&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;==&lt;/span&gt; &lt;span style="color:#75af00"&gt;context&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Canceled&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#75af00"&gt;rpctypes&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;ErrGRPCWatchCanceled&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;sws&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#111"&gt;close&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;这里 主要的逻辑是开启两个 goroutine，一个用于处理客户端发送的 watch 请求，另一个用于处理新的 event 然后发送给客户端。&lt;/p&gt;</description><content:encoded><![CDATA[<h2 id="介绍">介绍</h2>
<p>在 etcd 中，watch 是一个非常重要的特性，它可以让客户端监控 etcd 中的 key 或者一组 key，当 key 发生变化时，etcd 会通知客户端。本文将介绍 etcd watch 的实现原理。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-BASH" data-lang="BASH"><span style="display:flex;"><span>etcdctl watch /test
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 当 /test 的值发生变化时，会输出如下信息</span>
</span></span><span style="display:flex;"><span>PUT
</span></span><span style="display:flex;"><span>/test
</span></span><span style="display:flex;"><span>a
</span></span><span style="display:flex;"><span>PUT
</span></span><span style="display:flex;"><span>/test
</span></span><span style="display:flex;"><span>b
</span></span><span style="display:flex;"><span>DELETE
</span></span><span style="display:flex;"><span>/test
</span></span></code></pre></div><h2 id="watch-的-api">watch 的 api</h2>
<p>etcd watch api 是由 grpc stream 实现的，客户端通过 grpc stream 发送 watch 请求，etcd 会将 key 的变化通过 stream 返回给客户端。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-protobuf" data-lang="protobuf"><span style="display:flex;"><span><span style="color:#00a8c8">rpc</span> <span style="color:#111">Watch</span><span style="color:#111">(</span><span style="color:#111">stream</span> <span style="color:#111">WatchRequest</span><span style="color:#111">)</span> <span style="color:#00a8c8">returns</span> <span style="color:#111">(</span><span style="color:#111">stream</span> <span style="color:#111">WatchResponse</span><span style="color:#111">)</span> <span style="color:#111">{</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>      <span style="color:#00a8c8">option</span> <span style="color:#111">(</span><span style="color:#111">google.api.http</span><span style="color:#111">)</span> <span style="color:#f92672">=</span> <span style="color:#111">{</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>        <span style="color:#111">post</span><span style="color:#f92672">:</span> <span style="color:#d88200">&#34;/v3/watch&#34;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>        <span style="color:#111">body</span><span style="color:#f92672">:</span> <span style="color:#d88200">&#34;*&#34;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    <span style="color:#111">};</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#111">}</span><span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><h2 id="api-实现">api 实现</h2>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">ws</span> <span style="color:#f92672">*</span><span style="color:#75af00">watchServer</span><span style="color:#111">)</span> <span style="color:#75af00">Watch</span><span style="color:#111">(</span><span style="color:#75af00">stream</span> <span style="color:#75af00">pb</span><span style="color:#111">.</span><span style="color:#75af00">Watch_WatchServer</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">sws</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">serverWatchStream</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">lg</span><span style="color:#111">:</span> <span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">lg</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">clusterID</span><span style="color:#111">:</span> <span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">clusterID</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">memberID</span><span style="color:#111">:</span>  <span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">memberID</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">maxRequestBytes</span><span style="color:#111">:</span> <span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">maxRequestBytes</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">sg</span><span style="color:#111">:</span>        <span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">sg</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">watchable</span><span style="color:#111">:</span> <span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">watchable</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">ag</span><span style="color:#111">:</span>        <span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">ag</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">gRPCStream</span><span style="color:#111">:</span>  <span style="color:#75af00">stream</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">watchStream</span><span style="color:#111">:</span> <span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">watchable</span><span style="color:#111">.</span><span style="color:#75af00">NewWatchStream</span><span style="color:#111">(),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// chan for sending control response like watcher created and canceled.</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">ctrlStream</span><span style="color:#111">:</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">chan</span> <span style="color:#f92672">*</span><span style="color:#75af00">pb</span><span style="color:#111">.</span><span style="color:#75af00">WatchResponse</span><span style="color:#111">,</span> <span style="color:#75af00">ctrlStreamBufLen</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">progress</span><span style="color:#111">:</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#75af00">mvcc</span><span style="color:#111">.</span><span style="color:#75af00">WatchID</span><span style="color:#111">]</span><span style="color:#00a8c8">bool</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">prevKV</span><span style="color:#111">:</span>   <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#75af00">mvcc</span><span style="color:#111">.</span><span style="color:#75af00">WatchID</span><span style="color:#111">]</span><span style="color:#00a8c8">bool</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fragment</span><span style="color:#111">:</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#75af00">mvcc</span><span style="color:#111">.</span><span style="color:#75af00">WatchID</span><span style="color:#111">]</span><span style="color:#00a8c8">bool</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">closec</span><span style="color:#111">:</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">chan</span> <span style="color:#00a8c8">struct</span><span style="color:#111">{}),</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">wg</span><span style="color:#111">.</span><span style="color:#75af00">Add</span><span style="color:#111">(</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">go</span> <span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 开启一个 goroutine 处理新的 event 然后发送给客户端</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">sendLoop</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">wg</span><span style="color:#111">.</span><span style="color:#75af00">Done</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">errc</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">chan</span> <span style="color:#00a8c8">error</span><span style="color:#111">,</span> <span style="color:#ae81ff">1</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">go</span> <span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 开启一个 goroutine 处理客户端发送的 watch 请求</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">rerr</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">recvLoop</span><span style="color:#111">();</span> <span style="color:#75af00">rerr</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">isClientCtxErr</span><span style="color:#111">(</span><span style="color:#75af00">stream</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">().</span><span style="color:#75af00">Err</span><span style="color:#111">(),</span> <span style="color:#75af00">rerr</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">lg</span><span style="color:#111">.</span><span style="color:#75af00">Debug</span><span style="color:#111">(</span><span style="color:#d88200">&#34;failed to receive watch request from gRPC stream&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">Error</span><span style="color:#111">(</span><span style="color:#75af00">rerr</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">lg</span><span style="color:#111">.</span><span style="color:#75af00">Warn</span><span style="color:#111">(</span><span style="color:#d88200">&#34;failed to receive watch request from gRPC stream&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">Error</span><span style="color:#111">(</span><span style="color:#75af00">rerr</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">streamFailures</span><span style="color:#111">.</span><span style="color:#75af00">WithLabelValues</span><span style="color:#111">(</span><span style="color:#d88200">&#34;receive&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;watch&#34;</span><span style="color:#111">).</span><span style="color:#75af00">Inc</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">errc</span> <span style="color:#f92672">&lt;-</span> <span style="color:#75af00">rerr</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 处理结束</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">select</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">case</span> <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#f92672">&lt;-</span><span style="color:#75af00">errc</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">==</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Canceled</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">rpctypes</span><span style="color:#111">.</span><span style="color:#75af00">ErrGRPCWatchCanceled</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">close</span><span style="color:#111">(</span><span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">ctrlStream</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#75af00">stream</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">().</span><span style="color:#75af00">Done</span><span style="color:#111">():</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">stream</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">().</span><span style="color:#75af00">Err</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">==</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Canceled</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">rpctypes</span><span style="color:#111">.</span><span style="color:#75af00">ErrGRPCWatchCanceled</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#111">close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>这里 主要的逻辑是开启两个 goroutine，一个用于处理客户端发送的 watch 请求，另一个用于处理新的 event 然后发送给客户端。</p>
<h3 id="sendloop">sendLoop</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">sws</span> <span style="color:#f92672">*</span><span style="color:#75af00">serverWatchStream</span><span style="color:#111">)</span> <span style="color:#75af00">sendLoop</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// watch ids that are currently active</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ids</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#75af00">mvcc</span><span style="color:#111">.</span><span style="color:#75af00">WatchID</span><span style="color:#111">]</span><span style="color:#00a8c8">struct</span><span style="color:#111">{})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// watch responses pending on a watch id creation message</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">pending</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#75af00">mvcc</span><span style="color:#111">.</span><span style="color:#75af00">WatchID</span><span style="color:#111">][]</span><span style="color:#f92672">*</span><span style="color:#75af00">pb</span><span style="color:#111">.</span><span style="color:#75af00">WatchResponse</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">interval</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">GetProgressReportInterval</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">progressTicker</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">NewTicker</span><span style="color:#111">(</span><span style="color:#75af00">interval</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">progressTicker</span><span style="color:#111">.</span><span style="color:#75af00">Stop</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 清空chan ，清理待处理 event</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">for</span> <span style="color:#75af00">ws</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">watchStream</span><span style="color:#111">.</span><span style="color:#75af00">Chan</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">mvcc</span><span style="color:#111">.</span><span style="color:#75af00">ReportEventReceived</span><span style="color:#111">(</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">Events</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">wrs</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">pending</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">ws</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">wrs</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">mvcc</span><span style="color:#111">.</span><span style="color:#75af00">ReportEventReceived</span><span style="color:#111">(</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">Events</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">select</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">case</span> <span style="color:#75af00">wresp</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">watchStream</span><span style="color:#111">.</span><span style="color:#75af00">Chan</span><span style="color:#111">():</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 从 watchStream.Chan() 中获取 event</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 然后发送给客户端 </span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">evs</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">wresp</span><span style="color:#111">.</span><span style="color:#75af00">Events</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">events</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">([]</span><span style="color:#f92672">*</span><span style="color:#75af00">mvccpb</span><span style="color:#111">.</span><span style="color:#75af00">Event</span><span style="color:#111">,</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">evs</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">RLock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">needPrevKV</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">prevKV</span><span style="color:#111">[</span><span style="color:#75af00">wresp</span><span style="color:#111">.</span><span style="color:#75af00">WatchID</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">RUnlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">for</span> <span style="color:#75af00">i</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">evs</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">events</span><span style="color:#111">[</span><span style="color:#75af00">i</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">evs</span><span style="color:#111">[</span><span style="color:#75af00">i</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">if</span> <span style="color:#75af00">needPrevKV</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#111">!</span><span style="color:#75af00">IsCreateEvent</span><span style="color:#111">(</span><span style="color:#75af00">evs</span><span style="color:#111">[</span><span style="color:#75af00">i</span><span style="color:#111">])</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">opt</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">mvcc</span><span style="color:#111">.</span><span style="color:#75af00">RangeOptions</span><span style="color:#111">{</span><span style="color:#75af00">Rev</span><span style="color:#111">:</span> <span style="color:#75af00">evs</span><span style="color:#111">[</span><span style="color:#75af00">i</span><span style="color:#111">].</span><span style="color:#75af00">Kv</span><span style="color:#111">.</span><span style="color:#75af00">ModRevision</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">r</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">watchable</span><span style="color:#111">.</span><span style="color:#75af00">Range</span><span style="color:#111">(</span><span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">TODO</span><span style="color:#111">(),</span> <span style="color:#75af00">evs</span><span style="color:#111">[</span><span style="color:#75af00">i</span><span style="color:#111">].</span><span style="color:#75af00">Kv</span><span style="color:#111">.</span><span style="color:#75af00">Key</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">opt</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>					<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">KVs</span><span style="color:#111">)</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>						<span style="color:#75af00">events</span><span style="color:#111">[</span><span style="color:#75af00">i</span><span style="color:#111">].</span><span style="color:#75af00">PrevKv</span> <span style="color:#111">=</span> <span style="color:#f92672">&amp;</span><span style="color:#111">(</span><span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">KVs</span><span style="color:#111">[</span><span style="color:#ae81ff">0</span><span style="color:#111">])</span>
</span></span><span style="display:flex;"><span>					<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>				<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">canceled</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">wresp</span><span style="color:#111">.</span><span style="color:#75af00">CompactRevision</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">wr</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">pb</span><span style="color:#111">.</span><span style="color:#75af00">WatchResponse</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">Header</span><span style="color:#111">:</span>          <span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">newResponseHeader</span><span style="color:#111">(</span><span style="color:#75af00">wresp</span><span style="color:#111">.</span><span style="color:#75af00">Revision</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">WatchId</span><span style="color:#111">:</span>         <span style="color:#111">int64</span><span style="color:#111">(</span><span style="color:#75af00">wresp</span><span style="color:#111">.</span><span style="color:#75af00">WatchID</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">Events</span><span style="color:#111">:</span>          <span style="color:#75af00">events</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">CompactRevision</span><span style="color:#111">:</span> <span style="color:#75af00">wresp</span><span style="color:#111">.</span><span style="color:#75af00">CompactRevision</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">Canceled</span><span style="color:#111">:</span>        <span style="color:#75af00">canceled</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// Progress notifications can have WatchID -1</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// if they announce on behalf of multiple watchers</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">wresp</span><span style="color:#111">.</span><span style="color:#75af00">WatchID</span> <span style="color:#f92672">!=</span> <span style="color:#75af00">clientv3</span><span style="color:#111">.</span><span style="color:#75af00">InvalidWatchID</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">if</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">okID</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">ids</span><span style="color:#111">[</span><span style="color:#75af00">wresp</span><span style="color:#111">.</span><span style="color:#75af00">WatchID</span><span style="color:#111">];</span> <span style="color:#111">!</span><span style="color:#75af00">okID</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75715e">// buffer if id not yet announced</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">wrs</span> <span style="color:#f92672">:=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">pending</span><span style="color:#111">[</span><span style="color:#75af00">wresp</span><span style="color:#111">.</span><span style="color:#75af00">WatchID</span><span style="color:#111">],</span> <span style="color:#75af00">wr</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">pending</span><span style="color:#111">[</span><span style="color:#75af00">wresp</span><span style="color:#111">.</span><span style="color:#75af00">WatchID</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#75af00">wrs</span>
</span></span><span style="display:flex;"><span>					<span style="color:#00a8c8">continue</span>
</span></span><span style="display:flex;"><span>				<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">mvcc</span><span style="color:#111">.</span><span style="color:#75af00">ReportEventReceived</span><span style="color:#111">(</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">evs</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">RLock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">fragmented</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">fragment</span><span style="color:#111">[</span><span style="color:#75af00">wresp</span><span style="color:#111">.</span><span style="color:#75af00">WatchID</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">RUnlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">var</span> <span style="color:#75af00">serr</span> <span style="color:#00a8c8">error</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// gofail: var beforeSendWatchResponse struct{}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">fragmented</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#111">!</span><span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">serr</span> <span style="color:#111">=</span> <span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">gRPCStream</span><span style="color:#111">.</span><span style="color:#75af00">Send</span><span style="color:#111">(</span><span style="color:#75af00">wr</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">serr</span> <span style="color:#111">=</span> <span style="color:#75af00">sendFragments</span><span style="color:#111">(</span><span style="color:#75af00">wr</span><span style="color:#111">,</span> <span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">maxRequestBytes</span><span style="color:#111">,</span> <span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">gRPCStream</span><span style="color:#111">.</span><span style="color:#75af00">Send</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">serr</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">if</span> <span style="color:#75af00">isClientCtxErr</span><span style="color:#111">(</span><span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">gRPCStream</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">().</span><span style="color:#75af00">Err</span><span style="color:#111">(),</span> <span style="color:#75af00">serr</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">lg</span><span style="color:#111">.</span><span style="color:#75af00">Debug</span><span style="color:#111">(</span><span style="color:#d88200">&#34;failed to send watch response to gRPC stream&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">Error</span><span style="color:#111">(</span><span style="color:#75af00">serr</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>				<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">lg</span><span style="color:#111">.</span><span style="color:#75af00">Warn</span><span style="color:#111">(</span><span style="color:#d88200">&#34;failed to send watch response to gRPC stream&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">Error</span><span style="color:#111">(</span><span style="color:#75af00">serr</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">streamFailures</span><span style="color:#111">.</span><span style="color:#75af00">WithLabelValues</span><span style="color:#111">(</span><span style="color:#d88200">&#34;send&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;watch&#34;</span><span style="color:#111">).</span><span style="color:#75af00">Inc</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>				<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">Lock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">evs</span><span style="color:#111">)</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">progress</span><span style="color:#111">[</span><span style="color:#75af00">wresp</span><span style="color:#111">.</span><span style="color:#75af00">WatchID</span><span style="color:#111">]</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// elide next progress update if sent a key update</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">progress</span><span style="color:#111">[</span><span style="color:#75af00">wresp</span><span style="color:#111">.</span><span style="color:#75af00">WatchID</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#00a8c8">false</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">Unlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">case</span> <span style="color:#75af00">c</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">ctrlStream</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 处理客户端发送的 watch 请求</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">gRPCStream</span><span style="color:#111">.</span><span style="color:#75af00">Send</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">);</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">if</span> <span style="color:#75af00">isClientCtxErr</span><span style="color:#111">(</span><span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">gRPCStream</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">().</span><span style="color:#75af00">Err</span><span style="color:#111">(),</span> <span style="color:#75af00">err</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">lg</span><span style="color:#111">.</span><span style="color:#75af00">Debug</span><span style="color:#111">(</span><span style="color:#d88200">&#34;failed to send watch control response to gRPC stream&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">Error</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>				<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">lg</span><span style="color:#111">.</span><span style="color:#75af00">Warn</span><span style="color:#111">(</span><span style="color:#d88200">&#34;failed to send watch control response to gRPC stream&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">Error</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">streamFailures</span><span style="color:#111">.</span><span style="color:#75af00">WithLabelValues</span><span style="color:#111">(</span><span style="color:#d88200">&#34;send&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;watch&#34;</span><span style="color:#111">).</span><span style="color:#75af00">Inc</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>				<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// track id creation</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">wid</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">mvcc</span><span style="color:#111">.</span><span style="color:#75af00">WatchID</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">WatchId</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">verify</span><span style="color:#111">.</span><span style="color:#75af00">Assert</span><span style="color:#111">(!(</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">Canceled</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">Created</span><span style="color:#111">)</span> <span style="color:#f92672">||</span> <span style="color:#75af00">wid</span> <span style="color:#f92672">==</span> <span style="color:#75af00">clientv3</span><span style="color:#111">.</span><span style="color:#75af00">InvalidWatchID</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;unexpected watchId: %d, wanted: %d, since both &#39;Canceled&#39; and &#39;Created&#39; are true&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">wid</span><span style="color:#111">,</span> <span style="color:#75af00">clientv3</span><span style="color:#111">.</span><span style="color:#75af00">InvalidWatchID</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">Canceled</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">wid</span> <span style="color:#f92672">!=</span> <span style="color:#75af00">clientv3</span><span style="color:#111">.</span><span style="color:#75af00">InvalidWatchID</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#111">delete</span><span style="color:#111">(</span><span style="color:#75af00">ids</span><span style="color:#111">,</span> <span style="color:#75af00">wid</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">continue</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">Created</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// flush buffered events</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">ids</span><span style="color:#111">[</span><span style="color:#75af00">wid</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#00a8c8">struct</span><span style="color:#111">{}{}</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">v</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">pending</span><span style="color:#111">[</span><span style="color:#75af00">wid</span><span style="color:#111">]</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">mvcc</span><span style="color:#111">.</span><span style="color:#75af00">ReportEventReceived</span><span style="color:#111">(</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">v</span><span style="color:#111">.</span><span style="color:#75af00">Events</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>					<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">gRPCStream</span><span style="color:#111">.</span><span style="color:#75af00">Send</span><span style="color:#111">(</span><span style="color:#75af00">v</span><span style="color:#111">);</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>						<span style="color:#00a8c8">if</span> <span style="color:#75af00">isClientCtxErr</span><span style="color:#111">(</span><span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">gRPCStream</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">().</span><span style="color:#75af00">Err</span><span style="color:#111">(),</span> <span style="color:#75af00">err</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>							<span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">lg</span><span style="color:#111">.</span><span style="color:#75af00">Debug</span><span style="color:#111">(</span><span style="color:#d88200">&#34;failed to send pending watch response to gRPC stream&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">Error</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>						<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>							<span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">lg</span><span style="color:#111">.</span><span style="color:#75af00">Warn</span><span style="color:#111">(</span><span style="color:#d88200">&#34;failed to send pending watch response to gRPC stream&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">Error</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>							<span style="color:#75af00">streamFailures</span><span style="color:#111">.</span><span style="color:#75af00">WithLabelValues</span><span style="color:#111">(</span><span style="color:#d88200">&#34;send&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;watch&#34;</span><span style="color:#111">).</span><span style="color:#75af00">Inc</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>						<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>						<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>					<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>				<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>				<span style="color:#111">delete</span><span style="color:#111">(</span><span style="color:#75af00">pending</span><span style="color:#111">,</span> <span style="color:#75af00">wid</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#75af00">progressTicker</span><span style="color:#111">.</span><span style="color:#75af00">C</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">Lock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">for</span> <span style="color:#75af00">id</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">progress</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">if</span> <span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">watchStream</span><span style="color:#111">.</span><span style="color:#75af00">RequestProgress</span><span style="color:#111">(</span><span style="color:#75af00">id</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">progress</span><span style="color:#111">[</span><span style="color:#75af00">id</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#00a8c8">true</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">Unlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">closec</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>这里使用了 for select 循环：</p>
<ol>
<li>从 watchStream.Chan() 中获取 event 然后发送给客户端。</li>
<li>处理客户端发送的 watch 请求。</li>
<li>dispatch progress 事件。</li>
<li>处理结束。</li>
</ol>
<h3 id="recvloop">recvLoop</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">sws</span> <span style="color:#f92672">*</span><span style="color:#75af00">serverWatchStream</span><span style="color:#111">)</span> <span style="color:#75af00">recvLoop</span><span style="color:#111">()</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">req</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">gRPCStream</span><span style="color:#111">.</span><span style="color:#75af00">Recv</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">==</span> <span style="color:#75af00">io</span><span style="color:#111">.</span><span style="color:#75af00">EOF</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">switch</span> <span style="color:#75af00">uv</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">req</span><span style="color:#111">.</span><span style="color:#75af00">RequestUnion</span><span style="color:#111">.(</span><span style="color:#00a8c8">type</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">case</span> <span style="color:#f92672">*</span><span style="color:#75af00">pb</span><span style="color:#111">.</span><span style="color:#75af00">WatchRequest_CreateRequest</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">uv</span><span style="color:#111">.</span><span style="color:#75af00">CreateRequest</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">break</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">creq</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">uv</span><span style="color:#111">.</span><span style="color:#75af00">CreateRequest</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">creq</span><span style="color:#111">.</span><span style="color:#75af00">Key</span><span style="color:#111">)</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// \x00 is the smallest key</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">creq</span><span style="color:#111">.</span><span style="color:#75af00">Key</span> <span style="color:#111">=</span> <span style="color:#111">[]</span><span style="color:#00a8c8">byte</span><span style="color:#111">{</span><span style="color:#ae81ff">0</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">creq</span><span style="color:#111">.</span><span style="color:#75af00">RangeEnd</span><span style="color:#111">)</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// force nil since watchstream.Watch distinguishes</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// between nil and []byte{} for single key / &gt;=</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">creq</span><span style="color:#111">.</span><span style="color:#75af00">RangeEnd</span> <span style="color:#111">=</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">creq</span><span style="color:#111">.</span><span style="color:#75af00">RangeEnd</span><span style="color:#111">)</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">creq</span><span style="color:#111">.</span><span style="color:#75af00">RangeEnd</span><span style="color:#111">[</span><span style="color:#ae81ff">0</span><span style="color:#111">]</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// support  &gt;= key queries</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">creq</span><span style="color:#111">.</span><span style="color:#75af00">RangeEnd</span> <span style="color:#111">=</span> <span style="color:#111">[]</span><span style="color:#00a8c8">byte</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">isWatchPermitted</span><span style="color:#111">(</span><span style="color:#75af00">creq</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">var</span> <span style="color:#75af00">cancelReason</span> <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">switch</span> <span style="color:#75af00">err</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">case</span> <span style="color:#75af00">auth</span><span style="color:#111">.</span><span style="color:#75af00">ErrInvalidAuthToken</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">cancelReason</span> <span style="color:#111">=</span> <span style="color:#75af00">rpctypes</span><span style="color:#111">.</span><span style="color:#75af00">ErrGRPCInvalidAuthToken</span><span style="color:#111">.</span><span style="color:#75af00">Error</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">case</span> <span style="color:#75af00">auth</span><span style="color:#111">.</span><span style="color:#75af00">ErrAuthOldRevision</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">cancelReason</span> <span style="color:#111">=</span> <span style="color:#75af00">rpctypes</span><span style="color:#111">.</span><span style="color:#75af00">ErrGRPCAuthOldRevision</span><span style="color:#111">.</span><span style="color:#75af00">Error</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">case</span> <span style="color:#75af00">auth</span><span style="color:#111">.</span><span style="color:#75af00">ErrUserEmpty</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">cancelReason</span> <span style="color:#111">=</span> <span style="color:#75af00">rpctypes</span><span style="color:#111">.</span><span style="color:#75af00">ErrGRPCUserEmpty</span><span style="color:#111">.</span><span style="color:#75af00">Error</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">default</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>					<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#75af00">auth</span><span style="color:#111">.</span><span style="color:#75af00">ErrPermissionDenied</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>						<span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">lg</span><span style="color:#111">.</span><span style="color:#75af00">Error</span><span style="color:#111">(</span><span style="color:#d88200">&#34;unexpected error code&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">Error</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>					<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">cancelReason</span> <span style="color:#111">=</span> <span style="color:#75af00">rpctypes</span><span style="color:#111">.</span><span style="color:#75af00">ErrGRPCPermissionDenied</span><span style="color:#111">.</span><span style="color:#75af00">Error</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>				<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">wr</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">pb</span><span style="color:#111">.</span><span style="color:#75af00">WatchResponse</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">Header</span><span style="color:#111">:</span>       <span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">newResponseHeader</span><span style="color:#111">(</span><span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">watchStream</span><span style="color:#111">.</span><span style="color:#75af00">Rev</span><span style="color:#111">()),</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">WatchId</span><span style="color:#111">:</span>      <span style="color:#75af00">clientv3</span><span style="color:#111">.</span><span style="color:#75af00">InvalidWatchID</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">Canceled</span><span style="color:#111">:</span>     <span style="color:#00a8c8">true</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">Created</span><span style="color:#111">:</span>      <span style="color:#00a8c8">true</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">CancelReason</span><span style="color:#111">:</span> <span style="color:#75af00">cancelReason</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">select</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">case</span> <span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">ctrlStream</span> <span style="color:#f92672">&lt;-</span> <span style="color:#75af00">wr</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>					<span style="color:#00a8c8">continue</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">closec</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>					<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>				<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">filters</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">FiltersFromRequest</span><span style="color:#111">(</span><span style="color:#75af00">creq</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">wsrev</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">watchStream</span><span style="color:#111">.</span><span style="color:#75af00">Rev</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">rev</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">creq</span><span style="color:#111">.</span><span style="color:#75af00">StartRevision</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">rev</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">rev</span> <span style="color:#111">=</span> <span style="color:#75af00">wsrev</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">id</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">watchStream</span><span style="color:#111">.</span><span style="color:#75af00">Watch</span><span style="color:#111">(</span><span style="color:#75af00">mvcc</span><span style="color:#111">.</span><span style="color:#75af00">WatchID</span><span style="color:#111">(</span><span style="color:#75af00">creq</span><span style="color:#111">.</span><span style="color:#75af00">WatchId</span><span style="color:#111">),</span> <span style="color:#75af00">creq</span><span style="color:#111">.</span><span style="color:#75af00">Key</span><span style="color:#111">,</span> <span style="color:#75af00">creq</span><span style="color:#111">.</span><span style="color:#75af00">RangeEnd</span><span style="color:#111">,</span> <span style="color:#75af00">rev</span><span style="color:#111">,</span> <span style="color:#75af00">filters</span><span style="color:#f92672">...</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">Lock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">if</span> <span style="color:#75af00">creq</span><span style="color:#111">.</span><span style="color:#75af00">ProgressNotify</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">progress</span><span style="color:#111">[</span><span style="color:#75af00">id</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#00a8c8">true</span>
</span></span><span style="display:flex;"><span>				<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">if</span> <span style="color:#75af00">creq</span><span style="color:#111">.</span><span style="color:#75af00">PrevKv</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">prevKV</span><span style="color:#111">[</span><span style="color:#75af00">id</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#00a8c8">true</span>
</span></span><span style="display:flex;"><span>				<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">if</span> <span style="color:#75af00">creq</span><span style="color:#111">.</span><span style="color:#75af00">Fragment</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">fragment</span><span style="color:#111">[</span><span style="color:#75af00">id</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#00a8c8">true</span>
</span></span><span style="display:flex;"><span>				<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">Unlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">id</span> <span style="color:#111">=</span> <span style="color:#75af00">clientv3</span><span style="color:#111">.</span><span style="color:#75af00">InvalidWatchID</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">wr</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">pb</span><span style="color:#111">.</span><span style="color:#75af00">WatchResponse</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">Header</span><span style="color:#111">:</span>   <span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">newResponseHeader</span><span style="color:#111">(</span><span style="color:#75af00">wsrev</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">WatchId</span><span style="color:#111">:</span>  <span style="color:#111">int64</span><span style="color:#111">(</span><span style="color:#75af00">id</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">Created</span><span style="color:#111">:</span>  <span style="color:#00a8c8">true</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">Canceled</span><span style="color:#111">:</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">wr</span><span style="color:#111">.</span><span style="color:#75af00">CancelReason</span> <span style="color:#111">=</span> <span style="color:#75af00">err</span><span style="color:#111">.</span><span style="color:#75af00">Error</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">select</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">case</span> <span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">ctrlStream</span> <span style="color:#f92672">&lt;-</span> <span style="color:#75af00">wr</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">closec</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">case</span> <span style="color:#f92672">*</span><span style="color:#75af00">pb</span><span style="color:#111">.</span><span style="color:#75af00">WatchRequest_CancelRequest</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">uv</span><span style="color:#111">.</span><span style="color:#75af00">CancelRequest</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">id</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">uv</span><span style="color:#111">.</span><span style="color:#75af00">CancelRequest</span><span style="color:#111">.</span><span style="color:#75af00">WatchId</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">watchStream</span><span style="color:#111">.</span><span style="color:#75af00">Cancel</span><span style="color:#111">(</span><span style="color:#75af00">mvcc</span><span style="color:#111">.</span><span style="color:#75af00">WatchID</span><span style="color:#111">(</span><span style="color:#75af00">id</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">ctrlStream</span> <span style="color:#f92672">&lt;-</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">pb</span><span style="color:#111">.</span><span style="color:#75af00">WatchResponse</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>						<span style="color:#75af00">Header</span><span style="color:#111">:</span>   <span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">newResponseHeader</span><span style="color:#111">(</span><span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">watchStream</span><span style="color:#111">.</span><span style="color:#75af00">Rev</span><span style="color:#111">()),</span>
</span></span><span style="display:flex;"><span>						<span style="color:#75af00">WatchId</span><span style="color:#111">:</span>  <span style="color:#75af00">id</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>						<span style="color:#75af00">Canceled</span><span style="color:#111">:</span> <span style="color:#00a8c8">true</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>					<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">Lock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>					<span style="color:#111">delete</span><span style="color:#111">(</span><span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">progress</span><span style="color:#111">,</span> <span style="color:#75af00">mvcc</span><span style="color:#111">.</span><span style="color:#75af00">WatchID</span><span style="color:#111">(</span><span style="color:#75af00">id</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>					<span style="color:#111">delete</span><span style="color:#111">(</span><span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">prevKV</span><span style="color:#111">,</span> <span style="color:#75af00">mvcc</span><span style="color:#111">.</span><span style="color:#75af00">WatchID</span><span style="color:#111">(</span><span style="color:#75af00">id</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>					<span style="color:#111">delete</span><span style="color:#111">(</span><span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">fragment</span><span style="color:#111">,</span> <span style="color:#75af00">mvcc</span><span style="color:#111">.</span><span style="color:#75af00">WatchID</span><span style="color:#111">(</span><span style="color:#75af00">id</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">Unlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>				<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">case</span> <span style="color:#f92672">*</span><span style="color:#75af00">pb</span><span style="color:#111">.</span><span style="color:#75af00">WatchRequest_ProgressRequest</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">uv</span><span style="color:#111">.</span><span style="color:#75af00">ProgressRequest</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">Lock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">watchStream</span><span style="color:#111">.</span><span style="color:#75af00">RequestProgressAll</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">Unlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">default</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// we probably should not shutdown the entire stream when</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// receive an invalid command.</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// so just do nothing instead.</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">sws</span><span style="color:#111">.</span><span style="color:#75af00">lg</span><span style="color:#111">.</span><span style="color:#75af00">Sugar</span><span style="color:#111">().</span><span style="color:#75af00">Infof</span><span style="color:#111">(</span><span style="color:#d88200">&#34;invalid watch request type %T received in gRPC stream&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">uv</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">continue</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>这里主要处理客户端发送的 watch 请求，然后发送给 ctrlStream。sendLoop 会从 ctrlStream 中获取 event 然后发送给客户端。</p>
<h2 id="watchstream">WatchStream</h2>
<p>这个 inferface 才是处理 watch 的主要逻辑</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// WatchStream 是一个接口，定义了一个流式处理watch请求的机制</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">WatchStream</span> <span style="color:#00a8c8">interface</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Watch 创建一个观察者。观察者会监听在给定的键或范围 [key, end) 上发生的事件或已发生的事件。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	// 整个事件历史都可以被观察到，除非被压缩。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 如果 &#34;startRev&#34; &lt;= 0，watch 将观察在当前修订版本之后的事件。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	// 返回的 &#34;id&#34; 是这个观察者的ID。它作为 WatchID 出现在通过 stream 通道发送到创建的观察者的事件中。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 当 WatchID 不等于 AutoWatchID 时，使用指定的 WatchID，否则返回自动生成的 WatchID。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Watch</span><span style="color:#111">(</span><span style="color:#75af00">id</span> <span style="color:#75af00">WatchID</span><span style="color:#111">,</span> <span style="color:#75af00">key</span><span style="color:#111">,</span> <span style="color:#75af00">end</span> <span style="color:#111">[]</span><span style="color:#00a8c8">byte</span><span style="color:#111">,</span> <span style="color:#75af00">startRev</span> <span style="color:#00a8c8">int64</span><span style="color:#111">,</span> <span style="color:#75af00">fcs</span> <span style="color:#f92672">...</span><span style="color:#75af00">FilterFunc</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#75af00">WatchID</span><span style="color:#111">,</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Chan 返回一个通道。所有的watch响应将被发送到这个返回的通道。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Chan</span><span style="color:#111">()</span> <span style="color:#f92672">&lt;-</span><span style="color:#00a8c8">chan</span> <span style="color:#75af00">WatchResponse</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// RequestProgress 请求给定ID的观察者的进度。响应只有在观察者当前同步时才会被发送。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 响应将通过与此流关联的 WatchResponse 通道发送，以确保正确的顺序。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 响应不包含事件。响应中的修订版本是观察者自同步以来的进度。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">RequestProgress</span><span style="color:#111">(</span><span style="color:#75af00">id</span> <span style="color:#75af00">WatchID</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// RequestProgressAll 请求所有共享此流的观察者的进度通知。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 如果所有观察者都已同步，将向此流的任意观察者发送带有watch ID -1的进度通知，并返回 true。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">RequestProgressAll</span><span style="color:#111">()</span> <span style="color:#00a8c8">bool</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Cancel 通过给定ID取消观察者。如果观察者不存在，将返回错误。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Cancel</span><span style="color:#111">(</span><span style="color:#75af00">id</span> <span style="color:#75af00">WatchID</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Close 关闭通道并释放所有相关资源。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Rev 返回流上观察到的KV的当前修订版本。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Rev</span><span style="color:#111">()</span> <span style="color:#00a8c8">int64</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// WatchResponse 表示一个watch操作的响应。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">WatchResponse</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// WatchID 是发送此响应的观察者的ID。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">WatchID</span> <span style="color:#75af00">WatchID</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Events 包含所有需要发送的事件。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Events</span> <span style="color:#111">[]</span><span style="color:#75af00">mvccpb</span><span style="color:#111">.</span><span style="color:#75af00">Event</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Revision 是创建watch响应时KV的修订版本。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 对于正常响应，修订版本应该与Events中最后一个修改的修订版本相同。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 对于延迟响应的未同步观察者，修订版本大于Events中最后一个修改的修订版本。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Revision</span> <span style="color:#00a8c8">int64</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// CompactRevision 在观察者由于压缩而被取消时设置。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">CompactRevision</span> <span style="color:#00a8c8">int64</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 实现了 WatchStream</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// watchStream 包含共享一个流通道发送被观察事件和其他控制事件的观察者集合。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">watchStream</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 可观察对象（例如KV存储）</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">watchable</span> <span style="color:#75af00">watchable</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 用于发送watch响应的通道</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ch</span>        <span style="color:#00a8c8">chan</span> <span style="color:#75af00">WatchResponse</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 互斥锁，保护以下字段</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">mu</span> <span style="color:#75af00">sync</span><span style="color:#111">.</span><span style="color:#75af00">Mutex</span> 
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// nextID 是为此流中下一个新观察者预分配的ID</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">nextID</span>   <span style="color:#75af00">WatchID</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 标志流是否已关闭</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">closed</span>   <span style="color:#00a8c8">bool</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 取消函数的映射，用于取消特定的观察者</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">cancels</span>  <span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#75af00">WatchID</span><span style="color:#111">]</span><span style="color:#75af00">cancelFunc</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 观察者的映射，根据观察者ID索引</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">watchers</span> <span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#75af00">WatchID</span><span style="color:#111">]</span><span style="color:#f92672">*</span><span style="color:#75af00">watcher</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Watch 在流中创建一个新的观察者并返回其 WatchID。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">ws</span> <span style="color:#f92672">*</span><span style="color:#75af00">watchStream</span><span style="color:#111">)</span> <span style="color:#75af00">Watch</span><span style="color:#111">(</span><span style="color:#75af00">id</span> <span style="color:#75af00">WatchID</span><span style="color:#111">,</span> <span style="color:#75af00">key</span><span style="color:#111">,</span> <span style="color:#75af00">end</span> <span style="color:#111">[]</span><span style="color:#00a8c8">byte</span><span style="color:#111">,</span> <span style="color:#75af00">startRev</span> <span style="color:#00a8c8">int64</span><span style="color:#111">,</span> <span style="color:#75af00">fcs</span> <span style="color:#f92672">...</span><span style="color:#75af00">FilterFunc</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#75af00">WatchID</span><span style="color:#111">,</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 防止键 &gt;= 结束键（按字典顺序）的错误范围</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 带有 &#39;WithFromKey&#39; 的watch请求具有空字节范围结束</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">end</span><span style="color:#111">)</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">bytes</span><span style="color:#111">.</span><span style="color:#75af00">Compare</span><span style="color:#111">(</span><span style="color:#75af00">key</span><span style="color:#111">,</span> <span style="color:#75af00">end</span><span style="color:#111">)</span> <span style="color:#f92672">!=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">,</span> <span style="color:#75af00">ErrEmptyWatcherRange</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 获取互斥锁</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">Lock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">Unlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 如果流已关闭，返回错误</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">closed</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">,</span> <span style="color:#75af00">ErrEmptyWatcherRange</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 自动生成 WatchID</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">id</span> <span style="color:#f92672">==</span> <span style="color:#75af00">clientv3</span><span style="color:#111">.</span><span style="color:#75af00">AutoWatchID</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">for</span> <span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">watchers</span><span style="color:#111">[</span><span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">nextID</span><span style="color:#111">]</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">nextID</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">id</span> <span style="color:#111">=</span> <span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">nextID</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">nextID</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#00a8c8">if</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">watchers</span><span style="color:#111">[</span><span style="color:#75af00">id</span><span style="color:#111">];</span> <span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">,</span> <span style="color:#75af00">ErrWatcherDuplicateID</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 创建新的观察者</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">w</span><span style="color:#111">,</span> <span style="color:#75af00">c</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">watchable</span><span style="color:#111">.</span><span style="color:#75af00">watch</span><span style="color:#111">(</span><span style="color:#75af00">key</span><span style="color:#111">,</span> <span style="color:#75af00">end</span><span style="color:#111">,</span> <span style="color:#75af00">startRev</span><span style="color:#111">,</span> <span style="color:#75af00">id</span><span style="color:#111">,</span> <span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">ch</span><span style="color:#111">,</span> <span style="color:#75af00">fcs</span><span style="color:#f92672">...</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 保存取消函数和观察者</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">cancels</span><span style="color:#111">[</span><span style="color:#75af00">id</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#75af00">c</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">watchers</span><span style="color:#111">[</span><span style="color:#75af00">id</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#75af00">w</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">id</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Chan 返回用于接收watch响应的通道。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">ws</span> <span style="color:#f92672">*</span><span style="color:#75af00">watchStream</span><span style="color:#111">)</span> <span style="color:#75af00">Chan</span><span style="color:#111">()</span> <span style="color:#f92672">&lt;-</span><span style="color:#00a8c8">chan</span> <span style="color:#75af00">WatchResponse</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">ch</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Cancel 取消具有给定ID的观察者。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">ws</span> <span style="color:#f92672">*</span><span style="color:#75af00">watchStream</span><span style="color:#111">)</span> <span style="color:#75af00">Cancel</span><span style="color:#111">(</span><span style="color:#75af00">id</span> <span style="color:#75af00">WatchID</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 获取互斥锁</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">Lock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">cancel</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">cancels</span><span style="color:#111">[</span><span style="color:#75af00">id</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">w</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">watchers</span><span style="color:#111">[</span><span style="color:#75af00">id</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ok</span> <span style="color:#111">=</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#111">!</span><span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">closed</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">Unlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 如果观察者不存在或流已关闭，返回错误</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">ErrWatcherNotExist</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">cancel</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 获取互斥锁</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">Lock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 在取消之前不删除观察者，以确保 Close() 调用时等待取消</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">ww</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">watchers</span><span style="color:#111">[</span><span style="color:#75af00">id</span><span style="color:#111">];</span> <span style="color:#75af00">ww</span> <span style="color:#f92672">==</span> <span style="color:#75af00">w</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">delete</span><span style="color:#111">(</span><span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">cancels</span><span style="color:#111">,</span> <span style="color:#75af00">id</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">delete</span><span style="color:#111">(</span><span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">watchers</span><span style="color:#111">,</span> <span style="color:#75af00">id</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">Unlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Close 关闭通道并释放所有相关资源。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">ws</span> <span style="color:#f92672">*</span><span style="color:#75af00">watchStream</span><span style="color:#111">)</span> <span style="color:#75af00">Close</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 获取互斥锁</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">Lock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">Unlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 取消所有观察者</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">cancel</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">cancels</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">cancel</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 标记流已关闭并关闭通道</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">closed</span> <span style="color:#111">=</span> <span style="color:#00a8c8">true</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">close</span><span style="color:#111">(</span><span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">ch</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">watchStreamGauge</span><span style="color:#111">.</span><span style="color:#75af00">Dec</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Rev 返回流上观察到的KV的当前修订版本。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">ws</span> <span style="color:#f92672">*</span><span style="color:#75af00">watchStream</span><span style="color:#111">)</span> <span style="color:#75af00">Rev</span><span style="color:#111">()</span> <span style="color:#00a8c8">int64</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 获取互斥锁</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">Lock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">Unlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">watchable</span><span style="color:#111">.</span><span style="color:#75af00">rev</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// RequestProgress 请求给定ID的观察者的进度。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">ws</span> <span style="color:#f92672">*</span><span style="color:#75af00">watchStream</span><span style="color:#111">)</span> <span style="color:#75af00">RequestProgress</span><span style="color:#111">(</span><span style="color:#75af00">id</span> <span style="color:#75af00">WatchID</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 获取互斥锁</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">Lock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">w</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">watchers</span><span style="color:#111">[</span><span style="color:#75af00">id</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">Unlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 如果观察者不存在，直接返回</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 请求进度</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">watchable</span><span style="color:#111">.</span><span style="color:#75af00">progress</span><span style="color:#111">(</span><span style="color:#75af00">w</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// RequestProgressAll 请求所有观察者的进度通知。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">ws</span> <span style="color:#f92672">*</span><span style="color:#75af00">watchStream</span><span style="color:#111">)</span> <span style="color:#75af00">RequestProgressAll</span><span style="color:#111">()</span> <span style="color:#00a8c8">bool</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 获取互斥锁</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">Lock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">Unlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">watchable</span><span style="color:#111">.</span><span style="color:#75af00">progressAll</span><span style="color:#111">(</span><span style="color:#75af00">ws</span><span style="color:#111">.</span><span style="color:#75af00">watchers</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><ol>
<li>Watch 方法：创建一个新的观察者，如果指定的范围不正确或观察者ID重复，则返回错误。否则，创建观察者并保存取消函数和观察者实例。</li>
<li>Chan 方法：返回用于接收watch响应的通道。</li>
<li>Cancel 方法：取消给定ID的观察者，删除相关的取消函数和观察者实例。</li>
<li>Close 方法：关闭所有观察者并释放资源。</li>
<li>Rev 方法：返回当前观察到的KV修订版本。</li>
<li>RequestProgress 方法：请求特定观察者的进度。</li>
<li>RequestProgressAll 方法：请求所有观察者的进度通知。</li>
</ol>
<p>可以可到 当调用 Watch 的时候 每个 watchId 都会调用 <code>watchable.watch</code> 并把自己 ch 放入进去</p>
<h2 id="watchable">watchable</h2>
<p><img src="/images/ad802824-86e0-42a7-b84d-d2dfe2076620.png" alt=""></p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// watchable 接口定义了可观察对象的行为</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">watchable</span> <span style="color:#00a8c8">interface</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// watch 创建一个新的观察者，用于监听指定键或范围[startRev, end)上的事件。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 返回观察者指针和取消函数。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">watch</span><span style="color:#111">(</span><span style="color:#75af00">key</span><span style="color:#111">,</span> <span style="color:#75af00">end</span> <span style="color:#111">[]</span><span style="color:#00a8c8">byte</span><span style="color:#111">,</span> <span style="color:#75af00">startRev</span> <span style="color:#00a8c8">int64</span><span style="color:#111">,</span> <span style="color:#75af00">id</span> <span style="color:#75af00">WatchID</span><span style="color:#111">,</span> <span style="color:#75af00">ch</span> <span style="color:#00a8c8">chan</span><span style="color:#f92672">&lt;-</span> <span style="color:#75af00">WatchResponse</span><span style="color:#111">,</span> <span style="color:#75af00">fcs</span> <span style="color:#f92672">...</span><span style="color:#75af00">FilterFunc</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">watcher</span><span style="color:#111">,</span> <span style="color:#75af00">cancelFunc</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// progress 通知特定观察者当前的进度。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">progress</span><span style="color:#111">(</span><span style="color:#75af00">w</span> <span style="color:#f92672">*</span><span style="color:#75af00">watcher</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// progressAll 通知所有观察者当前的进度。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 如果所有观察者都已同步，则返回 true。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">progressAll</span><span style="color:#111">(</span><span style="color:#75af00">watchers</span> <span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#75af00">WatchID</span><span style="color:#111">]</span><span style="color:#f92672">*</span><span style="color:#75af00">watcher</span><span style="color:#111">)</span> <span style="color:#00a8c8">bool</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// rev 返回当前观察到的修订版本。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">rev</span><span style="color:#111">()</span> <span style="color:#00a8c8">int64</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// watchableStore 是一个实现了 watchable 接口的结构体，代表一个可观察的存储</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">watchableStore</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// store 是一个指向基础存储的指针</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">*</span><span style="color:#75af00">store</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// mu 保护观察者组和批次。为了避免死锁，在锁定 store.mu 之前不应锁定 mu。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">mu</span> <span style="color:#75af00">sync</span><span style="color:#111">.</span><span style="color:#75af00">RWMutex</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// victims 是在 watch 通道上被阻塞的观察者批次</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">victims</span> <span style="color:#111">[]</span><span style="color:#75af00">watcherBatch</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">victimc</span> <span style="color:#00a8c8">chan</span> <span style="color:#00a8c8">struct</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// unsynced 包含所有需要同步已经发生的事件的未同步观察者</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">unsynced</span> <span style="color:#75af00">watcherGroup</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// synced 包含所有与存储进度同步的观察者</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 映射的键是观察者监听的键</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">synced</span> <span style="color:#75af00">watcherGroup</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// stopc 是一个用于停止操作的通道</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">stopc</span> <span style="color:#00a8c8">chan</span> <span style="color:#00a8c8">struct</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// wg 用于等待所有 goroutine 完成</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">wg</span> <span style="color:#75af00">sync</span><span style="color:#111">.</span><span style="color:#75af00">WaitGroup</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">s</span> <span style="color:#f92672">*</span><span style="color:#75af00">watchableStore</span><span style="color:#111">)</span> <span style="color:#75af00">watch</span><span style="color:#111">(</span><span style="color:#75af00">key</span><span style="color:#111">,</span> <span style="color:#75af00">end</span> <span style="color:#111">[]</span><span style="color:#00a8c8">byte</span><span style="color:#111">,</span> <span style="color:#75af00">startRev</span> <span style="color:#00a8c8">int64</span><span style="color:#111">,</span> <span style="color:#75af00">id</span> <span style="color:#75af00">WatchID</span><span style="color:#111">,</span> <span style="color:#75af00">ch</span> <span style="color:#00a8c8">chan</span><span style="color:#f92672">&lt;-</span> <span style="color:#75af00">WatchResponse</span><span style="color:#111">,</span> <span style="color:#75af00">fcs</span> <span style="color:#f92672">...</span><span style="color:#75af00">FilterFunc</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">watcher</span><span style="color:#111">,</span> <span style="color:#75af00">cancelFunc</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 创建一个新的观察者</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">wa</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">watcher</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">key</span><span style="color:#111">:</span>    <span style="color:#75af00">key</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">end</span><span style="color:#111">:</span>    <span style="color:#75af00">end</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">minRev</span><span style="color:#111">:</span> <span style="color:#75af00">startRev</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">id</span><span style="color:#111">:</span>     <span style="color:#75af00">id</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">ch</span><span style="color:#111">:</span>     <span style="color:#75af00">ch</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fcs</span><span style="color:#111">:</span>    <span style="color:#75af00">fcs</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 锁定 watchableStore 的互斥锁</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">Lock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 锁定 store 的读写锁用于获取当前修订版本</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">revMu</span><span style="color:#111">.</span><span style="color:#75af00">RLock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 判断观察者是否与当前存储修订版本同步</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">synced</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">startRev</span> <span style="color:#111">&gt;</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">store</span><span style="color:#111">.</span><span style="color:#75af00">currentRev</span> <span style="color:#f92672">||</span> <span style="color:#75af00">startRev</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">synced</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 如果同步，设置最小修订版本为当前修订版本的下一个版本</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">wa</span><span style="color:#111">.</span><span style="color:#75af00">minRev</span> <span style="color:#111">=</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">store</span><span style="color:#111">.</span><span style="color:#75af00">currentRev</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">startRev</span> <span style="color:#111">&gt;</span> <span style="color:#75af00">wa</span><span style="color:#111">.</span><span style="color:#75af00">minRev</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">wa</span><span style="color:#111">.</span><span style="color:#75af00">minRev</span> <span style="color:#111">=</span> <span style="color:#75af00">startRev</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 将观察者添加到同步观察者组中</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">synced</span><span style="color:#111">.</span><span style="color:#75af00">add</span><span style="color:#111">(</span><span style="color:#75af00">wa</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 如果未同步，增加慢速观察者计数器</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">slowWatcherGauge</span><span style="color:#111">.</span><span style="color:#75af00">Inc</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 将观察者添加到未同步观察者组中</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">unsynced</span><span style="color:#111">.</span><span style="color:#75af00">add</span><span style="color:#111">(</span><span style="color:#75af00">wa</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 解锁 store 的读写锁</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">revMu</span><span style="color:#111">.</span><span style="color:#75af00">RUnlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 解锁 watchableStore 的互斥锁</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">Unlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 增加观察者计数器</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">watcherGauge</span><span style="color:#111">.</span><span style="color:#75af00">Inc</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 返回观察者和取消函数</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">wa</span><span style="color:#111">,</span> <span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#111">{</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">cancelWatcher</span><span style="color:#111">(</span><span style="color:#75af00">wa</span><span style="color:#111">)</span> <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="newwatchablestore">newWatchableStore</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">newWatchableStore</span><span style="color:#111">(</span><span style="color:#75af00">lg</span> <span style="color:#f92672">*</span><span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">Logger</span><span style="color:#111">,</span> <span style="color:#75af00">b</span> <span style="color:#75af00">backend</span><span style="color:#111">.</span><span style="color:#75af00">Backend</span><span style="color:#111">,</span> <span style="color:#75af00">le</span> <span style="color:#75af00">lease</span><span style="color:#111">.</span><span style="color:#75af00">Lessor</span><span style="color:#111">,</span> <span style="color:#75af00">cfg</span> <span style="color:#75af00">StoreConfig</span><span style="color:#111">)</span> <span style="color:#f92672">*</span><span style="color:#75af00">watchableStore</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">lg</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">lg</span> <span style="color:#111">=</span> <span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">NewNop</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">s</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">watchableStore</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">store</span><span style="color:#111">:</span>    <span style="color:#75af00">NewStore</span><span style="color:#111">(</span><span style="color:#75af00">lg</span><span style="color:#111">,</span> <span style="color:#75af00">b</span><span style="color:#111">,</span> <span style="color:#75af00">le</span><span style="color:#111">,</span> <span style="color:#75af00">cfg</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">victimc</span><span style="color:#111">:</span>  <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">chan</span> <span style="color:#00a8c8">struct</span><span style="color:#111">{},</span> <span style="color:#ae81ff">1</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">unsynced</span><span style="color:#111">:</span> <span style="color:#75af00">newWatcherGroup</span><span style="color:#111">(),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">synced</span><span style="color:#111">:</span>   <span style="color:#75af00">newWatcherGroup</span><span style="color:#111">(),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">stopc</span><span style="color:#111">:</span>    <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">chan</span> <span style="color:#00a8c8">struct</span><span style="color:#111">{}),</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">store</span><span style="color:#111">.</span><span style="color:#75af00">ReadView</span> <span style="color:#111">=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">readView</span><span style="color:#111">{</span><span style="color:#75af00">s</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">store</span><span style="color:#111">.</span><span style="color:#75af00">WriteView</span> <span style="color:#111">=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">writeView</span><span style="color:#111">{</span><span style="color:#75af00">s</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">le</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// use this store as the deleter so revokes trigger watch events</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">le</span><span style="color:#111">.</span><span style="color:#75af00">SetRangeDeleter</span><span style="color:#111">(</span><span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#75af00">lease</span><span style="color:#111">.</span><span style="color:#75af00">TxnDelete</span> <span style="color:#111">{</span> <span style="color:#00a8c8">return</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">Write</span><span style="color:#111">(</span><span style="color:#75af00">traceutil</span><span style="color:#111">.</span><span style="color:#75af00">TODO</span><span style="color:#111">())</span> <span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">wg</span><span style="color:#111">.</span><span style="color:#75af00">Add</span><span style="color:#111">(</span><span style="color:#ae81ff">2</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">go</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">syncWatchersLoop</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">go</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">syncVictimsLoop</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">s</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="syncwatchersloop">syncWatchersLoop</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// syncWatchersLoop 每100毫秒同步一次unsynced集合中的观察者。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">s</span> <span style="color:#f92672">*</span><span style="color:#75af00">watchableStore</span><span style="color:#111">)</span> <span style="color:#75af00">syncWatchersLoop</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">wg</span><span style="color:#111">.</span><span style="color:#75af00">Done</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 设置等待时间为100毫秒</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">waitDuration</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">100</span> <span style="color:#f92672">*</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Millisecond</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">delayTicker</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">NewTicker</span><span style="color:#111">(</span><span style="color:#75af00">waitDuration</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">delayTicker</span><span style="color:#111">.</span><span style="color:#75af00">Stop</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 锁定以获取未同步观察者的数量</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">RLock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">st</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Now</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">lastUnsyncedWatchers</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">unsynced</span><span style="color:#111">.</span><span style="color:#75af00">size</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">RUnlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">unsyncedWatchers</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 如果有未同步观察者，同步这些观察者</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">lastUnsyncedWatchers</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">unsyncedWatchers</span> <span style="color:#111">=</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">syncWatchers</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">syncDuration</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Since</span><span style="color:#111">(</span><span style="color:#75af00">st</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 重置定时器</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">delayTicker</span><span style="color:#111">.</span><span style="color:#75af00">Reset</span><span style="color:#111">(</span><span style="color:#75af00">waitDuration</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 检查是否有更多待处理的工作</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">unsyncedWatchers</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">lastUnsyncedWatchers</span> <span style="color:#111">&gt;</span> <span style="color:#75af00">unsyncedWatchers</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 公平对待其他存储操作，通过延长时间来避免占用太多资源</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">delayTicker</span><span style="color:#111">.</span><span style="color:#75af00">Reset</span><span style="color:#111">(</span><span style="color:#75af00">syncDuration</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 等待定时器或停止信号</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">select</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#75af00">delayTicker</span><span style="color:#111">.</span><span style="color:#75af00">C</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">stopc</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// syncWatchers 通过以下步骤同步未同步的观察者：</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//  1. 从未同步观察者组中选择一组观察者</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//  2. 迭代该组以获取最小修订版本并移除压缩的观察者</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//  3. 使用最小修订版本获取所有键值对，并将这些事件发送给观察者</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//  4. 从未同步组中移除已同步的观察者，并移动到同步组中</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">s</span> <span style="color:#f92672">*</span><span style="color:#75af00">watchableStore</span><span style="color:#111">)</span> <span style="color:#75af00">syncWatchers</span><span style="color:#111">()</span> <span style="color:#00a8c8">int</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 锁定</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">Lock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">Unlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 如果没有未同步观察者，返回0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">unsynced</span><span style="color:#111">.</span><span style="color:#75af00">size</span><span style="color:#111">()</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 锁定存储的读写锁</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">store</span><span style="color:#111">.</span><span style="color:#75af00">revMu</span><span style="color:#111">.</span><span style="color:#75af00">RLock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">store</span><span style="color:#111">.</span><span style="color:#75af00">revMu</span><span style="color:#111">.</span><span style="color:#75af00">RUnlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 为了从未同步观察者中找到键值对，我们需要找到最小修订版本</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">curRev</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">store</span><span style="color:#111">.</span><span style="color:#75af00">currentRev</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">compactionRev</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">store</span><span style="color:#111">.</span><span style="color:#75af00">compactMainRev</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 选择一组观察者</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">wg</span><span style="color:#111">,</span> <span style="color:#75af00">minRev</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">unsynced</span><span style="color:#111">.</span><span style="color:#75af00">choose</span><span style="color:#111">(</span><span style="color:#75af00">maxWatchersPerSync</span><span style="color:#111">,</span> <span style="color:#75af00">curRev</span><span style="color:#111">,</span> <span style="color:#75af00">compactionRev</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">minBytes</span><span style="color:#111">,</span> <span style="color:#75af00">maxBytes</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">NewRevBytes</span><span style="color:#111">(),</span> <span style="color:#75af00">NewRevBytes</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">minBytes</span> <span style="color:#111">=</span> <span style="color:#75af00">RevToBytes</span><span style="color:#111">(</span><span style="color:#75af00">Revision</span><span style="color:#111">{</span><span style="color:#75af00">Main</span><span style="color:#111">:</span> <span style="color:#75af00">minRev</span><span style="color:#111">},</span> <span style="color:#75af00">minBytes</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">maxBytes</span> <span style="color:#111">=</span> <span style="color:#75af00">RevToBytes</span><span style="color:#111">(</span><span style="color:#75af00">Revision</span><span style="color:#111">{</span><span style="color:#75af00">Main</span><span style="color:#111">:</span> <span style="color:#75af00">curRev</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span><span style="color:#111">},</span> <span style="color:#75af00">maxBytes</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// UnsafeRange 返回键和值。在boltdb中，键是修订版本，值是实际的键值对。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">tx</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">store</span><span style="color:#111">.</span><span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">ReadTx</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">RLock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">revs</span><span style="color:#111">,</span> <span style="color:#75af00">vs</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">UnsafeRange</span><span style="color:#111">(</span><span style="color:#75af00">schema</span><span style="color:#111">.</span><span style="color:#75af00">Key</span><span style="color:#111">,</span> <span style="color:#75af00">minBytes</span><span style="color:#111">,</span> <span style="color:#75af00">maxBytes</span><span style="color:#111">,</span> <span style="color:#ae81ff">0</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">evs</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">kvsToEvents</span><span style="color:#111">(</span><span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">store</span><span style="color:#111">.</span><span style="color:#75af00">lg</span><span style="color:#111">,</span> <span style="color:#75af00">wg</span><span style="color:#111">,</span> <span style="color:#75af00">revs</span><span style="color:#111">,</span> <span style="color:#75af00">vs</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 必须在kvsToEvents之后解锁，因为vs（来自boltdb内存）不是深拷贝。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 我们只能在Unmarshal之后解锁，这将进行深拷贝。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 否则我们将在boltdb重新mmap期间触发SIGSEGV。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">RUnlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 创建一个新的观察者批次</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">victims</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#75af00">watcherBatch</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">wb</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">newWatcherBatch</span><span style="color:#111">(</span><span style="color:#75af00">wg</span><span style="color:#111">,</span> <span style="color:#75af00">evs</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">w</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">wg</span><span style="color:#111">.</span><span style="color:#75af00">watchers</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">w</span><span style="color:#111">.</span><span style="color:#75af00">minRev</span> <span style="color:#111">&lt;</span> <span style="color:#75af00">compactionRev</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 跳过因压缩而无法发送响应的观察者</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">continue</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">w</span><span style="color:#111">.</span><span style="color:#75af00">minRev</span> <span style="color:#111">=</span> <span style="color:#75af00">curRev</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">eb</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">wb</span><span style="color:#111">[</span><span style="color:#75af00">w</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 将未通知的观察者移至同步</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">synced</span><span style="color:#111">.</span><span style="color:#75af00">add</span><span style="color:#111">(</span><span style="color:#75af00">w</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">unsynced</span><span style="color:#111">.</span><span style="color:#111">delete</span><span style="color:#111">(</span><span style="color:#75af00">w</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">continue</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">eb</span><span style="color:#111">.</span><span style="color:#75af00">moreRev</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">w</span><span style="color:#111">.</span><span style="color:#75af00">minRev</span> <span style="color:#111">=</span> <span style="color:#75af00">eb</span><span style="color:#111">.</span><span style="color:#75af00">moreRev</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 发送响应</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">w</span><span style="color:#111">.</span><span style="color:#75af00">send</span><span style="color:#111">(</span><span style="color:#75af00">WatchResponse</span><span style="color:#111">{</span><span style="color:#75af00">WatchID</span><span style="color:#111">:</span> <span style="color:#75af00">w</span><span style="color:#111">.</span><span style="color:#75af00">id</span><span style="color:#111">,</span> <span style="color:#75af00">Events</span><span style="color:#111">:</span> <span style="color:#75af00">eb</span><span style="color:#111">.</span><span style="color:#75af00">evs</span><span style="color:#111">,</span> <span style="color:#75af00">Revision</span><span style="color:#111">:</span> <span style="color:#75af00">curRev</span><span style="color:#111">})</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">pendingEventsGauge</span><span style="color:#111">.</span><span style="color:#75af00">Add</span><span style="color:#111">(</span><span style="color:#111">float64</span><span style="color:#111">(</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">eb</span><span style="color:#111">.</span><span style="color:#75af00">evs</span><span style="color:#111">)))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">w</span><span style="color:#111">.</span><span style="color:#75af00">victim</span> <span style="color:#111">=</span> <span style="color:#00a8c8">true</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 处理受害者观察者</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">w</span><span style="color:#111">.</span><span style="color:#75af00">victim</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">victims</span><span style="color:#111">[</span><span style="color:#75af00">w</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#75af00">eb</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">eb</span><span style="color:#111">.</span><span style="color:#75af00">moreRev</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// 保持未同步状态；还有更多要读取</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">continue</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">synced</span><span style="color:#111">.</span><span style="color:#75af00">add</span><span style="color:#111">(</span><span style="color:#75af00">w</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">unsynced</span><span style="color:#111">.</span><span style="color:#111">delete</span><span style="color:#111">(</span><span style="color:#75af00">w</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">addVictim</span><span style="color:#111">(</span><span style="color:#75af00">victims</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 更新慢速观察者计数器</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">vsz</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">v</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">victims</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">vsz</span> <span style="color:#f92672">+=</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">v</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">slowWatcherGauge</span><span style="color:#111">.</span><span style="color:#75af00">Set</span><span style="color:#111">(</span><span style="color:#111">float64</span><span style="color:#111">(</span><span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">unsynced</span><span style="color:#111">.</span><span style="color:#75af00">size</span><span style="color:#111">()</span> <span style="color:#f92672">+</span> <span style="color:#75af00">vsz</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">unsynced</span><span style="color:#111">.</span><span style="color:#75af00">size</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h4 id="watcher--send">watcher &amp; send</h4>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">watcher</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// the watcher key</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">key</span> <span style="color:#111">[]</span><span style="color:#00a8c8">byte</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// end indicates the end of the range to watch.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// If end is set, the watcher is on a range.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">end</span> <span style="color:#111">[]</span><span style="color:#00a8c8">byte</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// victim is set when ch is blocked and undergoing victim processing</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">victim</span> <span style="color:#00a8c8">bool</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// compacted is set when the watcher is removed because of compaction</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">compacted</span> <span style="color:#00a8c8">bool</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// restore is true when the watcher is being restored from leader snapshot</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// which means that this watcher has just been moved from &#34;synced&#34; to &#34;unsynced&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// watcher group, possibly with a future revision when it was first added</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// to the synced watcher</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// &#34;unsynced&#34; watcher revision must always be &lt;= current revision,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// except when the watcher were to be moved from &#34;synced&#34; watcher group</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">restore</span> <span style="color:#00a8c8">bool</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// minRev is the minimum revision update the watcher will accept</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">minRev</span> <span style="color:#00a8c8">int64</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">id</span>     <span style="color:#75af00">WatchID</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fcs</span> <span style="color:#111">[]</span><span style="color:#75af00">FilterFunc</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// a chan to send out the watch response.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// The chan might be shared with other watchers.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ch</span> <span style="color:#00a8c8">chan</span><span style="color:#f92672">&lt;-</span> <span style="color:#75af00">WatchResponse</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">w</span> <span style="color:#f92672">*</span><span style="color:#75af00">watcher</span><span style="color:#111">)</span> <span style="color:#75af00">send</span><span style="color:#111">(</span><span style="color:#75af00">wr</span> <span style="color:#75af00">WatchResponse</span><span style="color:#111">)</span> <span style="color:#00a8c8">bool</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">progressEvent</span> <span style="color:#f92672">:=</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">wr</span><span style="color:#111">.</span><span style="color:#75af00">Events</span><span style="color:#111">)</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">w</span><span style="color:#111">.</span><span style="color:#75af00">fcs</span><span style="color:#111">)</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">ne</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">([]</span><span style="color:#75af00">mvccpb</span><span style="color:#111">.</span><span style="color:#75af00">Event</span><span style="color:#111">,</span> <span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">wr</span><span style="color:#111">.</span><span style="color:#75af00">Events</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">for</span> <span style="color:#75af00">i</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">wr</span><span style="color:#111">.</span><span style="color:#75af00">Events</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">filtered</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">false</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">filter</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">w</span><span style="color:#111">.</span><span style="color:#75af00">fcs</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">if</span> <span style="color:#75af00">filter</span><span style="color:#111">(</span><span style="color:#75af00">wr</span><span style="color:#111">.</span><span style="color:#75af00">Events</span><span style="color:#111">[</span><span style="color:#75af00">i</span><span style="color:#111">])</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">filtered</span> <span style="color:#111">=</span> <span style="color:#00a8c8">true</span>
</span></span><span style="display:flex;"><span>					<span style="color:#00a8c8">break</span>
</span></span><span style="display:flex;"><span>				<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">filtered</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">ne</span> <span style="color:#111">=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">ne</span><span style="color:#111">,</span> <span style="color:#75af00">wr</span><span style="color:#111">.</span><span style="color:#75af00">Events</span><span style="color:#111">[</span><span style="color:#75af00">i</span><span style="color:#111">])</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">wr</span><span style="color:#111">.</span><span style="color:#75af00">Events</span> <span style="color:#111">=</span> <span style="color:#75af00">ne</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// if all events are filtered out, we should send nothing.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">progressEvent</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">wr</span><span style="color:#111">.</span><span style="color:#75af00">Events</span><span style="color:#111">)</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">true</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">select</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">case</span> <span style="color:#75af00">w</span><span style="color:#111">.</span><span style="color:#75af00">ch</span> <span style="color:#f92672">&lt;-</span> <span style="color:#75af00">wr</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">true</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">default</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">false</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="syncvictimsloop">syncVictimsLoop</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// syncVictimsLoop 尝试将预先计算的观察者响应写入被阻塞的观察者通道</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">s</span> <span style="color:#f92672">*</span><span style="color:#75af00">watchableStore</span><span style="color:#111">)</span> <span style="color:#75af00">syncVictimsLoop</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">wg</span><span style="color:#111">.</span><span style="color:#75af00">Done</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 尝试更新所有受害者观察者</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">for</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">moveVictims</span><span style="color:#111">()</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 持续更新，直到所有受害者观察者都处理完毕</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 检查是否有受害者观察者</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">RLock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">isEmpty</span> <span style="color:#f92672">:=</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">victims</span><span style="color:#111">)</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">RUnlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">var</span> <span style="color:#75af00">tickc</span> <span style="color:#f92672">&lt;-</span><span style="color:#00a8c8">chan</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Time</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">isEmpty</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">tickc</span> <span style="color:#111">=</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">After</span><span style="color:#111">(</span><span style="color:#ae81ff">10</span> <span style="color:#f92672">*</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Millisecond</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 等待10毫秒或收到新的受害者通知或停止信号</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">select</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#75af00">tickc</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">victimc</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">stopc</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// moveVictims 尝试使用已存在的事件数据更新观察者</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">s</span> <span style="color:#f92672">*</span><span style="color:#75af00">watchableStore</span><span style="color:#111">)</span> <span style="color:#75af00">moveVictims</span><span style="color:#111">()</span> <span style="color:#111">(</span><span style="color:#75af00">moved</span> <span style="color:#00a8c8">int</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">Lock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">victims</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">victims</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">victims</span> <span style="color:#111">=</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">Unlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">var</span> <span style="color:#75af00">newVictim</span> <span style="color:#75af00">watcherBatch</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">wb</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">victims</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 再次尝试发送响应</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">for</span> <span style="color:#75af00">w</span><span style="color:#111">,</span> <span style="color:#75af00">eb</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">wb</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 观察者已观察到存储，直到但不包括 w.minRev</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">rev</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">w</span><span style="color:#111">.</span><span style="color:#75af00">minRev</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">w</span><span style="color:#111">.</span><span style="color:#75af00">send</span><span style="color:#111">(</span><span style="color:#75af00">WatchResponse</span><span style="color:#111">{</span><span style="color:#75af00">WatchID</span><span style="color:#111">:</span> <span style="color:#75af00">w</span><span style="color:#111">.</span><span style="color:#75af00">id</span><span style="color:#111">,</span> <span style="color:#75af00">Events</span><span style="color:#111">:</span> <span style="color:#75af00">eb</span><span style="color:#111">.</span><span style="color:#75af00">evs</span><span style="color:#111">,</span> <span style="color:#75af00">Revision</span><span style="color:#111">:</span> <span style="color:#75af00">rev</span><span style="color:#111">})</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">pendingEventsGauge</span><span style="color:#111">.</span><span style="color:#75af00">Add</span><span style="color:#111">(</span><span style="color:#111">float64</span><span style="color:#111">(</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">eb</span><span style="color:#111">.</span><span style="color:#75af00">evs</span><span style="color:#111">)))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">if</span> <span style="color:#75af00">newVictim</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">newVictim</span> <span style="color:#111">=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#75af00">watcherBatch</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">newVictim</span><span style="color:#111">[</span><span style="color:#75af00">w</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#75af00">eb</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">continue</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">moved</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 将完成的受害者观察者分配到未同步/同步组</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">Lock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">store</span><span style="color:#111">.</span><span style="color:#75af00">revMu</span><span style="color:#111">.</span><span style="color:#75af00">RLock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">curRev</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">store</span><span style="color:#111">.</span><span style="color:#75af00">currentRev</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">for</span> <span style="color:#75af00">w</span><span style="color:#111">,</span> <span style="color:#75af00">eb</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">wb</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">newVictim</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">newVictim</span><span style="color:#111">[</span><span style="color:#75af00">w</span><span style="color:#111">]</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// 无法发送watch响应，仍然是受害者</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">continue</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">w</span><span style="color:#111">.</span><span style="color:#75af00">victim</span> <span style="color:#111">=</span> <span style="color:#00a8c8">false</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">eb</span><span style="color:#111">.</span><span style="color:#75af00">moreRev</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">w</span><span style="color:#111">.</span><span style="color:#75af00">minRev</span> <span style="color:#111">=</span> <span style="color:#75af00">eb</span><span style="color:#111">.</span><span style="color:#75af00">moreRev</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">w</span><span style="color:#111">.</span><span style="color:#75af00">minRev</span> <span style="color:#f92672">&lt;=</span> <span style="color:#75af00">curRev</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">unsynced</span><span style="color:#111">.</span><span style="color:#75af00">add</span><span style="color:#111">(</span><span style="color:#75af00">w</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">slowWatcherGauge</span><span style="color:#111">.</span><span style="color:#75af00">Dec</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">synced</span><span style="color:#111">.</span><span style="color:#75af00">add</span><span style="color:#111">(</span><span style="color:#75af00">w</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">store</span><span style="color:#111">.</span><span style="color:#75af00">revMu</span><span style="color:#111">.</span><span style="color:#75af00">RUnlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">Unlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 如果仍然有未处理的受害者，重新添加到受害者列表中</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">newVictim</span><span style="color:#111">)</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">Lock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">victims</span> <span style="color:#111">=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">victims</span><span style="color:#111">,</span> <span style="color:#75af00">newVictim</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">Unlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">moved</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="reference">Reference</h2>
<ul>
<li><a href="https://blog.csdn.net/qq_24433609/article/details/120653747">https://blog.csdn.net/qq_24433609/article/details/120653747</a></li>
</ul>
]]></content:encoded><category>cloud</category><category>boltdb</category><category>etcd</category><category>golang</category><category>数据库</category><category>kubernetes</category></item><item><title>etcd MVCC 存储结构及流程</title><link>https://daemon365.dev/post/cloud/etcd_mvcc_storage_structure_and_process/</link><pubDate>Sun, 26 May 2024 18:00:00 +0800</pubDate><guid>https://daemon365.dev/post/cloud/etcd_mvcc_storage_structure_and_process/</guid><description>&lt;h2 id="什么是-mvcc"&gt;什么是 MVCC&lt;/h2&gt;
&lt;p&gt;MVCC 是 Multi-Version Concurrency Control 的缩写，即多版本并发控制。它是一种并发控制的方法，用于在数据库系统中实现事务的隔离性。MVCC 是一种乐观锁机制，它通过保存数据的多个版本来实现事务的隔禽性。在 etcd 中，MVCC 是用于实现数据的版本控制的。而且可以查看历史版本的数据。&lt;/p&gt;
&lt;h2 id="测试"&gt;测试&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-BASH" data-lang="BASH"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;# 添加数据&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;etcdctl put /test t1
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;OK
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;etcdctl put /test t2
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;OK
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;# 查看数据&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;etcdctl get /test
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;/test
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;t2
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;# 查看 json 格式数据&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;etcdctl get /test --write-out&lt;span style="color:#f92672"&gt;=&lt;/span&gt;json
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;# {&amp;#34;header&amp;#34;:{&amp;#34;cluster_id&amp;#34;:8735285696067307020,&amp;#34;member_id&amp;#34;:7131777314758672153,&amp;#34;revision&amp;#34;:15,&amp;#34;raft_term&amp;#34;:4},&amp;#34;kvs&amp;#34;:[{&amp;#34;key&amp;#34;:&amp;#34;L3Rlc3Q=&amp;#34;,&amp;#34;create_revision&amp;#34;:14,&amp;#34;mod_revision&amp;#34;:15,&amp;#34;version&amp;#34;:2,&amp;#34;value&amp;#34;:&amp;#34;dDI=&amp;#34;}],&amp;#34;count&amp;#34;:1}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;# 查看历史版本&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;etcdctl get /test --rev&lt;span style="color:#f92672"&gt;=&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;14&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;/test
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;t1
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;可以看到，通过 &lt;code&gt;--rev&lt;/code&gt; 参数可以查看历史版本的数据。也就是我第一次添加的数据。那么 json 中 revision 是什么意思呢？&lt;/p&gt;
&lt;h2 id="revision"&gt;revision&lt;/h2&gt;
&lt;p&gt;reversion 中是 etcd 中的一个概念，它是一个递增的整数，用于标识 etcd 中的数据版本。他是一个 int64 类型。没操作一次 etcd 数据（增，删，改），reversion 就会递增。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-BASH" data-lang="BASH"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;# 删除数据&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;etcdctl del /test
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#ae81ff"&gt;1&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;# 查看 revision&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;etcdctl get / -wjson
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;# {&amp;#34;header&amp;#34;:{&amp;#34;cluster_id&amp;#34;:8735285696067307020,&amp;#34;member_id&amp;#34;:7131777314758672153,&amp;#34;revision&amp;#34;:16,&amp;#34;raft_term&amp;#34;:4}}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;# 刚才是 15 现在是 16&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;# 添加 /test2 数据&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;etcdctl put /test2 t3
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;OK
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;# 查看 revision&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;etcdctl get / -wjson
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;# {&amp;#34;header&amp;#34;:{&amp;#34;cluster_id&amp;#34;:8735285696067307020,&amp;#34;member_id&amp;#34;:7131777314758672153,&amp;#34;revision&amp;#34;:17,&amp;#34;raft_term&amp;#34;:4}}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id="存储结构"&gt;存储结构&lt;/h2&gt;
&lt;p&gt;etcd mvcc 中，维护了两个数据结构，分别是 treeindex 和 &lt;a href="https://github.com/etcd-io/bbolt.git"&gt;boltDB&lt;/a&gt;。treeindex 是一个 B 树，用于存储 key 和 revision 之间的映射关系，它主要维护在内存中。而 boltDB 是一个 key-value 数据库，用于存储 key 和 value 之间的映射关系, 它主要维护在磁盘中, 用于持久化数据，虽然 boltdb 使用了 mmap 机制，但是它还是一个磁盘数据库。&lt;/p&gt;</description><content:encoded><![CDATA[<h2 id="什么是-mvcc">什么是 MVCC</h2>
<p>MVCC 是 Multi-Version Concurrency Control 的缩写，即多版本并发控制。它是一种并发控制的方法，用于在数据库系统中实现事务的隔离性。MVCC 是一种乐观锁机制，它通过保存数据的多个版本来实现事务的隔禽性。在 etcd 中，MVCC 是用于实现数据的版本控制的。而且可以查看历史版本的数据。</p>
<h2 id="测试">测试</h2>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-BASH" data-lang="BASH"><span style="display:flex;"><span><span style="color:#75715e"># 添加数据</span>
</span></span><span style="display:flex;"><span>etcdctl put /test t1
</span></span><span style="display:flex;"><span>OK
</span></span><span style="display:flex;"><span>etcdctl put /test t2
</span></span><span style="display:flex;"><span>OK
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看数据</span>
</span></span><span style="display:flex;"><span>etcdctl get /test
</span></span><span style="display:flex;"><span>/test
</span></span><span style="display:flex;"><span>t2
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看 json 格式数据</span>
</span></span><span style="display:flex;"><span>etcdctl get /test --write-out<span style="color:#f92672">=</span>json
</span></span><span style="display:flex;"><span><span style="color:#75715e"># {&#34;header&#34;:{&#34;cluster_id&#34;:8735285696067307020,&#34;member_id&#34;:7131777314758672153,&#34;revision&#34;:15,&#34;raft_term&#34;:4},&#34;kvs&#34;:[{&#34;key&#34;:&#34;L3Rlc3Q=&#34;,&#34;create_revision&#34;:14,&#34;mod_revision&#34;:15,&#34;version&#34;:2,&#34;value&#34;:&#34;dDI=&#34;}],&#34;count&#34;:1}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看历史版本</span>
</span></span><span style="display:flex;"><span>etcdctl get /test --rev<span style="color:#f92672">=</span><span style="color:#ae81ff">14</span>
</span></span><span style="display:flex;"><span>/test
</span></span><span style="display:flex;"><span>t1
</span></span></code></pre></div><p>可以看到，通过 <code>--rev</code> 参数可以查看历史版本的数据。也就是我第一次添加的数据。那么 json 中 revision 是什么意思呢？</p>
<h2 id="revision">revision</h2>
<p>reversion 中是 etcd 中的一个概念，它是一个递增的整数，用于标识 etcd 中的数据版本。他是一个 int64 类型。没操作一次 etcd 数据（增，删，改），reversion 就会递增。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-BASH" data-lang="BASH"><span style="display:flex;"><span><span style="color:#75715e"># 删除数据</span>
</span></span><span style="display:flex;"><span>etcdctl del /test
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看 revision</span>
</span></span><span style="display:flex;"><span>etcdctl get / -wjson
</span></span><span style="display:flex;"><span><span style="color:#75715e"># {&#34;header&#34;:{&#34;cluster_id&#34;:8735285696067307020,&#34;member_id&#34;:7131777314758672153,&#34;revision&#34;:16,&#34;raft_term&#34;:4}}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 刚才是 15 现在是 16</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 添加 /test2 数据</span>
</span></span><span style="display:flex;"><span>etcdctl put /test2 t3
</span></span><span style="display:flex;"><span>OK
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看 revision</span>
</span></span><span style="display:flex;"><span>etcdctl get / -wjson
</span></span><span style="display:flex;"><span><span style="color:#75715e"># {&#34;header&#34;:{&#34;cluster_id&#34;:8735285696067307020,&#34;member_id&#34;:7131777314758672153,&#34;revision&#34;:17,&#34;raft_term&#34;:4}}</span>
</span></span></code></pre></div><h2 id="存储结构">存储结构</h2>
<p>etcd mvcc 中，维护了两个数据结构，分别是 treeindex 和 <a href="https://github.com/etcd-io/bbolt.git">boltDB</a>。treeindex 是一个 B 树，用于存储 key 和 revision 之间的映射关系，它主要维护在内存中。而 boltDB 是一个 key-value 数据库，用于存储 key 和 value 之间的映射关系, 它主要维护在磁盘中, 用于持久化数据，虽然 boltdb 使用了 mmap 机制，但是它还是一个磁盘数据库。</p>
<h3 id="treeindex">treeindex</h3>
<p><strong>为什么 etcd 的 treeindex 使用 B-tree 而不使用哈希表、平衡二叉树？</strong></p>
<p>因为 etcd 需要范围查询，所以哈希表不适合。而且etcd 中的 key 过多，平衡二叉树的查询效率不高，所以使用 B tree。</p>
<p>b-tree:</p>
<p><img src="/images/97246cb8-633b-4ee2-a1a1-2ef0b4a059a4.png" alt=""></p>
<p>在 treeindex 中，数据的每个 key 是一个 keyIndex 结构，它保存了 key 和 revision 之间的映射关系。keyIndex 结构如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-GO" data-lang="GO"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">keyIndex</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">key</span>         <span style="color:#111">[]</span><span style="color:#00a8c8">byte</span> <span style="color:#75715e">// key 的值</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">modified</span>    <span style="color:#75af00">Revision</span> <span style="color:#75715e">// 最后一次修改的 main revision</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">generations</span> <span style="color:#111">[]</span><span style="color:#75af00">generation</span> <span style="color:#75715e">// 保存了 key 的历史版本 没删除一次然后添加一次就是一个 generation</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Revision</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 就是 revision 的值，比如上边的 15 等</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Main</span> <span style="color:#00a8c8">int64</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 子 revision 的值 主要是在事务中使用 比如事务中多个操作 那么就是 0 1 2 3 等</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Sub</span> <span style="color:#00a8c8">int64</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// generation 保存了 key 的历史版本</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">generation</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ver</span>     <span style="color:#00a8c8">int64</span> <span style="color:#75715e">// 版本号</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">created</span> <span style="color:#75af00">Revision</span> <span style="color:#75715e">// 最后一次被创建的 revision</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">revs</span>    <span style="color:#111">[]</span><span style="color:#75af00">Revision</span> <span style="color:#75715e">// 保存了 key 的历史 revision</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>在 treeindex 中，每个 keyIndex 保存了 key 的历史版本，而且每个 keyIndex 中的 generations 保存了 key 的历史版本。而且每个 generation 中的 revs 保存了 key 的历史 revision。这样就可以实现历史版本的查询。</p>
<p><strong>获取 resersion 的值</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-GO" data-lang="GO"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">ti</span> <span style="color:#f92672">*</span><span style="color:#75af00">treeIndex</span><span style="color:#111">)</span> <span style="color:#75af00">Get</span><span style="color:#111">(</span><span style="color:#75af00">key</span> <span style="color:#111">[]</span><span style="color:#00a8c8">byte</span><span style="color:#111">,</span> <span style="color:#75af00">atRev</span> <span style="color:#00a8c8">int64</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#75af00">modified</span><span style="color:#111">,</span> <span style="color:#75af00">created</span> <span style="color:#75af00">Revision</span><span style="color:#111">,</span> <span style="color:#75af00">ver</span> <span style="color:#00a8c8">int64</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ti</span><span style="color:#111">.</span><span style="color:#75af00">RLock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">ti</span><span style="color:#111">.</span><span style="color:#75af00">RUnlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">ti</span><span style="color:#111">.</span><span style="color:#75af00">unsafeGet</span><span style="color:#111">(</span><span style="color:#75af00">key</span><span style="color:#111">,</span> <span style="color:#75af00">atRev</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">ti</span> <span style="color:#f92672">*</span><span style="color:#75af00">treeIndex</span><span style="color:#111">)</span> <span style="color:#75af00">unsafeGet</span><span style="color:#111">(</span><span style="color:#75af00">key</span> <span style="color:#111">[]</span><span style="color:#00a8c8">byte</span><span style="color:#111">,</span> <span style="color:#75af00">atRev</span> <span style="color:#00a8c8">int64</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#75af00">modified</span><span style="color:#111">,</span> <span style="color:#75af00">created</span> <span style="color:#75af00">Revision</span><span style="color:#111">,</span> <span style="color:#75af00">ver</span> <span style="color:#00a8c8">int64</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">keyi</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">keyIndex</span><span style="color:#111">{</span><span style="color:#75af00">key</span><span style="color:#111">:</span> <span style="color:#75af00">key</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 从 B 树中获取 keyIndex</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">keyi</span> <span style="color:#111">=</span> <span style="color:#75af00">ti</span><span style="color:#111">.</span><span style="color:#75af00">keyIndex</span><span style="color:#111">(</span><span style="color:#75af00">keyi</span><span style="color:#111">);</span> <span style="color:#75af00">keyi</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">Revision</span><span style="color:#111">{},</span> <span style="color:#75af00">Revision</span><span style="color:#111">{},</span> <span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#75af00">ErrRevisionNotFound</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 从 keyIndex 中获取 revision</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">keyi</span><span style="color:#111">.</span><span style="color:#75af00">get</span><span style="color:#111">(</span><span style="color:#75af00">ti</span><span style="color:#111">.</span><span style="color:#75af00">lg</span><span style="color:#111">,</span> <span style="color:#75af00">atRev</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">ti</span> <span style="color:#f92672">*</span><span style="color:#75af00">treeIndex</span><span style="color:#111">)</span> <span style="color:#75af00">keyIndex</span><span style="color:#111">(</span><span style="color:#75af00">keyi</span> <span style="color:#f92672">*</span><span style="color:#75af00">keyIndex</span><span style="color:#111">)</span> <span style="color:#f92672">*</span><span style="color:#75af00">keyIndex</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">ki</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">ti</span><span style="color:#111">.</span><span style="color:#75af00">tree</span><span style="color:#111">.</span><span style="color:#75af00">Get</span><span style="color:#111">(</span><span style="color:#75af00">keyi</span><span style="color:#111">);</span> <span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">ki</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-GO" data-lang="GO"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">ki</span> <span style="color:#f92672">*</span><span style="color:#75af00">keyIndex</span><span style="color:#111">)</span> <span style="color:#75af00">get</span><span style="color:#111">(</span><span style="color:#75af00">lg</span> <span style="color:#f92672">*</span><span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">Logger</span><span style="color:#111">,</span> <span style="color:#75af00">atRev</span> <span style="color:#00a8c8">int64</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#75af00">modified</span><span style="color:#111">,</span> <span style="color:#75af00">created</span> <span style="color:#75af00">Revision</span><span style="color:#111">,</span> <span style="color:#75af00">ver</span> <span style="color:#00a8c8">int64</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">ki</span><span style="color:#111">.</span><span style="color:#75af00">isEmpty</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">lg</span><span style="color:#111">.</span><span style="color:#75af00">Panic</span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>			<span style="color:#d88200">&#34;&#39;get&#39; got an unexpected empty keyIndex&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">String</span><span style="color:#111">(</span><span style="color:#d88200">&#34;key&#34;</span><span style="color:#111">,</span> <span style="color:#111">string</span><span style="color:#111">(</span><span style="color:#75af00">ki</span><span style="color:#111">.</span><span style="color:#75af00">key</span><span style="color:#111">)),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 找到 key 的 generation</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">g</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">ki</span><span style="color:#111">.</span><span style="color:#75af00">findGeneration</span><span style="color:#111">(</span><span style="color:#75af00">atRev</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">isEmpty</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">Revision</span><span style="color:#111">{},</span> <span style="color:#75af00">Revision</span><span style="color:#111">{},</span> <span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#75af00">ErrRevisionNotFound</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 从 generation 中获取 revision 找到第一次小于 atRev 的 revision</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">n</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">walk</span><span style="color:#111">(</span><span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">rev</span> <span style="color:#75af00">Revision</span><span style="color:#111">)</span> <span style="color:#00a8c8">bool</span> <span style="color:#111">{</span> <span style="color:#00a8c8">return</span> <span style="color:#75af00">rev</span><span style="color:#111">.</span><span style="color:#75af00">Main</span> <span style="color:#111">&gt;</span> <span style="color:#75af00">atRev</span> <span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">n</span> <span style="color:#f92672">!=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">revs</span><span style="color:#111">[</span><span style="color:#75af00">n</span><span style="color:#111">],</span> <span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">created</span><span style="color:#111">,</span> <span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">ver</span> <span style="color:#f92672">-</span> <span style="color:#111">int64</span><span style="color:#111">(</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">revs</span><span style="color:#111">)</span><span style="color:#f92672">-</span><span style="color:#75af00">n</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">),</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">Revision</span><span style="color:#111">{},</span> <span style="color:#75af00">Revision</span><span style="color:#111">{},</span> <span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#75af00">ErrRevisionNotFound</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 基本的意思就是从后往前找到第一个 revision 小于 atRev 的 generation</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">ki</span> <span style="color:#f92672">*</span><span style="color:#75af00">keyIndex</span><span style="color:#111">)</span> <span style="color:#75af00">findGeneration</span><span style="color:#111">(</span><span style="color:#75af00">rev</span> <span style="color:#00a8c8">int64</span><span style="color:#111">)</span> <span style="color:#f92672">*</span><span style="color:#75af00">generation</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">lastg</span> <span style="color:#f92672">:=</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">ki</span><span style="color:#111">.</span><span style="color:#75af00">generations</span><span style="color:#111">)</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">cg</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">lastg</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">cg</span> <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">ki</span><span style="color:#111">.</span><span style="color:#75af00">generations</span><span style="color:#111">[</span><span style="color:#75af00">cg</span><span style="color:#111">].</span><span style="color:#75af00">revs</span><span style="color:#111">)</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">cg</span><span style="color:#f92672">--</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">continue</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">g</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">ki</span><span style="color:#111">.</span><span style="color:#75af00">generations</span><span style="color:#111">[</span><span style="color:#75af00">cg</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">cg</span> <span style="color:#f92672">!=</span> <span style="color:#75af00">lastg</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 如果当前 generation 的最后一个 revision 小于等于 rev 那么就返回 nil</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">tomb</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">revs</span><span style="color:#111">[</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">revs</span><span style="color:#111">)</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">].</span><span style="color:#75af00">Main</span><span style="color:#111">;</span> <span style="color:#75af00">tomb</span> <span style="color:#f92672">&lt;=</span> <span style="color:#75af00">rev</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">revs</span><span style="color:#111">[</span><span style="color:#ae81ff">0</span><span style="color:#111">].</span><span style="color:#75af00">Main</span> <span style="color:#f92672">&lt;=</span> <span style="color:#75af00">rev</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">ki</span><span style="color:#111">.</span><span style="color:#75af00">generations</span><span style="color:#111">[</span><span style="color:#75af00">cg</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">cg</span><span style="color:#f92672">--</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// walk 从后往前遍历 generation</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">g</span> <span style="color:#f92672">*</span><span style="color:#75af00">generation</span><span style="color:#111">)</span> <span style="color:#75af00">walk</span><span style="color:#111">(</span><span style="color:#75af00">f</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">rev</span> <span style="color:#75af00">Revision</span><span style="color:#111">)</span> <span style="color:#00a8c8">bool</span><span style="color:#111">)</span> <span style="color:#00a8c8">int</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">l</span> <span style="color:#f92672">:=</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">revs</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">i</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">revs</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">f</span><span style="color:#111">(</span><span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">revs</span><span style="color:#111">[</span><span style="color:#75af00">l</span><span style="color:#f92672">-</span><span style="color:#75af00">i</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">])</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#75af00">l</span> <span style="color:#f92672">-</span> <span style="color:#75af00">i</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="boltdb">boltdb</h3>
<p>上边的 treeindex 拿到 revision 之后，并没有拿到 value，那么如何拿到 value 呢？这就需要用到 boltdb 了。boltdb 是一个 key-value 数据库，用于存储 key 和 value 之间的映射关系。在 etcd 中，boltdb 主要用于持久化数据。
在 etcd 中，boltdb 报错的不是 etcd key-value 数据，而他的 ket 是 revision，value 是元数据。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-GO" data-lang="GO"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">tr</span> <span style="color:#f92672">*</span><span style="color:#75af00">storeTxnCommon</span><span style="color:#111">)</span> <span style="color:#75af00">rangeKeys</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">,</span> <span style="color:#75af00">key</span><span style="color:#111">,</span> <span style="color:#75af00">end</span> <span style="color:#111">[]</span><span style="color:#00a8c8">byte</span><span style="color:#111">,</span> <span style="color:#75af00">curRev</span> <span style="color:#00a8c8">int64</span><span style="color:#111">,</span> <span style="color:#75af00">ro</span> <span style="color:#75af00">RangeOptions</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">RangeResult</span><span style="color:#111">,</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">rev</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">ro</span><span style="color:#111">.</span><span style="color:#75af00">Rev</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 如果 rev 大于当前的 revision 那么就返回 ErrFutureRev</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">rev</span> <span style="color:#111">&gt;</span> <span style="color:#75af00">curRev</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">RangeResult</span><span style="color:#111">{</span><span style="color:#75af00">KVs</span><span style="color:#111">:</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">Count</span><span style="color:#111">:</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">,</span> <span style="color:#75af00">Rev</span><span style="color:#111">:</span> <span style="color:#75af00">curRev</span><span style="color:#111">},</span> <span style="color:#75af00">ErrFutureRev</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 如果 rev 小于等于 0 那么就是当前的 revision</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">rev</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">rev</span> <span style="color:#111">=</span> <span style="color:#75af00">curRev</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 如果 rev 小于 compactMainRev 那么就返回 ErrCompacted</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">rev</span> <span style="color:#111">&lt;</span> <span style="color:#75af00">tr</span><span style="color:#111">.</span><span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">compactMainRev</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">RangeResult</span><span style="color:#111">{</span><span style="color:#75af00">KVs</span><span style="color:#111">:</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">Count</span><span style="color:#111">:</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">,</span> <span style="color:#75af00">Rev</span><span style="color:#111">:</span> <span style="color:#ae81ff">0</span><span style="color:#111">},</span> <span style="color:#75af00">ErrCompacted</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 如果 re.Count 代表 count 操作 查出来直接返回数量就可以了 不需要在查 value</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">ro</span><span style="color:#111">.</span><span style="color:#75af00">Count</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">total</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">tr</span><span style="color:#111">.</span><span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">kvindex</span><span style="color:#111">.</span><span style="color:#75af00">CountRevisions</span><span style="color:#111">(</span><span style="color:#75af00">key</span><span style="color:#111">,</span> <span style="color:#75af00">end</span><span style="color:#111">,</span> <span style="color:#75af00">rev</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">tr</span><span style="color:#111">.</span><span style="color:#75af00">trace</span><span style="color:#111">.</span><span style="color:#75af00">Step</span><span style="color:#111">(</span><span style="color:#d88200">&#34;count revisions from in-memory index tree&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">RangeResult</span><span style="color:#111">{</span><span style="color:#75af00">KVs</span><span style="color:#111">:</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">Count</span><span style="color:#111">:</span> <span style="color:#75af00">total</span><span style="color:#111">,</span> <span style="color:#75af00">Rev</span><span style="color:#111">:</span> <span style="color:#75af00">curRev</span><span style="color:#111">},</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 查好需要的 revision 之后，从 boltdb 中查出 value ，revpairs 是从 treeindex 中查出来的 revisions</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">revpairs</span><span style="color:#111">,</span> <span style="color:#75af00">total</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">tr</span><span style="color:#111">.</span><span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">kvindex</span><span style="color:#111">.</span><span style="color:#75af00">Revisions</span><span style="color:#111">(</span><span style="color:#75af00">key</span><span style="color:#111">,</span> <span style="color:#75af00">end</span><span style="color:#111">,</span> <span style="color:#75af00">rev</span><span style="color:#111">,</span> <span style="color:#111">int</span><span style="color:#111">(</span><span style="color:#75af00">ro</span><span style="color:#111">.</span><span style="color:#75af00">Limit</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">tr</span><span style="color:#111">.</span><span style="color:#75af00">trace</span><span style="color:#111">.</span><span style="color:#75af00">Step</span><span style="color:#111">(</span><span style="color:#d88200">&#34;range keys from in-memory index tree&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">revpairs</span><span style="color:#111">)</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">RangeResult</span><span style="color:#111">{</span><span style="color:#75af00">KVs</span><span style="color:#111">:</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">Count</span><span style="color:#111">:</span> <span style="color:#75af00">total</span><span style="color:#111">,</span> <span style="color:#75af00">Rev</span><span style="color:#111">:</span> <span style="color:#75af00">curRev</span><span style="color:#111">},</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">limit</span> <span style="color:#f92672">:=</span> <span style="color:#111">int</span><span style="color:#111">(</span><span style="color:#75af00">ro</span><span style="color:#111">.</span><span style="color:#75af00">Limit</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">limit</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">||</span> <span style="color:#75af00">limit</span> <span style="color:#111">&gt;</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">revpairs</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">limit</span> <span style="color:#111">=</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">revpairs</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">kvs</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">([]</span><span style="color:#75af00">mvccpb</span><span style="color:#111">.</span><span style="color:#75af00">KeyValue</span><span style="color:#111">,</span> <span style="color:#75af00">limit</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">revBytes</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">NewRevBytes</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 对于每个 revision 从 boltdb 中查出 value</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">i</span><span style="color:#111">,</span> <span style="color:#75af00">revpair</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">revpairs</span><span style="color:#111">[:</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">kvs</span><span style="color:#111">)]</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">select</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#75af00">ctx</span><span style="color:#111">.</span><span style="color:#75af00">Done</span><span style="color:#111">():</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;rangeKeys: context cancelled: %w&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">ctx</span><span style="color:#111">.</span><span style="color:#75af00">Err</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">default</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 把 revision 转换成 bytes</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">revBytes</span> <span style="color:#111">=</span> <span style="color:#75af00">RevToBytes</span><span style="color:#111">(</span><span style="color:#75af00">revpair</span><span style="color:#111">,</span> <span style="color:#75af00">revBytes</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 从 boltdb 中查出 value</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">vs</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">tr</span><span style="color:#111">.</span><span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">UnsafeRange</span><span style="color:#111">(</span><span style="color:#75af00">schema</span><span style="color:#111">.</span><span style="color:#75af00">Key</span><span style="color:#111">,</span> <span style="color:#75af00">revBytes</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#ae81ff">0</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">vs</span><span style="color:#111">)</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">1</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">tr</span><span style="color:#111">.</span><span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">lg</span><span style="color:#111">.</span><span style="color:#75af00">Fatal</span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>				<span style="color:#d88200">&#34;range failed to find revision pair&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">Int64</span><span style="color:#111">(</span><span style="color:#d88200">&#34;revision-main&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">revpair</span><span style="color:#111">.</span><span style="color:#75af00">Main</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">Int64</span><span style="color:#111">(</span><span style="color:#d88200">&#34;revision-sub&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">revpair</span><span style="color:#111">.</span><span style="color:#75af00">Sub</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">Int64</span><span style="color:#111">(</span><span style="color:#d88200">&#34;revision-current&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">curRev</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">Int64</span><span style="color:#111">(</span><span style="color:#d88200">&#34;range-option-rev&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">ro</span><span style="color:#111">.</span><span style="color:#75af00">Rev</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">Int64</span><span style="color:#111">(</span><span style="color:#d88200">&#34;range-option-limit&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">ro</span><span style="color:#111">.</span><span style="color:#75af00">Limit</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">Binary</span><span style="color:#111">(</span><span style="color:#d88200">&#34;key&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">key</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">Binary</span><span style="color:#111">(</span><span style="color:#d88200">&#34;end&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">end</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">Int</span><span style="color:#111">(</span><span style="color:#d88200">&#34;len-revpairs&#34;</span><span style="color:#111">,</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">revpairs</span><span style="color:#111">)),</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">Int</span><span style="color:#111">(</span><span style="color:#d88200">&#34;len-values&#34;</span><span style="color:#111">,</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">vs</span><span style="color:#111">)),</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 把 value 转换成 mvccpb.KeyValue</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">kvs</span><span style="color:#111">[</span><span style="color:#75af00">i</span><span style="color:#111">].</span><span style="color:#75af00">Unmarshal</span><span style="color:#111">(</span><span style="color:#75af00">vs</span><span style="color:#111">[</span><span style="color:#ae81ff">0</span><span style="color:#111">]);</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">tr</span><span style="color:#111">.</span><span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">lg</span><span style="color:#111">.</span><span style="color:#75af00">Fatal</span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>				<span style="color:#d88200">&#34;failed to unmarshal mvccpb.KeyValue&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">zap</span><span style="color:#111">.</span><span style="color:#75af00">Error</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">tr</span><span style="color:#111">.</span><span style="color:#75af00">trace</span><span style="color:#111">.</span><span style="color:#75af00">Step</span><span style="color:#111">(</span><span style="color:#d88200">&#34;range keys from bolt db&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">RangeResult</span><span style="color:#111">{</span><span style="color:#75af00">KVs</span><span style="color:#111">:</span> <span style="color:#75af00">kvs</span><span style="color:#111">,</span> <span style="color:#75af00">Count</span><span style="color:#111">:</span> <span style="color:#75af00">total</span><span style="color:#111">,</span> <span style="color:#75af00">Rev</span><span style="color:#111">:</span> <span style="color:#75af00">curRev</span><span style="color:#111">},</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// boltdb 的 key 结构 </span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">BucketKey</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Revision</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 墓碑标志 当删除的时候 先标记一下</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">tombstone</span> <span style="color:#00a8c8">bool</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-GO" data-lang="GO"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">baseReadTx</span> <span style="color:#f92672">*</span><span style="color:#75af00">baseReadTx</span><span style="color:#111">)</span> <span style="color:#75af00">UnsafeRange</span><span style="color:#111">(</span><span style="color:#75af00">bucketType</span> <span style="color:#75af00">Bucket</span><span style="color:#111">,</span> <span style="color:#75af00">key</span><span style="color:#111">,</span> <span style="color:#75af00">endKey</span> <span style="color:#111">[]</span><span style="color:#00a8c8">byte</span><span style="color:#111">,</span> <span style="color:#75af00">limit</span> <span style="color:#00a8c8">int64</span><span style="color:#111">)</span> <span style="color:#111">([][]</span><span style="color:#00a8c8">byte</span><span style="color:#111">,</span> <span style="color:#111">[][]</span><span style="color:#00a8c8">byte</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">endKey</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// forbid duplicates for single keys</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">limit</span> <span style="color:#111">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">limit</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">limit</span> <span style="color:#111">=</span> <span style="color:#75af00">math</span><span style="color:#111">.</span><span style="color:#75af00">MaxInt64</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">limit</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#111">!</span><span style="color:#75af00">bucketType</span><span style="color:#111">.</span><span style="color:#75af00">IsSafeRangeBucket</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#d88200">&#34;do not use unsafeRange on non-keys bucket&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 从缓存中拿出数据</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">keys</span><span style="color:#111">,</span> <span style="color:#75af00">vals</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">baseReadTx</span><span style="color:#111">.</span><span style="color:#75af00">buf</span><span style="color:#111">.</span><span style="color:#75af00">Range</span><span style="color:#111">(</span><span style="color:#75af00">bucketType</span><span style="color:#111">,</span> <span style="color:#75af00">key</span><span style="color:#111">,</span> <span style="color:#75af00">endKey</span><span style="color:#111">,</span> <span style="color:#75af00">limit</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#111">int64</span><span style="color:#111">(</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">keys</span><span style="color:#111">))</span> <span style="color:#f92672">==</span> <span style="color:#75af00">limit</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">keys</span><span style="color:#111">,</span> <span style="color:#75af00">vals</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// find/cache bucket</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">bn</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">bucketType</span><span style="color:#111">.</span><span style="color:#75af00">ID</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">baseReadTx</span><span style="color:#111">.</span><span style="color:#75af00">txMu</span><span style="color:#111">.</span><span style="color:#75af00">RLock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">bucket</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">baseReadTx</span><span style="color:#111">.</span><span style="color:#75af00">buckets</span><span style="color:#111">[</span><span style="color:#75af00">bn</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">baseReadTx</span><span style="color:#111">.</span><span style="color:#75af00">txMu</span><span style="color:#111">.</span><span style="color:#75af00">RUnlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">lockHeld</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">false</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">baseReadTx</span><span style="color:#111">.</span><span style="color:#75af00">txMu</span><span style="color:#111">.</span><span style="color:#75af00">Lock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">lockHeld</span> <span style="color:#111">=</span> <span style="color:#00a8c8">true</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">bucket</span> <span style="color:#111">=</span> <span style="color:#75af00">baseReadTx</span><span style="color:#111">.</span><span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">Bucket</span><span style="color:#111">(</span><span style="color:#75af00">bucketType</span><span style="color:#111">.</span><span style="color:#75af00">Name</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">baseReadTx</span><span style="color:#111">.</span><span style="color:#75af00">buckets</span><span style="color:#111">[</span><span style="color:#75af00">bn</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#75af00">bucket</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ignore missing bucket since may have been created in this batch</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">bucket</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">lockHeld</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">baseReadTx</span><span style="color:#111">.</span><span style="color:#75af00">txMu</span><span style="color:#111">.</span><span style="color:#75af00">Unlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">keys</span><span style="color:#111">,</span> <span style="color:#75af00">vals</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">lockHeld</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">baseReadTx</span><span style="color:#111">.</span><span style="color:#75af00">txMu</span><span style="color:#111">.</span><span style="color:#75af00">Lock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">c</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">bucket</span><span style="color:#111">.</span><span style="color:#75af00">Cursor</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">baseReadTx</span><span style="color:#111">.</span><span style="color:#75af00">txMu</span><span style="color:#111">.</span><span style="color:#75af00">Unlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 从 boltdb 中查出数据</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">k2</span><span style="color:#111">,</span> <span style="color:#75af00">v2</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">unsafeRange</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">,</span> <span style="color:#75af00">key</span><span style="color:#111">,</span> <span style="color:#75af00">endKey</span><span style="color:#111">,</span> <span style="color:#75af00">limit</span><span style="color:#f92672">-</span><span style="color:#111">int64</span><span style="color:#111">(</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">keys</span><span style="color:#111">)))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">k2</span><span style="color:#111">,</span> <span style="color:#75af00">keys</span><span style="color:#f92672">...</span><span style="color:#111">),</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">v2</span><span style="color:#111">,</span> <span style="color:#75af00">vals</span><span style="color:#f92672">...</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="流程">流程</h2>
<ol>
<li>用户通过 <code>etcdctl get /b</code> 命令获取数据</li>
<li>etcd 通过 treeindex 获取 key 的 revision 信息 <code>{man: 19, sub: 0}</code></li>
<li>etcd 通过 key = <code>{man: 19, sub: 0, tombstone: false}</code> 从 boltdb 中获取 value 值 他是一个protobuf 序列化的数据</li>
<li>etcd 将 value 值反序列化成 mvccpb.KeyValue</li>
<li>etcd 将 mvccpb.KeyValue 返回给用户</li>
</ol>
<p><img src="/images/658af763-0bf3-4af0-b7c9-3da26ed87db3.png" alt=""></p>
]]></content:encoded><category>cloud</category><category>boltdb</category><category>etcd</category><category>golang</category><category>数据库</category><category>kubernetes</category></item><item><title>boltdb 介绍</title><link>https://daemon365.dev/post/cloud/boltdb_basics/</link><pubDate>Wed, 08 May 2024 20:56:00 +0800</pubDate><guid>https://daemon365.dev/post/cloud/boltdb_basics/</guid><description>&lt;h2 id="介绍"&gt;介绍&lt;/h2&gt;
&lt;p&gt;&lt;code&gt;BoltDB&lt;/code&gt; 是一个用 Go 语言编写的嵌入式键/值数据库。以下是关于 BoltDB 的一些基本介绍：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;键/值存储&lt;/strong&gt;: BoltDB 为应用程序提供了简单的键/值存储接口。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;事务&lt;/strong&gt;: BoltDB 支持完整的 ACID 事务。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;嵌入式&lt;/strong&gt;: 与像 MySQL 或 PostgreSQL 这样的数据库系统不同，BoltDB 不运行在单独的服务器进程中。它作为一个库被直接嵌入到你的应用程序中。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;单文件存储&lt;/strong&gt;: 所有的数据都存储在一个文件中，这使得备份和迁移变得简单。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;高效的二进制存储&lt;/strong&gt;: 数据在磁盘上使用 B+ 树结构存储，这为随机读取提供了高性能。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;前缀扫描&lt;/strong&gt;: 可以很容易地按键的前缀进行扫描，这使得它适用于范围查询。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;没有外部依赖&lt;/strong&gt;: BoltDB 不依赖于任何外部系统或库。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;线程安全&lt;/strong&gt;: BoltDB 是线程安全的，可以在多个 goroutines 中并发地使用。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;BoltDB 特别适用于需要一个轻量级、高性能、易于部署和维护的数据库解决方案的场景。&lt;/p&gt;
&lt;p&gt;虽然 BoltDB 非常有用，但它也有其局限性。例如，它不支持分布式存储，也不适用于需要多节点复制或分片的场景。但对于许多应用程序，它提供了一个简单且高性能的存储解决方案。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;源码地址：&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href="https://github.com/boltdb/bolt"&gt;https://github.com/boltdb/bolt&lt;/a&gt; 这个项目已经不维护了, &lt;a href="https://etcd.io/"&gt;etcd&lt;/a&gt; 官方维护了一个 fork 库，api 是互通的: &lt;a href="https://github.com/etcd-io/bbolt"&gt;https://github.com/etcd-io/bbolt&lt;/a&gt;&lt;/p&gt;
&lt;h2 id="谁在使用"&gt;谁在使用&lt;/h2&gt;
&lt;p&gt;&lt;a href="https://github.com/etcd-io/etcd"&gt;etcd&lt;/a&gt;、&lt;a href="https://github.com/pingcap/tidb"&gt;tidb&lt;/a&gt;、&lt;a href="https://github.com/influxdata/influxdb"&gt;influxdb&lt;/a&gt;、&lt;a href="https://github.com/hashicorp/consul"&gt;consul&lt;/a&gt; &amp;hellip;&amp;hellip;&lt;/p&gt;
&lt;h2 id="架构图"&gt;架构图&lt;/h2&gt;
&lt;p&gt;&lt;img src="https://daemon365.dev/images/6f10d17d-ca52-4fd0-a600-e92a9fc99d36.png" alt="boltdb"&gt;&lt;/p&gt;
&lt;h2 id="引入"&gt;引入&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;go get go.etcd.io/bbolt
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id="使用"&gt;使用&lt;/h2&gt;
&lt;h3 id="open--a-database"&gt;open a database&lt;/h3&gt;
&lt;p&gt;Bolt 中的顶级对象是 DB。它在你的硬盘上表示为一个单独的文件，并代表了你数据的一个一致性快照。&lt;/p&gt;
&lt;p&gt;要打开你的数据库，只需使用 &lt;code&gt;bolt.Open()&lt;/code&gt; 函数：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-GO" data-lang="GO"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;package&lt;/span&gt; &lt;span style="color:#75af00"&gt;main&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;import&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;log&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;bolt&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;go.etcd.io/bbolt&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;main&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;db&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;bolt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Open&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;my.db&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;0600&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;!=&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;log&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Fatal&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;err&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;defer&lt;/span&gt; &lt;span style="color:#75af00"&gt;db&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Close&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;请注意，Bolt 在数据文件上获得一个文件锁，因此多个进程不能同时打开同一个数据库。打开一个已经打开的 Bolt 数据库会导致它挂起，直到另一个进程关闭它。为了防止无限期的等待，你可以向 &lt;code&gt;Open()&lt;/code&gt; 函数传递一个超时选项：&lt;/p&gt;</description><content:encoded><![CDATA[<h2 id="介绍">介绍</h2>
<p><code>BoltDB</code> 是一个用 Go 语言编写的嵌入式键/值数据库。以下是关于 BoltDB 的一些基本介绍：</p>
<ul>
<li><strong>键/值存储</strong>: BoltDB 为应用程序提供了简单的键/值存储接口。</li>
<li><strong>事务</strong>: BoltDB 支持完整的 ACID 事务。</li>
<li><strong>嵌入式</strong>: 与像 MySQL 或 PostgreSQL 这样的数据库系统不同，BoltDB 不运行在单独的服务器进程中。它作为一个库被直接嵌入到你的应用程序中。</li>
<li><strong>单文件存储</strong>: 所有的数据都存储在一个文件中，这使得备份和迁移变得简单。</li>
<li><strong>高效的二进制存储</strong>: 数据在磁盘上使用 B+ 树结构存储，这为随机读取提供了高性能。</li>
<li><strong>前缀扫描</strong>: 可以很容易地按键的前缀进行扫描，这使得它适用于范围查询。</li>
<li><strong>没有外部依赖</strong>: BoltDB 不依赖于任何外部系统或库。</li>
<li><strong>线程安全</strong>: BoltDB 是线程安全的，可以在多个 goroutines 中并发地使用。</li>
</ul>
<p>BoltDB 特别适用于需要一个轻量级、高性能、易于部署和维护的数据库解决方案的场景。</p>
<p>虽然 BoltDB 非常有用，但它也有其局限性。例如，它不支持分布式存储，也不适用于需要多节点复制或分片的场景。但对于许多应用程序，它提供了一个简单且高性能的存储解决方案。</p>
<p><strong>源码地址：</strong></p>
<p><a href="https://github.com/boltdb/bolt">https://github.com/boltdb/bolt</a> 这个项目已经不维护了,  <a href="https://etcd.io/">etcd</a> 官方维护了一个 fork 库，api 是互通的: <a href="https://github.com/etcd-io/bbolt">https://github.com/etcd-io/bbolt</a></p>
<h2 id="谁在使用">谁在使用</h2>
<p><a href="https://github.com/etcd-io/etcd">etcd</a>、<a href="https://github.com/pingcap/tidb">tidb</a>、<a href="https://github.com/influxdata/influxdb">influxdb</a>、<a href="https://github.com/hashicorp/consul">consul</a> &hellip;&hellip;</p>
<h2 id="架构图">架构图</h2>
<p><img src="/images/6f10d17d-ca52-4fd0-a600-e92a9fc99d36.png" alt="boltdb"></p>
<h2 id="引入">引入</h2>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>go get go.etcd.io/bbolt 
</span></span></code></pre></div><h2 id="使用">使用</h2>
<h3 id="open--a-database">open  a database</h3>
<p>Bolt 中的顶级对象是 DB。它在你的硬盘上表示为一个单独的文件，并代表了你数据的一个一致性快照。</p>
<p>要打开你的数据库，只需使用 <code>bolt.Open()</code> 函数：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-GO" data-lang="GO"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">bolt</span> <span style="color:#d88200">&#34;go.etcd.io/bbolt&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">db</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">bolt</span><span style="color:#111">.</span><span style="color:#75af00">Open</span><span style="color:#111">(</span><span style="color:#d88200">&#34;my.db&#34;</span><span style="color:#111">,</span> <span style="color:#ae81ff">0600</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Fatal</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>请注意，Bolt 在数据文件上获得一个文件锁，因此多个进程不能同时打开同一个数据库。打开一个已经打开的 Bolt 数据库会导致它挂起，直到另一个进程关闭它。为了防止无限期的等待，你可以向 <code>Open()</code> 函数传递一个超时选项：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-GO" data-lang="GO"><span style="display:flex;"><span><span style="color:#75af00">db</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">bolt</span><span style="color:#111">.</span><span style="color:#75af00">Open</span><span style="color:#111">(</span><span style="color:#d88200">&#34;my.db&#34;</span><span style="color:#111">,</span> <span style="color:#ae81ff">0600</span><span style="color:#111">,</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">bolt</span><span style="color:#111">.</span><span style="color:#75af00">Options</span><span style="color:#111">{</span><span style="color:#75af00">Timeout</span><span style="color:#111">:</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">*</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Second</span><span style="color:#111">})</span>
</span></span></code></pre></div><h3 id="transactions">Transactions</h3>
<p>Bolt一次只允许一个读写 transactions ，但允许您一次进行多个只读 transactions 。每一个 transactions 在开始时都能看到数据的一致视图。</p>
<p>单独的 transactions 和从它们创建的所有对象（例如桶、键）都不是线程安全的。要在多个goroutines中处理数据，您必须为每一个goroutine启动一个 transactions ，或使用锁来确保一次只有一个goroutine访问一个 transactions 。从数据库创建 transactions 是线程安全的。</p>
<p>transactions 不应相互依赖，并且通常不应在同一goroutine中同时打开。这可能会导致死锁，因为读写 transactions 需要定期重新映射数据文件，但在任何只读 transactions 打开时都不能这样做。即使是嵌套的只读 transactions 也可能导致死锁，因为子 transactions 可能阻止父 transactions 释放其资源。</p>
<h4 id="read-write-transactions">Read-write transactions</h4>
<p>要开始一个读写 transactions ，可以使用DB.Update()函数：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">Update</span><span style="color:#111">(</span><span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">tx</span> <span style="color:#f92672">*</span><span style="color:#75af00">bolt</span><span style="color:#111">.</span><span style="color:#75af00">Tx</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">})</span>
</span></span></code></pre></div><p>在闭包中，您可以看到数据库的一致视图。通过在最后返回nil来提交 transactions 。您还可以通过返回错误在任何时候回滚 transactions 。所有的数据库操作都允许在一个读写 transactions 中进行。</p>
<p>始终检查返回错误，因为它会报告任何可能导致您的 transactions 未完成的磁盘故障。如果您在闭包内返回错误，它将被传递。</p>
<h4 id="read-only-transactions">Read-only transactions</h4>
<p>要开始一个只读 transactions ，您可以使用DB.View()函数：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">View</span><span style="color:#111">(</span><span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">tx</span> <span style="color:#f92672">*</span><span style="color:#75af00">bolt</span><span style="color:#111">.</span><span style="color:#75af00">Tx</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">})</span>
</span></span></code></pre></div><p>在这个闭包内，您也可以看到数据库的一致视图，但在只读 transactions 中不允许进行变动操作。在一个只读 transactions 中，您只能检索桶、检索值和复制数据库。</p>
<h4 id="batch-read-write-transactions">Batch read-write transactions</h4>
<p>每个DB.Update()都会等待磁盘提交写入。这种开销可以通过使用DB.Batch()函数结合多个更新来最小化：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">Batch</span><span style="color:#111">(</span><span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">tx</span> <span style="color:#f92672">*</span><span style="color:#75af00">bolt</span><span style="color:#111">.</span><span style="color:#75af00">Tx</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">})</span>
</span></span></code></pre></div><p>并发的Batch调用会被机会性地组合成更大的 transactions 。只有当有多个goroutines调用它时，Batch才是有用的。</p>
<p>权衡之处在于，Batch在 transactions 的部分失败时可以多次调用给定的函数。该函数必须是幂等的，且只有在成功从DB.Batch()返回后，副作用才会生效。</p>
<p>例如：不要从函数内部显示消息，而是在封闭范围内设置变量：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">var</span> <span style="color:#75af00">id</span> <span style="color:#00a8c8">uint64</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">Batch</span><span style="color:#111">(</span><span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">tx</span> <span style="color:#f92672">*</span><span style="color:#75af00">bolt</span><span style="color:#111">.</span><span style="color:#75af00">Tx</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 在桶中查找最后一个键，解码为bigendian uint64，增加</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 一个，编码回[]byte，并添加新键。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">id</span> <span style="color:#111">=</span> <span style="color:#75af00">newValue</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">})</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Allocated ID %d&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">id</span><span style="color:#111">)</span>
</span></span></code></pre></div><h4 id="managing-transactions-manually">Managing transactions manually</h4>
<p>DB.View()和DB.Update()函数是DB.Begin()函数的包装。这些助手函数将启动 transactions 、执行函数，然后在返回错误时安全地关闭您的 transactions 。这是使用Bolt transactions 的推荐方法。</p>
<p>然而，有时您可能希望手动开始和结束您的 transactions 。您可以直接使用DB.Begin()函数，但请确保关闭 transactions 。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// 开始一个可写的 transactions 。</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">tx</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">Begin</span><span style="color:#111">(</span><span style="color:#00a8c8">true</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">defer</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">Rollback</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 使用 transactions ...</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">CreateBucket</span><span style="color:#111">([]</span><span style="color:#111">byte</span><span style="color:#111">(</span><span style="color:#d88200">&#34;MyBucket&#34;</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 提交 transactions 并检查错误。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">Commit</span><span style="color:#111">();</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>DB.Begin()的第一个参数是一个布尔值，表示 transactions 是否应该是可写的。</p>
<h3 id="using-buckets">Using buckets</h3>
<p>桶是数据库中的键/值对集合。一个桶中的所有键都必须是唯一的。您可以使用Tx.CreateBucket()函数创建一个桶：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">Update</span><span style="color:#111">(</span><span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">tx</span> <span style="color:#f92672">*</span><span style="color:#75af00">bolt</span><span style="color:#111">.</span><span style="color:#75af00">Tx</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">b</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">CreateBucket</span><span style="color:#111">([]</span><span style="color:#111">byte</span><span style="color:#111">(</span><span style="color:#d88200">&#34;MyBucket&#34;</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;create bucket: %s&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">})</span>
</span></span></code></pre></div><p>您可以使用Tx.Bucket()函数检索现有的桶：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">Update</span><span style="color:#111">(</span><span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">tx</span> <span style="color:#f92672">*</span><span style="color:#75af00">bolt</span><span style="color:#111">.</span><span style="color:#75af00">Tx</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">b</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">Bucket</span><span style="color:#111">([]</span><span style="color:#111">byte</span><span style="color:#111">(</span><span style="color:#d88200">&#34;MyBucket&#34;</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">b</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;bucket does not exist&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">})</span>
</span></span></code></pre></div><p>您还可以使用Tx.CreateBucketIfNotExists()函数只在桶不存在时创建一个桶。打开数据库后，为所有的顶级桶调用此函数是一种常见的模式，这样您可以保证它们存在于未来的 transactions 中。</p>
<p>要删除一个桶，只需调用Tx.DeleteBucket()函数。</p>
<h3 id="using-keyvalue-pairs">Using key/value pairs</h3>
<p>要将键/值对保存到存储桶，使用<code>Bucket.Put()</code>函数：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">Update</span><span style="color:#111">(</span><span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">tx</span> <span style="color:#f92672">*</span><span style="color:#75af00">bolt</span><span style="color:#111">.</span><span style="color:#75af00">Tx</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">b</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">Bucket</span><span style="color:#111">([]</span><span style="color:#111">byte</span><span style="color:#111">(</span><span style="color:#d88200">&#34;MyBucket&#34;</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">Put</span><span style="color:#111">([]</span><span style="color:#111">byte</span><span style="color:#111">(</span><span style="color:#d88200">&#34;answer&#34;</span><span style="color:#111">),</span> <span style="color:#111">[]</span><span style="color:#111">byte</span><span style="color:#111">(</span><span style="color:#d88200">&#34;42&#34;</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span><span style="color:#111">})</span>
</span></span></code></pre></div><p>这会在<code>MyBucket</code>存储桶中将&quot;answer&quot;键的值设置为&quot;42&quot;。要检索此值，我们可以使用<code>Bucket.Get()</code>函数：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">View</span><span style="color:#111">(</span><span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">tx</span> <span style="color:#f92672">*</span><span style="color:#75af00">bolt</span><span style="color:#111">.</span><span style="color:#75af00">Tx</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">b</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">Bucket</span><span style="color:#111">([]</span><span style="color:#111">byte</span><span style="color:#111">(</span><span style="color:#d88200">&#34;MyBucket&#34;</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">v</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">Get</span><span style="color:#111">([]</span><span style="color:#111">byte</span><span style="color:#111">(</span><span style="color:#d88200">&#34;answer&#34;</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;The answer is: %s\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">v</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">})</span>
</span></span></code></pre></div><p><code>Get()</code>函数不返回错误，因为其操作保证可以工作（除非有某种系统故障）。如果键存在，它将返回其字节切片值。如果不存在，则返回nil。重要的是要注意，您可以将零长度的值设置为一个键，这与键不存在是不同的。</p>
<p>使用<code>Bucket.Delete()</code>函数从存储桶中删除键：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">Update</span><span style="color:#111">(</span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">tx</span> <span style="color:#f92672">*</span><span style="color:#75af00">bolt</span><span style="color:#111">.</span><span style="color:#75af00">Tx</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">b</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">Bucket</span><span style="color:#111">([]</span><span style="color:#111">byte</span><span style="color:#111">(</span><span style="color:#d88200">&#34;MyBucket&#34;</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">Delete</span><span style="color:#111">([]</span><span style="color:#111">byte</span><span style="color:#111">(</span><span style="color:#d88200">&#34;answer&#34;</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span><span style="color:#111">})</span>
</span></span></code></pre></div><p>这将从<code>MyBucket</code>存储桶中删除答案键。</p>
<p>请注意，从<code>Get()</code>返回的值只在事务打开时有效。如果您需要在事务外部使用值，则必须使用<code>copy()</code>将其复制到另一个字节切片。</p>
<h3 id="autoincrementing-integer-for-the-bucket">Autoincrementing integer for the bucket</h3>
<p>通过使用<code>NextSequence()</code>函数，您可以让Bolt确定一个序列，该序列可以用作键/值对的唯一标识符。请参阅下面的示例。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-GO" data-lang="GO"><span style="display:flex;"><span><span style="color:#75715e">// CreateUser saves u to the store. The new user ID is set on u once the data is persisted.</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">s</span> <span style="color:#f92672">*</span><span style="color:#75af00">Store</span><span style="color:#111">)</span> <span style="color:#75af00">CreateUser</span><span style="color:#111">(</span><span style="color:#75af00">u</span> <span style="color:#f92672">*</span><span style="color:#75af00">User</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">Update</span><span style="color:#111">(</span><span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">tx</span> <span style="color:#f92672">*</span><span style="color:#75af00">bolt</span><span style="color:#111">.</span><span style="color:#75af00">Tx</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Retrieve the users bucket.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// This should be created when the DB is first opened.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">b</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">Bucket</span><span style="color:#111">([]</span><span style="color:#111">byte</span><span style="color:#111">(</span><span style="color:#d88200">&#34;users&#34;</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Generate ID for the user.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// This returns an error only if the Tx is closed or not writeable.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// That can&#39;t happen in an Update() call so I ignore the error check.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">id</span><span style="color:#111">,</span> <span style="color:#75af00">_</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">NextSequence</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">u</span><span style="color:#111">.</span><span style="color:#75af00">ID</span> <span style="color:#111">=</span> <span style="color:#111">int</span><span style="color:#111">(</span><span style="color:#75af00">id</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Marshal user data into bytes.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">buf</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">json</span><span style="color:#111">.</span><span style="color:#75af00">Marshal</span><span style="color:#111">(</span><span style="color:#75af00">u</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Persist bytes to users bucket.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">Put</span><span style="color:#111">(</span><span style="color:#75af00">itob</span><span style="color:#111">(</span><span style="color:#75af00">u</span><span style="color:#111">.</span><span style="color:#75af00">ID</span><span style="color:#111">),</span> <span style="color:#75af00">buf</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">})</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// itob returns an 8-byte big endian representation of v.</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">itob</span><span style="color:#111">(</span><span style="color:#75af00">v</span> <span style="color:#00a8c8">int</span><span style="color:#111">)</span> <span style="color:#111">[]</span><span style="color:#00a8c8">byte</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">b</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">([]</span><span style="color:#00a8c8">byte</span><span style="color:#111">,</span> <span style="color:#ae81ff">8</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">binary</span><span style="color:#111">.</span><span style="color:#75af00">BigEndian</span><span style="color:#111">.</span><span style="color:#75af00">PutUint64</span><span style="color:#111">(</span><span style="color:#75af00">b</span><span style="color:#111">,</span> <span style="color:#111">uint64</span><span style="color:#111">(</span><span style="color:#75af00">v</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#75af00">b</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">User</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">ID</span> <span style="color:#00a8c8">int</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="iterating-over-keys">Iterating over keys</h3>
<p>Bolt在存储桶内按字节排序存储其键。这使得对这些键进行顺序迭代非常快。要迭代键，我们将使用一个Cursor：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">View</span><span style="color:#111">(</span><span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">tx</span> <span style="color:#f92672">*</span><span style="color:#75af00">bolt</span><span style="color:#111">.</span><span style="color:#75af00">Tx</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Assume bucket exists and has keys</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">b</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">Bucket</span><span style="color:#111">([]</span><span style="color:#111">byte</span><span style="color:#111">(</span><span style="color:#d88200">&#34;MyBucket&#34;</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">c</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">Cursor</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">k</span><span style="color:#111">,</span> <span style="color:#75af00">v</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">First</span><span style="color:#111">();</span> <span style="color:#75af00">k</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span><span style="color:#111">;</span> <span style="color:#75af00">k</span><span style="color:#111">,</span> <span style="color:#75af00">v</span> <span style="color:#111">=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">Next</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;key=%s, value=%s\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">k</span><span style="color:#111">,</span> <span style="color:#75af00">v</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">})</span>
</span></span></code></pre></div><p>游标允许您移动到键列表中的特定点，并一次向前或向后移动一个键。</p>
<p>以下函数在游标上可用：</p>
<ul>
<li><code>First()</code> 移动到第一个键。</li>
<li><code>Last()</code> 移动到最后一个键。</li>
<li><code>Seek()</code> 移动到特定键。</li>
<li><code>Next()</code> 移动到下一个键。</li>
<li><code>Prev()</code> 移动到上一个键。 每个函数都有一个返回签名（key []byte, value []byte）。当您迭代到游标的末尾时，<code>Next()</code>将返回一个nil键。您必须使用<code>First()</code>、<code>Last()</code>或<code>Seek()</code>移动到某个位置，然后再调用<code>Next()</code>或<code>Prev()</code>。如果您没有移动到某个位置，那么这些函数将返回一个nil键。</li>
</ul>
<p>在迭代过程中，如果键不是nil，但值是nil，那么意味着键引用的是一个存储桶而不是一个值。使用<code>Bucket.Bucket()</code>来访问子存储桶。</p>
<h4 id="prefix-scans">Prefix scans</h4>
<p>要迭代键前缀，您可以结合使用<code>Seek()</code>和<code>bytes.HasPrefix()</code>：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">View</span><span style="color:#111">(</span><span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">tx</span> <span style="color:#f92672">*</span><span style="color:#75af00">bolt</span><span style="color:#111">.</span><span style="color:#75af00">Tx</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Assume bucket exists and has keys</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">c</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">Bucket</span><span style="color:#111">([]</span><span style="color:#111">byte</span><span style="color:#111">(</span><span style="color:#d88200">&#34;MyBucket&#34;</span><span style="color:#111">)).</span><span style="color:#75af00">Cursor</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">prefix</span> <span style="color:#f92672">:=</span> <span style="color:#111">[]</span><span style="color:#111">byte</span><span style="color:#111">(</span><span style="color:#d88200">&#34;1234&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">k</span><span style="color:#111">,</span> <span style="color:#75af00">v</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">Seek</span><span style="color:#111">(</span><span style="color:#75af00">prefix</span><span style="color:#111">);</span> <span style="color:#75af00">k</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">bytes</span><span style="color:#111">.</span><span style="color:#75af00">HasPrefix</span><span style="color:#111">(</span><span style="color:#75af00">k</span><span style="color:#111">,</span> <span style="color:#75af00">prefix</span><span style="color:#111">);</span> <span style="color:#75af00">k</span><span style="color:#111">,</span> <span style="color:#75af00">v</span> <span style="color:#111">=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">Next</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;key=%s, value=%s\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">k</span><span style="color:#111">,</span> <span style="color:#75af00">v</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">})</span>
</span></span></code></pre></div><h4 id="range-scans">Range scans</h4>
<p>另一个常见的用例是扫描范围，例如时间范围。如果您使用可排序的时间编码，例如RFC3339，那么您可以像这样查询特定的日期范围：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">View</span><span style="color:#111">(</span><span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">tx</span> <span style="color:#f92672">*</span><span style="color:#75af00">bolt</span><span style="color:#111">.</span><span style="color:#75af00">Tx</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Assume our events bucket exists and has RFC3339 encoded time keys.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">c</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">Bucket</span><span style="color:#111">([]</span><span style="color:#111">byte</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Events&#34;</span><span style="color:#111">)).</span><span style="color:#75af00">Cursor</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Our time range spans the 90&#39;s decade.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">min</span> <span style="color:#f92672">:=</span> <span style="color:#111">[]</span><span style="color:#111">byte</span><span style="color:#111">(</span><span style="color:#d88200">&#34;1990-01-01T00:00:00Z&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">max</span> <span style="color:#f92672">:=</span> <span style="color:#111">[]</span><span style="color:#111">byte</span><span style="color:#111">(</span><span style="color:#d88200">&#34;2000-01-01T00:00:00Z&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Iterate over the 90&#39;s.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">k</span><span style="color:#111">,</span> <span style="color:#75af00">v</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">Seek</span><span style="color:#111">(</span><span style="color:#75af00">min</span><span style="color:#111">);</span> <span style="color:#75af00">k</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">bytes</span><span style="color:#111">.</span><span style="color:#75af00">Compare</span><span style="color:#111">(</span><span style="color:#75af00">k</span><span style="color:#111">,</span> <span style="color:#75af00">max</span><span style="color:#111">)</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span><span style="color:#111">;</span> <span style="color:#75af00">k</span><span style="color:#111">,</span> <span style="color:#75af00">v</span> <span style="color:#111">=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">Next</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;%s: %s\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">k</span><span style="color:#111">,</span> <span style="color:#75af00">v</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">})</span>
</span></span></code></pre></div><p>请注意，虽然RFC3339是可排序的，但Golang的RFC3339Nano实现不使用小数点后固定数量的数字，因此不可排序。</p>
<h4 id="foreach">ForEach()</h4>
<p>如果您知道要在存储桶中迭代所有键，也可以使用<code>ForEach()</code>函数：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-GO" data-lang="GO"><span style="display:flex;"><span><span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">View</span><span style="color:#111">(</span><span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">tx</span> <span style="color:#f92672">*</span><span style="color:#75af00">bolt</span><span style="color:#111">.</span><span style="color:#75af00">Tx</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Assume bucket exists and has keys</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">b</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">Bucket</span><span style="color:#111">([]</span><span style="color:#111">byte</span><span style="color:#111">(</span><span style="color:#d88200">&#34;MyBucket&#34;</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">ForEach</span><span style="color:#111">(</span><span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">k</span><span style="color:#111">,</span> <span style="color:#75af00">v</span> <span style="color:#111">[]</span><span style="color:#00a8c8">byte</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;key=%s, value=%s\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">k</span><span style="color:#111">,</span> <span style="color:#75af00">v</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">})</span>
</span></span></code></pre></div><p>请注意，ForEach()中的键和值仅在事务打开时有效。如果您需要在事务之外使用键或值，您必须使用copy()将其复制到另一个字节切片。</p>
<h3 id="nested-buckets">Nested buckets</h3>
<p>以下是给定文档的中文翻译：</p>
<p>请注意，ForEach()中的键和值仅在事务打开时有效。如果您需要在事务之外使用键或值，您必须使用copy()将其复制到另一个字节切片。</p>
<p><strong>嵌套的桶</strong> 您还可以在键中存储一个桶，以创建嵌套的桶。该API与DB对象上的桶管理API相同：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">Bucket</span><span style="color:#111">)</span> <span style="color:#75af00">CreateBucket</span><span style="color:#111">(</span><span style="color:#75af00">key</span> <span style="color:#111">[]</span><span style="color:#00a8c8">byte</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">Bucket</span><span style="color:#111">,</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">Bucket</span><span style="color:#111">)</span> <span style="color:#75af00">CreateBucketIfNotExists</span><span style="color:#111">(</span><span style="color:#75af00">key</span> <span style="color:#111">[]</span><span style="color:#00a8c8">byte</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">Bucket</span><span style="color:#111">,</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">Bucket</span><span style="color:#111">)</span> <span style="color:#75af00">DeleteBucket</span><span style="color:#111">(</span><span style="color:#75af00">key</span> <span style="color:#111">[]</span><span style="color:#00a8c8">byte</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span>
</span></span></code></pre></div><p>假设您有一个多租户应用程序，其中根级别的桶是帐户桶。在此桶内是一系列自身为桶的帐户。在这个序列桶里，你可以拥有许多与账户自身相关的桶（如用户、笔记等），将信息隔离到逻辑分组中。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// createUser 在给定账户中创建一个新用户。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">createUser</span><span style="color:#111">(</span><span style="color:#75af00">accountID</span> <span style="color:#00a8c8">int</span><span style="color:#111">,</span> <span style="color:#75af00">u</span> <span style="color:#f92672">*</span><span style="color:#75af00">User</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 开始事务。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">tx</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">Begin</span><span style="color:#111">(</span><span style="color:#00a8c8">true</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">defer</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">Rollback</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 检索帐户的根桶。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 假设在设置帐户时已经创建了此桶。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">root</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">Bucket</span><span style="color:#111">([]</span><span style="color:#111">byte</span><span style="color:#111">(</span><span style="color:#75af00">strconv</span><span style="color:#111">.</span><span style="color:#75af00">FormatUint</span><span style="color:#111">(</span><span style="color:#75af00">accountID</span><span style="color:#111">,</span> <span style="color:#ae81ff">10</span><span style="color:#111">)))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 设置用户桶。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">bkt</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">root</span><span style="color:#111">.</span><span style="color:#75af00">CreateBucketIfNotExists</span><span style="color:#111">([]</span><span style="color:#111">byte</span><span style="color:#111">(</span><span style="color:#d88200">&#34;USERS&#34;</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 为新用户生成ID。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">userID</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">bkt</span><span style="color:#111">.</span><span style="color:#75af00">NextSequence</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">u</span><span style="color:#111">.</span><span style="color:#75af00">ID</span> <span style="color:#111">=</span> <span style="color:#75af00">userID</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 序列化并保存编码的用户。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">buf</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">json</span><span style="color:#111">.</span><span style="color:#75af00">Marshal</span><span style="color:#111">(</span><span style="color:#75af00">u</span><span style="color:#111">);</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">bkt</span><span style="color:#111">.</span><span style="color:#75af00">Put</span><span style="color:#111">([]</span><span style="color:#111">byte</span><span style="color:#111">(</span><span style="color:#75af00">strconv</span><span style="color:#111">.</span><span style="color:#75af00">FormatUint</span><span style="color:#111">(</span><span style="color:#75af00">u</span><span style="color:#111">.</span><span style="color:#75af00">ID</span><span style="color:#111">,</span> <span style="color:#ae81ff">10</span><span style="color:#111">)),</span> <span style="color:#75af00">buf</span><span style="color:#111">);</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 提交事务。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">Commit</span><span style="color:#111">();</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="数据库备份">数据库备份</h3>
<p>Bolt是一个单一的文件，所以备份很容易。您可以使用Tx.WriteTo()函数将数据库的一致视图写入一个写入器。如果您从只读事务中调用此函数，它将执行一个热备份，并且不会阻止您的其他数据库读取和写入。</p>
<p>默认情况下，它将使用一个常规的文件句柄，该句柄将利用操作系统的页面缓存。请查看Tx文档，了解有关优化大于RAM数据集的信息。</p>
<p>一个常见的用例是通过HTTP进行备份，这样您就可以使用像cURL这样的工具进行数据库备份：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">BackupHandleFunc</span><span style="color:#111">(</span><span style="color:#75af00">w</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">ResponseWriter</span><span style="color:#111">,</span> <span style="color:#75af00">req</span> <span style="color:#f92672">*</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Request</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">View</span><span style="color:#111">(</span><span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">tx</span> <span style="color:#f92672">*</span><span style="color:#75af00">bolt</span><span style="color:#111">.</span><span style="color:#75af00">Tx</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">w</span><span style="color:#111">.</span><span style="color:#75af00">Header</span><span style="color:#111">().</span><span style="color:#75af00">Set</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Content-Type&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;application/octet-stream&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">w</span><span style="color:#111">.</span><span style="color:#75af00">Header</span><span style="color:#111">().</span><span style="color:#75af00">Set</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Content-Disposition&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">`attachment; filename=&#34;my.db&#34;`</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">w</span><span style="color:#111">.</span><span style="color:#75af00">Header</span><span style="color:#111">().</span><span style="color:#75af00">Set</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Content-Length&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">strconv</span><span style="color:#111">.</span><span style="color:#75af00">Itoa</span><span style="color:#111">(</span><span style="color:#111">int</span><span style="color:#111">(</span><span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">Size</span><span style="color:#111">())))</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">WriteTo</span><span style="color:#111">(</span><span style="color:#75af00">w</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Error</span><span style="color:#111">(</span><span style="color:#75af00">w</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">.</span><span style="color:#75af00">Error</span><span style="color:#111">(),</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">StatusInternalServerError</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>然后你可以使用这个命令备份：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">$</span> <span style="color:#75af00">curl</span> <span style="color:#75af00">http</span><span style="color:#111">:</span><span style="color:#75715e">//localhost/backup &gt; my.db</span>
</span></span></code></pre></div><p>或者您可以打开您的浏览器访问http://localhost/backup，它将自动下载。</p>
<p>如果您想备份到另一个文件，您可以使用Tx.CopyFile()辅助函数。</p>
<p><strong>统计信息</strong> 数据库保持对其执行的许多内部操作的持续计数，这样您可以更好地了解正在发生的事情。通过在两个时间点获取这些统计的快照，我们可以看到在这个时间范围内执行了哪些操作。</p>
<p>例如，我们可以启动一个goroutine，每10秒记录一次统计信息：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">go</span> <span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 获取初始统计。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">prev</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">Stats</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">for</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 等待10秒。</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Sleep</span><span style="color:#111">(</span><span style="color:#ae81ff">10</span> <span style="color:#f92672">*</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Second</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 获取当前统计并对其进行差异处理。</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">stats</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">Stats</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">diff</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">stats</span><span style="color:#111">.</span><span style="color:#75af00">Sub</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">prev</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 将统计信息编码为JSON并打印到STDERR。</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">json</span><span style="color:#111">.</span><span style="color:#75af00">NewEncoder</span><span style="color:#111">(</span><span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">Stderr</span><span style="color:#111">).</span><span style="color:#75af00">Encode</span><span style="color:#111">(</span><span style="color:#75af00">diff</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 为下一个循环保存统计。</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">prev</span> <span style="color:#111">=</span> <span style="color:#75af00">stats</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}()</span>
</span></span></code></pre></div><p>将这些统计信息管道到像statsd这样的服务进行监控，或者提供一个HTTP端点来执行固定长度的样本，也很有用。</p>
<h3 id="只读模式">只读模式</h3>
<p>有时创建一个共享的、只读的Bolt数据库是很有用的。要做到这一点，打开数据库时设置Options.ReadOnly标志。只读模式使用共享锁，允许多个进程从数据库中读取，但它会阻止任何进程以读写模式打开数据库。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">db</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">bolt</span><span style="color:#111">.</span><span style="color:#75af00">Open</span><span style="color:#111">(</span><span style="color:#d88200">&#34;my.db&#34;</span><span style="color:#111">,</span> <span style="color:#ae81ff">0600</span><span style="color:#111">,</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">bolt</span><span style="color:#111">.</span><span style="color:#75af00">Options</span><span style="color:#111">{</span><span style="color:#75af00">ReadOnly</span><span style="color:#111">:</span> <span style="color:#00a8c8">true</span><span style="color:#111">})</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Fatal</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>希望这可以帮助您理解给定的文档！如果您有任何问题或需要进一步的澄清，请告诉我。</p>
<h2 id="referance">referance</h2>
<ul>
<li><a href="https://github.com/etcd-io/bbolt">https://github.com/etcd-io/bbolt</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/377572049">https://zhuanlan.zhihu.com/p/377572049</a></li>
</ul>
]]></content:encoded><category>cloud</category><category>boltdb</category><category>etcd</category><category>golang</category><category>数据库</category><category>kubernetes</category></item><item><title>kubelet 原理分析</title><link>https://daemon365.dev/post/cloud/analysis_of_kubelet_principles/</link><pubDate>Wed, 01 May 2024 12:40:00 +0800</pubDate><guid>https://daemon365.dev/post/cloud/analysis_of_kubelet_principles/</guid><description>&lt;h2 id="reference"&gt;Reference&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="https://atbug.com/kubelet-source-code-analysis/"&gt;https://atbug.com/kubelet-source-code-analysis/&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="kubelet-简介"&gt;kubelet 简介&lt;/h2&gt;
&lt;p&gt;kubernetes 分为控制面和数据面，kubelet 就是数据面最主要的组件，在每个节点上启动，主要负责容器的创建、启停、监控、日志收集等工作。它是一个在每个集群节点上运行的代理，负责确保节点上的容器根据PodSpec（Pod定义文件）正确运行。&lt;/p&gt;
&lt;p&gt;Kubelet执行以下几项重要功能：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Pod生命周期管理：Kubelet根据从API服务器接收到的PodSpecs创建、启动、终止容器。它负责启动Pod中的容器，并确保它们按预期运行。&lt;/li&gt;
&lt;li&gt;节点状态监控：Kubelet定期监控节点和容器的状态，并将状态报告回集群的控制平面。这使得集群中的其他组件能够做出相应的调度决策。&lt;/li&gt;
&lt;li&gt;资源管理：Kubelet负责管理分配给每个Pod的资源。这包括CPU、内存和磁盘存储资源。&lt;/li&gt;
&lt;li&gt;健康检查：Kubelet可以执行容器健康检查，并根据检查结果决定是否需要重启容器。&lt;/li&gt;
&lt;li&gt;与容器运行时的通信：Kubelet与容器运行时（如Docker、containerd等）通信，以管理容器的生命周期。&lt;/li&gt;
&lt;li&gt;秘密和配置管理：Kubelet负责将秘密、配置映射等挂载到Pod的容器中，以便应用程序可以访问这些配置。&lt;/li&gt;
&lt;li&gt;服务发现和负载均衡：尽管Kubelet本身不直接处理服务发现，但它通过设置网络规则和环境变量来支持容器内的服务发现机制。&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="kubelet-架构"&gt;kubelet 架构&lt;/h2&gt;
&lt;p&gt;&lt;img src="https://daemon365.dev/images/52795638-fd1a-4286-bfc7-170869122330.png" alt=""&gt;&lt;/p&gt;
&lt;p&gt;kubelet 的架构由 N 多的组件组成，下面简单介绍下比较重要的几个：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Sync Loop: 这是Kubelet活动的核心，负责同步Pod的状态。同步循环会定期从API服务器获取PodSpecs，并确保容器的当前状态与这些规格相匹配。&lt;/li&gt;
&lt;li&gt;PodConfig: 负责将各个配置源转换成 PodSpecs，可以选择的配置源包括：Kube-apiserver、本地文件、HTTP。&lt;/li&gt;
&lt;li&gt;PLEG(Pod Lifecycle Event Generator)： 负责监测和缓存Pod生命周期事件，如创建、启动或停止容器，然后将这些事件通知 Sync Loop。&lt;/li&gt;
&lt;li&gt;PodWorkers: 负责管理 Pod 的生命周期事件处理。当 Pod 生命周期事件 PLEG 检测到新的事件时，PodWorkers 会被调用来处理这些事件，包括启动新的 Pod、更新现有的 Pod、或者停止和清理不再需要的 Pod。&lt;/li&gt;
&lt;li&gt;PodManager: 存储 Pod 的期望状态，kubelet 服务的不同渠道的 Pod。&lt;/li&gt;
&lt;li&gt;ContainerRuntime: 顾名思义，容器运行时。与遵循 CRI 规范的高级容器运行时进行交互。&lt;/li&gt;
&lt;li&gt;StatsProvider: 提供节点和容器的统计信息，有 cAdvisor 和 CRI 两种实现。&lt;/li&gt;
&lt;li&gt;ProbeManager: 负责执行容器的健康检查，包括 Liveness，Startup 和 Readiness 检查。&lt;/li&gt;
&lt;li&gt;VolumeManager: 负责管理 Pod 的卷，包括挂载和卸载卷。&lt;/li&gt;
&lt;li&gt;ImageManager: 负责管理镜像，包括拉取、删除、镜像 GC 等。&lt;/li&gt;
&lt;li&gt;DeviceManager: 负责管理设备，包括 GPU、RDMA 等。&lt;/li&gt;
&lt;li&gt;PluginManager: PluginManager 运行一组异步循环，根据此节点确定哪些插件需要注册/取消注册并执行。如 CSI 驱动和设备管理器插件（Device Plugin）。&lt;/li&gt;
&lt;li&gt;CertificateManager: 处理证书轮换。&lt;/li&gt;
&lt;li&gt;OOMWatcher: 从系统日志中获取容器的 OOM 日志，将其封装成事件并记录。&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="流程"&gt;流程&lt;/h2&gt;
&lt;p&gt;首先在 &lt;code&gt;cmd/kubelet&lt;/code&gt; 中使用传入命令行参数的方式初始化配置，然后创建 &lt;code&gt;pkg/kubelet&lt;/code&gt; 中的 Bootstrap inferface, kubelet struct 实现了这个接口， 然后调用 &lt;code&gt;Run&lt;/code&gt; 方法启动 kubelet。&lt;/p&gt;</description><content:encoded><![CDATA[<h2 id="reference">Reference</h2>
<ul>
<li><a href="https://atbug.com/kubelet-source-code-analysis/">https://atbug.com/kubelet-source-code-analysis/</a></li>
</ul>
<h2 id="kubelet-简介">kubelet 简介</h2>
<p>kubernetes 分为控制面和数据面，kubelet 就是数据面最主要的组件，在每个节点上启动，主要负责容器的创建、启停、监控、日志收集等工作。它是一个在每个集群节点上运行的代理，负责确保节点上的容器根据PodSpec（Pod定义文件）正确运行。</p>
<p>Kubelet执行以下几项重要功能：</p>
<ul>
<li>Pod生命周期管理：Kubelet根据从API服务器接收到的PodSpecs创建、启动、终止容器。它负责启动Pod中的容器，并确保它们按预期运行。</li>
<li>节点状态监控：Kubelet定期监控节点和容器的状态，并将状态报告回集群的控制平面。这使得集群中的其他组件能够做出相应的调度决策。</li>
<li>资源管理：Kubelet负责管理分配给每个Pod的资源。这包括CPU、内存和磁盘存储资源。</li>
<li>健康检查：Kubelet可以执行容器健康检查，并根据检查结果决定是否需要重启容器。</li>
<li>与容器运行时的通信：Kubelet与容器运行时（如Docker、containerd等）通信，以管理容器的生命周期。</li>
<li>秘密和配置管理：Kubelet负责将秘密、配置映射等挂载到Pod的容器中，以便应用程序可以访问这些配置。</li>
<li>服务发现和负载均衡：尽管Kubelet本身不直接处理服务发现，但它通过设置网络规则和环境变量来支持容器内的服务发现机制。</li>
</ul>
<h2 id="kubelet-架构">kubelet 架构</h2>
<p><img src="/images/52795638-fd1a-4286-bfc7-170869122330.png" alt=""></p>
<p>kubelet 的架构由 N 多的组件组成，下面简单介绍下比较重要的几个：</p>
<ul>
<li>Sync Loop: 这是Kubelet活动的核心，负责同步Pod的状态。同步循环会定期从API服务器获取PodSpecs，并确保容器的当前状态与这些规格相匹配。</li>
<li>PodConfig: 负责将各个配置源转换成 PodSpecs，可以选择的配置源包括：Kube-apiserver、本地文件、HTTP。</li>
<li>PLEG(Pod Lifecycle Event Generator)： 负责监测和缓存Pod生命周期事件，如创建、启动或停止容器，然后将这些事件通知 Sync Loop。</li>
<li>PodWorkers: 负责管理 Pod 的生命周期事件处理。当 Pod 生命周期事件 PLEG 检测到新的事件时，PodWorkers 会被调用来处理这些事件，包括启动新的 Pod、更新现有的 Pod、或者停止和清理不再需要的 Pod。</li>
<li>PodManager: 存储 Pod 的期望状态，kubelet 服务的不同渠道的 Pod。</li>
<li>ContainerRuntime: 顾名思义，容器运行时。与遵循 CRI 规范的高级容器运行时进行交互。</li>
<li>StatsProvider: 提供节点和容器的统计信息，有 cAdvisor 和 CRI 两种实现。</li>
<li>ProbeManager: 负责执行容器的健康检查，包括 Liveness，Startup 和 Readiness 检查。</li>
<li>VolumeManager: 负责管理 Pod 的卷，包括挂载和卸载卷。</li>
<li>ImageManager: 负责管理镜像，包括拉取、删除、镜像 GC 等。</li>
<li>DeviceManager: 负责管理设备，包括 GPU、RDMA 等。</li>
<li>PluginManager: PluginManager 运行一组异步循环，根据此节点确定哪些插件需要注册/取消注册并执行。如 CSI 驱动和设备管理器插件（Device Plugin）。</li>
<li>CertificateManager: 处理证书轮换。</li>
<li>OOMWatcher: 从系统日志中获取容器的 OOM 日志，将其封装成事件并记录。</li>
</ul>
<h2 id="流程">流程</h2>
<p>首先在 <code>cmd/kubelet</code> 中使用传入命令行参数的方式初始化配置，然后创建 <code>pkg/kubelet</code> 中的 Bootstrap inferface, kubelet struct 实现了这个接口， 然后调用 <code>Run</code> 方法启动 kubelet。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-GO" data-lang="GO"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">startKubelet</span><span style="color:#111">(</span><span style="color:#75af00">k</span> <span style="color:#75af00">kubelet</span><span style="color:#111">.</span><span style="color:#75af00">Bootstrap</span><span style="color:#111">,</span> <span style="color:#75af00">podCfg</span> <span style="color:#f92672">*</span><span style="color:#75af00">config</span><span style="color:#111">.</span><span style="color:#75af00">PodConfig</span><span style="color:#111">,</span> <span style="color:#75af00">kubeCfg</span> <span style="color:#f92672">*</span><span style="color:#75af00">kubeletconfiginternal</span><span style="color:#111">.</span><span style="color:#75af00">KubeletConfiguration</span><span style="color:#111">,</span> <span style="color:#75af00">kubeDeps</span> <span style="color:#f92672">*</span><span style="color:#75af00">kubelet</span><span style="color:#111">.</span><span style="color:#75af00">Dependencies</span><span style="color:#111">,</span> <span style="color:#75af00">enableServer</span> <span style="color:#00a8c8">bool</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// start the kubelet</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">go</span> <span style="color:#75af00">k</span><span style="color:#111">.</span><span style="color:#75af00">Run</span><span style="color:#111">(</span><span style="color:#75af00">podCfg</span><span style="color:#111">.</span><span style="color:#75af00">Updates</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// start the kubelet server</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">enableServer</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">go</span> <span style="color:#75af00">k</span><span style="color:#111">.</span><span style="color:#75af00">ListenAndServe</span><span style="color:#111">(</span><span style="color:#75af00">kubeCfg</span><span style="color:#111">,</span> <span style="color:#75af00">kubeDeps</span><span style="color:#111">.</span><span style="color:#75af00">TLSOptions</span><span style="color:#111">,</span> <span style="color:#75af00">kubeDeps</span><span style="color:#111">.</span><span style="color:#75af00">Auth</span><span style="color:#111">,</span> <span style="color:#75af00">kubeDeps</span><span style="color:#111">.</span><span style="color:#75af00">TracerProvider</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">kubeCfg</span><span style="color:#111">.</span><span style="color:#75af00">ReadOnlyPort</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">go</span> <span style="color:#75af00">k</span><span style="color:#111">.</span><span style="color:#75af00">ListenAndServeReadOnly</span><span style="color:#111">(</span><span style="color:#75af00">netutils</span><span style="color:#111">.</span><span style="color:#75af00">ParseIPSloppy</span><span style="color:#111">(</span><span style="color:#75af00">kubeCfg</span><span style="color:#111">.</span><span style="color:#75af00">Address</span><span style="color:#111">),</span> <span style="color:#111">uint</span><span style="color:#111">(</span><span style="color:#75af00">kubeCfg</span><span style="color:#111">.</span><span style="color:#75af00">ReadOnlyPort</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">go</span> <span style="color:#75af00">k</span><span style="color:#111">.</span><span style="color:#75af00">ListenAndServePodResources</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="bootstrap">Bootstrap</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// Bootstrap is a bootstrapping interface for kubelet, targets the initialization protocol</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Bootstrap</span> <span style="color:#00a8c8">interface</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">GetConfiguration</span><span style="color:#111">()</span> <span style="color:#75af00">kubeletconfiginternal</span><span style="color:#111">.</span><span style="color:#75af00">KubeletConfiguration</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">BirthCry</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">StartGarbageCollection</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ListenAndServe</span><span style="color:#111">(</span><span style="color:#75af00">kubeCfg</span> <span style="color:#f92672">*</span><span style="color:#75af00">kubeletconfiginternal</span><span style="color:#111">.</span><span style="color:#75af00">KubeletConfiguration</span><span style="color:#111">,</span> <span style="color:#75af00">tlsOptions</span> <span style="color:#f92672">*</span><span style="color:#75af00">server</span><span style="color:#111">.</span><span style="color:#75af00">TLSOptions</span><span style="color:#111">,</span> <span style="color:#75af00">auth</span> <span style="color:#75af00">server</span><span style="color:#111">.</span><span style="color:#75af00">AuthInterface</span><span style="color:#111">,</span> <span style="color:#75af00">tp</span> <span style="color:#75af00">trace</span><span style="color:#111">.</span><span style="color:#75af00">TracerProvider</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ListenAndServeReadOnly</span><span style="color:#111">(</span><span style="color:#75af00">address</span> <span style="color:#75af00">net</span><span style="color:#111">.</span><span style="color:#75af00">IP</span><span style="color:#111">,</span> <span style="color:#75af00">port</span> <span style="color:#00a8c8">uint</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ListenAndServePodResources</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Run</span><span style="color:#111">(</span><span style="color:#f92672">&lt;-</span><span style="color:#00a8c8">chan</span> <span style="color:#75af00">kubetypes</span><span style="color:#111">.</span><span style="color:#75af00">PodUpdate</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">RunOnce</span><span style="color:#111">(</span><span style="color:#f92672">&lt;-</span><span style="color:#00a8c8">chan</span> <span style="color:#75af00">kubetypes</span><span style="color:#111">.</span><span style="color:#75af00">PodUpdate</span><span style="color:#111">)</span> <span style="color:#111">([]</span><span style="color:#75af00">RunPodResult</span><span style="color:#111">,</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Kubelet</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ...</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>方法：</p>
<ul>
<li>GetConfiguration: 获取 kubelet 的配置</li>
<li>BirthCry: 打印 kubelet 启动信息</li>
<li>StartGarbageCollection: 启动垃圾回收</li>
<li>ListenAndServe: 启动 kubelet 服务</li>
<li>ListenAndServeReadOnly: 启动只读服务</li>
<li>ListenAndServePodResources: 启动 pod 资源服务</li>
<li>Run: 启动 kubelet 的同步循环</li>
<li>RunOnce: 启动一次同步循环</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-GO" data-lang="GO"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">kl</span> <span style="color:#f92672">*</span><span style="color:#75af00">Kubelet</span><span style="color:#111">)</span> <span style="color:#75af00">StartGarbageCollection</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">loggedContainerGCFailure</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">false</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">go</span> <span style="color:#75af00">wait</span><span style="color:#111">.</span><span style="color:#75af00">Until</span><span style="color:#111">(</span><span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">ctx</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Background</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">containerGC</span><span style="color:#111">.</span><span style="color:#75af00">GarbageCollect</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">);</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">ErrorS</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Container garbage collection failed&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">recorder</span><span style="color:#111">.</span><span style="color:#75af00">Eventf</span><span style="color:#111">(</span><span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">nodeRef</span><span style="color:#111">,</span> <span style="color:#75af00">v1</span><span style="color:#111">.</span><span style="color:#75af00">EventTypeWarning</span><span style="color:#111">,</span> <span style="color:#75af00">events</span><span style="color:#111">.</span><span style="color:#75af00">ContainerGCFailed</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">.</span><span style="color:#75af00">Error</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">loggedContainerGCFailure</span> <span style="color:#111">=</span> <span style="color:#00a8c8">true</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">var</span> <span style="color:#75af00">vLevel</span> <span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">Level</span> <span style="color:#111">=</span> <span style="color:#ae81ff">4</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">loggedContainerGCFailure</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">vLevel</span> <span style="color:#111">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">loggedContainerGCFailure</span> <span style="color:#111">=</span> <span style="color:#00a8c8">false</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#75af00">vLevel</span><span style="color:#111">).</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Container garbage collection succeeded&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">},</span> <span style="color:#75af00">ContainerGCPeriod</span><span style="color:#111">,</span> <span style="color:#75af00">wait</span><span style="color:#111">.</span><span style="color:#75af00">NeverStop</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// when the high threshold is set to 100, stub the image GC manager</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">kubeletConfiguration</span><span style="color:#111">.</span><span style="color:#75af00">ImageGCHighThresholdPercent</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">100</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#ae81ff">2</span><span style="color:#111">).</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;ImageGCHighThresholdPercent is set 100, Disable image GC&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">prevImageGCFailed</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">false</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">go</span> <span style="color:#75af00">wait</span><span style="color:#111">.</span><span style="color:#75af00">Until</span><span style="color:#111">(</span><span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">ctx</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Background</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">imageManager</span><span style="color:#111">.</span><span style="color:#75af00">GarbageCollect</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">);</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">prevImageGCFailed</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">ErrorS</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Image garbage collection failed multiple times in a row&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// Only create an event for repeated failures</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">recorder</span><span style="color:#111">.</span><span style="color:#75af00">Eventf</span><span style="color:#111">(</span><span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">nodeRef</span><span style="color:#111">,</span> <span style="color:#75af00">v1</span><span style="color:#111">.</span><span style="color:#75af00">EventTypeWarning</span><span style="color:#111">,</span> <span style="color:#75af00">events</span><span style="color:#111">.</span><span style="color:#75af00">ImageGCFailed</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">.</span><span style="color:#75af00">Error</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">ErrorS</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Image garbage collection failed once. Stats initialization may not have completed yet&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">prevImageGCFailed</span> <span style="color:#111">=</span> <span style="color:#00a8c8">true</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">var</span> <span style="color:#75af00">vLevel</span> <span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">Level</span> <span style="color:#111">=</span> <span style="color:#ae81ff">4</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">prevImageGCFailed</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">vLevel</span> <span style="color:#111">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">prevImageGCFailed</span> <span style="color:#111">=</span> <span style="color:#00a8c8">false</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#75af00">vLevel</span><span style="color:#111">).</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Image garbage collection succeeded&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">},</span> <span style="color:#75af00">ImageGCPeriod</span><span style="color:#111">,</span> <span style="color:#75af00">wait</span><span style="color:#111">.</span><span style="color:#75af00">NeverStop</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>大致的流程为使用 <code>containerGC</code> 启动容器垃圾回收，当ImageGCHighThresholdPercent 为100时，不启动镜像垃圾回收，否则使用 <code>imageManager</code> 启动镜像垃圾回收。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-GO" data-lang="GO"><span style="display:flex;"><span><span style="color:#75715e">// RunOnce polls from one configuration update and run the associated pods.</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">kl</span> <span style="color:#f92672">*</span><span style="color:#75af00">Kubelet</span><span style="color:#111">)</span> <span style="color:#75af00">RunOnce</span><span style="color:#111">(</span><span style="color:#75af00">updates</span> <span style="color:#f92672">&lt;-</span><span style="color:#00a8c8">chan</span> <span style="color:#75af00">kubetypes</span><span style="color:#111">.</span><span style="color:#75af00">PodUpdate</span><span style="color:#111">)</span> <span style="color:#111">([]</span><span style="color:#75af00">RunPodResult</span><span style="color:#111">,</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ctx</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Background</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Setup filesystem directories.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">setupDataDirs</span><span style="color:#111">();</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// If the container logs directory does not exist, create it.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">Stat</span><span style="color:#111">(</span><span style="color:#75af00">ContainerLogsDir</span><span style="color:#111">);</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">MkdirAll</span><span style="color:#111">(</span><span style="color:#75af00">ContainerLogsDir</span><span style="color:#111">,</span> <span style="color:#ae81ff">0755</span><span style="color:#111">);</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">ErrorS</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Failed to create directory&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;path&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">ContainerLogsDir</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">select</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">case</span> <span style="color:#75af00">u</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#75af00">updates</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Processing manifest with pods&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;numPods&#34;</span><span style="color:#111">,</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">u</span><span style="color:#111">.</span><span style="color:#75af00">Pods</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">result</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">runOnce</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">u</span><span style="color:#111">.</span><span style="color:#75af00">Pods</span><span style="color:#111">,</span> <span style="color:#75af00">runOnceRetryDelay</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Finished processing pods&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;numPods&#34;</span><span style="color:#111">,</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">u</span><span style="color:#111">.</span><span style="color:#75af00">Pods</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">result</span><span style="color:#111">,</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">After</span><span style="color:#111">(</span><span style="color:#75af00">runOnceManifestDelay</span><span style="color:#111">):</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;no pod manifest update after %v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">runOnceManifestDelay</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// runOnce runs a given set of pods and returns their status.</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">kl</span> <span style="color:#f92672">*</span><span style="color:#75af00">Kubelet</span><span style="color:#111">)</span> <span style="color:#75af00">runOnce</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">,</span> <span style="color:#75af00">pods</span> <span style="color:#111">[]</span><span style="color:#f92672">*</span><span style="color:#75af00">v1</span><span style="color:#111">.</span><span style="color:#75af00">Pod</span><span style="color:#111">,</span> <span style="color:#75af00">retryDelay</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Duration</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#75af00">results</span> <span style="color:#111">[]</span><span style="color:#75af00">RunPodResult</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ch</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">chan</span> <span style="color:#75af00">RunPodResult</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">admitted</span> <span style="color:#f92672">:=</span> <span style="color:#111">[]</span><span style="color:#f92672">*</span><span style="color:#75af00">v1</span><span style="color:#111">.</span><span style="color:#75af00">Pod</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">pod</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">pods</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Check if we can admit the pod.</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">ok</span><span style="color:#111">,</span> <span style="color:#75af00">reason</span><span style="color:#111">,</span> <span style="color:#75af00">message</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">canAdmitPod</span><span style="color:#111">(</span><span style="color:#75af00">admitted</span><span style="color:#111">,</span> <span style="color:#75af00">pod</span><span style="color:#111">);</span> <span style="color:#111">!</span><span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">rejectPod</span><span style="color:#111">(</span><span style="color:#75af00">pod</span><span style="color:#111">,</span> <span style="color:#75af00">reason</span><span style="color:#111">,</span> <span style="color:#75af00">message</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">results</span> <span style="color:#111">=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">results</span><span style="color:#111">,</span> <span style="color:#75af00">RunPodResult</span><span style="color:#111">{</span><span style="color:#75af00">pod</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span><span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">continue</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">admitted</span> <span style="color:#111">=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">admitted</span><span style="color:#111">,</span> <span style="color:#75af00">pod</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">go</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">pod</span> <span style="color:#f92672">*</span><span style="color:#75af00">v1</span><span style="color:#111">.</span><span style="color:#75af00">Pod</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">runPod</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">pod</span><span style="color:#111">,</span> <span style="color:#75af00">retryDelay</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">ch</span> <span style="color:#f92672">&lt;-</span> <span style="color:#75af00">RunPodResult</span><span style="color:#111">{</span><span style="color:#75af00">pod</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}(</span><span style="color:#75af00">pod</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Waiting for pods&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;numPods&#34;</span><span style="color:#111">,</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">admitted</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">failedPods</span> <span style="color:#f92672">:=</span> <span style="color:#111">[]</span><span style="color:#00a8c8">string</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span><span style="color:#111">;</span> <span style="color:#75af00">i</span> <span style="color:#111">&lt;</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">admitted</span><span style="color:#111">);</span> <span style="color:#75af00">i</span><span style="color:#f92672">++</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">res</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#75af00">ch</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">results</span> <span style="color:#111">=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">results</span><span style="color:#111">,</span> <span style="color:#75af00">res</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">res</span><span style="color:#111">.</span><span style="color:#75af00">Err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">failedContainerName</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">getFailedContainers</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">res</span><span style="color:#111">.</span><span style="color:#75af00">Pod</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Unable to get failed containers&#39; names for pod&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;pod&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">KObj</span><span style="color:#111">(</span><span style="color:#75af00">res</span><span style="color:#111">.</span><span style="color:#75af00">Pod</span><span style="color:#111">),</span> <span style="color:#d88200">&#34;err&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Unable to start pod because container failed&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;pod&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">KObj</span><span style="color:#111">(</span><span style="color:#75af00">res</span><span style="color:#111">.</span><span style="color:#75af00">Pod</span><span style="color:#111">),</span> <span style="color:#d88200">&#34;containerName&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">failedContainerName</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">failedPods</span> <span style="color:#111">=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">failedPods</span><span style="color:#111">,</span> <span style="color:#75af00">format</span><span style="color:#111">.</span><span style="color:#75af00">Pod</span><span style="color:#111">(</span><span style="color:#75af00">res</span><span style="color:#111">.</span><span style="color:#75af00">Pod</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Started pod&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;pod&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">KObj</span><span style="color:#111">(</span><span style="color:#75af00">res</span><span style="color:#111">.</span><span style="color:#75af00">Pod</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">failedPods</span><span style="color:#111">)</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">results</span><span style="color:#111">,</span> <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;error running pods: %v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">failedPods</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Pods started&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;numPods&#34;</span><span style="color:#111">,</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">pods</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">results</span><span style="color:#111">,</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>大致作用为从 <code>updates</code> 中获取 PodUpdate，然后调用 <code>runOnce</code> 方法，该方法会调用 <code>runPod</code> 方法启动 Pod。</p>
<h3 id="run">Run</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-GO" data-lang="GO"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">kl</span> <span style="color:#f92672">*</span><span style="color:#75af00">Kubelet</span><span style="color:#111">)</span> <span style="color:#75af00">Run</span><span style="color:#111">(</span><span style="color:#75af00">updates</span> <span style="color:#f92672">&lt;-</span><span style="color:#00a8c8">chan</span> <span style="color:#75af00">kubetypes</span><span style="color:#111">.</span><span style="color:#75af00">PodUpdate</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ctx</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Background</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">logServer</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">file</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">FileServer</span><span style="color:#111">(</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Dir</span><span style="color:#111">(</span><span style="color:#75af00">nodeLogDir</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">utilfeature</span><span style="color:#111">.</span><span style="color:#75af00">DefaultFeatureGate</span><span style="color:#111">.</span><span style="color:#75af00">Enabled</span><span style="color:#111">(</span><span style="color:#75af00">features</span><span style="color:#111">.</span><span style="color:#75af00">NodeLogQuery</span><span style="color:#111">)</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">kubeletConfiguration</span><span style="color:#111">.</span><span style="color:#75af00">EnableSystemLogQuery</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">logServer</span> <span style="color:#111">=</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">StripPrefix</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/logs/&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">HandlerFunc</span><span style="color:#111">(</span><span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">w</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">ResponseWriter</span><span style="color:#111">,</span> <span style="color:#75af00">req</span> <span style="color:#f92672">*</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Request</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">if</span> <span style="color:#75af00">nlq</span><span style="color:#111">,</span> <span style="color:#75af00">errs</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">newNodeLogQuery</span><span style="color:#111">(</span><span style="color:#75af00">req</span><span style="color:#111">.</span><span style="color:#75af00">URL</span><span style="color:#111">.</span><span style="color:#75af00">Query</span><span style="color:#111">());</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">errs</span><span style="color:#111">)</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Error</span><span style="color:#111">(</span><span style="color:#75af00">w</span><span style="color:#111">,</span> <span style="color:#75af00">errs</span><span style="color:#111">.</span><span style="color:#75af00">ToAggregate</span><span style="color:#111">().</span><span style="color:#75af00">Error</span><span style="color:#111">(),</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">StatusBadRequest</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>					<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>				<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#00a8c8">if</span> <span style="color:#75af00">nlq</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#00a8c8">if</span> <span style="color:#75af00">req</span><span style="color:#111">.</span><span style="color:#75af00">URL</span><span style="color:#111">.</span><span style="color:#75af00">Path</span> <span style="color:#f92672">!=</span> <span style="color:#d88200">&#34;/&#34;</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">req</span><span style="color:#111">.</span><span style="color:#75af00">URL</span><span style="color:#111">.</span><span style="color:#75af00">Path</span> <span style="color:#f92672">!=</span> <span style="color:#d88200">&#34;&#34;</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>						<span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Error</span><span style="color:#111">(</span><span style="color:#75af00">w</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;path not allowed in query mode&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">StatusNotAcceptable</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>						<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>					<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>					<span style="color:#00a8c8">if</span> <span style="color:#75af00">errs</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">nlq</span><span style="color:#111">.</span><span style="color:#75af00">validate</span><span style="color:#111">();</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">errs</span><span style="color:#111">)</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>						<span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Error</span><span style="color:#111">(</span><span style="color:#75af00">w</span><span style="color:#111">,</span> <span style="color:#75af00">errs</span><span style="color:#111">.</span><span style="color:#75af00">ToAggregate</span><span style="color:#111">().</span><span style="color:#75af00">Error</span><span style="color:#111">(),</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">StatusNotAcceptable</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>						<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>					<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75715e">// Validation ensures that the request does not query services and files at the same time</span>
</span></span><span style="display:flex;"><span>					<span style="color:#00a8c8">if</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">nlq</span><span style="color:#111">.</span><span style="color:#75af00">Services</span><span style="color:#111">)</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>						<span style="color:#75af00">journal</span><span style="color:#111">.</span><span style="color:#75af00">ServeHTTP</span><span style="color:#111">(</span><span style="color:#75af00">w</span><span style="color:#111">,</span> <span style="color:#75af00">req</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>						<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>					<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75715e">// Validation ensures that the request does not explicitly query multiple files at the same time</span>
</span></span><span style="display:flex;"><span>					<span style="color:#00a8c8">if</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">nlq</span><span style="color:#111">.</span><span style="color:#75af00">Files</span><span style="color:#111">)</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>						<span style="color:#75715e">// Account for the \ being used on Windows clients</span>
</span></span><span style="display:flex;"><span>						<span style="color:#75af00">req</span><span style="color:#111">.</span><span style="color:#75af00">URL</span><span style="color:#111">.</span><span style="color:#75af00">Path</span> <span style="color:#111">=</span> <span style="color:#75af00">filepath</span><span style="color:#111">.</span><span style="color:#75af00">ToSlash</span><span style="color:#111">(</span><span style="color:#75af00">nlq</span><span style="color:#111">.</span><span style="color:#75af00">Files</span><span style="color:#111">[</span><span style="color:#ae81ff">0</span><span style="color:#111">])</span>
</span></span><span style="display:flex;"><span>					<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>				<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// Fall back in case the caller is directly trying to query a file</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// Example: kubectl get --raw /api/v1/nodes/$name/proxy/logs/foo.log</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">file</span><span style="color:#111">.</span><span style="color:#75af00">ServeHTTP</span><span style="color:#111">(</span><span style="color:#75af00">w</span><span style="color:#111">,</span> <span style="color:#75af00">req</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">logServer</span> <span style="color:#111">=</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">StripPrefix</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/logs/&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">file</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">kubeClient</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;No API server defined - no node status update will be sent&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Start the cloud provider sync manager</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">cloudResourceSyncManager</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">go</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">cloudResourceSyncManager</span><span style="color:#111">.</span><span style="color:#75af00">Run</span><span style="color:#111">(</span><span style="color:#75af00">wait</span><span style="color:#111">.</span><span style="color:#75af00">NeverStop</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">initializeModules</span><span style="color:#111">();</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">recorder</span><span style="color:#111">.</span><span style="color:#75af00">Eventf</span><span style="color:#111">(</span><span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">nodeRef</span><span style="color:#111">,</span> <span style="color:#75af00">v1</span><span style="color:#111">.</span><span style="color:#75af00">EventTypeWarning</span><span style="color:#111">,</span> <span style="color:#75af00">events</span><span style="color:#111">.</span><span style="color:#75af00">KubeletSetupFailed</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">.</span><span style="color:#75af00">Error</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">ErrorS</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Failed to initialize internal modules&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">Exit</span><span style="color:#111">(</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Start volume manager</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">go</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">volumeManager</span><span style="color:#111">.</span><span style="color:#75af00">Run</span><span style="color:#111">(</span><span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">sourcesReady</span><span style="color:#111">,</span> <span style="color:#75af00">wait</span><span style="color:#111">.</span><span style="color:#75af00">NeverStop</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">kubeClient</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Start two go-routines to update the status.</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">		// The first will report to the apiserver every nodeStatusUpdateFrequency and is aimed to provide regular status intervals,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// while the second is used to provide a more timely status update during initialization and runs an one-shot update to the apiserver</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// once the node becomes ready, then exits afterwards.</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">		// Introduce some small jittering to ensure that over time the requests won&#39;t start</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// accumulating at approximately the same time from the set of nodes due to priority and</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// fairness effect.</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">go</span> <span style="color:#75af00">wait</span><span style="color:#111">.</span><span style="color:#75af00">JitterUntil</span><span style="color:#111">(</span><span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">syncNodeStatus</span><span style="color:#111">,</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">nodeStatusUpdateFrequency</span><span style="color:#111">,</span> <span style="color:#ae81ff">0.04</span><span style="color:#111">,</span> <span style="color:#00a8c8">true</span><span style="color:#111">,</span> <span style="color:#75af00">wait</span><span style="color:#111">.</span><span style="color:#75af00">NeverStop</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">go</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">fastStatusUpdateOnce</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// start syncing lease</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">go</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">nodeLeaseController</span><span style="color:#111">.</span><span style="color:#75af00">Run</span><span style="color:#111">(</span><span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Background</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">go</span> <span style="color:#75af00">wait</span><span style="color:#111">.</span><span style="color:#75af00">Until</span><span style="color:#111">(</span><span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">updateRuntimeUp</span><span style="color:#111">,</span> <span style="color:#ae81ff">5</span><span style="color:#f92672">*</span><span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Second</span><span style="color:#111">,</span> <span style="color:#75af00">wait</span><span style="color:#111">.</span><span style="color:#75af00">NeverStop</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Set up iptables util rules</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">makeIPTablesUtilChains</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">initNetworkUtil</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Start component sync loops.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">statusManager</span><span style="color:#111">.</span><span style="color:#75af00">Start</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Start syncing RuntimeClasses if enabled.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">runtimeClassManager</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">runtimeClassManager</span><span style="color:#111">.</span><span style="color:#75af00">Start</span><span style="color:#111">(</span><span style="color:#75af00">wait</span><span style="color:#111">.</span><span style="color:#75af00">NeverStop</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Start the pod lifecycle event generator.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">pleg</span><span style="color:#111">.</span><span style="color:#75af00">Start</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Start eventedPLEG only if EventedPLEG feature gate is enabled.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">utilfeature</span><span style="color:#111">.</span><span style="color:#75af00">DefaultFeatureGate</span><span style="color:#111">.</span><span style="color:#75af00">Enabled</span><span style="color:#111">(</span><span style="color:#75af00">features</span><span style="color:#111">.</span><span style="color:#75af00">EventedPLEG</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">eventedPleg</span><span style="color:#111">.</span><span style="color:#75af00">Start</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">syncLoop</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">updates</span><span style="color:#111">,</span> <span style="color:#75af00">kl</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>代码的流程为：</p>
<ol>
<li>检查是否需要创建日志服务器 如果需要则创建</li>
<li>启动云提供商同步管理器</li>
<li>初始化模块，如果出错则打印日志并退出</li>
<li>启动卷管理器</li>
<li>启动两个 goroutine 来更新状态，一个是定时更新，一个是在初始化时更新</li>
<li>启动同步租约的goroutine</li>
<li>定期更新RuntimeUp状态的goroutine</li>
<li>设置iptables规则</li>
<li>启动组件同步循环</li>
<li>如果启用了RuntimeClasses，则启动RuntimeClasses同步循环</li>
<li>启动Pod Lifecycle Event Generator</li>
<li>如果启用了EventedPLEG特性，则启动EventedPLEG</li>
<li>启动 syncloop</li>
</ol>
<h3 id="syncloop">syncLoop</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-GO" data-lang="GO"><span style="display:flex;"><span><span style="color:#75715e">// syncLoop is the main loop for processing changes. It watches for changes from</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// three channels (file, apiserver, and http) and creates a union of them. For</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// any new change seen, will run a sync against desired state and running state. If</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// no changes are seen to the configuration, will synchronize the last known desired</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// state every sync-frequency seconds. Never returns.</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">kl</span> <span style="color:#f92672">*</span><span style="color:#75af00">Kubelet</span><span style="color:#111">)</span> <span style="color:#75af00">syncLoop</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">,</span> <span style="color:#75af00">updates</span> <span style="color:#f92672">&lt;-</span><span style="color:#00a8c8">chan</span> <span style="color:#75af00">kubetypes</span><span style="color:#111">.</span><span style="color:#75af00">PodUpdate</span><span style="color:#111">,</span> <span style="color:#75af00">handler</span> <span style="color:#75af00">SyncHandler</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Starting kubelet main sync loop&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// The syncTicker wakes up kubelet to checks if there are any pod workers</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// that need to be sync&#39;d. A one-second period is sufficient because the</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// sync interval is defaulted to 10s.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">syncTicker</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">NewTicker</span><span style="color:#111">(</span><span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Second</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">syncTicker</span><span style="color:#111">.</span><span style="color:#75af00">Stop</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">housekeepingTicker</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">NewTicker</span><span style="color:#111">(</span><span style="color:#75af00">housekeepingPeriod</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">housekeepingTicker</span><span style="color:#111">.</span><span style="color:#75af00">Stop</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">plegCh</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">pleg</span><span style="color:#111">.</span><span style="color:#75af00">Watch</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">const</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">base</span>   <span style="color:#111">=</span> <span style="color:#ae81ff">100</span> <span style="color:#f92672">*</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Millisecond</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">max</span>    <span style="color:#111">=</span> <span style="color:#ae81ff">5</span> <span style="color:#f92672">*</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Second</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">factor</span> <span style="color:#111">=</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">duration</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">base</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Responsible for checking limits in resolv.conf</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// The limits do not have anything to do with individual pods</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Since this is called in syncLoop, we don&#39;t need to call it anywhere else</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">dnsConfigurer</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">dnsConfigurer</span><span style="color:#111">.</span><span style="color:#75af00">ResolverConfig</span> <span style="color:#f92672">!=</span> <span style="color:#d88200">&#34;&#34;</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">dnsConfigurer</span><span style="color:#111">.</span><span style="color:#75af00">CheckLimitsForResolvConf</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">runtimeState</span><span style="color:#111">.</span><span style="color:#75af00">runtimeErrors</span><span style="color:#111">();</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">ErrorS</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Skipping pod synchronization&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// exponential backoff</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Sleep</span><span style="color:#111">(</span><span style="color:#75af00">duration</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">duration</span> <span style="color:#111">=</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Duration</span><span style="color:#111">(</span><span style="color:#75af00">math</span><span style="color:#111">.</span><span style="color:#75af00">Min</span><span style="color:#111">(</span><span style="color:#111">float64</span><span style="color:#111">(</span><span style="color:#75af00">max</span><span style="color:#111">),</span> <span style="color:#75af00">factor</span><span style="color:#f92672">*</span><span style="color:#111">float64</span><span style="color:#111">(</span><span style="color:#75af00">duration</span><span style="color:#111">)))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">continue</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// reset backoff if we have a success</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">duration</span> <span style="color:#111">=</span> <span style="color:#75af00">base</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">syncLoopMonitor</span><span style="color:#111">.</span><span style="color:#75af00">Store</span><span style="color:#111">(</span><span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">clock</span><span style="color:#111">.</span><span style="color:#75af00">Now</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">syncLoopIteration</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">updates</span><span style="color:#111">,</span> <span style="color:#75af00">handler</span><span style="color:#111">,</span> <span style="color:#75af00">syncTicker</span><span style="color:#111">.</span><span style="color:#75af00">C</span><span style="color:#111">,</span> <span style="color:#75af00">housekeepingTicker</span><span style="color:#111">.</span><span style="color:#75af00">C</span><span style="color:#111">,</span> <span style="color:#75af00">plegCh</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">break</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">syncLoopMonitor</span><span style="color:#111">.</span><span style="color:#75af00">Store</span><span style="color:#111">(</span><span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">clock</span><span style="color:#111">.</span><span style="color:#75af00">Now</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>代码流程为：</p>
<ol>
<li>从 pleg 获取 update 事件 他是一个 channel</li>
<li>进入循环 如果 runtimeState 有错误 sleep 一会儿然后跳过</li>
<li>执行  syncLoopIteration</li>
</ol>
<h4 id="syncloopiteration">syncLoopIteration</h4>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">kl</span> <span style="color:#f92672">*</span><span style="color:#75af00">Kubelet</span><span style="color:#111">)</span> <span style="color:#75af00">syncLoopIteration</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">,</span> <span style="color:#75af00">configCh</span> <span style="color:#f92672">&lt;-</span><span style="color:#00a8c8">chan</span> <span style="color:#75af00">kubetypes</span><span style="color:#111">.</span><span style="color:#75af00">PodUpdate</span><span style="color:#111">,</span> <span style="color:#75af00">handler</span> <span style="color:#75af00">SyncHandler</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">syncCh</span> <span style="color:#f92672">&lt;-</span><span style="color:#00a8c8">chan</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Time</span><span style="color:#111">,</span> <span style="color:#75af00">housekeepingCh</span> <span style="color:#f92672">&lt;-</span><span style="color:#00a8c8">chan</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Time</span><span style="color:#111">,</span> <span style="color:#75af00">plegCh</span> <span style="color:#f92672">&lt;-</span><span style="color:#00a8c8">chan</span> <span style="color:#f92672">*</span><span style="color:#75af00">pleg</span><span style="color:#111">.</span><span style="color:#75af00">PodLifecycleEvent</span><span style="color:#111">)</span> <span style="color:#00a8c8">bool</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">select</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">case</span> <span style="color:#75af00">u</span><span style="color:#111">,</span> <span style="color:#75af00">open</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#75af00">configCh</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Update from a config source; dispatch it to the right handler</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// callback.</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">open</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">ErrorS</span><span style="color:#111">(</span><span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Update channel is closed, exiting the sync loop&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">false</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">switch</span> <span style="color:#75af00">u</span><span style="color:#111">.</span><span style="color:#75af00">Op</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">case</span> <span style="color:#75af00">kubetypes</span><span style="color:#111">.</span><span style="color:#75af00">ADD</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#ae81ff">2</span><span style="color:#111">).</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;SyncLoop ADD&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;source&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">u</span><span style="color:#111">.</span><span style="color:#75af00">Source</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;pods&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">KObjSlice</span><span style="color:#111">(</span><span style="color:#75af00">u</span><span style="color:#111">.</span><span style="color:#75af00">Pods</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// After restarting, kubelet will get all existing pods through</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// ADD as if they are new pods. These pods will then go through the</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// admission process and *may* be rejected. This can be resolved</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// once we have checkpointing.</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">handler</span><span style="color:#111">.</span><span style="color:#75af00">HandlePodAdditions</span><span style="color:#111">(</span><span style="color:#75af00">u</span><span style="color:#111">.</span><span style="color:#75af00">Pods</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">case</span> <span style="color:#75af00">kubetypes</span><span style="color:#111">.</span><span style="color:#75af00">UPDATE</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#ae81ff">2</span><span style="color:#111">).</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;SyncLoop UPDATE&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;source&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">u</span><span style="color:#111">.</span><span style="color:#75af00">Source</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;pods&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">KObjSlice</span><span style="color:#111">(</span><span style="color:#75af00">u</span><span style="color:#111">.</span><span style="color:#75af00">Pods</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">handler</span><span style="color:#111">.</span><span style="color:#75af00">HandlePodUpdates</span><span style="color:#111">(</span><span style="color:#75af00">u</span><span style="color:#111">.</span><span style="color:#75af00">Pods</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">case</span> <span style="color:#75af00">kubetypes</span><span style="color:#111">.</span><span style="color:#75af00">REMOVE</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#ae81ff">2</span><span style="color:#111">).</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;SyncLoop REMOVE&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;source&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">u</span><span style="color:#111">.</span><span style="color:#75af00">Source</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;pods&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">KObjSlice</span><span style="color:#111">(</span><span style="color:#75af00">u</span><span style="color:#111">.</span><span style="color:#75af00">Pods</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">handler</span><span style="color:#111">.</span><span style="color:#75af00">HandlePodRemoves</span><span style="color:#111">(</span><span style="color:#75af00">u</span><span style="color:#111">.</span><span style="color:#75af00">Pods</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">case</span> <span style="color:#75af00">kubetypes</span><span style="color:#111">.</span><span style="color:#75af00">RECONCILE</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#ae81ff">4</span><span style="color:#111">).</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;SyncLoop RECONCILE&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;source&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">u</span><span style="color:#111">.</span><span style="color:#75af00">Source</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;pods&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">KObjSlice</span><span style="color:#111">(</span><span style="color:#75af00">u</span><span style="color:#111">.</span><span style="color:#75af00">Pods</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">handler</span><span style="color:#111">.</span><span style="color:#75af00">HandlePodReconcile</span><span style="color:#111">(</span><span style="color:#75af00">u</span><span style="color:#111">.</span><span style="color:#75af00">Pods</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">case</span> <span style="color:#75af00">kubetypes</span><span style="color:#111">.</span><span style="color:#75af00">DELETE</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#ae81ff">2</span><span style="color:#111">).</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;SyncLoop DELETE&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;source&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">u</span><span style="color:#111">.</span><span style="color:#75af00">Source</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;pods&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">KObjSlice</span><span style="color:#111">(</span><span style="color:#75af00">u</span><span style="color:#111">.</span><span style="color:#75af00">Pods</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// DELETE is treated as a UPDATE because of graceful deletion.</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">handler</span><span style="color:#111">.</span><span style="color:#75af00">HandlePodUpdates</span><span style="color:#111">(</span><span style="color:#75af00">u</span><span style="color:#111">.</span><span style="color:#75af00">Pods</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">case</span> <span style="color:#75af00">kubetypes</span><span style="color:#111">.</span><span style="color:#75af00">SET</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// TODO: Do we want to support this?</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">ErrorS</span><span style="color:#111">(</span><span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Kubelet does not support snapshot update&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">default</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">ErrorS</span><span style="color:#111">(</span><span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Invalid operation type received&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;operation&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">u</span><span style="color:#111">.</span><span style="color:#75af00">Op</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">sourcesReady</span><span style="color:#111">.</span><span style="color:#75af00">AddSource</span><span style="color:#111">(</span><span style="color:#75af00">u</span><span style="color:#111">.</span><span style="color:#75af00">Source</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">case</span> <span style="color:#75af00">e</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#75af00">plegCh</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">isSyncPodWorthy</span><span style="color:#111">(</span><span style="color:#75af00">e</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// PLEG event for a pod; sync it.</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">pod</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">podManager</span><span style="color:#111">.</span><span style="color:#75af00">GetPodByUID</span><span style="color:#111">(</span><span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">ID</span><span style="color:#111">);</span> <span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#ae81ff">2</span><span style="color:#111">).</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;SyncLoop (PLEG): event for pod&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;pod&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">KObj</span><span style="color:#111">(</span><span style="color:#75af00">pod</span><span style="color:#111">),</span> <span style="color:#d88200">&#34;event&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">e</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">handler</span><span style="color:#111">.</span><span style="color:#75af00">HandlePodSyncs</span><span style="color:#111">([]</span><span style="color:#f92672">*</span><span style="color:#75af00">v1</span><span style="color:#111">.</span><span style="color:#75af00">Pod</span><span style="color:#111">{</span><span style="color:#75af00">pod</span><span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// If the pod no longer exists, ignore the event.</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#ae81ff">4</span><span style="color:#111">).</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;SyncLoop (PLEG): pod does not exist, ignore irrelevant event&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;event&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">e</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">Type</span> <span style="color:#f92672">==</span> <span style="color:#75af00">pleg</span><span style="color:#111">.</span><span style="color:#75af00">ContainerDied</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">containerID</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">Data</span><span style="color:#111">.(</span><span style="color:#00a8c8">string</span><span style="color:#111">);</span> <span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">cleanUpContainersInPod</span><span style="color:#111">(</span><span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">ID</span><span style="color:#111">,</span> <span style="color:#75af00">containerID</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#75af00">syncCh</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Sync pods waiting for sync</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">podsToSync</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">getPodsToSync</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">podsToSync</span><span style="color:#111">)</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">break</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#ae81ff">4</span><span style="color:#111">).</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;SyncLoop (SYNC) pods&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;total&#34;</span><span style="color:#111">,</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">podsToSync</span><span style="color:#111">),</span> <span style="color:#d88200">&#34;pods&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">KObjSlice</span><span style="color:#111">(</span><span style="color:#75af00">podsToSync</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">handler</span><span style="color:#111">.</span><span style="color:#75af00">HandlePodSyncs</span><span style="color:#111">(</span><span style="color:#75af00">podsToSync</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">case</span> <span style="color:#75af00">update</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">livenessManager</span><span style="color:#111">.</span><span style="color:#75af00">Updates</span><span style="color:#111">():</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">update</span><span style="color:#111">.</span><span style="color:#75af00">Result</span> <span style="color:#f92672">==</span> <span style="color:#75af00">proberesults</span><span style="color:#111">.</span><span style="color:#75af00">Failure</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">handleProbeSync</span><span style="color:#111">(</span><span style="color:#75af00">kl</span><span style="color:#111">,</span> <span style="color:#75af00">update</span><span style="color:#111">,</span> <span style="color:#75af00">handler</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;liveness&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;unhealthy&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">case</span> <span style="color:#75af00">update</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">readinessManager</span><span style="color:#111">.</span><span style="color:#75af00">Updates</span><span style="color:#111">():</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">ready</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">update</span><span style="color:#111">.</span><span style="color:#75af00">Result</span> <span style="color:#f92672">==</span> <span style="color:#75af00">proberesults</span><span style="color:#111">.</span><span style="color:#75af00">Success</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">statusManager</span><span style="color:#111">.</span><span style="color:#75af00">SetContainerReadiness</span><span style="color:#111">(</span><span style="color:#75af00">update</span><span style="color:#111">.</span><span style="color:#75af00">PodUID</span><span style="color:#111">,</span> <span style="color:#75af00">update</span><span style="color:#111">.</span><span style="color:#75af00">ContainerID</span><span style="color:#111">,</span> <span style="color:#75af00">ready</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">status</span> <span style="color:#f92672">:=</span> <span style="color:#d88200">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">ready</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">status</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;ready&#34;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">handleProbeSync</span><span style="color:#111">(</span><span style="color:#75af00">kl</span><span style="color:#111">,</span> <span style="color:#75af00">update</span><span style="color:#111">,</span> <span style="color:#75af00">handler</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;readiness&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">status</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">case</span> <span style="color:#75af00">update</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">startupManager</span><span style="color:#111">.</span><span style="color:#75af00">Updates</span><span style="color:#111">():</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">started</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">update</span><span style="color:#111">.</span><span style="color:#75af00">Result</span> <span style="color:#f92672">==</span> <span style="color:#75af00">proberesults</span><span style="color:#111">.</span><span style="color:#75af00">Success</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">statusManager</span><span style="color:#111">.</span><span style="color:#75af00">SetContainerStartup</span><span style="color:#111">(</span><span style="color:#75af00">update</span><span style="color:#111">.</span><span style="color:#75af00">PodUID</span><span style="color:#111">,</span> <span style="color:#75af00">update</span><span style="color:#111">.</span><span style="color:#75af00">ContainerID</span><span style="color:#111">,</span> <span style="color:#75af00">started</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">status</span> <span style="color:#f92672">:=</span> <span style="color:#d88200">&#34;unhealthy&#34;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">started</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">status</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;started&#34;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">handleProbeSync</span><span style="color:#111">(</span><span style="color:#75af00">kl</span><span style="color:#111">,</span> <span style="color:#75af00">update</span><span style="color:#111">,</span> <span style="color:#75af00">handler</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;startup&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">status</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#75af00">housekeepingCh</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">sourcesReady</span><span style="color:#111">.</span><span style="color:#75af00">AllReady</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// If the sources aren&#39;t ready or volume manager has not yet synced the states,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// skip housekeeping, as we may accidentally delete pods from unready sources.</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#ae81ff">4</span><span style="color:#111">).</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;SyncLoop (housekeeping, skipped): sources aren&#39;t ready yet&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">start</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Now</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#ae81ff">4</span><span style="color:#111">).</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;SyncLoop (housekeeping)&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">handler</span><span style="color:#111">.</span><span style="color:#75af00">HandlePodCleanups</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">);</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">ErrorS</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Failed cleaning pods&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">duration</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Since</span><span style="color:#111">(</span><span style="color:#75af00">start</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">duration</span> <span style="color:#111">&gt;</span> <span style="color:#75af00">housekeepingWarningDuration</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">ErrorS</span><span style="color:#111">(</span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;housekeeping took too long&#34;</span><span style="color:#111">),</span> <span style="color:#d88200">&#34;Housekeeping took longer than expected&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;expected&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">housekeepingWarningDuration</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;actual&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">duration</span><span style="color:#111">.</span><span style="color:#75af00">Round</span><span style="color:#111">(</span><span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Millisecond</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#ae81ff">4</span><span style="color:#111">).</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;SyncLoop (housekeeping) end&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;duration&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">duration</span><span style="color:#111">.</span><span style="color:#75af00">Round</span><span style="color:#111">(</span><span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Millisecond</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">true</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>首先解释一下这个函数的参数：</p>
<ul>
<li>configCh: 将配置更改的 Pod 分派给适当的处理程序回调函数</li>
<li>plegCh: 更新运行时缓存；同步 Pod</li>
<li>syncCh: 同步所有等待同步的 Pod</li>
<li>housekeepingCh: 触发 Pod 的清理</li>
<li>health manager: 同步失败的 Pod 或其中一个或多个容器的健康检查失败的 Pod</li>
</ul>
<p>代码流程为：</p>
<ul>
<li>如果 updates channel 有消息 则使用 handler 调用对应方法做处理</li>
<li>如果 plegCh 有消息 则使用 handler 的 HandlePodSyncs 做同步</li>
<li>如果 syncCh 有消息 代表到了同步时间 做同步操作</li>
<li>如果是 三种 probe 的更新 则使用 handleProbeSync 做同步</li>
<li>如果 housekeepingCh 有消息 则使用 handler 的 HandlePodCleanups 做清理</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">handleProbeSync</span><span style="color:#111">(</span><span style="color:#75af00">kl</span> <span style="color:#f92672">*</span><span style="color:#75af00">Kubelet</span><span style="color:#111">,</span> <span style="color:#75af00">update</span> <span style="color:#75af00">proberesults</span><span style="color:#111">.</span><span style="color:#75af00">Update</span><span style="color:#111">,</span> <span style="color:#75af00">handler</span> <span style="color:#75af00">SyncHandler</span><span style="color:#111">,</span> <span style="color:#75af00">probe</span><span style="color:#111">,</span> <span style="color:#75af00">status</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// We should not use the pod from manager, because it is never updated after initialization.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">pod</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">podManager</span><span style="color:#111">.</span><span style="color:#75af00">GetPodByUID</span><span style="color:#111">(</span><span style="color:#75af00">update</span><span style="color:#111">.</span><span style="color:#75af00">PodUID</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// If the pod no longer exists, ignore the update.</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#ae81ff">4</span><span style="color:#111">).</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;SyncLoop (probe): ignore irrelevant update&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;probe&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">probe</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;status&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">status</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;update&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">update</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#ae81ff">1</span><span style="color:#111">).</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;SyncLoop (probe)&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;probe&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">probe</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;status&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">status</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;pod&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">KObj</span><span style="color:#111">(</span><span style="color:#75af00">pod</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">handler</span><span style="color:#111">.</span><span style="color:#75af00">HandlePodSyncs</span><span style="color:#111">([]</span><span style="color:#f92672">*</span><span style="color:#75af00">v1</span><span style="color:#111">.</span><span style="color:#75af00">Pod</span><span style="color:#111">{</span><span style="color:#75af00">pod</span><span style="color:#111">})</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>handleProbeSync也是使用 handler 的 HandlePodSyncs 做同步</p>
<h3 id="handle-synchandler">handle (SyncHandler)</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-GO" data-lang="GO"><span style="display:flex;"><span><span style="color:#75715e">// SyncHandler is an interface implemented by Kubelet, for testability</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">SyncHandler</span> <span style="color:#00a8c8">interface</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">HandlePodAdditions</span><span style="color:#111">(</span><span style="color:#75af00">pods</span> <span style="color:#111">[]</span><span style="color:#f92672">*</span><span style="color:#75af00">v1</span><span style="color:#111">.</span><span style="color:#75af00">Pod</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">HandlePodUpdates</span><span style="color:#111">(</span><span style="color:#75af00">pods</span> <span style="color:#111">[]</span><span style="color:#f92672">*</span><span style="color:#75af00">v1</span><span style="color:#111">.</span><span style="color:#75af00">Pod</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">HandlePodRemoves</span><span style="color:#111">(</span><span style="color:#75af00">pods</span> <span style="color:#111">[]</span><span style="color:#f92672">*</span><span style="color:#75af00">v1</span><span style="color:#111">.</span><span style="color:#75af00">Pod</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">HandlePodReconcile</span><span style="color:#111">(</span><span style="color:#75af00">pods</span> <span style="color:#111">[]</span><span style="color:#f92672">*</span><span style="color:#75af00">v1</span><span style="color:#111">.</span><span style="color:#75af00">Pod</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">HandlePodSyncs</span><span style="color:#111">(</span><span style="color:#75af00">pods</span> <span style="color:#111">[]</span><span style="color:#f92672">*</span><span style="color:#75af00">v1</span><span style="color:#111">.</span><span style="color:#75af00">Pod</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">HandlePodCleanups</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>也是 kubelet struct 实现了这个接口</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-GO" data-lang="GO"><span style="display:flex;"><span><span style="color:#75715e">// HandlePodAdditions is the callback in SyncHandler for pods being added from</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// a config source.</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">kl</span> <span style="color:#f92672">*</span><span style="color:#75af00">Kubelet</span><span style="color:#111">)</span> <span style="color:#75af00">HandlePodAdditions</span><span style="color:#111">(</span><span style="color:#75af00">pods</span> <span style="color:#111">[]</span><span style="color:#f92672">*</span><span style="color:#75af00">v1</span><span style="color:#111">.</span><span style="color:#75af00">Pod</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">start</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">clock</span><span style="color:#111">.</span><span style="color:#75af00">Now</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">sort</span><span style="color:#111">.</span><span style="color:#75af00">Sort</span><span style="color:#111">(</span><span style="color:#75af00">sliceutils</span><span style="color:#111">.</span><span style="color:#75af00">PodsByCreationTime</span><span style="color:#111">(</span><span style="color:#75af00">pods</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">utilfeature</span><span style="color:#111">.</span><span style="color:#75af00">DefaultFeatureGate</span><span style="color:#111">.</span><span style="color:#75af00">Enabled</span><span style="color:#111">(</span><span style="color:#75af00">features</span><span style="color:#111">.</span><span style="color:#75af00">InPlacePodVerticalScaling</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">podResizeMutex</span><span style="color:#111">.</span><span style="color:#75af00">Lock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">defer</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">podResizeMutex</span><span style="color:#111">.</span><span style="color:#75af00">Unlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">pod</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">pods</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">existingPods</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">podManager</span><span style="color:#111">.</span><span style="color:#75af00">GetPods</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">podManager</span><span style="color:#111">.</span><span style="color:#75af00">AddPod</span><span style="color:#111">(</span><span style="color:#75af00">pod</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">pod</span><span style="color:#111">,</span> <span style="color:#75af00">mirrorPod</span><span style="color:#111">,</span> <span style="color:#75af00">wasMirror</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">podManager</span><span style="color:#111">.</span><span style="color:#75af00">GetPodAndMirrorPod</span><span style="color:#111">(</span><span style="color:#75af00">pod</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">wasMirror</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">pod</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#ae81ff">2</span><span style="color:#111">).</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Unable to find pod for mirror pod, skipping&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;mirrorPod&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">KObj</span><span style="color:#111">(</span><span style="color:#75af00">mirrorPod</span><span style="color:#111">),</span> <span style="color:#d88200">&#34;mirrorPodUID&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">mirrorPod</span><span style="color:#111">.</span><span style="color:#75af00">UID</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">continue</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">podWorkers</span><span style="color:#111">.</span><span style="color:#75af00">UpdatePod</span><span style="color:#111">(</span><span style="color:#75af00">UpdatePodOptions</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">Pod</span><span style="color:#111">:</span>        <span style="color:#75af00">pod</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">MirrorPod</span><span style="color:#111">:</span>  <span style="color:#75af00">mirrorPod</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">UpdateType</span><span style="color:#111">:</span> <span style="color:#75af00">kubetypes</span><span style="color:#111">.</span><span style="color:#75af00">SyncPodUpdate</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">StartTime</span><span style="color:#111">:</span>  <span style="color:#75af00">start</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">continue</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">podWorkers</span><span style="color:#111">.</span><span style="color:#75af00">IsPodTerminationRequested</span><span style="color:#111">(</span><span style="color:#75af00">pod</span><span style="color:#111">.</span><span style="color:#75af00">UID</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// We failed pods that we rejected, so activePods include all admitted</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// pods that are alive.</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">activePods</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">filterOutInactivePods</span><span style="color:#111">(</span><span style="color:#75af00">existingPods</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">utilfeature</span><span style="color:#111">.</span><span style="color:#75af00">DefaultFeatureGate</span><span style="color:#111">.</span><span style="color:#75af00">Enabled</span><span style="color:#111">(</span><span style="color:#75af00">features</span><span style="color:#111">.</span><span style="color:#75af00">InPlacePodVerticalScaling</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// To handle kubelet restarts, test pod admissibility using AllocatedResources values</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// (for cpu &amp; memory) from checkpoint store. If found, that is the source of truth.</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">podCopy</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">pod</span><span style="color:#111">.</span><span style="color:#75af00">DeepCopy</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">updateContainerResourceAllocation</span><span style="color:#111">(</span><span style="color:#75af00">podCopy</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// Check if we can admit the pod; if not, reject it.</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">if</span> <span style="color:#75af00">ok</span><span style="color:#111">,</span> <span style="color:#75af00">reason</span><span style="color:#111">,</span> <span style="color:#75af00">message</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">canAdmitPod</span><span style="color:#111">(</span><span style="color:#75af00">activePods</span><span style="color:#111">,</span> <span style="color:#75af00">podCopy</span><span style="color:#111">);</span> <span style="color:#111">!</span><span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">rejectPod</span><span style="color:#111">(</span><span style="color:#75af00">pod</span><span style="color:#111">,</span> <span style="color:#75af00">reason</span><span style="color:#111">,</span> <span style="color:#75af00">message</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>					<span style="color:#00a8c8">continue</span>
</span></span><span style="display:flex;"><span>				<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// For new pod, checkpoint the resource values at which the Pod has been admitted</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">statusManager</span><span style="color:#111">.</span><span style="color:#75af00">SetPodAllocation</span><span style="color:#111">(</span><span style="color:#75af00">podCopy</span><span style="color:#111">);</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75715e">//TODO(vinaykul,InPlacePodVerticalScaling): Can we recover from this in some way? Investigate</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">ErrorS</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;SetPodAllocation failed&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;pod&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">KObj</span><span style="color:#111">(</span><span style="color:#75af00">pod</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>				<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// Check if we can admit the pod; if not, reject it.</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">if</span> <span style="color:#75af00">ok</span><span style="color:#111">,</span> <span style="color:#75af00">reason</span><span style="color:#111">,</span> <span style="color:#75af00">message</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">canAdmitPod</span><span style="color:#111">(</span><span style="color:#75af00">activePods</span><span style="color:#111">,</span> <span style="color:#75af00">pod</span><span style="color:#111">);</span> <span style="color:#111">!</span><span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">rejectPod</span><span style="color:#111">(</span><span style="color:#75af00">pod</span><span style="color:#111">,</span> <span style="color:#75af00">reason</span><span style="color:#111">,</span> <span style="color:#75af00">message</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>					<span style="color:#00a8c8">continue</span>
</span></span><span style="display:flex;"><span>				<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">podWorkers</span><span style="color:#111">.</span><span style="color:#75af00">UpdatePod</span><span style="color:#111">(</span><span style="color:#75af00">UpdatePodOptions</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">Pod</span><span style="color:#111">:</span>        <span style="color:#75af00">pod</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">MirrorPod</span><span style="color:#111">:</span>  <span style="color:#75af00">mirrorPod</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">UpdateType</span><span style="color:#111">:</span> <span style="color:#75af00">kubetypes</span><span style="color:#111">.</span><span style="color:#75af00">SyncPodCreate</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">StartTime</span><span style="color:#111">:</span>  <span style="color:#75af00">start</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">kl</span> <span style="color:#f92672">*</span><span style="color:#75af00">Kubelet</span><span style="color:#111">)</span> <span style="color:#75af00">HandlePodUpdates</span><span style="color:#111">(</span><span style="color:#75af00">pods</span> <span style="color:#111">[]</span><span style="color:#f92672">*</span><span style="color:#75af00">v1</span><span style="color:#111">.</span><span style="color:#75af00">Pod</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">start</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">clock</span><span style="color:#111">.</span><span style="color:#75af00">Now</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">pod</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">pods</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">podManager</span><span style="color:#111">.</span><span style="color:#75af00">UpdatePod</span><span style="color:#111">(</span><span style="color:#75af00">pod</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">pod</span><span style="color:#111">,</span> <span style="color:#75af00">mirrorPod</span><span style="color:#111">,</span> <span style="color:#75af00">wasMirror</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">podManager</span><span style="color:#111">.</span><span style="color:#75af00">GetPodAndMirrorPod</span><span style="color:#111">(</span><span style="color:#75af00">pod</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">wasMirror</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">pod</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#ae81ff">2</span><span style="color:#111">).</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Unable to find pod for mirror pod, skipping&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;mirrorPod&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">KObj</span><span style="color:#111">(</span><span style="color:#75af00">mirrorPod</span><span style="color:#111">),</span> <span style="color:#d88200">&#34;mirrorPodUID&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">mirrorPod</span><span style="color:#111">.</span><span style="color:#75af00">UID</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">continue</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">podWorkers</span><span style="color:#111">.</span><span style="color:#75af00">UpdatePod</span><span style="color:#111">(</span><span style="color:#75af00">UpdatePodOptions</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">Pod</span><span style="color:#111">:</span>        <span style="color:#75af00">pod</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">MirrorPod</span><span style="color:#111">:</span>  <span style="color:#75af00">mirrorPod</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">UpdateType</span><span style="color:#111">:</span> <span style="color:#75af00">kubetypes</span><span style="color:#111">.</span><span style="color:#75af00">SyncPodUpdate</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">StartTime</span><span style="color:#111">:</span>  <span style="color:#75af00">start</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">kl</span> <span style="color:#f92672">*</span><span style="color:#75af00">Kubelet</span><span style="color:#111">)</span> <span style="color:#75af00">HandlePodRemoves</span><span style="color:#111">(</span><span style="color:#75af00">pods</span> <span style="color:#111">[]</span><span style="color:#f92672">*</span><span style="color:#75af00">v1</span><span style="color:#111">.</span><span style="color:#75af00">Pod</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">start</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">clock</span><span style="color:#111">.</span><span style="color:#75af00">Now</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">pod</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">pods</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">podManager</span><span style="color:#111">.</span><span style="color:#75af00">RemovePod</span><span style="color:#111">(</span><span style="color:#75af00">pod</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">pod</span><span style="color:#111">,</span> <span style="color:#75af00">mirrorPod</span><span style="color:#111">,</span> <span style="color:#75af00">wasMirror</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">podManager</span><span style="color:#111">.</span><span style="color:#75af00">GetPodAndMirrorPod</span><span style="color:#111">(</span><span style="color:#75af00">pod</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">wasMirror</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">pod</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#ae81ff">2</span><span style="color:#111">).</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Unable to find pod for mirror pod, skipping&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;mirrorPod&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">KObj</span><span style="color:#111">(</span><span style="color:#75af00">mirrorPod</span><span style="color:#111">),</span> <span style="color:#d88200">&#34;mirrorPodUID&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">mirrorPod</span><span style="color:#111">.</span><span style="color:#75af00">UID</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">continue</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">podWorkers</span><span style="color:#111">.</span><span style="color:#75af00">UpdatePod</span><span style="color:#111">(</span><span style="color:#75af00">UpdatePodOptions</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">Pod</span><span style="color:#111">:</span>        <span style="color:#75af00">pod</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">MirrorPod</span><span style="color:#111">:</span>  <span style="color:#75af00">mirrorPod</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">UpdateType</span><span style="color:#111">:</span> <span style="color:#75af00">kubetypes</span><span style="color:#111">.</span><span style="color:#75af00">SyncPodUpdate</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">StartTime</span><span style="color:#111">:</span>  <span style="color:#75af00">start</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">continue</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Deletion is allowed to fail because the periodic cleanup routine</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// will trigger deletion again.</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">deletePod</span><span style="color:#111">(</span><span style="color:#75af00">pod</span><span style="color:#111">);</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#ae81ff">2</span><span style="color:#111">).</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Failed to delete pod&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;pod&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">KObj</span><span style="color:#111">(</span><span style="color:#75af00">pod</span><span style="color:#111">),</span> <span style="color:#d88200">&#34;err&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">kl</span> <span style="color:#f92672">*</span><span style="color:#75af00">Kubelet</span><span style="color:#111">)</span> <span style="color:#75af00">HandlePodReconcile</span><span style="color:#111">(</span><span style="color:#75af00">pods</span> <span style="color:#111">[]</span><span style="color:#f92672">*</span><span style="color:#75af00">v1</span><span style="color:#111">.</span><span style="color:#75af00">Pod</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">start</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">clock</span><span style="color:#111">.</span><span style="color:#75af00">Now</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">pod</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">pods</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Update the pod in pod manager, status manager will do periodically reconcile according</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// to the pod manager.</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">podManager</span><span style="color:#111">.</span><span style="color:#75af00">UpdatePod</span><span style="color:#111">(</span><span style="color:#75af00">pod</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">pod</span><span style="color:#111">,</span> <span style="color:#75af00">mirrorPod</span><span style="color:#111">,</span> <span style="color:#75af00">wasMirror</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">podManager</span><span style="color:#111">.</span><span style="color:#75af00">GetPodAndMirrorPod</span><span style="color:#111">(</span><span style="color:#75af00">pod</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">wasMirror</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">pod</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#ae81ff">2</span><span style="color:#111">).</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Unable to find pod for mirror pod, skipping&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;mirrorPod&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">KObj</span><span style="color:#111">(</span><span style="color:#75af00">mirrorPod</span><span style="color:#111">),</span> <span style="color:#d88200">&#34;mirrorPodUID&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">mirrorPod</span><span style="color:#111">.</span><span style="color:#75af00">UID</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">continue</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// Static pods should be reconciled the same way as regular pods</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// TODO: reconcile being calculated in the config manager is questionable, and avoiding</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// extra syncs may no longer be necessary. Reevaluate whether Reconcile and Sync can be</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// merged (after resolving the next two TODOs).</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Reconcile Pod &#34;Ready&#34; condition if necessary. Trigger sync pod for reconciliation.</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// TODO: this should be unnecessary today - determine what is the cause for this to</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// be different than Sync, or if there is a better place for it. For instance, we have</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// needsReconcile in kubelet/config, here, and in status_manager.</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">status</span><span style="color:#111">.</span><span style="color:#75af00">NeedToReconcilePodReadiness</span><span style="color:#111">(</span><span style="color:#75af00">pod</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">podWorkers</span><span style="color:#111">.</span><span style="color:#75af00">UpdatePod</span><span style="color:#111">(</span><span style="color:#75af00">UpdatePodOptions</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">Pod</span><span style="color:#111">:</span>        <span style="color:#75af00">pod</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">MirrorPod</span><span style="color:#111">:</span>  <span style="color:#75af00">mirrorPod</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">UpdateType</span><span style="color:#111">:</span> <span style="color:#75af00">kubetypes</span><span style="color:#111">.</span><span style="color:#75af00">SyncPodSync</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">StartTime</span><span style="color:#111">:</span>  <span style="color:#75af00">start</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// After an evicted pod is synced, all dead containers in the pod can be removed.</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// TODO: this is questionable - status read is async and during eviction we already</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// expect to not have some container info. The pod worker knows whether a pod has</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// been evicted, so if this is about minimizing the time to react to an eviction we</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// can do better. If it&#39;s about preserving pod status info we can also do better.</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">eviction</span><span style="color:#111">.</span><span style="color:#75af00">PodIsEvicted</span><span style="color:#111">(</span><span style="color:#75af00">pod</span><span style="color:#111">.</span><span style="color:#75af00">Status</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">podStatus</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">podCache</span><span style="color:#111">.</span><span style="color:#75af00">Get</span><span style="color:#111">(</span><span style="color:#75af00">pod</span><span style="color:#111">.</span><span style="color:#75af00">UID</span><span style="color:#111">);</span> <span style="color:#75af00">err</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">containerDeletor</span><span style="color:#111">.</span><span style="color:#75af00">deleteContainersInPod</span><span style="color:#111">(</span><span style="color:#d88200">&#34;&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">podStatus</span><span style="color:#111">,</span> <span style="color:#00a8c8">true</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">kl</span> <span style="color:#f92672">*</span><span style="color:#75af00">Kubelet</span><span style="color:#111">)</span> <span style="color:#75af00">HandlePodSyncs</span><span style="color:#111">(</span><span style="color:#75af00">pods</span> <span style="color:#111">[]</span><span style="color:#f92672">*</span><span style="color:#75af00">v1</span><span style="color:#111">.</span><span style="color:#75af00">Pod</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">start</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">clock</span><span style="color:#111">.</span><span style="color:#75af00">Now</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">pod</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">pods</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">pod</span><span style="color:#111">,</span> <span style="color:#75af00">mirrorPod</span><span style="color:#111">,</span> <span style="color:#75af00">wasMirror</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">podManager</span><span style="color:#111">.</span><span style="color:#75af00">GetPodAndMirrorPod</span><span style="color:#111">(</span><span style="color:#75af00">pod</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">wasMirror</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">pod</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#ae81ff">2</span><span style="color:#111">).</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Unable to find pod for mirror pod, skipping&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;mirrorPod&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">KObj</span><span style="color:#111">(</span><span style="color:#75af00">mirrorPod</span><span style="color:#111">),</span> <span style="color:#d88200">&#34;mirrorPodUID&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">mirrorPod</span><span style="color:#111">.</span><span style="color:#75af00">UID</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">continue</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// Syncing a mirror pod is a programmer error since the intent of sync is to</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// batch notify all pending work. We should make it impossible to double sync,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// but for now log a programmer error to prevent accidental introduction.</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#ae81ff">3</span><span style="color:#111">).</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Programmer error, HandlePodSyncs does not expect to receive mirror pods&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;podUID&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">pod</span><span style="color:#111">.</span><span style="color:#75af00">UID</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;mirrorPodUID&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">mirrorPod</span><span style="color:#111">.</span><span style="color:#75af00">UID</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">continue</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">podWorkers</span><span style="color:#111">.</span><span style="color:#75af00">UpdatePod</span><span style="color:#111">(</span><span style="color:#75af00">UpdatePodOptions</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">Pod</span><span style="color:#111">:</span>        <span style="color:#75af00">pod</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">MirrorPod</span><span style="color:#111">:</span>  <span style="color:#75af00">mirrorPod</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">UpdateType</span><span style="color:#111">:</span> <span style="color:#75af00">kubetypes</span><span style="color:#111">.</span><span style="color:#75af00">SyncPodSync</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">StartTime</span><span style="color:#111">:</span>  <span style="color:#75af00">start</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">kl</span> <span style="color:#f92672">*</span><span style="color:#75af00">Kubelet</span><span style="color:#111">)</span> <span style="color:#75af00">HandlePodCleanups</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// The kubelet lacks checkpointing, so we need to introspect the set of pods</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// in the cgroup tree prior to inspecting the set of pods in our pod manager.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// this ensures our view of the cgroup tree does not mistakenly observe pods</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// that are added after the fact...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">var</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">cgroupPods</span> <span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#75af00">types</span><span style="color:#111">.</span><span style="color:#75af00">UID</span><span style="color:#111">]</span><span style="color:#75af00">cm</span><span style="color:#111">.</span><span style="color:#75af00">CgroupName</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">err</span>        <span style="color:#00a8c8">error</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">cgroupsPerQOS</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">pcm</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">containerManager</span><span style="color:#111">.</span><span style="color:#75af00">NewPodContainerManager</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">cgroupPods</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">pcm</span><span style="color:#111">.</span><span style="color:#75af00">GetAllPodsFromCgroups</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;failed to get list of pods that still exist on cgroup mounts: %v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">allPods</span><span style="color:#111">,</span> <span style="color:#75af00">mirrorPods</span><span style="color:#111">,</span> <span style="color:#75af00">orphanedMirrorPodFullnames</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">podManager</span><span style="color:#111">.</span><span style="color:#75af00">GetPodsAndMirrorPods</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Pod phase progresses monotonically. Once a pod has reached a final state,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// it should never leave regardless of the restart policy. The statuses</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// of such pods should not be changed, and there is no need to sync them.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// TODO: the logic here does not handle two cases:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//   1. If the containers were removed immediately after they died, kubelet</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//      may fail to generate correct statuses, let alone filtering correctly.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//   2. If kubelet restarted before writing the terminated status for a pod</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//      to the apiserver, it could still restart the terminated pod (even</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//      though the pod was not considered terminated by the apiserver).</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// These two conditions could be alleviated by checkpointing kubelet.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Stop the workers for terminated pods not in the config source</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#ae81ff">3</span><span style="color:#111">).</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Clean up pod workers for terminated pods&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">workingPods</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">podWorkers</span><span style="color:#111">.</span><span style="color:#75af00">SyncKnownPods</span><span style="color:#111">(</span><span style="color:#75af00">allPods</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Reconcile: At this point the pod workers have been pruned to the set of</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// desired pods. Pods that must be restarted due to UID reuse, or leftover</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// pods from previous runs, are not known to the pod worker.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">allPodsByUID</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#75af00">types</span><span style="color:#111">.</span><span style="color:#75af00">UID</span><span style="color:#111">]</span><span style="color:#f92672">*</span><span style="color:#75af00">v1</span><span style="color:#111">.</span><span style="color:#75af00">Pod</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">pod</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">allPods</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">allPodsByUID</span><span style="color:#111">[</span><span style="color:#75af00">pod</span><span style="color:#111">.</span><span style="color:#75af00">UID</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#75af00">pod</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Identify the set of pods that have workers, which should be all pods</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// from config that are not terminated, as well as any terminating pods</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// that have already been removed from config. Pods that are terminating</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// will be added to possiblyRunningPods, to prevent overly aggressive</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// cleanup of pod cgroups.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">stringIfTrue</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">t</span> <span style="color:#00a8c8">bool</span><span style="color:#111">)</span> <span style="color:#00a8c8">string</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">t</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#d88200">&#34;true&#34;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#d88200">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">runningPods</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#75af00">types</span><span style="color:#111">.</span><span style="color:#75af00">UID</span><span style="color:#111">]</span><span style="color:#75af00">sets</span><span style="color:#111">.</span><span style="color:#75af00">Empty</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">possiblyRunningPods</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#75af00">types</span><span style="color:#111">.</span><span style="color:#75af00">UID</span><span style="color:#111">]</span><span style="color:#75af00">sets</span><span style="color:#111">.</span><span style="color:#75af00">Empty</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">uid</span><span style="color:#111">,</span> <span style="color:#75af00">sync</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">workingPods</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">switch</span> <span style="color:#75af00">sync</span><span style="color:#111">.</span><span style="color:#75af00">State</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">case</span> <span style="color:#75af00">SyncPod</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">runningPods</span><span style="color:#111">[</span><span style="color:#75af00">uid</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#00a8c8">struct</span><span style="color:#111">{}{}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">possiblyRunningPods</span><span style="color:#111">[</span><span style="color:#75af00">uid</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#00a8c8">struct</span><span style="color:#111">{}{}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">case</span> <span style="color:#75af00">TerminatingPod</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">possiblyRunningPods</span><span style="color:#111">[</span><span style="color:#75af00">uid</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#00a8c8">struct</span><span style="color:#111">{}{}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">default</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Retrieve the list of running containers from the runtime to perform cleanup.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// We need the latest state to avoid delaying restarts of static pods that reuse</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// a UID.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">runtimeCache</span><span style="color:#111">.</span><span style="color:#75af00">ForceUpdateIfOlder</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">clock</span><span style="color:#111">.</span><span style="color:#75af00">Now</span><span style="color:#111">());</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">ErrorS</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Error listing containers&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">runningRuntimePods</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">runtimeCache</span><span style="color:#111">.</span><span style="color:#75af00">GetPods</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">ErrorS</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Error listing containers&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Stop probing pods that are not running</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#ae81ff">3</span><span style="color:#111">).</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Clean up probes for terminated pods&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">probeManager</span><span style="color:#111">.</span><span style="color:#75af00">CleanupPods</span><span style="color:#111">(</span><span style="color:#75af00">possiblyRunningPods</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Remove orphaned pod statuses not in the total list of known config pods</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#ae81ff">3</span><span style="color:#111">).</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Clean up orphaned pod statuses&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">removeOrphanedPodStatuses</span><span style="color:#111">(</span><span style="color:#75af00">allPods</span><span style="color:#111">,</span> <span style="color:#75af00">mirrorPods</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Remove orphaned pod user namespace allocations (if any).</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#ae81ff">3</span><span style="color:#111">).</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Clean up orphaned pod user namespace allocations&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">usernsManager</span><span style="color:#111">.</span><span style="color:#75af00">CleanupOrphanedPodUsernsAllocations</span><span style="color:#111">(</span><span style="color:#75af00">allPods</span><span style="color:#111">,</span> <span style="color:#75af00">runningRuntimePods</span><span style="color:#111">);</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">ErrorS</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Failed cleaning up orphaned pod user namespaces allocations&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Remove orphaned volumes from pods that are known not to have any</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// containers. Note that we pass all pods (including terminated pods) to</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// the function, so that we don&#39;t remove volumes associated with terminated</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// but not yet deleted pods.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// TODO: this method could more aggressively cleanup terminated pods</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// in the future (volumes, mount dirs, logs, and containers could all be</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// better separated)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#ae81ff">3</span><span style="color:#111">).</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Clean up orphaned pod directories&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">cleanupOrphanedPodDirs</span><span style="color:#111">(</span><span style="color:#75af00">allPods</span><span style="color:#111">,</span> <span style="color:#75af00">runningRuntimePods</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// We want all cleanup tasks to be run even if one of them failed. So</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// we just log an error here and continue other cleanup tasks.</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// This also applies to the other clean up tasks.</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">ErrorS</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Failed cleaning up orphaned pod directories&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Remove any orphaned mirror pods (mirror pods are tracked by name via the</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// pod worker)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#ae81ff">3</span><span style="color:#111">).</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Clean up orphaned mirror pods&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">podFullname</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">orphanedMirrorPodFullnames</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">podWorkers</span><span style="color:#111">.</span><span style="color:#75af00">IsPodForMirrorPodTerminatingByFullName</span><span style="color:#111">(</span><span style="color:#75af00">podFullname</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">mirrorPodClient</span><span style="color:#111">.</span><span style="color:#75af00">DeleteMirrorPod</span><span style="color:#111">(</span><span style="color:#75af00">podFullname</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">ErrorS</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Encountered error when deleting mirror pod&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;podName&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">podFullname</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#ae81ff">3</span><span style="color:#111">).</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Deleted mirror pod&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;podName&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">podFullname</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// After pruning pod workers for terminated pods get the list of active pods for</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// metrics and to determine restarts.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">activePods</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">filterOutInactivePods</span><span style="color:#111">(</span><span style="color:#75af00">allPods</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">allRegularPods</span><span style="color:#111">,</span> <span style="color:#75af00">allStaticPods</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">splitPodsByStatic</span><span style="color:#111">(</span><span style="color:#75af00">allPods</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">activeRegularPods</span><span style="color:#111">,</span> <span style="color:#75af00">activeStaticPods</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">splitPodsByStatic</span><span style="color:#111">(</span><span style="color:#75af00">activePods</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">metrics</span><span style="color:#111">.</span><span style="color:#75af00">DesiredPodCount</span><span style="color:#111">.</span><span style="color:#75af00">WithLabelValues</span><span style="color:#111">(</span><span style="color:#d88200">&#34;&#34;</span><span style="color:#111">).</span><span style="color:#75af00">Set</span><span style="color:#111">(</span><span style="color:#111">float64</span><span style="color:#111">(</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">allRegularPods</span><span style="color:#111">)))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">metrics</span><span style="color:#111">.</span><span style="color:#75af00">DesiredPodCount</span><span style="color:#111">.</span><span style="color:#75af00">WithLabelValues</span><span style="color:#111">(</span><span style="color:#d88200">&#34;true&#34;</span><span style="color:#111">).</span><span style="color:#75af00">Set</span><span style="color:#111">(</span><span style="color:#111">float64</span><span style="color:#111">(</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">allStaticPods</span><span style="color:#111">)))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">metrics</span><span style="color:#111">.</span><span style="color:#75af00">ActivePodCount</span><span style="color:#111">.</span><span style="color:#75af00">WithLabelValues</span><span style="color:#111">(</span><span style="color:#d88200">&#34;&#34;</span><span style="color:#111">).</span><span style="color:#75af00">Set</span><span style="color:#111">(</span><span style="color:#111">float64</span><span style="color:#111">(</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">activeRegularPods</span><span style="color:#111">)))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">metrics</span><span style="color:#111">.</span><span style="color:#75af00">ActivePodCount</span><span style="color:#111">.</span><span style="color:#75af00">WithLabelValues</span><span style="color:#111">(</span><span style="color:#d88200">&#34;true&#34;</span><span style="color:#111">).</span><span style="color:#75af00">Set</span><span style="color:#111">(</span><span style="color:#111">float64</span><span style="color:#111">(</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">activeStaticPods</span><span style="color:#111">)))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">metrics</span><span style="color:#111">.</span><span style="color:#75af00">MirrorPodCount</span><span style="color:#111">.</span><span style="color:#75af00">Set</span><span style="color:#111">(</span><span style="color:#111">float64</span><span style="color:#111">(</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">mirrorPods</span><span style="color:#111">)))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// At this point, the pod worker is aware of which pods are not desired (SyncKnownPods).</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// We now look through the set of active pods for those that the pod worker is not aware of</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// and deliver an update. The most common reason a pod is not known is because the pod was</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// deleted and recreated with the same UID while the pod worker was driving its lifecycle (very</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// very rare for API pods, common for static pods with fixed UIDs). Containers that may still</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// be running from a previous execution must be reconciled by the pod worker&#39;s sync method.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// We must use active pods because that is the set of admitted pods (podManager includes pods</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// that will never be run, and statusManager tracks already rejected pods).</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">var</span> <span style="color:#75af00">restartCount</span><span style="color:#111">,</span> <span style="color:#75af00">restartCountStatic</span> <span style="color:#00a8c8">int</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">desiredPod</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">activePods</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">knownPod</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">workingPods</span><span style="color:#111">[</span><span style="color:#75af00">desiredPod</span><span style="color:#111">.</span><span style="color:#75af00">UID</span><span style="color:#111">];</span> <span style="color:#75af00">knownPod</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">continue</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#ae81ff">3</span><span style="color:#111">).</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Pod will be restarted because it is in the desired set and not known to the pod workers (likely due to UID reuse)&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;podUID&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">desiredPod</span><span style="color:#111">.</span><span style="color:#75af00">UID</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">isStatic</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">kubetypes</span><span style="color:#111">.</span><span style="color:#75af00">IsStaticPod</span><span style="color:#111">(</span><span style="color:#75af00">desiredPod</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">pod</span><span style="color:#111">,</span> <span style="color:#75af00">mirrorPod</span><span style="color:#111">,</span> <span style="color:#75af00">wasMirror</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">podManager</span><span style="color:#111">.</span><span style="color:#75af00">GetPodAndMirrorPod</span><span style="color:#111">(</span><span style="color:#75af00">desiredPod</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">pod</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#f92672">||</span> <span style="color:#75af00">wasMirror</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#ae81ff">2</span><span style="color:#111">).</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Programmer error, restartable pod was a mirror pod but activePods should never contain a mirror pod&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;podUID&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">desiredPod</span><span style="color:#111">.</span><span style="color:#75af00">UID</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">continue</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">podWorkers</span><span style="color:#111">.</span><span style="color:#75af00">UpdatePod</span><span style="color:#111">(</span><span style="color:#75af00">UpdatePodOptions</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">UpdateType</span><span style="color:#111">:</span> <span style="color:#75af00">kubetypes</span><span style="color:#111">.</span><span style="color:#75af00">SyncPodCreate</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">Pod</span><span style="color:#111">:</span>        <span style="color:#75af00">pod</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">MirrorPod</span><span style="color:#111">:</span>  <span style="color:#75af00">mirrorPod</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// the desired pod is now known as well</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">workingPods</span><span style="color:#111">[</span><span style="color:#75af00">desiredPod</span><span style="color:#111">.</span><span style="color:#75af00">UID</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#75af00">PodWorkerSync</span><span style="color:#111">{</span><span style="color:#75af00">State</span><span style="color:#111">:</span> <span style="color:#75af00">SyncPod</span><span style="color:#111">,</span> <span style="color:#75af00">HasConfig</span><span style="color:#111">:</span> <span style="color:#00a8c8">true</span><span style="color:#111">,</span> <span style="color:#75af00">Static</span><span style="color:#111">:</span> <span style="color:#75af00">isStatic</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">isStatic</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// restartable static pods are the normal case</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">restartCountStatic</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// almost certainly means shenanigans, as API pods should never have the same UID after being deleted and recreated</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// unless there is a major API violation</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">restartCount</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">metrics</span><span style="color:#111">.</span><span style="color:#75af00">RestartedPodTotal</span><span style="color:#111">.</span><span style="color:#75af00">WithLabelValues</span><span style="color:#111">(</span><span style="color:#d88200">&#34;true&#34;</span><span style="color:#111">).</span><span style="color:#75af00">Add</span><span style="color:#111">(</span><span style="color:#111">float64</span><span style="color:#111">(</span><span style="color:#75af00">restartCountStatic</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">metrics</span><span style="color:#111">.</span><span style="color:#75af00">RestartedPodTotal</span><span style="color:#111">.</span><span style="color:#75af00">WithLabelValues</span><span style="color:#111">(</span><span style="color:#d88200">&#34;&#34;</span><span style="color:#111">).</span><span style="color:#75af00">Add</span><span style="color:#111">(</span><span style="color:#111">float64</span><span style="color:#111">(</span><span style="color:#75af00">restartCount</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Complete termination of deleted pods that are not runtime pods (don&#39;t have</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// running containers), are terminal, and are not known to pod workers.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// An example is pods rejected during kubelet admission that have never</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// started before (i.e. does not have an orphaned pod).</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Adding the pods with SyncPodKill to pod workers allows to proceed with</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// force-deletion of such pods, yet preventing re-entry of the routine in the</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// next invocation of HandlePodCleanups.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">pod</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">filterTerminalPodsToDelete</span><span style="color:#111">(</span><span style="color:#75af00">allPods</span><span style="color:#111">,</span> <span style="color:#75af00">runningRuntimePods</span><span style="color:#111">,</span> <span style="color:#75af00">workingPods</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#ae81ff">3</span><span style="color:#111">).</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Handling termination and deletion of the pod to pod workers&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;pod&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">KObj</span><span style="color:#111">(</span><span style="color:#75af00">pod</span><span style="color:#111">),</span> <span style="color:#d88200">&#34;podUID&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">pod</span><span style="color:#111">.</span><span style="color:#75af00">UID</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">podWorkers</span><span style="color:#111">.</span><span style="color:#75af00">UpdatePod</span><span style="color:#111">(</span><span style="color:#75af00">UpdatePodOptions</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">UpdateType</span><span style="color:#111">:</span> <span style="color:#75af00">kubetypes</span><span style="color:#111">.</span><span style="color:#75af00">SyncPodKill</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">Pod</span><span style="color:#111">:</span>        <span style="color:#75af00">pod</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Finally, terminate any pods that are observed in the runtime but not present in the list of</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// known running pods from config. If we do terminate running runtime pods that will happen</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// asynchronously in the background and those will be processed in the next invocation of</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// HandlePodCleanups.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">var</span> <span style="color:#75af00">orphanCount</span> <span style="color:#00a8c8">int</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">runningPod</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">runningRuntimePods</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// If there are orphaned pod resources in CRI that are unknown to the pod worker, terminate them</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// now. Since housekeeping is exclusive to other pod worker updates, we know that no pods have</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// been added to the pod worker in the meantime. Note that pods that are not visible in the runtime</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// but which were previously known are terminated by SyncKnownPods().</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">knownPod</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">workingPods</span><span style="color:#111">[</span><span style="color:#75af00">runningPod</span><span style="color:#111">.</span><span style="color:#75af00">ID</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">knownPod</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">one</span> <span style="color:#f92672">:=</span> <span style="color:#111">int64</span><span style="color:#111">(</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">killPodOptions</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">KillPodOptions</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">PodTerminationGracePeriodSecondsOverride</span><span style="color:#111">:</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">one</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#ae81ff">2</span><span style="color:#111">).</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Clean up containers for orphaned pod we had not seen before&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;podUID&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">runningPod</span><span style="color:#111">.</span><span style="color:#75af00">ID</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;killPodOptions&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">killPodOptions</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">podWorkers</span><span style="color:#111">.</span><span style="color:#75af00">UpdatePod</span><span style="color:#111">(</span><span style="color:#75af00">UpdatePodOptions</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">UpdateType</span><span style="color:#111">:</span>     <span style="color:#75af00">kubetypes</span><span style="color:#111">.</span><span style="color:#75af00">SyncPodKill</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">RunningPod</span><span style="color:#111">:</span>     <span style="color:#75af00">runningPod</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">KillPodOptions</span><span style="color:#111">:</span> <span style="color:#75af00">killPodOptions</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// the running pod is now known as well</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">workingPods</span><span style="color:#111">[</span><span style="color:#75af00">runningPod</span><span style="color:#111">.</span><span style="color:#75af00">ID</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#75af00">PodWorkerSync</span><span style="color:#111">{</span><span style="color:#75af00">State</span><span style="color:#111">:</span> <span style="color:#75af00">TerminatingPod</span><span style="color:#111">,</span> <span style="color:#75af00">Orphan</span><span style="color:#111">:</span> <span style="color:#00a8c8">true</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">orphanCount</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">metrics</span><span style="color:#111">.</span><span style="color:#75af00">OrphanedRuntimePodTotal</span><span style="color:#111">.</span><span style="color:#75af00">Add</span><span style="color:#111">(</span><span style="color:#111">float64</span><span style="color:#111">(</span><span style="color:#75af00">orphanCount</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Now that we have recorded any terminating pods, and added new pods that should be running,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// record a summary here. Not all possible combinations of PodWorkerSync values are valid.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">counts</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#75af00">PodWorkerSync</span><span style="color:#111">]</span><span style="color:#00a8c8">int</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">sync</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">workingPods</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">counts</span><span style="color:#111">[</span><span style="color:#75af00">sync</span><span style="color:#111">]</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">validSync</span><span style="color:#111">,</span> <span style="color:#75af00">configState</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#75af00">PodWorkerSync</span><span style="color:#111">]</span><span style="color:#00a8c8">string</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">{</span><span style="color:#75af00">HasConfig</span><span style="color:#111">:</span> <span style="color:#00a8c8">true</span><span style="color:#111">,</span> <span style="color:#75af00">Static</span><span style="color:#111">:</span> <span style="color:#00a8c8">true</span><span style="color:#111">}:</span>                <span style="color:#d88200">&#34;desired&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">{</span><span style="color:#75af00">HasConfig</span><span style="color:#111">:</span> <span style="color:#00a8c8">true</span><span style="color:#111">,</span> <span style="color:#75af00">Static</span><span style="color:#111">:</span> <span style="color:#00a8c8">false</span><span style="color:#111">}:</span>               <span style="color:#d88200">&#34;desired&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">{</span><span style="color:#75af00">Orphan</span><span style="color:#111">:</span> <span style="color:#00a8c8">true</span><span style="color:#111">,</span> <span style="color:#75af00">HasConfig</span><span style="color:#111">:</span> <span style="color:#00a8c8">true</span><span style="color:#111">,</span> <span style="color:#75af00">Static</span><span style="color:#111">:</span> <span style="color:#00a8c8">true</span><span style="color:#111">}:</span>  <span style="color:#d88200">&#34;orphan&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">{</span><span style="color:#75af00">Orphan</span><span style="color:#111">:</span> <span style="color:#00a8c8">true</span><span style="color:#111">,</span> <span style="color:#75af00">HasConfig</span><span style="color:#111">:</span> <span style="color:#00a8c8">true</span><span style="color:#111">,</span> <span style="color:#75af00">Static</span><span style="color:#111">:</span> <span style="color:#00a8c8">false</span><span style="color:#111">}:</span> <span style="color:#d88200">&#34;orphan&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">{</span><span style="color:#75af00">Orphan</span><span style="color:#111">:</span> <span style="color:#00a8c8">true</span><span style="color:#111">,</span> <span style="color:#75af00">HasConfig</span><span style="color:#111">:</span> <span style="color:#00a8c8">false</span><span style="color:#111">}:</span>               <span style="color:#d88200">&#34;runtime_only&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">state</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#111">[]</span><span style="color:#75af00">PodWorkerState</span><span style="color:#111">{</span><span style="color:#75af00">SyncPod</span><span style="color:#111">,</span> <span style="color:#75af00">TerminatingPod</span><span style="color:#111">,</span> <span style="color:#75af00">TerminatedPod</span><span style="color:#111">}</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">validSync</span><span style="color:#111">.</span><span style="color:#75af00">State</span> <span style="color:#111">=</span> <span style="color:#75af00">state</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">count</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">counts</span><span style="color:#111">[</span><span style="color:#75af00">validSync</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">delete</span><span style="color:#111">(</span><span style="color:#75af00">counts</span><span style="color:#111">,</span> <span style="color:#75af00">validSync</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">staticString</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">stringIfTrue</span><span style="color:#111">(</span><span style="color:#75af00">validSync</span><span style="color:#111">.</span><span style="color:#75af00">Static</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">validSync</span><span style="color:#111">.</span><span style="color:#75af00">HasConfig</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">staticString</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;unknown&#34;</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">metrics</span><span style="color:#111">.</span><span style="color:#75af00">WorkingPodCount</span><span style="color:#111">.</span><span style="color:#75af00">WithLabelValues</span><span style="color:#111">(</span><span style="color:#75af00">state</span><span style="color:#111">.</span><span style="color:#75af00">String</span><span style="color:#111">(),</span> <span style="color:#75af00">configState</span><span style="color:#111">,</span> <span style="color:#75af00">staticString</span><span style="color:#111">).</span><span style="color:#75af00">Set</span><span style="color:#111">(</span><span style="color:#111">float64</span><span style="color:#111">(</span><span style="color:#75af00">count</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">counts</span><span style="color:#111">)</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// in case a combination is lost</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#ae81ff">3</span><span style="color:#111">).</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Programmer error, did not report a kubelet_working_pods metric for a value returned by SyncKnownPods&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;counts&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">counts</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Remove any cgroups in the hierarchy for pods that are definitely no longer</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// running (not in the container runtime).</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">cgroupsPerQOS</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">pcm</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">containerManager</span><span style="color:#111">.</span><span style="color:#75af00">NewPodContainerManager</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#ae81ff">3</span><span style="color:#111">).</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Clean up orphaned pod cgroups&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">cleanupOrphanedPodCgroups</span><span style="color:#111">(</span><span style="color:#75af00">pcm</span><span style="color:#111">,</span> <span style="color:#75af00">cgroupPods</span><span style="color:#111">,</span> <span style="color:#75af00">possiblyRunningPods</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Cleanup any backoff entries.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">backOff</span><span style="color:#111">.</span><span style="color:#75af00">GC</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>可以看到这些函数基本都是把pod交给 podWorkers 去处理</p>
<h2 id="podconfig">podconfig</h2>
<p>上文中的 updates channel 是从 podconfig 中获取的 那就来看看 podconfig 是怎么工作的</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">SourcesReady</span> <span style="color:#00a8c8">interface</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// AddSource adds the specified source to the set of sources managed.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">AddSource</span><span style="color:#111">(</span><span style="color:#75af00">source</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// AllReady returns true if the currently configured sources have all been seen.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">AllReady</span><span style="color:#111">()</span> <span style="color:#00a8c8">bool</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// sourcesImpl implements SourcesReady.  It is thread-safe.</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">sourcesImpl</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// lock protects access to sources seen.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">lock</span> <span style="color:#75af00">sync</span><span style="color:#111">.</span><span style="color:#75af00">RWMutex</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// set of sources seen.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">sourcesSeen</span> <span style="color:#75af00">sets</span><span style="color:#111">.</span><span style="color:#75af00">String</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// sourcesReady is a function that evaluates if the sources are ready.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">sourcesReadyFn</span> <span style="color:#75af00">SourcesReadyFn</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>这里定义了接口 接口提中可以存储多个 source 那么有什么 source 呢</p>
<h3 id="kube-apiserver">kube-apiserver</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">NewSourceApiserver</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#75af00">clientset</span><span style="color:#111">.</span><span style="color:#75af00">Interface</span><span style="color:#111">,</span> <span style="color:#75af00">nodeName</span> <span style="color:#75af00">types</span><span style="color:#111">.</span><span style="color:#75af00">NodeName</span><span style="color:#111">,</span> <span style="color:#75af00">nodeHasSynced</span> <span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#00a8c8">bool</span><span style="color:#111">,</span> <span style="color:#75af00">updates</span> <span style="color:#00a8c8">chan</span><span style="color:#f92672">&lt;-</span> <span style="color:#00a8c8">interface</span><span style="color:#111">{})</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">lw</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">cache</span><span style="color:#111">.</span><span style="color:#75af00">NewListWatchFromClient</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">CoreV1</span><span style="color:#111">().</span><span style="color:#75af00">RESTClient</span><span style="color:#111">(),</span> <span style="color:#d88200">&#34;pods&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">metav1</span><span style="color:#111">.</span><span style="color:#75af00">NamespaceAll</span><span style="color:#111">,</span> <span style="color:#75af00">fields</span><span style="color:#111">.</span><span style="color:#75af00">OneTermEqualSelector</span><span style="color:#111">(</span><span style="color:#d88200">&#34;spec.nodeName&#34;</span><span style="color:#111">,</span> <span style="color:#111">string</span><span style="color:#111">(</span><span style="color:#75af00">nodeName</span><span style="color:#111">)))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// The Reflector responsible for watching pods at the apiserver should be run only after</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// the node sync with the apiserver has completed.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Waiting for node sync before watching apiserver pods&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">go</span> <span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">for</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">nodeHasSynced</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#ae81ff">4</span><span style="color:#111">).</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;node sync completed&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">break</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Sleep</span><span style="color:#111">(</span><span style="color:#75af00">WaitForAPIServerSyncPeriod</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#ae81ff">4</span><span style="color:#111">).</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;node sync has not completed yet&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Watching apiserver&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">newSourceApiserverFromLW</span><span style="color:#111">(</span><span style="color:#75af00">lw</span><span style="color:#111">,</span> <span style="color:#75af00">updates</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// newSourceApiserverFromLW holds creates a config source that watches and pulls from the apiserver.</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">newSourceApiserverFromLW</span><span style="color:#111">(</span><span style="color:#75af00">lw</span> <span style="color:#75af00">cache</span><span style="color:#111">.</span><span style="color:#75af00">ListerWatcher</span><span style="color:#111">,</span> <span style="color:#75af00">updates</span> <span style="color:#00a8c8">chan</span><span style="color:#f92672">&lt;-</span> <span style="color:#00a8c8">interface</span><span style="color:#111">{})</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">send</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">objs</span> <span style="color:#111">[]</span><span style="color:#00a8c8">interface</span><span style="color:#111">{})</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">var</span> <span style="color:#75af00">pods</span> <span style="color:#111">[]</span><span style="color:#f92672">*</span><span style="color:#75af00">v1</span><span style="color:#111">.</span><span style="color:#75af00">Pod</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">o</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">objs</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">pods</span> <span style="color:#111">=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">pods</span><span style="color:#111">,</span> <span style="color:#75af00">o</span><span style="color:#111">.(</span><span style="color:#f92672">*</span><span style="color:#75af00">v1</span><span style="color:#111">.</span><span style="color:#75af00">Pod</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">updates</span> <span style="color:#f92672">&lt;-</span> <span style="color:#75af00">kubetypes</span><span style="color:#111">.</span><span style="color:#75af00">PodUpdate</span><span style="color:#111">{</span><span style="color:#75af00">Pods</span><span style="color:#111">:</span> <span style="color:#75af00">pods</span><span style="color:#111">,</span> <span style="color:#75af00">Op</span><span style="color:#111">:</span> <span style="color:#75af00">kubetypes</span><span style="color:#111">.</span><span style="color:#75af00">SET</span><span style="color:#111">,</span> <span style="color:#75af00">Source</span><span style="color:#111">:</span> <span style="color:#75af00">kubetypes</span><span style="color:#111">.</span><span style="color:#75af00">ApiserverSource</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">cache</span><span style="color:#111">.</span><span style="color:#75af00">NewReflector</span><span style="color:#111">(</span><span style="color:#75af00">lw</span><span style="color:#111">,</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">v1</span><span style="color:#111">.</span><span style="color:#75af00">Pod</span><span style="color:#111">{},</span> <span style="color:#75af00">cache</span><span style="color:#111">.</span><span style="color:#75af00">NewUndeltaStore</span><span style="color:#111">(</span><span style="color:#75af00">send</span><span style="color:#111">,</span> <span style="color:#75af00">cache</span><span style="color:#111">.</span><span style="color:#75af00">MetaNamespaceKeyFunc</span><span style="color:#111">),</span> <span style="color:#ae81ff">0</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">go</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">Run</span><span style="color:#111">(</span><span style="color:#75af00">wait</span><span style="color:#111">.</span><span style="color:#75af00">NeverStop</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>可以看到代码简单 就是 watrch apiserver 的 pod 然后把 pods 传给 updates channel</p>
<h3 id="file">file</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">s</span> <span style="color:#f92672">*</span><span style="color:#75af00">sourceFile</span><span style="color:#111">)</span> <span style="color:#75af00">doWatch</span><span style="color:#111">()</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">Stat</span><span style="color:#111">(</span><span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">path</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">IsNotExist</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Emit an update with an empty PodList to allow FileSource to be marked as seen</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">updates</span> <span style="color:#f92672">&lt;-</span> <span style="color:#75af00">kubetypes</span><span style="color:#111">.</span><span style="color:#75af00">PodUpdate</span><span style="color:#111">{</span><span style="color:#75af00">Pods</span><span style="color:#111">:</span> <span style="color:#111">[]</span><span style="color:#f92672">*</span><span style="color:#75af00">v1</span><span style="color:#111">.</span><span style="color:#75af00">Pod</span><span style="color:#111">{},</span> <span style="color:#75af00">Op</span><span style="color:#111">:</span> <span style="color:#75af00">kubetypes</span><span style="color:#111">.</span><span style="color:#75af00">SET</span><span style="color:#111">,</span> <span style="color:#75af00">Source</span><span style="color:#111">:</span> <span style="color:#75af00">kubetypes</span><span style="color:#111">.</span><span style="color:#75af00">FileSource</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">retryableError</span><span style="color:#111">{</span><span style="color:#d88200">&#34;path does not exist, ignoring&#34;</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">w</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">fsnotify</span><span style="color:#111">.</span><span style="color:#75af00">NewWatcher</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;unable to create inotify: %v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">w</span><span style="color:#111">.</span><span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">w</span><span style="color:#111">.</span><span style="color:#75af00">Add</span><span style="color:#111">(</span><span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">path</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;unable to create inotify for path %q: %v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">path</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">select</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">case</span> <span style="color:#75af00">event</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#75af00">w</span><span style="color:#111">.</span><span style="color:#75af00">Events</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">produceWatchEvent</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">event</span><span style="color:#111">);</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">return</span> <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;error while processing inotify event (%+v): %v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">event</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">case</span> <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#f92672">&lt;-</span><span style="color:#75af00">w</span><span style="color:#111">.</span><span style="color:#75af00">Errors</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;error while watching %q: %v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">path</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">s</span> <span style="color:#f92672">*</span><span style="color:#75af00">sourceFile</span><span style="color:#111">)</span> <span style="color:#75af00">produceWatchEvent</span><span style="color:#111">(</span><span style="color:#75af00">e</span> <span style="color:#f92672">*</span><span style="color:#75af00">fsnotify</span><span style="color:#111">.</span><span style="color:#75af00">Event</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Ignore file start with dots</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">strings</span><span style="color:#111">.</span><span style="color:#75af00">HasPrefix</span><span style="color:#111">(</span><span style="color:#75af00">filepath</span><span style="color:#111">.</span><span style="color:#75af00">Base</span><span style="color:#111">(</span><span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">Name</span><span style="color:#111">),</span> <span style="color:#d88200">&#34;.&#34;</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#ae81ff">4</span><span style="color:#111">).</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Ignored pod manifest, because it starts with dots&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;eventName&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">Name</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">var</span> <span style="color:#75af00">eventType</span> <span style="color:#75af00">podEventType</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">switch</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">case</span> <span style="color:#111">(</span><span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">Op</span> <span style="color:#f92672">&amp;</span> <span style="color:#75af00">fsnotify</span><span style="color:#111">.</span><span style="color:#75af00">Create</span><span style="color:#111">)</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">0</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">eventType</span> <span style="color:#111">=</span> <span style="color:#75af00">podAdd</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">case</span> <span style="color:#111">(</span><span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">Op</span> <span style="color:#f92672">&amp;</span> <span style="color:#75af00">fsnotify</span><span style="color:#111">.</span><span style="color:#75af00">Write</span><span style="color:#111">)</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">0</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">eventType</span> <span style="color:#111">=</span> <span style="color:#75af00">podModify</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">case</span> <span style="color:#111">(</span><span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">Op</span> <span style="color:#f92672">&amp;</span> <span style="color:#75af00">fsnotify</span><span style="color:#111">.</span><span style="color:#75af00">Chmod</span><span style="color:#111">)</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">0</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">eventType</span> <span style="color:#111">=</span> <span style="color:#75af00">podModify</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">case</span> <span style="color:#111">(</span><span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">Op</span> <span style="color:#f92672">&amp;</span> <span style="color:#75af00">fsnotify</span><span style="color:#111">.</span><span style="color:#75af00">Remove</span><span style="color:#111">)</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">0</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">eventType</span> <span style="color:#111">=</span> <span style="color:#75af00">podDelete</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">case</span> <span style="color:#111">(</span><span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">Op</span> <span style="color:#f92672">&amp;</span> <span style="color:#75af00">fsnotify</span><span style="color:#111">.</span><span style="color:#75af00">Rename</span><span style="color:#111">)</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">0</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">eventType</span> <span style="color:#111">=</span> <span style="color:#75af00">podDelete</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">default</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Ignore rest events</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">watchEvents</span> <span style="color:#f92672">&lt;-</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">watchEvent</span><span style="color:#111">{</span><span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">Name</span><span style="color:#111">,</span> <span style="color:#75af00">eventType</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">s</span> <span style="color:#f92672">*</span><span style="color:#75af00">sourceFile</span><span style="color:#111">)</span> <span style="color:#75af00">run</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">listTicker</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">NewTicker</span><span style="color:#111">(</span><span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">period</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">go</span> <span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Read path immediately to speed up startup.</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">listConfig</span><span style="color:#111">();</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">ErrorS</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Unable to read config path&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;path&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">path</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">for</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">select</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#75af00">listTicker</span><span style="color:#111">.</span><span style="color:#75af00">C</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">listConfig</span><span style="color:#111">();</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">ErrorS</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Unable to read config path&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;path&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">path</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">case</span> <span style="color:#75af00">e</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">watchEvents</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">consumeWatchEvent</span><span style="color:#111">(</span><span style="color:#75af00">e</span><span style="color:#111">);</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">ErrorS</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Unable to process watch event&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">startWatch</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>上面是 file source 的代码 也是 watch 文件变化 然后把变化的 pod 传给 updates channel
这个主要的作用就是 kubeadm 等部署 k8s 集群 使用文件拉起 kube-apiserver etcd kube-controller-manager kube-scheduler 等组件</p>
<h3 id="http">http</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">s</span> <span style="color:#f92672">*</span><span style="color:#75af00">sourceURL</span><span style="color:#111">)</span> <span style="color:#75af00">run</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">extractFromURL</span><span style="color:#111">();</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Don&#39;t log this multiple times per minute. The first few entries should be</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// enough to get the point across.</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">failureLogs</span> <span style="color:#111">&lt;</span> <span style="color:#ae81ff">3</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Failed to read pods from URL&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;err&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#00a8c8">if</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">failureLogs</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">3</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Failed to read pods from URL. Dropping verbosity of this message to V(4)&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;err&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#ae81ff">4</span><span style="color:#111">).</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Failed to read pods from URL&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;err&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">failureLogs</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">failureLogs</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Successfully read pods from URL&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">failureLogs</span> <span style="color:#111">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">s</span> <span style="color:#f92672">*</span><span style="color:#75af00">sourceURL</span><span style="color:#111">)</span> <span style="color:#75af00">applyDefaults</span><span style="color:#111">(</span><span style="color:#75af00">pod</span> <span style="color:#f92672">*</span><span style="color:#75af00">api</span><span style="color:#111">.</span><span style="color:#75af00">Pod</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">applyDefaults</span><span style="color:#111">(</span><span style="color:#75af00">pod</span><span style="color:#111">,</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">url</span><span style="color:#111">,</span> <span style="color:#00a8c8">false</span><span style="color:#111">,</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">nodeName</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">s</span> <span style="color:#f92672">*</span><span style="color:#75af00">sourceURL</span><span style="color:#111">)</span> <span style="color:#75af00">extractFromURL</span><span style="color:#111">()</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">req</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">NewRequest</span><span style="color:#111">(</span><span style="color:#d88200">&#34;GET&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">url</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">req</span><span style="color:#111">.</span><span style="color:#75af00">Header</span> <span style="color:#111">=</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">header</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">resp</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">client</span><span style="color:#111">.</span><span style="color:#75af00">Do</span><span style="color:#111">(</span><span style="color:#75af00">req</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">resp</span><span style="color:#111">.</span><span style="color:#75af00">Body</span><span style="color:#111">.</span><span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">data</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">utilio</span><span style="color:#111">.</span><span style="color:#75af00">ReadAtMost</span><span style="color:#111">(</span><span style="color:#75af00">resp</span><span style="color:#111">.</span><span style="color:#75af00">Body</span><span style="color:#111">,</span> <span style="color:#75af00">maxConfigLength</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">resp</span><span style="color:#111">.</span><span style="color:#75af00">StatusCode</span> <span style="color:#f92672">!=</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">StatusOK</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;%v: %v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">url</span><span style="color:#111">,</span> <span style="color:#75af00">resp</span><span style="color:#111">.</span><span style="color:#75af00">Status</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">data</span><span style="color:#111">)</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Emit an update with an empty PodList to allow HTTPSource to be marked as seen</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">updates</span> <span style="color:#f92672">&lt;-</span> <span style="color:#75af00">kubetypes</span><span style="color:#111">.</span><span style="color:#75af00">PodUpdate</span><span style="color:#111">{</span><span style="color:#75af00">Pods</span><span style="color:#111">:</span> <span style="color:#111">[]</span><span style="color:#f92672">*</span><span style="color:#75af00">v1</span><span style="color:#111">.</span><span style="color:#75af00">Pod</span><span style="color:#111">{},</span> <span style="color:#75af00">Op</span><span style="color:#111">:</span> <span style="color:#75af00">kubetypes</span><span style="color:#111">.</span><span style="color:#75af00">SET</span><span style="color:#111">,</span> <span style="color:#75af00">Source</span><span style="color:#111">:</span> <span style="color:#75af00">kubetypes</span><span style="color:#111">.</span><span style="color:#75af00">HTTPSource</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;zero-length data received from %v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">url</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Short circuit if the data has not changed since the last time it was read.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">bytes</span><span style="color:#111">.</span><span style="color:#75af00">Equal</span><span style="color:#111">(</span><span style="color:#75af00">data</span><span style="color:#111">,</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">data</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">data</span> <span style="color:#111">=</span> <span style="color:#75af00">data</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// First try as it is a single pod.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">parsed</span><span style="color:#111">,</span> <span style="color:#75af00">pod</span><span style="color:#111">,</span> <span style="color:#75af00">singlePodErr</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">tryDecodeSinglePod</span><span style="color:#111">(</span><span style="color:#75af00">data</span><span style="color:#111">,</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">applyDefaults</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">parsed</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">singlePodErr</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// It parsed but could not be used.</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#75af00">singlePodErr</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">updates</span> <span style="color:#f92672">&lt;-</span> <span style="color:#75af00">kubetypes</span><span style="color:#111">.</span><span style="color:#75af00">PodUpdate</span><span style="color:#111">{</span><span style="color:#75af00">Pods</span><span style="color:#111">:</span> <span style="color:#111">[]</span><span style="color:#f92672">*</span><span style="color:#75af00">v1</span><span style="color:#111">.</span><span style="color:#75af00">Pod</span><span style="color:#111">{</span><span style="color:#75af00">pod</span><span style="color:#111">},</span> <span style="color:#75af00">Op</span><span style="color:#111">:</span> <span style="color:#75af00">kubetypes</span><span style="color:#111">.</span><span style="color:#75af00">SET</span><span style="color:#111">,</span> <span style="color:#75af00">Source</span><span style="color:#111">:</span> <span style="color:#75af00">kubetypes</span><span style="color:#111">.</span><span style="color:#75af00">HTTPSource</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// That didn&#39;t work, so try a list of pods.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">parsed</span><span style="color:#111">,</span> <span style="color:#75af00">podList</span><span style="color:#111">,</span> <span style="color:#75af00">multiPodErr</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">tryDecodePodList</span><span style="color:#111">(</span><span style="color:#75af00">data</span><span style="color:#111">,</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">applyDefaults</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">parsed</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">multiPodErr</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// It parsed but could not be used.</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#75af00">multiPodErr</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">pods</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">([]</span><span style="color:#f92672">*</span><span style="color:#75af00">v1</span><span style="color:#111">.</span><span style="color:#75af00">Pod</span><span style="color:#111">,</span> <span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">podList</span><span style="color:#111">.</span><span style="color:#75af00">Items</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">for</span> <span style="color:#75af00">i</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">podList</span><span style="color:#111">.</span><span style="color:#75af00">Items</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">pods</span> <span style="color:#111">=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">pods</span><span style="color:#111">,</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">podList</span><span style="color:#111">.</span><span style="color:#75af00">Items</span><span style="color:#111">[</span><span style="color:#75af00">i</span><span style="color:#111">])</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">updates</span> <span style="color:#f92672">&lt;-</span> <span style="color:#75af00">kubetypes</span><span style="color:#111">.</span><span style="color:#75af00">PodUpdate</span><span style="color:#111">{</span><span style="color:#75af00">Pods</span><span style="color:#111">:</span> <span style="color:#75af00">pods</span><span style="color:#111">,</span> <span style="color:#75af00">Op</span><span style="color:#111">:</span> <span style="color:#75af00">kubetypes</span><span style="color:#111">.</span><span style="color:#75af00">SET</span><span style="color:#111">,</span> <span style="color:#75af00">Source</span><span style="color:#111">:</span> <span style="color:#75af00">kubetypes</span><span style="color:#111">.</span><span style="color:#75af00">HTTPSource</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;%v: received &#39;%v&#39;, but couldn&#39;t parse as &#34;</span><span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>		<span style="color:#d88200">&#34;single (%v) or multiple pods (%v)&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">url</span><span style="color:#111">,</span> <span style="color:#111">string</span><span style="color:#111">(</span><span style="color:#75af00">data</span><span style="color:#111">),</span> <span style="color:#75af00">singlePodErr</span><span style="color:#111">,</span> <span style="color:#75af00">multiPodErr</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>http source 是 kubelet 本身开启 http 服务 通过调用 kubelet 的 http 接口来管理 pod 这个主要的作用是 给那些不想部署集群 只想使用 kubelet 的需求提供的</p>
<h2 id="pleg">PLEG</h2>
<p>PLEG（Pod Lifecycle Event Generator）是 Kubernetes 中的一个关键组件，它负责监视和处理 Pod 的生命周期事件。PLEG 运行在每个节点上，并与 kubelet 组件紧密配合工作。</p>
<p>PLEG 的主要功能包括：</p>
<ol>
<li>监控容器状态：PLEG 监控每个节点上正在运行的容器的状态，并根据其状态变化生成相应的事件。</li>
<li>生成事件：当容器的状态发生变化时，PLEG 会生成相应的事件，例如容器的创建、启动、停止、退出等事件。</li>
<li>同步状态：PLEG 通过与 kubelet 进行交互，将容器的状态信息同步给 kubelet，使 kubelet 能够了解容器的当前状态。</li>
<li>故障处理：PLEG 检测容器的状态变化，并在发现容器失败或异常时生成相应的事件，以便 kubelet 采取适当的故障处理措施。</li>
</ol>
<p>PLEG 的设计目标是提供高效可靠的容器生命周期事件处理。它使用操作系统的文件系统事件和容器运行时的状态查询机制来监视容器的状态变化，从而及时地生成相应的事件。这些事件对于监控、日志记录、故障排除和自动恢复等方面非常重要。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">PodLifecycleEventGenerator</span> <span style="color:#00a8c8">interface</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Start</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Watch</span><span style="color:#111">()</span> <span style="color:#00a8c8">chan</span> <span style="color:#f92672">*</span><span style="color:#75af00">PodLifecycleEvent</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Healthy</span><span style="color:#111">()</span> <span style="color:#111">(</span><span style="color:#00a8c8">bool</span><span style="color:#111">,</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">UpdateCache</span><span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">kubecontainer</span><span style="color:#111">.</span><span style="color:#75af00">Pod</span><span style="color:#111">,</span> <span style="color:#75af00">types</span><span style="color:#111">.</span><span style="color:#75af00">UID</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#00a8c8">error</span><span style="color:#111">,</span> <span style="color:#00a8c8">bool</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>kubelet 中实现了两种 PLEG，分别是：</p>
<ul>
<li>通用 PLEG：用于处理普通容器的生命周期事件。使用轮询机制监控容器的状态变化，因此可能会有一定的延迟。而且耗费资源较多，不适合大规模部署。</li>
<li>Event PLEG：用于处理事件容器的生命周期事件。使用事件机制监控容器的状态变化，因此响应速度较快。但是，他需要 container runtime 支持事件机制。</li>
</ul>
<h3 id="genericpleg">GenericPLEG</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">g</span> <span style="color:#f92672">*</span><span style="color:#75af00">GenericPLEG</span><span style="color:#111">)</span> <span style="color:#75af00">Watch</span><span style="color:#111">()</span> <span style="color:#00a8c8">chan</span> <span style="color:#f92672">*</span><span style="color:#75af00">PodLifecycleEvent</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">eventChannel</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">g</span> <span style="color:#f92672">*</span><span style="color:#75af00">GenericPLEG</span><span style="color:#111">)</span> <span style="color:#75af00">Start</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">runningMu</span><span style="color:#111">.</span><span style="color:#75af00">Lock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">runningMu</span><span style="color:#111">.</span><span style="color:#75af00">Unlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">isRunning</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">isRunning</span> <span style="color:#111">=</span> <span style="color:#00a8c8">true</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">stopCh</span> <span style="color:#111">=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">chan</span> <span style="color:#00a8c8">struct</span><span style="color:#111">{})</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">go</span> <span style="color:#75af00">wait</span><span style="color:#111">.</span><span style="color:#75af00">Until</span><span style="color:#111">(</span><span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">Relist</span><span style="color:#111">,</span> <span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">relistDuration</span><span style="color:#111">.</span><span style="color:#75af00">RelistPeriod</span><span style="color:#111">,</span> <span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">stopCh</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">g</span> <span style="color:#f92672">*</span><span style="color:#75af00">GenericPLEG</span><span style="color:#111">)</span> <span style="color:#75af00">Relist</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">relistLock</span><span style="color:#111">.</span><span style="color:#75af00">Lock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">relistLock</span><span style="color:#111">.</span><span style="color:#75af00">Unlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ctx</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Background</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#ae81ff">5</span><span style="color:#111">).</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;GenericPLEG: Relisting&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">lastRelistTime</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">getRelistTime</span><span style="color:#111">();</span> <span style="color:#111">!</span><span style="color:#75af00">lastRelistTime</span><span style="color:#111">.</span><span style="color:#75af00">IsZero</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">metrics</span><span style="color:#111">.</span><span style="color:#75af00">PLEGRelistInterval</span><span style="color:#111">.</span><span style="color:#75af00">Observe</span><span style="color:#111">(</span><span style="color:#75af00">metrics</span><span style="color:#111">.</span><span style="color:#75af00">SinceInSeconds</span><span style="color:#111">(</span><span style="color:#75af00">lastRelistTime</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">timestamp</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">clock</span><span style="color:#111">.</span><span style="color:#75af00">Now</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">metrics</span><span style="color:#111">.</span><span style="color:#75af00">PLEGRelistDuration</span><span style="color:#111">.</span><span style="color:#75af00">Observe</span><span style="color:#111">(</span><span style="color:#75af00">metrics</span><span style="color:#111">.</span><span style="color:#75af00">SinceInSeconds</span><span style="color:#111">(</span><span style="color:#75af00">timestamp</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Get all the pods.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">podList</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">runtime</span><span style="color:#111">.</span><span style="color:#75af00">GetPods</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#00a8c8">true</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">ErrorS</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;GenericPLEG: Unable to retrieve pods&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">updateRelistTime</span><span style="color:#111">(</span><span style="color:#75af00">timestamp</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">pods</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">kubecontainer</span><span style="color:#111">.</span><span style="color:#75af00">Pods</span><span style="color:#111">(</span><span style="color:#75af00">podList</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// update running pod and container count</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">updateRunningPodAndContainerMetrics</span><span style="color:#111">(</span><span style="color:#75af00">pods</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">podRecords</span><span style="color:#111">.</span><span style="color:#75af00">setCurrent</span><span style="color:#111">(</span><span style="color:#75af00">pods</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Compare the old and the current pods, and generate events.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">eventsByPodID</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#75af00">types</span><span style="color:#111">.</span><span style="color:#75af00">UID</span><span style="color:#111">][]</span><span style="color:#f92672">*</span><span style="color:#75af00">PodLifecycleEvent</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">pid</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">podRecords</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">oldPod</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">podRecords</span><span style="color:#111">.</span><span style="color:#75af00">getOld</span><span style="color:#111">(</span><span style="color:#75af00">pid</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">pod</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">podRecords</span><span style="color:#111">.</span><span style="color:#75af00">getCurrent</span><span style="color:#111">(</span><span style="color:#75af00">pid</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Get all containers in the old and the new pod.</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">allContainers</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">getContainersFromPods</span><span style="color:#111">(</span><span style="color:#75af00">oldPod</span><span style="color:#111">,</span> <span style="color:#75af00">pod</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">container</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">allContainers</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">events</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">computeEvents</span><span style="color:#111">(</span><span style="color:#75af00">oldPod</span><span style="color:#111">,</span> <span style="color:#75af00">pod</span><span style="color:#111">,</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">container</span><span style="color:#111">.</span><span style="color:#75af00">ID</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">e</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">events</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">updateEvents</span><span style="color:#111">(</span><span style="color:#75af00">eventsByPodID</span><span style="color:#111">,</span> <span style="color:#75af00">e</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">var</span> <span style="color:#75af00">needsReinspection</span> <span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#75af00">types</span><span style="color:#111">.</span><span style="color:#75af00">UID</span><span style="color:#111">]</span><span style="color:#f92672">*</span><span style="color:#75af00">kubecontainer</span><span style="color:#111">.</span><span style="color:#75af00">Pod</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">cacheEnabled</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">needsReinspection</span> <span style="color:#111">=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#75af00">types</span><span style="color:#111">.</span><span style="color:#75af00">UID</span><span style="color:#111">]</span><span style="color:#f92672">*</span><span style="color:#75af00">kubecontainer</span><span style="color:#111">.</span><span style="color:#75af00">Pod</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// If there are events associated with a pod, we should update the</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// podCache.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">pid</span><span style="color:#111">,</span> <span style="color:#75af00">events</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">eventsByPodID</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">pod</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">podRecords</span><span style="color:#111">.</span><span style="color:#75af00">getCurrent</span><span style="color:#111">(</span><span style="color:#75af00">pid</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">cacheEnabled</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// updateCache() will inspect the pod and update the cache. If an</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// error occurs during the inspection, we want PLEG to retry again</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// in the next relist. To achieve this, we do not update the</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// associated podRecord of the pod, so that the change will be</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// detect again in the next relist.</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// TODO: If many pods changed during the same relist period,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// inspecting the pod and getting the PodStatus to update the cache</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// serially may take a while. We should be aware of this and</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// parallelize if needed.</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#75af00">updated</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">updateCache</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">pod</span><span style="color:#111">,</span> <span style="color:#75af00">pid</span><span style="color:#111">);</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// Rely on updateCache calling GetPodStatus to log the actual error.</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#ae81ff">4</span><span style="color:#111">).</span><span style="color:#75af00">ErrorS</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;PLEG: Ignoring events for pod&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;pod&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">KRef</span><span style="color:#111">(</span><span style="color:#75af00">pod</span><span style="color:#111">.</span><span style="color:#75af00">Namespace</span><span style="color:#111">,</span> <span style="color:#75af00">pod</span><span style="color:#111">.</span><span style="color:#75af00">Name</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// make sure we try to reinspect the pod during the next relisting</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">needsReinspection</span><span style="color:#111">[</span><span style="color:#75af00">pid</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#75af00">pod</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">continue</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// this pod was in the list to reinspect and we did so because it had events, so remove it</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// from the list (we don&#39;t want the reinspection code below to inspect it a second time in</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// this relist execution)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#111">delete</span><span style="color:#111">(</span><span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">podsToReinspect</span><span style="color:#111">,</span> <span style="color:#75af00">pid</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">if</span> <span style="color:#75af00">utilfeature</span><span style="color:#111">.</span><span style="color:#75af00">DefaultFeatureGate</span><span style="color:#111">.</span><span style="color:#75af00">Enabled</span><span style="color:#111">(</span><span style="color:#75af00">features</span><span style="color:#111">.</span><span style="color:#75af00">EventedPLEG</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">updated</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>						<span style="color:#00a8c8">continue</span>
</span></span><span style="display:flex;"><span>					<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>				<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Update the internal storage and send out the events.</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">podRecords</span><span style="color:#111">.</span><span style="color:#75af00">update</span><span style="color:#111">(</span><span style="color:#75af00">pid</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Map from containerId to exit code; used as a temporary cache for lookup</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">containerExitCode</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#00a8c8">string</span><span style="color:#111">]</span><span style="color:#00a8c8">int</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">for</span> <span style="color:#75af00">i</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">events</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// Filter out events that are not reliable and no other components use yet.</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">events</span><span style="color:#111">[</span><span style="color:#75af00">i</span><span style="color:#111">].</span><span style="color:#75af00">Type</span> <span style="color:#f92672">==</span> <span style="color:#75af00">ContainerChanged</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">continue</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">select</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">case</span> <span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">eventChannel</span> <span style="color:#f92672">&lt;-</span> <span style="color:#75af00">events</span><span style="color:#111">[</span><span style="color:#75af00">i</span><span style="color:#111">]:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">default</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">metrics</span><span style="color:#111">.</span><span style="color:#75af00">PLEGDiscardEvents</span><span style="color:#111">.</span><span style="color:#75af00">Inc</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">ErrorS</span><span style="color:#111">(</span><span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Event channel is full, discard this relist() cycle event&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// Log exit code of containers when they finished in a particular event</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">events</span><span style="color:#111">[</span><span style="color:#75af00">i</span><span style="color:#111">].</span><span style="color:#75af00">Type</span> <span style="color:#f92672">==</span> <span style="color:#75af00">ContainerDied</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// Fill up containerExitCode map for ContainerDied event when first time appeared</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">if</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">containerExitCode</span><span style="color:#111">)</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">pod</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">cache</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75715e">// Get updated podStatus</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">status</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">cache</span><span style="color:#111">.</span><span style="color:#75af00">Get</span><span style="color:#111">(</span><span style="color:#75af00">pod</span><span style="color:#111">.</span><span style="color:#75af00">ID</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>					<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>						<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">containerStatus</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">status</span><span style="color:#111">.</span><span style="color:#75af00">ContainerStatuses</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>							<span style="color:#75af00">containerExitCode</span><span style="color:#111">[</span><span style="color:#75af00">containerStatus</span><span style="color:#111">.</span><span style="color:#75af00">ID</span><span style="color:#111">.</span><span style="color:#75af00">ID</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#75af00">containerStatus</span><span style="color:#111">.</span><span style="color:#75af00">ExitCode</span>
</span></span><span style="display:flex;"><span>						<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>					<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>				<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">if</span> <span style="color:#75af00">containerID</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">events</span><span style="color:#111">[</span><span style="color:#75af00">i</span><span style="color:#111">].</span><span style="color:#75af00">Data</span><span style="color:#111">.(</span><span style="color:#00a8c8">string</span><span style="color:#111">);</span> <span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#00a8c8">if</span> <span style="color:#75af00">exitCode</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">containerExitCode</span><span style="color:#111">[</span><span style="color:#75af00">containerID</span><span style="color:#111">];</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">pod</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>						<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#ae81ff">2</span><span style="color:#111">).</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Generic (PLEG): container finished&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;podID&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">pod</span><span style="color:#111">.</span><span style="color:#75af00">ID</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;containerID&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">containerID</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;exitCode&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">exitCode</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>					<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>				<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">cacheEnabled</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// reinspect any pods that failed inspection during the previous relist</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">podsToReinspect</span><span style="color:#111">)</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#ae81ff">5</span><span style="color:#111">).</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;GenericPLEG: Reinspecting pods that previously failed inspection&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">for</span> <span style="color:#75af00">pid</span><span style="color:#111">,</span> <span style="color:#75af00">pod</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">podsToReinspect</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#75af00">_</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">updateCache</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">pod</span><span style="color:#111">,</span> <span style="color:#75af00">pid</span><span style="color:#111">);</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75715e">// Rely on updateCache calling GetPodStatus to log the actual error.</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#ae81ff">5</span><span style="color:#111">).</span><span style="color:#75af00">ErrorS</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;PLEG: pod failed reinspection&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;pod&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">KRef</span><span style="color:#111">(</span><span style="color:#75af00">pod</span><span style="color:#111">.</span><span style="color:#75af00">Namespace</span><span style="color:#111">,</span> <span style="color:#75af00">pod</span><span style="color:#111">.</span><span style="color:#75af00">Name</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">needsReinspection</span><span style="color:#111">[</span><span style="color:#75af00">pid</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#75af00">pod</span>
</span></span><span style="display:flex;"><span>				<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Update the cache timestamp.  This needs to happen *after*</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// all pods have been properly updated in the cache.</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">cache</span><span style="color:#111">.</span><span style="color:#75af00">UpdateTime</span><span style="color:#111">(</span><span style="color:#75af00">timestamp</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// make sure we retain the list of pods that need reinspecting the next time relist is called</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">podsToReinspect</span> <span style="color:#111">=</span> <span style="color:#75af00">needsReinspection</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>可以看到 GenericPLEG 会定时从 runtime 获取 pods 然后和缓存中的旧的 pod 进行对比 然后生成事件发送给 eventChannel</p>
<h3 id="eventpleg">EventPLEG</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">e</span> <span style="color:#f92672">*</span><span style="color:#75af00">EventedPLEG</span><span style="color:#111">)</span> <span style="color:#75af00">Start</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">runningMu</span><span style="color:#111">.</span><span style="color:#75af00">Lock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">runningMu</span><span style="color:#111">.</span><span style="color:#75af00">Unlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">isEventedPLEGInUse</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">setEventedPLEGUsage</span><span style="color:#111">(</span><span style="color:#00a8c8">true</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">stopCh</span> <span style="color:#111">=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">chan</span> <span style="color:#00a8c8">struct</span><span style="color:#111">{})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">stopCacheUpdateCh</span> <span style="color:#111">=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">chan</span> <span style="color:#00a8c8">struct</span><span style="color:#111">{})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">go</span> <span style="color:#75af00">wait</span><span style="color:#111">.</span><span style="color:#75af00">Until</span><span style="color:#111">(</span><span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">watchEventsChannel</span><span style="color:#111">,</span> <span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">stopCh</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">go</span> <span style="color:#75af00">wait</span><span style="color:#111">.</span><span style="color:#75af00">Until</span><span style="color:#111">(</span><span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">updateGlobalCache</span><span style="color:#111">,</span> <span style="color:#75af00">globalCacheUpdatePeriod</span><span style="color:#111">,</span> <span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">stopCacheUpdateCh</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">e</span> <span style="color:#f92672">*</span><span style="color:#75af00">EventedPLEG</span><span style="color:#111">)</span> <span style="color:#75af00">watchEventsChannel</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">containerEventsResponseCh</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">chan</span> <span style="color:#f92672">*</span><span style="color:#75af00">runtimeapi</span><span style="color:#111">.</span><span style="color:#75af00">ContainerEventResponse</span><span style="color:#111">,</span> <span style="color:#111">cap</span><span style="color:#111">(</span><span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">eventChannel</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#111">close</span><span style="color:#111">(</span><span style="color:#75af00">containerEventsResponseCh</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Get the container events from the runtime.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">go</span> <span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">numAttempts</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">for</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">numAttempts</span> <span style="color:#f92672">&gt;=</span> <span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">eventedPlegMaxStreamRetries</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">if</span> <span style="color:#75af00">isEventedPLEGInUse</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75715e">// Fall back to Generic PLEG relisting since Evented PLEG is not working.</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#ae81ff">4</span><span style="color:#111">).</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Fall back to Generic PLEG relisting since Evented PLEG is not working&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">Stop</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">genericPleg</span><span style="color:#111">.</span><span style="color:#75af00">Stop</span><span style="color:#111">()</span>       <span style="color:#75715e">// Stop the existing Generic PLEG which runs with longer relisting period when Evented PLEG is in use.</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">Update</span><span style="color:#111">(</span><span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">relistDuration</span><span style="color:#111">)</span> <span style="color:#75715e">// Update the relisting period to the default value for the Generic PLEG.</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">genericPleg</span><span style="color:#111">.</span><span style="color:#75af00">Start</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>					<span style="color:#00a8c8">break</span>
</span></span><span style="display:flex;"><span>				<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">runtimeService</span><span style="color:#111">.</span><span style="color:#75af00">GetContainerEvents</span><span style="color:#111">(</span><span style="color:#75af00">containerEventsResponseCh</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">metrics</span><span style="color:#111">.</span><span style="color:#75af00">EventedPLEGConnErr</span><span style="color:#111">.</span><span style="color:#75af00">Inc</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">numAttempts</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">Relist</span><span style="color:#111">()</span> <span style="color:#75715e">// Force a relist to get the latest container and pods running metric.</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#ae81ff">4</span><span style="color:#111">).</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Evented PLEG: Failed to get container events, retrying: &#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;err&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">isEventedPLEGInUse</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">processCRIEvents</span><span style="color:#111">(</span><span style="color:#75af00">containerEventsResponseCh</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 转换 runtimeapi.ContainerEventResponse 为 PodLifecycleEvent</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">e</span> <span style="color:#f92672">*</span><span style="color:#75af00">EventedPLEG</span><span style="color:#111">)</span> <span style="color:#75af00">processCRIEvents</span><span style="color:#111">(</span><span style="color:#75af00">containerEventsResponseCh</span> <span style="color:#00a8c8">chan</span> <span style="color:#f92672">*</span><span style="color:#75af00">runtimeapi</span><span style="color:#111">.</span><span style="color:#75af00">ContainerEventResponse</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">event</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">containerEventsResponseCh</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Ignore the event if PodSandboxStatus is nil.</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// This might happen under some race condition where the podSandbox has</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// been deleted, and therefore container runtime couldn&#39;t find the</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// podSandbox for the container when generating the event.</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// It is safe to ignore because</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// a) a event would have been received for the sandbox deletion,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// b) in worst case, a relist will eventually sync the pod status.</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// TODO(#114371): Figure out a way to handle this case instead of ignoring.</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">event</span><span style="color:#111">.</span><span style="color:#75af00">PodSandboxStatus</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#f92672">||</span> <span style="color:#75af00">event</span><span style="color:#111">.</span><span style="color:#75af00">PodSandboxStatus</span><span style="color:#111">.</span><span style="color:#75af00">Metadata</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">ErrorS</span><span style="color:#111">(</span><span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Evented PLEG: received ContainerEventResponse with nil PodSandboxStatus or PodSandboxStatus.Metadata&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;containerEventResponse&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">event</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">continue</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">podID</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">types</span><span style="color:#111">.</span><span style="color:#75af00">UID</span><span style="color:#111">(</span><span style="color:#75af00">event</span><span style="color:#111">.</span><span style="color:#75af00">PodSandboxStatus</span><span style="color:#111">.</span><span style="color:#75af00">Metadata</span><span style="color:#111">.</span><span style="color:#75af00">Uid</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">shouldSendPLEGEvent</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">false</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">status</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">runtime</span><span style="color:#111">.</span><span style="color:#75af00">GeneratePodStatus</span><span style="color:#111">(</span><span style="color:#75af00">event</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// nolint:logcheck // Not using the result of klog.V inside the</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// if branch is okay, we just use it to determine whether the</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// additional &#34;podStatus&#34; key and its value should be added.</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#ae81ff">6</span><span style="color:#111">).</span><span style="color:#75af00">Enabled</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">ErrorS</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Evented PLEG: error generating pod status from the received event&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;podUID&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">podID</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;podStatus&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">status</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">ErrorS</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Evented PLEG: error generating pod status from the received event&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;podUID&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">podID</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">klogV</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#ae81ff">6</span><span style="color:#111">);</span> <span style="color:#75af00">klogV</span><span style="color:#111">.</span><span style="color:#75af00">Enabled</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">klogV</span><span style="color:#111">.</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Evented PLEG: Generated pod status from the received event&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;podUID&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">podID</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;podStatus&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">status</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#ae81ff">4</span><span style="color:#111">).</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Evented PLEG: Generated pod status from the received event&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;podUID&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">podID</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// Preserve the pod IP across cache updates if the new IP is empty.</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// When a pod is torn down, kubelet may race with PLEG and retrieve</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// a pod status after network teardown, but the kubernetes API expects</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// the completed pod&#39;s IP to be available after the pod is dead.</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">status</span><span style="color:#111">.</span><span style="color:#75af00">IPs</span> <span style="color:#111">=</span> <span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">getPodIPs</span><span style="color:#111">(</span><span style="color:#75af00">podID</span><span style="color:#111">,</span> <span style="color:#75af00">status</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">updateRunningPodMetric</span><span style="color:#111">(</span><span style="color:#75af00">status</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">updateRunningContainerMetric</span><span style="color:#111">(</span><span style="color:#75af00">status</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">updateLatencyMetric</span><span style="color:#111">(</span><span style="color:#75af00">event</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">event</span><span style="color:#111">.</span><span style="color:#75af00">ContainerEventType</span> <span style="color:#f92672">==</span> <span style="color:#75af00">runtimeapi</span><span style="color:#111">.</span><span style="color:#75af00">ContainerEventType_CONTAINER_DELETED_EVENT</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">sandbox</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">status</span><span style="color:#111">.</span><span style="color:#75af00">SandboxStatuses</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">if</span> <span style="color:#75af00">sandbox</span><span style="color:#111">.</span><span style="color:#75af00">Id</span> <span style="color:#f92672">==</span> <span style="color:#75af00">event</span><span style="color:#111">.</span><span style="color:#75af00">ContainerId</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75715e">// When the CONTAINER_DELETED_EVENT is received by the kubelet,</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75715e">// the runtime has indicated that the container has been removed</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75715e">// by the runtime and hence, it must be removed from the cache</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75715e">// of kubelet too.</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">cache</span><span style="color:#111">.</span><span style="color:#75af00">Delete</span><span style="color:#111">(</span><span style="color:#75af00">podID</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">shouldSendPLEGEvent</span> <span style="color:#111">=</span> <span style="color:#00a8c8">true</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">cache</span><span style="color:#111">.</span><span style="color:#75af00">Set</span><span style="color:#111">(</span><span style="color:#75af00">podID</span><span style="color:#111">,</span> <span style="color:#75af00">status</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Unix</span><span style="color:#111">(</span><span style="color:#75af00">event</span><span style="color:#111">.</span><span style="color:#75af00">GetCreatedAt</span><span style="color:#111">(),</span> <span style="color:#ae81ff">0</span><span style="color:#111">))</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">shouldSendPLEGEvent</span> <span style="color:#111">=</span> <span style="color:#00a8c8">true</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">shouldSendPLEGEvent</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">processCRIEvent</span><span style="color:#111">(</span><span style="color:#75af00">event</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>从代码中可以看到 EventPLEG 可以从 runtime 获取容器事件。</p>
]]></content:encoded><category>cloud</category><category>kubelet</category><category>kubernetes</category><category>源码分析</category><category>golang</category></item><item><title>kubernetes client-go功能介绍</title><link>https://daemon365.dev/post/cloud/kubernetes_client_go_function_introduction/</link><pubDate>Fri, 08 Mar 2024 17:11:00 +0800</pubDate><guid>https://daemon365.dev/post/cloud/kubernetes_client_go_function_introduction/</guid><description>&lt;h2 id="原文地址"&gt;原文地址&lt;/h2&gt;
&lt;p&gt;&lt;a href="https://haiyux.cc/2023/02/26/k8s-client-go/"&gt;https://haiyux.cc/2023/02/26/k8s-client-go/&lt;/a&gt;&lt;/p&gt;
&lt;h2 id="client-go是什么"&gt;client-go是什么？&lt;/h2&gt;
&lt;p&gt;client-go是Kubernetes官方提供的Go语言客户端库，用于与Kubernetes API服务器交互。使用client-go，您可以编写Go语言程序来创建、修改和删除Kubernetes对象，如Pod、Deployment、Service等。&lt;/p&gt;
&lt;h2 id="作用"&gt;作用&lt;/h2&gt;
&lt;p&gt;client-go的主要功能包括：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;连接Kubernetes API服务器：client-go提供了一个API客户端，用于连接Kubernetes API服务器。&lt;/li&gt;
&lt;li&gt;对象管理：client-go提供了一组API，用于创建、读取、更新和删除Kubernetes对象，如Pod、Deployment、Service等。&lt;/li&gt;
&lt;li&gt;Watch API：client-go提供了一个Watch API，可以用于监视Kubernetes对象的变化。&lt;/li&gt;
&lt;li&gt;命名空间支持：client-go支持多个命名空间，并提供了一组API，用于管理命名空间。&lt;/li&gt;
&lt;li&gt;认证和授权：client-go提供了一组API，用于执行身份验证和授权，以确保只有授权的用户才能对Kubernetes对象进行操作。&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;client-go是使用Kubernetes API的标准方式，是Kubernetes生态系统中的重要组成部分。&lt;/p&gt;
&lt;h2 id="api-client"&gt;api client&lt;/h2&gt;
&lt;p&gt;client-go 中包含四种client，&lt;code&gt;RestClient&lt;/code&gt;, &lt;code&gt;ClientSet&lt;/code&gt;，&lt;code&gt;DynamicClient&lt;/code&gt;和&lt;code&gt;DiscoveryClient&lt;/code&gt;。&lt;/p&gt;
&lt;p&gt;&lt;img src="https://daemon365.dev/images/ee8f5899-aa4e-45a6-b240-dcec971e9cd7.png" alt=""&gt;&lt;/p&gt;
&lt;p&gt;&lt;code&gt;ClientSet&lt;/code&gt;，&lt;code&gt;DynamicClient&lt;/code&gt;，&lt;code&gt;DiscoveryClient&lt;/code&gt;都是&lt;code&gt;RestClient&lt;/code&gt;上的封装&lt;/p&gt;
&lt;h3 id="restclient"&gt;RestClient&lt;/h3&gt;
&lt;p&gt;RestClient是最基础的客户端，它基于HTTP请求进行了封装，实现了RESTful API。使用RESTClient提供的RESTful方法，如Get()、Put()、Post()和Delete()，可以直接与API进行交互。同时，它支持JSON和Protocol Buffers，并支持所有原生资源和自定义资源定义（CRDs）。然而，为了更加优雅地处理API交互，一般需要进一步封装，通过Clientset对RESTClient进行封装，然后再对外提供接口和服务。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;package&lt;/span&gt; &lt;span style="color:#75af00"&gt;main&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;import&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;context&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;fmt&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;path/filepath&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;corev1&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;k8s.io/api/core/v1&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;metav1&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;k8s.io/apimachinery/pkg/apis/meta/v1&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;k8s.io/client-go/kubernetes/scheme&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;k8s.io/client-go/rest&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;k8s.io/client-go/tools/clientcmd&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;k8s.io/client-go/util/homedir&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;main&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// 使用kubeconfig生成配置&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;config&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;clientcmd&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;BuildConfigFromFlags&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;filepath&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Join&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;homedir&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;HomeDir&lt;/span&gt;&lt;span style="color:#111"&gt;(),&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;.kube&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;config&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;))&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;!=&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;panic&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;err&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;config&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;APIPath&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;api&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;config&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;GroupVersion&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#f92672"&gt;&amp;amp;&lt;/span&gt;&lt;span style="color:#75af00"&gt;corev1&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;SchemeGroupVersion&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;config&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;NegotiatedSerializer&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#75af00"&gt;scheme&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Codecs&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// 生成restClient&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;restClient&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;rest&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;RESTClientFor&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;config&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;!=&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;panic&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;err&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;rest&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#f92672"&gt;&amp;amp;&lt;/span&gt;&lt;span style="color:#75af00"&gt;corev1&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;PodList&lt;/span&gt;&lt;span style="color:#111"&gt;{}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#75af00"&gt;restClient&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Get&lt;/span&gt;&lt;span style="color:#111"&gt;().&lt;/span&gt;&lt;span style="color:#75af00"&gt;Namespace&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;default&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;).&lt;/span&gt;&lt;span style="color:#75af00"&gt;Resource&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;pods&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;).&lt;/span&gt;&lt;span style="color:#75af00"&gt;VersionedParams&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#f92672"&gt;&amp;amp;&lt;/span&gt;&lt;span style="color:#75af00"&gt;metav1&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;ListOptions&lt;/span&gt;&lt;span style="color:#111"&gt;{},&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;scheme&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;ParameterCodec&lt;/span&gt;&lt;span style="color:#111"&gt;).&lt;/span&gt;&lt;span style="color:#75af00"&gt;Do&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;context&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;TODO&lt;/span&gt;&lt;span style="color:#111"&gt;()).&lt;/span&gt;&lt;span style="color:#75af00"&gt;Into&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;rest&lt;/span&gt;&lt;span style="color:#111"&gt;);&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;!=&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;panic&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;err&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;for&lt;/span&gt; &lt;span style="color:#75af00"&gt;_&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;v&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;range&lt;/span&gt; &lt;span style="color:#75af00"&gt;rest&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Items&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Printf&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;NameSpace: %v Name: %v Status: %v \n&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;v&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Namespace&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;v&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Name&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;v&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Status&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Phase&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;/*
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;结果
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;NameSpace: default Name: nginx-76d6c9b8c-8ljkt Status: Running
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;NameSpace: default Name: nginx-76d6c9b8c-jqv9h Status: Running
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;NameSpace: default Name: nginx-76d6c9b8c-kr9d2 Status: Running
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;NameSpace: default Name: nginx-76d6c9b8c-m4g5l Status: Running
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;NameSpace: default Name: nginx-76d6c9b8c-n8st9 Status: Running
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;*/&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id="clientset"&gt;ClientSet&lt;/h3&gt;
&lt;p&gt;ClientSet是在RestClient的基础上封装了对资源和版本的管理方法。资源可以理解为一个客户端，而ClientSet是多个客户端的集合。在操作资源对象时，需要指定Group和Version，然后根据资源获取。然而，ClientSet不支持自定义资源定义（CRDs），但使用kubebuilder生成代码时，会生成相应的ClientSet。&lt;/p&gt;</description><content:encoded><![CDATA[<h2 id="原文地址">原文地址</h2>
<p><a href="https://haiyux.cc/2023/02/26/k8s-client-go/">https://haiyux.cc/2023/02/26/k8s-client-go/</a></p>
<h2 id="client-go是什么">client-go是什么？</h2>
<p>client-go是Kubernetes官方提供的Go语言客户端库，用于与Kubernetes API服务器交互。使用client-go，您可以编写Go语言程序来创建、修改和删除Kubernetes对象，如Pod、Deployment、Service等。</p>
<h2 id="作用">作用</h2>
<p>client-go的主要功能包括：</p>
<ol>
<li>连接Kubernetes API服务器：client-go提供了一个API客户端，用于连接Kubernetes API服务器。</li>
<li>对象管理：client-go提供了一组API，用于创建、读取、更新和删除Kubernetes对象，如Pod、Deployment、Service等。</li>
<li>Watch API：client-go提供了一个Watch API，可以用于监视Kubernetes对象的变化。</li>
<li>命名空间支持：client-go支持多个命名空间，并提供了一组API，用于管理命名空间。</li>
<li>认证和授权：client-go提供了一组API，用于执行身份验证和授权，以确保只有授权的用户才能对Kubernetes对象进行操作。</li>
</ol>
<p>client-go是使用Kubernetes API的标准方式，是Kubernetes生态系统中的重要组成部分。</p>
<h2 id="api-client">api client</h2>
<p>client-go 中包含四种client，<code>RestClient</code>, <code>ClientSet</code>，<code>DynamicClient</code>和<code>DiscoveryClient</code>。</p>
<p><img src="/images/ee8f5899-aa4e-45a6-b240-dcec971e9cd7.png" alt=""></p>
<p><code>ClientSet</code>，<code>DynamicClient</code>，<code>DiscoveryClient</code>都是<code>RestClient</code>上的封装</p>
<h3 id="restclient">RestClient</h3>
<p>RestClient是最基础的客户端，它基于HTTP请求进行了封装，实现了RESTful API。使用RESTClient提供的RESTful方法，如Get()、Put()、Post()和Delete()，可以直接与API进行交互。同时，它支持JSON和Protocol Buffers，并支持所有原生资源和自定义资源定义（CRDs）。然而，为了更加优雅地处理API交互，一般需要进一步封装，通过Clientset对RESTClient进行封装，然后再对外提供接口和服务。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;context&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;path/filepath&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">corev1</span> <span style="color:#d88200">&#34;k8s.io/api/core/v1&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">metav1</span> <span style="color:#d88200">&#34;k8s.io/apimachinery/pkg/apis/meta/v1&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;k8s.io/client-go/kubernetes/scheme&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;k8s.io/client-go/rest&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;k8s.io/client-go/tools/clientcmd&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;k8s.io/client-go/util/homedir&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 使用kubeconfig生成配置</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">config</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">clientcmd</span><span style="color:#111">.</span><span style="color:#75af00">BuildConfigFromFlags</span><span style="color:#111">(</span><span style="color:#d88200">&#34;&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">filepath</span><span style="color:#111">.</span><span style="color:#75af00">Join</span><span style="color:#111">(</span><span style="color:#75af00">homedir</span><span style="color:#111">.</span><span style="color:#75af00">HomeDir</span><span style="color:#111">(),</span> <span style="color:#d88200">&#34;.kube&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;config&#34;</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">config</span><span style="color:#111">.</span><span style="color:#75af00">APIPath</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;api&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">config</span><span style="color:#111">.</span><span style="color:#75af00">GroupVersion</span> <span style="color:#111">=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">corev1</span><span style="color:#111">.</span><span style="color:#75af00">SchemeGroupVersion</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">config</span><span style="color:#111">.</span><span style="color:#75af00">NegotiatedSerializer</span> <span style="color:#111">=</span> <span style="color:#75af00">scheme</span><span style="color:#111">.</span><span style="color:#75af00">Codecs</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 生成restClient</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">restClient</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">rest</span><span style="color:#111">.</span><span style="color:#75af00">RESTClientFor</span><span style="color:#111">(</span><span style="color:#75af00">config</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">rest</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">corev1</span><span style="color:#111">.</span><span style="color:#75af00">PodList</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">restClient</span><span style="color:#111">.</span><span style="color:#75af00">Get</span><span style="color:#111">().</span><span style="color:#75af00">Namespace</span><span style="color:#111">(</span><span style="color:#d88200">&#34;default&#34;</span><span style="color:#111">).</span><span style="color:#75af00">Resource</span><span style="color:#111">(</span><span style="color:#d88200">&#34;pods&#34;</span><span style="color:#111">).</span><span style="color:#75af00">VersionedParams</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">metav1</span><span style="color:#111">.</span><span style="color:#75af00">ListOptions</span><span style="color:#111">{},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">scheme</span><span style="color:#111">.</span><span style="color:#75af00">ParameterCodec</span><span style="color:#111">).</span><span style="color:#75af00">Do</span><span style="color:#111">(</span><span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">TODO</span><span style="color:#111">()).</span><span style="color:#75af00">Into</span><span style="color:#111">(</span><span style="color:#75af00">rest</span><span style="color:#111">);</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">v</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">rest</span><span style="color:#111">.</span><span style="color:#75af00">Items</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;NameSpace: %v  Name: %v  Status: %v \n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">v</span><span style="color:#111">.</span><span style="color:#75af00">Namespace</span><span style="color:#111">,</span> <span style="color:#75af00">v</span><span style="color:#111">.</span><span style="color:#75af00">Name</span><span style="color:#111">,</span> <span style="color:#75af00">v</span><span style="color:#111">.</span><span style="color:#75af00">Status</span><span style="color:#111">.</span><span style="color:#75af00">Phase</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">结果
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">NameSpace: default  Name: nginx-76d6c9b8c-8ljkt  Status: Running 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">NameSpace: default  Name: nginx-76d6c9b8c-jqv9h  Status: Running 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">NameSpace: default  Name: nginx-76d6c9b8c-kr9d2  Status: Running 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">NameSpace: default  Name: nginx-76d6c9b8c-m4g5l  Status: Running 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">NameSpace: default  Name: nginx-76d6c9b8c-n8st9  Status: Running 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span></code></pre></div><h3 id="clientset">ClientSet</h3>
<p>ClientSet是在RestClient的基础上封装了对资源和版本的管理方法。资源可以理解为一个客户端，而ClientSet是多个客户端的集合。在操作资源对象时，需要指定Group和Version，然后根据资源获取。然而，ClientSet不支持自定义资源定义（CRDs），但使用kubebuilder生成代码时，会生成相应的ClientSet。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;context&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;path/filepath&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">metav1</span> <span style="color:#d88200">&#34;k8s.io/apimachinery/pkg/apis/meta/v1&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;k8s.io/client-go/kubernetes&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;k8s.io/client-go/tools/clientcmd&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;k8s.io/client-go/util/homedir&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ctx</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Background</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 使用kubeconfig生成配置 ~/.kube/config</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">config</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">clientcmd</span><span style="color:#111">.</span><span style="color:#75af00">BuildConfigFromFlags</span><span style="color:#111">(</span><span style="color:#d88200">&#34;&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">filepath</span><span style="color:#111">.</span><span style="color:#75af00">Join</span><span style="color:#111">(</span><span style="color:#75af00">homedir</span><span style="color:#111">.</span><span style="color:#75af00">HomeDir</span><span style="color:#111">(),</span> <span style="color:#d88200">&#34;.kube&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;config&#34;</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 生成clientSet</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">clientSet</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">kubernetes</span><span style="color:#111">.</span><span style="color:#75af00">NewForConfig</span><span style="color:#111">(</span><span style="color:#75af00">config</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">nodeList</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">clientSet</span><span style="color:#111">.</span><span style="color:#75af00">CoreV1</span><span style="color:#111">().</span><span style="color:#75af00">Nodes</span><span style="color:#111">().</span><span style="color:#75af00">List</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">metav1</span><span style="color:#111">.</span><span style="color:#75af00">ListOptions</span><span style="color:#111">{})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">node</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">nodeList</span><span style="color:#111">.</span><span style="color:#75af00">Items</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;nodeName: %v, status: %v \n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">node</span><span style="color:#111">.</span><span style="color:#75af00">GetName</span><span style="color:#111">(),</span> <span style="color:#75af00">node</span><span style="color:#111">.</span><span style="color:#75af00">GetCreationTimestamp</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// pod 是有namespace资源所以指定namespace 而node没有</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">pods</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">clientSet</span><span style="color:#111">.</span><span style="color:#75af00">CoreV1</span><span style="color:#111">().</span><span style="color:#75af00">Pods</span><span style="color:#111">(</span><span style="color:#d88200">&#34;default&#34;</span><span style="color:#111">).</span><span style="color:#75af00">List</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">metav1</span><span style="color:#111">.</span><span style="color:#75af00">ListOptions</span><span style="color:#111">{})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">v</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">pods</span><span style="color:#111">.</span><span style="color:#75af00">Items</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;namespace: %v podName: %v status: %v \n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">v</span><span style="color:#111">.</span><span style="color:#75af00">Namespace</span><span style="color:#111">,</span> <span style="color:#75af00">v</span><span style="color:#111">.</span><span style="color:#75af00">Name</span><span style="color:#111">,</span> <span style="color:#75af00">v</span><span style="color:#111">.</span><span style="color:#75af00">Status</span><span style="color:#111">.</span><span style="color:#75af00">Phase</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">结果:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">nodeName: minikube, status: 2023-01-27 18:45:35 +0800 CST 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">nodeName: minikube-m02, status: 2023-02-26 21:19:30 +0800 CST 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">nodeName: minikube-m03, status: 2023-02-26 21:19:38 +0800 CST 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">namespace: default podName: nginx-76d6c9b8c-8ljkt status: Running 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">namespace: default podName: nginx-76d6c9b8c-jqv9h status: Running 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">namespace: default podName: nginx-76d6c9b8c-kr9d2 status: Running 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">namespace: default podName: nginx-76d6c9b8c-m4g5l status: Running 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">namespace: default podName: nginx-76d6c9b8c-n8st9 status: Running 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span></code></pre></div><h3 id="dynamicclient">DynamicClient</h3>
<p>DynamicClient是一种动态客户端，它可以对任何资源进行RESTful操作，包括自定义资源定义（CRD）。与ClientSet不同，DynamicClient返回的对象是一个map[string]interface{}。如果一个控制器需要控制所有的API，可以使用DynamicClient。目前，DynamicClient在垃圾回收器和命名空间控制器中被广泛使用。</p>
<p>DynamicClient的处理过程将Resource（例如PodList）转换为unstructured类型。Kubernetes的所有资源都可以转换为这个结构类型。处理完毕后，再将其转换回PodList。整个转换过程类似于接口转换，即通过interface{}的断言实现。</p>
<p>DynamicClient是一种动态的客户端，它能处理Kubernetes所有的资源，但仅支持JSON</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;context&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;path/filepath&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">apiv1</span> <span style="color:#d88200">&#34;k8s.io/api/core/v1&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">metav1</span> <span style="color:#d88200">&#34;k8s.io/apimachinery/pkg/apis/meta/v1&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;k8s.io/apimachinery/pkg/runtime&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;k8s.io/apimachinery/pkg/runtime/schema&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;k8s.io/client-go/dynamic&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;k8s.io/client-go/tools/clientcmd&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;k8s.io/client-go/util/homedir&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ctx</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Background</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 使用kubeconfig生成配置 ~/.kube/config</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">config</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">clientcmd</span><span style="color:#111">.</span><span style="color:#75af00">BuildConfigFromFlags</span><span style="color:#111">(</span><span style="color:#d88200">&#34;&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">filepath</span><span style="color:#111">.</span><span style="color:#75af00">Join</span><span style="color:#111">(</span><span style="color:#75af00">homedir</span><span style="color:#111">.</span><span style="color:#75af00">HomeDir</span><span style="color:#111">(),</span> <span style="color:#d88200">&#34;.kube&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;config&#34;</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// dynamicClient</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">dynamicClient</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">dynamic</span><span style="color:#111">.</span><span style="color:#75af00">NewForConfig</span><span style="color:#111">(</span><span style="color:#75af00">config</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 定义组版本资源</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">gvr</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">schema</span><span style="color:#111">.</span><span style="color:#75af00">GroupVersionResource</span><span style="color:#111">{</span><span style="color:#75af00">Version</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;v1&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">Resource</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;pods&#34;</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">unStructObj</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">dynamicClient</span><span style="color:#111">.</span><span style="color:#75af00">Resource</span><span style="color:#111">(</span><span style="color:#75af00">gvr</span><span style="color:#111">).</span><span style="color:#75af00">Namespace</span><span style="color:#111">(</span><span style="color:#d88200">&#34;default&#34;</span><span style="color:#111">).</span><span style="color:#75af00">List</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">metav1</span><span style="color:#111">.</span><span style="color:#75af00">ListOptions</span><span style="color:#111">{})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">podList</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">apiv1</span><span style="color:#111">.</span><span style="color:#75af00">PodList</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">runtime</span><span style="color:#111">.</span><span style="color:#75af00">DefaultUnstructuredConverter</span><span style="color:#111">.</span><span style="color:#75af00">FromUnstructured</span><span style="color:#111">(</span><span style="color:#75af00">unStructObj</span><span style="color:#111">.</span><span style="color:#75af00">UnstructuredContent</span><span style="color:#111">(),</span> <span style="color:#75af00">podList</span><span style="color:#111">);</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">v</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">podList</span><span style="color:#111">.</span><span style="color:#75af00">Items</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;namespaces:%v  podName:%v status:%v \n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">v</span><span style="color:#111">.</span><span style="color:#75af00">Namespace</span><span style="color:#111">,</span> <span style="color:#75af00">v</span><span style="color:#111">.</span><span style="color:#75af00">Name</span><span style="color:#111">,</span> <span style="color:#75af00">v</span><span style="color:#111">.</span><span style="color:#75af00">Status</span><span style="color:#111">.</span><span style="color:#75af00">Phase</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">namespaces:default  podName:nginx-76d6c9b8c-8ljkt status:Running
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">namespaces:default  podName:nginx-76d6c9b8c-jqv9h status:Running
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">namespaces:default  podName:nginx-76d6c9b8c-kr9d2 status:Running
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">namespaces:default  podName:nginx-76d6c9b8c-m4g5l status:Running
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">namespaces:default  podName:nginx-76d6c9b8c-n8st9 status:Running
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span></code></pre></div><p>其中，GVR（group,version,resource） 用于标识 Kubernetes API 中的资源类型，其中 Group 表示 API 群组，Version 表示 API 版本，Resource 表示资源类型。例如，Deployment 的 GVR 为 &ldquo;apps/v1/deployments&rdquo;，其中 &ldquo;apps&rdquo; 是 API 群组，&ldquo;v1&rdquo; 是 API 版本，&ldquo;deployments&rdquo; 是资源类型。</p>
<h3 id="discoveryclient">DiscoveryClient</h3>
<p>DiscoveryClient 是一个发现客户端，它的主要作用是用于发现 API Server 支持的资源组、资源版本和资源信息。在 Kubernetes 中，API Server 支持很多资源组、资源版本和资源信息，我们可以通过使用 DiscoveryClient 来查看这些信息。此外，kubectl 的 API 版本和 API 资源也是通过 DiscoveryClient 来实现的。我们还可以将这些信息缓存到本地，以减轻 API 访问的压力。缓存文件默认存储在 <code>./kube/cache</code> 和 <code>./kube/http-cache</code> 目录下。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;path/filepath&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;k8s.io/apimachinery/pkg/runtime/schema&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;k8s.io/client-go/discovery&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;k8s.io/client-go/tools/clientcmd&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;k8s.io/client-go/util/homedir&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 使用kubeconfig生成配置 ~/.kube/config</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">config</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">clientcmd</span><span style="color:#111">.</span><span style="color:#75af00">BuildConfigFromFlags</span><span style="color:#111">(</span><span style="color:#d88200">&#34;&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">filepath</span><span style="color:#111">.</span><span style="color:#75af00">Join</span><span style="color:#111">(</span><span style="color:#75af00">homedir</span><span style="color:#111">.</span><span style="color:#75af00">HomeDir</span><span style="color:#111">(),</span> <span style="color:#d88200">&#34;.kube&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;config&#34;</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 生成discoverClient</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">discoverClient</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">discovery</span><span style="color:#111">.</span><span style="color:#75af00">NewDiscoveryClientForConfig</span><span style="color:#111">(</span><span style="color:#75af00">config</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">apiResourceList</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">discoverClient</span><span style="color:#111">.</span><span style="color:#75af00">ServerGroupsAndResources</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">v</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">apiResourceList</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">gv</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">schema</span><span style="color:#111">.</span><span style="color:#75af00">ParseGroupVersion</span><span style="color:#111">(</span><span style="color:#75af00">v</span><span style="color:#111">.</span><span style="color:#75af00">GroupVersion</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">resource</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">v</span><span style="color:#111">.</span><span style="color:#75af00">APIResources</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;name:%v group:%v version:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">resource</span><span style="color:#111">.</span><span style="color:#75af00">Name</span><span style="color:#111">,</span> <span style="color:#75af00">gv</span><span style="color:#111">.</span><span style="color:#75af00">Group</span><span style="color:#111">,</span> <span style="color:#75af00">gv</span><span style="color:#111">.</span><span style="color:#75af00">Version</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:bindings group: version:v1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:componentstatuses group: version:v1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:configmaps group: version:v1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:endpoints group: version:v1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:events group: version:v1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:limitranges group: version:v1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:namespaces group: version:v1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:namespaces/finalize group: version:v1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:namespaces/status group: version:v1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:nodes group: version:v1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:nodes/proxy group: version:v1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:nodes/status group: version:v1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:persistentvolumeclaims group: version:v1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:persistentvolumeclaims/status group: version:v1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:persistentvolumes group: version:v1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:persistentvolumes/status group: version:v1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:pods group: version:v1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:pods/attach group: version:v1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:pods/binding group: version:v1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:pods/ephemeralcontainers group: version:v1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:pods/eviction group: version:v1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:pods/exec group: version:v1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:pods/log group: version:v1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:pods/portforward group: version:v1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:pods/proxy group: version:v1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:pods/status group: version:v1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:podtemplates group: version:v1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:replicationcontrollers group: version:v1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:replicationcontrollers/scale group: version:v1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:replicationcontrollers/status group: version:v1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:resourcequotas group: version:v1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:resourcequotas/status group: version:v1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:secrets group: version:v1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:serviceaccounts group: version:v1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:serviceaccounts/token group: version:v1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:services group: version:v1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:services/proxy group: version:v1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:services/status group: version:v1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:apiservices group:apiregistration.k8s.io version:v1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:apiservices/status group:apiregistration.k8s.io version:v1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:controllerrevisions group:apps version:v1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:daemonsets group:apps version:v1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:daemonsets/status group:apps version:v1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:deployments group:apps version:v1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:deployments/scale group:apps version:v1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:deployments/status group:apps version:v1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:replicasets group:apps version:v1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:replicasets/scale group:apps version:v1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:replicasets/status group:apps version:v1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:statefulsets group:apps version:v1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:statefulsets/scale group:apps version:v1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:statefulsets/status group:apps version:v1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:events group:events.k8s.io version:v1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:tokenreviews group:authentication.k8s.io version:v1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:localsubjectaccessreviews group:authorization.k8s.io version:v1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:selfsubjectaccessreviews group:authorization.k8s.io version:v1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:selfsubjectrulesreviews group:authorization.k8s.io version:v1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:subjectaccessreviews group:authorization.k8s.io version:v1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:horizontalpodautoscalers group:autoscaling version:v2
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:horizontalpodautoscalers/status group:autoscaling version:v2
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:horizontalpodautoscalers group:autoscaling version:v1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:horizontalpodautoscalers/status group:autoscaling version:v1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:horizontalpodautoscalers group:autoscaling version:v2beta2
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:horizontalpodautoscalers/status group:autoscaling version:v2beta2
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:cronjobs group:batch version:v1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:cronjobs/status group:batch version:v1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:jobs group:batch version:v1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:jobs/status group:batch version:v1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:certificatesigningrequests group:certificates.k8s.io version:v1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:certificatesigningrequests/approval group:certificates.k8s.io version:v1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:certificatesigningrequests/status group:certificates.k8s.io version:v1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:ingressclasses group:networking.k8s.io version:v1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:ingresses group:networking.k8s.io version:v1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:ingresses/status group:networking.k8s.io version:v1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:networkpolicies group:networking.k8s.io version:v1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:networkpolicies/status group:networking.k8s.io version:v1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:poddisruptionbudgets group:policy version:v1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:poddisruptionbudgets/status group:policy version:v1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:clusterrolebindings group:rbac.authorization.k8s.io version:v1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:clusterroles group:rbac.authorization.k8s.io version:v1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:rolebindings group:rbac.authorization.k8s.io version:v1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:roles group:rbac.authorization.k8s.io version:v1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:csidrivers group:storage.k8s.io version:v1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:csinodes group:storage.k8s.io version:v1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:csistoragecapacities group:storage.k8s.io version:v1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:storageclasses group:storage.k8s.io version:v1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:volumeattachments group:storage.k8s.io version:v1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:volumeattachments/status group:storage.k8s.io version:v1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:csistoragecapacities group:storage.k8s.io version:v1beta1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:mutatingwebhookconfigurations group:admissionregistration.k8s.io version:v1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:validatingwebhookconfigurations group:admissionregistration.k8s.io version:v1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:customresourcedefinitions group:apiextensions.k8s.io version:v1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:customresourcedefinitions/status group:apiextensions.k8s.io version:v1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:priorityclasses group:scheduling.k8s.io version:v1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:leases group:coordination.k8s.io version:v1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:runtimeclasses group:node.k8s.io version:v1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:endpointslices group:discovery.k8s.io version:v1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:flowschemas group:flowcontrol.apiserver.k8s.io version:v1beta2
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:flowschemas/status group:flowcontrol.apiserver.k8s.io version:v1beta2
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:prioritylevelconfigurations group:flowcontrol.apiserver.k8s.io version:v1beta2
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:prioritylevelconfigurations/status group:flowcontrol.apiserver.k8s.io version:v1beta2
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:flowschemas group:flowcontrol.apiserver.k8s.io version:v1beta1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:flowschemas/status group:flowcontrol.apiserver.k8s.io version:v1beta1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:prioritylevelconfigurations group:flowcontrol.apiserver.k8s.io version:v1beta1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:prioritylevelconfigurations/status group:flowcontrol.apiserver.k8s.io version:v1beta1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:nodes group:metrics.k8s.io version:v1beta1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">name:pods group:metrics.k8s.io version:v1beta1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span></code></pre></div><h2 id="informer-indexer--lister机制">informer indexer  lister机制</h2>
<p><img src="/images/c42bc0af-cbf6-4ee4-ae5d-bc954b5c594f.png" alt=""></p>
<p>上图展示了自定义控制器的工作方式。在虚线上方，是client-go包的informer和indexer工作方式。informer负责监听Kubernetes API资源对象的变化，如创建、更新、删除等操作，并将这些变化通知给indexer进行索引和缓存。而indexer则是将API对象进行索引，以便在需要时快速地访问它们。lister则是对indexer的封装，提供了一种简单的方式来获取已经索引的对象列表，以供代码中的其他部分使用。这种分层结构的设计使得client-go可以高效地处理Kubernetes资源对象的变化，并在应用程序中方便地使用这些资源对象。</p>
<h3 id="informer">informer</h3>
<p>Informer是Kubernetes API客户端中一种重要的机制，它可以实现对资源对象的监视和事件通知。当Kubernetes集群中的资源对象发生变化时，Informer可以及时地获取到这些变化，并将这些变化以事件的形式通知给相关的监听器。Informer通过调用API Server提供的REST接口，以及Kubernetes中定义的watch机制，实现了对集群资源对象的全面监视。</p>
<p>下面是一个简单的pod informer示例，用于监控所有pod的变化并将其放入队列中，worker从队列中取出pod并打印相关信息。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;os/signal&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;syscall&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">v1</span> <span style="color:#d88200">&#34;k8s.io/api/core/v1&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;k8s.io/apimachinery/pkg/util/wait&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;k8s.io/client-go/informers&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;k8s.io/client-go/kubernetes&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;k8s.io/client-go/tools/cache&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;k8s.io/client-go/tools/clientcmd&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;k8s.io/client-go/util/workqueue&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 获取 kubeconfig 文件路径</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">kubeconfigPath</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">Getenv</span><span style="color:#111">(</span><span style="color:#d88200">&#34;KUBECONFIG&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">kubeconfigPath</span> <span style="color:#f92672">==</span> <span style="color:#d88200">&#34;&#34;</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">kubeconfigPath</span> <span style="color:#111">=</span> <span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">Getenv</span><span style="color:#111">(</span><span style="color:#d88200">&#34;HOME&#34;</span><span style="color:#111">)</span> <span style="color:#f92672">+</span> <span style="color:#d88200">&#34;/.kube/config&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 使用 kubeconfig 文件创建 kubernetes 客户端</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">config</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">clientcmd</span><span style="color:#111">.</span><span style="color:#75af00">BuildConfigFromFlags</span><span style="color:#111">(</span><span style="color:#d88200">&#34;&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">kubeconfigPath</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">clientset</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">kubernetes</span><span style="color:#111">.</span><span style="color:#75af00">NewForConfig</span><span style="color:#111">(</span><span style="color:#75af00">config</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 创建 informer 工厂</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">informerFactory</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">informers</span><span style="color:#111">.</span><span style="color:#75af00">NewSharedInformerFactory</span><span style="color:#111">(</span><span style="color:#75af00">clientset</span><span style="color:#111">,</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Minute</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 创建 informer 对象</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">podInformer</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">informerFactory</span><span style="color:#111">.</span><span style="color:#75af00">Core</span><span style="color:#111">().</span><span style="color:#75af00">V1</span><span style="color:#111">().</span><span style="color:#75af00">Pods</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 创建工作队列</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">queue</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">workqueue</span><span style="color:#111">.</span><span style="color:#75af00">NewRateLimitingQueue</span><span style="color:#111">(</span><span style="color:#75af00">workqueue</span><span style="color:#111">.</span><span style="color:#75af00">DefaultControllerRateLimiter</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 定义处理新增、更新和删除事件的回调函数</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">podHandler</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">cache</span><span style="color:#111">.</span><span style="color:#75af00">ResourceEventHandlerFuncs</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">AddFunc</span><span style="color:#111">:</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">obj</span> <span style="color:#00a8c8">interface</span><span style="color:#111">{})</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">key</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">cache</span><span style="color:#111">.</span><span style="color:#75af00">MetaNamespaceKeyFunc</span><span style="color:#111">(</span><span style="color:#75af00">obj</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">queue</span><span style="color:#111">.</span><span style="color:#75af00">Add</span><span style="color:#111">(</span><span style="color:#75af00">key</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">UpdateFunc</span><span style="color:#111">:</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">oldObj</span><span style="color:#111">,</span> <span style="color:#75af00">newObj</span> <span style="color:#00a8c8">interface</span><span style="color:#111">{})</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">key</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">cache</span><span style="color:#111">.</span><span style="color:#75af00">MetaNamespaceKeyFunc</span><span style="color:#111">(</span><span style="color:#75af00">newObj</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">queue</span><span style="color:#111">.</span><span style="color:#75af00">Add</span><span style="color:#111">(</span><span style="color:#75af00">key</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">DeleteFunc</span><span style="color:#111">:</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">obj</span> <span style="color:#00a8c8">interface</span><span style="color:#111">{})</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">key</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">cache</span><span style="color:#111">.</span><span style="color:#75af00">MetaNamespaceKeyFunc</span><span style="color:#111">(</span><span style="color:#75af00">obj</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">queue</span><span style="color:#111">.</span><span style="color:#75af00">Add</span><span style="color:#111">(</span><span style="color:#75af00">key</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">},</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 将回调函数注册到 informer 上</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">podInformer</span><span style="color:#111">.</span><span style="color:#75af00">Informer</span><span style="color:#111">().</span><span style="color:#75af00">AddEventHandler</span><span style="color:#111">(</span><span style="color:#75af00">podHandler</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 启动 informer</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">stopCh</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">chan</span> <span style="color:#00a8c8">struct</span><span style="color:#111">{})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#111">close</span><span style="color:#111">(</span><span style="color:#75af00">stopCh</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">informerFactory</span><span style="color:#111">.</span><span style="color:#75af00">Start</span><span style="color:#111">(</span><span style="color:#75af00">stopCh</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 等待 informer 同步完成</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">cache</span><span style="color:#111">.</span><span style="color:#75af00">WaitForCacheSync</span><span style="color:#111">(</span><span style="color:#75af00">stopCh</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#d88200">&#34;同步 informer 缓存失败&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 创建信号处理程序，用于捕捉 SIGTERM 和 SIGINT 信号</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">signalCh</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">chan</span> <span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">Signal</span><span style="color:#111">,</span> <span style="color:#ae81ff">1</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">signal</span><span style="color:#111">.</span><span style="color:#75af00">Notify</span><span style="color:#111">(</span><span style="color:#75af00">signalCh</span><span style="color:#111">,</span> <span style="color:#75af00">syscall</span><span style="color:#111">.</span><span style="color:#75af00">SIGTERM</span><span style="color:#111">,</span> <span style="color:#75af00">syscall</span><span style="color:#111">.</span><span style="color:#75af00">SIGINT</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 创建 worker 函数，用于处理队列中的事件</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">processNextItem</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">obj</span><span style="color:#111">,</span> <span style="color:#75af00">shutdown</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">queue</span><span style="color:#111">.</span><span style="color:#75af00">Get</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">shutdown</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 转换对象为 Pod</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">key</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">obj</span><span style="color:#111">.(</span><span style="color:#00a8c8">string</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">podObj</span><span style="color:#111">,</span> <span style="color:#75af00">exists</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">podInformer</span><span style="color:#111">.</span><span style="color:#75af00">Informer</span><span style="color:#111">().</span><span style="color:#75af00">GetIndexer</span><span style="color:#111">().</span><span style="color:#75af00">GetByKey</span><span style="color:#111">(</span><span style="color:#75af00">key</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">queue</span><span style="color:#111">.</span><span style="color:#75af00">Forget</span><span style="color:#111">(</span><span style="color:#75af00">obj</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Sprintf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;获取 Pod 失败：%v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">exists</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 如果对象已经被删除，就把它从队列中移除</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">queue</span><span style="color:#111">.</span><span style="color:#75af00">Forget</span><span style="color:#111">(</span><span style="color:#75af00">obj</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 在这里添加处理 Pod 的逻辑</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">pod</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">podObj</span><span style="color:#111">.(</span><span style="color:#f92672">*</span><span style="color:#75af00">v1</span><span style="color:#111">.</span><span style="color:#75af00">Pod</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;处理 Pod: namespace:%v,podName:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">pod</span><span style="color:#111">.</span><span style="color:#75af00">Namespace</span><span style="color:#111">,</span> <span style="color:#75af00">pod</span><span style="color:#111">.</span><span style="color:#75af00">Name</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 处理完事件后，把它从队列中移除</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">queue</span><span style="color:#111">.</span><span style="color:#75af00">Forget</span><span style="color:#111">(</span><span style="color:#75af00">obj</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 启动 worker</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">go</span> <span style="color:#75af00">wait</span><span style="color:#111">.</span><span style="color:#75af00">Until</span><span style="color:#111">(</span><span style="color:#75af00">processNextItem</span><span style="color:#111">,</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Second</span><span style="color:#111">,</span> <span style="color:#75af00">stopCh</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 等待信号</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">&lt;-</span><span style="color:#75af00">signalCh</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">处理 Pod: namespace:kube-system,podName:kindnet-h25kv
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">处理 Pod: namespace:kube-system,podName:kube-apiserver-minikube
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">处理 Pod: namespace:kube-system,podName:metrics-server-c9fb666df-zk4tb
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">处理 Pod: namespace:kubernetes-dashboard,podName:dashboard-metrics-scraper-b74747df5-4pb7w
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">处理 Pod: namespace:default,podName:nginx-76d6c9b8c-jqv9h
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">处理 Pod: namespace:default,podName:nginx-76d6c9b8c-m4g5l
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">处理 Pod: namespace:kube-system,podName:coredns-7f8cbcb969-48nz6
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">处理 Pod: namespace:kube-system,podName:kube-proxy-t766g
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">处理 Pod: namespace:kube-system,podName:kube-scheduler-minikube
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">处理 Pod: namespace:kube-system,podName:kindnet-44zl6
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">处理 Pod: namespace:kube-system,podName:kube-controller-manager-minikube
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">处理 Pod: namespace:kube-system,podName:kube-proxy-gq68w
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">处理 Pod: namespace:kube-system,podName:kube-proxy-l92vg
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">处理 Pod: namespace:kube-system,podName:storage-provisioner
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">处理 Pod: namespace:kubernetes-dashboard,podName:kubernetes-dashboard-57bbdc5f89-466rh
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">处理 Pod: namespace:default,podName:nginx-76d6c9b8c-kr9d2
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">处理 Pod: namespace:default,podName:nginx-76d6c9b8c-n8st9
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">处理 Pod: namespace:kube-system,podName:kindnet-w9f7t
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">处理 Pod: namespace:default,podName:nginx-76d6c9b8c-8ljkt
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">处理 Pod: namespace:kube-system,podName:etcd-minikube
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">处理 Pod: namespace:default,podName:nginx
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">处理 Pod: namespace:default,podName:ubuntu
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span></code></pre></div><h3 id="indexer">indexer</h3>
<p>Indexer是client-go中用于本地缓存资源对象的一种方式。它支持多种索引方式，并且可以使用函数<code>func(obj interface{}) ([]string, error)</code>进行索引。在检索时，需要使用相同的<code>indexName</code>参数。借助<code>informer</code>，indexer就可以维护一个特定资源的本地缓存，例如pod、namespace等。这种方法省去了每次get pod都要访问api-server的过程，从而减小了api-server的压力。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// 如何使用索引器来检索Pod对象</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">v1</span> <span style="color:#d88200">&#34;k8s.io/api/core/v1&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;k8s.io/apimachinery/pkg/api/meta&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">metav1</span> <span style="color:#d88200">&#34;k8s.io/apimachinery/pkg/apis/meta/v1&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;k8s.io/client-go/tools/cache&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">const</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">NamespaceIndexName</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;namespace&#34;</span> <span style="color:#75715e">// 定义一个索引器名称，用于按照命名空间检索Pod</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">NodeNameIndexName</span>  <span style="color:#111">=</span> <span style="color:#d88200">&#34;nodeName&#34;</span>  <span style="color:#75715e">// 定义一个索引器名称，用于按照节点名称检索Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// NamespaceIndexFunc是一个函数，用于从对象中提取命名空间作为索引键</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">NamespaceIndexFunc</span><span style="color:#111">(</span><span style="color:#75af00">obj</span> <span style="color:#00a8c8">interface</span><span style="color:#111">{})</span> <span style="color:#111">([]</span><span style="color:#00a8c8">string</span><span style="color:#111">,</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">m</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">meta</span><span style="color:#111">.</span><span style="color:#75af00">Accessor</span><span style="color:#111">(</span><span style="color:#75af00">obj</span><span style="color:#111">)</span> <span style="color:#75715e">// 获取对象的元数据</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#111">[]</span><span style="color:#00a8c8">string</span><span style="color:#111">{</span><span style="color:#d88200">&#34;&#34;</span><span style="color:#111">},</span> <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;object has no meta: %v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#111">[]</span><span style="color:#00a8c8">string</span><span style="color:#111">{</span><span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">GetNamespace</span><span style="color:#111">()},</span> <span style="color:#00a8c8">nil</span> <span style="color:#75715e">// 返回对象的命名空间</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// NodeNameIndexFunc是一个函数，用于从Pod对象中提取节点名称作为索引键</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">NodeNameIndexFunc</span><span style="color:#111">(</span><span style="color:#75af00">obj</span> <span style="color:#00a8c8">interface</span><span style="color:#111">{})</span> <span style="color:#111">([]</span><span style="color:#00a8c8">string</span><span style="color:#111">,</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">pod</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">obj</span><span style="color:#111">.(</span><span style="color:#f92672">*</span><span style="color:#75af00">v1</span><span style="color:#111">.</span><span style="color:#75af00">Pod</span><span style="color:#111">)</span> <span style="color:#75715e">// 判断对象是否是Pod类型</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#111">[]</span><span style="color:#00a8c8">string</span><span style="color:#111">{},</span> <span style="color:#00a8c8">nil</span> <span style="color:#75715e">// 如果不是，返回空切片</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#111">[]</span><span style="color:#00a8c8">string</span><span style="color:#111">{</span><span style="color:#75af00">pod</span><span style="color:#111">.</span><span style="color:#75af00">Spec</span><span style="color:#111">.</span><span style="color:#75af00">NodeName</span><span style="color:#111">},</span> <span style="color:#00a8c8">nil</span> <span style="color:#75715e">// 如果是，返回Pod的节点名称</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">index</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">cache</span><span style="color:#111">.</span><span style="color:#75af00">NewIndexer</span><span style="color:#111">(</span><span style="color:#75af00">cache</span><span style="color:#111">.</span><span style="color:#75af00">MetaNamespaceKeyFunc</span><span style="color:#111">,</span> <span style="color:#75af00">cache</span><span style="color:#111">.</span><span style="color:#75af00">Indexers</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">NamespaceIndexName</span><span style="color:#111">:</span> <span style="color:#75af00">NamespaceIndexFunc</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">NodeNameIndexName</span><span style="color:#111">:</span>  <span style="color:#75af00">NodeNameIndexFunc</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span> <span style="color:#75715e">// 创建一个新的索引器，指定主键函数和辅助键函数</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">pod1</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">v1</span><span style="color:#111">.</span><span style="color:#75af00">Pod</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">ObjectMeta</span><span style="color:#111">:</span> <span style="color:#75af00">metav1</span><span style="color:#111">.</span><span style="color:#75af00">ObjectMeta</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">Name</span><span style="color:#111">:</span>      <span style="color:#d88200">&#34;index-pod-1&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">Namespace</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;default&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">Spec</span><span style="color:#111">:</span> <span style="color:#75af00">v1</span><span style="color:#111">.</span><span style="color:#75af00">PodSpec</span><span style="color:#111">{</span><span style="color:#75af00">NodeName</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;node1&#34;</span><span style="color:#111">},</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span> <span style="color:#75715e">// 创建一个Pod对象，属于default命名空间和node1节点</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">pod2</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">v1</span><span style="color:#111">.</span><span style="color:#75af00">Pod</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">ObjectMeta</span><span style="color:#111">:</span> <span style="color:#75af00">metav1</span><span style="color:#111">.</span><span style="color:#75af00">ObjectMeta</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">Name</span><span style="color:#111">:</span>      <span style="color:#d88200">&#34;index-pod-2&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">Namespace</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;default&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">Spec</span><span style="color:#111">:</span> <span style="color:#75af00">v1</span><span style="color:#111">.</span><span style="color:#75af00">PodSpec</span><span style="color:#111">{</span><span style="color:#75af00">NodeName</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;node2&#34;</span><span style="color:#111">},</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span> <span style="color:#75715e">// 创建另一个Pod对象，属于default命名空间和node2节点</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">pod3</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">v1</span><span style="color:#111">.</span><span style="color:#75af00">Pod</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">ObjectMeta</span><span style="color:#111">:</span> <span style="color:#75af00">metav1</span><span style="color:#111">.</span><span style="color:#75af00">ObjectMeta</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">Name</span><span style="color:#111">:</span>      <span style="color:#d88200">&#34;index-pod-3&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">Namespace</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;kube-system&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">Spec</span><span style="color:#111">:</span> <span style="color:#75af00">v1</span><span style="color:#111">.</span><span style="color:#75af00">PodSpec</span><span style="color:#111">{</span><span style="color:#75af00">NodeName</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;node2&#34;</span><span style="color:#111">},</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span> <span style="color:#75715e">// 创建第三个Pod对象，属于kube-system命名空间和node2节点</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">index</span><span style="color:#111">.</span><span style="color:#75af00">Add</span><span style="color:#111">(</span><span style="color:#75af00">pod1</span><span style="color:#111">)</span> <span style="color:#75715e">// 将pod1添加到索引器中</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">index</span><span style="color:#111">.</span><span style="color:#75af00">Add</span><span style="color:#111">(</span><span style="color:#75af00">pod2</span><span style="color:#111">)</span> <span style="color:#75715e">// 将pod2添加到索引器中</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">index</span><span style="color:#111">.</span><span style="color:#75af00">Add</span><span style="color:#111">(</span><span style="color:#75af00">pod3</span><span style="color:#111">)</span> <span style="color:#75715e">// 将pod3添加到索引器中</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">pods</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">index</span><span style="color:#111">.</span><span style="color:#75af00">ByIndex</span><span style="color:#111">(</span><span style="color:#75af00">NamespaceIndexName</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;default&#34;</span><span style="color:#111">)</span> <span style="color:#75715e">// 按照命名空间为default检索Pod列表</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">pod</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">pods</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">pod</span><span style="color:#111">.(</span><span style="color:#f92672">*</span><span style="color:#75af00">v1</span><span style="color:#111">.</span><span style="color:#75af00">Pod</span><span style="color:#111">).</span><span style="color:#75af00">Name</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span> <span style="color:#75715e">// 遍历并打印检索到的Pod名称</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;*****************&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">pods</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">index</span><span style="color:#111">.</span><span style="color:#75af00">ByIndex</span><span style="color:#111">(</span><span style="color:#75af00">NodeNameIndexName</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;node2&#34;</span><span style="color:#111">)</span> <span style="color:#75715e">// 按照节点名称为node2检索Pod列表</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">pod</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">pods</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">pod</span><span style="color:#111">.(</span><span style="color:#f92672">*</span><span style="color:#75af00">v1</span><span style="color:#111">.</span><span style="color:#75af00">Pod</span><span style="color:#111">).</span><span style="color:#75af00">Name</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span> <span style="color:#75715e">// 遍历并打印</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">index-pod-2
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">index-pod-1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*****************
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">index-pod-2
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">index-pod-3
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span></code></pre></div><h3 id="lister">lister</h3>
<p>Lister是对Indexer的封装，提供了一种方便的方式来获取已经索引的Kubernetes资源对象列表。</p>
<p>具体而言，Lister是一个接口，包含了获取所有已索引对象的列表以及根据名称获取单个对象的方法。这些方法可以帮助开发者在应用程序中快速访问已经缓存的资源对象，而无需直接与Indexer交互。</p>
<p>Lister的主要功能包括：</p>
<ol>
<li>提供方便的接口：Lister接口的方法定义清晰简洁，使用起来非常方便，可以快速地获取已经索引的资源对象列表。</li>
<li>提高代码可读性：通过使用Lister接口，代码可读性得到提高。开发者可以更加专注于业务逻辑，而无需关注底层的Indexer实现细节。</li>
<li>提高代码复用性：由于Lister接口已经提供了通用的方法，因此可以更容易地在不同的代码模块中重用相同的逻辑，减少代码重复。</li>
</ol>
<p>总之，Lister作为client-go包中的一个重要组件，可以帮助开发者更加高效地处理Kubernetes资源对象，提高代码的可读性和可重用性。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;k8s.io/apimachinery/pkg/labels&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;k8s.io/client-go/informers&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;k8s.io/client-go/kubernetes&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;k8s.io/client-go/tools/cache&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;k8s.io/client-go/tools/clientcmd&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 获取 kubeconfig 文件路径</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">kubeconfigPath</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">Getenv</span><span style="color:#111">(</span><span style="color:#d88200">&#34;KUBECONFIG&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">kubeconfigPath</span> <span style="color:#f92672">==</span> <span style="color:#d88200">&#34;&#34;</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">kubeconfigPath</span> <span style="color:#111">=</span> <span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">Getenv</span><span style="color:#111">(</span><span style="color:#d88200">&#34;HOME&#34;</span><span style="color:#111">)</span> <span style="color:#f92672">+</span> <span style="color:#d88200">&#34;/.kube/config&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 使用 kubeconfig 文件创建 kubernetes 客户端</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">config</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">clientcmd</span><span style="color:#111">.</span><span style="color:#75af00">BuildConfigFromFlags</span><span style="color:#111">(</span><span style="color:#d88200">&#34;&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">kubeconfigPath</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">clientset</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">kubernetes</span><span style="color:#111">.</span><span style="color:#75af00">NewForConfig</span><span style="color:#111">(</span><span style="color:#75af00">config</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">.</span><span style="color:#75af00">Error</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 创建Informer</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">factory</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">informers</span><span style="color:#111">.</span><span style="color:#75af00">NewSharedInformerFactory</span><span style="color:#111">(</span><span style="color:#75af00">clientset</span><span style="color:#111">,</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Minute</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">podInformer</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">factory</span><span style="color:#111">.</span><span style="color:#75af00">Core</span><span style="color:#111">().</span><span style="color:#75af00">V1</span><span style="color:#111">().</span><span style="color:#75af00">Pods</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 创建Lister</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">lister</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">podInformer</span><span style="color:#111">.</span><span style="color:#75af00">Lister</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 等待Informer同步完成</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">stopCh</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">chan</span> <span style="color:#00a8c8">struct</span><span style="color:#111">{})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#111">close</span><span style="color:#111">(</span><span style="color:#75af00">stopCh</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">factory</span><span style="color:#111">.</span><span style="color:#75af00">Start</span><span style="color:#111">(</span><span style="color:#75af00">stopCh</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">cache</span><span style="color:#111">.</span><span style="color:#75af00">WaitForCacheSync</span><span style="color:#111">(</span><span style="color:#75af00">stopCh</span><span style="color:#111">,</span> <span style="color:#75af00">podInformer</span><span style="color:#111">.</span><span style="color:#75af00">Informer</span><span style="color:#111">().</span><span style="color:#75af00">HasSynced</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 获取namespace为&#34;default&#34;的Pod对象</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">podList</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">lister</span><span style="color:#111">.</span><span style="color:#75af00">Pods</span><span style="color:#111">(</span><span style="color:#d88200">&#34;default&#34;</span><span style="color:#111">).</span><span style="color:#75af00">List</span><span style="color:#111">(</span><span style="color:#75af00">labels</span><span style="color:#111">.</span><span style="color:#75af00">Everything</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">.</span><span style="color:#75af00">Error</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 打印Pod对象</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">pod</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">podList</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Pod name: %s, Namespace: %s\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">pod</span><span style="color:#111">.</span><span style="color:#75af00">Name</span><span style="color:#111">,</span> <span style="color:#75af00">pod</span><span style="color:#111">.</span><span style="color:#75af00">Namespace</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">Pod name: nginx-76d6c9b8c-m4g5l, Namespace: default
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">Pod name: nginx, Namespace: default
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">Pod name: ubuntu, Namespace: default
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">Pod name: nginx-76d6c9b8c-kr9d2, Namespace: default
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">Pod name: nginx-76d6c9b8c-n8st9, Namespace: default
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">Pod name: nginx-76d6c9b8c-8ljkt, Namespace: default
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">Pod name: nginx-76d6c9b8c-jqv9h, Namespace: default
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span></code></pre></div><h2 id="reference">Reference</h2>
<ul>
<li><a href="https://github.com/kubernetes/sample-controller/blob/master/docs/controller-client-go.md">sample-controller/controller-client-go.md at master · kubernetes/sample-controller (github.com)</a></li>
<li><a href="https://juejin.cn/post/6962869412785487909">K8s二开之 client-go 初探 - 掘金 (juejin.cn)</a></li>
</ul>
]]></content:encoded><category>cloud</category><category>client-go</category><category>kubernetes</category><category>golang</category></item><item><title>golang操作etcd</title><link>https://daemon365.dev/post/go/golang_operates_etcd/</link><pubDate>Sun, 08 Jan 2023 20:56:00 +0800</pubDate><guid>https://daemon365.dev/post/go/golang_operates_etcd/</guid><description>&lt;p&gt;etcd是近几年比较火热的一个开源的、分布式的键值对数据存储系统，提供共享配置、服务的注册和发现，本文主要介绍etcd的安装和使用。&lt;/p&gt;
&lt;h2 id="etcd介绍"&gt;etcd介绍&lt;/h2&gt;
&lt;p&gt;&lt;a href="https://etcd.io/"&gt;etcd&lt;/a&gt;是使用Go语言开发的一个开源的、高可用的分布式key-value存储系统，可以用于配置共享和服务的注册和发现。&lt;/p&gt;
&lt;p&gt;类似项目有zookeeper和consul。&lt;/p&gt;
&lt;p&gt;etcd具有以下特点：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;完全复制：集群中的每个节点都可以使用完整的存档&lt;/li&gt;
&lt;li&gt;高可用性：Etcd可用于避免硬件的单点故障或网络问题&lt;/li&gt;
&lt;li&gt;一致性：每次读取都会返回跨多主机的最新写入&lt;/li&gt;
&lt;li&gt;简单：包括一个定义良好、面向用户的API（gRPC）&lt;/li&gt;
&lt;li&gt;安全：实现了带有可选的客户端证书身份验证的自动化TLS&lt;/li&gt;
&lt;li&gt;快速：每秒10000次写入的基准速度&lt;/li&gt;
&lt;li&gt;可靠：使用Raft算法实现了强一致、高可用的服务存储目录&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="etcd应用场景"&gt;etcd应用场景&lt;/h2&gt;
&lt;h3 id="服务发现"&gt;服务发现&lt;/h3&gt;
&lt;p&gt;服务发现要解决的也是分布式系统中最常见的问题之一，即在同一个分布式集群中的进程或服务，要如何才能找到对方并建立连接。本质上来说，服务发现就是想要了解集群中是否有进程在监听 udp 或 tcp 端口，并且通过名字就可以查找和连接。&lt;/p&gt;
&lt;h3 id="配置中心"&gt;配置中心&lt;/h3&gt;
&lt;p&gt;将一些配置信息放到 etcd 上进行集中管理。&lt;/p&gt;
&lt;p&gt;这类场景的使用方式通常是这样：应用在启动的时候主动从 etcd 获取一次配置信息，同时，在 etcd 节点上注册一个 Watcher 并等待，以后每次配置有更新的时候，etcd 都会实时通知订阅者，以此达到获取最新配置信息的目的。&lt;/p&gt;
&lt;h3 id="分布式锁"&gt;分布式锁&lt;/h3&gt;
&lt;p&gt;因为 etcd 使用 Raft 算法保持了数据的强一致性，某次操作存储到集群中的值必然是全局一致的，所以很容易实现分布式锁。锁服务有两种使用方式，一是保持独占，二是控制时序。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;保持独占即所有获取锁的用户最终只有一个可以得到&lt;/strong&gt;。etcd 为此提供了一套实现分布式锁原子操作 CAS（CompareAndSwap）的 API。通过设置prevExist值，可以保证在多个节点同时去创建某个目录时，只有一个成功。而创建成功的用户就可以认为是获得了锁。&lt;/li&gt;
&lt;li&gt;控制时序，即所有想要获得锁的用户都会被安排执行，但是&lt;strong&gt;获得锁的顺序也是全局唯一的，同时决定了执行顺序&lt;/strong&gt;。etcd 为此也提供了一套 API（自动创建有序键），对一个目录建值时指定为POST动作，这样 etcd 会自动在目录下生成一个当前最大的值为键，存储这个新的值（客户端编号）。同时还可以使用 API 按顺序列出所有当前目录下的键值。此时这些键的值就是客户端的时序，而这些键中存储的值可以是代表客户端的编号。&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="为什么用-etcd-而不用zookeeper"&gt;为什么用 etcd 而不用ZooKeeper？&lt;/h2&gt;
&lt;p&gt;etcd 实现的这些功能，ZooKeeper都能实现。那么为什么要用 etcd 而非直接使用ZooKeeper呢？&lt;/p&gt;
&lt;h3 id="为什么不选择zookeeper"&gt;为什么不选择ZooKeeper？&lt;/h3&gt;
&lt;ol&gt;
&lt;li&gt;部署维护复杂，其使用的Paxos强一致性算法复杂难懂。官方只提供了Java和C两种语言的接口。&lt;/li&gt;
&lt;li&gt;使用Java编写引入大量的依赖。运维人员维护起来比较麻烦。&lt;/li&gt;
&lt;li&gt;最近几年发展缓慢，不如etcd和consul等后起之秀。&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id="为什么选择etcd"&gt;为什么选择etcd？&lt;/h3&gt;
&lt;ol&gt;
&lt;li&gt;简单。使用 Go 语言编写部署简单；支持HTTP/JSON API,使用简单；使用 Raft 算法保证强一致性让用户易于理解。&lt;/li&gt;
&lt;li&gt;etcd 默认数据一更新就进行持久化。&lt;/li&gt;
&lt;li&gt;etcd 支持 SSL 客户端安全认证。&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;最后，etcd 作为一个年轻的项目，正在高速迭代和开发中，这既是一个优点，也是一个缺点。优点是它的未来具有无限的可能性，缺点是无法得到大项目长时间使用的检验。然而，目前CoreOS、Kubernetes和CloudFoundry等知名项目均在生产环境中使用了etcd，所以总的来说，etcd值得你去尝试。&lt;/p&gt;</description><content:encoded><![CDATA[<p>etcd是近几年比较火热的一个开源的、分布式的键值对数据存储系统，提供共享配置、服务的注册和发现，本文主要介绍etcd的安装和使用。</p>
<h2 id="etcd介绍">etcd介绍</h2>
<p><a href="https://etcd.io/">etcd</a>是使用Go语言开发的一个开源的、高可用的分布式key-value存储系统，可以用于配置共享和服务的注册和发现。</p>
<p>类似项目有zookeeper和consul。</p>
<p>etcd具有以下特点：</p>
<ul>
<li>完全复制：集群中的每个节点都可以使用完整的存档</li>
<li>高可用性：Etcd可用于避免硬件的单点故障或网络问题</li>
<li>一致性：每次读取都会返回跨多主机的最新写入</li>
<li>简单：包括一个定义良好、面向用户的API（gRPC）</li>
<li>安全：实现了带有可选的客户端证书身份验证的自动化TLS</li>
<li>快速：每秒10000次写入的基准速度</li>
<li>可靠：使用Raft算法实现了强一致、高可用的服务存储目录</li>
</ul>
<h2 id="etcd应用场景">etcd应用场景</h2>
<h3 id="服务发现">服务发现</h3>
<p>服务发现要解决的也是分布式系统中最常见的问题之一，即在同一个分布式集群中的进程或服务，要如何才能找到对方并建立连接。本质上来说，服务发现就是想要了解集群中是否有进程在监听 udp 或 tcp 端口，并且通过名字就可以查找和连接。</p>
<h3 id="配置中心">配置中心</h3>
<p>将一些配置信息放到 etcd 上进行集中管理。</p>
<p>这类场景的使用方式通常是这样：应用在启动的时候主动从 etcd 获取一次配置信息，同时，在 etcd 节点上注册一个 Watcher 并等待，以后每次配置有更新的时候，etcd 都会实时通知订阅者，以此达到获取最新配置信息的目的。</p>
<h3 id="分布式锁">分布式锁</h3>
<p>因为 etcd 使用 Raft 算法保持了数据的强一致性，某次操作存储到集群中的值必然是全局一致的，所以很容易实现分布式锁。锁服务有两种使用方式，一是保持独占，二是控制时序。</p>
<ul>
<li><strong>保持独占即所有获取锁的用户最终只有一个可以得到</strong>。etcd 为此提供了一套实现分布式锁原子操作 CAS（CompareAndSwap）的 API。通过设置prevExist值，可以保证在多个节点同时去创建某个目录时，只有一个成功。而创建成功的用户就可以认为是获得了锁。</li>
<li>控制时序，即所有想要获得锁的用户都会被安排执行，但是<strong>获得锁的顺序也是全局唯一的，同时决定了执行顺序</strong>。etcd 为此也提供了一套 API（自动创建有序键），对一个目录建值时指定为POST动作，这样 etcd 会自动在目录下生成一个当前最大的值为键，存储这个新的值（客户端编号）。同时还可以使用 API 按顺序列出所有当前目录下的键值。此时这些键的值就是客户端的时序，而这些键中存储的值可以是代表客户端的编号。</li>
</ul>
<h2 id="为什么用-etcd-而不用zookeeper">为什么用 etcd 而不用ZooKeeper？</h2>
<p>etcd 实现的这些功能，ZooKeeper都能实现。那么为什么要用 etcd 而非直接使用ZooKeeper呢？</p>
<h3 id="为什么不选择zookeeper">为什么不选择ZooKeeper？</h3>
<ol>
<li>部署维护复杂，其使用的Paxos强一致性算法复杂难懂。官方只提供了Java和C两种语言的接口。</li>
<li>使用Java编写引入大量的依赖。运维人员维护起来比较麻烦。</li>
<li>最近几年发展缓慢，不如etcd和consul等后起之秀。</li>
</ol>
<h3 id="为什么选择etcd">为什么选择etcd？</h3>
<ol>
<li>简单。使用 Go 语言编写部署简单；支持HTTP/JSON API,使用简单；使用 Raft 算法保证强一致性让用户易于理解。</li>
<li>etcd 默认数据一更新就进行持久化。</li>
<li>etcd 支持 SSL 客户端安全认证。</li>
</ol>
<p>最后，etcd 作为一个年轻的项目，正在高速迭代和开发中，这既是一个优点，也是一个缺点。优点是它的未来具有无限的可能性，缺点是无法得到大项目长时间使用的检验。然而，目前CoreOS、Kubernetes和CloudFoundry等知名项目均在生产环境中使用了etcd，所以总的来说，etcd值得你去尝试。</p>
<h2 id="etcd集群">etcd集群</h2>
<p>etcd 作为一个高可用键值存储系统，天生就是为集群化而设计的。由于 Raft 算法在做决策时需要多数节点的投票，所以 etcd 一般部署集群推荐奇数个节点，推荐的数量为 3、5 或者 7 个节点构成一个集群。</p>
<h3 id="搭建一个3节点集群示例">搭建一个3节点集群示例：</h3>
<p>在每个etcd节点指定集群成员，为了区分不同的集群最好同时配置一个独一无二的token。</p>
<p>下面是提前定义好的集群信息，其中n1、n2和n3表示3个不同的etcd节点。</p>
<pre tabindex="0"><code>TOKEN=token-01
CLUSTER_STATE=new
CLUSTER=n1=http://10.240.0.17:2380,n2=http://10.240.0.18:2380,n3=http://10.240.0.19:2380
</code></pre><p>在n1这台机器上执行以下命令来启动etcd：</p>
<pre tabindex="0"><code>etcd --data-dir=data.etcd --name n1 \
	--initial-advertise-peer-urls http://10.240.0.17:2380 --listen-peer-urls http://10.240.0.17:2380 \
	--advertise-client-urls http://10.240.0.17:2379 --listen-client-urls http://10.240.0.17:2379 \
	--initial-cluster ${CLUSTER} \
	--initial-cluster-state ${CLUSTER_STATE} --initial-cluster-token ${TOKEN}
</code></pre><p>在n2这台机器上执行以下命令启动etcd：</p>
<pre tabindex="0"><code>etcd --data-dir=data.etcd --name n2 \
	--initial-advertise-peer-urls http://10.240.0.18:2380 --listen-peer-urls http://10.240.0.18:2380 \
	--advertise-client-urls http://10.240.0.18:2379 --listen-client-urls http://10.240.0.18:2379 \
	--initial-cluster ${CLUSTER} \
	--initial-cluster-state ${CLUSTER_STATE} --initial-cluster-token ${TOKEN}
</code></pre><p>在n3这台机器上执行以下命令启动etcd：</p>
<pre tabindex="0"><code>etcd --data-dir=data.etcd --name n3 \
	--initial-advertise-peer-urls http://10.240.0.19:2380 --listen-peer-urls http://10.240.0.19:2380 \
	--advertise-client-urls http://10.240.0.19:2379 --listen-client-urls http://10.240.0.19:2379 \
	--initial-cluster ${CLUSTER} \
	--initial-cluster-state ${CLUSTER_STATE} --initial-cluster-token ${TOKEN}
</code></pre><p>etcd 官网提供了一个可以公网访问的 etcd 存储地址。你可以通过如下命令得到 etcd 服务的目录，并把它作为-discovery参数使用。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">curl</span> <span style="color:#75af00">https</span><span style="color:#111">:</span><span style="color:#75715e">//discovery.etcd.io/new?size=3</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">https</span><span style="color:#111">:</span><span style="color:#75715e">//discovery.etcd.io/a81b5818e67a6ea83e9d4daea5ecbc92</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#75af00">grab</span> <span style="color:#75af00">this</span> <span style="color:#75af00">token</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">TOKEN</span><span style="color:#111">=</span><span style="color:#75af00">token</span><span style="color:#f92672">-</span><span style="color:#ae81ff">01</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">CLUSTER_STATE</span><span style="color:#111">=</span><span style="color:#75af00">new</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">DISCOVERY</span><span style="color:#111">=</span><span style="color:#75af00">https</span><span style="color:#111">:</span><span style="color:#75715e">//discovery.etcd.io/a81b5818e67a6ea83e9d4daea5ecbc92</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">etcd</span> <span style="color:#f92672">--</span><span style="color:#75af00">data</span><span style="color:#f92672">-</span><span style="color:#75af00">dir</span><span style="color:#111">=</span><span style="color:#75af00">data</span><span style="color:#111">.</span><span style="color:#75af00">etcd</span> <span style="color:#f92672">--</span><span style="color:#75af00">name</span> <span style="color:#75af00">n1</span> <span style="color:#960050;background-color:#1e0010">\</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">--</span><span style="color:#75af00">initial</span><span style="color:#f92672">-</span><span style="color:#75af00">advertise</span><span style="color:#f92672">-</span><span style="color:#75af00">peer</span><span style="color:#f92672">-</span><span style="color:#75af00">urls</span> <span style="color:#75af00">http</span><span style="color:#111">:</span><span style="color:#75715e">//10.240.0.17:2380 --listen-peer-urls http://10.240.0.17:2380 \</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">--</span><span style="color:#75af00">advertise</span><span style="color:#f92672">-</span><span style="color:#75af00">client</span><span style="color:#f92672">-</span><span style="color:#75af00">urls</span> <span style="color:#75af00">http</span><span style="color:#111">:</span><span style="color:#75715e">//10.240.0.17:2379 --listen-client-urls http://10.240.0.17:2379 \</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">--</span><span style="color:#75af00">discovery</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#111">{</span><span style="color:#75af00">DISCOVERY</span><span style="color:#111">}</span> <span style="color:#960050;background-color:#1e0010">\</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">--</span><span style="color:#75af00">initial</span><span style="color:#f92672">-</span><span style="color:#75af00">cluster</span><span style="color:#f92672">-</span><span style="color:#75af00">state</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#111">{</span><span style="color:#75af00">CLUSTER_STATE</span><span style="color:#111">}</span> <span style="color:#f92672">--</span><span style="color:#75af00">initial</span><span style="color:#f92672">-</span><span style="color:#75af00">cluster</span><span style="color:#f92672">-</span><span style="color:#75af00">token</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#111">{</span><span style="color:#75af00">TOKEN</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">etcd</span> <span style="color:#f92672">--</span><span style="color:#75af00">data</span><span style="color:#f92672">-</span><span style="color:#75af00">dir</span><span style="color:#111">=</span><span style="color:#75af00">data</span><span style="color:#111">.</span><span style="color:#75af00">etcd</span> <span style="color:#f92672">--</span><span style="color:#75af00">name</span> <span style="color:#75af00">n2</span> <span style="color:#960050;background-color:#1e0010">\</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">--</span><span style="color:#75af00">initial</span><span style="color:#f92672">-</span><span style="color:#75af00">advertise</span><span style="color:#f92672">-</span><span style="color:#75af00">peer</span><span style="color:#f92672">-</span><span style="color:#75af00">urls</span> <span style="color:#75af00">http</span><span style="color:#111">:</span><span style="color:#75715e">//10.240.0.18:2380 --listen-peer-urls http://10.240.0.18:2380 \</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">--</span><span style="color:#75af00">advertise</span><span style="color:#f92672">-</span><span style="color:#75af00">client</span><span style="color:#f92672">-</span><span style="color:#75af00">urls</span> <span style="color:#75af00">http</span><span style="color:#111">:</span><span style="color:#75715e">//10.240.0.18:2379 --listen-client-urls http://10.240.0.18:2379 \</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">--</span><span style="color:#75af00">discovery</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#111">{</span><span style="color:#75af00">DISCOVERY</span><span style="color:#111">}</span> <span style="color:#960050;background-color:#1e0010">\</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">--</span><span style="color:#75af00">initial</span><span style="color:#f92672">-</span><span style="color:#75af00">cluster</span><span style="color:#f92672">-</span><span style="color:#75af00">state</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#111">{</span><span style="color:#75af00">CLUSTER_STATE</span><span style="color:#111">}</span> <span style="color:#f92672">--</span><span style="color:#75af00">initial</span><span style="color:#f92672">-</span><span style="color:#75af00">cluster</span><span style="color:#f92672">-</span><span style="color:#75af00">token</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#111">{</span><span style="color:#75af00">TOKEN</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">etcd</span> <span style="color:#f92672">--</span><span style="color:#75af00">data</span><span style="color:#f92672">-</span><span style="color:#75af00">dir</span><span style="color:#111">=</span><span style="color:#75af00">data</span><span style="color:#111">.</span><span style="color:#75af00">etcd</span> <span style="color:#f92672">--</span><span style="color:#75af00">name</span> <span style="color:#75af00">n3</span> <span style="color:#960050;background-color:#1e0010">\</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">--</span><span style="color:#75af00">initial</span><span style="color:#f92672">-</span><span style="color:#75af00">advertise</span><span style="color:#f92672">-</span><span style="color:#75af00">peer</span><span style="color:#f92672">-</span><span style="color:#75af00">urls</span> <span style="color:#75af00">http</span><span style="color:#111">:</span><span style="color:#75715e">//10.240.0.19:2380 --listen-peer-urls http://10.240.0.19:2380 \</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">--</span><span style="color:#75af00">advertise</span><span style="color:#f92672">-</span><span style="color:#75af00">client</span><span style="color:#f92672">-</span><span style="color:#75af00">urls</span> <span style="color:#75af00">http</span><span style="color:#111">:</span><span style="color:#75715e">//10.240.0.19:2379 --listen-client-urls http:/10.240.0.19:2379 \</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">--</span><span style="color:#75af00">discovery</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#111">{</span><span style="color:#75af00">DISCOVERY</span><span style="color:#111">}</span> <span style="color:#960050;background-color:#1e0010">\</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">--</span><span style="color:#75af00">initial</span><span style="color:#f92672">-</span><span style="color:#75af00">cluster</span><span style="color:#f92672">-</span><span style="color:#75af00">state</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#111">{</span><span style="color:#75af00">CLUSTER_STATE</span><span style="color:#111">}</span> <span style="color:#f92672">--</span><span style="color:#75af00">initial</span><span style="color:#f92672">-</span><span style="color:#75af00">cluster</span><span style="color:#f92672">-</span><span style="color:#75af00">token</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#111">{</span><span style="color:#75af00">TOKEN</span><span style="color:#111">}</span>
</span></span></code></pre></div><p>到此etcd集群就搭建起来了，可以使用etcdctl来连接etcd。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#111">export</span> <span style="color:#111">ETCDCTL_API</span><span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span><span style="color:#111">HOST_1</span><span style="color:#f92672">=</span>10.240.0.17
</span></span><span style="display:flex;"><span><span style="color:#111">HOST_2</span><span style="color:#f92672">=</span>10.240.0.18
</span></span><span style="display:flex;"><span><span style="color:#111">HOST_3</span><span style="color:#f92672">=</span>10.240.0.19
</span></span><span style="display:flex;"><span><span style="color:#111">ENDPOINTS</span><span style="color:#f92672">=</span><span style="color:#111">$HOST_1</span>:2379,<span style="color:#111">$HOST_2</span>:2379,<span style="color:#111">$HOST_3</span>:2379
</span></span><span style="display:flex;"><span>etcdctl --endpoints<span style="color:#f92672">=</span><span style="color:#111">$ENDPOINTS</span> member list
</span></span></code></pre></div><h2 id="go语言操作etcd">Go语言操作etcd</h2>
<p>这里使用官方的<a href="https://github.com/etcd-io/etcd/tree/master/clientv3">etcd/clientv3</a>包来连接etcd并进行相关操作。</p>
<h3 id="安装">安装</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">go</span> <span style="color:#75af00">get</span> <span style="color:#00a8c8">go</span><span style="color:#111">.</span><span style="color:#75af00">etcd</span><span style="color:#111">.</span><span style="color:#75af00">io</span><span style="color:#f92672">/</span><span style="color:#75af00">etcd</span><span style="color:#f92672">/</span><span style="color:#75af00">clientv3</span>
</span></span></code></pre></div><h3 id="put和get操作">put和get操作</h3>
<p>put命令用来设置键值对数据，get命令用来根据key获取值。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;context&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;go.etcd.io/etcd/clientv3&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// etcd client put/get demo</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// use etcd/clientv3</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">cli</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">clientv3</span><span style="color:#111">.</span><span style="color:#75af00">New</span><span style="color:#111">(</span><span style="color:#75af00">clientv3</span><span style="color:#111">.</span><span style="color:#75af00">Config</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">Endpoints</span><span style="color:#111">:</span>   <span style="color:#111">[]</span><span style="color:#00a8c8">string</span><span style="color:#111">{</span><span style="color:#d88200">&#34;127.0.0.1:2379&#34;</span><span style="color:#111">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">DialTimeout</span><span style="color:#111">:</span> <span style="color:#ae81ff">5</span> <span style="color:#f92672">*</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Second</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// handle error!</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;connect to etcd failed, err:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;connect to etcd success&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">cli</span><span style="color:#111">.</span><span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// put</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">cancel</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">WithTimeout</span><span style="color:#111">(</span><span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Background</span><span style="color:#111">(),</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Second</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">cli</span><span style="color:#111">.</span><span style="color:#75af00">Put</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;q1mi&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;dsb&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">cancel</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;put to etcd failed, err:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// get</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">cancel</span> <span style="color:#111">=</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">WithTimeout</span><span style="color:#111">(</span><span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Background</span><span style="color:#111">(),</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Second</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">resp</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">cli</span><span style="color:#111">.</span><span style="color:#75af00">Get</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;q1mi&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">cancel</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;get from etcd failed, err:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">ev</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">resp</span><span style="color:#111">.</span><span style="color:#75af00">Kvs</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;%s:%s\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">ev</span><span style="color:#111">.</span><span style="color:#75af00">Key</span><span style="color:#111">,</span> <span style="color:#75af00">ev</span><span style="color:#111">.</span><span style="color:#75af00">Value</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="watch操作">watch操作</h3>
<p>watch用来获取未来更改的通知。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;context&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;go.etcd.io/etcd/clientv3&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// watch demo</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">cli</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">clientv3</span><span style="color:#111">.</span><span style="color:#75af00">New</span><span style="color:#111">(</span><span style="color:#75af00">clientv3</span><span style="color:#111">.</span><span style="color:#75af00">Config</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">Endpoints</span><span style="color:#111">:</span>   <span style="color:#111">[]</span><span style="color:#00a8c8">string</span><span style="color:#111">{</span><span style="color:#d88200">&#34;127.0.0.1:2379&#34;</span><span style="color:#111">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">DialTimeout</span><span style="color:#111">:</span> <span style="color:#ae81ff">5</span> <span style="color:#f92672">*</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Second</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;connect to etcd failed, err:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;connect to etcd success&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">cli</span><span style="color:#111">.</span><span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// watch key:q1mi change</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">rch</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">cli</span><span style="color:#111">.</span><span style="color:#75af00">Watch</span><span style="color:#111">(</span><span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Background</span><span style="color:#111">(),</span> <span style="color:#d88200">&#34;q1mi&#34;</span><span style="color:#111">)</span> <span style="color:#75715e">// &lt;-chan WatchResponse</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">wresp</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">rch</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">ev</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">wresp</span><span style="color:#111">.</span><span style="color:#75af00">Events</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Type: %s Key:%s Value:%s\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">ev</span><span style="color:#111">.</span><span style="color:#75af00">Type</span><span style="color:#111">,</span> <span style="color:#75af00">ev</span><span style="color:#111">.</span><span style="color:#75af00">Kv</span><span style="color:#111">.</span><span style="color:#75af00">Key</span><span style="color:#111">,</span> <span style="color:#75af00">ev</span><span style="color:#111">.</span><span style="color:#75af00">Kv</span><span style="color:#111">.</span><span style="color:#75af00">Value</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>将上面的代码保存编译执行，此时程序就会等待etcd中q1mi这个key的变化。</p>
<p>例如：我们打开终端执行以下命令修改、删除、设置q1mi这个key。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">etcd</span><span style="color:#111">&gt;</span> <span style="color:#75af00">etcdctl</span><span style="color:#111">.</span><span style="color:#75af00">exe</span> <span style="color:#f92672">--</span><span style="color:#75af00">endpoints</span><span style="color:#111">=</span><span style="color:#75af00">http</span><span style="color:#111">:</span><span style="color:#75715e">//127.0.0.1:2379 put q1mi &#34;dsb2&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">OK</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">etcd</span><span style="color:#111">&gt;</span> <span style="color:#75af00">etcdctl</span><span style="color:#111">.</span><span style="color:#75af00">exe</span> <span style="color:#f92672">--</span><span style="color:#75af00">endpoints</span><span style="color:#111">=</span><span style="color:#75af00">http</span><span style="color:#111">:</span><span style="color:#75715e">//127.0.0.1:2379 del q1mi</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">etcd</span><span style="color:#111">&gt;</span> <span style="color:#75af00">etcdctl</span><span style="color:#111">.</span><span style="color:#75af00">exe</span> <span style="color:#f92672">--</span><span style="color:#75af00">endpoints</span><span style="color:#111">=</span><span style="color:#75af00">http</span><span style="color:#111">:</span><span style="color:#75715e">//127.0.0.1:2379 put q1mi &#34;dsb3&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">OK</span>
</span></span></code></pre></div><p>上面的程序都能收到如下通知。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">watch</span><span style="color:#111">&gt;</span><span style="color:#75af00">watch</span><span style="color:#111">.</span><span style="color:#75af00">exe</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">connect</span> <span style="color:#75af00">to</span> <span style="color:#75af00">etcd</span> <span style="color:#75af00">success</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">Type</span><span style="color:#111">:</span> <span style="color:#75af00">PUT</span> <span style="color:#75af00">Key</span><span style="color:#111">:</span><span style="color:#75af00">q1mi</span> <span style="color:#75af00">Value</span><span style="color:#111">:</span><span style="color:#75af00">dsb2</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">Type</span><span style="color:#111">:</span> <span style="color:#75af00">DELETE</span> <span style="color:#75af00">Key</span><span style="color:#111">:</span><span style="color:#75af00">q1mi</span> <span style="color:#75af00">Value</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">Type</span><span style="color:#111">:</span> <span style="color:#75af00">PUT</span> <span style="color:#75af00">Key</span><span style="color:#111">:</span><span style="color:#75af00">q1mi</span> <span style="color:#75af00">Value</span><span style="color:#111">:</span><span style="color:#75af00">dsb3</span>
</span></span></code></pre></div><h3 id="lease租约">lease租约</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// etcd lease</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;context&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;go.etcd.io/etcd/clientv3&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">cli</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">clientv3</span><span style="color:#111">.</span><span style="color:#75af00">New</span><span style="color:#111">(</span><span style="color:#75af00">clientv3</span><span style="color:#111">.</span><span style="color:#75af00">Config</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">Endpoints</span><span style="color:#111">:</span>   <span style="color:#111">[]</span><span style="color:#00a8c8">string</span><span style="color:#111">{</span><span style="color:#d88200">&#34;127.0.0.1:2379&#34;</span><span style="color:#111">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">DialTimeout</span><span style="color:#111">:</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Second</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">5</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Fatal</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;connect to etcd success.&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">cli</span><span style="color:#111">.</span><span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 创建一个5秒的租约</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">resp</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">cli</span><span style="color:#111">.</span><span style="color:#75af00">Grant</span><span style="color:#111">(</span><span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">TODO</span><span style="color:#111">(),</span> <span style="color:#ae81ff">5</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Fatal</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 5秒钟之后, /nazha/ 这个key就会被移除</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">cli</span><span style="color:#111">.</span><span style="color:#75af00">Put</span><span style="color:#111">(</span><span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">TODO</span><span style="color:#111">(),</span> <span style="color:#d88200">&#34;/nazha/&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;dsb&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">clientv3</span><span style="color:#111">.</span><span style="color:#75af00">WithLease</span><span style="color:#111">(</span><span style="color:#75af00">resp</span><span style="color:#111">.</span><span style="color:#75af00">ID</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Fatal</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="keepalive">keepAlive</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;context&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;go.etcd.io/etcd/clientv3&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// etcd keepAlive</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">cli</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">clientv3</span><span style="color:#111">.</span><span style="color:#75af00">New</span><span style="color:#111">(</span><span style="color:#75af00">clientv3</span><span style="color:#111">.</span><span style="color:#75af00">Config</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">Endpoints</span><span style="color:#111">:</span>   <span style="color:#111">[]</span><span style="color:#00a8c8">string</span><span style="color:#111">{</span><span style="color:#d88200">&#34;127.0.0.1:2379&#34;</span><span style="color:#111">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">DialTimeout</span><span style="color:#111">:</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Second</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">5</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Fatal</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;connect to etcd success.&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">cli</span><span style="color:#111">.</span><span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">resp</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">cli</span><span style="color:#111">.</span><span style="color:#75af00">Grant</span><span style="color:#111">(</span><span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">TODO</span><span style="color:#111">(),</span> <span style="color:#ae81ff">5</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Fatal</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">cli</span><span style="color:#111">.</span><span style="color:#75af00">Put</span><span style="color:#111">(</span><span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">TODO</span><span style="color:#111">(),</span> <span style="color:#d88200">&#34;/nazha/&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;dsb&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">clientv3</span><span style="color:#111">.</span><span style="color:#75af00">WithLease</span><span style="color:#111">(</span><span style="color:#75af00">resp</span><span style="color:#111">.</span><span style="color:#75af00">ID</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Fatal</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// the key &#39;foo&#39; will be kept forever</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ch</span><span style="color:#111">,</span> <span style="color:#75af00">kaerr</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">cli</span><span style="color:#111">.</span><span style="color:#75af00">KeepAlive</span><span style="color:#111">(</span><span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">TODO</span><span style="color:#111">(),</span> <span style="color:#75af00">resp</span><span style="color:#111">.</span><span style="color:#75af00">ID</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">kaerr</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Fatal</span><span style="color:#111">(</span><span style="color:#75af00">kaerr</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">ka</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#75af00">ch</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;ttl:&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">ka</span><span style="color:#111">.</span><span style="color:#75af00">TTL</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="基于etcd实现分布式锁">基于etcd实现分布式锁</h3>
<p>go.etcd.io/etcd/clientv3/concurrency在etcd之上实现并发操作，如分布式锁、屏障和选举。</p>
<p>导入该包：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#d88200">&#34;go.etcd.io/etcd/clientv3/concurrency&#34;</span>
</span></span></code></pre></div><p>基于etcd实现的分布式锁示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">cli</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">clientv3</span><span style="color:#111">.</span><span style="color:#75af00">New</span><span style="color:#111">(</span><span style="color:#75af00">clientv3</span><span style="color:#111">.</span><span style="color:#75af00">Config</span><span style="color:#111">{</span><span style="color:#75af00">Endpoints</span><span style="color:#111">:</span> <span style="color:#75af00">endpoints</span><span style="color:#111">})</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Fatal</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">defer</span> <span style="color:#75af00">cli</span><span style="color:#111">.</span><span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 创建两个单独的会话用来演示锁竞争</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">s1</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">concurrency</span><span style="color:#111">.</span><span style="color:#75af00">NewSession</span><span style="color:#111">(</span><span style="color:#75af00">cli</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Fatal</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">defer</span> <span style="color:#75af00">s1</span><span style="color:#111">.</span><span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">m1</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">concurrency</span><span style="color:#111">.</span><span style="color:#75af00">NewMutex</span><span style="color:#111">(</span><span style="color:#75af00">s1</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;/my-lock/&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">s2</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">concurrency</span><span style="color:#111">.</span><span style="color:#75af00">NewSession</span><span style="color:#111">(</span><span style="color:#75af00">cli</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Fatal</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">defer</span> <span style="color:#75af00">s2</span><span style="color:#111">.</span><span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">m2</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">concurrency</span><span style="color:#111">.</span><span style="color:#75af00">NewMutex</span><span style="color:#111">(</span><span style="color:#75af00">s2</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;/my-lock/&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 会话s1获取锁</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">m1</span><span style="color:#111">.</span><span style="color:#75af00">Lock</span><span style="color:#111">(</span><span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">TODO</span><span style="color:#111">());</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Fatal</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;acquired lock for s1&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">m2Locked</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">chan</span> <span style="color:#00a8c8">struct</span><span style="color:#111">{})</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">go</span> <span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">defer</span> <span style="color:#111">close</span><span style="color:#111">(</span><span style="color:#75af00">m2Locked</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 等待直到会话s1释放了/my-lock/的锁</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">m2</span><span style="color:#111">.</span><span style="color:#75af00">Lock</span><span style="color:#111">(</span><span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">TODO</span><span style="color:#111">());</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Fatal</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}()</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">m1</span><span style="color:#111">.</span><span style="color:#75af00">Unlock</span><span style="color:#111">(</span><span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">TODO</span><span style="color:#111">());</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Fatal</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;released lock for s1&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;-</span><span style="color:#75af00">m2Locked</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;acquired lock for s2&#34;</span><span style="color:#111">)</span>
</span></span></code></pre></div><p>输出：</p>
<pre tabindex="0"><code>acquired lock for s1
released lock for s1
acquired lock for s2
</code></pre><p><a href="https://godoc.org/go.etcd.io/etcd/clientv3/concurrency">查看文档了解更多</a></p>
<h2 id="文章转自">文章转自</h2>
<ul>
<li><a href="https://www.liwenzhou.com/posts/Go/go_etcd/">https://www.liwenzhou.com/posts/Go/go_etcd/</a></li>
</ul>
]]></content:encoded><category>go</category><category>boltdb</category><category>etcd</category><category>golang</category><category>数据库</category><category>kubernetes</category></item><item><title>golang sqlx</title><link>https://daemon365.dev/post/go/golang_sqlx/</link><pubDate>Mon, 13 Jan 2020 00:00:00 +0800</pubDate><guid>https://daemon365.dev/post/go/golang_sqlx/</guid><description>&lt;p&gt;在项目中我们通常可能会使用&lt;code&gt;database/sql&lt;/code&gt;连接MySQL数据库。本文借助使用&lt;code&gt;sqlx&lt;/code&gt;实现批量插入数据的例子，介绍了&lt;code&gt;sqlx&lt;/code&gt;中可能被你忽视了的&lt;code&gt;sqlx.In&lt;/code&gt;和&lt;code&gt;DB.NamedExec&lt;/code&gt;方法。&lt;/p&gt;
&lt;h2 id="sqlx介绍"&gt;sqlx介绍&lt;/h2&gt;
&lt;p&gt;在项目中我们通常可能会使用&lt;code&gt;database/sql&lt;/code&gt;连接MySQL数据库。&lt;code&gt;sqlx&lt;/code&gt;可以认为是Go语言内置&lt;code&gt;database/sql&lt;/code&gt;的超集，它在优秀的内置&lt;code&gt;database/sql&lt;/code&gt;基础上提供了一组扩展。这些扩展中除了大家常用来查询的&lt;code&gt;Get(dest interface{}, ...) error&lt;/code&gt;和&lt;code&gt;Select(dest interface{}, ...) error&lt;/code&gt;外还有很多其他强大的功能。&lt;/p&gt;
&lt;h2 id="安装sqlx"&gt;安装sqlx&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;go&lt;/span&gt; &lt;span style="color:#75af00"&gt;get&lt;/span&gt; &lt;span style="color:#75af00"&gt;github&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;com&lt;/span&gt;&lt;span style="color:#f92672"&gt;/&lt;/span&gt;&lt;span style="color:#75af00"&gt;jmoiron&lt;/span&gt;&lt;span style="color:#f92672"&gt;/&lt;/span&gt;&lt;span style="color:#75af00"&gt;sqlx&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id="基本使用"&gt;基本使用&lt;/h2&gt;
&lt;h3 id="连接数据库"&gt;连接数据库&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;var&lt;/span&gt; &lt;span style="color:#75af00"&gt;db&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;sqlx&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;DB&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;initDB&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;error&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;dsn&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;user:password@tcp(127.0.0.1:3306)/sql_test?charset=utf8mb4&amp;amp;parseTime=True&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// 也可以使用MustConnect连接不成功就panic&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;db&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#75af00"&gt;sqlx&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Connect&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;mysql&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;dsn&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;!=&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Printf&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;connect DB failed, err:%v\n&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;db&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;SetMaxOpenConns&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;20&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;db&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;SetMaxIdleConns&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;10&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id="查询"&gt;查询&lt;/h3&gt;
&lt;p&gt;查询单行数据示例代码如下：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;// 查询单条数据示例&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;queryRowDemo&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;sqlStr&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;select id, name, age from user where id=?&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;var&lt;/span&gt; &lt;span style="color:#75af00"&gt;u&lt;/span&gt; &lt;span style="color:#75af00"&gt;user&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;db&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Get&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#f92672"&gt;&amp;amp;&lt;/span&gt;&lt;span style="color:#75af00"&gt;u&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;sqlStr&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;1&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;!=&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Printf&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;get failed, err:%v\n&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Printf&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;id:%d name:%s age:%d\n&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;u&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;ID&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;u&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Name&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;u&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Age&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;查询多行数据示例代码如下：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;// 查询多条数据示例&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;queryMultiRowDemo&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;sqlStr&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;select id, name, age from user where id &amp;gt; ?&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;var&lt;/span&gt; &lt;span style="color:#75af00"&gt;users&lt;/span&gt; &lt;span style="color:#111"&gt;[]&lt;/span&gt;&lt;span style="color:#75af00"&gt;user&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;db&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Select&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#f92672"&gt;&amp;amp;&lt;/span&gt;&lt;span style="color:#75af00"&gt;users&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;sqlStr&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;0&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;!=&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Printf&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;query failed, err:%v\n&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Printf&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;users:%#v\n&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;users&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id="插入更新和删除"&gt;插入、更新和删除&lt;/h3&gt;
&lt;p&gt;sqlx中的exec方法与原生sql中的exec使用基本一致：&lt;/p&gt;</description><content:encoded><![CDATA[<p>在项目中我们通常可能会使用<code>database/sql</code>连接MySQL数据库。本文借助使用<code>sqlx</code>实现批量插入数据的例子，介绍了<code>sqlx</code>中可能被你忽视了的<code>sqlx.In</code>和<code>DB.NamedExec</code>方法。</p>
<h2 id="sqlx介绍">sqlx介绍</h2>
<p>在项目中我们通常可能会使用<code>database/sql</code>连接MySQL数据库。<code>sqlx</code>可以认为是Go语言内置<code>database/sql</code>的超集，它在优秀的内置<code>database/sql</code>基础上提供了一组扩展。这些扩展中除了大家常用来查询的<code>Get(dest interface{}, ...) error</code>和<code>Select(dest interface{}, ...) error</code>外还有很多其他强大的功能。</p>
<h2 id="安装sqlx">安装sqlx</h2>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">go</span> <span style="color:#75af00">get</span> <span style="color:#75af00">github</span><span style="color:#111">.</span><span style="color:#75af00">com</span><span style="color:#f92672">/</span><span style="color:#75af00">jmoiron</span><span style="color:#f92672">/</span><span style="color:#75af00">sqlx</span>
</span></span></code></pre></div><h2 id="基本使用">基本使用</h2>
<h3 id="连接数据库">连接数据库</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">var</span> <span style="color:#75af00">db</span> <span style="color:#f92672">*</span><span style="color:#75af00">sqlx</span><span style="color:#111">.</span><span style="color:#75af00">DB</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">initDB</span><span style="color:#111">()</span> <span style="color:#111">(</span><span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">dsn</span> <span style="color:#f92672">:=</span> <span style="color:#d88200">&#34;user:password@tcp(127.0.0.1:3306)/sql_test?charset=utf8mb4&amp;parseTime=True&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 也可以使用MustConnect连接不成功就panic</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">db</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">sqlx</span><span style="color:#111">.</span><span style="color:#75af00">Connect</span><span style="color:#111">(</span><span style="color:#d88200">&#34;mysql&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">dsn</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;connect DB failed, err:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">SetMaxOpenConns</span><span style="color:#111">(</span><span style="color:#ae81ff">20</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">SetMaxIdleConns</span><span style="color:#111">(</span><span style="color:#ae81ff">10</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="查询">查询</h3>
<p>查询单行数据示例代码如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// 查询单条数据示例</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">queryRowDemo</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">sqlStr</span> <span style="color:#f92672">:=</span> <span style="color:#d88200">&#34;select id, name, age from user where id=?&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">var</span> <span style="color:#75af00">u</span> <span style="color:#75af00">user</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">Get</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">u</span><span style="color:#111">,</span> <span style="color:#75af00">sqlStr</span><span style="color:#111">,</span> <span style="color:#ae81ff">1</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;get failed, err:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;id:%d name:%s age:%d\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">u</span><span style="color:#111">.</span><span style="color:#75af00">ID</span><span style="color:#111">,</span> <span style="color:#75af00">u</span><span style="color:#111">.</span><span style="color:#75af00">Name</span><span style="color:#111">,</span> <span style="color:#75af00">u</span><span style="color:#111">.</span><span style="color:#75af00">Age</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>查询多行数据示例代码如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// 查询多条数据示例</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">queryMultiRowDemo</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">sqlStr</span> <span style="color:#f92672">:=</span> <span style="color:#d88200">&#34;select id, name, age from user where id &gt; ?&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">var</span> <span style="color:#75af00">users</span> <span style="color:#111">[]</span><span style="color:#75af00">user</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">Select</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">users</span><span style="color:#111">,</span> <span style="color:#75af00">sqlStr</span><span style="color:#111">,</span> <span style="color:#ae81ff">0</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;query failed, err:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;users:%#v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">users</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="插入更新和删除">插入、更新和删除</h3>
<p>sqlx中的exec方法与原生sql中的exec使用基本一致：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// 插入数据</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">insertRowDemo</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">sqlStr</span> <span style="color:#f92672">:=</span> <span style="color:#d88200">&#34;insert into user(name, age) values (?,?)&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ret</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">Exec</span><span style="color:#111">(</span><span style="color:#75af00">sqlStr</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;沙河小王子&#34;</span><span style="color:#111">,</span> <span style="color:#ae81ff">19</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;insert failed, err:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">theID</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">ret</span><span style="color:#111">.</span><span style="color:#75af00">LastInsertId</span><span style="color:#111">()</span> <span style="color:#75715e">// 新插入数据的id</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;get lastinsert ID failed, err:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;insert success, the id is %d.\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">theID</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 更新数据</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">updateRowDemo</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">sqlStr</span> <span style="color:#f92672">:=</span> <span style="color:#d88200">&#34;update user set age=? where id = ?&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ret</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">Exec</span><span style="color:#111">(</span><span style="color:#75af00">sqlStr</span><span style="color:#111">,</span> <span style="color:#ae81ff">39</span><span style="color:#111">,</span> <span style="color:#ae81ff">6</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;update failed, err:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">n</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">ret</span><span style="color:#111">.</span><span style="color:#75af00">RowsAffected</span><span style="color:#111">()</span> <span style="color:#75715e">// 操作影响的行数</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;get RowsAffected failed, err:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;update success, affected rows:%d\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">n</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 删除数据</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">deleteRowDemo</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">sqlStr</span> <span style="color:#f92672">:=</span> <span style="color:#d88200">&#34;delete from user where id = ?&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ret</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">Exec</span><span style="color:#111">(</span><span style="color:#75af00">sqlStr</span><span style="color:#111">,</span> <span style="color:#ae81ff">6</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;delete failed, err:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">n</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">ret</span><span style="color:#111">.</span><span style="color:#75af00">RowsAffected</span><span style="color:#111">()</span> <span style="color:#75715e">// 操作影响的行数</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;get RowsAffected failed, err:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;delete success, affected rows:%d\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">n</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="namedexec">NamedExec</h3>
<p><code>DB.NamedExec</code>方法用来绑定SQL语句与结构体或map中的同名字段。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">insertUserDemo</span><span style="color:#111">()(</span><span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span><span style="color:#111">){</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">sqlStr</span> <span style="color:#f92672">:=</span> <span style="color:#d88200">&#34;INSERT INTO user (name,age) VALUES (:name,:age)&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">NamedExec</span><span style="color:#111">(</span><span style="color:#75af00">sqlStr</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#00a8c8">string</span><span style="color:#111">]</span><span style="color:#00a8c8">interface</span><span style="color:#111">{}{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#d88200">&#34;name&#34;</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;七米&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#d88200">&#34;age&#34;</span><span style="color:#111">:</span> <span style="color:#ae81ff">28</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="namedquery">NamedQuery</h3>
<p>与<code>DB.NamedExec</code>同理，这里是支持查询。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">namedQuery</span><span style="color:#111">(){</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">sqlStr</span> <span style="color:#f92672">:=</span> <span style="color:#d88200">&#34;SELECT * FROM user WHERE name=:name&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 使用map做命名查询</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">rows</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">NamedQuery</span><span style="color:#111">(</span><span style="color:#75af00">sqlStr</span><span style="color:#111">,</span> <span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#00a8c8">string</span><span style="color:#111">]</span><span style="color:#00a8c8">interface</span><span style="color:#111">{}{</span><span style="color:#d88200">&#34;name&#34;</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;七米&#34;</span><span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;db.NamedQuery failed, err:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">rows</span><span style="color:#111">.</span><span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">rows</span><span style="color:#111">.</span><span style="color:#75af00">Next</span><span style="color:#111">(){</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">var</span> <span style="color:#75af00">u</span> <span style="color:#75af00">user</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">rows</span><span style="color:#111">.</span><span style="color:#75af00">StructScan</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">u</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;scan failed, err:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">continue</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;user:%#v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">u</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">u</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">user</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">Name</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;七米&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 使用结构体命名查询，根据结构体字段的 db tag进行映射</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">rows</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">NamedQuery</span><span style="color:#111">(</span><span style="color:#75af00">sqlStr</span><span style="color:#111">,</span> <span style="color:#75af00">u</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;db.NamedQuery failed, err:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">rows</span><span style="color:#111">.</span><span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">rows</span><span style="color:#111">.</span><span style="color:#75af00">Next</span><span style="color:#111">(){</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">var</span> <span style="color:#75af00">u</span> <span style="color:#75af00">user</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">rows</span><span style="color:#111">.</span><span style="color:#75af00">StructScan</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">u</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;scan failed, err:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">continue</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;user:%#v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">u</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="事务操作">事务操作</h3>
<p>对于事务操作，我们可以使用<code>sqlx</code>中提供的<code>db.Beginx()</code>和<code>tx.Exec()</code>方法。示例代码如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">transactionDemo2</span><span style="color:#111">()(</span><span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">tx</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">Beginx</span><span style="color:#111">()</span> <span style="color:#75715e">// 开启事务</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;begin trans failed, err:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">p</span> <span style="color:#f92672">:=</span> <span style="color:#111">recover</span><span style="color:#111">();</span> <span style="color:#75af00">p</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">Rollback</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#75af00">p</span><span style="color:#111">)</span> <span style="color:#75715e">// re-throw panic after Rollback</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;rollback&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">Rollback</span><span style="color:#111">()</span> <span style="color:#75715e">// err is non-nil; don&#39;t change it</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">Commit</span><span style="color:#111">()</span> <span style="color:#75715e">// err is nil; if Commit returns error update err</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;commit&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">sqlStr1</span> <span style="color:#f92672">:=</span> <span style="color:#d88200">&#34;Update user set age=20 where id=?&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">rs</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">Exec</span><span style="color:#111">(</span><span style="color:#75af00">sqlStr1</span><span style="color:#111">,</span> <span style="color:#ae81ff">1</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span><span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">n</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">rs</span><span style="color:#111">.</span><span style="color:#75af00">RowsAffected</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">n</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">1</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">errors</span><span style="color:#111">.</span><span style="color:#75af00">New</span><span style="color:#111">(</span><span style="color:#d88200">&#34;exec sqlStr1 failed&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">sqlStr2</span> <span style="color:#f92672">:=</span> <span style="color:#d88200">&#34;Update user set age=50 where i=?&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">rs</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">Exec</span><span style="color:#111">(</span><span style="color:#75af00">sqlStr2</span><span style="color:#111">,</span> <span style="color:#ae81ff">5</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span><span style="color:#f92672">!=</span><span style="color:#00a8c8">nil</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">n</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">rs</span><span style="color:#111">.</span><span style="color:#75af00">RowsAffected</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">n</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">1</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">errors</span><span style="color:#111">.</span><span style="color:#75af00">New</span><span style="color:#111">(</span><span style="color:#d88200">&#34;exec sqlStr1 failed&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="sqlxin">sqlx.In</h2>
<p><code>sqlx.In</code>是<code>sqlx</code>提供的一个非常方便的函数。</p>
<h3 id="sqlxin的批量插入示例">sqlx.In的批量插入示例</h3>
<h4 id="表结构">表结构</h4>
<p>为了方便演示插入数据操作，这里创建一个<code>user</code>表，表结构如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#00a8c8">CREATE</span> <span style="color:#00a8c8">TABLE</span> <span style="color:#f92672">`</span><span style="color:#00a8c8">user</span><span style="color:#f92672">`</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">`</span><span style="color:#111">id</span><span style="color:#f92672">`</span> <span style="color:#111">BIGINT</span><span style="color:#111">(</span><span style="color:#ae81ff">20</span><span style="color:#111">)</span> <span style="color:#00a8c8">NOT</span> <span style="color:#00a8c8">NULL</span> <span style="color:#111">AUTO_INCREMENT</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">`</span><span style="color:#111">name</span><span style="color:#f92672">`</span> <span style="color:#111">VARCHAR</span><span style="color:#111">(</span><span style="color:#ae81ff">20</span><span style="color:#111">)</span> <span style="color:#00a8c8">DEFAULT</span> <span style="color:#d88200">&#39;&#39;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">`</span><span style="color:#111">age</span><span style="color:#f92672">`</span> <span style="color:#111">INT</span><span style="color:#111">(</span><span style="color:#ae81ff">11</span><span style="color:#111">)</span> <span style="color:#00a8c8">DEFAULT</span> <span style="color:#d88200">&#39;0&#39;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">PRIMARY</span> <span style="color:#00a8c8">KEY</span><span style="color:#111">(</span><span style="color:#f92672">`</span><span style="color:#111">id</span><span style="color:#f92672">`</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span><span style="color:#111">ENGINE</span><span style="color:#f92672">=</span><span style="color:#111">InnoDB</span> <span style="color:#111">AUTO_INCREMENT</span><span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> <span style="color:#00a8c8">DEFAULT</span> <span style="color:#111">CHARSET</span><span style="color:#f92672">=</span><span style="color:#111">utf8mb4</span><span style="color:#111">;</span>
</span></span></code></pre></div><h4 id="结构体">结构体</h4>
<p>定义一个<code>user</code>结构体，字段通过tag与数据库中user表的列一致。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">User</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Name</span> <span style="color:#00a8c8">string</span> <span style="color:#d88200">`db:&#34;name&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Age</span>  <span style="color:#00a8c8">int</span>    <span style="color:#d88200">`db:&#34;age&#34;`</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h4 id="bindvars绑定变量">bindvars（绑定变量）</h4>
<p>查询占位符<code>?</code>在内部称为<strong>bindvars（查询占位符）</strong>,它非常重要。你应该始终使用它们向数据库发送值，因为它们可以防止SQL注入攻击。<code>database/sql</code>不尝试对查询文本进行任何验证；它与编码的参数一起按原样发送到服务器。除非驱动程序实现一个特殊的接口，否则在执行之前，查询是在服务器上准备的。因此<code>bindvars</code>是特定于数据库的:</p>
<ul>
<li>MySQL中使用<code>?</code></li>
<li>PostgreSQL使用枚举的<code>$1</code>、<code>$2</code>等bindvar语法</li>
<li>SQLite中<code>?</code>和<code>$1</code>的语法都支持</li>
<li>Oracle中使用<code>:name</code>的语法</li>
</ul>
<p><code>bindvars</code>的一个常见误解是，它们用来在sql语句中插入值。它们其实仅用于参数化，不允许更改SQL语句的结构。例如，使用<code>bindvars</code>尝试参数化列或表名将不起作用：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// ？不能用来插入表名（做SQL语句中表名的占位符）</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">Query</span><span style="color:#111">(</span><span style="color:#d88200">&#34;SELECT * FROM ?&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;mytable&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#75715e">// ？也不能用来插入列名（做SQL语句中列名的占位符）</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">Query</span><span style="color:#111">(</span><span style="color:#d88200">&#34;SELECT ?, ? FROM people&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;name&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;location&#34;</span><span style="color:#111">)</span>
</span></span></code></pre></div><h4 id="自己拼接语句实现批量插入">自己拼接语句实现批量插入</h4>
<p>比较笨，但是很好理解。就是有多少个User就拼接多少个<code>(?, ?)</code>。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// BatchInsertUsers 自行构造批量插入的语句</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">BatchInsertUsers</span><span style="color:#111">(</span><span style="color:#75af00">users</span> <span style="color:#111">[]</span><span style="color:#f92672">*</span><span style="color:#75af00">User</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 存放 (?, ?) 的slice</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">valueStrings</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">([]</span><span style="color:#00a8c8">string</span><span style="color:#111">,</span> <span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">users</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 存放values的slice</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">valueArgs</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">([]</span><span style="color:#00a8c8">interface</span><span style="color:#111">{},</span> <span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">users</span><span style="color:#111">)</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">2</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 遍历users准备相关数据</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">u</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">users</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 此处占位符要与插入值的个数对应</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">valueStrings</span> <span style="color:#111">=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">valueStrings</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;(?, ?)&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">valueArgs</span> <span style="color:#111">=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">valueArgs</span><span style="color:#111">,</span> <span style="color:#75af00">u</span><span style="color:#111">.</span><span style="color:#75af00">Name</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">valueArgs</span> <span style="color:#111">=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">valueArgs</span><span style="color:#111">,</span> <span style="color:#75af00">u</span><span style="color:#111">.</span><span style="color:#75af00">Age</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 自行拼接要执行的具体语句</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">stmt</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Sprintf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;INSERT INTO user (name, age) VALUES %s&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">strings</span><span style="color:#111">.</span><span style="color:#75af00">Join</span><span style="color:#111">(</span><span style="color:#75af00">valueStrings</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;,&#34;</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">DB</span><span style="color:#111">.</span><span style="color:#75af00">Exec</span><span style="color:#111">(</span><span style="color:#75af00">stmt</span><span style="color:#111">,</span> <span style="color:#75af00">valueArgs</span><span style="color:#f92672">...</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h4 id="使用sqlxin实现批量插入">使用sqlx.In实现批量插入</h4>
<p>前提是需要我们的结构体实现<code>driver.Valuer</code>接口：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">u</span> <span style="color:#75af00">User</span><span style="color:#111">)</span> <span style="color:#75af00">Value</span><span style="color:#111">()</span> <span style="color:#111">(</span><span style="color:#75af00">driver</span><span style="color:#111">.</span><span style="color:#75af00">Value</span><span style="color:#111">,</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#111">[]</span><span style="color:#00a8c8">interface</span><span style="color:#111">{}{</span><span style="color:#75af00">u</span><span style="color:#111">.</span><span style="color:#75af00">Name</span><span style="color:#111">,</span> <span style="color:#75af00">u</span><span style="color:#111">.</span><span style="color:#75af00">Age</span><span style="color:#111">},</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>使用<code>sqlx.In</code>实现批量插入代码如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// BatchInsertUsers2 使用sqlx.In帮我们拼接语句和参数, 注意传入的参数是[]interface{}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">BatchInsertUsers2</span><span style="color:#111">(</span><span style="color:#75af00">users</span> <span style="color:#111">[]</span><span style="color:#00a8c8">interface</span><span style="color:#111">{})</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">query</span><span style="color:#111">,</span> <span style="color:#75af00">args</span><span style="color:#111">,</span> <span style="color:#75af00">_</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">sqlx</span><span style="color:#111">.</span><span style="color:#75af00">In</span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#d88200">&#34;INSERT INTO user (name, age) VALUES (?), (?), (?)&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">users</span><span style="color:#f92672">...</span><span style="color:#111">,</span> <span style="color:#75715e">// 如果arg实现了 driver.Valuer, sqlx.In 会通过调用 Value()来展开它</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">query</span><span style="color:#111">)</span> <span style="color:#75715e">// 查看生成的querystring</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">args</span><span style="color:#111">)</span>  <span style="color:#75715e">// 查看生成的args</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">DB</span><span style="color:#111">.</span><span style="color:#75af00">Exec</span><span style="color:#111">(</span><span style="color:#75af00">query</span><span style="color:#111">,</span> <span style="color:#75af00">args</span><span style="color:#f92672">...</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h4 id="使用namedexec实现批量插入">使用NamedExec实现批量插入</h4>
<p><strong>注意</strong> ：该功能需1.3.1版本以上，并且1.3.1版本目前还有点问题，sql语句最后不能有空格和<code>;</code>，详见<a href="https://github.com/jmoiron/sqlx/issues/690">issues/690</a>。</p>
<p>使用<code>NamedExec</code>实现批量插入的代码如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// BatchInsertUsers3 使用NamedExec实现批量插入</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">BatchInsertUsers3</span><span style="color:#111">(</span><span style="color:#75af00">users</span> <span style="color:#111">[]</span><span style="color:#f92672">*</span><span style="color:#75af00">User</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">DB</span><span style="color:#111">.</span><span style="color:#75af00">NamedExec</span><span style="color:#111">(</span><span style="color:#d88200">&#34;INSERT INTO user (name, age) VALUES (:name, :age)&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">users</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>把上面三种方法综合起来试一下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">initDB</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">DB</span><span style="color:#111">.</span><span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">u1</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">User</span><span style="color:#111">{</span><span style="color:#75af00">Name</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;七米&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">Age</span><span style="color:#111">:</span> <span style="color:#ae81ff">18</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">u2</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">User</span><span style="color:#111">{</span><span style="color:#75af00">Name</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;q1mi&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">Age</span><span style="color:#111">:</span> <span style="color:#ae81ff">28</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">u3</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">User</span><span style="color:#111">{</span><span style="color:#75af00">Name</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;小王子&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">Age</span><span style="color:#111">:</span> <span style="color:#ae81ff">38</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 方法1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">users</span> <span style="color:#f92672">:=</span> <span style="color:#111">[]</span><span style="color:#f92672">*</span><span style="color:#75af00">User</span><span style="color:#111">{</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">u1</span><span style="color:#111">,</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">u2</span><span style="color:#111">,</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">u3</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">BatchInsertUsers</span><span style="color:#111">(</span><span style="color:#75af00">users</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;BatchInsertUsers failed, err:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 方法2</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">users2</span> <span style="color:#f92672">:=</span> <span style="color:#111">[]</span><span style="color:#00a8c8">interface</span><span style="color:#111">{}{</span><span style="color:#75af00">u1</span><span style="color:#111">,</span> <span style="color:#75af00">u2</span><span style="color:#111">,</span> <span style="color:#75af00">u3</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">BatchInsertUsers2</span><span style="color:#111">(</span><span style="color:#75af00">users2</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;BatchInsertUsers2 failed, err:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 方法3</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">users3</span> <span style="color:#f92672">:=</span> <span style="color:#111">[]</span><span style="color:#f92672">*</span><span style="color:#75af00">User</span><span style="color:#111">{</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">u1</span><span style="color:#111">,</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">u2</span><span style="color:#111">,</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">u3</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">BatchInsertUsers3</span><span style="color:#111">(</span><span style="color:#75af00">users3</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;BatchInsertUsers3 failed, err:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="sqlxin的查询示例">sqlx.In的查询示例</h3>
<p>关于<code>sqlx.In</code>这里再补充一个用法，在<code>sqlx</code>查询语句中实现In查询和FIND_IN_SET函数。即实现<code>SELECT * FROM user WHERE id in (3, 2, 1);</code>和<code>SELECT * FROM user WHERE id in (3, 2, 1) ORDER BY FIND_IN_SET(id, '3,2,1');</code>。</p>
<h4 id="in查询">in查询</h4>
<p>查询id在给定id集合中的数据。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// QueryByIDs 根据给定ID查询</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">QueryByIDs</span><span style="color:#111">(</span><span style="color:#75af00">ids</span> <span style="color:#111">[]</span><span style="color:#00a8c8">int</span><span style="color:#111">)(</span><span style="color:#75af00">users</span> <span style="color:#111">[]</span><span style="color:#75af00">User</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span><span style="color:#111">){</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 动态填充id</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">query</span><span style="color:#111">,</span> <span style="color:#75af00">args</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">sqlx</span><span style="color:#111">.</span><span style="color:#75af00">In</span><span style="color:#111">(</span><span style="color:#d88200">&#34;SELECT name, age FROM user WHERE id IN (?)&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">ids</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// sqlx.In 返回带 `?` bindvar的查询语句, 我们使用Rebind()重新绑定它</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">query</span> <span style="color:#111">=</span> <span style="color:#75af00">DB</span><span style="color:#111">.</span><span style="color:#75af00">Rebind</span><span style="color:#111">(</span><span style="color:#75af00">query</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">DB</span><span style="color:#111">.</span><span style="color:#75af00">Select</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">users</span><span style="color:#111">,</span> <span style="color:#75af00">query</span><span style="color:#111">,</span> <span style="color:#75af00">args</span><span style="color:#f92672">...</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h4 id="in查询和find_in_set函数">in查询和FIND_IN_SET函数</h4>
<p>查询id在给定id集合的数据并维持给定id集合的顺序。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// QueryAndOrderByIDs 按照指定id查询并维护顺序</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">QueryAndOrderByIDs</span><span style="color:#111">(</span><span style="color:#75af00">ids</span> <span style="color:#111">[]</span><span style="color:#00a8c8">int</span><span style="color:#111">)(</span><span style="color:#75af00">users</span> <span style="color:#111">[]</span><span style="color:#75af00">User</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span><span style="color:#111">){</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 动态填充id</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">strIDs</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">([]</span><span style="color:#00a8c8">string</span><span style="color:#111">,</span> <span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">ids</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">id</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">ids</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">strIDs</span> <span style="color:#111">=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">strIDs</span><span style="color:#111">,</span> <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Sprintf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;%d&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">id</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">query</span><span style="color:#111">,</span> <span style="color:#75af00">args</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">sqlx</span><span style="color:#111">.</span><span style="color:#75af00">In</span><span style="color:#111">(</span><span style="color:#d88200">&#34;SELECT name, age FROM user WHERE id IN (?) ORDER BY FIND_IN_SET(id, ?)&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">ids</span><span style="color:#111">,</span> <span style="color:#75af00">strings</span><span style="color:#111">.</span><span style="color:#75af00">Join</span><span style="color:#111">(</span><span style="color:#75af00">strIDs</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;,&#34;</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// sqlx.In 返回带 `?` bindvar的查询语句, 我们使用Rebind()重新绑定它</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">query</span> <span style="color:#111">=</span> <span style="color:#75af00">DB</span><span style="color:#111">.</span><span style="color:#75af00">Rebind</span><span style="color:#111">(</span><span style="color:#75af00">query</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">DB</span><span style="color:#111">.</span><span style="color:#75af00">Select</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">users</span><span style="color:#111">,</span> <span style="color:#75af00">query</span><span style="color:#111">,</span> <span style="color:#75af00">args</span><span style="color:#f92672">...</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>当然，在这个例子里面你也可以先使用<code>IN</code>查询，然后通过代码按给定的ids对查询结果进行排序。</p>
<h2 id="文章转自">文章转自</h2>
<ul>
<li><a href="https://www.liwenzhou.com/posts/Go/sqlx/">https://www.liwenzhou.com/posts/Go/sqlx/</a></li>
</ul>
]]></content:encoded><category>go</category><category>golang</category><category>sqlx</category></item><item><title>golang redis</title><link>https://daemon365.dev/post/go/golang_redis/</link><pubDate>Sun, 12 Jan 2020 00:00:00 +0800</pubDate><guid>https://daemon365.dev/post/go/golang_redis/</guid><description>&lt;h2 id="安装"&gt;安装&lt;/h2&gt;
&lt;p&gt;下载第三方包:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;go get -u github.com/go-redis/redis/v9
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id="连接"&gt;连接&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;// 定义一个rdis客户端&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;var&lt;/span&gt; &lt;span style="color:#75af00"&gt;redisdb&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;redis&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Client&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;// 初始化&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;initClient&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;error&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;redisdb&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#75af00"&gt;redis&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;NewClient&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#f92672"&gt;&amp;amp;&lt;/span&gt;&lt;span style="color:#75af00"&gt;redis&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Options&lt;/span&gt;&lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;Addr&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;localhost:6379&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75715e"&gt;// post端口&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;Password&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 密码&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;DB&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;0&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 使用redis的库&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;})&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;_&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#75af00"&gt;redisdb&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Ping&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;context&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Background&lt;/span&gt;&lt;span style="color:#111"&gt;()).&lt;/span&gt;&lt;span style="color:#75af00"&gt;Result&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;!=&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;连接失败&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id="使用"&gt;使用&lt;/h2&gt;
&lt;h3 id="setget示例"&gt;set/get示例&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;redisExample&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;ctx&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;context&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Background&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;redisdb&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Set&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;ctx&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;score&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;100&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;0&lt;/span&gt;&lt;span style="color:#111"&gt;).&lt;/span&gt;&lt;span style="color:#75af00"&gt;Err&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;!=&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Printf&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;set score failed, err:%v\n&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;val&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;redisdb&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Get&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;ctx&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;score&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;).&lt;/span&gt;&lt;span style="color:#75af00"&gt;Result&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;!=&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Printf&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;get score failed, err:%v\n&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;score&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;val&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;val2&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;redisdb&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Get&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;ctx&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;name&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;).&lt;/span&gt;&lt;span style="color:#75af00"&gt;Result&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;==&lt;/span&gt; &lt;span style="color:#75af00"&gt;redis&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Nil&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;name does not exist&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;else&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;!=&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Printf&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;get name failed, err:%v\n&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;else&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;name&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;val2&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id="zset示例"&gt;zset示例&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;redisExample2&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;ctx&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;context&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Background&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;zsetKey&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;language_rank&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;languages&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#111"&gt;[]&lt;/span&gt;&lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;redis&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Z&lt;/span&gt;&lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f92672"&gt;&amp;amp;&lt;/span&gt;&lt;span style="color:#75af00"&gt;redis&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Z&lt;/span&gt;&lt;span style="color:#111"&gt;{&lt;/span&gt;&lt;span style="color:#75af00"&gt;Score&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;90.0&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;Member&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;Golang&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;},&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f92672"&gt;&amp;amp;&lt;/span&gt;&lt;span style="color:#75af00"&gt;redis&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Z&lt;/span&gt;&lt;span style="color:#111"&gt;{&lt;/span&gt;&lt;span style="color:#75af00"&gt;Score&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;98.0&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;Member&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;Java&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;},&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f92672"&gt;&amp;amp;&lt;/span&gt;&lt;span style="color:#75af00"&gt;redis&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Z&lt;/span&gt;&lt;span style="color:#111"&gt;{&lt;/span&gt;&lt;span style="color:#75af00"&gt;Score&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;95.0&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;Member&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;Python&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;},&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f92672"&gt;&amp;amp;&lt;/span&gt;&lt;span style="color:#75af00"&gt;redis&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Z&lt;/span&gt;&lt;span style="color:#111"&gt;{&lt;/span&gt;&lt;span style="color:#75af00"&gt;Score&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;97.0&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;Member&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;JavaScript&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;},&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f92672"&gt;&amp;amp;&lt;/span&gt;&lt;span style="color:#75af00"&gt;redis&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Z&lt;/span&gt;&lt;span style="color:#111"&gt;{&lt;/span&gt;&lt;span style="color:#75af00"&gt;Score&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;99.0&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;Member&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;C/C++&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;},&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// ZADD&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;num&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;redisdb&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;ZAdd&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;ctx&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;zsetKey&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;languages&lt;/span&gt;&lt;span style="color:#f92672"&gt;...&lt;/span&gt;&lt;span style="color:#111"&gt;).&lt;/span&gt;&lt;span style="color:#75af00"&gt;Result&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;!=&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Printf&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;zadd failed, err:%v\n&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Printf&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;zadd %d succ.\n&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;num&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// 把Golang的分数加10&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;newScore&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;redisdb&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;ZIncrBy&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;ctx&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;zsetKey&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;10.0&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;Golang&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;).&lt;/span&gt;&lt;span style="color:#75af00"&gt;Result&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;!=&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Printf&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;zincrby failed, err:%v\n&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Printf&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;Golang&amp;#39;s score is %f now.\n&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;newScore&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// 取分数最高的3个&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;ret&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;redisdb&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;ZRevRangeWithScores&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;ctx&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;zsetKey&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;0&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;2&lt;/span&gt;&lt;span style="color:#111"&gt;).&lt;/span&gt;&lt;span style="color:#75af00"&gt;Result&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;!=&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Printf&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;zrevrange failed, err:%v\n&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;for&lt;/span&gt; &lt;span style="color:#75af00"&gt;_&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;z&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;range&lt;/span&gt; &lt;span style="color:#75af00"&gt;ret&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;z&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Member&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;z&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Score&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// 取95~100分的&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;op&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#f92672"&gt;&amp;amp;&lt;/span&gt;&lt;span style="color:#75af00"&gt;redis&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;ZRangeBy&lt;/span&gt;&lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;Min&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;95&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;Max&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;100&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;ret&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#75af00"&gt;redisdb&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;ZRangeByScoreWithScores&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;ctx&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;zsetKey&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;op&lt;/span&gt;&lt;span style="color:#111"&gt;).&lt;/span&gt;&lt;span style="color:#75af00"&gt;Result&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;!=&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Printf&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;zrangebyscore failed, err:%v\n&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;for&lt;/span&gt; &lt;span style="color:#75af00"&gt;_&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;z&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;range&lt;/span&gt; &lt;span style="color:#75af00"&gt;ret&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;z&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Member&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;z&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Score&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;输出结果如下：&lt;/p&gt;</description><content:encoded><![CDATA[<h2 id="安装">安装</h2>
<p>下载第三方包:</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>go get -u github.com/go-redis/redis/v9
</span></span></code></pre></div><h2 id="连接">连接</h2>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// 定义一个rdis客户端</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">var</span> <span style="color:#75af00">redisdb</span> <span style="color:#f92672">*</span><span style="color:#75af00">redis</span><span style="color:#111">.</span><span style="color:#75af00">Client</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 初始化</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">initClient</span><span style="color:#111">()</span> <span style="color:#111">(</span><span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">redisdb</span> <span style="color:#111">=</span> <span style="color:#75af00">redis</span><span style="color:#111">.</span><span style="color:#75af00">NewClient</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">redis</span><span style="color:#111">.</span><span style="color:#75af00">Options</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">Addr</span><span style="color:#111">:</span>     <span style="color:#d88200">&#34;localhost:6379&#34;</span><span style="color:#111">,</span> <span style="color:#75715e">// post端口</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">Password</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;&#34;</span><span style="color:#111">,</span> <span style="color:#75715e">// 密码</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">DB</span><span style="color:#111">:</span>       <span style="color:#ae81ff">0</span><span style="color:#111">,</span>  <span style="color:#75715e">// 使用redis的库</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">redisdb</span><span style="color:#111">.</span><span style="color:#75af00">Ping</span><span style="color:#111">(</span><span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Background</span><span style="color:#111">()).</span><span style="color:#75af00">Result</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;连接失败&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="使用">使用</h2>
<h3 id="setget示例">set/get示例</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">redisExample</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ctx</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Background</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">redisdb</span><span style="color:#111">.</span><span style="color:#75af00">Set</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;score&#34;</span><span style="color:#111">,</span> <span style="color:#ae81ff">100</span><span style="color:#111">,</span> <span style="color:#ae81ff">0</span><span style="color:#111">).</span><span style="color:#75af00">Err</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;set score failed, err:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">val</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">redisdb</span><span style="color:#111">.</span><span style="color:#75af00">Get</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;score&#34;</span><span style="color:#111">).</span><span style="color:#75af00">Result</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;get score failed, err:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;score&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">val</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">val2</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">redisdb</span><span style="color:#111">.</span><span style="color:#75af00">Get</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;name&#34;</span><span style="color:#111">).</span><span style="color:#75af00">Result</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">==</span> <span style="color:#75af00">redis</span><span style="color:#111">.</span><span style="color:#75af00">Nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;name does not exist&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;get name failed, err:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;name&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">val2</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="zset示例">zset示例</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">redisExample2</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ctx</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Background</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">zsetKey</span> <span style="color:#f92672">:=</span> <span style="color:#d88200">&#34;language_rank&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">languages</span> <span style="color:#f92672">:=</span> <span style="color:#111">[]</span><span style="color:#f92672">*</span><span style="color:#75af00">redis</span><span style="color:#111">.</span><span style="color:#75af00">Z</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">&amp;</span><span style="color:#75af00">redis</span><span style="color:#111">.</span><span style="color:#75af00">Z</span><span style="color:#111">{</span><span style="color:#75af00">Score</span><span style="color:#111">:</span> <span style="color:#ae81ff">90.0</span><span style="color:#111">,</span> <span style="color:#75af00">Member</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;Golang&#34;</span><span style="color:#111">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">&amp;</span><span style="color:#75af00">redis</span><span style="color:#111">.</span><span style="color:#75af00">Z</span><span style="color:#111">{</span><span style="color:#75af00">Score</span><span style="color:#111">:</span> <span style="color:#ae81ff">98.0</span><span style="color:#111">,</span> <span style="color:#75af00">Member</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;Java&#34;</span><span style="color:#111">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">&amp;</span><span style="color:#75af00">redis</span><span style="color:#111">.</span><span style="color:#75af00">Z</span><span style="color:#111">{</span><span style="color:#75af00">Score</span><span style="color:#111">:</span> <span style="color:#ae81ff">95.0</span><span style="color:#111">,</span> <span style="color:#75af00">Member</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;Python&#34;</span><span style="color:#111">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">&amp;</span><span style="color:#75af00">redis</span><span style="color:#111">.</span><span style="color:#75af00">Z</span><span style="color:#111">{</span><span style="color:#75af00">Score</span><span style="color:#111">:</span> <span style="color:#ae81ff">97.0</span><span style="color:#111">,</span> <span style="color:#75af00">Member</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;JavaScript&#34;</span><span style="color:#111">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">&amp;</span><span style="color:#75af00">redis</span><span style="color:#111">.</span><span style="color:#75af00">Z</span><span style="color:#111">{</span><span style="color:#75af00">Score</span><span style="color:#111">:</span> <span style="color:#ae81ff">99.0</span><span style="color:#111">,</span> <span style="color:#75af00">Member</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;C/C++&#34;</span><span style="color:#111">},</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ZADD</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">num</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">redisdb</span><span style="color:#111">.</span><span style="color:#75af00">ZAdd</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">zsetKey</span><span style="color:#111">,</span> <span style="color:#75af00">languages</span><span style="color:#f92672">...</span><span style="color:#111">).</span><span style="color:#75af00">Result</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;zadd failed, err:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;zadd %d succ.\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">num</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 把Golang的分数加10</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">newScore</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">redisdb</span><span style="color:#111">.</span><span style="color:#75af00">ZIncrBy</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">zsetKey</span><span style="color:#111">,</span> <span style="color:#ae81ff">10.0</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Golang&#34;</span><span style="color:#111">).</span><span style="color:#75af00">Result</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;zincrby failed, err:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Golang&#39;s score is %f now.\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">newScore</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 取分数最高的3个</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ret</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">redisdb</span><span style="color:#111">.</span><span style="color:#75af00">ZRevRangeWithScores</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">zsetKey</span><span style="color:#111">,</span> <span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#ae81ff">2</span><span style="color:#111">).</span><span style="color:#75af00">Result</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;zrevrange failed, err:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">z</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">ret</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">z</span><span style="color:#111">.</span><span style="color:#75af00">Member</span><span style="color:#111">,</span> <span style="color:#75af00">z</span><span style="color:#111">.</span><span style="color:#75af00">Score</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 取95~100分的</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">op</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">redis</span><span style="color:#111">.</span><span style="color:#75af00">ZRangeBy</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">Min</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;95&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">Max</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;100&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ret</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">redisdb</span><span style="color:#111">.</span><span style="color:#75af00">ZRangeByScoreWithScores</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">zsetKey</span><span style="color:#111">,</span> <span style="color:#75af00">op</span><span style="color:#111">).</span><span style="color:#75af00">Result</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;zrangebyscore failed, err:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">z</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">ret</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">z</span><span style="color:#111">.</span><span style="color:#75af00">Member</span><span style="color:#111">,</span> <span style="color:#75af00">z</span><span style="color:#111">.</span><span style="color:#75af00">Score</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>输出结果如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ ./06redis_demo 
</span></span><span style="display:flex;"><span>zadd <span style="color:#ae81ff">0</span> succ.
</span></span><span style="display:flex;"><span>Golang<span style="color:#960050;background-color:#1e0010">&#39;</span>s score is 100.000000 now.
</span></span><span style="display:flex;"><span>Golang <span style="color:#ae81ff">100</span>
</span></span><span style="display:flex;"><span>C/C++ <span style="color:#ae81ff">99</span>
</span></span><span style="display:flex;"><span>Java <span style="color:#ae81ff">98</span>
</span></span><span style="display:flex;"><span>JavaScript <span style="color:#ae81ff">97</span>
</span></span><span style="display:flex;"><span>Java <span style="color:#ae81ff">98</span>
</span></span><span style="display:flex;"><span>C/C++ <span style="color:#ae81ff">99</span>
</span></span><span style="display:flex;"><span>Golang <span style="color:#ae81ff">100</span>
</span></span></code></pre></div>]]></content:encoded><category>go</category><category>golang</category><category>redis</category></item></channel></rss>