<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/"><channel><title>Grpc on Daemon365</title><link>https://daemon365.dev/tags/grpc/</link><description>Don't let yourself stop.</description><generator>Hugo -- gohugo.io</generator><language>zh-cn</language><lastBuildDate>Sun, 25 Dec 2022 00:00:00 +0800</lastBuildDate><atom:link href="https://daemon365.dev/tags/grpc/index.xml" rel="self" type="application/rss+xml"/><item><title>隔离</title><link>https://daemon365.dev/post/microservice/isolation/</link><pubDate>Sun, 25 Dec 2022 00:00:00 +0800</pubDate><guid>https://daemon365.dev/post/microservice/isolation/</guid><description>&lt;h2 id="什么是隔离"&gt;什么是隔离？&lt;/h2&gt;
&lt;p&gt;隔离，本质上是对系统或资源进行分割，从而实现当系统发生故障时能限定传播范围和影响范围，即发生故障后只有出问题的服务不可用，保证其他服务仍然可用。&lt;/p&gt;
&lt;p&gt;&lt;img src="https://daemon365.dev/images/bc26357f-7699-40e1-b00e-4ca4996b5e85.png" alt=""&gt;&lt;/p&gt;
&lt;h2 id="服务隔离"&gt;服务隔离&lt;/h2&gt;
&lt;h2 id="动静隔离"&gt;动静隔离&lt;/h2&gt;
&lt;p&gt;例如 CDN&lt;/p&gt;
&lt;p&gt;小到 CPU 的 cacheline false sharing、数据库 mysql 表设计中避免 bufferpool 频繁过期，隔离动静表，大到架构设计中的图片、静态资源等缓存加速。本质上都体现的一样的思路，即加速/缓存访问变换频次小的。比如 CDN 场景中，将静态资源和动态 API 分离，也是体现了隔离的思路:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;降低应用服务器负载，静态文件访问负载全部通过CDN。&lt;/li&gt;
&lt;li&gt;对象存储存储费用最低。&lt;/li&gt;
&lt;li&gt;海量存储空间，无需考虑存储架构升级。&lt;/li&gt;
&lt;li&gt;静态CDN带宽加速，延迟低。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img src="https://daemon365.dev/images/583bfe49-86ce-4e4b-b7b1-fef33a6a9ae8.png" alt=""&gt;&lt;/p&gt;
&lt;p&gt;archive: 稿件表，存储稿件的名称、作者、分类、tag、状态等信息，表示稿件的基本信息。 在一个投稿流程中，一旦稿件创建改动的频率比较低。 archive_stat: 稿件统计表，表示稿件的播放、点赞、收藏、投币数量，比较高频的更新。 随着稿件获取流量，稿件被用户所消费，各类计数信息更新比较频繁。 MySQL BufferPool 是用于缓存 DataPage 的，DataPage 可以理解为缓存了表的行，那么如果频繁更新 DataPage 不断会置换，会导致命中率下降的问题，所以我们在表设计中，仍然可以沿用类似的思路，其主表基本更新，在上游 Cache 未命中，透穿到 MySQL，仍然有 BufferPool 的缓存。&lt;/p&gt;
&lt;h3 id="读写隔离"&gt;读写隔离&lt;/h3&gt;
&lt;p&gt;例如主从，除此之外还有常见的 CQRS 模式，分库分表等&lt;/p&gt;
&lt;p&gt;常见的隔离技术，当用于读取操作的服务器出现故障时，写服务器照常可以运作，反之也一样。&lt;/p&gt;
&lt;h2 id="轻重隔离"&gt;轻重隔离&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;核心隔离：例如上面讲到将核心业务独立部署，非核心业务共享资源&lt;/li&gt;
&lt;li&gt;热点隔离：例如上面讲到的 remote cache 到 local cache&lt;/li&gt;
&lt;li&gt;用户隔离：不同的用户可能有不同的级别，例如上面讲到的外部用户和管理员&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="物理隔离"&gt;物理隔离&lt;/h2&gt;
&lt;h3 id="线程"&gt;线程&lt;/h3&gt;
&lt;p&gt;常见的例子就是线程池，这个在 Golang 中一般不用过多考虑，runtime 已经帮我们管理好了&lt;/p&gt;
&lt;p&gt;主要通过线程池进行隔离，也是实现服务隔离的基础。（可将图中隔离媒介换成线程池即可）&lt;/p&gt;
&lt;p&gt;把业务进行分类并交给不同的线程池进行处理，当某个线程池处理一种业务请求发生问题时，不会讲故障扩散和影响到其他线程池，保证服务可用。&lt;/p&gt;
&lt;p&gt;假设系统存在商品服务、用户服务和订单服务3个微服务，通过设置运行时环境得到3个服务一共使用200个线程，客户端调用这3个微服务共享线程池时可能会引发服务雪崩，将线程分别隔离后则不会触发整体雪崩。&lt;/p&gt;
&lt;p&gt;&lt;img src="https://daemon365.dev/images/76ca5d29-3442-44ce-a408-98d5f89de10b.png" alt=""&gt;&lt;/p&gt;
&lt;h3 id="进程"&gt;进程&lt;/h3&gt;
&lt;p&gt;我们现在一般使用容器化服务，跑在 k8s 上这就是一种进程级别的隔离&lt;/p&gt;</description><content:encoded><![CDATA[<h2 id="什么是隔离">什么是隔离？</h2>
<p>隔离，本质上是对系统或资源进行分割，从而实现当系统发生故障时能限定传播范围和影响范围，即发生故障后只有出问题的服务不可用，保证其他服务仍然可用。</p>
<p><img src="/images/bc26357f-7699-40e1-b00e-4ca4996b5e85.png" alt=""></p>
<h2 id="服务隔离">服务隔离</h2>
<h2 id="动静隔离">动静隔离</h2>
<p>例如 CDN</p>
<p>小到 CPU 的 cacheline false sharing、数据库 mysql 表设计中避免 bufferpool 频繁过期，隔离动静表，大到架构设计中的图片、静态资源等缓存加速。本质上都体现的一样的思路，即加速/缓存访问变换频次小的。比如 CDN 场景中，将静态资源和动态 API 分离，也是体现了隔离的思路:</p>
<ul>
<li>降低应用服务器负载，静态文件访问负载全部通过CDN。</li>
<li>对象存储存储费用最低。</li>
<li>海量存储空间，无需考虑存储架构升级。</li>
<li>静态CDN带宽加速，延迟低。</li>
</ul>
<p><img src="/images/583bfe49-86ce-4e4b-b7b1-fef33a6a9ae8.png" alt=""></p>
<p>archive: 稿件表，存储稿件的名称、作者、分类、tag、状态等信息，表示稿件的基本信息。 在一个投稿流程中，一旦稿件创建改动的频率比较低。 archive_stat: 稿件统计表，表示稿件的播放、点赞、收藏、投币数量，比较高频的更新。 随着稿件获取流量，稿件被用户所消费，各类计数信息更新比较频繁。 MySQL BufferPool 是用于缓存 DataPage 的，DataPage 可以理解为缓存了表的行，那么如果频繁更新 DataPage 不断会置换，会导致命中率下降的问题，所以我们在表设计中，仍然可以沿用类似的思路，其主表基本更新，在上游 Cache 未命中，透穿到 MySQL，仍然有 BufferPool 的缓存。</p>
<h3 id="读写隔离">读写隔离</h3>
<p>例如主从，除此之外还有常见的 CQRS 模式，分库分表等</p>
<p>常见的隔离技术，当用于读取操作的服务器出现故障时，写服务器照常可以运作，反之也一样。</p>
<h2 id="轻重隔离">轻重隔离</h2>
<ul>
<li>核心隔离：例如上面讲到将核心业务独立部署，非核心业务共享资源</li>
<li>热点隔离：例如上面讲到的 remote cache 到 local cache</li>
<li>用户隔离：不同的用户可能有不同的级别，例如上面讲到的外部用户和管理员</li>
</ul>
<h2 id="物理隔离">物理隔离</h2>
<h3 id="线程">线程</h3>
<p>常见的例子就是线程池，这个在 Golang 中一般不用过多考虑，runtime 已经帮我们管理好了</p>
<p>主要通过线程池进行隔离，也是实现服务隔离的基础。（可将图中隔离媒介换成线程池即可）</p>
<p>把业务进行分类并交给不同的线程池进行处理，当某个线程池处理一种业务请求发生问题时，不会讲故障扩散和影响到其他线程池，保证服务可用。</p>
<p>假设系统存在商品服务、用户服务和订单服务3个微服务，通过设置运行时环境得到3个服务一共使用200个线程，客户端调用这3个微服务共享线程池时可能会引发服务雪崩，将线程分别隔离后则不会触发整体雪崩。</p>
<p><img src="/images/76ca5d29-3442-44ce-a408-98d5f89de10b.png" alt=""></p>
<h3 id="进程">进程</h3>
<p>我们现在一般使用容器化服务，跑在 k8s 上这就是一种进程级别的隔离</p>
<p>将系统拆分为多个子系统来实现物理隔离，各个子系统运行在独立的容器和JVM中，通过进程隔离使得一个子系统出现问题不会影响其他子系统。</p>
<h3 id="机房">机房</h3>
<p>我们目前在 K8s 的基础上做一些开发，常见的一种做法就是将我们的服务的不同副本尽量的分配在不同的可用区，实际上就是云厂商的不同机房，避免机房停电或者着火之类的影响</p>
<p>如果有条件，对于大型高可用系统，会进行多机房部署，每个机房的服务都有自己的服务分组，本机房的服务应该只调用同机房服务。</p>
<p>当一个机房出现故障，将请求快速切换到其他机房确保服务继续可用。</p>
<h3 id="集群">集群</h3>
<p>非常重要的服务我们可以部署多套，在物理上进行隔离，常见的有异地部署，也可能就部署在同一个区域</p>
<p>将某些服务单独部署成集群，或对于某些服务可以进行分组集群管理，某一个集群出现问题之后就不会影响到其他集群，从而实现隔离。</p>
<p><img src="/images/adca81f8-c0a6-4ce2-9db3-025e103763d1.png" alt=""></p>
<h2 id="参考文章">参考文章</h2>
<ul>
<li><a href="https://blog.csdn.net/xiaofeng10330111/article/details/86772740">https://blog.csdn.net/xiaofeng10330111/article/details/86772740</a></li>
<li><a href="https://lailin.xyz/post/go-training-week6-usability-1-bulkhe.html">https://lailin.xyz/post/go-training-week6-usability-1-bulkhe.html</a></li>
</ul>
]]></content:encoded><category>microservice</category><category>go</category><category>grpc</category></item><item><title>限流</title><link>https://daemon365.dev/post/microservice/current_limitation/</link><pubDate>Sat, 24 Dec 2022 00:00:00 +0800</pubDate><guid>https://daemon365.dev/post/microservice/current_limitation/</guid><description>&lt;h2 id="令牌桶算法"&gt;令牌桶算法&lt;/h2&gt;
&lt;p&gt;是一个存放固定容量令牌的桶，按照固定速率往桶里添加令牌。令牌桶算法的描述如下：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;假设限制2r/s，则按照500毫秒的固定速率往桶中添加令牌。&lt;/li&gt;
&lt;li&gt;桶中最多存放 b 个令牌，当桶满时，新添加的令牌被丢弃或拒绝。&lt;/li&gt;
&lt;li&gt;当一个 n 个字节大小的数据包到达，将从桶中删除n 个令牌，接着数据包被发送到网络上。&lt;/li&gt;
&lt;li&gt;如果桶中的令牌不足 n 个，则不会删除令牌，且该数据包将被限流（要么丢弃，要么缓冲区等待）。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;令牌桶速率限制算法: &lt;code&gt;golang.org/x/time/rate&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src="https://daemon365.dev/images/51a3b153-ddc8-4d86-93e4-5610b49bcf96.png" alt=""&gt;&lt;/p&gt;
&lt;h2 id="漏桶算法"&gt;漏桶算法&lt;/h2&gt;
&lt;p&gt;作为计量工具(The Leaky Bucket Algorithm as a Meter)时，可以用于流量整形(Traffic Shaping)和流量控制(TrafficPolicing)，漏桶算法的描述如下：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;一个固定容量的漏桶，按照常量固定速率流出水滴。&lt;/li&gt;
&lt;li&gt;如果桶是空的，则不需流出水滴。&lt;/li&gt;
&lt;li&gt;可以以任意速率流入水滴到漏桶。&lt;/li&gt;
&lt;li&gt;如果流入水滴超出了桶的容量，则流入的水滴溢出了（被丢弃），而漏桶容量是不变的。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;漏桶率限制算法: go.uber.org/ratelimit&lt;/p&gt;
&lt;p&gt;&lt;img src="https://daemon365.dev/images/3359127c-5aa1-42e5-bb12-c1f59880c50f.png" alt=""&gt;&lt;/p&gt;
&lt;h2 id="过载保护"&gt;过载保护&lt;/h2&gt;
&lt;h3 id="令牌桶与漏桶的缺点"&gt;令牌桶与漏桶的缺点&lt;/h3&gt;
&lt;p&gt;漏斗桶/令牌桶确实能够保护系统不被拖垮, 但不管漏斗桶还是令牌桶, 其防护思路都是设定一个指标, 当超过该指标后就阻止或减少流量的继续进入，当系统负载降低到某一水平后则恢复流量的进入。但其通常都是被动的，其实际效果取决于限流阈值设置是否合理，但往往设置合理不是一件容易的事情。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;集群增加机器或者减少机器限流阈值是否要重新设置?&lt;/li&gt;
&lt;li&gt;设置限流阈值的依据是什么?&lt;/li&gt;
&lt;li&gt;人力运维成本是否过高?&lt;/li&gt;
&lt;li&gt;当调用方反馈429时, 这个时候重新设置限流, 其实流量高峰已经过了重新评估限流是否有意义?&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;这些其实都是采用漏斗桶/令牌桶的缺点, 总体来说就是太被动, 不能快速适应流量变化。
因此我们需要一种自适应的限流算法，即: 过载保护，根据系统当前的负载自动丢弃流量。&lt;/p&gt;
&lt;h3 id="过载保护方法"&gt;过载保护方法&lt;/h3&gt;
&lt;p&gt;计算系统临近过载时的峰值吞吐作为限流的阈值来进行流量控制，达到系统保护。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;服务器临近过载时，主动抛弃一定量的负载，目标是自保。&lt;/li&gt;
&lt;li&gt;在系统稳定的前提下，保持系统的吞吐量。&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id="利特尔法则"&gt;利特尔法则&lt;/h3&gt;
&lt;p&gt;&lt;strong&gt;计算吞吐量：利特尔法则 L = λ * W&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;利特尔法则由麻省理工大学斯隆商学院（MIT Sloan School of Management）的教授 John Little﹐于 1961 年所提出与证明。它是一个有关提前期与在制品关系的简单数学公式，这一法则为精益生产的改善方向指明了道路。 —- &lt;a href="https://wiki.mbalib.com/wiki/%E5%88%A9%E7%89%B9%E5%B0%94%E6%B3%95%E5%88%99"&gt;MBA 智库百科 (mbalib.com)&lt;/a&gt;&lt;/p&gt;</description><content:encoded><![CDATA[<h2 id="令牌桶算法">令牌桶算法</h2>
<p>是一个存放固定容量令牌的桶，按照固定速率往桶里添加令牌。令牌桶算法的描述如下：</p>
<ul>
<li>假设限制2r/s，则按照500毫秒的固定速率往桶中添加令牌。</li>
<li>桶中最多存放 b 个令牌，当桶满时，新添加的令牌被丢弃或拒绝。</li>
<li>当一个 n 个字节大小的数据包到达，将从桶中删除n 个令牌，接着数据包被发送到网络上。</li>
<li>如果桶中的令牌不足 n 个，则不会删除令牌，且该数据包将被限流（要么丢弃，要么缓冲区等待）。</li>
</ul>
<p>令牌桶速率限制算法: <code>golang.org/x/time/rate</code></p>
<p><img src="/images/51a3b153-ddc8-4d86-93e4-5610b49bcf96.png" alt=""></p>
<h2 id="漏桶算法">漏桶算法</h2>
<p>作为计量工具(The Leaky Bucket Algorithm as a Meter)时，可以用于流量整形(Traffic Shaping)和流量控制(TrafficPolicing)，漏桶算法的描述如下：</p>
<ul>
<li>一个固定容量的漏桶，按照常量固定速率流出水滴。</li>
<li>如果桶是空的，则不需流出水滴。</li>
<li>可以以任意速率流入水滴到漏桶。</li>
<li>如果流入水滴超出了桶的容量，则流入的水滴溢出了（被丢弃），而漏桶容量是不变的。</li>
</ul>
<p>漏桶率限制算法: go.uber.org/ratelimit</p>
<p><img src="/images/3359127c-5aa1-42e5-bb12-c1f59880c50f.png" alt=""></p>
<h2 id="过载保护">过载保护</h2>
<h3 id="令牌桶与漏桶的缺点">令牌桶与漏桶的缺点</h3>
<p>漏斗桶/令牌桶确实能够保护系统不被拖垮, 但不管漏斗桶还是令牌桶, 其防护思路都是设定一个指标, 当超过该指标后就阻止或减少流量的继续进入，当系统负载降低到某一水平后则恢复流量的进入。但其通常都是被动的，其实际效果取决于限流阈值设置是否合理，但往往设置合理不是一件容易的事情。</p>
<ul>
<li>集群增加机器或者减少机器限流阈值是否要重新设置?</li>
<li>设置限流阈值的依据是什么?</li>
<li>人力运维成本是否过高?</li>
<li>当调用方反馈429时, 这个时候重新设置限流, 其实流量高峰已经过了重新评估限流是否有意义?</li>
</ul>
<p>这些其实都是采用漏斗桶/令牌桶的缺点, 总体来说就是太被动, 不能快速适应流量变化。
因此我们需要一种自适应的限流算法，即: 过载保护，根据系统当前的负载自动丢弃流量。</p>
<h3 id="过载保护方法">过载保护方法</h3>
<p>计算系统临近过载时的峰值吞吐作为限流的阈值来进行流量控制，达到系统保护。</p>
<ul>
<li>服务器临近过载时，主动抛弃一定量的负载，目标是自保。</li>
<li>在系统稳定的前提下，保持系统的吞吐量。</li>
</ul>
<h3 id="利特尔法则">利特尔法则</h3>
<p><strong>计算吞吐量：利特尔法则 L = λ * W</strong></p>
<p>利特尔法则由麻省理工大学斯隆商学院（MIT Sloan School of Management）的教授 John Little﹐于 1961 年所提出与证明。它是一个有关提前期与在制品关系的简单数学公式，这一法则为精益生产的改善方向指明了道路。 —- <a href="https://wiki.mbalib.com/wiki/%E5%88%A9%E7%89%B9%E5%B0%94%E6%B3%95%E5%88%99">MBA 智库百科 (mbalib.com)</a></p>
<p><img src="/images/90d947b6-d2a4-4179-968e-fab77cca6f69.png" alt=""></p>
<p><img src="/images/f0f01256-91b8-4874-b0db-5e8b375e1e46.png" alt=""></p>
<p>如上图所示，如果我们开一个小店，平均每分钟进店 2 个客人(λ)，每位客人从等待到完成交易需要 4 分钟(W)，那我们店里能承载的客人数量就是 2 * 4 = 8 个人</p>
<p>同理，我们可以将 <code>λ</code> 当做 QPS， <code>W</code> 呢是每个请求需要花费的时间，那我们的系统的吞吐就是 <code>L = λ * W</code> ，所以我们可以使用利特尔法则来计算系统的吞吐量。</p>
<h4 id="什么时候系统的吞吐量就是最大的吞吐量">什么时候系统的吞吐量就是最大的吞吐量？</h4>
<p>首先我们可以通过统计过去一段时间的数据，获取到平均每秒的请求量，也就是 QPS，以及请求的耗时时间，为了避免出现前面 900ms 一个请求都没有最后 100ms 请求特别多的情况，我们可以使用滑动窗口算法来进行统计。</p>
<p>最容易想到的就是我们从系统启动开始，就把这些值给保存下来，然后计算一个吞吐的最大值，用这个来表示我们的最大吞吐量就可以了。但是这样存在一个问题是，我们很多系统其实都不是独占一台机器的，一个物理机上面往往有很多服务，并且一般还存在一些超卖，所以可能第一个小时最大处理能力是 100，但是这台节点上其他服务实例同时都在抢占资源的时候，这个处理能力最多就只能到 80 了</p>
<p>所以我们需要一个数据来做启发阈值，只要这个指标达到了阈值那我们就进入流控当中。常见的选择一般是 CPU、Memory、System Load，这里我们以 CPU 为例</p>
<p>只要我们的 CPU 负载超过 80% 的时候，获取过去 5s 的最大吞吐数据，然后再统计当前系统中的请求数量，只要当前系统中的请求数大于最大吞吐那么我们就丢弃这个请求。</p>
<p>如何计算接近峰值时的系统吞吐？</p>
<ul>
<li>CPU: 使用一个独立的线程采样，每隔 250ms 触发一次。在计算均值时，使用了简单滑动平均去除峰值的影响。</li>
<li>Inflight: 当前服务中正在进行的请求的数量。</li>
<li>Pass&amp;RT: 最近5s，pass 为每100ms采样窗口内成功请求的数量，rt 为单个采样窗口中平均响应时间。</li>
</ul>
<p><img src="/images/6dbc84ba-a083-4c70-b5f6-f0abe8149f03.png" alt=""></p>
<p><img src="/images/4408995c-1d9d-4a95-be14-be8feb329dce.png" alt=""></p>
<ul>
<li>我们使用 CPU 的滑动均值(CPU &gt; 800)作为启发阈值，一旦触发进入到过载保护阶段，算法为：(pass* rt) &lt; inflight</li>
<li>限流效果生效后，CPU 会在临界值(800)附近抖动，如果不使用冷却时间，那么一个短时间的 CPU 下降就可能导致大量请求被放行，严重时会打满 CPU。</li>
<li>在冷却时间后，重新判断阈值(CPU &gt; 800 )，是否持续进入过载保护。</li>
</ul>
<p><img src="/images/0567b758-0a00-4ff5-9a8c-901e38d242f5.png" alt=""></p>
<h2 id="什么是限流">什么是限流</h2>
<p>限流是指在一段时间内，定义某个客户或应用可以接收或处理多少个请求的技术。例如，通过限流，你可以过滤掉产生流量峰值的客户和微服务，或者可以确保你的应用程序在自动扩展(Auto Scaling)失效前都不会出现过载的情况。</p>
<ul>
<li>令牌桶、漏桶 针对单个节点，无法分布式限流。</li>
<li>QPS 限流
<ul>
<li>不同的请求可能需要数量迥异的资源来处理。</li>
<li>某种静态 QPS 限流不是特别准。</li>
</ul>
</li>
<li><strong>给每个用户设置限制</strong>
<ul>
<li>全局过载发生时候，针对某些“异常”进行控制。</li>
<li>一定程度的“超卖”配额。</li>
</ul>
</li>
<li>按照优先级丢弃。</li>
<li>拒绝请求也需要成本。</li>
</ul>
<p><img src="/images/cd9b2488-c5fb-47c4-b40a-4d6d8819c692.png" alt=""></p>
<h2 id="分布式限流">分布式限流</h2>
<p>分布式限流，是为了控制某个应用全局的流量，而非真对单个节点纬度。</p>
<ul>
<li>单个大流量的接口，使用 redis 容易产生热点。</li>
<li>pre-request 模式对性能有一定影响，高频的网络往返。</li>
</ul>
<p>思考：</p>
<ul>
<li>从获取单个 quota 升级成批量 quota。quota: 表示速率，获取后使用令牌桶算法来限制。</li>
</ul>
<p><img src="/images/84f00d9e-14d6-4791-9240-b95f2d60159b.png" alt=""></p>
<ul>
<li>每次心跳后，异步批量获取 quota，可以大大减少请求 redis 的频次，获取完以后本地消费，基于令牌桶拦截。</li>
<li>每次申请的配额需要手动设定静态值略欠灵活，比如每次要20，还是50。</li>
</ul>
<p>如何基于单个节点按需申请，并且避免出现不公平的现象？
初次使用默认值，一旦有过去历史窗口的数据，可以基于历史窗口数据进行 quota 请求。
思考：</p>
<ul>
<li>我们经常面临给一组用户划分稀有资源的问题，他们都享有等价的权利来获取资源，但是其中一些用户实际上只需要比其他用户少的资源。</li>
</ul>
<p><img src="/images/c18c4e61-f29e-41fc-aba7-d254a1e20be7.png" alt=""></p>
<p>那么我们如何来分配资源呢？一种在实际中广泛使用的分享技术称作“最大最小公平分享”(Max-Min Fairness)。
直观上，公平分享分配给每个用户想要的可以满足的最小需求，然后将没有使用的资源均匀的分配给需要‘大资源’的用户。
最大最小公平分配算法的形式化定义如下：</p>
<ul>
<li>资源按照需求递增的顺序进行分配。</li>
<li>不存在用户得到的资源超过自己的需求。</li>
<li>未得到满足的用户等价的分享资源。</li>
</ul>
<p><img src="/images/bc3758b8-71b6-4298-9b43-a988c25f808e.png" alt=""></p>
<p><img src="/images/2f213e58-59a8-48d9-9def-8f1b6d30230c.png" alt=""></p>
<h2 id="限流的重要性">限流的重要性</h2>
<p>每个接口配置阈值，运营工作繁重，最简单的我们配置服务级别 quota，更细粒度的，我们可以根据不同重要性设定 quota，我们引入了重要性(criticality):</p>
<ul>
<li>最重要 CRITICAL_PLUS，为最终的要求预留的类型，拒绝这些请求会造成非常严重的用户可见的问题。</li>
<li>重要 CRITICAL，生产任务发出的默认请求类型。拒绝这些请求也会造成用户可见的问题。但是可能没那么严重。</li>
<li>可丢弃的 SHEDDABLE_PLUS 这些流量可以容忍某种程度的不可用性。这是批量任务发出的请求的默认值。这些请求通常可以过几分钟、几小时后重试。</li>
<li>可丢弃的 SHEDDABLE 这些流量可能会经常遇到部分不可用情况，偶尔会完全不可用。</li>
</ul>
<p>gRPC 系统之间，需要自动传递重要性信息。如果后端接受到请求 A，在处理过程中发出了请求 B 和 C 给其他后端，请求 B 和 C 会使用与 A 相同的重要性属性。</p>
<ul>
<li>全局配额不足时，优先拒绝低优先级的。</li>
<li>全局配额，可以按照重要性分别设置。</li>
<li>过载保护时，低优先级的请求先被拒绝。</li>
</ul>
<h2 id="熔断">熔断</h2>
<p>断路器(Circuit Breakers): 为了限制操作的持续时间，我们可以使用超时，超时可以防止挂起操作并保证系统可以响应。因为我们处于高度动态的环境中，几乎不可能确定在每种情况下都能正常工作的准确的时间限制。断路器以现实世界的电子元件命名，因为它们的行为是都是相同的。断路器在分布式系统中非常有用，因为重复的故障可能会导致雪球效应，并使整个系统崩溃。</p>
<ul>
<li><strong>服务依赖的资源出现大量错误。</strong></li>
<li><strong>某个用户超过资源配额时，后端任务会快速拒绝请求，返回“配额不足”的错误，但是拒绝回复仍然会消耗一定资源。有可能后端忙着不停发送拒绝请求，导致过载。</strong></li>
</ul>
<p><img src="/images/bb7a5dcf-2c93-484a-9d81-58cd9fc37564.png" alt=""></p>
<p>如上图所示，熔断器存在三个状态:</p>
<ol>
<li><strong>关闭(closed)</strong>: 关闭状态下没有触发断路保护，所有的请求都正常通行</li>
<li><strong>打开(open)</strong>: 当错误阈值触发之后，就进入开启状态，这个时候所有的流量都会被节流，不运行通行</li>
<li><strong>半打开(half-open)</strong>: 处于打开状态一段时间之后，会尝试尝试放行一个流量来探测当前 server 端是否可以接收新流量，如果这个没有问题就会进入关闭状态，如果有问题又会回到打开状态</li>
</ol>
<h3 id="google-sre-过载保护算法">Google SRE 过载保护算法</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#111">max</span><span style="color:#111">(</span><span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#111">(</span><span style="color:#75af00">requests</span> <span style="color:#f92672">-</span> <span style="color:#75af00">K</span><span style="color:#f92672">*</span><span style="color:#75af00">accepts</span><span style="color:#111">)</span> <span style="color:#f92672">/</span> <span style="color:#111">(</span><span style="color:#75af00">requests</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span><span style="color:#111">))</span>
</span></span></code></pre></div><p>算法如上所示，这个公式计算的是请求被丢弃的概率[<a href="https://lailin.xyz/post/go-training-week6-6-breaker.html#fn:3">3]</a></p>
<ul>
<li>requests: 一段时间的请求数量</li>
<li>accepts: 成功的请求数量</li>
<li>K: 倍率，K 越小表示越激进，越小表示越容易被丢弃请求</li>
</ul>
<p>这个算法的好处是不会直接一刀切的丢弃所有请求，而是计算出一个概率来进行判断，当成功的请求数量越少，K越小的时候 requests−K∗accepts 的值就越大，计算出的概率也就越大，表示这个请求被丢弃的概率越大</p>
<p><img src="/images/0fb2f1dd-bde2-4ea0-a684-32c6432b0170.png" alt=""></p>
<h2 id="gutter">Gutter</h2>
<p>基于熔断的 gutter kafka ，用于接管自动修复系统运行过程中的负载，这样只需要付出10%的资源就能解决部分系统可用性问题。
我们经常使用 failover 的思路，但是完整的 failover 需要翻倍的机器资源，平常不接受流量时，资源浪费。高负载情况下接管流量又不一定完整能接住。所以这里核心利用熔断的思路，是把抛弃的流量转移到 gutter 集群，如果 gutter 也接受不住的流量，重新回抛到主集群，最大力度来接受。</p>
<p><img src="/images/e4c6bd90-f754-4511-a3dd-b1bf7534b541.png" alt=""></p>
<h2 id="客户端流控">客户端流控</h2>
<p>positive feedback: 用户总是积极重试，访问一个不可达的服务。</p>
<ul>
<li>客户端需要限制请求频次，retry backoff 做一定的请求退让。</li>
<li>可以通过接口级别的error_details，挂载到每个 API 返回的响应里。</li>
</ul>
<p><img src="/images/c77189a6-f8f5-4fd9-b831-a32ef231ad4d.png" alt=""></p>
<p><img src="/images/325019ac-8b8e-4615-abbd-9050afe79c65.png" alt=""></p>
<p><img src="/images/c42b5eb8-1c45-485b-8c33-92c9bd7009e1.png" alt=""></p>
<h2 id="参考文章">参考文章</h2>
<ul>
<li><a href="https://blog.csdn.net/m__l__/article/details/109175787">https://blog.csdn.net/m__l__/article/details/109175787</a></li>
<li><a href="https://lailin.xyz/post/go-training-week6-4-auto-limiter.html">https://lailin.xyz/post/go-training-week6-4-auto-limiter.html</a></li>
<li><a href="https://lailin.xyz/post/go-training-week6-6-breaker.html">https://lailin.xyz/post/go-training-week6-6-breaker.html</a></li>
</ul>
]]></content:encoded><category>microservice</category><category>grpc</category><category>go</category></item><item><title>超时控制</title><link>https://daemon365.dev/post/microservice/timeout_control/</link><pubDate>Fri, 23 Dec 2022 00:00:00 +0800</pubDate><guid>https://daemon365.dev/post/microservice/timeout_control/</guid><description>&lt;h2 id="什么是超时控制"&gt;什么是超时控制？&lt;/h2&gt;
&lt;p&gt;超时控制，使我们的服务之间调用可以快速抛错。比如API接口设置1s超时API调用A服务用了500ms，服务A调用和服务B用了600ms，n那么现在已经超时，还要调用服务C等等，再返回超时错误吗？这回事使服务C后面的链路做了无用功，浪费服务器资源。&lt;/p&gt;
&lt;p&gt;&lt;img src="https://daemon365.dev/images/44cc09fe-c961-4cb6-af02-ea19c60f44c3.png" alt=""&gt;&lt;/p&gt;
&lt;h2 id="grpc的截止时间"&gt;GRPC的截止时间&lt;/h2&gt;
&lt;p&gt;截止时间以请求开始的绝对时间来表示（即使 API 将它们表示为持续时间偏移），并且应 用于多个服务调用。发起请求的应用程序设置截止时间，整个请求链需要在截止时间之前 进行响应。 gRPC API 支持为 RPC 使用截止时间，出于多种原因，在 gRPC 应用程序中使 用截止时间始终是一种最佳实践。由于 gRPC 通信是在网络上发生的，因此在 RPC 和响应 之间会有延迟。另外，在一些特定的场景中， gRPC 服务本身可能要花费更多的时间来响 应，这取决于服务的业务逻辑。如果客户端应用程序在开发时没有指定截止时间，那么它 们会无限期地等待自己所发起的 RPC 请求的响应，而资源都会被正在处理的请求所占用。 这会让服务和客户端都面临资源耗尽的风险，增加服务的延迟，甚至可能导致整个 gRPC 服务崩溃。&lt;/p&gt;
&lt;p&gt;客户端应用程序的截止时间设置为 50 毫秒（截止时间 = 当前时间 + 偏移量）。客户端和 ProductMgt 服务之间的网络延迟为 0 毫秒， ProductMgt 服务的处理延迟为 20 毫秒。 商 品管理服务（ ProductMgt 服务）必须将截止时间的偏移量设置为 30 毫秒。 因为库存服 务（ Inventory 服务）需要 30 毫秒来响应， 所以截止时间的事件会在两个客户端上发生 （ ProductMgt 调用 Inventory 服务和客户端应用程序）。&lt;/p&gt;
&lt;p&gt;ProductMgt 服务的业务逻辑将延迟时间增加了 20 毫秒。 随后， ProductMgt 服务的调用逻 辑触发了超出截止时间的场景，并且传播回客户端应用程序。因此，在使用截止时间时， 要明确它们适用于所有服务场景。&lt;/p&gt;</description><content:encoded><![CDATA[<h2 id="什么是超时控制">什么是超时控制？</h2>
<p>超时控制，使我们的服务之间调用可以快速抛错。比如API接口设置1s超时API调用A服务用了500ms，服务A调用和服务B用了600ms，n那么现在已经超时，还要调用服务C等等，再返回超时错误吗？这回事使服务C后面的链路做了无用功，浪费服务器资源。</p>
<p><img src="/images/44cc09fe-c961-4cb6-af02-ea19c60f44c3.png" alt=""></p>
<h2 id="grpc的截止时间">GRPC的截止时间</h2>
<p>截止时间以请求开始的绝对时间来表示（即使 API 将它们表示为持续时间偏移），并且应 用于多个服务调用。发起请求的应用程序设置截止时间，整个请求链需要在截止时间之前 进行响应。 gRPC API 支持为 RPC 使用截止时间，出于多种原因，在 gRPC 应用程序中使 用截止时间始终是一种最佳实践。由于 gRPC 通信是在网络上发生的，因此在 RPC 和响应 之间会有延迟。另外，在一些特定的场景中， gRPC 服务本身可能要花费更多的时间来响 应，这取决于服务的业务逻辑。如果客户端应用程序在开发时没有指定截止时间，那么它 们会无限期地等待自己所发起的 RPC 请求的响应，而资源都会被正在处理的请求所占用。 这会让服务和客户端都面临资源耗尽的风险，增加服务的延迟，甚至可能导致整个 gRPC 服务崩溃。</p>
<p>客户端应用程序的截止时间设置为 50 毫秒（截止时间 = 当前时间 + 偏移量）。客户端和 ProductMgt 服务之间的网络延迟为 0 毫秒， ProductMgt 服务的处理延迟为 20 毫秒。 商 品管理服务（ ProductMgt 服务）必须将截止时间的偏移量设置为 30 毫秒。 因为库存服 务（ Inventory 服务）需要 30 毫秒来响应， 所以截止时间的事件会在两个客户端上发生 （ ProductMgt 调用 Inventory 服务和客户端应用程序）。</p>
<p>ProductMgt 服务的业务逻辑将延迟时间增加了 20 毫秒。 随后， ProductMgt 服务的调用逻 辑触发了超出截止时间的场景，并且传播回客户端应用程序。因此，在使用截止时间时， 要明确它们适用于所有服务场景。</p>
<p><img src="/images/29faba9a-1bc6-41bc-a376-5868f2bb82b9.png" alt=""></p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">conn</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">grpc</span><span style="color:#111">.</span><span style="color:#75af00">Dial</span><span style="color:#111">(</span><span style="color:#75af00">address</span><span style="color:#111">,</span> <span style="color:#75af00">grpc</span><span style="color:#111">.</span><span style="color:#75af00">WithInsecure</span><span style="color:#111">())</span> 
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Fatalf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;did not connect: %v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span> 
</span></span><span style="display:flex;"><span><span style="color:#111">}</span> 
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">defer</span> <span style="color:#75af00">conn</span><span style="color:#111">.</span><span style="color:#75af00">Close</span><span style="color:#111">()</span> 
</span></span><span style="display:flex;"><span><span style="color:#75af00">client</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">pb</span><span style="color:#111">.</span><span style="color:#75af00">NewOrderManagementClient</span><span style="color:#111">(</span><span style="color:#75af00">conn</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">clientDeadline</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Now</span><span style="color:#111">().</span><span style="color:#75af00">Add</span><span style="color:#111">(</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Duration</span><span style="color:#111">(</span><span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Second</span><span style="color:#111">))</span> 
</span></span><span style="display:flex;"><span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">cancel</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">WithDeadline</span><span style="color:#111">(</span><span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Background</span><span style="color:#111">(),</span> <span style="color:#75af00">clientDeadline</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">defer</span> <span style="color:#75af00">cancel</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 调用方法传入ctx</span>
</span></span></code></pre></div>]]></content:encoded><category>microservice</category><category>grpc</category><category>go</category></item><item><title>grpc服务发现与负载均衡</title><link>https://daemon365.dev/post/microservice/grpc_service_discovery_and_load_balancing/</link><pubDate>Sun, 20 Dec 2020 00:00:00 +0800</pubDate><guid>https://daemon365.dev/post/microservice/grpc_service_discovery_and_load_balancing/</guid><description>&lt;h2 id="前言"&gt;前言&lt;/h2&gt;
&lt;p&gt;   在后台服务开发中，高可用性是构建中核心且重要的一环。服务发现（Service discovery）和负载均衡（Load Balance）一直都是我关注的话题。今天来谈一下我在实际中是如何理解及落地的。&lt;/p&gt;
&lt;h2 id="负载均衡--服务发现"&gt;负载均衡 &amp;amp;&amp;amp; 服务发现&lt;/h2&gt;
&lt;h4 id="基础"&gt;基础&lt;/h4&gt;
&lt;p&gt;   负载均衡 ，顾名思义，是通过某种手段将流量 / 请求分配到不通的服务器上去，保证后台的每个服务收到的请求都尽可能保持平衡
   服务发现 ，就是指客户端按照某种约定的方式主动去（注册中心）寻找服务，然后再连接相应的服务
   关于负载均衡的构建与实现，可以看下这几篇文章：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="https://segmentfault.com/a/1190000008672912"&gt;gRPC 服务发现 &amp;amp; 负载均衡&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://grpc.io/blog/loadbalancing/"&gt;gRPC Load Balancing&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/grpc/grpc/blob/master/doc/load-balancing.md"&gt;Load Balancing in gRPC&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id="服务发现概念"&gt;服务发现概念&lt;/h4&gt;
&lt;p&gt;   我们说的服务发现，一般理解为客户端如何发现 (并连接到) 服务，这里一般包含三个组件：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;服务消费者：一般指客户端（可以是简单的 TCP-Client 或者是 RPC-Client ）&lt;/li&gt;
&lt;li&gt;服务提供者：一般指服务提供方，如传统服务，微服务等&lt;/li&gt;
&lt;li&gt;服务注册中心：用来存储（Key-Value）服务提供者的服务，一般以 DNS/HTTP/RPC 等方式对外暴露接口&lt;/li&gt;
&lt;/ol&gt;
&lt;h4 id="负载均衡概念"&gt;负载均衡概念&lt;/h4&gt;
&lt;p&gt;我们把 LB 看作一个组件，根据组件位置的不同，大致上分为三种：&lt;/p&gt;
&lt;h4 id="集中式-lbproxy-model"&gt;集中式 LB（Proxy Model）&lt;/h4&gt;
&lt;p&gt;   独立的 LB, 可以是硬件实现，如 F5，或者是 nginx 这种内置 Proxy-pass 或者 upstream 功能的网关，亦或是 LVS/HAPROXY，之前也使用 &lt;a href="http://core.dpdk.org/doc/quick-start/"&gt;DPDK&lt;/a&gt; 开发过类似的专用网关。&lt;/p&gt;
&lt;p&gt;&lt;img src="https://daemon365.dev/images/600380fe-75ab-44af-9615-c41dd981f499.png" alt=""&gt;&lt;/p&gt;
&lt;h4 id="进程内-lbbalancing-aware-client"&gt;进程内 LB（Balancing-aware Client）&lt;/h4&gt;
&lt;p&gt;   进程内 LB（集成到客户端），此方案将 LB 的功能集成到服务消费方进程里，也被称为软负载或者客户端负载方案。服务提供方启动时，首先将服务地址注册到服务注册表，同时定期报心跳到服务注册表以表明服务的存活状态，相当于健康检查，服务消费方要访问某个服务时，它通过内置的 LB 组件向服务注册表查询，同时缓存并定期刷新目标服务地址列表，然后以某种负载均衡策略选择一个目标服务地址，最后向目标服务发起请求。LB 和服务发现能力被分散到每一个服务消费者的进程内部，同时服务消费方和服务提供方之间是直接调用，没有额外开销，性能比较好。&lt;/p&gt;
&lt;p&gt;&lt;img src="https://daemon365.dev/images/484f3293-3b5e-4606-ade5-7b69ac18f7fb.png" alt=""&gt;&lt;/p&gt;</description><content:encoded><![CDATA[<h2 id="前言">前言</h2>
<p>   在后台服务开发中，高可用性是构建中核心且重要的一环。服务发现（Service discovery）和负载均衡（Load Balance）一直都是我关注的话题。今天来谈一下我在实际中是如何理解及落地的。</p>
<h2 id="负载均衡--服务发现">负载均衡 &amp;&amp; 服务发现</h2>
<h4 id="基础">基础</h4>
<p>   负载均衡 ，顾名思义，是通过某种手段将流量 / 请求分配到不通的服务器上去，保证后台的每个服务收到的请求都尽可能保持平衡
   服务发现 ，就是指客户端按照某种约定的方式主动去（注册中心）寻找服务，然后再连接相应的服务
   关于负载均衡的构建与实现，可以看下这几篇文章：</p>
<ul>
<li><a href="https://segmentfault.com/a/1190000008672912">gRPC 服务发现 &amp; 负载均衡</a></li>
<li><a href="https://grpc.io/blog/loadbalancing/">gRPC Load Balancing</a></li>
<li><a href="https://github.com/grpc/grpc/blob/master/doc/load-balancing.md">Load Balancing in gRPC</a></li>
</ul>
<h4 id="服务发现概念">服务发现概念</h4>
<p>   我们说的服务发现，一般理解为客户端如何发现 (并连接到) 服务，这里一般包含三个组件：</p>
<ol>
<li>服务消费者：一般指客户端（可以是简单的 TCP-Client 或者是 RPC-Client ）</li>
<li>服务提供者：一般指服务提供方，如传统服务，微服务等</li>
<li>服务注册中心：用来存储（Key-Value）服务提供者的服务，一般以 DNS/HTTP/RPC 等方式对外暴露接口</li>
</ol>
<h4 id="负载均衡概念">负载均衡概念</h4>
<p>我们把 LB 看作一个组件，根据组件位置的不同，大致上分为三种：</p>
<h4 id="集中式-lbproxy-model">集中式 LB（Proxy Model）</h4>
<p>   独立的 LB, 可以是硬件实现，如 F5，或者是 nginx 这种内置 Proxy-pass 或者 upstream 功能的网关，亦或是 LVS/HAPROXY，之前也使用 <a href="http://core.dpdk.org/doc/quick-start/">DPDK</a> 开发过类似的专用网关。</p>
<p><img src="/images/600380fe-75ab-44af-9615-c41dd981f499.png" alt=""></p>
<h4 id="进程内-lbbalancing-aware-client">进程内 LB（Balancing-aware Client）</h4>
<p>   进程内 LB（集成到客户端），此方案将 LB 的功能集成到服务消费方进程里，也被称为软负载或者客户端负载方案。服务提供方启动时，首先将服务地址注册到服务注册表，同时定期报心跳到服务注册表以表明服务的存活状态，相当于健康检查，服务消费方要访问某个服务时，它通过内置的 LB 组件向服务注册表查询，同时缓存并定期刷新目标服务地址列表，然后以某种负载均衡策略选择一个目标服务地址，最后向目标服务发起请求。LB 和服务发现能力被分散到每一个服务消费者的进程内部，同时服务消费方和服务提供方之间是直接调用，没有额外开销，性能比较好。</p>
<p><img src="/images/484f3293-3b5e-4606-ade5-7b69ac18f7fb.png" alt=""></p>
<h4 id="独立-lb-进程external-load-balancing-service">独立 LB 进程（External Load Balancing Service）</h4>
<p>   该方案是针对上一种方案的不足而提出的一种折中方案，原理和第二种方案基本类似。不同之处是将 LB 和服务发现功能从进程内移出来，变成主机上的一个独立进程。主机上的一个或者多个服务要访问目标服务时，他们都通过同一主机上的独立 LB 进程做服务发现和负载均衡。该方案也是一种分布式方案没有单点问题，一个 LB 进程挂了只影响该主机上的服务调用方，服务调用方和 LB 之间是进程内调用性能好，同时该方案还简化了服务调用方，不需要为不同语言开发客户库，LB 的升级不需要服务调用方改代码。 公司的 L5 是这种方式，每台机器上都安装了 L5 的 agent，供其他服务调用。该方案主要问题：部署较复杂，环节多，出错调试排查问题不方便。</p>
<p><img src="/images/be553bb2-7a9a-4539-93db-02cd4a2d1ee2.png" alt=""></p>
<h3 id="grpc-内置的方案">gRPC 内置的方案</h3>
<p>  gRPC 的内置方案如下图所示：</p>
<p><img src="/images/4bc0b344-b882-415c-9972-75ad14e35d51.png" alt=""></p>
<p>gRPC 在官网文档中提供了实现 LB 的思路，并在不同语言的 gRPC 代码 API 中已提供了命名解析和负载均衡接口供扩展。默认提供了 DNS-resolver 的实现，接口相当规范，实现起来也不复杂，只需要实现服务注册（Registry）和服务监听 + 解析（Watcher+Resolver）的逻辑就行了，这里简单介绍其基本实现过程：</p>
<ol>
<li>构建注册中心，这里注册中心一般要求具备分布式一致性（满足 CAP 定理的 AP 或 CP）的高可用的组件集群，如 Zookeeper、Consul、Etcd 等</li>
<li>构建 gRPC 服务端的注册逻辑，服务启动后定时向注册中心注册自身的关键信息（一般开启新的 groutine 来完成），至少包含 IP 和端口，其他可选信息，如自身的负载信息（CPU 和 Memory）、当前实时连接数等，这些辅助信息有助于帮助系统更好的执行 LB 算法</li>
<li>gRPC 客户端向注册中心发出服务解析请求，注册中心将请求中关联的所有服务的信息返回给 gRPC 客户端，客户端与所有在线的服务建立起 HTTP2 长连接</li>
<li>gRPC 客户端发起 RPC 调用，根据 LB 均衡器中实现的负载均衡策略（gRPC 中默认提供的算法是 RoundRobin），选择其中一 HTTP2 长连接进行通信，即 LB 策略决定哪个子通道 - 即哪个 gRPC 服务器将接收请求</li>
</ol>
<h2 id="grpc-负载均衡的运行机制">gRPC 负载均衡的运行机制</h2>
<p>gRPC 提供了负载均衡实现的用户侧接口，我们可以非常方便的定制化业务的负载均衡策略，为了理解 gRPC 的负载均衡的实现机制，后续博客中我会分析下 <code>gRPC</code> 实现负载均衡的代码。</p>
<p><img src="/images/c0b8b2f7-eee6-4a7b-8785-331d276a19fd.png" alt=""></p>
<ol>
<li>Resolver
<ul>
<li>解析器，用于从注册中心实时获取当前服务端的列表，同步发送给 Balancer</li>
</ul>
</li>
<li>Balancer
<ul>
<li>平衡器，一是接收从 Resolver 发送的服务端列表，建立并维护（长）连接状态；二是每次当 Client 发起 Rpc 调用时，按照一定算法从连接池中选择一个连接进行 Rpc 调用</li>
</ul>
</li>
<li>Register
<ul>
<li>注册，用于服务端初始化和在线时，将自己信息上报到注册中心，主要信息有 Ip，端口等</li>
</ul>
</li>
</ol>
<h2 id="负载均衡的算法及实现">负载均衡的算法及实现</h2>
<p>在实践中，如何选取负载均衡策略是一个很有趣的话题，例如 Nginx 的 <code>upstream</code> 机制中就有很多经典的 LB 策略，如带权重的轮询 <a href="https://github.com/nginx/nginx/blob/master/src/http/ngx_http_upstream_round_robin.c">Weight-RoundRobin</a>，一般常用的负载均衡方法有如下几种：</p>
<ol>
<li>RoundRobin（轮询）</li>
<li>Weight-RoundRobin（加权轮询）
<ul>
<li>不同的后端服务器可能机器的配置和当前系统的负载并不相同，因此它们的抗压能力也不相同。给配置高、负载低的机器配置更高的权重，而配置低、负载高的机器，给其分配较低的权重，降低其系统负载，加权轮询能很好地处理这一问题，并将请求顺序且按照权重分配到后端。</li>
</ul>
</li>
<li>Random（随机）</li>
<li>Weight-Random（加权随机）
<ul>
<li>通过系统的随机算法，根据后端服务器的列表随机选取其中的一台服务器进行访问</li>
</ul>
</li>
<li>源地址哈希法
<ul>
<li>源地址哈希的思想是根据获取客户端的 IP 地址，通过哈希函数计算得到的一个数值，用该数值对服务器列表的大小进行取模运算，得到的结果便是客服端要访问服务器的序号。采用源地址哈希法进行负载均衡，同一 IP 地址的客户端，当后端服务器列表不变时，它每次都会映射到同一台后端服务器进行访问</li>
</ul>
</li>
<li>最小连接数法
<ul>
<li>最小连接数算法比较灵活和智能，由于后端服务器的配置不尽相同，对于请求的处理有快有慢，它是根据后端服务器当前的连接情况，动态地选取其中当前积压连接数最少的一台服务器来处理当前的请求，尽可能地提高后端服务的利用效率，将负责合理地分流到每一台服务器</li>
</ul>
</li>
<li>一致性哈希算法
<ul>
<li>常见的是 <code>Ketama</code> 算法，该算法是用来解决 <code>cache</code> 失效导致的缓存穿透的问题的，当然也可以适用于 gRPC 长连接的场景</li>
</ul>
</li>
</ol>
<h2 id="grpc-服务治理的优势">gRPC 服务治理的优势</h2>
<p>   在现网环境中，后端服务就是采用了 gRPC 与 Etcd 的服务治理方案，总结下有这么几个优点；</p>
<ul>
<li>采用了 gRPC 实现负载均衡策略，模块之间通信采用长连接方式，避免每次 RPC 调用时新建连接的开销，充分发挥 <code>HTTP2</code> 的优势</li>
<li>扩容和缩容都及其方便，例如扩容，只要部署上服务，运行后，服务成功注册到 Etcd 便大功告成</li>
<li>灵活的自定义的 LB 算法，使得后端压力更为均衡</li>
<li>客户端加入重试逻辑，使得网络抖动情况下，可以通过重试连接上另外一台服务</li>
</ul>
<h2 id="resolver-暴露的三个接口">Resolver 暴露的三个接口</h2>
<p>前文说过，gRPC 内置的服务治理功能，对开发者暴露了服务发现的 <code>interface{}</code>，<code>resolver.Builder</code> 和 <code>resolver.ClientConn</code> 和 <code>resolver.Resolver</code>，<a href="https://github.com/grpc/grpc-go/blob/master/resolver/resolver.go">相关代码</a>。开发者在实例化这三个接口之后，就可以实现从指定的 scheme 中获取服务列表，通知 balancer 并与这些服务端建立 RPC 长连接。</p>
<ol>
<li>resolver.Builder</li>
<li>resolver.ClientConn</li>
<li>resolver.Resolver</li>
</ol>
<ul>
<li>resolver.Builder <code>Builder</code> 用于 gRPC 内部创建 <code>Resolver</code> 接口的实现，但注意内部声明的 <code>Build()</code> 方法将接口 <code>ClientConn</code> 作为参数传入了，在前文的分析中，我们了解到 <code>ClientConn</code><a href="https://github.com/grpc/grpc-go/blob/master/clientconn.go#L459">结库</a> 是非常重要的结构，其成员 <code>conns map[*addrConn]struct{}</code> 中维护了所有从注册中心获取到的服务端列表。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// Builder creates a resolver that will be used to watch name resolution updates.</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Builder</span> <span style="color:#00a8c8">interface</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Build creates a new resolver for the given target.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// gRPC dial calls Build synchronously, and fails if the returned error is</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// not nil.</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">Build</span><span style="color:#111">(</span><span style="color:#75af00">target</span> <span style="color:#75af00">Target</span><span style="color:#111">,</span> <span style="color:#75af00">cc</span> <span style="color:#75af00">ClientConn</span><span style="color:#111">,</span> <span style="color:#75af00">opts</span> <span style="color:#75af00">BuildOption</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#75af00">Resolver</span><span style="color:#111">,</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Scheme returns the scheme supported by this resolver.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Scheme is defined at https://github.com/grpc/grpc/blob/master/doc/naming.md.</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">Scheme</span><span style="color:#111">()</span> <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><ul>
<li><a href="https://github.com/grpc/grpc-go/blob/master/clientconn.go#L459">resolver.ClientConn</a> <code>ClientConn</code> 接口中，<code>UpdateState</code> 方法需要传入 <code>State</code> 结构，<code>NewAddress</code> 方法需要传入 <code>Address</code> 结构，看代码可以发现其中包含了 <code>Addresses []Address // Resolved addresses for the target</code>，可以看出是需要将服务发现得到的 <code>Address</code> 对象列表告诉 <code>ClientConn</code> 的对象。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// ClientConn contains the callbacks for resolver to notify any updates</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// to the gRPC ClientConn.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// This interface is to be implemented by gRPC. Users should not need a</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// brand new implementation of this interface. For the situations like</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// testing, the new implementation should embed this interface. This allows</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// gRPC to add new methods to this interface.</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">ClientConn</span> <span style="color:#00a8c8">interface</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// UpdateState updates the state of the ClientConn appropriately.</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">UpdateState</span><span style="color:#111">(</span><span style="color:#75af00">State</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// NewAddress is called by resolver to notify ClientConn a new list</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// of resolved addresses.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// The address list should be the complete list of resolved addresses.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// Deprecated: Use UpdateState instead.</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">NewAddress</span><span style="color:#111">(</span><span style="color:#75af00">addresses</span> <span style="color:#111">[]</span><span style="color:#75af00">Address</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// NewServiceConfig is called by resolver to notify ClientConn a new</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// service config. The service config should be provided as a json string.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// Deprecated: Use UpdateState instead.</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">NewServiceConfig</span><span style="color:#111">(</span><span style="color:#75af00">serviceConfig</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><ul>
<li>resolver.Resolver <code>Resolver</code> 提供了 <code>ResolveNow</code> 用于被 gRPC 尝试重新进行服务发现</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// Resolver watches for the updates on the specified target.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Updates include address updates and service config updates.</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Resolver</span> <span style="color:#00a8c8">interface</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// ResolveNow will be called by gRPC to try to resolve the target name</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// again. It&#39;s just a hint, resolver can ignore this if it&#39;s not necessary.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// It could be called multiple times concurrently.</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">ResolveNow</span><span style="color:#111">(</span><span style="color:#75af00">ResolveNowOption</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Close closes the resolver.</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="梳理-resolver-过程">梳理 Resolver 过程</h2>
<p>通过这三个接口，再次梳理下 gRPC 的服务发现实现逻辑</p>
<ol>
<li>通过 <code>Builder.Build()</code> 进行 <code>Reslover</code> 的创建，在 <code>Build()</code> 的过程中将服务发现的地址信息丢给 <code>ClientConn</code> 用于内部连接创建（通过 <code>ClientConn.UpdateState()</code> 实现）等逻辑；</li>
<li>当 <code>client</code> 在 <code>Dial</code> 时会根据 <code>target</code> 解析的 <code>scheme</code> 获取对应的 <code>Builder</code>，<a href="https://github.com/grpc/grpc-go/blob/master/clientconn.go#L242">代码位置</a></li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">DialContext</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">,</span> <span style="color:#75af00">target</span> <span style="color:#00a8c8">string</span><span style="color:#111">,</span> <span style="color:#75af00">opts</span> <span style="color:#f92672">...</span><span style="color:#75af00">DialOption</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#75af00">conn</span> <span style="color:#f92672">*</span><span style="color:#75af00">ClientConn</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Determine the resolver to use.</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">cc</span><span style="color:#111">.</span><span style="color:#75af00">parsedTarget</span> <span style="color:#111">=</span> <span style="color:#75af00">parseTarget</span><span style="color:#111">(</span><span style="color:#75af00">cc</span><span style="color:#111">.</span><span style="color:#75af00">target</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">grpclog</span><span style="color:#111">.</span><span style="color:#75af00">Infof</span><span style="color:#111">(</span><span style="color:#d88200">&#34;parsed scheme: %q&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">cc</span><span style="color:#111">.</span><span style="color:#75af00">parsedTarget</span><span style="color:#111">.</span><span style="color:#75af00">Scheme</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">resolverBuilder</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">cc</span><span style="color:#111">.</span><span style="color:#75af00">getResolver</span><span style="color:#111">(</span><span style="color:#75af00">cc</span><span style="color:#111">.</span><span style="color:#75af00">parsedTarget</span><span style="color:#111">.</span><span style="color:#75af00">Scheme</span><span style="color:#111">)</span>		<span style="color:#75715e">// 通过 scheme(名字) 获取对应的 resolver</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#75af00">resolverBuilder</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// If resolver builder is still nil, the parsed target&#39;s scheme is</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// not registered. Fallback to default resolver and set Endpoint to</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// the original target.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">grpclog</span><span style="color:#111">.</span><span style="color:#75af00">Infof</span><span style="color:#111">(</span><span style="color:#d88200">&#34;scheme %q not registered, fallback to default scheme&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">cc</span><span style="color:#111">.</span><span style="color:#75af00">parsedTarget</span><span style="color:#111">.</span><span style="color:#75af00">Scheme</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">cc</span><span style="color:#111">.</span><span style="color:#75af00">parsedTarget</span> <span style="color:#111">=</span> <span style="color:#75af00">resolver</span><span style="color:#111">.</span><span style="color:#75af00">Target</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">Scheme</span><span style="color:#111">:</span>   <span style="color:#75af00">resolver</span><span style="color:#111">.</span><span style="color:#75af00">GetDefaultScheme</span><span style="color:#111">(),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">Endpoint</span><span style="color:#111">:</span> <span style="color:#75af00">target</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">resolverBuilder</span> <span style="color:#111">=</span> <span style="color:#75af00">cc</span><span style="color:#111">.</span><span style="color:#75af00">getResolver</span><span style="color:#111">(</span><span style="color:#75af00">cc</span><span style="color:#111">.</span><span style="color:#75af00">parsedTarget</span><span style="color:#111">.</span><span style="color:#75af00">Scheme</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">resolverBuilder</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;could not get resolver for default scheme: %q&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">cc</span><span style="color:#111">.</span><span style="color:#75af00">parsedTarget</span><span style="color:#111">.</span><span style="color:#75af00">Scheme</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Build the resolver.</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">rWrapper</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">newCCResolverWrapper</span><span style="color:#111">(</span><span style="color:#75af00">cc</span><span style="color:#111">,</span> <span style="color:#75af00">resolverBuilder</span><span style="color:#111">)</span>		<span style="color:#75715e">// 通过 gRPC 提供的 Wrapper，应用我们实现的 resolver 逻辑</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;failed to build resolver: %v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">cc</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">Lock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">cc</span><span style="color:#111">.</span><span style="color:#75af00">resolverWrapper</span> <span style="color:#111">=</span> <span style="color:#75af00">rWrapper</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">cc</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">Unlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><ol start="3">
<li>当 <code>Dial</code> 成功会创建出结构体 <code>ClientConn</code> 的对象 <a href="https://github.com/grpc/grpc-go/blob/master/clientconn.go#L447">官方代码位置</a>(注意不是上面的 <code>ClientConn</code> 接口)，可以看到结构体 <code>ClientConn</code> 内的成员 <code>resolverWrapper</code> 又实现了接口 <code>ClientConn</code> 的方法 <a href="https://github.com/grpc/grpc-go/blob/master/resolver_conn_wrapper.go">官方代码位置</a></li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">DialContext</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">,</span> <span style="color:#75af00">target</span> <span style="color:#00a8c8">string</span><span style="color:#111">,</span> <span style="color:#75af00">opts</span> <span style="color:#f92672">...</span><span style="color:#75af00">DialOption</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#75af00">conn</span> <span style="color:#f92672">*</span><span style="color:#75af00">ClientConn</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 初始化 CC</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">cc</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">ClientConn</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">target</span><span style="color:#111">:</span>            <span style="color:#75af00">target</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">csMgr</span><span style="color:#111">:</span>             <span style="color:#f92672">&amp;</span><span style="color:#75af00">connectivityStateManager</span><span style="color:#111">{},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">conns</span><span style="color:#111">:</span>             <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#f92672">*</span><span style="color:#75af00">addrConn</span><span style="color:#111">]</span><span style="color:#00a8c8">struct</span><span style="color:#111">{}),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">dopts</span><span style="color:#111">:</span>             <span style="color:#75af00">defaultDialOptions</span><span style="color:#111">(),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">blockingpicker</span><span style="color:#111">:</span>    <span style="color:#75af00">newPickerWrapper</span><span style="color:#111">(),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">czData</span><span style="color:#111">:</span>            <span style="color:#111">new</span><span style="color:#111">(</span><span style="color:#75af00">channelzData</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">firstResolveEvent</span><span style="color:#111">:</span> <span style="color:#75af00">grpcsync</span><span style="color:#111">.</span><span style="color:#75af00">NewEvent</span><span style="color:#111">(),</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">return</span> <span style="color:#75af00">cc</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><ol start="4">
<li>当 <code>resolverWrapper</code> 被初始化时就会调用 <code>Build</code> 方法 <a href="https://github.com/grpc/grpc-go/blob/master/resolver_conn_wrapper.go#L89">官方代码位置</a>，其中参数为接口 <code>ClientConn</code> 传入的是 <code>ccResolverWrapper</code></li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// newCCResolverWrapper uses the resolver.Builder to build a Resolver and</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// returns a ccResolverWrapper object which wraps the newly built resolver.</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">newCCResolverWrapper</span><span style="color:#111">(</span><span style="color:#75af00">cc</span> <span style="color:#f92672">*</span><span style="color:#75af00">ClientConn</span><span style="color:#111">,</span> <span style="color:#75af00">rb</span> <span style="color:#75af00">resolver</span><span style="color:#111">.</span><span style="color:#75af00">Builder</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">ccResolverWrapper</span><span style="color:#111">,</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">ccr</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">ccResolverWrapper</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">cc</span><span style="color:#111">:</span>   <span style="color:#75af00">cc</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">done</span><span style="color:#111">:</span> <span style="color:#75af00">grpcsync</span><span style="color:#111">.</span><span style="color:#75af00">NewEvent</span><span style="color:#111">(),</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">var</span> <span style="color:#75af00">credsClone</span> <span style="color:#75af00">credentials</span><span style="color:#111">.</span><span style="color:#75af00">TransportCredentials</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#75af00">creds</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">cc</span><span style="color:#111">.</span><span style="color:#75af00">dopts</span><span style="color:#111">.</span><span style="color:#75af00">copts</span><span style="color:#111">.</span><span style="color:#75af00">TransportCredentials</span><span style="color:#111">;</span> <span style="color:#75af00">creds</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">credsClone</span> <span style="color:#111">=</span> <span style="color:#75af00">creds</span><span style="color:#111">.</span><span style="color:#75af00">Clone</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">rbo</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">resolver</span><span style="color:#111">.</span><span style="color:#75af00">BuildOptions</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">DisableServiceConfig</span><span style="color:#111">:</span> <span style="color:#75af00">cc</span><span style="color:#111">.</span><span style="color:#75af00">dopts</span><span style="color:#111">.</span><span style="color:#75af00">disableServiceConfig</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">DialCreds</span><span style="color:#111">:</span>            <span style="color:#75af00">credsClone</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">CredsBundle</span><span style="color:#111">:</span>          <span style="color:#75af00">cc</span><span style="color:#111">.</span><span style="color:#75af00">dopts</span><span style="color:#111">.</span><span style="color:#75af00">copts</span><span style="color:#111">.</span><span style="color:#75af00">CredsBundle</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">Dialer</span><span style="color:#111">:</span>               <span style="color:#75af00">cc</span><span style="color:#111">.</span><span style="color:#75af00">dopts</span><span style="color:#111">.</span><span style="color:#75af00">copts</span><span style="color:#111">.</span><span style="color:#75af00">Dialer</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">var</span> <span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// We need to hold the lock here while we assign to the ccr.resolver field</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// to guard against a data race caused by the following code path,</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// rb.Build--&gt;ccr.ReportError--&gt;ccr.poll--&gt;ccr.resolveNow, would end up</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// accessing ccr.resolver which is being assigned here.</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">ccr</span><span style="color:#111">.</span><span style="color:#75af00">resolverMu</span><span style="color:#111">.</span><span style="color:#75af00">Lock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">defer</span> <span style="color:#75af00">ccr</span><span style="color:#111">.</span><span style="color:#75af00">resolverMu</span><span style="color:#111">.</span><span style="color:#75af00">Unlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">ccr</span><span style="color:#111">.</span><span style="color:#75af00">resolver</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">rb</span><span style="color:#111">.</span><span style="color:#75af00">Build</span><span style="color:#111">(</span><span style="color:#75af00">cc</span><span style="color:#111">.</span><span style="color:#75af00">parsedTarget</span><span style="color:#111">,</span> <span style="color:#75af00">ccr</span><span style="color:#111">,</span> <span style="color:#75af00">rbo</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">return</span> <span style="color:#75af00">ccr</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><ol start="5">
<li>当用户基于 <code>Builder</code> 的实现进行 <code>UpdateState</code> 调用时，则会触发结构体 <code>ClientConn</code> 的 <code>updateResolverState</code> 方法 <a href="https://github.com/grpc/grpc-go/blob/master/resolver_conn_wrapper.go#L109">官方代码位置</a>，<code>updateResolverState</code> 则会对传入的 <code>Address</code> 进行初始化等逻辑 <a href="https://github.com/grpc/grpc-go/blob/master/clientconn.go#L553">官方代码位置</a></li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">cc</span> <span style="color:#f92672">*</span><span style="color:#75af00">ClientConn</span><span style="color:#111">)</span> <span style="color:#75af00">updateResolverState</span><span style="color:#111">(</span><span style="color:#75af00">s</span> <span style="color:#75af00">resolver</span><span style="color:#111">.</span><span style="color:#75af00">State</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">defer</span> <span style="color:#75af00">cc</span><span style="color:#111">.</span><span style="color:#75af00">firstResolveEvent</span><span style="color:#111">.</span><span style="color:#75af00">Fire</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">cc</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">Lock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Check if the ClientConn is already closed. Some fields (e.g.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// balancerWrapper) are set to nil when closing the ClientConn, and could</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// cause nil pointer panic if we don&#39;t have this check.</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#75af00">cc</span><span style="color:#111">.</span><span style="color:#75af00">conns</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">cc</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">Unlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// May need to apply the initial service config in case the resolver</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// doesn&#39;t support service configs, or doesn&#39;t provide a service config</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// with the new addresses.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">cc</span><span style="color:#111">.</span><span style="color:#75af00">maybeApplyDefaultServiceConfig</span><span style="color:#111">(</span><span style="color:#00a8c8">nil</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">cc</span><span style="color:#111">.</span><span style="color:#75af00">balancerWrapper</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">cc</span><span style="color:#111">.</span><span style="color:#75af00">balancerWrapper</span><span style="color:#111">.</span><span style="color:#75af00">resolverError</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// No addresses are valid with err set; return early.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">cc</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">Unlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#75af00">balancer</span><span style="color:#111">.</span><span style="color:#75af00">ErrBadResolverState</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">var</span> <span style="color:#75af00">ret</span> <span style="color:#00a8c8">error</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#75af00">cc</span><span style="color:#111">.</span><span style="color:#75af00">dopts</span><span style="color:#111">.</span><span style="color:#75af00">disableServiceConfig</span> <span style="color:#f92672">||</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">ServiceConfig</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">cc</span><span style="color:#111">.</span><span style="color:#75af00">maybeApplyDefaultServiceConfig</span><span style="color:#111">(</span><span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">Addresses</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// TODO: do we need to apply a failing LB policy if there is no</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// default, per the error handling design?</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">sc</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">ServiceConfig</span><span style="color:#111">.</span><span style="color:#75af00">Config</span><span style="color:#111">.(</span><span style="color:#f92672">*</span><span style="color:#75af00">ServiceConfig</span><span style="color:#111">);</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">ServiceConfig</span><span style="color:#111">.</span><span style="color:#75af00">Err</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">cc</span><span style="color:#111">.</span><span style="color:#75af00">applyServiceConfigAndBalancer</span><span style="color:#111">(</span><span style="color:#75af00">sc</span><span style="color:#111">,</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">Addresses</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">ret</span> <span style="color:#111">=</span> <span style="color:#75af00">balancer</span><span style="color:#111">.</span><span style="color:#75af00">ErrBadResolverState</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#75af00">cc</span><span style="color:#111">.</span><span style="color:#75af00">balancerWrapper</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">var</span> <span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">if</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">ServiceConfig</span><span style="color:#111">.</span><span style="color:#75af00">Err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">status</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#75af00">codes</span><span style="color:#111">.</span><span style="color:#75af00">Unavailable</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;error parsing service config: %v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">ServiceConfig</span><span style="color:#111">.</span><span style="color:#75af00">Err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">status</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#75af00">codes</span><span style="color:#111">.</span><span style="color:#75af00">Unavailable</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;illegal service config type: %T&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">ServiceConfig</span><span style="color:#111">.</span><span style="color:#75af00">Config</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75af00">cc</span><span style="color:#111">.</span><span style="color:#75af00">blockingpicker</span><span style="color:#111">.</span><span style="color:#75af00">updatePicker</span><span style="color:#111">(</span><span style="color:#75af00">base</span><span style="color:#111">.</span><span style="color:#75af00">NewErrPicker</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75af00">cc</span><span style="color:#111">.</span><span style="color:#75af00">csMgr</span><span style="color:#111">.</span><span style="color:#75af00">updateState</span><span style="color:#111">(</span><span style="color:#75af00">connectivity</span><span style="color:#111">.</span><span style="color:#75af00">TransientFailure</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75af00">cc</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">Unlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">return</span> <span style="color:#75af00">ret</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">var</span> <span style="color:#75af00">balCfg</span> <span style="color:#75af00">serviceconfig</span><span style="color:#111">.</span><span style="color:#75af00">LoadBalancingConfig</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#75af00">cc</span><span style="color:#111">.</span><span style="color:#75af00">dopts</span><span style="color:#111">.</span><span style="color:#75af00">balancerBuilder</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">cc</span><span style="color:#111">.</span><span style="color:#75af00">sc</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">cc</span><span style="color:#111">.</span><span style="color:#75af00">sc</span><span style="color:#111">.</span><span style="color:#75af00">lbConfig</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">balCfg</span> <span style="color:#111">=</span> <span style="color:#75af00">cc</span><span style="color:#111">.</span><span style="color:#75af00">sc</span><span style="color:#111">.</span><span style="color:#75af00">lbConfig</span><span style="color:#111">.</span><span style="color:#75af00">cfg</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">cbn</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">cc</span><span style="color:#111">.</span><span style="color:#75af00">curBalancerName</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">bw</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">cc</span><span style="color:#111">.</span><span style="color:#75af00">balancerWrapper</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">cc</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">Unlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#75af00">cbn</span> <span style="color:#f92672">!=</span> <span style="color:#75af00">grpclbName</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Filter any grpclb addresses since we don&#39;t have the grpclb balancer.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">for</span> <span style="color:#75af00">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span><span style="color:#111">;</span> <span style="color:#75af00">i</span> <span style="color:#111">&lt;</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">Addresses</span><span style="color:#111">);</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">Addresses</span><span style="color:#111">[</span><span style="color:#75af00">i</span><span style="color:#111">].</span><span style="color:#75af00">Type</span> <span style="color:#f92672">==</span> <span style="color:#75af00">resolver</span><span style="color:#111">.</span><span style="color:#75af00">GRPCLB</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">copy</span><span style="color:#111">(</span><span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">Addresses</span><span style="color:#111">[</span><span style="color:#75af00">i</span><span style="color:#111">:],</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">Addresses</span><span style="color:#111">[</span><span style="color:#75af00">i</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span><span style="color:#111">:])</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">Addresses</span> <span style="color:#111">=</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">Addresses</span><span style="color:#111">[:</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">Addresses</span><span style="color:#111">)</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">continue</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">i</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">uccsErr</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">bw</span><span style="color:#111">.</span><span style="color:#75af00">updateClientConnState</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">balancer</span><span style="color:#111">.</span><span style="color:#75af00">ClientConnState</span><span style="color:#111">{</span><span style="color:#75af00">ResolverState</span><span style="color:#111">:</span> <span style="color:#75af00">s</span><span style="color:#111">,</span> <span style="color:#75af00">BalancerConfig</span><span style="color:#111">:</span> <span style="color:#75af00">balCfg</span><span style="color:#111">})</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#75af00">ret</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">ret</span> <span style="color:#111">=</span> <span style="color:#75af00">uccsErr</span> <span style="color:#75715e">// prefer ErrBadResolver state since any other error is</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// currently meaningless to the caller.</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">return</span> <span style="color:#75af00">ret</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><ol start="6">
<li>至此整个服务发现过程就结束了。从中也可以看出 gRPC 官方提供的三个接口还是很灵活的，但也正因为灵活要实现稍微麻烦一些，而 <code>Address</code><a href="https://github.com/grpc/grpc-go/blob/master/resolver/resolver.go#L79">官方代码位置</a> 如果直接被业务拿来用于服务节点信息的描述结构则显得有些过于简单。</li>
</ol>
<p>所以 <code>warden</code> 包装了 gRPC 的整个服务发现实现逻辑，代码分别位于 <code>pkg/naming/naming.go</code> 和 <code>warden/resolver/resolver.go</code>，其中：</p>
<ul>
<li><code>naming.go</code> 内定义了用于描述业务实例的 <code>Instance</code> 结构、用于服务注册的 <code>Registry</code> 接口、用于服务发现的 <code>Resolver</code> 接口</li>
<li><code>resolver.go</code> 内实现了 gRPC 官方的 <code>resolver.Builder</code> 和 <code>resolver.Resolver</code> 接口，但也暴露了 <code>naming.go</code> 内的 <code>naming.Builder</code> 和 <code>naming.Resolver</code> 接口</li>
</ul>
<h2 id="文章转自">文章转自：</h2>
<ul>
<li><a href="https://pandaychen.github.io/2019/07/11/GRPC-SERVICE-DISCOVERY/">基于 gRPC 的服务发现与负载均衡（基础篇） - 熊喵君的博客 | PANDAYCHEN</a></li>
<li><a href="https://pandaychen.github.io/2020/01/03/GRPC-RESOLVER-DEEP-ANALYSIS2-IN-KRATOS/">gRPC 应用篇之 Resolver 接口封装 - 熊喵君的博客 | PANDAYCHEN</a></li>
</ul>
]]></content:encoded><category>microservice</category><category>grpc</category><category>go</category></item><item><title>grpc基础</title><link>https://daemon365.dev/post/microservice/grpc_basics/</link><pubDate>Thu, 10 Dec 2020 00:00:00 +0800</pubDate><guid>https://daemon365.dev/post/microservice/grpc_basics/</guid><description>&lt;h2 id="rpc-框架原理"&gt;RPC 框架原理&lt;/h2&gt;
&lt;p&gt;RPC 框架的目标就是让远程服务调用更加简单、透明，RPC 框架负责屏蔽底层的传输方式（TCP 或者 UDP）、序列化方式（XML/Json/ 二进制）和通信细节。服务调用者可以像调用本地接口一样调用远程的服务提供者，而不需要关心底层通信细节和调用过程。&lt;/p&gt;
&lt;p&gt;&lt;img src="https://daemon365.dev/images/32547781-dc18-4784-b1a3-f6ade97bc87f.png" alt=""&gt;&lt;/p&gt;
&lt;p&gt;业界主流的 RPC 框架整体上分为三类：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;支持多语言的 RPC 框架，比较成熟的有 Google 的 gRPC、facebook的Apache、Thrift；&lt;/li&gt;
&lt;li&gt;只支持特定语言的 RPC 框架，例如新浪微博的 Motan；&lt;/li&gt;
&lt;li&gt;支持服务治理等服务化特性的分布式服务框架，其底层内核仍然是 RPC 框架, 例如阿里的 Dubbo。&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="grpc是什么"&gt;gRPC是什么&lt;/h2&gt;
&lt;p&gt;&lt;a href="http://www.oschina.net/p/grpc-framework"&gt;gRPC&lt;/a&gt; 是一个高性能、开源和通用的 RPC 框架，面向移动和 HTTP/2 设计。目前提供 C、Java 和 Go 语言版本，分别是：grpc, grpc-java, grpc-go. 其中 C 版本支持 C, C++, Node.js, Python, Ruby, Objective-C, PHP 和 C## 支持.&lt;/p&gt;
&lt;p&gt;gRPC 基于 HTTP/2 标准设计，带来诸如双向流、流控、头部压缩、单 TCP 连接上的多复用请求等特。这些特性使得其在移动设备上表现更好，更省电和节省空间占用。&lt;/p&gt;
&lt;h3 id="grc优点"&gt;grc优点&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;多语言：语言中立，支持多种语言。&lt;/li&gt;
&lt;li&gt;轻量级、高性能：序列化支持 PB(Protocol Buffer)和 JSON，PB 是一种语言无关的高性能序列化框架。
可插拔&lt;/li&gt;
&lt;li&gt;IDL：基于文件定义服务，通过 proto3 工具生成指定语言的数据结构、服务端接口以及客户端 Stub。&lt;/li&gt;
&lt;li&gt;移动端：基于标准的 HTTP2 设计，支持双向流、消息头压缩、单 TCP 的多路复用、服务端推送等特性，这些特性使得 gRPC 在移动端设备上更加省电和节省网络流量。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img src="https://daemon365.dev/images/f011b389-3272-4f7f-be74-4eb0f6bb7b94.png" alt=""&gt;&lt;/p&gt;</description><content:encoded><![CDATA[<h2 id="rpc-框架原理">RPC 框架原理</h2>
<p>RPC 框架的目标就是让远程服务调用更加简单、透明，RPC 框架负责屏蔽底层的传输方式（TCP 或者 UDP）、序列化方式（XML/Json/ 二进制）和通信细节。服务调用者可以像调用本地接口一样调用远程的服务提供者，而不需要关心底层通信细节和调用过程。</p>
<p><img src="/images/32547781-dc18-4784-b1a3-f6ade97bc87f.png" alt=""></p>
<p>业界主流的 RPC 框架整体上分为三类：</p>
<ul>
<li>支持多语言的 RPC 框架，比较成熟的有 Google 的 gRPC、facebook的Apache、Thrift；</li>
<li>只支持特定语言的 RPC 框架，例如新浪微博的 Motan；</li>
<li>支持服务治理等服务化特性的分布式服务框架，其底层内核仍然是 RPC 框架, 例如阿里的 Dubbo。</li>
</ul>
<h2 id="grpc是什么">gRPC是什么</h2>
<p><a href="http://www.oschina.net/p/grpc-framework">gRPC</a> 是一个高性能、开源和通用的 RPC 框架，面向移动和 HTTP/2 设计。目前提供 C、Java 和 Go 语言版本，分别是：grpc, grpc-java, grpc-go. 其中 C 版本支持 C, C++, Node.js, Python, Ruby, Objective-C, PHP 和 C## 支持.</p>
<p>gRPC 基于 HTTP/2 标准设计，带来诸如双向流、流控、头部压缩、单 TCP 连接上的多复用请求等特。这些特性使得其在移动设备上表现更好，更省电和节省空间占用。</p>
<h3 id="grc优点">grc优点</h3>
<ul>
<li>多语言：语言中立，支持多种语言。</li>
<li>轻量级、高性能：序列化支持 PB(Protocol Buffer)和 JSON，PB 是一种语言无关的高性能序列化框架。
可插拔</li>
<li>IDL：基于文件定义服务，通过 proto3 工具生成指定语言的数据结构、服务端接口以及客户端 Stub。</li>
<li>移动端：基于标准的 HTTP2 设计，支持双向流、消息头压缩、单 TCP 的多路复用、服务端推送等特性，这些特性使得 gRPC 在移动端设备上更加省电和节省网络流量。</li>
</ul>
<p><img src="/images/f011b389-3272-4f7f-be74-4eb0f6bb7b94.png" alt=""></p>
<h2 id="安全">安全</h2>
<p>HTTP2 规范当使用 TLS 时强制使用 TLS 1.2 及以上的版本，并且在部署上对允许的密码施加一些额外的限制以避免已知的比如需要 SNI 支持的问题。并且期待 HTTP2 与专有的传输安全机制相结合，这些传输机制的规格说明不能提供有意义的建议。</p>
<h2 id="grpc使用">gRPC使用</h2>
<p>使用gRPC， 我们可以一次性的在一个.proto文件中定义服务并使用任何支持它的语言去实现客户端和服务端，反过来，它们可以应用在各种场景中，从Google的服务器到你自己的平板电脑—— gRPC帮你解决了不同语言及环境间通信的复杂性。使用protocol buffers还能获得其他好处，包括高效的序列号，简单的IDL以及容易进行接口更新。总之一句话，使用gRPC能让我们更容易编写跨语言的分布式代码。</p>
<ul>
<li>通过一个 protocol buffers 模式，定义一个简单的带有 Hello World 方法的 RPC 服务。</li>
<li>用你最喜欢的语言(如果可用的话)来创建一个实现了这个接口的服务端。</li>
<li>用你最喜欢的(或者其他你愿意的)语言来访问你的服务端。</li>
</ul>
<h2 id="什么用grpc">什么用grpc</h2>
<ul>
<li>服务而非对象、消息而非引用：促进微服务的系统间粗粒度消息交互设计理念。</li>
<li>负载无关的：不同的服务需要使用不同的消息类型和编码，例如 protocol buffers、JSON、XML 和 Thrift。</li>
<li>流：Streaming API。</li>
<li>阻塞式和非阻塞式：支持异步和同步处理在客户端和服务端间交互的消息序列。</li>
<li>元数据交换：常见的横切关注点，如认证或跟踪，依赖数据交换。</li>
<li>标准化状态码：客户端通常以有限的方式响应 API 调用返回的错误。</li>
</ul>
<h3 id="healthcheck">HealthCheck</h3>
<p>gRPC 有一个标准的健康检测协议，在 gRPC 的所有语言实现中基本都提供了生成代码和用于设置运行状态的功能。</p>
<p>主动健康检查 health check，可以在服务提供者服务不稳定时，被消费者所感知，临时从负载均衡中摘除，减少错误请求。当服务提供者重新稳定后，health check 成功，重新加入到消费者的负载均衡，恢复请求。health check，同样也被用于外挂方式的容器健康检测，或者流量检测(k8s liveness &amp; readiness)。</p>
<p><img src="/images/b0e2261e-65fd-4a25-92bd-faf3e2465848.png" alt=""></p>
<p><img src="/images/2d6258dc-37b5-409b-a46f-b727115925af.png" alt=""></p>
<h2 id="protubuf文件编写">protubuf文件编写</h2>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">syntax</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;proto3&#34;</span><span style="color:#111">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">hello</span><span style="color:#111">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// option go_package = &#34;hello&#34;;</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">option</span> <span style="color:#75af00">go_package</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;/hello&#34;</span><span style="color:#111">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// The greeting service definition.</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">service</span> <span style="color:#75af00">Greeter</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Sends a greeting</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75af00">rpc</span> <span style="color:#75af00">SayHello</span> <span style="color:#111">(</span><span style="color:#75af00">HelloRequest</span><span style="color:#111">)</span> <span style="color:#75af00">returns</span> <span style="color:#111">(</span><span style="color:#75af00">HelloReply</span><span style="color:#111">)</span>  <span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// The request message containing the user&#39;s name.</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">message</span> <span style="color:#75af00">HelloRequest</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#00a8c8">string</span> <span style="color:#75af00">name</span> <span style="color:#111">=</span> <span style="color:#ae81ff">1</span><span style="color:#111">;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// The response message containing the greetings</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">message</span> <span style="color:#75af00">HelloReply</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#00a8c8">string</span> <span style="color:#75af00">message</span> <span style="color:#111">=</span> <span style="color:#ae81ff">1</span><span style="color:#111">;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="golang创建grpc-server">golang创建grpc server</h2>
<p>安装工具包:</p>
<ol>
<li>下载protoc <a href="https://www.zhaohaiyu.com/protobuf/">链接</a></li>
<li><code>go install google.golang.org/protobuf/cmd/protoc-gen-go@latest</code></li>
<li><code>go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest</code></li>
</ol>
<p>执行:</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>protoc --go_out<span style="color:#f92672">=</span>./  --go-grpc_out<span style="color:#f92672">=</span>./  hello.proto
</span></span></code></pre></div><ul>
<li>&ndash;proto_path: 指定了要去哪个目录中搜索import中导入的和要编译为.go的proto文件 (在这没有使用,需要的话可以加上)</li>
<li>&ndash;go_out:指定了生成的go文件的目录，我在这里把go文件放到本目录中</li>
<li>&ndash;go-grpc_out: 指定了生成的go grpc文件的目录，我在这里把go grpc文件放到本目录中</li>
<li>hello.proto， 定义了我要编译的文件是哪个文件。</li>
</ul>
<h3 id="go-server代码">go server代码</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;context&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;errors&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;github.com/zhaohaiyu1996/akit/example/grpc/hello&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;google.golang.org/grpc&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;net&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Server</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">hello</span><span style="color:#111">.</span><span style="color:#75af00">UnimplementedGreeterServer</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// SayHello implements helloworld.GreeterServer</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">s</span> <span style="color:#f92672">*</span><span style="color:#75af00">Server</span><span style="color:#111">)</span> <span style="color:#75af00">SayHello</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">,</span> <span style="color:#75af00">in</span> <span style="color:#f92672">*</span><span style="color:#75af00">hello</span><span style="color:#111">.</span><span style="color:#75af00">HelloRequest</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">hello</span><span style="color:#111">.</span><span style="color:#75af00">HelloReply</span><span style="color:#111">,</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">in</span><span style="color:#111">.</span><span style="color:#75af00">Name</span> <span style="color:#f92672">==</span> <span style="color:#d88200">&#34;error&#34;</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">errors</span><span style="color:#111">.</span><span style="color:#75af00">New</span><span style="color:#111">(</span><span style="color:#d88200">&#34;123&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">in</span><span style="color:#111">.</span><span style="color:#75af00">Name</span> <span style="color:#f92672">==</span> <span style="color:#d88200">&#34;panic&#34;</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#d88200">&#34;grpc panic&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">hello</span><span style="color:#111">.</span><span style="color:#75af00">HelloReply</span><span style="color:#111">{</span><span style="color:#75af00">Message</span><span style="color:#111">:</span> <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Sprintf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Hello %+v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">in</span><span style="color:#111">.</span><span style="color:#75af00">Name</span><span style="color:#111">)},</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Ss</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">*</span><span style="color:#75af00">grpc</span><span style="color:#111">.</span><span style="color:#75af00">Server</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 监听本地的8848端口</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">s</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">Ss</span><span style="color:#111">{</span><span style="color:#75af00">grpc</span><span style="color:#111">.</span><span style="color:#75af00">NewServer</span><span style="color:#111">()}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">hello</span><span style="color:#111">.</span><span style="color:#75af00">RegisterGreeterServer</span><span style="color:#111">(</span><span style="color:#75af00">s</span><span style="color:#111">,</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">Server</span><span style="color:#111">{})</span> <span style="color:#75715e">// 在gRPC服务端注册服务</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">lis</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">net</span><span style="color:#111">.</span><span style="color:#75af00">Listen</span><span style="color:#111">(</span><span style="color:#d88200">&#34;tcp&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;127.0.0.1:8808&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;listen failed: %v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//reflection.Register(s.Server) //在给定的gRPC服务器上注册服务器反射服务</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Serve方法在lis上接受传入连接，为每个连接创建一个ServerTransport和server的goroutine。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 该goroutine读取gRPC请求，然后调用已注册的处理程序来响应它们。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">Serve</span><span style="color:#111">(</span><span style="color:#75af00">lis</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;failed to serve: %v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="golang创建grpc-client">golang创建grpc client</h2>
<p>执行:</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>protoc --go_out<span style="color:#f92672">=</span>./  --go-grpc_out<span style="color:#f92672">=</span>./  hello.proto
</span></span></code></pre></div><h3 id="go-client代码">go client代码</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;context&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;github.com/zhaohaiyu1996/akit/example/grpc/hello&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;google.golang.org/grpc&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 连接服务器</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">conn</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">grpc</span><span style="color:#111">.</span><span style="color:#75af00">Dial</span><span style="color:#111">(</span><span style="color:#d88200">&#34;localhost:8808&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">grpc</span><span style="color:#111">.</span><span style="color:#75af00">WithInsecure</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;connect faild: %v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">conn</span><span style="color:#111">.</span><span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">c</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">hello</span><span style="color:#111">.</span><span style="color:#75af00">NewGreeterClient</span><span style="color:#111">(</span><span style="color:#75af00">conn</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 调用SayHello</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">SayHello</span><span style="color:#111">(</span><span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Background</span><span style="color:#111">(),</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">hello</span><span style="color:#111">.</span><span style="color:#75af00">HelloRequest</span><span style="color:#111">{</span><span style="color:#75af00">Name</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;zhaohaiyu&#34;</span><span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;sayHello failed: %v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">r</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>结果:</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>SayHello: hello ---&gt; zhaohaiyu
</span></span></code></pre></div><h2 id="python创建grpc-client">python创建grpc client</h2>
<p>使用python客户端调用golang服务端的方法</p>
<p>下载依赖:</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#111">pip</span> <span style="color:#111">install</span> <span style="color:#111">grpcio</span>
</span></span><span style="display:flex;"><span><span style="color:#111">pip</span> <span style="color:#111">install</span> <span style="color:#111">protobuf</span>
</span></span><span style="display:flex;"><span><span style="color:#111">pip</span> <span style="color:#111">install</span> <span style="color:#111">grpcio_tools</span>
</span></span></code></pre></div><p>执行:</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>python -m grpc_tools.protoc -I ./ --python_out<span style="color:#f92672">=</span>./ --grpc_python_out<span style="color:#f92672">=</span>./ hello.proto
</span></span></code></pre></div><h3 id="python-client代码">python client代码</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">grpc</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">hello_pb2</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">hello_pb2_grpc</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">def</span> <span style="color:#75af00">run</span><span style="color:#111">():</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">with</span> <span style="color:#111">grpc</span><span style="color:#f92672">.</span><span style="color:#111">insecure_channel</span><span style="color:#111">(</span><span style="color:#d88200">&#39;localhost:8848&#39;</span><span style="color:#111">)</span> <span style="color:#00a8c8">as</span> <span style="color:#111">channel</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">stub</span> <span style="color:#f92672">=</span> <span style="color:#111">hello_pb2_grpc</span><span style="color:#f92672">.</span><span style="color:#111">HelloStub</span><span style="color:#111">(</span><span style="color:#111">channel</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">res</span> <span style="color:#f92672">=</span> <span style="color:#111">stub</span><span style="color:#f92672">.</span><span style="color:#111">SayHello</span><span style="color:#111">(</span><span style="color:#111">hello_pb2</span><span style="color:#f92672">.</span><span style="color:#111">HelloRequest</span><span style="color:#111">(</span><span style="color:#111">name</span><span style="color:#f92672">=</span><span style="color:#d88200">&#34;赵海宇&#34;</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">print</span><span style="color:#111">(</span><span style="color:#111">res</span><span style="color:#f92672">.</span><span style="color:#111">message</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#111">__name__</span> <span style="color:#f92672">==</span> <span style="color:#d88200">&#39;__main__&#39;</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">run</span><span style="color:#111">()</span>
</span></span></code></pre></div><p>结果:</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>python ./main.go
</span></span><span style="display:flex;"><span>hello ---&gt; 赵海宇
</span></span></code></pre></div><h2 id="gprc的haeder">gprc的haeder</h2>
<ul>
<li>grpc是基于http2.0的rpc框架 -</li>
<li>grpc对于http头部传递数据进行了封装 metadata,单独抽象了一个包google.golang.org/grpc/metadata-</li>
<li>type ***p[string][]string其实就是一个map</li>
</ul>
<p>客户端发送方式一:</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// 创建md 并加入ctx</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">md</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">metadata</span><span style="color:#111">.</span><span style="color:#75af00">Pairs</span><span style="color:#111">(</span><span style="color:#d88200">&#34;key1&#34;</span><span style="color:#111">,</span><span style="color:#d88200">&#34;value1&#34;</span><span style="color:#111">,</span><span style="color:#d88200">&#34;key2&#34;</span><span style="color:#111">,</span><span style="color:#d88200">&#34;value2&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ctx</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">metadata</span><span style="color:#111">.</span><span style="color:#75af00">NewOutgoingContext</span><span style="color:#111">(</span><span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Background</span><span style="color:#111">(),</span><span style="color:#75af00">md</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 从ctx中拿出md</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">md</span><span style="color:#111">,</span><span style="color:#75af00">_</span> <span style="color:#111">=</span> <span style="color:#75af00">metadata</span><span style="color:#111">.</span><span style="color:#75af00">FromOutgoingContext</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">newMd</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">metadata</span><span style="color:#111">.</span><span style="color:#75af00">Pairs</span><span style="color:#111">(</span><span style="color:#d88200">&#34;key3&#34;</span><span style="color:#111">,</span><span style="color:#d88200">&#34;value3&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ctx</span> <span style="color:#111">=</span> <span style="color:#75af00">metadata</span><span style="color:#111">.</span><span style="color:#75af00">NewOutgoingContext</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span><span style="color:#75af00">metadata</span><span style="color:#111">.</span><span style="color:#75af00">Join</span><span style="color:#111">(</span><span style="color:#75af00">md</span><span style="color:#111">,</span><span style="color:#75af00">newMd</span><span style="color:#111">))</span>
</span></span></code></pre></div><p>客户端发送方式二:</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">ctx</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Background</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">ctx</span> <span style="color:#111">=</span> <span style="color:#75af00">metadata</span><span style="color:#111">.</span><span style="color:#75af00">AppendToOutgoingContext</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span><span style="color:#d88200">&#34;key1&#34;</span><span style="color:#111">,</span><span style="color:#d88200">&#34;value1&#34;</span><span style="color:#111">,</span><span style="color:#d88200">&#34;key2&#34;</span><span style="color:#111">,</span><span style="color:#d88200">&#34;value2&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">ctx</span> <span style="color:#111">=</span> <span style="color:#75af00">metadata</span><span style="color:#111">.</span><span style="color:#75af00">AppendToOutgoingContext</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span><span style="color:#d88200">&#34;key3&#34;</span><span style="color:#111">,</span><span style="color:#d88200">&#34;value3&#34;</span><span style="color:#111">)</span>
</span></span></code></pre></div><p>服务端接收:</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">md</span><span style="color:#111">,</span><span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">metadata</span><span style="color:#111">.</span><span style="color:#75af00">FromIncomingContext</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">)</span>
</span></span></code></pre></div><p>实例:</p>
<ol>
<li>server:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;net&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">pb</span> <span style="color:#d88200">&#34;test/demo13/server/hello&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;github.com/grpc-ecosystem/grpc-gateway/examples/clients/responsebody&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;github.com/uber/jaeger-client-go/crossdock/client&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;golang.org/x/net/context&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;google.golang.org/grpc&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;google.golang.org/grpc/metadata&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;google.golang.org/grpc/reflection&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">server</span> <span style="color:#00a8c8">struct</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">s</span> <span style="color:#f92672">*</span><span style="color:#75af00">server</span><span style="color:#111">)</span> <span style="color:#75af00">SayHello</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">,</span> <span style="color:#75af00">in</span> <span style="color:#f92672">*</span><span style="color:#75af00">pb</span><span style="color:#111">.</span><span style="color:#75af00">HelloRequest</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">pb</span><span style="color:#111">.</span><span style="color:#75af00">HelloResponse</span><span style="color:#111">,</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">md</span><span style="color:#111">,</span><span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">metadata</span><span style="color:#111">.</span><span style="color:#75af00">FromIncomingContext</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">md</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">pb</span><span style="color:#111">.</span><span style="color:#75af00">HelloResponse</span><span style="color:#111">{</span><span style="color:#75af00">Message</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;hello ---&gt; &#34;</span> <span style="color:#f92672">+</span> <span style="color:#75af00">in</span><span style="color:#111">.</span><span style="color:#75af00">Name</span><span style="color:#111">},</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 监听本地的8848端口</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">lis</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">net</span><span style="color:#111">.</span><span style="color:#75af00">Listen</span><span style="color:#111">(</span><span style="color:#d88200">&#34;tcp&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;localhost:8848&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;listen failed: %v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">s</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">grpc</span><span style="color:#111">.</span><span style="color:#75af00">NewServer</span><span style="color:#111">()</span> <span style="color:#75715e">// 创建gRPC服务器</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">pb</span><span style="color:#111">.</span><span style="color:#75af00">RegisterHelloServer</span><span style="color:#111">(</span><span style="color:#75af00">s</span><span style="color:#111">,</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">server</span><span style="color:#111">{})</span> <span style="color:#75715e">// 在gRPC服务端注册服务</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">reflection</span><span style="color:#111">.</span><span style="color:#75af00">Register</span><span style="color:#111">(</span><span style="color:#75af00">s</span><span style="color:#111">)</span> <span style="color:#75715e">//在给定的gRPC服务器上注册服务器反射服务</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Serve方法在lis上接受传入连接，为每个连接创建一个ServerTransport和server的goroutine。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 该goroutine读取gRPC请求，然后调用已注册的处理程序来响应它们。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">Serve</span><span style="color:#111">(</span><span style="color:#75af00">lis</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;failed to serve: %v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><ol>
<li>client</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;context&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">pb</span> <span style="color:#d88200">&#34;test/demo13/client/hello&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;google.golang.org/grpc&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;google.golang.org/grpc/metadata&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 连接服务器</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">conn</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">grpc</span><span style="color:#111">.</span><span style="color:#75af00">Dial</span><span style="color:#111">(</span><span style="color:#d88200">&#34;localhost:8848&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">grpc</span><span style="color:#111">.</span><span style="color:#75af00">WithInsecure</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;faild to connect: %v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">conn</span><span style="color:#111">.</span><span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">c</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">pb</span><span style="color:#111">.</span><span style="color:#75af00">NewHelloClient</span><span style="color:#111">(</span><span style="color:#75af00">conn</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 调用服务端的SayHello</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ctx</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Background</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ctx</span> <span style="color:#111">=</span> <span style="color:#75af00">metadata</span><span style="color:#111">.</span><span style="color:#75af00">AppendToOutgoingContext</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span><span style="color:#d88200">&#34;zhyyz&#34;</span><span style="color:#111">,</span><span style="color:#d88200">&#34;961119&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">SayHello</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">pb</span><span style="color:#111">.</span><span style="color:#75af00">HelloRequest</span><span style="color:#111">{</span><span style="color:#75af00">Name</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;zhaohaiyu&#34;</span><span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;sayHello failed: %v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;SayHello: %s \n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">Message</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div>]]></content:encoded><category>microservice</category><category>grpc</category><category>go</category></item></channel></rss>