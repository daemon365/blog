<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/"><channel><title>源码分析 on Daemon365</title><link>https://daemon365.dev/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/</link><description>Don't let yourself stop.</description><generator>Hugo -- gohugo.io</generator><language>zh-cn</language><lastBuildDate>Sat, 15 Jun 2024 16:14:00 +0800</lastBuildDate><atom:link href="https://daemon365.dev/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/index.xml" rel="self" type="application/rss+xml"/><item><title>boltdb 原理</title><link>https://daemon365.dev/post/cloud/boltdb_principles/</link><pubDate>Sat, 15 Jun 2024 16:14:00 +0800</pubDate><guid>https://daemon365.dev/post/cloud/boltdb_principles/</guid><description>&lt;h2 id="简介"&gt;简介&lt;/h2&gt;
&lt;p&gt;介绍及简单使用：https://www.cnblogs.com/daemon365/p/17690167.html
源码地址：https://github.com/etcd-io/bbolt&lt;/p&gt;
&lt;h2 id="page"&gt;page&lt;/h2&gt;
&lt;p&gt;因为 boltdb 是要落盘的，所以就要操作文件。为了提高效率，boltdb 会和其他数据库一样，会按 页（page）来操作文件。而且 boltdb 使用了 linux 的 &lt;a href="https://man7.org/linux/man-pages/man2/mmap.2.html"&gt;mmap&lt;/a&gt; 来内存映射操作文件，这样可以提高效率。&lt;/p&gt;
&lt;p&gt;在 linux 中，每个 page 的大小是 4KB。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-BASH" data-lang="BASH"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;getconf PAGESIZE
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#ae81ff"&gt;4096&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;对应的每页在我们的代理里也应该有一个数据结构，来存储数据。这个数据结构就是 &lt;code&gt;page&lt;/code&gt;。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;type&lt;/span&gt; &lt;span style="color:#75af00"&gt;Pgid&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;uint64&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;type&lt;/span&gt; &lt;span style="color:#75af00"&gt;Page&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;struct&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;id&lt;/span&gt; &lt;span style="color:#75af00"&gt;Pgid&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;flags&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;uint16&lt;/span&gt; &lt;span style="color:#75715e"&gt;// page 类型&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;count&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;uint16&lt;/span&gt; &lt;span style="color:#75715e"&gt;// page 中的元素数量&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;overflow&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;uint32&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 是否有后序页，如果有，overflow 表示后续页的数量&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;const&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;BranchPageFlag&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;0x01&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;LeafPageFlag&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;0x02&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;MetaPageFlag&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;0x04&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;FreelistPageFlag&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;0x10&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;code&gt;Page&lt;/code&gt; 里面有一个 &lt;code&gt;flags&lt;/code&gt; 字段，用来标识这个 page 是什么类型的。boltdb 里面有四种类型的 page, 分别是 分支页（BranchPageFlag）、叶子页（LeafPageFlag）、元数据页（MetaPageFlag）、空闲列表页（FreelistPageFlag）。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;分支页：由于 boltdb 使用的是 B+ 树，所以分支页用来存储 key 和子节点的指针。&lt;/li&gt;
&lt;li&gt;叶子页：叶子页用来存储 key 和 value。&lt;/li&gt;
&lt;li&gt;元数据页：元数据页用来存储 boltdb 的元数据，比如 boltdb 的版本号、boltdb 的根节点等。&lt;/li&gt;
&lt;li&gt;空闲列表页：由于 boltdb 使用 copy on write，所以当一个 page 被删除的时候，boltdb 并不会立即释放这个 page，而是把这个 page 加入到空闲列表页中，等到需要新的 page 的时候，再从空闲列表页中取出一个 page。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;在 page 之后会存储对用的结构，比如 meta 或者 freelist。先读取 page 判断自己的结构（定长的：8 + 2 + 2 +4），然后再根据不同的数据类型读取其他的结构（比如BranchPage）。&lt;/p&gt;</description><content:encoded><![CDATA[<h2 id="简介">简介</h2>
<p>介绍及简单使用：https://www.cnblogs.com/daemon365/p/17690167.html
源码地址：https://github.com/etcd-io/bbolt</p>
<h2 id="page">page</h2>
<p>因为 boltdb 是要落盘的，所以就要操作文件。为了提高效率，boltdb 会和其他数据库一样，会按 页（page）来操作文件。而且 boltdb 使用了 linux 的 <a href="https://man7.org/linux/man-pages/man2/mmap.2.html">mmap</a> 来内存映射操作文件，这样可以提高效率。</p>
<p>在 linux 中，每个 page 的大小是 4KB。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-BASH" data-lang="BASH"><span style="display:flex;"><span>getconf PAGESIZE
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">4096</span>
</span></span></code></pre></div><p>对应的每页在我们的代理里也应该有一个数据结构，来存储数据。这个数据结构就是 <code>page</code>。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Pgid</span> <span style="color:#00a8c8">uint64</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Page</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">id</span>       <span style="color:#75af00">Pgid</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">flags</span>    <span style="color:#00a8c8">uint16</span> <span style="color:#75715e">// page 类型</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">count</span>    <span style="color:#00a8c8">uint16</span> <span style="color:#75715e">// page 中的元素数量</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">overflow</span> <span style="color:#00a8c8">uint32</span> <span style="color:#75715e">// 是否有后序页，如果有，overflow 表示后续页的数量</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">const</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">BranchPageFlag</span>   <span style="color:#111">=</span> <span style="color:#ae81ff">0x01</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">LeafPageFlag</span>     <span style="color:#111">=</span> <span style="color:#ae81ff">0x02</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">MetaPageFlag</span>     <span style="color:#111">=</span> <span style="color:#ae81ff">0x04</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">FreelistPageFlag</span> <span style="color:#111">=</span> <span style="color:#ae81ff">0x10</span> 
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span></code></pre></div><p><code>Page</code> 里面有一个 <code>flags</code> 字段，用来标识这个 page 是什么类型的。boltdb 里面有四种类型的 page, 分别是 分支页（BranchPageFlag）、叶子页（LeafPageFlag）、元数据页（MetaPageFlag）、空闲列表页（FreelistPageFlag）。</p>
<ul>
<li>分支页：由于 boltdb 使用的是 B+ 树，所以分支页用来存储 key 和子节点的指针。</li>
<li>叶子页：叶子页用来存储 key 和 value。</li>
<li>元数据页：元数据页用来存储 boltdb 的元数据，比如 boltdb 的版本号、boltdb 的根节点等。</li>
<li>空闲列表页：由于 boltdb 使用 copy on write，所以当一个 page 被删除的时候，boltdb 并不会立即释放这个 page，而是把这个 page 加入到空闲列表页中，等到需要新的 page 的时候，再从空闲列表页中取出一个 page。</li>
</ul>
<p>在 page 之后会存储对用的结构，比如 meta 或者 freelist。先读取 page 判断自己的结构（定长的：8 + 2 + 2 +4），然后再根据不同的数据类型读取其他的结构（比如BranchPage）。</p>
<p><img src="/images/eebaffa3-116e-40f0-95be-2dfc0ee58bd6.png" alt=""></p>
<h3 id="branchpage--leafpage">BranchPage &amp;&amp; LeafPage</h3>
<p>这两个分别存储 B+ tree 的分支页和叶子页。对应结构为：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// branchPageElement represents a node on a branch page.</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">branchPageElement</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">pos</span>   <span style="color:#00a8c8">uint32</span> <span style="color:#75715e">// 真实数据对应的偏移量</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ksize</span> <span style="color:#00a8c8">uint32</span> <span style="color:#75715e">// key 的大小</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">pgid</span>  <span style="color:#75af00">Pgid</span> <span style="color:#75715e">// 指向 page 的 id</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// leafPageElement represents a node on a leaf page.</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">leafPageElement</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">flags</span> <span style="color:#00a8c8">uint32</span> <span style="color:#75715e">// 是否是一个 bucket</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">pos</span>   <span style="color:#00a8c8">uint32</span> <span style="color:#75715e">// 真实数据对应的偏移量</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ksize</span> <span style="color:#00a8c8">uint32</span> <span style="color:#75715e">// key 的大小</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">vsize</span> <span style="color:#00a8c8">uint32</span> <span style="color:#75715e">// value 的大小</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>对应的存储方式为:</p>
<p><img src="/images/c5206aef-62de-447a-880a-3024a75f4b3d.png" alt=""></p>
<p>从 page 中拿取数据：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">p</span> <span style="color:#f92672">*</span><span style="color:#75af00">Page</span><span style="color:#111">)</span> <span style="color:#75af00">LeafPageElements</span><span style="color:#111">()</span> <span style="color:#111">[]</span><span style="color:#75af00">leafPageElement</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">count</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 从 page 的指针 加上 page 的大小，就是第一个元素的地址</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">data</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">UnsafeAdd</span><span style="color:#111">(</span><span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">(</span><span style="color:#75af00">p</span><span style="color:#111">),</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Sizeof</span><span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">p</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 转换为 slice</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">elems</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Slice</span><span style="color:#111">((</span><span style="color:#f92672">*</span><span style="color:#75af00">leafPageElement</span><span style="color:#111">)(</span><span style="color:#75af00">data</span><span style="color:#111">),</span> <span style="color:#111">int</span><span style="color:#111">(</span><span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">count</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">elems</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">p</span> <span style="color:#f92672">*</span><span style="color:#75af00">Page</span><span style="color:#111">)</span> <span style="color:#75af00">BranchPageElements</span><span style="color:#111">()</span> <span style="color:#111">[]</span><span style="color:#75af00">branchPageElement</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">count</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">data</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">UnsafeAdd</span><span style="color:#111">(</span><span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">(</span><span style="color:#75af00">p</span><span style="color:#111">),</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Sizeof</span><span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">p</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">elems</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Slice</span><span style="color:#111">((</span><span style="color:#f92672">*</span><span style="color:#75af00">branchPageElement</span><span style="color:#111">)(</span><span style="color:#75af00">data</span><span style="color:#111">),</span> <span style="color:#111">int</span><span style="color:#111">(</span><span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">count</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">elems</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="metapage">MetaPage</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Meta</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">magic</span>    <span style="color:#00a8c8">uint32</span> <span style="color:#75715e">// boltdb 的魔数</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">version</span>  <span style="color:#00a8c8">uint32</span> <span style="color:#75715e">// boltdb 的版本</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">pageSize</span> <span style="color:#00a8c8">uint32</span> <span style="color:#75715e">// boltdb 的 page 大小 ，该值和操作系统默认的页大小保持一致</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">flags</span>    <span style="color:#00a8c8">uint32</span> 
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">root</span>     <span style="color:#75af00">InBucket</span> <span style="color:#75715e">// boltdb 的根节点</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">freelist</span> <span style="color:#75af00">Pgid</span>   <span style="color:#75715e">// 空闲页的 id</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">pgid</span>     <span style="color:#75af00">Pgid</span> <span style="color:#75715e">// 当前 page 的 id</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">txid</span>     <span style="color:#75af00">Txid</span> <span style="color:#75715e">// 当前事务的 id</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">checksum</span> <span style="color:#00a8c8">uint64</span> <span style="color:#75715e">// 用作校验的校验和</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>它是如何写到 page 中的和从 page 中读取的呢？</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// 把 meta 写到 page 中</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">m</span> <span style="color:#f92672">*</span><span style="color:#75af00">Meta</span><span style="color:#111">)</span> <span style="color:#75af00">Write</span><span style="color:#111">(</span><span style="color:#75af00">p</span> <span style="color:#f92672">*</span><span style="color:#75af00">Page</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 检查 root bucket 的 pgid 是否有效。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 如果 root.root 的 pgid 大于或等于 m.pgid，这是不合理的，因为这意味着它引用了一个尚未分配的 pgid。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">root</span><span style="color:#111">.</span><span style="color:#75af00">root</span> <span style="color:#f92672">&gt;=</span> <span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">pgid</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Sprintf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;root bucket pgid (%d) above high water mark (%d)&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">root</span><span style="color:#111">.</span><span style="color:#75af00">root</span><span style="color:#111">,</span> <span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">pgid</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	  <span style="color:#75715e">// 检查 freelist 的 pgid 是否有效。</span>
</span></span><span style="display:flex;"><span>	  <span style="color:#75715e">// 如果 freelist 的 pgid 大于或等于 m.pgid 且 freelist 不是 PgidNoFreelist，</span>
</span></span><span style="display:flex;"><span>	  <span style="color:#75715e">// 这同样表示它引用了一个尚未分配的 pgid，这是不合理的。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#00a8c8">if</span> <span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">freelist</span> <span style="color:#f92672">&gt;=</span> <span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">pgid</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">freelist</span> <span style="color:#f92672">!=</span> <span style="color:#75af00">PgidNoFreelist</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Sprintf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;freelist pgid (%d) above high water mark (%d)&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">freelist</span><span style="color:#111">,</span> <span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">pgid</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 指定 pageId 和 page 类型</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">id</span> <span style="color:#111">=</span> <span style="color:#75af00">Pgid</span><span style="color:#111">(</span><span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">txid</span> <span style="color:#f92672">%</span> <span style="color:#ae81ff">2</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">SetFlags</span><span style="color:#111">(</span><span style="color:#75af00">MetaPageFlag</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 计算校验和</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">checksum</span> <span style="color:#111">=</span> <span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">Sum64</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">Copy</span><span style="color:#111">(</span><span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">Meta</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 从 page 中读取 meta</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">p</span> <span style="color:#f92672">*</span><span style="color:#75af00">Page</span><span style="color:#111">)</span> <span style="color:#75af00">Meta</span><span style="color:#111">()</span> <span style="color:#f92672">*</span><span style="color:#75af00">Meta</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">Meta</span><span style="color:#111">)(</span><span style="color:#75af00">UnsafeAdd</span><span style="color:#111">(</span><span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">(</span><span style="color:#75af00">p</span><span style="color:#111">),</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Sizeof</span><span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">p</span><span style="color:#111">)))</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 把 meta 的数据拷贝到 page 中</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">m</span> <span style="color:#f92672">*</span><span style="color:#75af00">Meta</span><span style="color:#111">)</span> <span style="color:#75af00">Copy</span><span style="color:#111">(</span><span style="color:#75af00">dest</span> <span style="color:#f92672">*</span><span style="color:#75af00">Meta</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">*</span><span style="color:#75af00">dest</span> <span style="color:#111">=</span> <span style="color:#f92672">*</span><span style="color:#75af00">m</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 计算校验和</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">m</span> <span style="color:#f92672">*</span><span style="color:#75af00">Meta</span><span style="color:#111">)</span> <span style="color:#75af00">Sum64</span><span style="color:#111">()</span> <span style="color:#00a8c8">uint64</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">var</span> <span style="color:#75af00">h</span> <span style="color:#111">=</span> <span style="color:#75af00">fnv</span><span style="color:#111">.</span><span style="color:#75af00">New64a</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">_</span> <span style="color:#111">=</span> <span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">Write</span><span style="color:#111">((</span><span style="color:#f92672">*</span><span style="color:#111">[</span><span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Offsetof</span><span style="color:#111">(</span><span style="color:#75af00">Meta</span><span style="color:#111">{}.</span><span style="color:#75af00">checksum</span><span style="color:#111">)]</span><span style="color:#00a8c8">byte</span><span style="color:#111">)(</span><span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">(</span><span style="color:#75af00">m</span><span style="color:#111">))[:])</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">Sum64</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="freelistpage">FreelistPage</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">freelist</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 表示 freelist 的类型，可能会有不同的策略或实现。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">freelistType</span> <span style="color:#75af00">FreelistType</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 存储所有已释放且可供分配的页面ID。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">ids</span> <span style="color:#111">[]</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 记录哪个事务ID分配了特定的页面ID。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">allocs</span> <span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">]</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Txid</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 记录即将被释放的页面ID及其所属的事务ID。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">pending</span> <span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Txid</span><span style="color:#111">]</span><span style="color:#f92672">*</span><span style="color:#75af00">txPending</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 快速查找所有空闲和待处理页面ID的缓存。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">cache</span> <span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">]</span><span style="color:#00a8c8">struct</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 按连续页面大小分类的空闲页面，键是连续页面的大小，值是具有相同大小的起始页面ID的集合。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">freemaps</span> <span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#00a8c8">uint64</span><span style="color:#111">]</span><span style="color:#75af00">pidSet</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 正向映射，键是起始页面ID，值是其span大小。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">forwardMap</span> <span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">]</span><span style="color:#00a8c8">uint64</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 反向映射，键是结束页面ID，值是其span大小。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">backwardMap</span> <span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">]</span><span style="color:#00a8c8">uint64</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 空闲页面的计数（基于哈希图的版本）。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">freePagesCount</span> <span style="color:#00a8c8">uint64</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 分配函数，根据提供的事务ID和需求的页面数量分配页面。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">allocate</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">txid</span> <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Txid</span><span style="color:#111">,</span> <span style="color:#75af00">n</span> <span style="color:#00a8c8">int</span><span style="color:#111">)</span> <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 返回当前空闲页面数量的函数。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">free_count</span> <span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#00a8c8">int</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 合并连续空闲页面的函数。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">mergeSpans</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">ids</span> <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgids</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 获取所有空闲页面ID的函数。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">getFreePageIDs</span> <span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#111">[]</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 读取一系列页面ID并初始化 freelist 的函数。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">readIDs</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">pgids</span> <span style="color:#111">[]</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// FreelistType 定义了 freelist 后端的类型，用字符串表示不同的实现策略。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">FreelistType</span> <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 未来的开发计划：</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//  1. 默认改为使用 `FreelistMapType`；</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//  2. 移除 `FreelistArrayType`，不再公开 `FreelistMapType`，</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//     并从 `DB` 和 `Options` 结构体中移除 `FreelistType` 字段。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">const</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// FreelistArrayType 表示 freelist 的后端类型为数组。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 这种类型可能适用于需要按顺序访问空闲页的场景。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">FreelistArrayType</span> <span style="color:#111">=</span> <span style="color:#75af00">FreelistType</span><span style="color:#111">(</span><span style="color:#d88200">&#34;array&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// FreelistMapType 表示 freelist 的后端类型为哈希映射。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 这种类型提供了更快的查找速度，适合于频繁、随机地访问空闲页的情况。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">FreelistMapType</span> <span style="color:#111">=</span> <span style="color:#75af00">FreelistType</span><span style="color:#111">(</span><span style="color:#d88200">&#34;hashmap&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span></code></pre></div><p>把 freelist 写到 page 中：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// write 将空闲和待处理的页面ID写入到 freelist 页面。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 在程序崩溃的事件中，所有待处理的ID都将变成空闲的，因此这些ID都需要被保存到磁盘上。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">f</span> <span style="color:#f92672">*</span><span style="color:#75af00">freelist</span><span style="color:#111">)</span> <span style="color:#75af00">write</span><span style="color:#111">(</span><span style="color:#75af00">p</span> <span style="color:#f92672">*</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Page</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> 	<span style="color:#75715e">// 设置页头中的页类型标识</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">SetFlags</span><span style="color:#111">(</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">FreelistPageFlag</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 获取需要保存的 PageID 数量。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">l</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">count</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">l</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 没有 id 需要保存，直接返回。</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">SetCount</span><span style="color:#111">(</span><span style="color:#111">uint16</span><span style="color:#111">(</span><span style="color:#75af00">l</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#00a8c8">if</span> <span style="color:#75af00">l</span> <span style="color:#111">&lt;</span> <span style="color:#ae81ff">0xFFFF</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 如果数量小于 0xFFFF</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 将 id 数量写入到页头中</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">SetCount</span><span style="color:#111">(</span><span style="color:#111">uint16</span><span style="color:#111">(</span><span style="color:#75af00">l</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 计算指针头</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">data</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">UnsafeAdd</span><span style="color:#111">(</span><span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">(</span><span style="color:#75af00">p</span><span style="color:#111">),</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Sizeof</span><span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">p</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 开辟一个 slice 用来存储 id</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">ids</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Slice</span><span style="color:#111">((</span><span style="color:#f92672">*</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">)(</span><span style="color:#75af00">data</span><span style="color:#111">),</span> <span style="color:#75af00">l</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 将 id 拷贝到 page 中</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">copyall</span><span style="color:#111">(</span><span style="color:#75af00">ids</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 如果数量大于 0xFFFF ，则需要分多个 page 来保存</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 先设置本页的数量为 0xFFFF</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">SetCount</span><span style="color:#111">(</span><span style="color:#ae81ff">0xFFFF</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 计算指针头 </span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">data</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">UnsafeAdd</span><span style="color:#111">(</span><span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">(</span><span style="color:#75af00">p</span><span style="color:#111">),</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Sizeof</span><span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">p</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">ids</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Slice</span><span style="color:#111">((</span><span style="color:#f92672">*</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">)(</span><span style="color:#75af00">data</span><span style="color:#111">),</span> <span style="color:#75af00">l</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 将ID数量存储在第一个元素中</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">ids</span><span style="color:#111">[</span><span style="color:#ae81ff">0</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">(</span><span style="color:#75af00">l</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 将剩余的 id 拷贝到 page 中</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">copyall</span><span style="color:#111">(</span><span style="color:#75af00">ids</span><span style="color:#111">[</span><span style="color:#ae81ff">1</span><span style="color:#111">:])</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// copyall 将所有空闲的ID和所有待处理的ID复制到一个排序后的列表中。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// f.count 返回目标数组 dst 需要的最小长度。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">f</span> <span style="color:#f92672">*</span><span style="color:#75af00">freelist</span><span style="color:#111">)</span> <span style="color:#75af00">copyall</span><span style="color:#111">(</span><span style="color:#75af00">dst</span> <span style="color:#111">[]</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 创建一个切片用于存放待处理的ID，容量预设为待处理ID的数量。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">m</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgids</span><span style="color:#111">,</span> <span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">pending_count</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 遍历所有待处理事务，并将它们的ID加入到切片 m 中。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">txp</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">pending</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">m</span> <span style="color:#111">=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">m</span><span style="color:#111">,</span> <span style="color:#75af00">txp</span><span style="color:#111">.</span><span style="color:#75af00">ids</span><span style="color:#f92672">...</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 对切片 m 进行排序。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">sort</span><span style="color:#111">.</span><span style="color:#75af00">Sort</span><span style="color:#111">(</span><span style="color:#75af00">m</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 将已经空闲的ID和刚排序的待处理ID合并到目标切片 dst 中。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Mergepgids</span><span style="color:#111">(</span><span style="color:#75af00">dst</span><span style="color:#111">,</span> <span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">getFreePageIDs</span><span style="color:#111">(),</span> <span style="color:#75af00">m</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Mergepgids 将两个已排序列表 a 和 b 的并集复制到 dst 中。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 如果 dst 的长度不足以容纳结果，会触发 panic。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">Mergepgids</span><span style="color:#111">(</span><span style="color:#75af00">dst</span><span style="color:#111">,</span> <span style="color:#75af00">a</span><span style="color:#111">,</span> <span style="color:#75af00">b</span> <span style="color:#75af00">Pgids</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 检查目标切片 dst 是否足够大以容纳 a 和 b 的所有元素。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">dst</span><span style="color:#111">)</span> <span style="color:#111">&lt;</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">a</span><span style="color:#111">)</span><span style="color:#f92672">+</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">b</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;mergepgids bad len %d &lt; %d + %d&#34;</span><span style="color:#111">,</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">dst</span><span style="color:#111">),</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">a</span><span style="color:#111">),</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">b</span><span style="color:#111">)))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 如果其中一个列表为空，则直接将另一个列表复制到 dst 中。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">a</span><span style="color:#111">)</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">copy</span><span style="color:#111">(</span><span style="color:#75af00">dst</span><span style="color:#111">,</span> <span style="color:#75af00">b</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">b</span><span style="color:#111">)</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">copy</span><span style="color:#111">(</span><span style="color:#75af00">dst</span><span style="color:#111">,</span> <span style="color:#75af00">a</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 初始化一个切片 merged 来存储最终合并的结果。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">merged</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">dst</span><span style="color:#111">[:</span><span style="color:#ae81ff">0</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 确定哪个列表的起始值更小，并将其设为 lead，另一个设为 follow。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">lead</span><span style="color:#111">,</span> <span style="color:#75af00">follow</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">a</span><span style="color:#111">,</span> <span style="color:#75af00">b</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">b</span><span style="color:#111">[</span><span style="color:#ae81ff">0</span><span style="color:#111">]</span> <span style="color:#111">&lt;</span> <span style="color:#75af00">a</span><span style="color:#111">[</span><span style="color:#ae81ff">0</span><span style="color:#111">]</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">lead</span><span style="color:#111">,</span> <span style="color:#75af00">follow</span> <span style="color:#111">=</span> <span style="color:#75af00">b</span><span style="color:#111">,</span> <span style="color:#75af00">a</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 循环合并，直到 lead 为空。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">for</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">lead</span><span style="color:#111">)</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 合并 lead 中所有小于 follow[0] 的元素。</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">n</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">sort</span><span style="color:#111">.</span><span style="color:#75af00">Search</span><span style="color:#111">(</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">lead</span><span style="color:#111">),</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">i</span> <span style="color:#00a8c8">int</span><span style="color:#111">)</span> <span style="color:#00a8c8">bool</span> <span style="color:#111">{</span> <span style="color:#00a8c8">return</span> <span style="color:#75af00">lead</span><span style="color:#111">[</span><span style="color:#75af00">i</span><span style="color:#111">]</span> <span style="color:#111">&gt;</span> <span style="color:#75af00">follow</span><span style="color:#111">[</span><span style="color:#ae81ff">0</span><span style="color:#111">]</span> <span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">merged</span> <span style="color:#111">=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">merged</span><span style="color:#111">,</span> <span style="color:#75af00">lead</span><span style="color:#111">[:</span><span style="color:#75af00">n</span><span style="color:#111">]</span><span style="color:#f92672">...</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#75af00">n</span> <span style="color:#f92672">&gt;=</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">lead</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">break</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 交换 lead 和 follow，继续合并过程。</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">lead</span><span style="color:#111">,</span> <span style="color:#75af00">follow</span> <span style="color:#111">=</span> <span style="color:#75af00">follow</span><span style="color:#111">,</span> <span style="color:#75af00">lead</span><span style="color:#111">[</span><span style="color:#75af00">n</span><span style="color:#111">:]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 将剩余的 follow 元素加入到 merged 中。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">_</span> <span style="color:#111">=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">merged</span><span style="color:#111">,</span> <span style="color:#75af00">follow</span><span style="color:#f92672">...</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>从 page 中读取 freelist：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// read 从 freelist 页面读取页面ID。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">f</span> <span style="color:#f92672">*</span><span style="color:#75af00">freelist</span><span style="color:#111">)</span> <span style="color:#75af00">read</span><span style="color:#111">(</span><span style="color:#75af00">p</span> <span style="color:#f92672">*</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Page</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 首先检查是否为 freelist 页面，如果不是则抛出错误。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">IsFreelistPage</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Sprintf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;invalid freelist page: %d, page type is %s&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">Id</span><span style="color:#111">(),</span> <span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">Typ</span><span style="color:#111">()))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 从页面获取 freelist 页面的ID列表。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">ids</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">FreelistPageIds</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 如果获取的ID列表为空，将 f.ids 设置为 nil，表示没有空闲页面。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">ids</span><span style="color:#111">)</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">ids</span> <span style="color:#111">=</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 如果ID列表不为空，则创建一个新切片并复制这些ID，以避免直接修改原始页面数据。</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">idsCopy</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">([]</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">,</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">ids</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">copy</span><span style="color:#111">(</span><span style="color:#75af00">idsCopy</span><span style="color:#111">,</span> <span style="color:#75af00">ids</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 确保复制的ID列表是排序的。</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">sort</span><span style="color:#111">.</span><span style="color:#75af00">Sort</span><span style="color:#111">(</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgids</span><span style="color:#111">(</span><span style="color:#75af00">idsCopy</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 将排序后的ID列表读入 freelist 结构。</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">readIDs</span><span style="color:#111">(</span><span style="color:#75af00">idsCopy</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// hashmapReadIDs 读取输入的 pgids 并初始化 freelist（基于哈希映射的版本）。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">f</span> <span style="color:#f92672">*</span><span style="color:#75af00">freelist</span><span style="color:#111">)</span> <span style="color:#75af00">hashmapReadIDs</span><span style="color:#111">(</span><span style="color:#75af00">pgids</span> <span style="color:#111">[]</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 初始化 freelist。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">init</span><span style="color:#111">(</span><span style="color:#75af00">pgids</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 重建页面缓存。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">reindex</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// reindex 基于可用和待处理的空闲列表重建自由缓存。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">f</span> <span style="color:#f92672">*</span><span style="color:#75af00">freelist</span><span style="color:#111">)</span> <span style="color:#75af00">reindex</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 获取所有空闲页面ID。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">ids</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">getFreePageIDs</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 创建一个新的缓存映射。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">cache</span> <span style="color:#111">=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">]</span><span style="color:#00a8c8">struct</span><span style="color:#111">{},</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">ids</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 将所有空闲ID添加到缓存中。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">id</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">ids</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">cache</span><span style="color:#111">[</span><span style="color:#75af00">id</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#00a8c8">struct</span><span style="color:#111">{}{}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 将所有待处理的空闲ID也添加到缓存中。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">txp</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">pending</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">pendingID</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">txp</span><span style="color:#111">.</span><span style="color:#75af00">ids</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">cache</span><span style="color:#111">[</span><span style="color:#75af00">pendingID</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#00a8c8">struct</span><span style="color:#111">{}{}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>分配页：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// hashmapAllocate 根据传入的事务ID和请求的页面数量，分配页面。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">f</span> <span style="color:#f92672">*</span><span style="color:#75af00">freelist</span><span style="color:#111">)</span> <span style="color:#75af00">hashmapAllocate</span><span style="color:#111">(</span><span style="color:#75af00">txid</span> <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Txid</span><span style="color:#111">,</span> <span style="color:#75af00">n</span> <span style="color:#00a8c8">int</span><span style="color:#111">)</span> <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">n</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 如果请求的页面数量为0，则直接返回0，表示没有分配任何页面。</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 检查是否存在完全匹配的空闲span。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">bm</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">freemaps</span><span style="color:#111">[</span><span style="color:#111">uint64</span><span style="color:#111">(</span><span style="color:#75af00">n</span><span style="color:#111">)];</span> <span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">for</span> <span style="color:#75af00">pid</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">bm</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 移除这个span。</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">delSpan</span><span style="color:#111">(</span><span style="color:#75af00">pid</span><span style="color:#111">,</span> <span style="color:#111">uint64</span><span style="color:#111">(</span><span style="color:#75af00">n</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 记录这个页面ID被哪个事务分配。</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">allocs</span><span style="color:#111">[</span><span style="color:#75af00">pid</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#75af00">txid</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 从缓存中移除已分配的页面。</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">for</span> <span style="color:#75af00">i</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">(</span><span style="color:#ae81ff">0</span><span style="color:#111">);</span> <span style="color:#75af00">i</span> <span style="color:#111">&lt;</span> <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">(</span><span style="color:#75af00">n</span><span style="color:#111">);</span> <span style="color:#75af00">i</span><span style="color:#f92672">++</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#111">delete</span><span style="color:#111">(</span><span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">cache</span><span style="color:#111">,</span> <span style="color:#75af00">pid</span><span style="color:#f92672">+</span><span style="color:#75af00">i</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#75af00">pid</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 在映射中查找大于请求大小的更大span。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">size</span><span style="color:#111">,</span> <span style="color:#75af00">bm</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">freemaps</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">size</span> <span style="color:#111">&lt;</span> <span style="color:#111">uint64</span><span style="color:#111">(</span><span style="color:#75af00">n</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">continue</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">for</span> <span style="color:#75af00">pid</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">bm</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 移除找到的大span。</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">delSpan</span><span style="color:#111">(</span><span style="color:#75af00">pid</span><span style="color:#111">,</span> <span style="color:#75af00">size</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 记录页面分配。</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">allocs</span><span style="color:#111">[</span><span style="color:#75af00">pid</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#75af00">txid</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 计算剩余的span大小，并添加回 freelist。</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">remain</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">size</span> <span style="color:#f92672">-</span> <span style="color:#111">uint64</span><span style="color:#111">(</span><span style="color:#75af00">n</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">addSpan</span><span style="color:#111">(</span><span style="color:#75af00">pid</span><span style="color:#f92672">+</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">(</span><span style="color:#75af00">n</span><span style="color:#111">),</span> <span style="color:#75af00">remain</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 从缓存中移除已分配的页面。</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">for</span> <span style="color:#75af00">i</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">(</span><span style="color:#ae81ff">0</span><span style="color:#111">);</span> <span style="color:#75af00">i</span> <span style="color:#111">&lt;</span> <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">(</span><span style="color:#75af00">n</span><span style="color:#111">);</span> <span style="color:#75af00">i</span><span style="color:#f92672">++</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#111">delete</span><span style="color:#111">(</span><span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">cache</span><span style="color:#111">,</span> <span style="color:#75af00">pid</span><span style="color:#f92672">+</span><span style="color:#75af00">i</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#75af00">pid</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// delSpan 从 freelist 中删除一个span。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">f</span> <span style="color:#f92672">*</span><span style="color:#75af00">freelist</span><span style="color:#111">)</span> <span style="color:#75af00">delSpan</span><span style="color:#111">(</span><span style="color:#75af00">start</span> <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">,</span> <span style="color:#75af00">size</span> <span style="color:#00a8c8">uint64</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 更新前向和后向映射，移除对应的条目。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">delete</span><span style="color:#111">(</span><span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">forwardMap</span><span style="color:#111">,</span> <span style="color:#75af00">start</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">delete</span><span style="color:#111">(</span><span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">backwardMap</span><span style="color:#111">,</span> <span style="color:#75af00">start</span><span style="color:#f92672">+</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">(</span><span style="color:#75af00">size</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 从 freemaps 中移除span。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">delete</span><span style="color:#111">(</span><span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">freemaps</span><span style="color:#111">[</span><span style="color:#75af00">size</span><span style="color:#111">],</span> <span style="color:#75af00">start</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">freemaps</span><span style="color:#111">[</span><span style="color:#75af00">size</span><span style="color:#111">])</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 如果某个大小的span已经没有其他项，从 freemaps 中完全移除这个大小。</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">delete</span><span style="color:#111">(</span><span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">freemaps</span><span style="color:#111">,</span> <span style="color:#75af00">size</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 更新空闲页面计数。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">freePagesCount</span> <span style="color:#f92672">-=</span> <span style="color:#75af00">size</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// addSpan 向 freelist 中添加一个新的span。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">f</span> <span style="color:#f92672">*</span><span style="color:#75af00">freelist</span><span style="color:#111">)</span> <span style="color:#75af00">addSpan</span><span style="color:#111">(</span><span style="color:#75af00">start</span> <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">,</span> <span style="color:#75af00">size</span> <span style="color:#00a8c8">uint64</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 更新前向和后向映射。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">backwardMap</span><span style="color:#111">[</span><span style="color:#75af00">start</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">+</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">(</span><span style="color:#75af00">size</span><span style="color:#111">)]</span> <span style="color:#111">=</span> <span style="color:#75af00">size</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">forwardMap</span><span style="color:#111">[</span><span style="color:#75af00">start</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#75af00">size</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 确保 freemaps 中存在对应大小的映射。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">freemaps</span><span style="color:#111">[</span><span style="color:#75af00">size</span><span style="color:#111">];</span> <span style="color:#111">!</span><span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">freemaps</span><span style="color:#111">[</span><span style="color:#75af00">size</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">]</span><span style="color:#00a8c8">struct</span><span style="color:#111">{})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 添加新的span到 freemaps。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">freemaps</span><span style="color:#111">[</span><span style="color:#75af00">size</span><span style="color:#111">][</span><span style="color:#75af00">start</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#00a8c8">struct</span><span style="color:#111">{}{}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 更新空闲页面计数。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">freePagesCount</span> <span style="color:#f92672">+=</span> <span style="color:#75af00">size</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="node">Node</h2>
<p>page 的操作跟多都是基于磁盘设计的，在内存中使用这些数据结构并不是很方便。所以 boltdb 会把 page 的数据结构转换为 node 的数据结构，这样在内存中操作就会方便很多。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">node</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">bucket</span>     <span style="color:#f92672">*</span><span style="color:#75af00">Bucket</span> <span style="color:#75715e">// bucket 的指针</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">isLeaf</span>     <span style="color:#00a8c8">bool</span> <span style="color:#75715e">// 是否是叶子节点</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">unbalanced</span> <span style="color:#00a8c8">bool</span> <span style="color:#75715e">// 是否平衡</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">spilled</span>    <span style="color:#00a8c8">bool</span> <span style="color:#75715e">// 是否溢出</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">key</span>        <span style="color:#111">[]</span><span style="color:#00a8c8">byte</span> <span style="color:#75715e">// 该 node 的起始 key</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">pgid</span>       <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span> <span style="color:#75715e">// 该 node 对应的 page id</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">parent</span>     <span style="color:#f92672">*</span><span style="color:#75af00">node</span> <span style="color:#75715e">// 父节点</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">children</span>   <span style="color:#75af00">nodes</span> <span style="color:#75715e">// 子节点</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">inodes</span>     <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Inodes</span> <span style="color:#75715e">// 存储键值对的结构体数组</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Inode</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">flags</span> <span style="color:#00a8c8">uint32</span> <span style="color:#75715e">// 用于 leaf node 是否是一个 bucket （subbucket）</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">pgid</span>  <span style="color:#75af00">Pgid</span>	<span style="color:#75715e">// 用于 branch node, 子节点的 page id</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">key</span>   <span style="color:#111">[]</span><span style="color:#00a8c8">byte</span> <span style="color:#75715e">// key</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">value</span> <span style="color:#111">[]</span><span style="color:#00a8c8">byte</span> <span style="color:#75715e">// value</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Inodes</span> <span style="color:#111">[]</span><span style="color:#75af00">Inode</span>
</span></span></code></pre></div><h3 id="page-to-node">page to node</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">n</span> <span style="color:#f92672">*</span><span style="color:#75af00">node</span><span style="color:#111">)</span> <span style="color:#75af00">read</span><span style="color:#111">(</span><span style="color:#75af00">p</span> <span style="color:#f92672">*</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Page</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">pgid</span> <span style="color:#111">=</span> <span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">Id</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">isLeaf</span> <span style="color:#111">=</span> <span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">IsLeafPage</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 读取 inodes</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">inodes</span> <span style="color:#111">=</span> <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">ReadInodeFromPage</span><span style="color:#111">(</span><span style="color:#75af00">p</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 保存第一个键，以便在将节点写入到父节点时能够找到这个节点。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">inodes</span><span style="color:#111">)</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">key</span> <span style="color:#111">=</span> <span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">inodes</span><span style="color:#111">[</span><span style="color:#ae81ff">0</span><span style="color:#111">].</span><span style="color:#75af00">Key</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Assert</span><span style="color:#111">(</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">key</span><span style="color:#111">)</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;read: zero-length node key&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">key</span> <span style="color:#111">=</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">ReadInodeFromPage</span><span style="color:#111">(</span><span style="color:#75af00">p</span> <span style="color:#f92672">*</span><span style="color:#75af00">Page</span><span style="color:#111">)</span> <span style="color:#75af00">Inodes</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">inodes</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#75af00">Inodes</span><span style="color:#111">,</span> <span style="color:#111">int</span><span style="color:#111">(</span><span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">Count</span><span style="color:#111">()))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">isLeaf</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">IsLeafPage</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span><span style="color:#111">;</span> <span style="color:#75af00">i</span> <span style="color:#111">&lt;</span> <span style="color:#111">int</span><span style="color:#111">(</span><span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">Count</span><span style="color:#111">());</span> <span style="color:#75af00">i</span><span style="color:#f92672">++</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">inode</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">inodes</span><span style="color:#111">[</span><span style="color:#75af00">i</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">isLeaf</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 转换为 leafPageElement 结构</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">elem</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">LeafPageElement</span><span style="color:#111">(</span><span style="color:#111">uint16</span><span style="color:#111">(</span><span style="color:#75af00">i</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">inode</span><span style="color:#111">.</span><span style="color:#75af00">SetFlags</span><span style="color:#111">(</span><span style="color:#75af00">elem</span><span style="color:#111">.</span><span style="color:#75af00">Flags</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">inode</span><span style="color:#111">.</span><span style="color:#75af00">SetKey</span><span style="color:#111">(</span><span style="color:#75af00">elem</span><span style="color:#111">.</span><span style="color:#75af00">Key</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">inode</span><span style="color:#111">.</span><span style="color:#75af00">SetValue</span><span style="color:#111">(</span><span style="color:#75af00">elem</span><span style="color:#111">.</span><span style="color:#75af00">Value</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 转换为 branchPageElement 结构</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">elem</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">BranchPageElement</span><span style="color:#111">(</span><span style="color:#111">uint16</span><span style="color:#111">(</span><span style="color:#75af00">i</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">inode</span><span style="color:#111">.</span><span style="color:#75af00">SetPgid</span><span style="color:#111">(</span><span style="color:#75af00">elem</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">inode</span><span style="color:#111">.</span><span style="color:#75af00">SetKey</span><span style="color:#111">(</span><span style="color:#75af00">elem</span><span style="color:#111">.</span><span style="color:#75af00">Key</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">Assert</span><span style="color:#111">(</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">inode</span><span style="color:#111">.</span><span style="color:#75af00">Key</span><span style="color:#111">())</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;read: zero-length inode key&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">inodes</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="node-to-page">node to page</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// write writes the items onto one or more pages.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// The page should have p.id (might be 0 for meta or bucket-inline page) and p.overflow set</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// and the rest should be zeroed.</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">n</span> <span style="color:#f92672">*</span><span style="color:#75af00">node</span><span style="color:#111">)</span> <span style="color:#75af00">write</span><span style="color:#111">(</span><span style="color:#75af00">p</span> <span style="color:#f92672">*</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Page</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Assert</span><span style="color:#111">(</span><span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">Count</span><span style="color:#111">()</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">Flags</span><span style="color:#111">()</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;node cannot be written into a not empty page&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Initialize page.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">isLeaf</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">SetFlags</span><span style="color:#111">(</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">LeafPageFlag</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">SetFlags</span><span style="color:#111">(</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">BranchPageFlag</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">inodes</span><span style="color:#111">)</span> <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0xFFFF</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Sprintf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;inode overflow: %d (pgid=%d)&#34;</span><span style="color:#111">,</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">inodes</span><span style="color:#111">),</span> <span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">Id</span><span style="color:#111">()))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">SetCount</span><span style="color:#111">(</span><span style="color:#111">uint16</span><span style="color:#111">(</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">inodes</span><span style="color:#111">)))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Stop here if there are no items to write.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">Count</span><span style="color:#111">()</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 将node的inodes写入page</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">WriteInodeToPage</span><span style="color:#111">(</span><span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">inodes</span><span style="color:#111">,</span> <span style="color:#75af00">p</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// DEBUG ONLY: n.dump()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">WriteInodeToPage</span><span style="color:#111">(</span><span style="color:#75af00">inodes</span> <span style="color:#75af00">Inodes</span><span style="color:#111">,</span> <span style="color:#75af00">p</span> <span style="color:#f92672">*</span><span style="color:#75af00">Page</span><span style="color:#111">)</span> <span style="color:#00a8c8">uint32</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 计算写入的初始偏移量。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">off</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Sizeof</span><span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">p</span><span style="color:#111">)</span> <span style="color:#f92672">+</span> <span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">PageElementSize</span><span style="color:#111">()</span><span style="color:#f92672">*</span><span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">inodes</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">isLeaf</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">IsLeafPage</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">i</span><span style="color:#111">,</span> <span style="color:#75af00">item</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">inodes</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">Assert</span><span style="color:#111">(</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">item</span><span style="color:#111">.</span><span style="color:#75af00">Key</span><span style="color:#111">())</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;write: zero-length inode key&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 创建一个足够大小的切片来存放键和值。</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">sz</span> <span style="color:#f92672">:=</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">item</span><span style="color:#111">.</span><span style="color:#75af00">Key</span><span style="color:#111">())</span> <span style="color:#f92672">+</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">item</span><span style="color:#111">.</span><span style="color:#75af00">Value</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">b</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">UnsafeByteSlice</span><span style="color:#111">(</span><span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">(</span><span style="color:#75af00">p</span><span style="color:#111">),</span> <span style="color:#75af00">off</span><span style="color:#111">,</span> <span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#75af00">sz</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">off</span> <span style="color:#f92672">+=</span> <span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">sz</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Write the page element.</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">isLeaf</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">elem</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">LeafPageElement</span><span style="color:#111">(</span><span style="color:#111">uint16</span><span style="color:#111">(</span><span style="color:#75af00">i</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">elem</span><span style="color:#111">.</span><span style="color:#75af00">SetPos</span><span style="color:#111">(</span><span style="color:#111">uint32</span><span style="color:#111">(</span><span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">b</span><span style="color:#111">[</span><span style="color:#ae81ff">0</span><span style="color:#111">]))</span> <span style="color:#f92672">-</span> <span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">(</span><span style="color:#75af00">elem</span><span style="color:#111">))))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">elem</span><span style="color:#111">.</span><span style="color:#75af00">SetFlags</span><span style="color:#111">(</span><span style="color:#75af00">item</span><span style="color:#111">.</span><span style="color:#75af00">Flags</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">elem</span><span style="color:#111">.</span><span style="color:#75af00">SetKsize</span><span style="color:#111">(</span><span style="color:#111">uint32</span><span style="color:#111">(</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">item</span><span style="color:#111">.</span><span style="color:#75af00">Key</span><span style="color:#111">())))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">elem</span><span style="color:#111">.</span><span style="color:#75af00">SetVsize</span><span style="color:#111">(</span><span style="color:#111">uint32</span><span style="color:#111">(</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">item</span><span style="color:#111">.</span><span style="color:#75af00">Value</span><span style="color:#111">())))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">elem</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">BranchPageElement</span><span style="color:#111">(</span><span style="color:#111">uint16</span><span style="color:#111">(</span><span style="color:#75af00">i</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">elem</span><span style="color:#111">.</span><span style="color:#75af00">SetPos</span><span style="color:#111">(</span><span style="color:#111">uint32</span><span style="color:#111">(</span><span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">b</span><span style="color:#111">[</span><span style="color:#ae81ff">0</span><span style="color:#111">]))</span> <span style="color:#f92672">-</span> <span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">(</span><span style="color:#75af00">elem</span><span style="color:#111">))))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">elem</span><span style="color:#111">.</span><span style="color:#75af00">SetKsize</span><span style="color:#111">(</span><span style="color:#111">uint32</span><span style="color:#111">(</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">item</span><span style="color:#111">.</span><span style="color:#75af00">Key</span><span style="color:#111">())))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">elem</span><span style="color:#111">.</span><span style="color:#75af00">SetPgid</span><span style="color:#111">(</span><span style="color:#75af00">item</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">Assert</span><span style="color:#111">(</span><span style="color:#75af00">elem</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">()</span> <span style="color:#f92672">!=</span> <span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">Id</span><span style="color:#111">(),</span> <span style="color:#d88200">&#34;write: circular dependency occurred&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 将键和值数据写入到页面的末尾。</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">l</span> <span style="color:#f92672">:=</span> <span style="color:#111">copy</span><span style="color:#111">(</span><span style="color:#75af00">b</span><span style="color:#111">,</span> <span style="color:#75af00">item</span><span style="color:#111">.</span><span style="color:#75af00">Key</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">copy</span><span style="color:#111">(</span><span style="color:#75af00">b</span><span style="color:#111">[</span><span style="color:#75af00">l</span><span style="color:#111">:],</span> <span style="color:#75af00">item</span><span style="color:#111">.</span><span style="color:#75af00">Value</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#111">uint32</span><span style="color:#111">(</span><span style="color:#75af00">off</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="bucket">Bucket</h2>
<p>Bucket 是 boltdb 的上层的数据结构，每个 bucket 都有一个完成的 B+ 树。将多个 page 联合起来。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Bucket</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">*</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">InBucket</span>             
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">tx</span>       <span style="color:#f92672">*</span><span style="color:#75af00">Tx</span>                    <span style="color:#75715e">// 指向关联事务的指针，将 bucket 与其事务上下文连接。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">buckets</span>  <span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#00a8c8">string</span><span style="color:#111">]</span><span style="color:#f92672">*</span><span style="color:#75af00">Bucket</span>     <span style="color:#75715e">// 子 bucket 缓存；允许通过名字快速访问子 bucket。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">page</span>     <span style="color:#f92672">*</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Page</span>           <span style="color:#75715e">// 内联页面的引用，用于直接存储少量数据或作为数据节点的入口点。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">rootNode</span> <span style="color:#f92672">*</span><span style="color:#75af00">node</span>                  <span style="color:#75715e">// 根页面的已实例化节点，如果 bucket 直接存储在内存中，则此节点将被激活。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">nodes</span>    <span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">]</span><span style="color:#f92672">*</span><span style="color:#75af00">node</span>  <span style="color:#75715e">// 节点缓存，用于快速访问已加载的页面节点，避免重复读取磁盘。</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 设置节点分裂时的填充阈值。默认情况下，bucket 将填充至 50%，</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 但如果你知道你的写入工作负载主要是追加操作，提高这个比例可能会有用。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    // 这个设置不会跨事务持久化，因此每个事务都必须设置它。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">FillPercent</span> <span style="color:#00a8c8">float64</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">InBucket</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">root</span>     <span style="color:#75af00">Pgid</span>   <span style="color:#75715e">// bucket 根级页面的页面ID。如果 bucket 是内联的，则此值为 0。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">sequence</span> <span style="color:#00a8c8">uint64</span> <span style="color:#75715e">// 单调递增的序列号，用于 NextSequence() 函数。</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>Bucket 有可能是 node，也可能是 page。查找某页面的键值对时，首先检查 Bucket.nodes 缓存是否有对应的 node，如果没有，再从 page 中查找。
Bucket.FillPercent 记录 node 的填充百分比。当 node 的已用空间超过其容量的某个百分比后，节点必须分裂，以减少在 B+ Tree 中插入键值对时触发再平衡的概率。默认值是 50%，仅当大量写入操作在尾部添加时，增大该值才有帮助。</p>
<p>bucket 存储方式：</p>
<p><img src="/images/04c8dda1-ff6f-4ae5-9162-bf31819e9a9c.png" alt=""></p>
<h3 id="遍历-cursor">遍历 cursor</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Cursor</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">bucket</span> <span style="color:#f92672">*</span><span style="color:#75af00">Bucket</span>  
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">stack</span>  <span style="color:#111">[]</span><span style="color:#75af00">elemRef</span> 
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">elemRef</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">page</span>  <span style="color:#f92672">*</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Page</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">node</span>  <span style="color:#f92672">*</span><span style="color:#75af00">node</span>        
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">index</span> <span style="color:#00a8c8">int</span>    
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>cursor 分为三类，定位到某一个元素的位置、在当前位置从前往后找、在当前位置从后往前找。方法为：First、Last、Next、Prev 等。</p>
<h4 id="seek">Seek</h4>
<p>如果该键存在，它会返回该键及其对应的值；如果键不存在，它则返回最近的后续键。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// Seek 方法使用B树搜索将光标移动到给定的键并返回它。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 如果键不存在，则使用下一个键。如果没有更多的键，返回nil。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 返回的键和值只在事务的生命周期内有效。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">Cursor</span><span style="color:#111">)</span> <span style="color:#75af00">Seek</span><span style="color:#111">(</span><span style="color:#75af00">seek</span> <span style="color:#111">[]</span><span style="color:#00a8c8">byte</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#75af00">key</span> <span style="color:#111">[]</span><span style="color:#00a8c8">byte</span><span style="color:#111">,</span> <span style="color:#75af00">value</span> <span style="color:#111">[]</span><span style="color:#00a8c8">byte</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 确保数据库事务没有关闭</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Assert</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">bucket</span><span style="color:#111">.</span><span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">db</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;tx closed&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 调用内部的seek方法，获取键和值</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">k</span><span style="color:#111">,</span> <span style="color:#75af00">v</span><span style="color:#111">,</span> <span style="color:#75af00">flags</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">seek</span><span style="color:#111">(</span><span style="color:#75af00">seek</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 检查是否位于页面的最后一个元素之后，如果是，则移动到下一个元素。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">ref</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">stack</span><span style="color:#111">[</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">stack</span><span style="color:#111">)</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">];</span> <span style="color:#75af00">ref</span><span style="color:#111">.</span><span style="color:#75af00">index</span> <span style="color:#f92672">&gt;=</span> <span style="color:#75af00">ref</span><span style="color:#111">.</span><span style="color:#75af00">count</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">k</span><span style="color:#111">,</span> <span style="color:#75af00">v</span><span style="color:#111">,</span> <span style="color:#75af00">flags</span> <span style="color:#111">=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">next</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 如果k为nil，表示未找到键，返回nil。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">k</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#00a8c8">if</span> <span style="color:#111">(</span><span style="color:#75af00">flags</span> <span style="color:#f92672">&amp;</span> <span style="color:#111">uint32</span><span style="color:#111">(</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">BucketLeafFlag</span><span style="color:#111">))</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 如果是叶子节点，返回键和nil值。</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">k</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 返回找到的键和值。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#75af00">k</span><span style="color:#111">,</span> <span style="color:#75af00">v</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// seek 方法将光标移动到给定的键，并返回该键。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 如果键不存在，则使用下一个键。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">Cursor</span><span style="color:#111">)</span> <span style="color:#75af00">seek</span><span style="color:#111">(</span><span style="color:#75af00">seek</span> <span style="color:#111">[]</span><span style="color:#00a8c8">byte</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#75af00">key</span> <span style="color:#111">[]</span><span style="color:#00a8c8">byte</span><span style="color:#111">,</span> <span style="color:#75af00">value</span> <span style="color:#111">[]</span><span style="color:#00a8c8">byte</span><span style="color:#111">,</span> <span style="color:#75af00">flags</span> <span style="color:#00a8c8">uint32</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 从根页面/节点开始，遍历到正确的页面。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">stack</span> <span style="color:#111">=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">stack</span><span style="color:#111">[:</span><span style="color:#ae81ff">0</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">search</span><span style="color:#111">(</span><span style="color:#75af00">seek</span><span style="color:#111">,</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">bucket</span><span style="color:#111">.</span><span style="color:#75af00">RootPage</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 如果是桶，则返回nil值。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">keyValue</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>search</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// search 方法递归地对给定的页面/节点进行二分搜索，直到找到给定的键。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">Cursor</span><span style="color:#111">)</span> <span style="color:#75af00">search</span><span style="color:#111">(</span><span style="color:#75af00">key</span> <span style="color:#111">[]</span><span style="color:#00a8c8">byte</span><span style="color:#111">,</span> <span style="color:#75af00">pgId</span> <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">p</span><span style="color:#111">,</span> <span style="color:#75af00">n</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">bucket</span><span style="color:#111">.</span><span style="color:#75af00">pageNode</span><span style="color:#111">(</span><span style="color:#75af00">pgId</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">p</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#111">!</span><span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">IsBranchPage</span><span style="color:#111">()</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#111">!</span><span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">IsLeafPage</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Sprintf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;invalid page type: %d: %x&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">Id</span><span style="color:#111">(),</span> <span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">Flags</span><span style="color:#111">()))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">e</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">elemRef</span><span style="color:#111">{</span><span style="color:#75af00">page</span><span style="color:#111">:</span> <span style="color:#75af00">p</span><span style="color:#111">,</span> <span style="color:#75af00">node</span><span style="color:#111">:</span> <span style="color:#75af00">n</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">stack</span> <span style="color:#111">=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">stack</span><span style="color:#111">,</span> <span style="color:#75af00">e</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 如果我们位于叶节点页面上，则在该页面内部继续查找特定节点。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">isLeaf</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">nsearch</span><span style="color:#111">(</span><span style="color:#75af00">key</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 如果是节点，继续在节点内部搜索。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">n</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">searchNode</span><span style="color:#111">(</span><span style="color:#75af00">key</span><span style="color:#111">,</span> <span style="color:#75af00">n</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 如果是页面，继续在页面内部搜索。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">searchPage</span><span style="color:#111">(</span><span style="color:#75af00">key</span><span style="color:#111">,</span> <span style="color:#75af00">p</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">Cursor</span><span style="color:#111">)</span> <span style="color:#75af00">searchNode</span><span style="color:#111">(</span><span style="color:#75af00">key</span> <span style="color:#111">[]</span><span style="color:#00a8c8">byte</span><span style="color:#111">,</span> <span style="color:#75af00">n</span> <span style="color:#f92672">*</span><span style="color:#75af00">node</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">var</span> <span style="color:#75af00">exact</span> <span style="color:#00a8c8">bool</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 使用二分搜索确定键的位置。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">index</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">sort</span><span style="color:#111">.</span><span style="color:#75af00">Search</span><span style="color:#111">(</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">inodes</span><span style="color:#111">),</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">i</span> <span style="color:#00a8c8">int</span><span style="color:#111">)</span> <span style="color:#00a8c8">bool</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">ret</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">bytes</span><span style="color:#111">.</span><span style="color:#75af00">Compare</span><span style="color:#111">(</span><span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">inodes</span><span style="color:#111">[</span><span style="color:#75af00">i</span><span style="color:#111">].</span><span style="color:#75af00">Key</span><span style="color:#111">(),</span> <span style="color:#75af00">key</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#75af00">ret</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75af00">exact</span> <span style="color:#111">=</span> <span style="color:#00a8c8">true</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">ret</span> <span style="color:#f92672">!=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">exact</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">index</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">index</span><span style="color:#f92672">--</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">stack</span><span style="color:#111">[</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">stack</span><span style="color:#111">)</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">].</span><span style="color:#75af00">index</span> <span style="color:#111">=</span> <span style="color:#75af00">index</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 递归搜索到下一页。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">search</span><span style="color:#111">(</span><span style="color:#75af00">key</span><span style="color:#111">,</span> <span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">inodes</span><span style="color:#111">[</span><span style="color:#75af00">index</span><span style="color:#111">].</span><span style="color:#75af00">Pgid</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">Cursor</span><span style="color:#111">)</span> <span style="color:#75af00">searchPage</span><span style="color:#111">(</span><span style="color:#75af00">key</span> <span style="color:#111">[]</span><span style="color:#00a8c8">byte</span><span style="color:#111">,</span> <span style="color:#75af00">p</span> <span style="color:#f92672">*</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Page</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 对页面进行二分搜索以确定正确的范围。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">inodes</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">BranchPageElements</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">var</span> <span style="color:#75af00">exact</span> <span style="color:#00a8c8">bool</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">index</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">sort</span><span style="color:#111">.</span><span style="color:#75af00">Search</span><span style="color:#111">(</span><span style="color:#111">int</span><span style="color:#111">(</span><span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">Count</span><span style="color:#111">()),</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">i</span> <span style="color:#00a8c8">int</span><span style="color:#111">)</span> <span style="color:#00a8c8">bool</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">ret</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">bytes</span><span style="color:#111">.</span><span style="color:#75af00">Compare</span><span style="color:#111">(</span><span style="color:#75af00">inodes</span><span style="color:#111">[</span><span style="color:#75af00">i</span><span style="color:#111">].</span><span style="color:#75af00">Key</span><span style="color:#111">(),</span> <span style="color:#75af00">key</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#75af00">ret</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75af00">exact</span> <span style="color:#111">=</span> <span style="color:#00a8c8">true</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">ret</span> <span style="color:#f92672">!=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">exact</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">index</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">index</span><span style="color:#f92672">--</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">stack</span><span style="color:#111">[</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">stack</span><span style="color:#111">)</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">].</span><span style="color:#75af00">index</span> <span style="color:#111">=</span> <span style="color:#75af00">index</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 递归搜索到下一页。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">search</span><span style="color:#111">(</span><span style="color:#75af00">key</span><span style="color:#111">,</span> <span style="color:#75af00">inodes</span><span style="color:#111">[</span><span style="color:#75af00">index</span><span style="color:#111">].</span><span style="color:#75af00">Pgid</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">Cursor</span><span style="color:#111">)</span> <span style="color:#75af00">nsearch</span><span style="color:#111">(</span><span style="color:#75af00">key</span> <span style="color:#111">[]</span><span style="color:#00a8c8">byte</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">e</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">stack</span><span style="color:#111">[</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">stack</span><span style="color:#111">)</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">p</span><span style="color:#111">,</span> <span style="color:#75af00">n</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">page</span><span style="color:#111">,</span> <span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">node</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// If we have a node then search its inodes.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">n</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">index</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">sort</span><span style="color:#111">.</span><span style="color:#75af00">Search</span><span style="color:#111">(</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">inodes</span><span style="color:#111">),</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">i</span> <span style="color:#00a8c8">int</span><span style="color:#111">)</span> <span style="color:#00a8c8">bool</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#75af00">bytes</span><span style="color:#111">.</span><span style="color:#75af00">Compare</span><span style="color:#111">(</span><span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">inodes</span><span style="color:#111">[</span><span style="color:#75af00">i</span><span style="color:#111">].</span><span style="color:#75af00">Key</span><span style="color:#111">(),</span> <span style="color:#75af00">key</span><span style="color:#111">)</span> <span style="color:#f92672">!=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">index</span> <span style="color:#111">=</span> <span style="color:#75af00">index</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// If we have a page then search its leaf elements.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">inodes</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">LeafPageElements</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">index</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">sort</span><span style="color:#111">.</span><span style="color:#75af00">Search</span><span style="color:#111">(</span><span style="color:#111">int</span><span style="color:#111">(</span><span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">Count</span><span style="color:#111">()),</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">i</span> <span style="color:#00a8c8">int</span><span style="color:#111">)</span> <span style="color:#00a8c8">bool</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">bytes</span><span style="color:#111">.</span><span style="color:#75af00">Compare</span><span style="color:#111">(</span><span style="color:#75af00">inodes</span><span style="color:#111">[</span><span style="color:#75af00">i</span><span style="color:#111">].</span><span style="color:#75af00">Key</span><span style="color:#111">(),</span> <span style="color:#75af00">key</span><span style="color:#111">)</span> <span style="color:#f92672">!=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">index</span> <span style="color:#111">=</span> <span style="color:#75af00">index</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>keyValue</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">Cursor</span><span style="color:#111">)</span> <span style="color:#75af00">keyValue</span><span style="color:#111">()</span> <span style="color:#111">([]</span><span style="color:#00a8c8">byte</span><span style="color:#111">,</span> <span style="color:#111">[]</span><span style="color:#00a8c8">byte</span><span style="color:#111">,</span> <span style="color:#00a8c8">uint32</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ref</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">stack</span><span style="color:#111">[</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">stack</span><span style="color:#111">)</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 如果索引超出范围，则返回nil。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">ref</span><span style="color:#111">.</span><span style="color:#75af00">count</span><span style="color:#111">()</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">||</span> <span style="color:#75af00">ref</span><span style="color:#111">.</span><span style="color:#75af00">index</span> <span style="color:#f92672">&gt;=</span> <span style="color:#75af00">ref</span><span style="color:#111">.</span><span style="color:#75af00">count</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//  从node中获取键值对。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">ref</span><span style="color:#111">.</span><span style="color:#75af00">node</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">inode</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">ref</span><span style="color:#111">.</span><span style="color:#75af00">node</span><span style="color:#111">.</span><span style="color:#75af00">inodes</span><span style="color:#111">[</span><span style="color:#75af00">ref</span><span style="color:#111">.</span><span style="color:#75af00">index</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">inode</span><span style="color:#111">.</span><span style="color:#75af00">Key</span><span style="color:#111">(),</span> <span style="color:#75af00">inode</span><span style="color:#111">.</span><span style="color:#75af00">Value</span><span style="color:#111">(),</span> <span style="color:#75af00">inode</span><span style="color:#111">.</span><span style="color:#75af00">Flags</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 从 page 中获取键值对。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">elem</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">ref</span><span style="color:#111">.</span><span style="color:#75af00">page</span><span style="color:#111">.</span><span style="color:#75af00">LeafPageElement</span><span style="color:#111">(</span><span style="color:#111">uint16</span><span style="color:#111">(</span><span style="color:#75af00">ref</span><span style="color:#111">.</span><span style="color:#75af00">index</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">elem</span><span style="color:#111">.</span><span style="color:#75af00">Key</span><span style="color:#111">(),</span> <span style="color:#75af00">elem</span><span style="color:#111">.</span><span style="color:#75af00">Value</span><span style="color:#111">(),</span> <span style="color:#75af00">elem</span><span style="color:#111">.</span><span style="color:#75af00">Flags</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="创建-bucket-如果不存在">创建 bucket 如果不存在</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// CreateBucketIfNotExists 如果指定的存储桶不存在，则创建它，并返回一个对它的引用。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 如果存储桶名为空或太长，则返回错误。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 存储桶实例仅在事务的生命周期内有效。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">b</span> <span style="color:#f92672">*</span><span style="color:#75af00">Bucket</span><span style="color:#111">)</span> <span style="color:#75af00">CreateBucketIfNotExists</span><span style="color:#111">(</span><span style="color:#75af00">key</span> <span style="color:#111">[]</span><span style="color:#00a8c8">byte</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#75af00">rb</span> <span style="color:#f92672">*</span><span style="color:#75af00">Bucket</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 如果日志不是被丢弃，记录创建存储桶的尝试。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">lg</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">Logger</span><span style="color:#111">();</span> <span style="color:#75af00">lg</span> <span style="color:#f92672">!=</span> <span style="color:#75af00">discardLogger</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">lg</span><span style="color:#111">.</span><span style="color:#75af00">Debugf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Creating bucket if not exist %q&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">key</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">defer</span> <span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75af00">lg</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Creating bucket if not exist %q failed: %v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">key</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75af00">lg</span><span style="color:#111">.</span><span style="color:#75af00">Debugf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Creating bucket if not exist %q successfully&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">key</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 检查数据库是否关闭，检查事务是否可写，检查键名是否为空。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">db</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">errors</span><span style="color:#111">.</span><span style="color:#75af00">ErrTxClosed</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">writable</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">errors</span><span style="color:#111">.</span><span style="color:#75af00">ErrTxNotWritable</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#00a8c8">if</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">key</span><span style="color:#111">)</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">errors</span><span style="color:#111">.</span><span style="color:#75af00">ErrBucketNameRequired</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 使用克隆的键而不是原始键，以避免内存泄漏。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">newKey</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">cloneBytes</span><span style="color:#111">(</span><span style="color:#75af00">key</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 检查键是否已存在。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">buckets</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#75af00">child</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">buckets</span><span style="color:#111">[</span><span style="color:#111">string</span><span style="color:#111">(</span><span style="color:#75af00">newKey</span><span style="color:#111">)];</span> <span style="color:#75af00">child</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">return</span> <span style="color:#75af00">child</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 使用光标寻找正确的位置。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">c</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">Cursor</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">k</span><span style="color:#111">,</span> <span style="color:#75af00">v</span><span style="color:#111">,</span> <span style="color:#75af00">flags</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">seek</span><span style="color:#111">(</span><span style="color:#75af00">newKey</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 如果找到的键相同，检查是否已有相同名字的非存储桶键。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">bytes</span><span style="color:#111">.</span><span style="color:#75af00">Equal</span><span style="color:#111">(</span><span style="color:#75af00">newKey</span><span style="color:#111">,</span> <span style="color:#75af00">k</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#111">(</span><span style="color:#75af00">flags</span> <span style="color:#f92672">&amp;</span> <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">BucketLeafFlag</span><span style="color:#111">)</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">var</span> <span style="color:#75af00">child</span> <span style="color:#111">=</span> <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">openBucket</span><span style="color:#111">(</span><span style="color:#75af00">v</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">if</span> <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">buckets</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">buckets</span><span style="color:#111">[</span><span style="color:#111">string</span><span style="color:#111">(</span><span style="color:#75af00">newKey</span><span style="color:#111">)]</span> <span style="color:#111">=</span> <span style="color:#75af00">child</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">return</span> <span style="color:#75af00">child</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">errors</span><span style="color:#111">.</span><span style="color:#75af00">ErrIncompatibleValue</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 创建空的内联存储桶。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">var</span> <span style="color:#75af00">bucket</span> <span style="color:#111">=</span> <span style="color:#75af00">Bucket</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">InBucket</span><span style="color:#111">:</span>    <span style="color:#f92672">&amp;</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">InBucket</span><span style="color:#111">{},</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">rootNode</span><span style="color:#111">:</span>    <span style="color:#f92672">&amp;</span><span style="color:#75af00">node</span><span style="color:#111">{</span><span style="color:#75af00">isLeaf</span><span style="color:#111">:</span> <span style="color:#00a8c8">true</span><span style="color:#111">},</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">FillPercent</span><span style="color:#111">:</span> <span style="color:#75af00">DefaultFillPercent</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">var</span> <span style="color:#75af00">value</span> <span style="color:#111">=</span> <span style="color:#75af00">bucket</span><span style="color:#111">.</span><span style="color:#75af00">write</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 在当前节点上插入键、值、标志。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">node</span><span style="color:#111">().</span><span style="color:#75af00">put</span><span style="color:#111">(</span><span style="color:#75af00">newKey</span><span style="color:#111">,</span> <span style="color:#75af00">newKey</span><span style="color:#111">,</span> <span style="color:#75af00">value</span><span style="color:#111">,</span> <span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">BucketLeafFlag</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 如果存在内联页面，取消引用它，使得存储桶被视为常规非内联存储桶。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">page</span> <span style="color:#111">=</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 返回新创建的存储桶。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">Bucket</span><span style="color:#111">(</span><span style="color:#75af00">newKey</span><span style="color:#111">),</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// node方法返回光标当前定位的节点。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">Cursor</span><span style="color:#111">)</span> <span style="color:#75af00">node</span><span style="color:#111">()</span> <span style="color:#f92672">*</span><span style="color:#75af00">node</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 确保光标栈长度大于0，否则抛出异常。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Assert</span><span style="color:#111">(</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">stack</span><span style="color:#111">)</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;accessing a node with a zero-length cursor stack&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 如果栈顶是叶子节点，直接返回该节点。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">ref</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">stack</span><span style="color:#111">[</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">stack</span><span style="color:#111">)</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">];</span> <span style="color:#75af00">ref</span><span style="color:#111">.</span><span style="color:#75af00">node</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">ref</span><span style="color:#111">.</span><span style="color:#75af00">isLeaf</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">ref</span><span style="color:#111">.</span><span style="color:#75af00">node</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 从根开始，向下遍历层级结构。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">var</span> <span style="color:#75af00">n</span> <span style="color:#111">=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">stack</span><span style="color:#111">[</span><span style="color:#ae81ff">0</span><span style="color:#111">].</span><span style="color:#75af00">node</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">n</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">n</span> <span style="color:#111">=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">bucket</span><span style="color:#111">.</span><span style="color:#75af00">node</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">stack</span><span style="color:#111">[</span><span style="color:#ae81ff">0</span><span style="color:#111">].</span><span style="color:#75af00">page</span><span style="color:#111">.</span><span style="color:#75af00">Id</span><span style="color:#111">(),</span> <span style="color:#00a8c8">nil</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">ref</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">stack</span><span style="color:#111">[:</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">stack</span><span style="color:#111">)</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">]</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Assert</span><span style="color:#111">(!</span><span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">isLeaf</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;expected branch node&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">n</span> <span style="color:#111">=</span> <span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">childAt</span><span style="color:#111">(</span><span style="color:#75af00">ref</span><span style="color:#111">.</span><span style="color:#75af00">index</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Assert</span><span style="color:#111">(</span><span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">isLeaf</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;expected leaf node&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#75af00">n</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// put方法在节点中插入键值对。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">n</span> <span style="color:#f92672">*</span><span style="color:#75af00">node</span><span style="color:#111">)</span> <span style="color:#75af00">put</span><span style="color:#111">(</span><span style="color:#75af00">oldKey</span><span style="color:#111">,</span> <span style="color:#75af00">newKey</span><span style="color:#111">,</span> <span style="color:#75af00">value</span> <span style="color:#111">[]</span><span style="color:#00a8c8">byte</span><span style="color:#111">,</span> <span style="color:#75af00">pgId</span> <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">,</span> <span style="color:#75af00">flags</span> <span style="color:#00a8c8">uint32</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 检查pgId是否超出限制。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">pgId</span> <span style="color:#f92672">&gt;=</span> <span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">bucket</span><span style="color:#111">.</span><span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">meta</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Sprintf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;pgId (%d) above high water mark (%d)&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">pgId</span><span style="color:#111">,</span> <span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">bucket</span><span style="color:#111">.</span><span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">meta</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">()))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#00a8c8">if</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">oldKey</span><span style="color:#111">)</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#d88200">&#34;put: zero-length old key&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#00a8c8">if</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">newKey</span><span style="color:#111">)</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#d88200">&#34;put: zero-length new key&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 寻找插入的位置。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">index</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">sort</span><span style="color:#111">.</span><span style="color:#75af00">Search</span><span style="color:#111">(</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">inodes</span><span style="color:#111">),</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">i</span> <span style="color:#00a8c8">int</span><span style="color:#111">)</span> <span style="color:#00a8c8">bool</span> <span style="color:#111">{</span> <span style="color:#00a8c8">return</span> <span style="color:#75af00">bytes</span><span style="color:#111">.</span><span style="color:#75af00">Compare</span><span style="color:#111">(</span><span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">inodes</span><span style="color:#111">[</span><span style="color:#75af00">i</span><span style="color:#111">].</span><span style="color:#75af00">Key</span><span style="color:#111">(),</span> <span style="color:#75af00">oldKey</span><span style="color:#111">)</span> <span style="color:#f92672">!=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> <span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 如果没有找到确切匹配，增加容量并移动节点。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">exact</span> <span style="color:#f92672">:=</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">inodes</span><span style="color:#111">)</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">index</span> <span style="color:#111">&lt;</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">inodes</span><span style="color:#111">)</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">bytes</span><span style="color:#111">.</span><span style="color:#75af00">Equal</span><span style="color:#111">(</span><span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">inodes</span><span style="color:#111">[</span><span style="color:#75af00">index</span><span style="color:#111">].</span><span style="color:#75af00">Key</span><span style="color:#111">(),</span> <span style="color:#75af00">oldKey</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">exact</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">inodes</span> <span style="color:#111">=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">inodes</span><span style="color:#111">,</span> <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Inode</span><span style="color:#111">{})</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">copy</span><span style="color:#111">(</span><span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">inodes</span><span style="color:#111">[</span><span style="color:#75af00">index</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span><span style="color:#111">:],</span> <span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">inodes</span><span style="color:#111">[</span><span style="color:#75af00">index</span><span style="color:#111">:])</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 设置inode的属性。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">inode</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">n</span><span style="color:#111">.</span><span style="color:#75af00">inodes</span><span style="color:#111">[</span><span style="color:#75af00">index</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">inode</span><span style="color:#111">.</span><span style="color:#75af00">SetFlags</span><span style="color:#111">(</span><span style="color:#75af00">flags</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">inode</span><span style="color:#111">.</span><span style="color:#75af00">SetKey</span><span style="color:#111">(</span><span style="color:#75af00">newKey</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">inode</span><span style="color:#111">.</span><span style="color:#75af00">SetValue</span><span style="color:#111">(</span><span style="color:#75af00">value</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">inode</span><span style="color:#111">.</span><span style="color:#75af00">SetPgid</span><span style="color:#111">(</span><span style="color:#75af00">pgId</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Assert</span><span style="color:#111">(</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">inode</span><span style="color:#111">.</span><span style="color:#75af00">Key</span><span style="color:#111">())</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;put: zero-length inode key&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Bucket方法通过名称检索嵌套桶。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 如果桶不存在，返回nil。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 返回的桶实例只在事务生命周期内有效。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">b</span> <span style="color:#f92672">*</span><span style="color:#75af00">Bucket</span><span style="color:#111">)</span> <span style="color:#75af00">Bucket</span><span style="color:#111">(</span><span style="color:#75af00">name</span> <span style="color:#111">[]</span><span style="color:#00a8c8">byte</span><span style="color:#111">)</span> <span style="color:#f92672">*</span><span style="color:#75af00">Bucket</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 如果已有桶缓存，则直接返回对应桶。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">buckets</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#75af00">child</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">buckets</span><span style="color:#111">[</span><span style="color:#111">string</span><span style="color:#111">(</span><span style="color:#75af00">name</span><span style="color:#111">)];</span> <span style="color:#75af00">child</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">return</span> <span style="color:#75af00">child</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 移动光标到键位置。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">c</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">Cursor</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">k</span><span style="color:#111">,</span> <span style="color:#75af00">v</span><span style="color:#111">,</span> <span style="color:#75af00">flags</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">seek</span><span style="color:#111">(</span><span style="color:#75af00">name</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 如果键不存在或者不是桶标志，则返回nil。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">bytes</span><span style="color:#111">.</span><span style="color:#75af00">Equal</span><span style="color:#111">(</span><span style="color:#75af00">name</span><span style="color:#111">,</span> <span style="color:#75af00">k</span><span style="color:#111">)</span> <span style="color:#f92672">||</span> <span style="color:#111">(</span><span style="color:#75af00">flags</span> <span style="color:#f92672">&amp;</span> <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">BucketLeafFlag</span><span style="color:#111">)</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 否则创建并缓存桶。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">var</span> <span style="color:#75af00">child</span> <span style="color:#111">=</span> <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">openBucket</span><span style="color:#111">(</span><span style="color:#75af00">v</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">buckets</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">buckets</span><span style="color:#111">[</span><span style="color:#111">string</span><span style="color:#111">(</span><span style="color:#75af00">name</span><span style="color:#111">)]</span> <span style="color:#111">=</span> <span style="color:#75af00">child</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#75af00">child</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="插入-keyvalue">插入 key/value</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">b</span> <span style="color:#f92672">*</span><span style="color:#75af00">Bucket</span><span style="color:#111">)</span> <span style="color:#75af00">Put</span><span style="color:#111">(</span><span style="color:#75af00">key</span> <span style="color:#111">[]</span><span style="color:#00a8c8">byte</span><span style="color:#111">,</span> <span style="color:#75af00">value</span> <span style="color:#111">[]</span><span style="color:#00a8c8">byte</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">lg</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">Logger</span><span style="color:#111">();</span> <span style="color:#75af00">lg</span> <span style="color:#f92672">!=</span> <span style="color:#75af00">discardLogger</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">lg</span><span style="color:#111">.</span><span style="color:#75af00">Debugf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Putting key %q&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">key</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">defer</span> <span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">lg</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Putting key %q failed: %v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">key</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">lg</span><span style="color:#111">.</span><span style="color:#75af00">Debugf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Putting key %q successfully&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">key</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">db</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">errors</span><span style="color:#111">.</span><span style="color:#75af00">ErrTxClosed</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">Writable</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">errors</span><span style="color:#111">.</span><span style="color:#75af00">ErrTxNotWritable</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#00a8c8">if</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">key</span><span style="color:#111">)</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">errors</span><span style="color:#111">.</span><span style="color:#75af00">ErrKeyRequired</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#00a8c8">if</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">key</span><span style="color:#111">)</span> <span style="color:#111">&gt;</span> <span style="color:#75af00">MaxKeySize</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">errors</span><span style="color:#111">.</span><span style="color:#75af00">ErrKeyTooLarge</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#00a8c8">if</span> <span style="color:#111">int64</span><span style="color:#111">(</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">value</span><span style="color:#111">))</span> <span style="color:#111">&gt;</span> <span style="color:#75af00">MaxValueSize</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">errors</span><span style="color:#111">.</span><span style="color:#75af00">ErrValueTooLarge</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">newKey</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">cloneBytes</span><span style="color:#111">(</span><span style="color:#75af00">key</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 移动光标到键位置。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">c</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">Cursor</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">k</span><span style="color:#111">,</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">flags</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">seek</span><span style="color:#111">(</span><span style="color:#75af00">newKey</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Return an error if there is an existing key with a bucket value.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">bytes</span><span style="color:#111">.</span><span style="color:#75af00">Equal</span><span style="color:#111">(</span><span style="color:#75af00">newKey</span><span style="color:#111">,</span> <span style="color:#75af00">k</span><span style="color:#111">)</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#111">(</span><span style="color:#75af00">flags</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">BucketLeafFlag</span><span style="color:#111">)</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">errors</span><span style="color:#111">.</span><span style="color:#75af00">ErrIncompatibleValue</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// gofail: var beforeBucketPut struct{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">node</span><span style="color:#111">().</span><span style="color:#75af00">put</span><span style="color:#111">(</span><span style="color:#75af00">newKey</span><span style="color:#111">,</span> <span style="color:#75af00">newKey</span><span style="color:#111">,</span> <span style="color:#75af00">value</span><span style="color:#111">,</span> <span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#ae81ff">0</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="事务">事务</h2>
<p>BoltDB 支持 ACID 事务，并采用了使用读写锁机制，支持多个读操作与一个写操作并发执行，让应用程序可以更简单的处理复杂操作。每个事务都有一个 txid，其中db.meta.txid 保存了最大的已提交的写事务 id。BoltDB 对写事务和读事务执行不同的 id 分配策略：</p>
<ol>
<li>读事务：txid == db.meta.txid；</li>
<li>写事务：txid == db.meta.txid + 1；</li>
<li>当写事务成功提交时，会更新了db.meta.txid为当前写事务 id。</li>
</ol>
<p>数据库初始化时会将页号为 0 和 1 的两个页面设置为meta页，每个事务会获得一个txid，并选取txid % 2的meta页做为该事务的读取对象，每次写数据后会交替更新meta页。当其中一个出现数据校验不一致时会使用另一个meta页。
BoltDB 的写操作都是在内存中进行，若事务未 commit 时出错，不会对数据库造成影响；若是在 commit 的过程中出错，BoltDB 写入文件的顺序也保证了不会造成影响：因为数据会写在新的 page 中不会覆盖原来的数据，且此时 meta中的信息不发生变化。</p>
<ol>
<li>开始一份写事务时，会拷贝一份 meta数据；</li>
<li>从 rootBucket 开始，遍历 B+ Tree 查找数据位置并修改；</li>
<li>修改操作完成后会进行事务 commit，此时会将数据写入新的 page；</li>
<li>最后更新meta的信息。</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// Tx 代表数据库上的一个只读或读写事务。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 只读事务可用于检索键值和创建光标。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 读写事务可以创建和删除桶以及创建和删除键。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// 重要：必须在使用完事务后提交或回滚事务。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 只有当没有事务在使用页面时，写入者才能回收这些页面。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 长时间运行的读事务可能会导致数据库迅速增长。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Tx</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">writable</span>       <span style="color:#00a8c8">bool</span>           <span style="color:#75715e">// 是否为可写事务</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">managed</span>        <span style="color:#00a8c8">bool</span>           <span style="color:#75715e">// 是否为管理事务</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">db</span>             <span style="color:#f92672">*</span><span style="color:#75af00">DB</span>            <span style="color:#75715e">// 关联的数据库实例</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">meta</span>           <span style="color:#f92672">*</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Meta</span>   <span style="color:#75715e">// 元数据指针</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">root</span>           <span style="color:#75af00">Bucket</span>         <span style="color:#75715e">// 根桶</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">pages</span>          <span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">]</span><span style="color:#f92672">*</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Page</span> <span style="color:#75715e">// 页面映射</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">stats</span>          <span style="color:#75af00">TxStats</span>        <span style="color:#75715e">// 事务统计</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">commitHandlers</span> <span style="color:#111">[]</span><span style="color:#00a8c8">func</span><span style="color:#111">()</span>       <span style="color:#75715e">// 提交处理程序列表</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// WriteFlag 指定写相关方法（如 WriteTo()）的标志。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Tx 使用指定的标志打开数据库文件以复制数据。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	// 默认情况下，此标志未设置，适合主要在内存中的工作负载。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 对于大于可用 RAM 的数据库，可以设置为 syscall.O_DIRECT 来避免淘汰页面缓存。</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">WriteFlag</span> <span style="color:#00a8c8">int</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="begin">Begin</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// Begin 开始一个新事务。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 多个只读事务可以并发使用，但一次只能使用一个写事务。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 启动多个写事务会导致调用阻塞，并序列化直到当前写事务完成。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// 事务不应该彼此依赖。在同一个goroutine中打开一个读事务和一个写事务可能会导致写入者死锁，</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 因为数据库需要定期重新映射自身以应对增长，并且在读事务打开的时候无法进行。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// 如果需要长时间运行的读事务（例如，快照事务），你可能想要将DB.InitialMmapSize设置为足够大的值</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 以避免写事务的潜在阻塞。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// 重要：你必须在完成后关闭只读事务，否则数据库将无法回收旧页面。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">db</span> <span style="color:#f92672">*</span><span style="color:#75af00">DB</span><span style="color:#111">)</span> <span style="color:#75af00">Begin</span><span style="color:#111">(</span><span style="color:#75af00">writable</span> <span style="color:#00a8c8">bool</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#75af00">t</span> <span style="color:#f92672">*</span><span style="color:#75af00">Tx</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">lg</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">Logger</span><span style="color:#111">();</span> <span style="color:#75af00">lg</span> <span style="color:#f92672">!=</span> <span style="color:#75af00">discardLogger</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">lg</span><span style="color:#111">.</span><span style="color:#75af00">Debugf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Starting a new transaction [writable: %t]&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">writable</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">defer</span> <span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">lg</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Starting a new transaction [writable: %t] failed: %v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">writable</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">lg</span><span style="color:#111">.</span><span style="color:#75af00">Debugf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Starting a new transaction [writable: %t] successfully&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">writable</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">writable</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">beginRWTx</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">beginTx</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">db</span> <span style="color:#f92672">*</span><span style="color:#75af00">DB</span><span style="color:#111">)</span> <span style="color:#75af00">beginRWTx</span><span style="color:#111">()</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">Tx</span><span style="color:#111">,</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// If the database was opened with Options.ReadOnly, return an error.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">readOnly</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">berrors</span><span style="color:#111">.</span><span style="color:#75af00">ErrDatabaseReadOnly</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Obtain writer lock. This is released by the transaction when it closes.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// This enforces only one writer transaction at a time.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">rwlock</span><span style="color:#111">.</span><span style="color:#75af00">Lock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Once we have the writer lock then we can lock the meta pages so that</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// we can set up the transaction.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">metalock</span><span style="color:#111">.</span><span style="color:#75af00">Lock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">metalock</span><span style="color:#111">.</span><span style="color:#75af00">Unlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Exit if the database is not open yet.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">opened</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">rwlock</span><span style="color:#111">.</span><span style="color:#75af00">Unlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">berrors</span><span style="color:#111">.</span><span style="color:#75af00">ErrDatabaseNotOpen</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Exit if the database is not correctly mapped.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">data</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">rwlock</span><span style="color:#111">.</span><span style="color:#75af00">Unlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">berrors</span><span style="color:#111">.</span><span style="color:#75af00">ErrInvalidMapping</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Create a transaction associated with the database.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">t</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">Tx</span><span style="color:#111">{</span><span style="color:#75af00">writable</span><span style="color:#111">:</span> <span style="color:#00a8c8">true</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">init</span><span style="color:#111">(</span><span style="color:#75af00">db</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">rwtx</span> <span style="color:#111">=</span> <span style="color:#75af00">t</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">freePages</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">t</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// freePages 释放与已关闭的只读事务关联的任何页面。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">db</span> <span style="color:#f92672">*</span><span style="color:#75af00">DB</span><span style="color:#111">)</span> <span style="color:#75af00">freePages</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">sort</span><span style="color:#111">.</span><span style="color:#75af00">Sort</span><span style="color:#111">(</span><span style="color:#75af00">txsById</span><span style="color:#111">(</span><span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">txs</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">minid</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Txid</span><span style="color:#111">(</span><span style="color:#ae81ff">0xFFFFFFFFFFFFFFFF</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">txs</span><span style="color:#111">)</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">minid</span> <span style="color:#111">=</span> <span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">txs</span><span style="color:#111">[</span><span style="color:#ae81ff">0</span><span style="color:#111">].</span><span style="color:#75af00">meta</span><span style="color:#111">.</span><span style="color:#75af00">Txid</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">minid</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">freelist</span><span style="color:#111">.</span><span style="color:#75af00">release</span><span style="color:#111">(</span><span style="color:#75af00">minid</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">t</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">txs</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">freelist</span><span style="color:#111">.</span><span style="color:#75af00">releaseRange</span><span style="color:#111">(</span><span style="color:#75af00">minid</span><span style="color:#111">,</span> <span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">meta</span><span style="color:#111">.</span><span style="color:#75af00">Txid</span><span style="color:#111">()</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">minid</span> <span style="color:#111">=</span> <span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">meta</span><span style="color:#111">.</span><span style="color:#75af00">Txid</span><span style="color:#111">()</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">freelist</span><span style="color:#111">.</span><span style="color:#75af00">releaseRange</span><span style="color:#111">(</span><span style="color:#75af00">minid</span><span style="color:#111">,</span> <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Txid</span><span style="color:#111">(</span><span style="color:#ae81ff">0xFFFFFFFFFFFFFFFF</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">db</span> <span style="color:#f92672">*</span><span style="color:#75af00">DB</span><span style="color:#111">)</span> <span style="color:#75af00">beginTx</span><span style="color:#111">()</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">Tx</span><span style="color:#111">,</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Lock the meta pages while we initialize the transaction. We obtain</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// the meta lock before the mmap lock because that&#39;s the order that the</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// write transaction will obtain them.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">metalock</span><span style="color:#111">.</span><span style="color:#75af00">Lock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Obtain a read-only lock on the mmap. When the mmap is remapped it will</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// obtain a write lock so all transactions must finish before it can be</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// remapped.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">mmaplock</span><span style="color:#111">.</span><span style="color:#75af00">RLock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Exit if the database is not open yet.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">opened</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">mmaplock</span><span style="color:#111">.</span><span style="color:#75af00">RUnlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">metalock</span><span style="color:#111">.</span><span style="color:#75af00">Unlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">berrors</span><span style="color:#111">.</span><span style="color:#75af00">ErrDatabaseNotOpen</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Exit if the database is not correctly mapped.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">data</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">mmaplock</span><span style="color:#111">.</span><span style="color:#75af00">RUnlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">metalock</span><span style="color:#111">.</span><span style="color:#75af00">Unlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">berrors</span><span style="color:#111">.</span><span style="color:#75af00">ErrInvalidMapping</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Create a transaction associated with the database.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">t</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">Tx</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">init</span><span style="color:#111">(</span><span style="color:#75af00">db</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Keep track of transaction until it closes.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">txs</span> <span style="color:#111">=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">txs</span><span style="color:#111">,</span> <span style="color:#75af00">t</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">n</span> <span style="color:#f92672">:=</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">txs</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Unlock the meta pages.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">metalock</span><span style="color:#111">.</span><span style="color:#75af00">Unlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Update the transaction stats.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">statlock</span><span style="color:#111">.</span><span style="color:#75af00">Lock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">stats</span><span style="color:#111">.</span><span style="color:#75af00">TxN</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">stats</span><span style="color:#111">.</span><span style="color:#75af00">OpenTxN</span> <span style="color:#111">=</span> <span style="color:#75af00">n</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">statlock</span><span style="color:#111">.</span><span style="color:#75af00">Unlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">t</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="commit">Commit</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// Commit 将所有更改写入磁盘，更新元数据页，并关闭事务。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 如果磁盘写入发生错误，或者在只读事务上调用Commit，将返回错误。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">tx</span> <span style="color:#f92672">*</span><span style="color:#75af00">Tx</span><span style="color:#111">)</span> <span style="color:#75af00">Commit</span><span style="color:#111">()</span> <span style="color:#111">(</span><span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">txId</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">ID</span><span style="color:#111">()</span>  <span style="color:#75715e">// 获取事务ID</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">lg</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">Logger</span><span style="color:#111">()</span>  <span style="color:#75715e">// 获取日志记录器</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">lg</span> <span style="color:#f92672">!=</span> <span style="color:#75af00">discardLogger</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">lg</span><span style="color:#111">.</span><span style="color:#75af00">Debugf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Committing transaction %d&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">txId</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">defer</span> <span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75af00">lg</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Committing transaction failed: %v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75af00">lg</span><span style="color:#111">.</span><span style="color:#75af00">Debugf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Committing transaction %d successfully&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">txId</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 检查是否为管理事务，不允许提交。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Assert</span><span style="color:#111">(!</span><span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">managed</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;managed tx commit not allowed&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">db</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">berrors</span><span style="color:#111">.</span><span style="color:#75af00">ErrTxClosed</span>  <span style="color:#75715e">// 事务已关闭错误</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">writable</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">berrors</span><span style="color:#111">.</span><span style="color:#75af00">ErrTxNotWritable</span>  <span style="color:#75715e">// 非写事务错误</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// TODO: 使用向量化I/O写出脏页</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 重新平衡删除后的节点</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">var</span> <span style="color:#75af00">startTime</span> <span style="color:#111">=</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Now</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">root</span><span style="color:#111">.</span><span style="color:#75af00">rebalance</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">stats</span><span style="color:#111">.</span><span style="color:#75af00">GetRebalance</span><span style="color:#111">()</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">stats</span><span style="color:#111">.</span><span style="color:#75af00">IncRebalanceTime</span><span style="color:#111">(</span><span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Since</span><span style="color:#111">(</span><span style="color:#75af00">startTime</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">opgid</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">meta</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">()</span>  <span style="color:#75715e">// 获取旧的页面ID</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 将数据溢出到脏页</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">startTime</span> <span style="color:#111">=</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Now</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">root</span><span style="color:#111">.</span><span style="color:#75af00">spill</span><span style="color:#111">();</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">lg</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;spilling data onto dirty pages failed: %v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">rollback</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">stats</span><span style="color:#111">.</span><span style="color:#75af00">IncSpillTime</span><span style="color:#111">(</span><span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Since</span><span style="color:#111">(</span><span style="color:#75af00">startTime</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 释放旧的根桶</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">meta</span><span style="color:#111">.</span><span style="color:#75af00">RootBucket</span><span style="color:#111">().</span><span style="color:#75af00">SetRootPage</span><span style="color:#111">(</span><span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">root</span><span style="color:#111">.</span><span style="color:#75af00">RootPage</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 释放旧的自由列表，因为提交会写出一个新的自由列表</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">meta</span><span style="color:#111">.</span><span style="color:#75af00">Freelist</span><span style="color:#111">()</span> <span style="color:#f92672">!=</span> <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">PgidNoFreelist</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">freelist</span><span style="color:#111">.</span><span style="color:#75af00">free</span><span style="color:#111">(</span><span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">meta</span><span style="color:#111">.</span><span style="color:#75af00">Txid</span><span style="color:#111">(),</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">page</span><span style="color:#111">(</span><span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">meta</span><span style="color:#111">.</span><span style="color:#75af00">Freelist</span><span style="color:#111">()))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">NoFreelistSync</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">commitFreelist</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75af00">lg</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;committing freelist failed: %v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">meta</span><span style="color:#111">.</span><span style="color:#75af00">SetFreelist</span><span style="color:#111">(</span><span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">PgidNoFreelist</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 如果高水位标记已上移，则尝试扩大数据库</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">meta</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">()</span> <span style="color:#111">&gt;</span> <span style="color:#75af00">opgid</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">grow</span><span style="color:#111">(</span><span style="color:#111">int</span><span style="color:#111">(</span><span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">meta</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">()</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span> <span style="color:#f92672">*</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">pageSize</span><span style="color:#111">);</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75af00">lg</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;growing db size failed, pgid: %d, pagesize: %d, error: %v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">meta</span><span style="color:#111">.</span><span style="color:#75af00">Pgid</span><span style="color:#111">(),</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">pageSize</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">rollback</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 将脏页写入磁盘</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">startTime</span> <span style="color:#111">=</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Now</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">write</span><span style="color:#111">();</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">lg</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;writing data failed: %v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">rollback</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 如果启用了严格模式，则执行一致性检查</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">StrictMode</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">ch</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">Check</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">var</span> <span style="color:#75af00">errs</span> <span style="color:#111">[]</span><span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">for</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75af00">chkErr</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#75af00">ch</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#00a8c8">break</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75af00">errs</span> <span style="color:#111">=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">errs</span><span style="color:#111">,</span> <span style="color:#75af00">chkErr</span><span style="color:#111">.</span><span style="color:#75af00">Error</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">errs</span><span style="color:#111">)</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#d88200">&#34;check fail: &#34;</span> <span style="color:#f92672">+</span> <span style="color:#75af00">strings</span><span style="color:#111">.</span><span style="color:#75af00">Join</span><span style="color:#111">(</span><span style="color:#75af00">errs</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;\n&#34;</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 将元数据写入磁盘</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">writeMeta</span><span style="color:#111">();</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">lg</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;writeMeta failed: %v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">rollback</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">stats</span><span style="color:#111">.</span><span style="color:#75af00">IncWriteTime</span><span style="color:#111">(</span><span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Since</span><span style="color:#111">(</span><span style="color:#75af00">startTime</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 结束事务</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#111">close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 执行提交处理程序，锁已经移除</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">fn</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">commitHandlers</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">fn</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="rollback">Rollback</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// Rollback 关闭事务并忽略所有之前的更新。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 只读事务必须回滚而不是提交。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">tx</span> <span style="color:#f92672">*</span><span style="color:#75af00">Tx</span><span style="color:#111">)</span> <span style="color:#75af00">Rollback</span><span style="color:#111">()</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Assert</span><span style="color:#111">(!</span><span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">managed</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;managed tx rollback not allowed&#34;</span><span style="color:#111">)</span>  <span style="color:#75715e">// 断言此事务不是管理型事务</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">db</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">berrors</span><span style="color:#111">.</span><span style="color:#75af00">ErrTxClosed</span>  <span style="color:#75715e">// 如果数据库已关闭，返回错误</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">nonPhysicalRollback</span><span style="color:#111">()</span>  <span style="color:#75715e">// 执行非物理性回滚</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// nonPhysicalRollback 在用户直接调用Rollback时被调用，在这种情况下，我们不需要从磁盘重新加载自由页面。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">tx</span> <span style="color:#f92672">*</span><span style="color:#75af00">Tx</span><span style="color:#111">)</span> <span style="color:#75af00">nonPhysicalRollback</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">db</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span>  <span style="color:#75715e">// 如果数据库已关闭，直接返回</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">writable</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">freelist</span><span style="color:#111">.</span><span style="color:#75af00">rollback</span><span style="color:#111">(</span><span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">meta</span><span style="color:#111">.</span><span style="color:#75af00">Txid</span><span style="color:#111">())</span>  <span style="color:#75715e">// 如果事务是可写的，回滚自由列表</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#111">close</span><span style="color:#111">()</span>  <span style="color:#75715e">// 关闭事务</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// rollback 从给定的挂起事务中移除页面。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">f</span> <span style="color:#f92672">*</span><span style="color:#75af00">freelist</span><span style="color:#111">)</span> <span style="color:#75af00">rollback</span><span style="color:#111">(</span><span style="color:#75af00">txid</span> <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Txid</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 从缓存中移除页面ID。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">txp</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">pending</span><span style="color:#111">[</span><span style="color:#75af00">txid</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">txp</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span>  <span style="color:#75715e">// 如果没有挂起的事务，直接返回</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">var</span> <span style="color:#75af00">m</span> <span style="color:#75af00">common</span><span style="color:#111">.</span><span style="color:#75af00">Pgids</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">for</span> <span style="color:#75af00">i</span><span style="color:#111">,</span> <span style="color:#75af00">pgid</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">txp</span><span style="color:#111">.</span><span style="color:#75af00">ids</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">delete</span><span style="color:#111">(</span><span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">cache</span><span style="color:#111">,</span> <span style="color:#75af00">pgid</span><span style="color:#111">)</span>  <span style="color:#75715e">// 从缓存中删除页面ID</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">tx</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">txp</span><span style="color:#111">.</span><span style="color:#75af00">alloctx</span><span style="color:#111">[</span><span style="color:#75af00">i</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#75af00">tx</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">continue</span>  <span style="color:#75715e">// 如果未分配事务ID，继续下一个</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#75af00">tx</span> <span style="color:#f92672">!=</span> <span style="color:#75af00">txid</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 如果待释放页面被中断，恢复页面回分配列表。</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">allocs</span><span style="color:#111">[</span><span style="color:#75af00">pgid</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#75af00">tx</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 如果释放的页面由此事务分配，可以安全地丢弃。</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75af00">m</span> <span style="color:#111">=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">m</span><span style="color:#111">,</span> <span style="color:#75af00">pgid</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 从挂起列表中移除页面，并将其标记为由txid分配的自由页面。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">delete</span><span style="color:#111">(</span><span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">pending</span><span style="color:#111">,</span> <span style="color:#75af00">txid</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">f</span><span style="color:#111">.</span><span style="color:#75af00">mergeSpans</span><span style="color:#111">(</span><span style="color:#75af00">m</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="view--update">View &amp;&amp; Update</h2>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// View 在管理的只读事务上下文中执行一个函数。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 从函数返回的任何错误都会从View()方法返回。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// 尝试在函数内手动回滚会导致panic。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">db</span> <span style="color:#f92672">*</span><span style="color:#75af00">DB</span><span style="color:#111">)</span> <span style="color:#75af00">View</span><span style="color:#111">(</span><span style="color:#75af00">fn</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">Tx</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">t</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">Begin</span><span style="color:#111">(</span><span style="color:#00a8c8">false</span><span style="color:#111">)</span>  <span style="color:#75715e">// 开始一个只读事务</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>  <span style="color:#75715e">// 如果无法开始事务，返回错误</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 确保在发生panic的情况下事务能够回滚。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">defer</span> <span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">db</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">rollback</span><span style="color:#111">()</span>  <span style="color:#75715e">// 执行回滚操作</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 标记为管理的事务，以便内部函数不能手动回滚。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">managed</span> <span style="color:#111">=</span> <span style="color:#00a8c8">true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 如果函数返回错误，则传递该错误。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">fn</span><span style="color:#111">(</span><span style="color:#75af00">t</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">managed</span> <span style="color:#111">=</span> <span style="color:#00a8c8">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">_</span> <span style="color:#111">=</span> <span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">Rollback</span><span style="color:#111">()</span>  <span style="color:#75715e">// 执行回滚</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">Rollback</span><span style="color:#111">()</span>  <span style="color:#75715e">// 完成后回滚事务</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Update 在读写管理事务的上下文中执行一个函数。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 如果函数没有返回错误，则提交事务。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 如果返回了错误，则整个事务被回滚。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 从函数返回的任何错误或从提交返回的错误都会从Update()方法返回。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// 尝试在函数内手动提交或回滚将导致panic。</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">db</span> <span style="color:#f92672">*</span><span style="color:#75af00">DB</span><span style="color:#111">)</span> <span style="color:#75af00">Update</span><span style="color:#111">(</span><span style="color:#75af00">fn</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">Tx</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">t</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">Begin</span><span style="color:#111">(</span><span style="color:#00a8c8">true</span><span style="color:#111">)</span>  <span style="color:#75715e">// 开始一个读写事务</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>  <span style="color:#75715e">// 如果无法开始事务，返回错误</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 确保在发生panic的情况下事务能够回滚。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">defer</span> <span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">db</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">rollback</span><span style="color:#111">()</span>  <span style="color:#75715e">// 执行回滚操作</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 标记为管理的事务，以便内部函数不能手动提交。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">managed</span> <span style="color:#111">=</span> <span style="color:#00a8c8">true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 如果函数返回错误，则回滚并返回错误。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">fn</span><span style="color:#111">(</span><span style="color:#75af00">t</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">managed</span> <span style="color:#111">=</span> <span style="color:#00a8c8">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">_</span> <span style="color:#111">=</span> <span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">Rollback</span><span style="color:#111">()</span>  <span style="color:#75715e">// 执行回滚</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">Commit</span><span style="color:#111">()</span>  <span style="color:#75715e">// 无错误时提交事务</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="reference">Reference</h2>
<ul>
<li><a href="https://wingsxdu.com/posts/database/boltdb/">https://wingsxdu.com/posts/database/boltdb/</a></li>
<li><a href="https://jaydenwen123.github.io/boltdb/">https://jaydenwen123.github.io/boltdb/</a></li>
<li><a href="https://youjiali1995.github.io/storage/boltdb/">https://youjiali1995.github.io/storage/boltdb/</a></li>
<li><a href="https://www.cnblogs.com/huxiao-tee/p/4660352.html">https://www.cnblogs.com/huxiao-tee/p/4660352.html</a></li>
</ul>
]]></content:encoded><category>cloud</category><category>boltdb</category><category>etcd</category><category>golang</category><category>数据库</category><category>kubernetes</category><category>源码分析</category><category>事务</category></item><item><title>kubelet 原理分析</title><link>https://daemon365.dev/post/cloud/analysis_of_kubelet_principles/</link><pubDate>Wed, 01 May 2024 12:40:00 +0800</pubDate><guid>https://daemon365.dev/post/cloud/analysis_of_kubelet_principles/</guid><description>&lt;h2 id="reference"&gt;Reference&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="https://atbug.com/kubelet-source-code-analysis/"&gt;https://atbug.com/kubelet-source-code-analysis/&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="kubelet-简介"&gt;kubelet 简介&lt;/h2&gt;
&lt;p&gt;kubernetes 分为控制面和数据面，kubelet 就是数据面最主要的组件，在每个节点上启动，主要负责容器的创建、启停、监控、日志收集等工作。它是一个在每个集群节点上运行的代理，负责确保节点上的容器根据PodSpec（Pod定义文件）正确运行。&lt;/p&gt;
&lt;p&gt;Kubelet执行以下几项重要功能：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Pod生命周期管理：Kubelet根据从API服务器接收到的PodSpecs创建、启动、终止容器。它负责启动Pod中的容器，并确保它们按预期运行。&lt;/li&gt;
&lt;li&gt;节点状态监控：Kubelet定期监控节点和容器的状态，并将状态报告回集群的控制平面。这使得集群中的其他组件能够做出相应的调度决策。&lt;/li&gt;
&lt;li&gt;资源管理：Kubelet负责管理分配给每个Pod的资源。这包括CPU、内存和磁盘存储资源。&lt;/li&gt;
&lt;li&gt;健康检查：Kubelet可以执行容器健康检查，并根据检查结果决定是否需要重启容器。&lt;/li&gt;
&lt;li&gt;与容器运行时的通信：Kubelet与容器运行时（如Docker、containerd等）通信，以管理容器的生命周期。&lt;/li&gt;
&lt;li&gt;秘密和配置管理：Kubelet负责将秘密、配置映射等挂载到Pod的容器中，以便应用程序可以访问这些配置。&lt;/li&gt;
&lt;li&gt;服务发现和负载均衡：尽管Kubelet本身不直接处理服务发现，但它通过设置网络规则和环境变量来支持容器内的服务发现机制。&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="kubelet-架构"&gt;kubelet 架构&lt;/h2&gt;
&lt;p&gt;&lt;img src="https://daemon365.dev/images/52795638-fd1a-4286-bfc7-170869122330.png" alt=""&gt;&lt;/p&gt;
&lt;p&gt;kubelet 的架构由 N 多的组件组成，下面简单介绍下比较重要的几个：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Sync Loop: 这是Kubelet活动的核心，负责同步Pod的状态。同步循环会定期从API服务器获取PodSpecs，并确保容器的当前状态与这些规格相匹配。&lt;/li&gt;
&lt;li&gt;PodConfig: 负责将各个配置源转换成 PodSpecs，可以选择的配置源包括：Kube-apiserver、本地文件、HTTP。&lt;/li&gt;
&lt;li&gt;PLEG(Pod Lifecycle Event Generator)： 负责监测和缓存Pod生命周期事件，如创建、启动或停止容器，然后将这些事件通知 Sync Loop。&lt;/li&gt;
&lt;li&gt;PodWorkers: 负责管理 Pod 的生命周期事件处理。当 Pod 生命周期事件 PLEG 检测到新的事件时，PodWorkers 会被调用来处理这些事件，包括启动新的 Pod、更新现有的 Pod、或者停止和清理不再需要的 Pod。&lt;/li&gt;
&lt;li&gt;PodManager: 存储 Pod 的期望状态，kubelet 服务的不同渠道的 Pod。&lt;/li&gt;
&lt;li&gt;ContainerRuntime: 顾名思义，容器运行时。与遵循 CRI 规范的高级容器运行时进行交互。&lt;/li&gt;
&lt;li&gt;StatsProvider: 提供节点和容器的统计信息，有 cAdvisor 和 CRI 两种实现。&lt;/li&gt;
&lt;li&gt;ProbeManager: 负责执行容器的健康检查，包括 Liveness，Startup 和 Readiness 检查。&lt;/li&gt;
&lt;li&gt;VolumeManager: 负责管理 Pod 的卷，包括挂载和卸载卷。&lt;/li&gt;
&lt;li&gt;ImageManager: 负责管理镜像，包括拉取、删除、镜像 GC 等。&lt;/li&gt;
&lt;li&gt;DeviceManager: 负责管理设备，包括 GPU、RDMA 等。&lt;/li&gt;
&lt;li&gt;PluginManager: PluginManager 运行一组异步循环，根据此节点确定哪些插件需要注册/取消注册并执行。如 CSI 驱动和设备管理器插件（Device Plugin）。&lt;/li&gt;
&lt;li&gt;CertificateManager: 处理证书轮换。&lt;/li&gt;
&lt;li&gt;OOMWatcher: 从系统日志中获取容器的 OOM 日志，将其封装成事件并记录。&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="流程"&gt;流程&lt;/h2&gt;
&lt;p&gt;首先在 &lt;code&gt;cmd/kubelet&lt;/code&gt; 中使用传入命令行参数的方式初始化配置，然后创建 &lt;code&gt;pkg/kubelet&lt;/code&gt; 中的 Bootstrap inferface, kubelet struct 实现了这个接口， 然后调用 &lt;code&gt;Run&lt;/code&gt; 方法启动 kubelet。&lt;/p&gt;</description><content:encoded><![CDATA[<h2 id="reference">Reference</h2>
<ul>
<li><a href="https://atbug.com/kubelet-source-code-analysis/">https://atbug.com/kubelet-source-code-analysis/</a></li>
</ul>
<h2 id="kubelet-简介">kubelet 简介</h2>
<p>kubernetes 分为控制面和数据面，kubelet 就是数据面最主要的组件，在每个节点上启动，主要负责容器的创建、启停、监控、日志收集等工作。它是一个在每个集群节点上运行的代理，负责确保节点上的容器根据PodSpec（Pod定义文件）正确运行。</p>
<p>Kubelet执行以下几项重要功能：</p>
<ul>
<li>Pod生命周期管理：Kubelet根据从API服务器接收到的PodSpecs创建、启动、终止容器。它负责启动Pod中的容器，并确保它们按预期运行。</li>
<li>节点状态监控：Kubelet定期监控节点和容器的状态，并将状态报告回集群的控制平面。这使得集群中的其他组件能够做出相应的调度决策。</li>
<li>资源管理：Kubelet负责管理分配给每个Pod的资源。这包括CPU、内存和磁盘存储资源。</li>
<li>健康检查：Kubelet可以执行容器健康检查，并根据检查结果决定是否需要重启容器。</li>
<li>与容器运行时的通信：Kubelet与容器运行时（如Docker、containerd等）通信，以管理容器的生命周期。</li>
<li>秘密和配置管理：Kubelet负责将秘密、配置映射等挂载到Pod的容器中，以便应用程序可以访问这些配置。</li>
<li>服务发现和负载均衡：尽管Kubelet本身不直接处理服务发现，但它通过设置网络规则和环境变量来支持容器内的服务发现机制。</li>
</ul>
<h2 id="kubelet-架构">kubelet 架构</h2>
<p><img src="/images/52795638-fd1a-4286-bfc7-170869122330.png" alt=""></p>
<p>kubelet 的架构由 N 多的组件组成，下面简单介绍下比较重要的几个：</p>
<ul>
<li>Sync Loop: 这是Kubelet活动的核心，负责同步Pod的状态。同步循环会定期从API服务器获取PodSpecs，并确保容器的当前状态与这些规格相匹配。</li>
<li>PodConfig: 负责将各个配置源转换成 PodSpecs，可以选择的配置源包括：Kube-apiserver、本地文件、HTTP。</li>
<li>PLEG(Pod Lifecycle Event Generator)： 负责监测和缓存Pod生命周期事件，如创建、启动或停止容器，然后将这些事件通知 Sync Loop。</li>
<li>PodWorkers: 负责管理 Pod 的生命周期事件处理。当 Pod 生命周期事件 PLEG 检测到新的事件时，PodWorkers 会被调用来处理这些事件，包括启动新的 Pod、更新现有的 Pod、或者停止和清理不再需要的 Pod。</li>
<li>PodManager: 存储 Pod 的期望状态，kubelet 服务的不同渠道的 Pod。</li>
<li>ContainerRuntime: 顾名思义，容器运行时。与遵循 CRI 规范的高级容器运行时进行交互。</li>
<li>StatsProvider: 提供节点和容器的统计信息，有 cAdvisor 和 CRI 两种实现。</li>
<li>ProbeManager: 负责执行容器的健康检查，包括 Liveness，Startup 和 Readiness 检查。</li>
<li>VolumeManager: 负责管理 Pod 的卷，包括挂载和卸载卷。</li>
<li>ImageManager: 负责管理镜像，包括拉取、删除、镜像 GC 等。</li>
<li>DeviceManager: 负责管理设备，包括 GPU、RDMA 等。</li>
<li>PluginManager: PluginManager 运行一组异步循环，根据此节点确定哪些插件需要注册/取消注册并执行。如 CSI 驱动和设备管理器插件（Device Plugin）。</li>
<li>CertificateManager: 处理证书轮换。</li>
<li>OOMWatcher: 从系统日志中获取容器的 OOM 日志，将其封装成事件并记录。</li>
</ul>
<h2 id="流程">流程</h2>
<p>首先在 <code>cmd/kubelet</code> 中使用传入命令行参数的方式初始化配置，然后创建 <code>pkg/kubelet</code> 中的 Bootstrap inferface, kubelet struct 实现了这个接口， 然后调用 <code>Run</code> 方法启动 kubelet。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-GO" data-lang="GO"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">startKubelet</span><span style="color:#111">(</span><span style="color:#75af00">k</span> <span style="color:#75af00">kubelet</span><span style="color:#111">.</span><span style="color:#75af00">Bootstrap</span><span style="color:#111">,</span> <span style="color:#75af00">podCfg</span> <span style="color:#f92672">*</span><span style="color:#75af00">config</span><span style="color:#111">.</span><span style="color:#75af00">PodConfig</span><span style="color:#111">,</span> <span style="color:#75af00">kubeCfg</span> <span style="color:#f92672">*</span><span style="color:#75af00">kubeletconfiginternal</span><span style="color:#111">.</span><span style="color:#75af00">KubeletConfiguration</span><span style="color:#111">,</span> <span style="color:#75af00">kubeDeps</span> <span style="color:#f92672">*</span><span style="color:#75af00">kubelet</span><span style="color:#111">.</span><span style="color:#75af00">Dependencies</span><span style="color:#111">,</span> <span style="color:#75af00">enableServer</span> <span style="color:#00a8c8">bool</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// start the kubelet</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">go</span> <span style="color:#75af00">k</span><span style="color:#111">.</span><span style="color:#75af00">Run</span><span style="color:#111">(</span><span style="color:#75af00">podCfg</span><span style="color:#111">.</span><span style="color:#75af00">Updates</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// start the kubelet server</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">enableServer</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">go</span> <span style="color:#75af00">k</span><span style="color:#111">.</span><span style="color:#75af00">ListenAndServe</span><span style="color:#111">(</span><span style="color:#75af00">kubeCfg</span><span style="color:#111">,</span> <span style="color:#75af00">kubeDeps</span><span style="color:#111">.</span><span style="color:#75af00">TLSOptions</span><span style="color:#111">,</span> <span style="color:#75af00">kubeDeps</span><span style="color:#111">.</span><span style="color:#75af00">Auth</span><span style="color:#111">,</span> <span style="color:#75af00">kubeDeps</span><span style="color:#111">.</span><span style="color:#75af00">TracerProvider</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">kubeCfg</span><span style="color:#111">.</span><span style="color:#75af00">ReadOnlyPort</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">go</span> <span style="color:#75af00">k</span><span style="color:#111">.</span><span style="color:#75af00">ListenAndServeReadOnly</span><span style="color:#111">(</span><span style="color:#75af00">netutils</span><span style="color:#111">.</span><span style="color:#75af00">ParseIPSloppy</span><span style="color:#111">(</span><span style="color:#75af00">kubeCfg</span><span style="color:#111">.</span><span style="color:#75af00">Address</span><span style="color:#111">),</span> <span style="color:#111">uint</span><span style="color:#111">(</span><span style="color:#75af00">kubeCfg</span><span style="color:#111">.</span><span style="color:#75af00">ReadOnlyPort</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">go</span> <span style="color:#75af00">k</span><span style="color:#111">.</span><span style="color:#75af00">ListenAndServePodResources</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="bootstrap">Bootstrap</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// Bootstrap is a bootstrapping interface for kubelet, targets the initialization protocol</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Bootstrap</span> <span style="color:#00a8c8">interface</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">GetConfiguration</span><span style="color:#111">()</span> <span style="color:#75af00">kubeletconfiginternal</span><span style="color:#111">.</span><span style="color:#75af00">KubeletConfiguration</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">BirthCry</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">StartGarbageCollection</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ListenAndServe</span><span style="color:#111">(</span><span style="color:#75af00">kubeCfg</span> <span style="color:#f92672">*</span><span style="color:#75af00">kubeletconfiginternal</span><span style="color:#111">.</span><span style="color:#75af00">KubeletConfiguration</span><span style="color:#111">,</span> <span style="color:#75af00">tlsOptions</span> <span style="color:#f92672">*</span><span style="color:#75af00">server</span><span style="color:#111">.</span><span style="color:#75af00">TLSOptions</span><span style="color:#111">,</span> <span style="color:#75af00">auth</span> <span style="color:#75af00">server</span><span style="color:#111">.</span><span style="color:#75af00">AuthInterface</span><span style="color:#111">,</span> <span style="color:#75af00">tp</span> <span style="color:#75af00">trace</span><span style="color:#111">.</span><span style="color:#75af00">TracerProvider</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ListenAndServeReadOnly</span><span style="color:#111">(</span><span style="color:#75af00">address</span> <span style="color:#75af00">net</span><span style="color:#111">.</span><span style="color:#75af00">IP</span><span style="color:#111">,</span> <span style="color:#75af00">port</span> <span style="color:#00a8c8">uint</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ListenAndServePodResources</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Run</span><span style="color:#111">(</span><span style="color:#f92672">&lt;-</span><span style="color:#00a8c8">chan</span> <span style="color:#75af00">kubetypes</span><span style="color:#111">.</span><span style="color:#75af00">PodUpdate</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">RunOnce</span><span style="color:#111">(</span><span style="color:#f92672">&lt;-</span><span style="color:#00a8c8">chan</span> <span style="color:#75af00">kubetypes</span><span style="color:#111">.</span><span style="color:#75af00">PodUpdate</span><span style="color:#111">)</span> <span style="color:#111">([]</span><span style="color:#75af00">RunPodResult</span><span style="color:#111">,</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Kubelet</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ...</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>方法：</p>
<ul>
<li>GetConfiguration: 获取 kubelet 的配置</li>
<li>BirthCry: 打印 kubelet 启动信息</li>
<li>StartGarbageCollection: 启动垃圾回收</li>
<li>ListenAndServe: 启动 kubelet 服务</li>
<li>ListenAndServeReadOnly: 启动只读服务</li>
<li>ListenAndServePodResources: 启动 pod 资源服务</li>
<li>Run: 启动 kubelet 的同步循环</li>
<li>RunOnce: 启动一次同步循环</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-GO" data-lang="GO"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">kl</span> <span style="color:#f92672">*</span><span style="color:#75af00">Kubelet</span><span style="color:#111">)</span> <span style="color:#75af00">StartGarbageCollection</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">loggedContainerGCFailure</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">false</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">go</span> <span style="color:#75af00">wait</span><span style="color:#111">.</span><span style="color:#75af00">Until</span><span style="color:#111">(</span><span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">ctx</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Background</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">containerGC</span><span style="color:#111">.</span><span style="color:#75af00">GarbageCollect</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">);</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">ErrorS</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Container garbage collection failed&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">recorder</span><span style="color:#111">.</span><span style="color:#75af00">Eventf</span><span style="color:#111">(</span><span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">nodeRef</span><span style="color:#111">,</span> <span style="color:#75af00">v1</span><span style="color:#111">.</span><span style="color:#75af00">EventTypeWarning</span><span style="color:#111">,</span> <span style="color:#75af00">events</span><span style="color:#111">.</span><span style="color:#75af00">ContainerGCFailed</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">.</span><span style="color:#75af00">Error</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">loggedContainerGCFailure</span> <span style="color:#111">=</span> <span style="color:#00a8c8">true</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">var</span> <span style="color:#75af00">vLevel</span> <span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">Level</span> <span style="color:#111">=</span> <span style="color:#ae81ff">4</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">loggedContainerGCFailure</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">vLevel</span> <span style="color:#111">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">loggedContainerGCFailure</span> <span style="color:#111">=</span> <span style="color:#00a8c8">false</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#75af00">vLevel</span><span style="color:#111">).</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Container garbage collection succeeded&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">},</span> <span style="color:#75af00">ContainerGCPeriod</span><span style="color:#111">,</span> <span style="color:#75af00">wait</span><span style="color:#111">.</span><span style="color:#75af00">NeverStop</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// when the high threshold is set to 100, stub the image GC manager</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">kubeletConfiguration</span><span style="color:#111">.</span><span style="color:#75af00">ImageGCHighThresholdPercent</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">100</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#ae81ff">2</span><span style="color:#111">).</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;ImageGCHighThresholdPercent is set 100, Disable image GC&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">prevImageGCFailed</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">false</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">go</span> <span style="color:#75af00">wait</span><span style="color:#111">.</span><span style="color:#75af00">Until</span><span style="color:#111">(</span><span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">ctx</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Background</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">imageManager</span><span style="color:#111">.</span><span style="color:#75af00">GarbageCollect</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">);</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">prevImageGCFailed</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">ErrorS</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Image garbage collection failed multiple times in a row&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// Only create an event for repeated failures</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">recorder</span><span style="color:#111">.</span><span style="color:#75af00">Eventf</span><span style="color:#111">(</span><span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">nodeRef</span><span style="color:#111">,</span> <span style="color:#75af00">v1</span><span style="color:#111">.</span><span style="color:#75af00">EventTypeWarning</span><span style="color:#111">,</span> <span style="color:#75af00">events</span><span style="color:#111">.</span><span style="color:#75af00">ImageGCFailed</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">.</span><span style="color:#75af00">Error</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">ErrorS</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Image garbage collection failed once. Stats initialization may not have completed yet&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">prevImageGCFailed</span> <span style="color:#111">=</span> <span style="color:#00a8c8">true</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">var</span> <span style="color:#75af00">vLevel</span> <span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">Level</span> <span style="color:#111">=</span> <span style="color:#ae81ff">4</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">prevImageGCFailed</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">vLevel</span> <span style="color:#111">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">prevImageGCFailed</span> <span style="color:#111">=</span> <span style="color:#00a8c8">false</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#75af00">vLevel</span><span style="color:#111">).</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Image garbage collection succeeded&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">},</span> <span style="color:#75af00">ImageGCPeriod</span><span style="color:#111">,</span> <span style="color:#75af00">wait</span><span style="color:#111">.</span><span style="color:#75af00">NeverStop</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>大致的流程为使用 <code>containerGC</code> 启动容器垃圾回收，当ImageGCHighThresholdPercent 为100时，不启动镜像垃圾回收，否则使用 <code>imageManager</code> 启动镜像垃圾回收。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-GO" data-lang="GO"><span style="display:flex;"><span><span style="color:#75715e">// RunOnce polls from one configuration update and run the associated pods.</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">kl</span> <span style="color:#f92672">*</span><span style="color:#75af00">Kubelet</span><span style="color:#111">)</span> <span style="color:#75af00">RunOnce</span><span style="color:#111">(</span><span style="color:#75af00">updates</span> <span style="color:#f92672">&lt;-</span><span style="color:#00a8c8">chan</span> <span style="color:#75af00">kubetypes</span><span style="color:#111">.</span><span style="color:#75af00">PodUpdate</span><span style="color:#111">)</span> <span style="color:#111">([]</span><span style="color:#75af00">RunPodResult</span><span style="color:#111">,</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ctx</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Background</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Setup filesystem directories.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">setupDataDirs</span><span style="color:#111">();</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// If the container logs directory does not exist, create it.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">Stat</span><span style="color:#111">(</span><span style="color:#75af00">ContainerLogsDir</span><span style="color:#111">);</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">MkdirAll</span><span style="color:#111">(</span><span style="color:#75af00">ContainerLogsDir</span><span style="color:#111">,</span> <span style="color:#ae81ff">0755</span><span style="color:#111">);</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">ErrorS</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Failed to create directory&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;path&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">ContainerLogsDir</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">select</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">case</span> <span style="color:#75af00">u</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#75af00">updates</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Processing manifest with pods&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;numPods&#34;</span><span style="color:#111">,</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">u</span><span style="color:#111">.</span><span style="color:#75af00">Pods</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">result</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">runOnce</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">u</span><span style="color:#111">.</span><span style="color:#75af00">Pods</span><span style="color:#111">,</span> <span style="color:#75af00">runOnceRetryDelay</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Finished processing pods&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;numPods&#34;</span><span style="color:#111">,</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">u</span><span style="color:#111">.</span><span style="color:#75af00">Pods</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">result</span><span style="color:#111">,</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">After</span><span style="color:#111">(</span><span style="color:#75af00">runOnceManifestDelay</span><span style="color:#111">):</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;no pod manifest update after %v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">runOnceManifestDelay</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// runOnce runs a given set of pods and returns their status.</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">kl</span> <span style="color:#f92672">*</span><span style="color:#75af00">Kubelet</span><span style="color:#111">)</span> <span style="color:#75af00">runOnce</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">,</span> <span style="color:#75af00">pods</span> <span style="color:#111">[]</span><span style="color:#f92672">*</span><span style="color:#75af00">v1</span><span style="color:#111">.</span><span style="color:#75af00">Pod</span><span style="color:#111">,</span> <span style="color:#75af00">retryDelay</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Duration</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#75af00">results</span> <span style="color:#111">[]</span><span style="color:#75af00">RunPodResult</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ch</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">chan</span> <span style="color:#75af00">RunPodResult</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">admitted</span> <span style="color:#f92672">:=</span> <span style="color:#111">[]</span><span style="color:#f92672">*</span><span style="color:#75af00">v1</span><span style="color:#111">.</span><span style="color:#75af00">Pod</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">pod</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">pods</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Check if we can admit the pod.</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">ok</span><span style="color:#111">,</span> <span style="color:#75af00">reason</span><span style="color:#111">,</span> <span style="color:#75af00">message</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">canAdmitPod</span><span style="color:#111">(</span><span style="color:#75af00">admitted</span><span style="color:#111">,</span> <span style="color:#75af00">pod</span><span style="color:#111">);</span> <span style="color:#111">!</span><span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">rejectPod</span><span style="color:#111">(</span><span style="color:#75af00">pod</span><span style="color:#111">,</span> <span style="color:#75af00">reason</span><span style="color:#111">,</span> <span style="color:#75af00">message</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">results</span> <span style="color:#111">=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">results</span><span style="color:#111">,</span> <span style="color:#75af00">RunPodResult</span><span style="color:#111">{</span><span style="color:#75af00">pod</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span><span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">continue</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">admitted</span> <span style="color:#111">=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">admitted</span><span style="color:#111">,</span> <span style="color:#75af00">pod</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">go</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">pod</span> <span style="color:#f92672">*</span><span style="color:#75af00">v1</span><span style="color:#111">.</span><span style="color:#75af00">Pod</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">runPod</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">pod</span><span style="color:#111">,</span> <span style="color:#75af00">retryDelay</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">ch</span> <span style="color:#f92672">&lt;-</span> <span style="color:#75af00">RunPodResult</span><span style="color:#111">{</span><span style="color:#75af00">pod</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}(</span><span style="color:#75af00">pod</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Waiting for pods&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;numPods&#34;</span><span style="color:#111">,</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">admitted</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">failedPods</span> <span style="color:#f92672">:=</span> <span style="color:#111">[]</span><span style="color:#00a8c8">string</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span><span style="color:#111">;</span> <span style="color:#75af00">i</span> <span style="color:#111">&lt;</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">admitted</span><span style="color:#111">);</span> <span style="color:#75af00">i</span><span style="color:#f92672">++</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">res</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#75af00">ch</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">results</span> <span style="color:#111">=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">results</span><span style="color:#111">,</span> <span style="color:#75af00">res</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">res</span><span style="color:#111">.</span><span style="color:#75af00">Err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">failedContainerName</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">getFailedContainers</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">res</span><span style="color:#111">.</span><span style="color:#75af00">Pod</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Unable to get failed containers&#39; names for pod&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;pod&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">KObj</span><span style="color:#111">(</span><span style="color:#75af00">res</span><span style="color:#111">.</span><span style="color:#75af00">Pod</span><span style="color:#111">),</span> <span style="color:#d88200">&#34;err&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Unable to start pod because container failed&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;pod&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">KObj</span><span style="color:#111">(</span><span style="color:#75af00">res</span><span style="color:#111">.</span><span style="color:#75af00">Pod</span><span style="color:#111">),</span> <span style="color:#d88200">&#34;containerName&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">failedContainerName</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">failedPods</span> <span style="color:#111">=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">failedPods</span><span style="color:#111">,</span> <span style="color:#75af00">format</span><span style="color:#111">.</span><span style="color:#75af00">Pod</span><span style="color:#111">(</span><span style="color:#75af00">res</span><span style="color:#111">.</span><span style="color:#75af00">Pod</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Started pod&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;pod&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">KObj</span><span style="color:#111">(</span><span style="color:#75af00">res</span><span style="color:#111">.</span><span style="color:#75af00">Pod</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">failedPods</span><span style="color:#111">)</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">results</span><span style="color:#111">,</span> <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;error running pods: %v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">failedPods</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Pods started&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;numPods&#34;</span><span style="color:#111">,</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">pods</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">results</span><span style="color:#111">,</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>大致作用为从 <code>updates</code> 中获取 PodUpdate，然后调用 <code>runOnce</code> 方法，该方法会调用 <code>runPod</code> 方法启动 Pod。</p>
<h3 id="run">Run</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-GO" data-lang="GO"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">kl</span> <span style="color:#f92672">*</span><span style="color:#75af00">Kubelet</span><span style="color:#111">)</span> <span style="color:#75af00">Run</span><span style="color:#111">(</span><span style="color:#75af00">updates</span> <span style="color:#f92672">&lt;-</span><span style="color:#00a8c8">chan</span> <span style="color:#75af00">kubetypes</span><span style="color:#111">.</span><span style="color:#75af00">PodUpdate</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ctx</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Background</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">logServer</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">file</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">FileServer</span><span style="color:#111">(</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Dir</span><span style="color:#111">(</span><span style="color:#75af00">nodeLogDir</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">utilfeature</span><span style="color:#111">.</span><span style="color:#75af00">DefaultFeatureGate</span><span style="color:#111">.</span><span style="color:#75af00">Enabled</span><span style="color:#111">(</span><span style="color:#75af00">features</span><span style="color:#111">.</span><span style="color:#75af00">NodeLogQuery</span><span style="color:#111">)</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">kubeletConfiguration</span><span style="color:#111">.</span><span style="color:#75af00">EnableSystemLogQuery</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">logServer</span> <span style="color:#111">=</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">StripPrefix</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/logs/&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">HandlerFunc</span><span style="color:#111">(</span><span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">w</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">ResponseWriter</span><span style="color:#111">,</span> <span style="color:#75af00">req</span> <span style="color:#f92672">*</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Request</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">if</span> <span style="color:#75af00">nlq</span><span style="color:#111">,</span> <span style="color:#75af00">errs</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">newNodeLogQuery</span><span style="color:#111">(</span><span style="color:#75af00">req</span><span style="color:#111">.</span><span style="color:#75af00">URL</span><span style="color:#111">.</span><span style="color:#75af00">Query</span><span style="color:#111">());</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">errs</span><span style="color:#111">)</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Error</span><span style="color:#111">(</span><span style="color:#75af00">w</span><span style="color:#111">,</span> <span style="color:#75af00">errs</span><span style="color:#111">.</span><span style="color:#75af00">ToAggregate</span><span style="color:#111">().</span><span style="color:#75af00">Error</span><span style="color:#111">(),</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">StatusBadRequest</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>					<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>				<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#00a8c8">if</span> <span style="color:#75af00">nlq</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#00a8c8">if</span> <span style="color:#75af00">req</span><span style="color:#111">.</span><span style="color:#75af00">URL</span><span style="color:#111">.</span><span style="color:#75af00">Path</span> <span style="color:#f92672">!=</span> <span style="color:#d88200">&#34;/&#34;</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">req</span><span style="color:#111">.</span><span style="color:#75af00">URL</span><span style="color:#111">.</span><span style="color:#75af00">Path</span> <span style="color:#f92672">!=</span> <span style="color:#d88200">&#34;&#34;</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>						<span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Error</span><span style="color:#111">(</span><span style="color:#75af00">w</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;path not allowed in query mode&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">StatusNotAcceptable</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>						<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>					<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>					<span style="color:#00a8c8">if</span> <span style="color:#75af00">errs</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">nlq</span><span style="color:#111">.</span><span style="color:#75af00">validate</span><span style="color:#111">();</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">errs</span><span style="color:#111">)</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>						<span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Error</span><span style="color:#111">(</span><span style="color:#75af00">w</span><span style="color:#111">,</span> <span style="color:#75af00">errs</span><span style="color:#111">.</span><span style="color:#75af00">ToAggregate</span><span style="color:#111">().</span><span style="color:#75af00">Error</span><span style="color:#111">(),</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">StatusNotAcceptable</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>						<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>					<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75715e">// Validation ensures that the request does not query services and files at the same time</span>
</span></span><span style="display:flex;"><span>					<span style="color:#00a8c8">if</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">nlq</span><span style="color:#111">.</span><span style="color:#75af00">Services</span><span style="color:#111">)</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>						<span style="color:#75af00">journal</span><span style="color:#111">.</span><span style="color:#75af00">ServeHTTP</span><span style="color:#111">(</span><span style="color:#75af00">w</span><span style="color:#111">,</span> <span style="color:#75af00">req</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>						<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>					<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75715e">// Validation ensures that the request does not explicitly query multiple files at the same time</span>
</span></span><span style="display:flex;"><span>					<span style="color:#00a8c8">if</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">nlq</span><span style="color:#111">.</span><span style="color:#75af00">Files</span><span style="color:#111">)</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>						<span style="color:#75715e">// Account for the \ being used on Windows clients</span>
</span></span><span style="display:flex;"><span>						<span style="color:#75af00">req</span><span style="color:#111">.</span><span style="color:#75af00">URL</span><span style="color:#111">.</span><span style="color:#75af00">Path</span> <span style="color:#111">=</span> <span style="color:#75af00">filepath</span><span style="color:#111">.</span><span style="color:#75af00">ToSlash</span><span style="color:#111">(</span><span style="color:#75af00">nlq</span><span style="color:#111">.</span><span style="color:#75af00">Files</span><span style="color:#111">[</span><span style="color:#ae81ff">0</span><span style="color:#111">])</span>
</span></span><span style="display:flex;"><span>					<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>				<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// Fall back in case the caller is directly trying to query a file</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// Example: kubectl get --raw /api/v1/nodes/$name/proxy/logs/foo.log</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">file</span><span style="color:#111">.</span><span style="color:#75af00">ServeHTTP</span><span style="color:#111">(</span><span style="color:#75af00">w</span><span style="color:#111">,</span> <span style="color:#75af00">req</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">logServer</span> <span style="color:#111">=</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">StripPrefix</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/logs/&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">file</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">kubeClient</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;No API server defined - no node status update will be sent&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Start the cloud provider sync manager</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">cloudResourceSyncManager</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">go</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">cloudResourceSyncManager</span><span style="color:#111">.</span><span style="color:#75af00">Run</span><span style="color:#111">(</span><span style="color:#75af00">wait</span><span style="color:#111">.</span><span style="color:#75af00">NeverStop</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">initializeModules</span><span style="color:#111">();</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">recorder</span><span style="color:#111">.</span><span style="color:#75af00">Eventf</span><span style="color:#111">(</span><span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">nodeRef</span><span style="color:#111">,</span> <span style="color:#75af00">v1</span><span style="color:#111">.</span><span style="color:#75af00">EventTypeWarning</span><span style="color:#111">,</span> <span style="color:#75af00">events</span><span style="color:#111">.</span><span style="color:#75af00">KubeletSetupFailed</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">.</span><span style="color:#75af00">Error</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">ErrorS</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Failed to initialize internal modules&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">Exit</span><span style="color:#111">(</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Start volume manager</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">go</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">volumeManager</span><span style="color:#111">.</span><span style="color:#75af00">Run</span><span style="color:#111">(</span><span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">sourcesReady</span><span style="color:#111">,</span> <span style="color:#75af00">wait</span><span style="color:#111">.</span><span style="color:#75af00">NeverStop</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">kubeClient</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Start two go-routines to update the status.</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">		// The first will report to the apiserver every nodeStatusUpdateFrequency and is aimed to provide regular status intervals,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// while the second is used to provide a more timely status update during initialization and runs an one-shot update to the apiserver</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// once the node becomes ready, then exits afterwards.</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">		// Introduce some small jittering to ensure that over time the requests won&#39;t start</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// accumulating at approximately the same time from the set of nodes due to priority and</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// fairness effect.</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">go</span> <span style="color:#75af00">wait</span><span style="color:#111">.</span><span style="color:#75af00">JitterUntil</span><span style="color:#111">(</span><span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">syncNodeStatus</span><span style="color:#111">,</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">nodeStatusUpdateFrequency</span><span style="color:#111">,</span> <span style="color:#ae81ff">0.04</span><span style="color:#111">,</span> <span style="color:#00a8c8">true</span><span style="color:#111">,</span> <span style="color:#75af00">wait</span><span style="color:#111">.</span><span style="color:#75af00">NeverStop</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">go</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">fastStatusUpdateOnce</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// start syncing lease</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">go</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">nodeLeaseController</span><span style="color:#111">.</span><span style="color:#75af00">Run</span><span style="color:#111">(</span><span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Background</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">go</span> <span style="color:#75af00">wait</span><span style="color:#111">.</span><span style="color:#75af00">Until</span><span style="color:#111">(</span><span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">updateRuntimeUp</span><span style="color:#111">,</span> <span style="color:#ae81ff">5</span><span style="color:#f92672">*</span><span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Second</span><span style="color:#111">,</span> <span style="color:#75af00">wait</span><span style="color:#111">.</span><span style="color:#75af00">NeverStop</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Set up iptables util rules</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">makeIPTablesUtilChains</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">initNetworkUtil</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Start component sync loops.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">statusManager</span><span style="color:#111">.</span><span style="color:#75af00">Start</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Start syncing RuntimeClasses if enabled.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">runtimeClassManager</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">runtimeClassManager</span><span style="color:#111">.</span><span style="color:#75af00">Start</span><span style="color:#111">(</span><span style="color:#75af00">wait</span><span style="color:#111">.</span><span style="color:#75af00">NeverStop</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Start the pod lifecycle event generator.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">pleg</span><span style="color:#111">.</span><span style="color:#75af00">Start</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Start eventedPLEG only if EventedPLEG feature gate is enabled.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">utilfeature</span><span style="color:#111">.</span><span style="color:#75af00">DefaultFeatureGate</span><span style="color:#111">.</span><span style="color:#75af00">Enabled</span><span style="color:#111">(</span><span style="color:#75af00">features</span><span style="color:#111">.</span><span style="color:#75af00">EventedPLEG</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">eventedPleg</span><span style="color:#111">.</span><span style="color:#75af00">Start</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">syncLoop</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">updates</span><span style="color:#111">,</span> <span style="color:#75af00">kl</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>代码的流程为：</p>
<ol>
<li>检查是否需要创建日志服务器 如果需要则创建</li>
<li>启动云提供商同步管理器</li>
<li>初始化模块，如果出错则打印日志并退出</li>
<li>启动卷管理器</li>
<li>启动两个 goroutine 来更新状态，一个是定时更新，一个是在初始化时更新</li>
<li>启动同步租约的goroutine</li>
<li>定期更新RuntimeUp状态的goroutine</li>
<li>设置iptables规则</li>
<li>启动组件同步循环</li>
<li>如果启用了RuntimeClasses，则启动RuntimeClasses同步循环</li>
<li>启动Pod Lifecycle Event Generator</li>
<li>如果启用了EventedPLEG特性，则启动EventedPLEG</li>
<li>启动 syncloop</li>
</ol>
<h3 id="syncloop">syncLoop</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-GO" data-lang="GO"><span style="display:flex;"><span><span style="color:#75715e">// syncLoop is the main loop for processing changes. It watches for changes from</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// three channels (file, apiserver, and http) and creates a union of them. For</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// any new change seen, will run a sync against desired state and running state. If</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// no changes are seen to the configuration, will synchronize the last known desired</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// state every sync-frequency seconds. Never returns.</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">kl</span> <span style="color:#f92672">*</span><span style="color:#75af00">Kubelet</span><span style="color:#111">)</span> <span style="color:#75af00">syncLoop</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">,</span> <span style="color:#75af00">updates</span> <span style="color:#f92672">&lt;-</span><span style="color:#00a8c8">chan</span> <span style="color:#75af00">kubetypes</span><span style="color:#111">.</span><span style="color:#75af00">PodUpdate</span><span style="color:#111">,</span> <span style="color:#75af00">handler</span> <span style="color:#75af00">SyncHandler</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Starting kubelet main sync loop&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// The syncTicker wakes up kubelet to checks if there are any pod workers</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// that need to be sync&#39;d. A one-second period is sufficient because the</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// sync interval is defaulted to 10s.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">syncTicker</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">NewTicker</span><span style="color:#111">(</span><span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Second</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">syncTicker</span><span style="color:#111">.</span><span style="color:#75af00">Stop</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">housekeepingTicker</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">NewTicker</span><span style="color:#111">(</span><span style="color:#75af00">housekeepingPeriod</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">housekeepingTicker</span><span style="color:#111">.</span><span style="color:#75af00">Stop</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">plegCh</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">pleg</span><span style="color:#111">.</span><span style="color:#75af00">Watch</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">const</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">base</span>   <span style="color:#111">=</span> <span style="color:#ae81ff">100</span> <span style="color:#f92672">*</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Millisecond</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">max</span>    <span style="color:#111">=</span> <span style="color:#ae81ff">5</span> <span style="color:#f92672">*</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Second</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">factor</span> <span style="color:#111">=</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">duration</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">base</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Responsible for checking limits in resolv.conf</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// The limits do not have anything to do with individual pods</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Since this is called in syncLoop, we don&#39;t need to call it anywhere else</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">dnsConfigurer</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">dnsConfigurer</span><span style="color:#111">.</span><span style="color:#75af00">ResolverConfig</span> <span style="color:#f92672">!=</span> <span style="color:#d88200">&#34;&#34;</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">dnsConfigurer</span><span style="color:#111">.</span><span style="color:#75af00">CheckLimitsForResolvConf</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">runtimeState</span><span style="color:#111">.</span><span style="color:#75af00">runtimeErrors</span><span style="color:#111">();</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">ErrorS</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Skipping pod synchronization&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// exponential backoff</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Sleep</span><span style="color:#111">(</span><span style="color:#75af00">duration</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">duration</span> <span style="color:#111">=</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Duration</span><span style="color:#111">(</span><span style="color:#75af00">math</span><span style="color:#111">.</span><span style="color:#75af00">Min</span><span style="color:#111">(</span><span style="color:#111">float64</span><span style="color:#111">(</span><span style="color:#75af00">max</span><span style="color:#111">),</span> <span style="color:#75af00">factor</span><span style="color:#f92672">*</span><span style="color:#111">float64</span><span style="color:#111">(</span><span style="color:#75af00">duration</span><span style="color:#111">)))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">continue</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// reset backoff if we have a success</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">duration</span> <span style="color:#111">=</span> <span style="color:#75af00">base</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">syncLoopMonitor</span><span style="color:#111">.</span><span style="color:#75af00">Store</span><span style="color:#111">(</span><span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">clock</span><span style="color:#111">.</span><span style="color:#75af00">Now</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">syncLoopIteration</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">updates</span><span style="color:#111">,</span> <span style="color:#75af00">handler</span><span style="color:#111">,</span> <span style="color:#75af00">syncTicker</span><span style="color:#111">.</span><span style="color:#75af00">C</span><span style="color:#111">,</span> <span style="color:#75af00">housekeepingTicker</span><span style="color:#111">.</span><span style="color:#75af00">C</span><span style="color:#111">,</span> <span style="color:#75af00">plegCh</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">break</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">syncLoopMonitor</span><span style="color:#111">.</span><span style="color:#75af00">Store</span><span style="color:#111">(</span><span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">clock</span><span style="color:#111">.</span><span style="color:#75af00">Now</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>代码流程为：</p>
<ol>
<li>从 pleg 获取 update 事件 他是一个 channel</li>
<li>进入循环 如果 runtimeState 有错误 sleep 一会儿然后跳过</li>
<li>执行  syncLoopIteration</li>
</ol>
<h4 id="syncloopiteration">syncLoopIteration</h4>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">kl</span> <span style="color:#f92672">*</span><span style="color:#75af00">Kubelet</span><span style="color:#111">)</span> <span style="color:#75af00">syncLoopIteration</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">,</span> <span style="color:#75af00">configCh</span> <span style="color:#f92672">&lt;-</span><span style="color:#00a8c8">chan</span> <span style="color:#75af00">kubetypes</span><span style="color:#111">.</span><span style="color:#75af00">PodUpdate</span><span style="color:#111">,</span> <span style="color:#75af00">handler</span> <span style="color:#75af00">SyncHandler</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">syncCh</span> <span style="color:#f92672">&lt;-</span><span style="color:#00a8c8">chan</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Time</span><span style="color:#111">,</span> <span style="color:#75af00">housekeepingCh</span> <span style="color:#f92672">&lt;-</span><span style="color:#00a8c8">chan</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Time</span><span style="color:#111">,</span> <span style="color:#75af00">plegCh</span> <span style="color:#f92672">&lt;-</span><span style="color:#00a8c8">chan</span> <span style="color:#f92672">*</span><span style="color:#75af00">pleg</span><span style="color:#111">.</span><span style="color:#75af00">PodLifecycleEvent</span><span style="color:#111">)</span> <span style="color:#00a8c8">bool</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">select</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">case</span> <span style="color:#75af00">u</span><span style="color:#111">,</span> <span style="color:#75af00">open</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#75af00">configCh</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Update from a config source; dispatch it to the right handler</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// callback.</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">open</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">ErrorS</span><span style="color:#111">(</span><span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Update channel is closed, exiting the sync loop&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">false</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">switch</span> <span style="color:#75af00">u</span><span style="color:#111">.</span><span style="color:#75af00">Op</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">case</span> <span style="color:#75af00">kubetypes</span><span style="color:#111">.</span><span style="color:#75af00">ADD</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#ae81ff">2</span><span style="color:#111">).</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;SyncLoop ADD&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;source&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">u</span><span style="color:#111">.</span><span style="color:#75af00">Source</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;pods&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">KObjSlice</span><span style="color:#111">(</span><span style="color:#75af00">u</span><span style="color:#111">.</span><span style="color:#75af00">Pods</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// After restarting, kubelet will get all existing pods through</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// ADD as if they are new pods. These pods will then go through the</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// admission process and *may* be rejected. This can be resolved</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// once we have checkpointing.</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">handler</span><span style="color:#111">.</span><span style="color:#75af00">HandlePodAdditions</span><span style="color:#111">(</span><span style="color:#75af00">u</span><span style="color:#111">.</span><span style="color:#75af00">Pods</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">case</span> <span style="color:#75af00">kubetypes</span><span style="color:#111">.</span><span style="color:#75af00">UPDATE</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#ae81ff">2</span><span style="color:#111">).</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;SyncLoop UPDATE&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;source&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">u</span><span style="color:#111">.</span><span style="color:#75af00">Source</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;pods&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">KObjSlice</span><span style="color:#111">(</span><span style="color:#75af00">u</span><span style="color:#111">.</span><span style="color:#75af00">Pods</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">handler</span><span style="color:#111">.</span><span style="color:#75af00">HandlePodUpdates</span><span style="color:#111">(</span><span style="color:#75af00">u</span><span style="color:#111">.</span><span style="color:#75af00">Pods</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">case</span> <span style="color:#75af00">kubetypes</span><span style="color:#111">.</span><span style="color:#75af00">REMOVE</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#ae81ff">2</span><span style="color:#111">).</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;SyncLoop REMOVE&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;source&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">u</span><span style="color:#111">.</span><span style="color:#75af00">Source</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;pods&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">KObjSlice</span><span style="color:#111">(</span><span style="color:#75af00">u</span><span style="color:#111">.</span><span style="color:#75af00">Pods</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">handler</span><span style="color:#111">.</span><span style="color:#75af00">HandlePodRemoves</span><span style="color:#111">(</span><span style="color:#75af00">u</span><span style="color:#111">.</span><span style="color:#75af00">Pods</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">case</span> <span style="color:#75af00">kubetypes</span><span style="color:#111">.</span><span style="color:#75af00">RECONCILE</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#ae81ff">4</span><span style="color:#111">).</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;SyncLoop RECONCILE&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;source&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">u</span><span style="color:#111">.</span><span style="color:#75af00">Source</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;pods&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">KObjSlice</span><span style="color:#111">(</span><span style="color:#75af00">u</span><span style="color:#111">.</span><span style="color:#75af00">Pods</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">handler</span><span style="color:#111">.</span><span style="color:#75af00">HandlePodReconcile</span><span style="color:#111">(</span><span style="color:#75af00">u</span><span style="color:#111">.</span><span style="color:#75af00">Pods</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">case</span> <span style="color:#75af00">kubetypes</span><span style="color:#111">.</span><span style="color:#75af00">DELETE</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#ae81ff">2</span><span style="color:#111">).</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;SyncLoop DELETE&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;source&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">u</span><span style="color:#111">.</span><span style="color:#75af00">Source</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;pods&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">KObjSlice</span><span style="color:#111">(</span><span style="color:#75af00">u</span><span style="color:#111">.</span><span style="color:#75af00">Pods</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// DELETE is treated as a UPDATE because of graceful deletion.</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">handler</span><span style="color:#111">.</span><span style="color:#75af00">HandlePodUpdates</span><span style="color:#111">(</span><span style="color:#75af00">u</span><span style="color:#111">.</span><span style="color:#75af00">Pods</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">case</span> <span style="color:#75af00">kubetypes</span><span style="color:#111">.</span><span style="color:#75af00">SET</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// TODO: Do we want to support this?</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">ErrorS</span><span style="color:#111">(</span><span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Kubelet does not support snapshot update&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">default</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">ErrorS</span><span style="color:#111">(</span><span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Invalid operation type received&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;operation&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">u</span><span style="color:#111">.</span><span style="color:#75af00">Op</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">sourcesReady</span><span style="color:#111">.</span><span style="color:#75af00">AddSource</span><span style="color:#111">(</span><span style="color:#75af00">u</span><span style="color:#111">.</span><span style="color:#75af00">Source</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">case</span> <span style="color:#75af00">e</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#75af00">plegCh</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">isSyncPodWorthy</span><span style="color:#111">(</span><span style="color:#75af00">e</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// PLEG event for a pod; sync it.</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">pod</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">podManager</span><span style="color:#111">.</span><span style="color:#75af00">GetPodByUID</span><span style="color:#111">(</span><span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">ID</span><span style="color:#111">);</span> <span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#ae81ff">2</span><span style="color:#111">).</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;SyncLoop (PLEG): event for pod&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;pod&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">KObj</span><span style="color:#111">(</span><span style="color:#75af00">pod</span><span style="color:#111">),</span> <span style="color:#d88200">&#34;event&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">e</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">handler</span><span style="color:#111">.</span><span style="color:#75af00">HandlePodSyncs</span><span style="color:#111">([]</span><span style="color:#f92672">*</span><span style="color:#75af00">v1</span><span style="color:#111">.</span><span style="color:#75af00">Pod</span><span style="color:#111">{</span><span style="color:#75af00">pod</span><span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// If the pod no longer exists, ignore the event.</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#ae81ff">4</span><span style="color:#111">).</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;SyncLoop (PLEG): pod does not exist, ignore irrelevant event&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;event&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">e</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">Type</span> <span style="color:#f92672">==</span> <span style="color:#75af00">pleg</span><span style="color:#111">.</span><span style="color:#75af00">ContainerDied</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">containerID</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">Data</span><span style="color:#111">.(</span><span style="color:#00a8c8">string</span><span style="color:#111">);</span> <span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">cleanUpContainersInPod</span><span style="color:#111">(</span><span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">ID</span><span style="color:#111">,</span> <span style="color:#75af00">containerID</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#75af00">syncCh</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Sync pods waiting for sync</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">podsToSync</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">getPodsToSync</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">podsToSync</span><span style="color:#111">)</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">break</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#ae81ff">4</span><span style="color:#111">).</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;SyncLoop (SYNC) pods&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;total&#34;</span><span style="color:#111">,</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">podsToSync</span><span style="color:#111">),</span> <span style="color:#d88200">&#34;pods&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">KObjSlice</span><span style="color:#111">(</span><span style="color:#75af00">podsToSync</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">handler</span><span style="color:#111">.</span><span style="color:#75af00">HandlePodSyncs</span><span style="color:#111">(</span><span style="color:#75af00">podsToSync</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">case</span> <span style="color:#75af00">update</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">livenessManager</span><span style="color:#111">.</span><span style="color:#75af00">Updates</span><span style="color:#111">():</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">update</span><span style="color:#111">.</span><span style="color:#75af00">Result</span> <span style="color:#f92672">==</span> <span style="color:#75af00">proberesults</span><span style="color:#111">.</span><span style="color:#75af00">Failure</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">handleProbeSync</span><span style="color:#111">(</span><span style="color:#75af00">kl</span><span style="color:#111">,</span> <span style="color:#75af00">update</span><span style="color:#111">,</span> <span style="color:#75af00">handler</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;liveness&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;unhealthy&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">case</span> <span style="color:#75af00">update</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">readinessManager</span><span style="color:#111">.</span><span style="color:#75af00">Updates</span><span style="color:#111">():</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">ready</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">update</span><span style="color:#111">.</span><span style="color:#75af00">Result</span> <span style="color:#f92672">==</span> <span style="color:#75af00">proberesults</span><span style="color:#111">.</span><span style="color:#75af00">Success</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">statusManager</span><span style="color:#111">.</span><span style="color:#75af00">SetContainerReadiness</span><span style="color:#111">(</span><span style="color:#75af00">update</span><span style="color:#111">.</span><span style="color:#75af00">PodUID</span><span style="color:#111">,</span> <span style="color:#75af00">update</span><span style="color:#111">.</span><span style="color:#75af00">ContainerID</span><span style="color:#111">,</span> <span style="color:#75af00">ready</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">status</span> <span style="color:#f92672">:=</span> <span style="color:#d88200">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">ready</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">status</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;ready&#34;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">handleProbeSync</span><span style="color:#111">(</span><span style="color:#75af00">kl</span><span style="color:#111">,</span> <span style="color:#75af00">update</span><span style="color:#111">,</span> <span style="color:#75af00">handler</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;readiness&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">status</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">case</span> <span style="color:#75af00">update</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">startupManager</span><span style="color:#111">.</span><span style="color:#75af00">Updates</span><span style="color:#111">():</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">started</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">update</span><span style="color:#111">.</span><span style="color:#75af00">Result</span> <span style="color:#f92672">==</span> <span style="color:#75af00">proberesults</span><span style="color:#111">.</span><span style="color:#75af00">Success</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">statusManager</span><span style="color:#111">.</span><span style="color:#75af00">SetContainerStartup</span><span style="color:#111">(</span><span style="color:#75af00">update</span><span style="color:#111">.</span><span style="color:#75af00">PodUID</span><span style="color:#111">,</span> <span style="color:#75af00">update</span><span style="color:#111">.</span><span style="color:#75af00">ContainerID</span><span style="color:#111">,</span> <span style="color:#75af00">started</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">status</span> <span style="color:#f92672">:=</span> <span style="color:#d88200">&#34;unhealthy&#34;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">started</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">status</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;started&#34;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">handleProbeSync</span><span style="color:#111">(</span><span style="color:#75af00">kl</span><span style="color:#111">,</span> <span style="color:#75af00">update</span><span style="color:#111">,</span> <span style="color:#75af00">handler</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;startup&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">status</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#75af00">housekeepingCh</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">sourcesReady</span><span style="color:#111">.</span><span style="color:#75af00">AllReady</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// If the sources aren&#39;t ready or volume manager has not yet synced the states,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// skip housekeeping, as we may accidentally delete pods from unready sources.</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#ae81ff">4</span><span style="color:#111">).</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;SyncLoop (housekeeping, skipped): sources aren&#39;t ready yet&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">start</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Now</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#ae81ff">4</span><span style="color:#111">).</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;SyncLoop (housekeeping)&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">handler</span><span style="color:#111">.</span><span style="color:#75af00">HandlePodCleanups</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">);</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">ErrorS</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Failed cleaning pods&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">duration</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Since</span><span style="color:#111">(</span><span style="color:#75af00">start</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">duration</span> <span style="color:#111">&gt;</span> <span style="color:#75af00">housekeepingWarningDuration</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">ErrorS</span><span style="color:#111">(</span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;housekeeping took too long&#34;</span><span style="color:#111">),</span> <span style="color:#d88200">&#34;Housekeeping took longer than expected&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;expected&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">housekeepingWarningDuration</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;actual&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">duration</span><span style="color:#111">.</span><span style="color:#75af00">Round</span><span style="color:#111">(</span><span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Millisecond</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#ae81ff">4</span><span style="color:#111">).</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;SyncLoop (housekeeping) end&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;duration&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">duration</span><span style="color:#111">.</span><span style="color:#75af00">Round</span><span style="color:#111">(</span><span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Millisecond</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">true</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>首先解释一下这个函数的参数：</p>
<ul>
<li>configCh: 将配置更改的 Pod 分派给适当的处理程序回调函数</li>
<li>plegCh: 更新运行时缓存；同步 Pod</li>
<li>syncCh: 同步所有等待同步的 Pod</li>
<li>housekeepingCh: 触发 Pod 的清理</li>
<li>health manager: 同步失败的 Pod 或其中一个或多个容器的健康检查失败的 Pod</li>
</ul>
<p>代码流程为：</p>
<ul>
<li>如果 updates channel 有消息 则使用 handler 调用对应方法做处理</li>
<li>如果 plegCh 有消息 则使用 handler 的 HandlePodSyncs 做同步</li>
<li>如果 syncCh 有消息 代表到了同步时间 做同步操作</li>
<li>如果是 三种 probe 的更新 则使用 handleProbeSync 做同步</li>
<li>如果 housekeepingCh 有消息 则使用 handler 的 HandlePodCleanups 做清理</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">handleProbeSync</span><span style="color:#111">(</span><span style="color:#75af00">kl</span> <span style="color:#f92672">*</span><span style="color:#75af00">Kubelet</span><span style="color:#111">,</span> <span style="color:#75af00">update</span> <span style="color:#75af00">proberesults</span><span style="color:#111">.</span><span style="color:#75af00">Update</span><span style="color:#111">,</span> <span style="color:#75af00">handler</span> <span style="color:#75af00">SyncHandler</span><span style="color:#111">,</span> <span style="color:#75af00">probe</span><span style="color:#111">,</span> <span style="color:#75af00">status</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// We should not use the pod from manager, because it is never updated after initialization.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">pod</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">podManager</span><span style="color:#111">.</span><span style="color:#75af00">GetPodByUID</span><span style="color:#111">(</span><span style="color:#75af00">update</span><span style="color:#111">.</span><span style="color:#75af00">PodUID</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// If the pod no longer exists, ignore the update.</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#ae81ff">4</span><span style="color:#111">).</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;SyncLoop (probe): ignore irrelevant update&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;probe&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">probe</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;status&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">status</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;update&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">update</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#ae81ff">1</span><span style="color:#111">).</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;SyncLoop (probe)&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;probe&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">probe</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;status&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">status</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;pod&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">KObj</span><span style="color:#111">(</span><span style="color:#75af00">pod</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">handler</span><span style="color:#111">.</span><span style="color:#75af00">HandlePodSyncs</span><span style="color:#111">([]</span><span style="color:#f92672">*</span><span style="color:#75af00">v1</span><span style="color:#111">.</span><span style="color:#75af00">Pod</span><span style="color:#111">{</span><span style="color:#75af00">pod</span><span style="color:#111">})</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>handleProbeSync也是使用 handler 的 HandlePodSyncs 做同步</p>
<h3 id="handle-synchandler">handle (SyncHandler)</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-GO" data-lang="GO"><span style="display:flex;"><span><span style="color:#75715e">// SyncHandler is an interface implemented by Kubelet, for testability</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">SyncHandler</span> <span style="color:#00a8c8">interface</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">HandlePodAdditions</span><span style="color:#111">(</span><span style="color:#75af00">pods</span> <span style="color:#111">[]</span><span style="color:#f92672">*</span><span style="color:#75af00">v1</span><span style="color:#111">.</span><span style="color:#75af00">Pod</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">HandlePodUpdates</span><span style="color:#111">(</span><span style="color:#75af00">pods</span> <span style="color:#111">[]</span><span style="color:#f92672">*</span><span style="color:#75af00">v1</span><span style="color:#111">.</span><span style="color:#75af00">Pod</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">HandlePodRemoves</span><span style="color:#111">(</span><span style="color:#75af00">pods</span> <span style="color:#111">[]</span><span style="color:#f92672">*</span><span style="color:#75af00">v1</span><span style="color:#111">.</span><span style="color:#75af00">Pod</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">HandlePodReconcile</span><span style="color:#111">(</span><span style="color:#75af00">pods</span> <span style="color:#111">[]</span><span style="color:#f92672">*</span><span style="color:#75af00">v1</span><span style="color:#111">.</span><span style="color:#75af00">Pod</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">HandlePodSyncs</span><span style="color:#111">(</span><span style="color:#75af00">pods</span> <span style="color:#111">[]</span><span style="color:#f92672">*</span><span style="color:#75af00">v1</span><span style="color:#111">.</span><span style="color:#75af00">Pod</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">HandlePodCleanups</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>也是 kubelet struct 实现了这个接口</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-GO" data-lang="GO"><span style="display:flex;"><span><span style="color:#75715e">// HandlePodAdditions is the callback in SyncHandler for pods being added from</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// a config source.</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">kl</span> <span style="color:#f92672">*</span><span style="color:#75af00">Kubelet</span><span style="color:#111">)</span> <span style="color:#75af00">HandlePodAdditions</span><span style="color:#111">(</span><span style="color:#75af00">pods</span> <span style="color:#111">[]</span><span style="color:#f92672">*</span><span style="color:#75af00">v1</span><span style="color:#111">.</span><span style="color:#75af00">Pod</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">start</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">clock</span><span style="color:#111">.</span><span style="color:#75af00">Now</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">sort</span><span style="color:#111">.</span><span style="color:#75af00">Sort</span><span style="color:#111">(</span><span style="color:#75af00">sliceutils</span><span style="color:#111">.</span><span style="color:#75af00">PodsByCreationTime</span><span style="color:#111">(</span><span style="color:#75af00">pods</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">utilfeature</span><span style="color:#111">.</span><span style="color:#75af00">DefaultFeatureGate</span><span style="color:#111">.</span><span style="color:#75af00">Enabled</span><span style="color:#111">(</span><span style="color:#75af00">features</span><span style="color:#111">.</span><span style="color:#75af00">InPlacePodVerticalScaling</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">podResizeMutex</span><span style="color:#111">.</span><span style="color:#75af00">Lock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">defer</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">podResizeMutex</span><span style="color:#111">.</span><span style="color:#75af00">Unlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">pod</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">pods</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">existingPods</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">podManager</span><span style="color:#111">.</span><span style="color:#75af00">GetPods</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">podManager</span><span style="color:#111">.</span><span style="color:#75af00">AddPod</span><span style="color:#111">(</span><span style="color:#75af00">pod</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">pod</span><span style="color:#111">,</span> <span style="color:#75af00">mirrorPod</span><span style="color:#111">,</span> <span style="color:#75af00">wasMirror</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">podManager</span><span style="color:#111">.</span><span style="color:#75af00">GetPodAndMirrorPod</span><span style="color:#111">(</span><span style="color:#75af00">pod</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">wasMirror</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">pod</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#ae81ff">2</span><span style="color:#111">).</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Unable to find pod for mirror pod, skipping&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;mirrorPod&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">KObj</span><span style="color:#111">(</span><span style="color:#75af00">mirrorPod</span><span style="color:#111">),</span> <span style="color:#d88200">&#34;mirrorPodUID&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">mirrorPod</span><span style="color:#111">.</span><span style="color:#75af00">UID</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">continue</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">podWorkers</span><span style="color:#111">.</span><span style="color:#75af00">UpdatePod</span><span style="color:#111">(</span><span style="color:#75af00">UpdatePodOptions</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">Pod</span><span style="color:#111">:</span>        <span style="color:#75af00">pod</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">MirrorPod</span><span style="color:#111">:</span>  <span style="color:#75af00">mirrorPod</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">UpdateType</span><span style="color:#111">:</span> <span style="color:#75af00">kubetypes</span><span style="color:#111">.</span><span style="color:#75af00">SyncPodUpdate</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">StartTime</span><span style="color:#111">:</span>  <span style="color:#75af00">start</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">continue</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">podWorkers</span><span style="color:#111">.</span><span style="color:#75af00">IsPodTerminationRequested</span><span style="color:#111">(</span><span style="color:#75af00">pod</span><span style="color:#111">.</span><span style="color:#75af00">UID</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// We failed pods that we rejected, so activePods include all admitted</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// pods that are alive.</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">activePods</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">filterOutInactivePods</span><span style="color:#111">(</span><span style="color:#75af00">existingPods</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">utilfeature</span><span style="color:#111">.</span><span style="color:#75af00">DefaultFeatureGate</span><span style="color:#111">.</span><span style="color:#75af00">Enabled</span><span style="color:#111">(</span><span style="color:#75af00">features</span><span style="color:#111">.</span><span style="color:#75af00">InPlacePodVerticalScaling</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// To handle kubelet restarts, test pod admissibility using AllocatedResources values</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// (for cpu &amp; memory) from checkpoint store. If found, that is the source of truth.</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">podCopy</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">pod</span><span style="color:#111">.</span><span style="color:#75af00">DeepCopy</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">updateContainerResourceAllocation</span><span style="color:#111">(</span><span style="color:#75af00">podCopy</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// Check if we can admit the pod; if not, reject it.</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">if</span> <span style="color:#75af00">ok</span><span style="color:#111">,</span> <span style="color:#75af00">reason</span><span style="color:#111">,</span> <span style="color:#75af00">message</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">canAdmitPod</span><span style="color:#111">(</span><span style="color:#75af00">activePods</span><span style="color:#111">,</span> <span style="color:#75af00">podCopy</span><span style="color:#111">);</span> <span style="color:#111">!</span><span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">rejectPod</span><span style="color:#111">(</span><span style="color:#75af00">pod</span><span style="color:#111">,</span> <span style="color:#75af00">reason</span><span style="color:#111">,</span> <span style="color:#75af00">message</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>					<span style="color:#00a8c8">continue</span>
</span></span><span style="display:flex;"><span>				<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// For new pod, checkpoint the resource values at which the Pod has been admitted</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">statusManager</span><span style="color:#111">.</span><span style="color:#75af00">SetPodAllocation</span><span style="color:#111">(</span><span style="color:#75af00">podCopy</span><span style="color:#111">);</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75715e">//TODO(vinaykul,InPlacePodVerticalScaling): Can we recover from this in some way? Investigate</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">ErrorS</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;SetPodAllocation failed&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;pod&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">KObj</span><span style="color:#111">(</span><span style="color:#75af00">pod</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>				<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// Check if we can admit the pod; if not, reject it.</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">if</span> <span style="color:#75af00">ok</span><span style="color:#111">,</span> <span style="color:#75af00">reason</span><span style="color:#111">,</span> <span style="color:#75af00">message</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">canAdmitPod</span><span style="color:#111">(</span><span style="color:#75af00">activePods</span><span style="color:#111">,</span> <span style="color:#75af00">pod</span><span style="color:#111">);</span> <span style="color:#111">!</span><span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">rejectPod</span><span style="color:#111">(</span><span style="color:#75af00">pod</span><span style="color:#111">,</span> <span style="color:#75af00">reason</span><span style="color:#111">,</span> <span style="color:#75af00">message</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>					<span style="color:#00a8c8">continue</span>
</span></span><span style="display:flex;"><span>				<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">podWorkers</span><span style="color:#111">.</span><span style="color:#75af00">UpdatePod</span><span style="color:#111">(</span><span style="color:#75af00">UpdatePodOptions</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">Pod</span><span style="color:#111">:</span>        <span style="color:#75af00">pod</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">MirrorPod</span><span style="color:#111">:</span>  <span style="color:#75af00">mirrorPod</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">UpdateType</span><span style="color:#111">:</span> <span style="color:#75af00">kubetypes</span><span style="color:#111">.</span><span style="color:#75af00">SyncPodCreate</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">StartTime</span><span style="color:#111">:</span>  <span style="color:#75af00">start</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">kl</span> <span style="color:#f92672">*</span><span style="color:#75af00">Kubelet</span><span style="color:#111">)</span> <span style="color:#75af00">HandlePodUpdates</span><span style="color:#111">(</span><span style="color:#75af00">pods</span> <span style="color:#111">[]</span><span style="color:#f92672">*</span><span style="color:#75af00">v1</span><span style="color:#111">.</span><span style="color:#75af00">Pod</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">start</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">clock</span><span style="color:#111">.</span><span style="color:#75af00">Now</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">pod</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">pods</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">podManager</span><span style="color:#111">.</span><span style="color:#75af00">UpdatePod</span><span style="color:#111">(</span><span style="color:#75af00">pod</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">pod</span><span style="color:#111">,</span> <span style="color:#75af00">mirrorPod</span><span style="color:#111">,</span> <span style="color:#75af00">wasMirror</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">podManager</span><span style="color:#111">.</span><span style="color:#75af00">GetPodAndMirrorPod</span><span style="color:#111">(</span><span style="color:#75af00">pod</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">wasMirror</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">pod</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#ae81ff">2</span><span style="color:#111">).</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Unable to find pod for mirror pod, skipping&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;mirrorPod&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">KObj</span><span style="color:#111">(</span><span style="color:#75af00">mirrorPod</span><span style="color:#111">),</span> <span style="color:#d88200">&#34;mirrorPodUID&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">mirrorPod</span><span style="color:#111">.</span><span style="color:#75af00">UID</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">continue</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">podWorkers</span><span style="color:#111">.</span><span style="color:#75af00">UpdatePod</span><span style="color:#111">(</span><span style="color:#75af00">UpdatePodOptions</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">Pod</span><span style="color:#111">:</span>        <span style="color:#75af00">pod</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">MirrorPod</span><span style="color:#111">:</span>  <span style="color:#75af00">mirrorPod</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">UpdateType</span><span style="color:#111">:</span> <span style="color:#75af00">kubetypes</span><span style="color:#111">.</span><span style="color:#75af00">SyncPodUpdate</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">StartTime</span><span style="color:#111">:</span>  <span style="color:#75af00">start</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">kl</span> <span style="color:#f92672">*</span><span style="color:#75af00">Kubelet</span><span style="color:#111">)</span> <span style="color:#75af00">HandlePodRemoves</span><span style="color:#111">(</span><span style="color:#75af00">pods</span> <span style="color:#111">[]</span><span style="color:#f92672">*</span><span style="color:#75af00">v1</span><span style="color:#111">.</span><span style="color:#75af00">Pod</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">start</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">clock</span><span style="color:#111">.</span><span style="color:#75af00">Now</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">pod</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">pods</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">podManager</span><span style="color:#111">.</span><span style="color:#75af00">RemovePod</span><span style="color:#111">(</span><span style="color:#75af00">pod</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">pod</span><span style="color:#111">,</span> <span style="color:#75af00">mirrorPod</span><span style="color:#111">,</span> <span style="color:#75af00">wasMirror</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">podManager</span><span style="color:#111">.</span><span style="color:#75af00">GetPodAndMirrorPod</span><span style="color:#111">(</span><span style="color:#75af00">pod</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">wasMirror</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">pod</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#ae81ff">2</span><span style="color:#111">).</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Unable to find pod for mirror pod, skipping&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;mirrorPod&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">KObj</span><span style="color:#111">(</span><span style="color:#75af00">mirrorPod</span><span style="color:#111">),</span> <span style="color:#d88200">&#34;mirrorPodUID&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">mirrorPod</span><span style="color:#111">.</span><span style="color:#75af00">UID</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">continue</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">podWorkers</span><span style="color:#111">.</span><span style="color:#75af00">UpdatePod</span><span style="color:#111">(</span><span style="color:#75af00">UpdatePodOptions</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">Pod</span><span style="color:#111">:</span>        <span style="color:#75af00">pod</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">MirrorPod</span><span style="color:#111">:</span>  <span style="color:#75af00">mirrorPod</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">UpdateType</span><span style="color:#111">:</span> <span style="color:#75af00">kubetypes</span><span style="color:#111">.</span><span style="color:#75af00">SyncPodUpdate</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">StartTime</span><span style="color:#111">:</span>  <span style="color:#75af00">start</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">continue</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Deletion is allowed to fail because the periodic cleanup routine</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// will trigger deletion again.</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">deletePod</span><span style="color:#111">(</span><span style="color:#75af00">pod</span><span style="color:#111">);</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#ae81ff">2</span><span style="color:#111">).</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Failed to delete pod&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;pod&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">KObj</span><span style="color:#111">(</span><span style="color:#75af00">pod</span><span style="color:#111">),</span> <span style="color:#d88200">&#34;err&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">kl</span> <span style="color:#f92672">*</span><span style="color:#75af00">Kubelet</span><span style="color:#111">)</span> <span style="color:#75af00">HandlePodReconcile</span><span style="color:#111">(</span><span style="color:#75af00">pods</span> <span style="color:#111">[]</span><span style="color:#f92672">*</span><span style="color:#75af00">v1</span><span style="color:#111">.</span><span style="color:#75af00">Pod</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">start</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">clock</span><span style="color:#111">.</span><span style="color:#75af00">Now</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">pod</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">pods</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Update the pod in pod manager, status manager will do periodically reconcile according</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// to the pod manager.</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">podManager</span><span style="color:#111">.</span><span style="color:#75af00">UpdatePod</span><span style="color:#111">(</span><span style="color:#75af00">pod</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">pod</span><span style="color:#111">,</span> <span style="color:#75af00">mirrorPod</span><span style="color:#111">,</span> <span style="color:#75af00">wasMirror</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">podManager</span><span style="color:#111">.</span><span style="color:#75af00">GetPodAndMirrorPod</span><span style="color:#111">(</span><span style="color:#75af00">pod</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">wasMirror</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">pod</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#ae81ff">2</span><span style="color:#111">).</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Unable to find pod for mirror pod, skipping&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;mirrorPod&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">KObj</span><span style="color:#111">(</span><span style="color:#75af00">mirrorPod</span><span style="color:#111">),</span> <span style="color:#d88200">&#34;mirrorPodUID&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">mirrorPod</span><span style="color:#111">.</span><span style="color:#75af00">UID</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">continue</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// Static pods should be reconciled the same way as regular pods</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// TODO: reconcile being calculated in the config manager is questionable, and avoiding</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// extra syncs may no longer be necessary. Reevaluate whether Reconcile and Sync can be</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// merged (after resolving the next two TODOs).</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Reconcile Pod &#34;Ready&#34; condition if necessary. Trigger sync pod for reconciliation.</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// TODO: this should be unnecessary today - determine what is the cause for this to</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// be different than Sync, or if there is a better place for it. For instance, we have</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// needsReconcile in kubelet/config, here, and in status_manager.</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">status</span><span style="color:#111">.</span><span style="color:#75af00">NeedToReconcilePodReadiness</span><span style="color:#111">(</span><span style="color:#75af00">pod</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">podWorkers</span><span style="color:#111">.</span><span style="color:#75af00">UpdatePod</span><span style="color:#111">(</span><span style="color:#75af00">UpdatePodOptions</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">Pod</span><span style="color:#111">:</span>        <span style="color:#75af00">pod</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">MirrorPod</span><span style="color:#111">:</span>  <span style="color:#75af00">mirrorPod</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">UpdateType</span><span style="color:#111">:</span> <span style="color:#75af00">kubetypes</span><span style="color:#111">.</span><span style="color:#75af00">SyncPodSync</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">StartTime</span><span style="color:#111">:</span>  <span style="color:#75af00">start</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// After an evicted pod is synced, all dead containers in the pod can be removed.</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// TODO: this is questionable - status read is async and during eviction we already</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// expect to not have some container info. The pod worker knows whether a pod has</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// been evicted, so if this is about minimizing the time to react to an eviction we</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// can do better. If it&#39;s about preserving pod status info we can also do better.</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">eviction</span><span style="color:#111">.</span><span style="color:#75af00">PodIsEvicted</span><span style="color:#111">(</span><span style="color:#75af00">pod</span><span style="color:#111">.</span><span style="color:#75af00">Status</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">podStatus</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">podCache</span><span style="color:#111">.</span><span style="color:#75af00">Get</span><span style="color:#111">(</span><span style="color:#75af00">pod</span><span style="color:#111">.</span><span style="color:#75af00">UID</span><span style="color:#111">);</span> <span style="color:#75af00">err</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">containerDeletor</span><span style="color:#111">.</span><span style="color:#75af00">deleteContainersInPod</span><span style="color:#111">(</span><span style="color:#d88200">&#34;&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">podStatus</span><span style="color:#111">,</span> <span style="color:#00a8c8">true</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">kl</span> <span style="color:#f92672">*</span><span style="color:#75af00">Kubelet</span><span style="color:#111">)</span> <span style="color:#75af00">HandlePodSyncs</span><span style="color:#111">(</span><span style="color:#75af00">pods</span> <span style="color:#111">[]</span><span style="color:#f92672">*</span><span style="color:#75af00">v1</span><span style="color:#111">.</span><span style="color:#75af00">Pod</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">start</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">clock</span><span style="color:#111">.</span><span style="color:#75af00">Now</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">pod</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">pods</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">pod</span><span style="color:#111">,</span> <span style="color:#75af00">mirrorPod</span><span style="color:#111">,</span> <span style="color:#75af00">wasMirror</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">podManager</span><span style="color:#111">.</span><span style="color:#75af00">GetPodAndMirrorPod</span><span style="color:#111">(</span><span style="color:#75af00">pod</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">wasMirror</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">pod</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#ae81ff">2</span><span style="color:#111">).</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Unable to find pod for mirror pod, skipping&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;mirrorPod&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">KObj</span><span style="color:#111">(</span><span style="color:#75af00">mirrorPod</span><span style="color:#111">),</span> <span style="color:#d88200">&#34;mirrorPodUID&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">mirrorPod</span><span style="color:#111">.</span><span style="color:#75af00">UID</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">continue</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// Syncing a mirror pod is a programmer error since the intent of sync is to</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// batch notify all pending work. We should make it impossible to double sync,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// but for now log a programmer error to prevent accidental introduction.</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#ae81ff">3</span><span style="color:#111">).</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Programmer error, HandlePodSyncs does not expect to receive mirror pods&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;podUID&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">pod</span><span style="color:#111">.</span><span style="color:#75af00">UID</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;mirrorPodUID&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">mirrorPod</span><span style="color:#111">.</span><span style="color:#75af00">UID</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">continue</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">podWorkers</span><span style="color:#111">.</span><span style="color:#75af00">UpdatePod</span><span style="color:#111">(</span><span style="color:#75af00">UpdatePodOptions</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">Pod</span><span style="color:#111">:</span>        <span style="color:#75af00">pod</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">MirrorPod</span><span style="color:#111">:</span>  <span style="color:#75af00">mirrorPod</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">UpdateType</span><span style="color:#111">:</span> <span style="color:#75af00">kubetypes</span><span style="color:#111">.</span><span style="color:#75af00">SyncPodSync</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">StartTime</span><span style="color:#111">:</span>  <span style="color:#75af00">start</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">kl</span> <span style="color:#f92672">*</span><span style="color:#75af00">Kubelet</span><span style="color:#111">)</span> <span style="color:#75af00">HandlePodCleanups</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// The kubelet lacks checkpointing, so we need to introspect the set of pods</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// in the cgroup tree prior to inspecting the set of pods in our pod manager.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// this ensures our view of the cgroup tree does not mistakenly observe pods</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// that are added after the fact...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">var</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">cgroupPods</span> <span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#75af00">types</span><span style="color:#111">.</span><span style="color:#75af00">UID</span><span style="color:#111">]</span><span style="color:#75af00">cm</span><span style="color:#111">.</span><span style="color:#75af00">CgroupName</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">err</span>        <span style="color:#00a8c8">error</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">cgroupsPerQOS</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">pcm</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">containerManager</span><span style="color:#111">.</span><span style="color:#75af00">NewPodContainerManager</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">cgroupPods</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">pcm</span><span style="color:#111">.</span><span style="color:#75af00">GetAllPodsFromCgroups</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;failed to get list of pods that still exist on cgroup mounts: %v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">allPods</span><span style="color:#111">,</span> <span style="color:#75af00">mirrorPods</span><span style="color:#111">,</span> <span style="color:#75af00">orphanedMirrorPodFullnames</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">podManager</span><span style="color:#111">.</span><span style="color:#75af00">GetPodsAndMirrorPods</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Pod phase progresses monotonically. Once a pod has reached a final state,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// it should never leave regardless of the restart policy. The statuses</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// of such pods should not be changed, and there is no need to sync them.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// TODO: the logic here does not handle two cases:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//   1. If the containers were removed immediately after they died, kubelet</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//      may fail to generate correct statuses, let alone filtering correctly.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//   2. If kubelet restarted before writing the terminated status for a pod</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//      to the apiserver, it could still restart the terminated pod (even</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//      though the pod was not considered terminated by the apiserver).</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// These two conditions could be alleviated by checkpointing kubelet.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Stop the workers for terminated pods not in the config source</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#ae81ff">3</span><span style="color:#111">).</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Clean up pod workers for terminated pods&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">workingPods</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">podWorkers</span><span style="color:#111">.</span><span style="color:#75af00">SyncKnownPods</span><span style="color:#111">(</span><span style="color:#75af00">allPods</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Reconcile: At this point the pod workers have been pruned to the set of</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// desired pods. Pods that must be restarted due to UID reuse, or leftover</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// pods from previous runs, are not known to the pod worker.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">allPodsByUID</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#75af00">types</span><span style="color:#111">.</span><span style="color:#75af00">UID</span><span style="color:#111">]</span><span style="color:#f92672">*</span><span style="color:#75af00">v1</span><span style="color:#111">.</span><span style="color:#75af00">Pod</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">pod</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">allPods</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">allPodsByUID</span><span style="color:#111">[</span><span style="color:#75af00">pod</span><span style="color:#111">.</span><span style="color:#75af00">UID</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#75af00">pod</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Identify the set of pods that have workers, which should be all pods</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// from config that are not terminated, as well as any terminating pods</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// that have already been removed from config. Pods that are terminating</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// will be added to possiblyRunningPods, to prevent overly aggressive</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// cleanup of pod cgroups.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">stringIfTrue</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">t</span> <span style="color:#00a8c8">bool</span><span style="color:#111">)</span> <span style="color:#00a8c8">string</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">t</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#d88200">&#34;true&#34;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#d88200">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">runningPods</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#75af00">types</span><span style="color:#111">.</span><span style="color:#75af00">UID</span><span style="color:#111">]</span><span style="color:#75af00">sets</span><span style="color:#111">.</span><span style="color:#75af00">Empty</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">possiblyRunningPods</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#75af00">types</span><span style="color:#111">.</span><span style="color:#75af00">UID</span><span style="color:#111">]</span><span style="color:#75af00">sets</span><span style="color:#111">.</span><span style="color:#75af00">Empty</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">uid</span><span style="color:#111">,</span> <span style="color:#75af00">sync</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">workingPods</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">switch</span> <span style="color:#75af00">sync</span><span style="color:#111">.</span><span style="color:#75af00">State</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">case</span> <span style="color:#75af00">SyncPod</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">runningPods</span><span style="color:#111">[</span><span style="color:#75af00">uid</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#00a8c8">struct</span><span style="color:#111">{}{}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">possiblyRunningPods</span><span style="color:#111">[</span><span style="color:#75af00">uid</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#00a8c8">struct</span><span style="color:#111">{}{}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">case</span> <span style="color:#75af00">TerminatingPod</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">possiblyRunningPods</span><span style="color:#111">[</span><span style="color:#75af00">uid</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#00a8c8">struct</span><span style="color:#111">{}{}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">default</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Retrieve the list of running containers from the runtime to perform cleanup.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// We need the latest state to avoid delaying restarts of static pods that reuse</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// a UID.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">runtimeCache</span><span style="color:#111">.</span><span style="color:#75af00">ForceUpdateIfOlder</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">clock</span><span style="color:#111">.</span><span style="color:#75af00">Now</span><span style="color:#111">());</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">ErrorS</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Error listing containers&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">runningRuntimePods</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">runtimeCache</span><span style="color:#111">.</span><span style="color:#75af00">GetPods</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">ErrorS</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Error listing containers&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Stop probing pods that are not running</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#ae81ff">3</span><span style="color:#111">).</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Clean up probes for terminated pods&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">probeManager</span><span style="color:#111">.</span><span style="color:#75af00">CleanupPods</span><span style="color:#111">(</span><span style="color:#75af00">possiblyRunningPods</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Remove orphaned pod statuses not in the total list of known config pods</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#ae81ff">3</span><span style="color:#111">).</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Clean up orphaned pod statuses&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">removeOrphanedPodStatuses</span><span style="color:#111">(</span><span style="color:#75af00">allPods</span><span style="color:#111">,</span> <span style="color:#75af00">mirrorPods</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Remove orphaned pod user namespace allocations (if any).</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#ae81ff">3</span><span style="color:#111">).</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Clean up orphaned pod user namespace allocations&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">usernsManager</span><span style="color:#111">.</span><span style="color:#75af00">CleanupOrphanedPodUsernsAllocations</span><span style="color:#111">(</span><span style="color:#75af00">allPods</span><span style="color:#111">,</span> <span style="color:#75af00">runningRuntimePods</span><span style="color:#111">);</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">ErrorS</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Failed cleaning up orphaned pod user namespaces allocations&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Remove orphaned volumes from pods that are known not to have any</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// containers. Note that we pass all pods (including terminated pods) to</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// the function, so that we don&#39;t remove volumes associated with terminated</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// but not yet deleted pods.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// TODO: this method could more aggressively cleanup terminated pods</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// in the future (volumes, mount dirs, logs, and containers could all be</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// better separated)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#ae81ff">3</span><span style="color:#111">).</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Clean up orphaned pod directories&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">cleanupOrphanedPodDirs</span><span style="color:#111">(</span><span style="color:#75af00">allPods</span><span style="color:#111">,</span> <span style="color:#75af00">runningRuntimePods</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// We want all cleanup tasks to be run even if one of them failed. So</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// we just log an error here and continue other cleanup tasks.</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// This also applies to the other clean up tasks.</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">ErrorS</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Failed cleaning up orphaned pod directories&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Remove any orphaned mirror pods (mirror pods are tracked by name via the</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// pod worker)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#ae81ff">3</span><span style="color:#111">).</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Clean up orphaned mirror pods&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">podFullname</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">orphanedMirrorPodFullnames</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">podWorkers</span><span style="color:#111">.</span><span style="color:#75af00">IsPodForMirrorPodTerminatingByFullName</span><span style="color:#111">(</span><span style="color:#75af00">podFullname</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">mirrorPodClient</span><span style="color:#111">.</span><span style="color:#75af00">DeleteMirrorPod</span><span style="color:#111">(</span><span style="color:#75af00">podFullname</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">ErrorS</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Encountered error when deleting mirror pod&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;podName&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">podFullname</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#ae81ff">3</span><span style="color:#111">).</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Deleted mirror pod&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;podName&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">podFullname</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// After pruning pod workers for terminated pods get the list of active pods for</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// metrics and to determine restarts.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">activePods</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">filterOutInactivePods</span><span style="color:#111">(</span><span style="color:#75af00">allPods</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">allRegularPods</span><span style="color:#111">,</span> <span style="color:#75af00">allStaticPods</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">splitPodsByStatic</span><span style="color:#111">(</span><span style="color:#75af00">allPods</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">activeRegularPods</span><span style="color:#111">,</span> <span style="color:#75af00">activeStaticPods</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">splitPodsByStatic</span><span style="color:#111">(</span><span style="color:#75af00">activePods</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">metrics</span><span style="color:#111">.</span><span style="color:#75af00">DesiredPodCount</span><span style="color:#111">.</span><span style="color:#75af00">WithLabelValues</span><span style="color:#111">(</span><span style="color:#d88200">&#34;&#34;</span><span style="color:#111">).</span><span style="color:#75af00">Set</span><span style="color:#111">(</span><span style="color:#111">float64</span><span style="color:#111">(</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">allRegularPods</span><span style="color:#111">)))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">metrics</span><span style="color:#111">.</span><span style="color:#75af00">DesiredPodCount</span><span style="color:#111">.</span><span style="color:#75af00">WithLabelValues</span><span style="color:#111">(</span><span style="color:#d88200">&#34;true&#34;</span><span style="color:#111">).</span><span style="color:#75af00">Set</span><span style="color:#111">(</span><span style="color:#111">float64</span><span style="color:#111">(</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">allStaticPods</span><span style="color:#111">)))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">metrics</span><span style="color:#111">.</span><span style="color:#75af00">ActivePodCount</span><span style="color:#111">.</span><span style="color:#75af00">WithLabelValues</span><span style="color:#111">(</span><span style="color:#d88200">&#34;&#34;</span><span style="color:#111">).</span><span style="color:#75af00">Set</span><span style="color:#111">(</span><span style="color:#111">float64</span><span style="color:#111">(</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">activeRegularPods</span><span style="color:#111">)))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">metrics</span><span style="color:#111">.</span><span style="color:#75af00">ActivePodCount</span><span style="color:#111">.</span><span style="color:#75af00">WithLabelValues</span><span style="color:#111">(</span><span style="color:#d88200">&#34;true&#34;</span><span style="color:#111">).</span><span style="color:#75af00">Set</span><span style="color:#111">(</span><span style="color:#111">float64</span><span style="color:#111">(</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">activeStaticPods</span><span style="color:#111">)))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">metrics</span><span style="color:#111">.</span><span style="color:#75af00">MirrorPodCount</span><span style="color:#111">.</span><span style="color:#75af00">Set</span><span style="color:#111">(</span><span style="color:#111">float64</span><span style="color:#111">(</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">mirrorPods</span><span style="color:#111">)))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// At this point, the pod worker is aware of which pods are not desired (SyncKnownPods).</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// We now look through the set of active pods for those that the pod worker is not aware of</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// and deliver an update. The most common reason a pod is not known is because the pod was</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// deleted and recreated with the same UID while the pod worker was driving its lifecycle (very</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// very rare for API pods, common for static pods with fixed UIDs). Containers that may still</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// be running from a previous execution must be reconciled by the pod worker&#39;s sync method.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// We must use active pods because that is the set of admitted pods (podManager includes pods</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// that will never be run, and statusManager tracks already rejected pods).</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">var</span> <span style="color:#75af00">restartCount</span><span style="color:#111">,</span> <span style="color:#75af00">restartCountStatic</span> <span style="color:#00a8c8">int</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">desiredPod</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">activePods</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">knownPod</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">workingPods</span><span style="color:#111">[</span><span style="color:#75af00">desiredPod</span><span style="color:#111">.</span><span style="color:#75af00">UID</span><span style="color:#111">];</span> <span style="color:#75af00">knownPod</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">continue</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#ae81ff">3</span><span style="color:#111">).</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Pod will be restarted because it is in the desired set and not known to the pod workers (likely due to UID reuse)&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;podUID&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">desiredPod</span><span style="color:#111">.</span><span style="color:#75af00">UID</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">isStatic</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">kubetypes</span><span style="color:#111">.</span><span style="color:#75af00">IsStaticPod</span><span style="color:#111">(</span><span style="color:#75af00">desiredPod</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">pod</span><span style="color:#111">,</span> <span style="color:#75af00">mirrorPod</span><span style="color:#111">,</span> <span style="color:#75af00">wasMirror</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">podManager</span><span style="color:#111">.</span><span style="color:#75af00">GetPodAndMirrorPod</span><span style="color:#111">(</span><span style="color:#75af00">desiredPod</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">pod</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#f92672">||</span> <span style="color:#75af00">wasMirror</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#ae81ff">2</span><span style="color:#111">).</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Programmer error, restartable pod was a mirror pod but activePods should never contain a mirror pod&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;podUID&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">desiredPod</span><span style="color:#111">.</span><span style="color:#75af00">UID</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">continue</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">podWorkers</span><span style="color:#111">.</span><span style="color:#75af00">UpdatePod</span><span style="color:#111">(</span><span style="color:#75af00">UpdatePodOptions</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">UpdateType</span><span style="color:#111">:</span> <span style="color:#75af00">kubetypes</span><span style="color:#111">.</span><span style="color:#75af00">SyncPodCreate</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">Pod</span><span style="color:#111">:</span>        <span style="color:#75af00">pod</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">MirrorPod</span><span style="color:#111">:</span>  <span style="color:#75af00">mirrorPod</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// the desired pod is now known as well</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">workingPods</span><span style="color:#111">[</span><span style="color:#75af00">desiredPod</span><span style="color:#111">.</span><span style="color:#75af00">UID</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#75af00">PodWorkerSync</span><span style="color:#111">{</span><span style="color:#75af00">State</span><span style="color:#111">:</span> <span style="color:#75af00">SyncPod</span><span style="color:#111">,</span> <span style="color:#75af00">HasConfig</span><span style="color:#111">:</span> <span style="color:#00a8c8">true</span><span style="color:#111">,</span> <span style="color:#75af00">Static</span><span style="color:#111">:</span> <span style="color:#75af00">isStatic</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">isStatic</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// restartable static pods are the normal case</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">restartCountStatic</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// almost certainly means shenanigans, as API pods should never have the same UID after being deleted and recreated</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// unless there is a major API violation</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">restartCount</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">metrics</span><span style="color:#111">.</span><span style="color:#75af00">RestartedPodTotal</span><span style="color:#111">.</span><span style="color:#75af00">WithLabelValues</span><span style="color:#111">(</span><span style="color:#d88200">&#34;true&#34;</span><span style="color:#111">).</span><span style="color:#75af00">Add</span><span style="color:#111">(</span><span style="color:#111">float64</span><span style="color:#111">(</span><span style="color:#75af00">restartCountStatic</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">metrics</span><span style="color:#111">.</span><span style="color:#75af00">RestartedPodTotal</span><span style="color:#111">.</span><span style="color:#75af00">WithLabelValues</span><span style="color:#111">(</span><span style="color:#d88200">&#34;&#34;</span><span style="color:#111">).</span><span style="color:#75af00">Add</span><span style="color:#111">(</span><span style="color:#111">float64</span><span style="color:#111">(</span><span style="color:#75af00">restartCount</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Complete termination of deleted pods that are not runtime pods (don&#39;t have</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// running containers), are terminal, and are not known to pod workers.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// An example is pods rejected during kubelet admission that have never</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// started before (i.e. does not have an orphaned pod).</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Adding the pods with SyncPodKill to pod workers allows to proceed with</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// force-deletion of such pods, yet preventing re-entry of the routine in the</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// next invocation of HandlePodCleanups.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">pod</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">filterTerminalPodsToDelete</span><span style="color:#111">(</span><span style="color:#75af00">allPods</span><span style="color:#111">,</span> <span style="color:#75af00">runningRuntimePods</span><span style="color:#111">,</span> <span style="color:#75af00">workingPods</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#ae81ff">3</span><span style="color:#111">).</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Handling termination and deletion of the pod to pod workers&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;pod&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">KObj</span><span style="color:#111">(</span><span style="color:#75af00">pod</span><span style="color:#111">),</span> <span style="color:#d88200">&#34;podUID&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">pod</span><span style="color:#111">.</span><span style="color:#75af00">UID</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">podWorkers</span><span style="color:#111">.</span><span style="color:#75af00">UpdatePod</span><span style="color:#111">(</span><span style="color:#75af00">UpdatePodOptions</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">UpdateType</span><span style="color:#111">:</span> <span style="color:#75af00">kubetypes</span><span style="color:#111">.</span><span style="color:#75af00">SyncPodKill</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">Pod</span><span style="color:#111">:</span>        <span style="color:#75af00">pod</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Finally, terminate any pods that are observed in the runtime but not present in the list of</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// known running pods from config. If we do terminate running runtime pods that will happen</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// asynchronously in the background and those will be processed in the next invocation of</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// HandlePodCleanups.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">var</span> <span style="color:#75af00">orphanCount</span> <span style="color:#00a8c8">int</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">runningPod</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">runningRuntimePods</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// If there are orphaned pod resources in CRI that are unknown to the pod worker, terminate them</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// now. Since housekeeping is exclusive to other pod worker updates, we know that no pods have</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// been added to the pod worker in the meantime. Note that pods that are not visible in the runtime</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// but which were previously known are terminated by SyncKnownPods().</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">knownPod</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">workingPods</span><span style="color:#111">[</span><span style="color:#75af00">runningPod</span><span style="color:#111">.</span><span style="color:#75af00">ID</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">knownPod</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">one</span> <span style="color:#f92672">:=</span> <span style="color:#111">int64</span><span style="color:#111">(</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">killPodOptions</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">KillPodOptions</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">PodTerminationGracePeriodSecondsOverride</span><span style="color:#111">:</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">one</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#ae81ff">2</span><span style="color:#111">).</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Clean up containers for orphaned pod we had not seen before&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;podUID&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">runningPod</span><span style="color:#111">.</span><span style="color:#75af00">ID</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;killPodOptions&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">killPodOptions</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">podWorkers</span><span style="color:#111">.</span><span style="color:#75af00">UpdatePod</span><span style="color:#111">(</span><span style="color:#75af00">UpdatePodOptions</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">UpdateType</span><span style="color:#111">:</span>     <span style="color:#75af00">kubetypes</span><span style="color:#111">.</span><span style="color:#75af00">SyncPodKill</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">RunningPod</span><span style="color:#111">:</span>     <span style="color:#75af00">runningPod</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">KillPodOptions</span><span style="color:#111">:</span> <span style="color:#75af00">killPodOptions</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// the running pod is now known as well</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">workingPods</span><span style="color:#111">[</span><span style="color:#75af00">runningPod</span><span style="color:#111">.</span><span style="color:#75af00">ID</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#75af00">PodWorkerSync</span><span style="color:#111">{</span><span style="color:#75af00">State</span><span style="color:#111">:</span> <span style="color:#75af00">TerminatingPod</span><span style="color:#111">,</span> <span style="color:#75af00">Orphan</span><span style="color:#111">:</span> <span style="color:#00a8c8">true</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">orphanCount</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">metrics</span><span style="color:#111">.</span><span style="color:#75af00">OrphanedRuntimePodTotal</span><span style="color:#111">.</span><span style="color:#75af00">Add</span><span style="color:#111">(</span><span style="color:#111">float64</span><span style="color:#111">(</span><span style="color:#75af00">orphanCount</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Now that we have recorded any terminating pods, and added new pods that should be running,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// record a summary here. Not all possible combinations of PodWorkerSync values are valid.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">counts</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#75af00">PodWorkerSync</span><span style="color:#111">]</span><span style="color:#00a8c8">int</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">sync</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">workingPods</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">counts</span><span style="color:#111">[</span><span style="color:#75af00">sync</span><span style="color:#111">]</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">validSync</span><span style="color:#111">,</span> <span style="color:#75af00">configState</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#75af00">PodWorkerSync</span><span style="color:#111">]</span><span style="color:#00a8c8">string</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">{</span><span style="color:#75af00">HasConfig</span><span style="color:#111">:</span> <span style="color:#00a8c8">true</span><span style="color:#111">,</span> <span style="color:#75af00">Static</span><span style="color:#111">:</span> <span style="color:#00a8c8">true</span><span style="color:#111">}:</span>                <span style="color:#d88200">&#34;desired&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">{</span><span style="color:#75af00">HasConfig</span><span style="color:#111">:</span> <span style="color:#00a8c8">true</span><span style="color:#111">,</span> <span style="color:#75af00">Static</span><span style="color:#111">:</span> <span style="color:#00a8c8">false</span><span style="color:#111">}:</span>               <span style="color:#d88200">&#34;desired&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">{</span><span style="color:#75af00">Orphan</span><span style="color:#111">:</span> <span style="color:#00a8c8">true</span><span style="color:#111">,</span> <span style="color:#75af00">HasConfig</span><span style="color:#111">:</span> <span style="color:#00a8c8">true</span><span style="color:#111">,</span> <span style="color:#75af00">Static</span><span style="color:#111">:</span> <span style="color:#00a8c8">true</span><span style="color:#111">}:</span>  <span style="color:#d88200">&#34;orphan&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">{</span><span style="color:#75af00">Orphan</span><span style="color:#111">:</span> <span style="color:#00a8c8">true</span><span style="color:#111">,</span> <span style="color:#75af00">HasConfig</span><span style="color:#111">:</span> <span style="color:#00a8c8">true</span><span style="color:#111">,</span> <span style="color:#75af00">Static</span><span style="color:#111">:</span> <span style="color:#00a8c8">false</span><span style="color:#111">}:</span> <span style="color:#d88200">&#34;orphan&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">{</span><span style="color:#75af00">Orphan</span><span style="color:#111">:</span> <span style="color:#00a8c8">true</span><span style="color:#111">,</span> <span style="color:#75af00">HasConfig</span><span style="color:#111">:</span> <span style="color:#00a8c8">false</span><span style="color:#111">}:</span>               <span style="color:#d88200">&#34;runtime_only&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">state</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#111">[]</span><span style="color:#75af00">PodWorkerState</span><span style="color:#111">{</span><span style="color:#75af00">SyncPod</span><span style="color:#111">,</span> <span style="color:#75af00">TerminatingPod</span><span style="color:#111">,</span> <span style="color:#75af00">TerminatedPod</span><span style="color:#111">}</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">validSync</span><span style="color:#111">.</span><span style="color:#75af00">State</span> <span style="color:#111">=</span> <span style="color:#75af00">state</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">count</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">counts</span><span style="color:#111">[</span><span style="color:#75af00">validSync</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">delete</span><span style="color:#111">(</span><span style="color:#75af00">counts</span><span style="color:#111">,</span> <span style="color:#75af00">validSync</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">staticString</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">stringIfTrue</span><span style="color:#111">(</span><span style="color:#75af00">validSync</span><span style="color:#111">.</span><span style="color:#75af00">Static</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">validSync</span><span style="color:#111">.</span><span style="color:#75af00">HasConfig</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">staticString</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;unknown&#34;</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">metrics</span><span style="color:#111">.</span><span style="color:#75af00">WorkingPodCount</span><span style="color:#111">.</span><span style="color:#75af00">WithLabelValues</span><span style="color:#111">(</span><span style="color:#75af00">state</span><span style="color:#111">.</span><span style="color:#75af00">String</span><span style="color:#111">(),</span> <span style="color:#75af00">configState</span><span style="color:#111">,</span> <span style="color:#75af00">staticString</span><span style="color:#111">).</span><span style="color:#75af00">Set</span><span style="color:#111">(</span><span style="color:#111">float64</span><span style="color:#111">(</span><span style="color:#75af00">count</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">counts</span><span style="color:#111">)</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// in case a combination is lost</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#ae81ff">3</span><span style="color:#111">).</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Programmer error, did not report a kubelet_working_pods metric for a value returned by SyncKnownPods&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;counts&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">counts</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Remove any cgroups in the hierarchy for pods that are definitely no longer</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// running (not in the container runtime).</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">cgroupsPerQOS</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">pcm</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">containerManager</span><span style="color:#111">.</span><span style="color:#75af00">NewPodContainerManager</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#ae81ff">3</span><span style="color:#111">).</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Clean up orphaned pod cgroups&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">cleanupOrphanedPodCgroups</span><span style="color:#111">(</span><span style="color:#75af00">pcm</span><span style="color:#111">,</span> <span style="color:#75af00">cgroupPods</span><span style="color:#111">,</span> <span style="color:#75af00">possiblyRunningPods</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Cleanup any backoff entries.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">kl</span><span style="color:#111">.</span><span style="color:#75af00">backOff</span><span style="color:#111">.</span><span style="color:#75af00">GC</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>可以看到这些函数基本都是把pod交给 podWorkers 去处理</p>
<h2 id="podconfig">podconfig</h2>
<p>上文中的 updates channel 是从 podconfig 中获取的 那就来看看 podconfig 是怎么工作的</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">SourcesReady</span> <span style="color:#00a8c8">interface</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// AddSource adds the specified source to the set of sources managed.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">AddSource</span><span style="color:#111">(</span><span style="color:#75af00">source</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// AllReady returns true if the currently configured sources have all been seen.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">AllReady</span><span style="color:#111">()</span> <span style="color:#00a8c8">bool</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// sourcesImpl implements SourcesReady.  It is thread-safe.</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">sourcesImpl</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// lock protects access to sources seen.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">lock</span> <span style="color:#75af00">sync</span><span style="color:#111">.</span><span style="color:#75af00">RWMutex</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// set of sources seen.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">sourcesSeen</span> <span style="color:#75af00">sets</span><span style="color:#111">.</span><span style="color:#75af00">String</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// sourcesReady is a function that evaluates if the sources are ready.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">sourcesReadyFn</span> <span style="color:#75af00">SourcesReadyFn</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>这里定义了接口 接口提中可以存储多个 source 那么有什么 source 呢</p>
<h3 id="kube-apiserver">kube-apiserver</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">NewSourceApiserver</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#75af00">clientset</span><span style="color:#111">.</span><span style="color:#75af00">Interface</span><span style="color:#111">,</span> <span style="color:#75af00">nodeName</span> <span style="color:#75af00">types</span><span style="color:#111">.</span><span style="color:#75af00">NodeName</span><span style="color:#111">,</span> <span style="color:#75af00">nodeHasSynced</span> <span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#00a8c8">bool</span><span style="color:#111">,</span> <span style="color:#75af00">updates</span> <span style="color:#00a8c8">chan</span><span style="color:#f92672">&lt;-</span> <span style="color:#00a8c8">interface</span><span style="color:#111">{})</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">lw</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">cache</span><span style="color:#111">.</span><span style="color:#75af00">NewListWatchFromClient</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">CoreV1</span><span style="color:#111">().</span><span style="color:#75af00">RESTClient</span><span style="color:#111">(),</span> <span style="color:#d88200">&#34;pods&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">metav1</span><span style="color:#111">.</span><span style="color:#75af00">NamespaceAll</span><span style="color:#111">,</span> <span style="color:#75af00">fields</span><span style="color:#111">.</span><span style="color:#75af00">OneTermEqualSelector</span><span style="color:#111">(</span><span style="color:#d88200">&#34;spec.nodeName&#34;</span><span style="color:#111">,</span> <span style="color:#111">string</span><span style="color:#111">(</span><span style="color:#75af00">nodeName</span><span style="color:#111">)))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// The Reflector responsible for watching pods at the apiserver should be run only after</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// the node sync with the apiserver has completed.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Waiting for node sync before watching apiserver pods&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">go</span> <span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">for</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">nodeHasSynced</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#ae81ff">4</span><span style="color:#111">).</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;node sync completed&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">break</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Sleep</span><span style="color:#111">(</span><span style="color:#75af00">WaitForAPIServerSyncPeriod</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#ae81ff">4</span><span style="color:#111">).</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;node sync has not completed yet&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Watching apiserver&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">newSourceApiserverFromLW</span><span style="color:#111">(</span><span style="color:#75af00">lw</span><span style="color:#111">,</span> <span style="color:#75af00">updates</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// newSourceApiserverFromLW holds creates a config source that watches and pulls from the apiserver.</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">newSourceApiserverFromLW</span><span style="color:#111">(</span><span style="color:#75af00">lw</span> <span style="color:#75af00">cache</span><span style="color:#111">.</span><span style="color:#75af00">ListerWatcher</span><span style="color:#111">,</span> <span style="color:#75af00">updates</span> <span style="color:#00a8c8">chan</span><span style="color:#f92672">&lt;-</span> <span style="color:#00a8c8">interface</span><span style="color:#111">{})</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">send</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">objs</span> <span style="color:#111">[]</span><span style="color:#00a8c8">interface</span><span style="color:#111">{})</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">var</span> <span style="color:#75af00">pods</span> <span style="color:#111">[]</span><span style="color:#f92672">*</span><span style="color:#75af00">v1</span><span style="color:#111">.</span><span style="color:#75af00">Pod</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">o</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">objs</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">pods</span> <span style="color:#111">=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">pods</span><span style="color:#111">,</span> <span style="color:#75af00">o</span><span style="color:#111">.(</span><span style="color:#f92672">*</span><span style="color:#75af00">v1</span><span style="color:#111">.</span><span style="color:#75af00">Pod</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">updates</span> <span style="color:#f92672">&lt;-</span> <span style="color:#75af00">kubetypes</span><span style="color:#111">.</span><span style="color:#75af00">PodUpdate</span><span style="color:#111">{</span><span style="color:#75af00">Pods</span><span style="color:#111">:</span> <span style="color:#75af00">pods</span><span style="color:#111">,</span> <span style="color:#75af00">Op</span><span style="color:#111">:</span> <span style="color:#75af00">kubetypes</span><span style="color:#111">.</span><span style="color:#75af00">SET</span><span style="color:#111">,</span> <span style="color:#75af00">Source</span><span style="color:#111">:</span> <span style="color:#75af00">kubetypes</span><span style="color:#111">.</span><span style="color:#75af00">ApiserverSource</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">cache</span><span style="color:#111">.</span><span style="color:#75af00">NewReflector</span><span style="color:#111">(</span><span style="color:#75af00">lw</span><span style="color:#111">,</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">v1</span><span style="color:#111">.</span><span style="color:#75af00">Pod</span><span style="color:#111">{},</span> <span style="color:#75af00">cache</span><span style="color:#111">.</span><span style="color:#75af00">NewUndeltaStore</span><span style="color:#111">(</span><span style="color:#75af00">send</span><span style="color:#111">,</span> <span style="color:#75af00">cache</span><span style="color:#111">.</span><span style="color:#75af00">MetaNamespaceKeyFunc</span><span style="color:#111">),</span> <span style="color:#ae81ff">0</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">go</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">Run</span><span style="color:#111">(</span><span style="color:#75af00">wait</span><span style="color:#111">.</span><span style="color:#75af00">NeverStop</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>可以看到代码简单 就是 watrch apiserver 的 pod 然后把 pods 传给 updates channel</p>
<h3 id="file">file</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">s</span> <span style="color:#f92672">*</span><span style="color:#75af00">sourceFile</span><span style="color:#111">)</span> <span style="color:#75af00">doWatch</span><span style="color:#111">()</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">Stat</span><span style="color:#111">(</span><span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">path</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">IsNotExist</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Emit an update with an empty PodList to allow FileSource to be marked as seen</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">updates</span> <span style="color:#f92672">&lt;-</span> <span style="color:#75af00">kubetypes</span><span style="color:#111">.</span><span style="color:#75af00">PodUpdate</span><span style="color:#111">{</span><span style="color:#75af00">Pods</span><span style="color:#111">:</span> <span style="color:#111">[]</span><span style="color:#f92672">*</span><span style="color:#75af00">v1</span><span style="color:#111">.</span><span style="color:#75af00">Pod</span><span style="color:#111">{},</span> <span style="color:#75af00">Op</span><span style="color:#111">:</span> <span style="color:#75af00">kubetypes</span><span style="color:#111">.</span><span style="color:#75af00">SET</span><span style="color:#111">,</span> <span style="color:#75af00">Source</span><span style="color:#111">:</span> <span style="color:#75af00">kubetypes</span><span style="color:#111">.</span><span style="color:#75af00">FileSource</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">retryableError</span><span style="color:#111">{</span><span style="color:#d88200">&#34;path does not exist, ignoring&#34;</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">w</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">fsnotify</span><span style="color:#111">.</span><span style="color:#75af00">NewWatcher</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;unable to create inotify: %v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">w</span><span style="color:#111">.</span><span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">w</span><span style="color:#111">.</span><span style="color:#75af00">Add</span><span style="color:#111">(</span><span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">path</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;unable to create inotify for path %q: %v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">path</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">select</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">case</span> <span style="color:#75af00">event</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#75af00">w</span><span style="color:#111">.</span><span style="color:#75af00">Events</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">produceWatchEvent</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">event</span><span style="color:#111">);</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">return</span> <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;error while processing inotify event (%+v): %v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">event</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">case</span> <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#f92672">&lt;-</span><span style="color:#75af00">w</span><span style="color:#111">.</span><span style="color:#75af00">Errors</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;error while watching %q: %v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">path</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">s</span> <span style="color:#f92672">*</span><span style="color:#75af00">sourceFile</span><span style="color:#111">)</span> <span style="color:#75af00">produceWatchEvent</span><span style="color:#111">(</span><span style="color:#75af00">e</span> <span style="color:#f92672">*</span><span style="color:#75af00">fsnotify</span><span style="color:#111">.</span><span style="color:#75af00">Event</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Ignore file start with dots</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">strings</span><span style="color:#111">.</span><span style="color:#75af00">HasPrefix</span><span style="color:#111">(</span><span style="color:#75af00">filepath</span><span style="color:#111">.</span><span style="color:#75af00">Base</span><span style="color:#111">(</span><span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">Name</span><span style="color:#111">),</span> <span style="color:#d88200">&#34;.&#34;</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#ae81ff">4</span><span style="color:#111">).</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Ignored pod manifest, because it starts with dots&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;eventName&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">Name</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">var</span> <span style="color:#75af00">eventType</span> <span style="color:#75af00">podEventType</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">switch</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">case</span> <span style="color:#111">(</span><span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">Op</span> <span style="color:#f92672">&amp;</span> <span style="color:#75af00">fsnotify</span><span style="color:#111">.</span><span style="color:#75af00">Create</span><span style="color:#111">)</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">0</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">eventType</span> <span style="color:#111">=</span> <span style="color:#75af00">podAdd</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">case</span> <span style="color:#111">(</span><span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">Op</span> <span style="color:#f92672">&amp;</span> <span style="color:#75af00">fsnotify</span><span style="color:#111">.</span><span style="color:#75af00">Write</span><span style="color:#111">)</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">0</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">eventType</span> <span style="color:#111">=</span> <span style="color:#75af00">podModify</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">case</span> <span style="color:#111">(</span><span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">Op</span> <span style="color:#f92672">&amp;</span> <span style="color:#75af00">fsnotify</span><span style="color:#111">.</span><span style="color:#75af00">Chmod</span><span style="color:#111">)</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">0</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">eventType</span> <span style="color:#111">=</span> <span style="color:#75af00">podModify</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">case</span> <span style="color:#111">(</span><span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">Op</span> <span style="color:#f92672">&amp;</span> <span style="color:#75af00">fsnotify</span><span style="color:#111">.</span><span style="color:#75af00">Remove</span><span style="color:#111">)</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">0</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">eventType</span> <span style="color:#111">=</span> <span style="color:#75af00">podDelete</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">case</span> <span style="color:#111">(</span><span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">Op</span> <span style="color:#f92672">&amp;</span> <span style="color:#75af00">fsnotify</span><span style="color:#111">.</span><span style="color:#75af00">Rename</span><span style="color:#111">)</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">0</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">eventType</span> <span style="color:#111">=</span> <span style="color:#75af00">podDelete</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">default</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Ignore rest events</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">watchEvents</span> <span style="color:#f92672">&lt;-</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">watchEvent</span><span style="color:#111">{</span><span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">Name</span><span style="color:#111">,</span> <span style="color:#75af00">eventType</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">s</span> <span style="color:#f92672">*</span><span style="color:#75af00">sourceFile</span><span style="color:#111">)</span> <span style="color:#75af00">run</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">listTicker</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">NewTicker</span><span style="color:#111">(</span><span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">period</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">go</span> <span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Read path immediately to speed up startup.</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">listConfig</span><span style="color:#111">();</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">ErrorS</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Unable to read config path&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;path&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">path</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">for</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">select</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#75af00">listTicker</span><span style="color:#111">.</span><span style="color:#75af00">C</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">listConfig</span><span style="color:#111">();</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">ErrorS</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Unable to read config path&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;path&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">path</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">case</span> <span style="color:#75af00">e</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">watchEvents</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">consumeWatchEvent</span><span style="color:#111">(</span><span style="color:#75af00">e</span><span style="color:#111">);</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">ErrorS</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Unable to process watch event&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">startWatch</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>上面是 file source 的代码 也是 watch 文件变化 然后把变化的 pod 传给 updates channel
这个主要的作用就是 kubeadm 等部署 k8s 集群 使用文件拉起 kube-apiserver etcd kube-controller-manager kube-scheduler 等组件</p>
<h3 id="http">http</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">s</span> <span style="color:#f92672">*</span><span style="color:#75af00">sourceURL</span><span style="color:#111">)</span> <span style="color:#75af00">run</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">extractFromURL</span><span style="color:#111">();</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Don&#39;t log this multiple times per minute. The first few entries should be</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// enough to get the point across.</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">failureLogs</span> <span style="color:#111">&lt;</span> <span style="color:#ae81ff">3</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Failed to read pods from URL&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;err&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#00a8c8">if</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">failureLogs</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">3</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Failed to read pods from URL. Dropping verbosity of this message to V(4)&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;err&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#ae81ff">4</span><span style="color:#111">).</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Failed to read pods from URL&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;err&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">failureLogs</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">failureLogs</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Successfully read pods from URL&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">failureLogs</span> <span style="color:#111">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">s</span> <span style="color:#f92672">*</span><span style="color:#75af00">sourceURL</span><span style="color:#111">)</span> <span style="color:#75af00">applyDefaults</span><span style="color:#111">(</span><span style="color:#75af00">pod</span> <span style="color:#f92672">*</span><span style="color:#75af00">api</span><span style="color:#111">.</span><span style="color:#75af00">Pod</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">applyDefaults</span><span style="color:#111">(</span><span style="color:#75af00">pod</span><span style="color:#111">,</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">url</span><span style="color:#111">,</span> <span style="color:#00a8c8">false</span><span style="color:#111">,</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">nodeName</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">s</span> <span style="color:#f92672">*</span><span style="color:#75af00">sourceURL</span><span style="color:#111">)</span> <span style="color:#75af00">extractFromURL</span><span style="color:#111">()</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">req</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">NewRequest</span><span style="color:#111">(</span><span style="color:#d88200">&#34;GET&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">url</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">req</span><span style="color:#111">.</span><span style="color:#75af00">Header</span> <span style="color:#111">=</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">header</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">resp</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">client</span><span style="color:#111">.</span><span style="color:#75af00">Do</span><span style="color:#111">(</span><span style="color:#75af00">req</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">resp</span><span style="color:#111">.</span><span style="color:#75af00">Body</span><span style="color:#111">.</span><span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">data</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">utilio</span><span style="color:#111">.</span><span style="color:#75af00">ReadAtMost</span><span style="color:#111">(</span><span style="color:#75af00">resp</span><span style="color:#111">.</span><span style="color:#75af00">Body</span><span style="color:#111">,</span> <span style="color:#75af00">maxConfigLength</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">resp</span><span style="color:#111">.</span><span style="color:#75af00">StatusCode</span> <span style="color:#f92672">!=</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">StatusOK</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;%v: %v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">url</span><span style="color:#111">,</span> <span style="color:#75af00">resp</span><span style="color:#111">.</span><span style="color:#75af00">Status</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">data</span><span style="color:#111">)</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Emit an update with an empty PodList to allow HTTPSource to be marked as seen</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">updates</span> <span style="color:#f92672">&lt;-</span> <span style="color:#75af00">kubetypes</span><span style="color:#111">.</span><span style="color:#75af00">PodUpdate</span><span style="color:#111">{</span><span style="color:#75af00">Pods</span><span style="color:#111">:</span> <span style="color:#111">[]</span><span style="color:#f92672">*</span><span style="color:#75af00">v1</span><span style="color:#111">.</span><span style="color:#75af00">Pod</span><span style="color:#111">{},</span> <span style="color:#75af00">Op</span><span style="color:#111">:</span> <span style="color:#75af00">kubetypes</span><span style="color:#111">.</span><span style="color:#75af00">SET</span><span style="color:#111">,</span> <span style="color:#75af00">Source</span><span style="color:#111">:</span> <span style="color:#75af00">kubetypes</span><span style="color:#111">.</span><span style="color:#75af00">HTTPSource</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;zero-length data received from %v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">url</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Short circuit if the data has not changed since the last time it was read.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">bytes</span><span style="color:#111">.</span><span style="color:#75af00">Equal</span><span style="color:#111">(</span><span style="color:#75af00">data</span><span style="color:#111">,</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">data</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">data</span> <span style="color:#111">=</span> <span style="color:#75af00">data</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// First try as it is a single pod.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">parsed</span><span style="color:#111">,</span> <span style="color:#75af00">pod</span><span style="color:#111">,</span> <span style="color:#75af00">singlePodErr</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">tryDecodeSinglePod</span><span style="color:#111">(</span><span style="color:#75af00">data</span><span style="color:#111">,</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">applyDefaults</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">parsed</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">singlePodErr</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// It parsed but could not be used.</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#75af00">singlePodErr</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">updates</span> <span style="color:#f92672">&lt;-</span> <span style="color:#75af00">kubetypes</span><span style="color:#111">.</span><span style="color:#75af00">PodUpdate</span><span style="color:#111">{</span><span style="color:#75af00">Pods</span><span style="color:#111">:</span> <span style="color:#111">[]</span><span style="color:#f92672">*</span><span style="color:#75af00">v1</span><span style="color:#111">.</span><span style="color:#75af00">Pod</span><span style="color:#111">{</span><span style="color:#75af00">pod</span><span style="color:#111">},</span> <span style="color:#75af00">Op</span><span style="color:#111">:</span> <span style="color:#75af00">kubetypes</span><span style="color:#111">.</span><span style="color:#75af00">SET</span><span style="color:#111">,</span> <span style="color:#75af00">Source</span><span style="color:#111">:</span> <span style="color:#75af00">kubetypes</span><span style="color:#111">.</span><span style="color:#75af00">HTTPSource</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// That didn&#39;t work, so try a list of pods.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">parsed</span><span style="color:#111">,</span> <span style="color:#75af00">podList</span><span style="color:#111">,</span> <span style="color:#75af00">multiPodErr</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">tryDecodePodList</span><span style="color:#111">(</span><span style="color:#75af00">data</span><span style="color:#111">,</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">applyDefaults</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">parsed</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">multiPodErr</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// It parsed but could not be used.</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#75af00">multiPodErr</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">pods</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">([]</span><span style="color:#f92672">*</span><span style="color:#75af00">v1</span><span style="color:#111">.</span><span style="color:#75af00">Pod</span><span style="color:#111">,</span> <span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">podList</span><span style="color:#111">.</span><span style="color:#75af00">Items</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">for</span> <span style="color:#75af00">i</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">podList</span><span style="color:#111">.</span><span style="color:#75af00">Items</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">pods</span> <span style="color:#111">=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">pods</span><span style="color:#111">,</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">podList</span><span style="color:#111">.</span><span style="color:#75af00">Items</span><span style="color:#111">[</span><span style="color:#75af00">i</span><span style="color:#111">])</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">updates</span> <span style="color:#f92672">&lt;-</span> <span style="color:#75af00">kubetypes</span><span style="color:#111">.</span><span style="color:#75af00">PodUpdate</span><span style="color:#111">{</span><span style="color:#75af00">Pods</span><span style="color:#111">:</span> <span style="color:#75af00">pods</span><span style="color:#111">,</span> <span style="color:#75af00">Op</span><span style="color:#111">:</span> <span style="color:#75af00">kubetypes</span><span style="color:#111">.</span><span style="color:#75af00">SET</span><span style="color:#111">,</span> <span style="color:#75af00">Source</span><span style="color:#111">:</span> <span style="color:#75af00">kubetypes</span><span style="color:#111">.</span><span style="color:#75af00">HTTPSource</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;%v: received &#39;%v&#39;, but couldn&#39;t parse as &#34;</span><span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>		<span style="color:#d88200">&#34;single (%v) or multiple pods (%v)&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">url</span><span style="color:#111">,</span> <span style="color:#111">string</span><span style="color:#111">(</span><span style="color:#75af00">data</span><span style="color:#111">),</span> <span style="color:#75af00">singlePodErr</span><span style="color:#111">,</span> <span style="color:#75af00">multiPodErr</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>http source 是 kubelet 本身开启 http 服务 通过调用 kubelet 的 http 接口来管理 pod 这个主要的作用是 给那些不想部署集群 只想使用 kubelet 的需求提供的</p>
<h2 id="pleg">PLEG</h2>
<p>PLEG（Pod Lifecycle Event Generator）是 Kubernetes 中的一个关键组件，它负责监视和处理 Pod 的生命周期事件。PLEG 运行在每个节点上，并与 kubelet 组件紧密配合工作。</p>
<p>PLEG 的主要功能包括：</p>
<ol>
<li>监控容器状态：PLEG 监控每个节点上正在运行的容器的状态，并根据其状态变化生成相应的事件。</li>
<li>生成事件：当容器的状态发生变化时，PLEG 会生成相应的事件，例如容器的创建、启动、停止、退出等事件。</li>
<li>同步状态：PLEG 通过与 kubelet 进行交互，将容器的状态信息同步给 kubelet，使 kubelet 能够了解容器的当前状态。</li>
<li>故障处理：PLEG 检测容器的状态变化，并在发现容器失败或异常时生成相应的事件，以便 kubelet 采取适当的故障处理措施。</li>
</ol>
<p>PLEG 的设计目标是提供高效可靠的容器生命周期事件处理。它使用操作系统的文件系统事件和容器运行时的状态查询机制来监视容器的状态变化，从而及时地生成相应的事件。这些事件对于监控、日志记录、故障排除和自动恢复等方面非常重要。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">PodLifecycleEventGenerator</span> <span style="color:#00a8c8">interface</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Start</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Watch</span><span style="color:#111">()</span> <span style="color:#00a8c8">chan</span> <span style="color:#f92672">*</span><span style="color:#75af00">PodLifecycleEvent</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Healthy</span><span style="color:#111">()</span> <span style="color:#111">(</span><span style="color:#00a8c8">bool</span><span style="color:#111">,</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">UpdateCache</span><span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">kubecontainer</span><span style="color:#111">.</span><span style="color:#75af00">Pod</span><span style="color:#111">,</span> <span style="color:#75af00">types</span><span style="color:#111">.</span><span style="color:#75af00">UID</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#00a8c8">error</span><span style="color:#111">,</span> <span style="color:#00a8c8">bool</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>kubelet 中实现了两种 PLEG，分别是：</p>
<ul>
<li>通用 PLEG：用于处理普通容器的生命周期事件。使用轮询机制监控容器的状态变化，因此可能会有一定的延迟。而且耗费资源较多，不适合大规模部署。</li>
<li>Event PLEG：用于处理事件容器的生命周期事件。使用事件机制监控容器的状态变化，因此响应速度较快。但是，他需要 container runtime 支持事件机制。</li>
</ul>
<h3 id="genericpleg">GenericPLEG</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">g</span> <span style="color:#f92672">*</span><span style="color:#75af00">GenericPLEG</span><span style="color:#111">)</span> <span style="color:#75af00">Watch</span><span style="color:#111">()</span> <span style="color:#00a8c8">chan</span> <span style="color:#f92672">*</span><span style="color:#75af00">PodLifecycleEvent</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">eventChannel</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">g</span> <span style="color:#f92672">*</span><span style="color:#75af00">GenericPLEG</span><span style="color:#111">)</span> <span style="color:#75af00">Start</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">runningMu</span><span style="color:#111">.</span><span style="color:#75af00">Lock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">runningMu</span><span style="color:#111">.</span><span style="color:#75af00">Unlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">isRunning</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">isRunning</span> <span style="color:#111">=</span> <span style="color:#00a8c8">true</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">stopCh</span> <span style="color:#111">=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">chan</span> <span style="color:#00a8c8">struct</span><span style="color:#111">{})</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">go</span> <span style="color:#75af00">wait</span><span style="color:#111">.</span><span style="color:#75af00">Until</span><span style="color:#111">(</span><span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">Relist</span><span style="color:#111">,</span> <span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">relistDuration</span><span style="color:#111">.</span><span style="color:#75af00">RelistPeriod</span><span style="color:#111">,</span> <span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">stopCh</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">g</span> <span style="color:#f92672">*</span><span style="color:#75af00">GenericPLEG</span><span style="color:#111">)</span> <span style="color:#75af00">Relist</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">relistLock</span><span style="color:#111">.</span><span style="color:#75af00">Lock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">relistLock</span><span style="color:#111">.</span><span style="color:#75af00">Unlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ctx</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Background</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#ae81ff">5</span><span style="color:#111">).</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;GenericPLEG: Relisting&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">lastRelistTime</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">getRelistTime</span><span style="color:#111">();</span> <span style="color:#111">!</span><span style="color:#75af00">lastRelistTime</span><span style="color:#111">.</span><span style="color:#75af00">IsZero</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">metrics</span><span style="color:#111">.</span><span style="color:#75af00">PLEGRelistInterval</span><span style="color:#111">.</span><span style="color:#75af00">Observe</span><span style="color:#111">(</span><span style="color:#75af00">metrics</span><span style="color:#111">.</span><span style="color:#75af00">SinceInSeconds</span><span style="color:#111">(</span><span style="color:#75af00">lastRelistTime</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">timestamp</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">clock</span><span style="color:#111">.</span><span style="color:#75af00">Now</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">metrics</span><span style="color:#111">.</span><span style="color:#75af00">PLEGRelistDuration</span><span style="color:#111">.</span><span style="color:#75af00">Observe</span><span style="color:#111">(</span><span style="color:#75af00">metrics</span><span style="color:#111">.</span><span style="color:#75af00">SinceInSeconds</span><span style="color:#111">(</span><span style="color:#75af00">timestamp</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Get all the pods.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">podList</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">runtime</span><span style="color:#111">.</span><span style="color:#75af00">GetPods</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#00a8c8">true</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">ErrorS</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;GenericPLEG: Unable to retrieve pods&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">updateRelistTime</span><span style="color:#111">(</span><span style="color:#75af00">timestamp</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">pods</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">kubecontainer</span><span style="color:#111">.</span><span style="color:#75af00">Pods</span><span style="color:#111">(</span><span style="color:#75af00">podList</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// update running pod and container count</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">updateRunningPodAndContainerMetrics</span><span style="color:#111">(</span><span style="color:#75af00">pods</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">podRecords</span><span style="color:#111">.</span><span style="color:#75af00">setCurrent</span><span style="color:#111">(</span><span style="color:#75af00">pods</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Compare the old and the current pods, and generate events.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">eventsByPodID</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#75af00">types</span><span style="color:#111">.</span><span style="color:#75af00">UID</span><span style="color:#111">][]</span><span style="color:#f92672">*</span><span style="color:#75af00">PodLifecycleEvent</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">pid</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">podRecords</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">oldPod</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">podRecords</span><span style="color:#111">.</span><span style="color:#75af00">getOld</span><span style="color:#111">(</span><span style="color:#75af00">pid</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">pod</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">podRecords</span><span style="color:#111">.</span><span style="color:#75af00">getCurrent</span><span style="color:#111">(</span><span style="color:#75af00">pid</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Get all containers in the old and the new pod.</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">allContainers</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">getContainersFromPods</span><span style="color:#111">(</span><span style="color:#75af00">oldPod</span><span style="color:#111">,</span> <span style="color:#75af00">pod</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">container</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">allContainers</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">events</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">computeEvents</span><span style="color:#111">(</span><span style="color:#75af00">oldPod</span><span style="color:#111">,</span> <span style="color:#75af00">pod</span><span style="color:#111">,</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">container</span><span style="color:#111">.</span><span style="color:#75af00">ID</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">e</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">events</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">updateEvents</span><span style="color:#111">(</span><span style="color:#75af00">eventsByPodID</span><span style="color:#111">,</span> <span style="color:#75af00">e</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">var</span> <span style="color:#75af00">needsReinspection</span> <span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#75af00">types</span><span style="color:#111">.</span><span style="color:#75af00">UID</span><span style="color:#111">]</span><span style="color:#f92672">*</span><span style="color:#75af00">kubecontainer</span><span style="color:#111">.</span><span style="color:#75af00">Pod</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">cacheEnabled</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">needsReinspection</span> <span style="color:#111">=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#75af00">types</span><span style="color:#111">.</span><span style="color:#75af00">UID</span><span style="color:#111">]</span><span style="color:#f92672">*</span><span style="color:#75af00">kubecontainer</span><span style="color:#111">.</span><span style="color:#75af00">Pod</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// If there are events associated with a pod, we should update the</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// podCache.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">pid</span><span style="color:#111">,</span> <span style="color:#75af00">events</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">eventsByPodID</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">pod</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">podRecords</span><span style="color:#111">.</span><span style="color:#75af00">getCurrent</span><span style="color:#111">(</span><span style="color:#75af00">pid</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">cacheEnabled</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// updateCache() will inspect the pod and update the cache. If an</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// error occurs during the inspection, we want PLEG to retry again</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// in the next relist. To achieve this, we do not update the</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// associated podRecord of the pod, so that the change will be</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// detect again in the next relist.</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// TODO: If many pods changed during the same relist period,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// inspecting the pod and getting the PodStatus to update the cache</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// serially may take a while. We should be aware of this and</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// parallelize if needed.</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#75af00">updated</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">updateCache</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">pod</span><span style="color:#111">,</span> <span style="color:#75af00">pid</span><span style="color:#111">);</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// Rely on updateCache calling GetPodStatus to log the actual error.</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#ae81ff">4</span><span style="color:#111">).</span><span style="color:#75af00">ErrorS</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;PLEG: Ignoring events for pod&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;pod&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">KRef</span><span style="color:#111">(</span><span style="color:#75af00">pod</span><span style="color:#111">.</span><span style="color:#75af00">Namespace</span><span style="color:#111">,</span> <span style="color:#75af00">pod</span><span style="color:#111">.</span><span style="color:#75af00">Name</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// make sure we try to reinspect the pod during the next relisting</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">needsReinspection</span><span style="color:#111">[</span><span style="color:#75af00">pid</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#75af00">pod</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">continue</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// this pod was in the list to reinspect and we did so because it had events, so remove it</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// from the list (we don&#39;t want the reinspection code below to inspect it a second time in</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// this relist execution)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#111">delete</span><span style="color:#111">(</span><span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">podsToReinspect</span><span style="color:#111">,</span> <span style="color:#75af00">pid</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">if</span> <span style="color:#75af00">utilfeature</span><span style="color:#111">.</span><span style="color:#75af00">DefaultFeatureGate</span><span style="color:#111">.</span><span style="color:#75af00">Enabled</span><span style="color:#111">(</span><span style="color:#75af00">features</span><span style="color:#111">.</span><span style="color:#75af00">EventedPLEG</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">updated</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>						<span style="color:#00a8c8">continue</span>
</span></span><span style="display:flex;"><span>					<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>				<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Update the internal storage and send out the events.</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">podRecords</span><span style="color:#111">.</span><span style="color:#75af00">update</span><span style="color:#111">(</span><span style="color:#75af00">pid</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Map from containerId to exit code; used as a temporary cache for lookup</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">containerExitCode</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#00a8c8">string</span><span style="color:#111">]</span><span style="color:#00a8c8">int</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">for</span> <span style="color:#75af00">i</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">events</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// Filter out events that are not reliable and no other components use yet.</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">events</span><span style="color:#111">[</span><span style="color:#75af00">i</span><span style="color:#111">].</span><span style="color:#75af00">Type</span> <span style="color:#f92672">==</span> <span style="color:#75af00">ContainerChanged</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">continue</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">select</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">case</span> <span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">eventChannel</span> <span style="color:#f92672">&lt;-</span> <span style="color:#75af00">events</span><span style="color:#111">[</span><span style="color:#75af00">i</span><span style="color:#111">]:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">default</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">metrics</span><span style="color:#111">.</span><span style="color:#75af00">PLEGDiscardEvents</span><span style="color:#111">.</span><span style="color:#75af00">Inc</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">ErrorS</span><span style="color:#111">(</span><span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Event channel is full, discard this relist() cycle event&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// Log exit code of containers when they finished in a particular event</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">events</span><span style="color:#111">[</span><span style="color:#75af00">i</span><span style="color:#111">].</span><span style="color:#75af00">Type</span> <span style="color:#f92672">==</span> <span style="color:#75af00">ContainerDied</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// Fill up containerExitCode map for ContainerDied event when first time appeared</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">if</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">containerExitCode</span><span style="color:#111">)</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">pod</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">cache</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75715e">// Get updated podStatus</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">status</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">cache</span><span style="color:#111">.</span><span style="color:#75af00">Get</span><span style="color:#111">(</span><span style="color:#75af00">pod</span><span style="color:#111">.</span><span style="color:#75af00">ID</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>					<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>						<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">containerStatus</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">status</span><span style="color:#111">.</span><span style="color:#75af00">ContainerStatuses</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>							<span style="color:#75af00">containerExitCode</span><span style="color:#111">[</span><span style="color:#75af00">containerStatus</span><span style="color:#111">.</span><span style="color:#75af00">ID</span><span style="color:#111">.</span><span style="color:#75af00">ID</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#75af00">containerStatus</span><span style="color:#111">.</span><span style="color:#75af00">ExitCode</span>
</span></span><span style="display:flex;"><span>						<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>					<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>				<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">if</span> <span style="color:#75af00">containerID</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">events</span><span style="color:#111">[</span><span style="color:#75af00">i</span><span style="color:#111">].</span><span style="color:#75af00">Data</span><span style="color:#111">.(</span><span style="color:#00a8c8">string</span><span style="color:#111">);</span> <span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#00a8c8">if</span> <span style="color:#75af00">exitCode</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">containerExitCode</span><span style="color:#111">[</span><span style="color:#75af00">containerID</span><span style="color:#111">];</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">pod</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>						<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#ae81ff">2</span><span style="color:#111">).</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Generic (PLEG): container finished&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;podID&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">pod</span><span style="color:#111">.</span><span style="color:#75af00">ID</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;containerID&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">containerID</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;exitCode&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">exitCode</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>					<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>				<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">cacheEnabled</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// reinspect any pods that failed inspection during the previous relist</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">podsToReinspect</span><span style="color:#111">)</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#ae81ff">5</span><span style="color:#111">).</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;GenericPLEG: Reinspecting pods that previously failed inspection&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">for</span> <span style="color:#75af00">pid</span><span style="color:#111">,</span> <span style="color:#75af00">pod</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">podsToReinspect</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#75af00">_</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">updateCache</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">pod</span><span style="color:#111">,</span> <span style="color:#75af00">pid</span><span style="color:#111">);</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75715e">// Rely on updateCache calling GetPodStatus to log the actual error.</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#ae81ff">5</span><span style="color:#111">).</span><span style="color:#75af00">ErrorS</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;PLEG: pod failed reinspection&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;pod&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">KRef</span><span style="color:#111">(</span><span style="color:#75af00">pod</span><span style="color:#111">.</span><span style="color:#75af00">Namespace</span><span style="color:#111">,</span> <span style="color:#75af00">pod</span><span style="color:#111">.</span><span style="color:#75af00">Name</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">needsReinspection</span><span style="color:#111">[</span><span style="color:#75af00">pid</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#75af00">pod</span>
</span></span><span style="display:flex;"><span>				<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Update the cache timestamp.  This needs to happen *after*</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// all pods have been properly updated in the cache.</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">cache</span><span style="color:#111">.</span><span style="color:#75af00">UpdateTime</span><span style="color:#111">(</span><span style="color:#75af00">timestamp</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// make sure we retain the list of pods that need reinspecting the next time relist is called</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">podsToReinspect</span> <span style="color:#111">=</span> <span style="color:#75af00">needsReinspection</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>可以看到 GenericPLEG 会定时从 runtime 获取 pods 然后和缓存中的旧的 pod 进行对比 然后生成事件发送给 eventChannel</p>
<h3 id="eventpleg">EventPLEG</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">e</span> <span style="color:#f92672">*</span><span style="color:#75af00">EventedPLEG</span><span style="color:#111">)</span> <span style="color:#75af00">Start</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">runningMu</span><span style="color:#111">.</span><span style="color:#75af00">Lock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">runningMu</span><span style="color:#111">.</span><span style="color:#75af00">Unlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">isEventedPLEGInUse</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">setEventedPLEGUsage</span><span style="color:#111">(</span><span style="color:#00a8c8">true</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">stopCh</span> <span style="color:#111">=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">chan</span> <span style="color:#00a8c8">struct</span><span style="color:#111">{})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">stopCacheUpdateCh</span> <span style="color:#111">=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">chan</span> <span style="color:#00a8c8">struct</span><span style="color:#111">{})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">go</span> <span style="color:#75af00">wait</span><span style="color:#111">.</span><span style="color:#75af00">Until</span><span style="color:#111">(</span><span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">watchEventsChannel</span><span style="color:#111">,</span> <span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">stopCh</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">go</span> <span style="color:#75af00">wait</span><span style="color:#111">.</span><span style="color:#75af00">Until</span><span style="color:#111">(</span><span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">updateGlobalCache</span><span style="color:#111">,</span> <span style="color:#75af00">globalCacheUpdatePeriod</span><span style="color:#111">,</span> <span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">stopCacheUpdateCh</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">e</span> <span style="color:#f92672">*</span><span style="color:#75af00">EventedPLEG</span><span style="color:#111">)</span> <span style="color:#75af00">watchEventsChannel</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">containerEventsResponseCh</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">chan</span> <span style="color:#f92672">*</span><span style="color:#75af00">runtimeapi</span><span style="color:#111">.</span><span style="color:#75af00">ContainerEventResponse</span><span style="color:#111">,</span> <span style="color:#111">cap</span><span style="color:#111">(</span><span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">eventChannel</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#111">close</span><span style="color:#111">(</span><span style="color:#75af00">containerEventsResponseCh</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Get the container events from the runtime.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">go</span> <span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">numAttempts</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">for</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">numAttempts</span> <span style="color:#f92672">&gt;=</span> <span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">eventedPlegMaxStreamRetries</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">if</span> <span style="color:#75af00">isEventedPLEGInUse</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75715e">// Fall back to Generic PLEG relisting since Evented PLEG is not working.</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#ae81ff">4</span><span style="color:#111">).</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Fall back to Generic PLEG relisting since Evented PLEG is not working&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">Stop</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">genericPleg</span><span style="color:#111">.</span><span style="color:#75af00">Stop</span><span style="color:#111">()</span>       <span style="color:#75715e">// Stop the existing Generic PLEG which runs with longer relisting period when Evented PLEG is in use.</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">Update</span><span style="color:#111">(</span><span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">relistDuration</span><span style="color:#111">)</span> <span style="color:#75715e">// Update the relisting period to the default value for the Generic PLEG.</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">genericPleg</span><span style="color:#111">.</span><span style="color:#75af00">Start</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>					<span style="color:#00a8c8">break</span>
</span></span><span style="display:flex;"><span>				<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">runtimeService</span><span style="color:#111">.</span><span style="color:#75af00">GetContainerEvents</span><span style="color:#111">(</span><span style="color:#75af00">containerEventsResponseCh</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">metrics</span><span style="color:#111">.</span><span style="color:#75af00">EventedPLEGConnErr</span><span style="color:#111">.</span><span style="color:#75af00">Inc</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">numAttempts</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">Relist</span><span style="color:#111">()</span> <span style="color:#75715e">// Force a relist to get the latest container and pods running metric.</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#ae81ff">4</span><span style="color:#111">).</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Evented PLEG: Failed to get container events, retrying: &#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;err&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">isEventedPLEGInUse</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">processCRIEvents</span><span style="color:#111">(</span><span style="color:#75af00">containerEventsResponseCh</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 转换 runtimeapi.ContainerEventResponse 为 PodLifecycleEvent</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">e</span> <span style="color:#f92672">*</span><span style="color:#75af00">EventedPLEG</span><span style="color:#111">)</span> <span style="color:#75af00">processCRIEvents</span><span style="color:#111">(</span><span style="color:#75af00">containerEventsResponseCh</span> <span style="color:#00a8c8">chan</span> <span style="color:#f92672">*</span><span style="color:#75af00">runtimeapi</span><span style="color:#111">.</span><span style="color:#75af00">ContainerEventResponse</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">event</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">containerEventsResponseCh</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Ignore the event if PodSandboxStatus is nil.</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// This might happen under some race condition where the podSandbox has</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// been deleted, and therefore container runtime couldn&#39;t find the</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// podSandbox for the container when generating the event.</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// It is safe to ignore because</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// a) a event would have been received for the sandbox deletion,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// b) in worst case, a relist will eventually sync the pod status.</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// TODO(#114371): Figure out a way to handle this case instead of ignoring.</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">event</span><span style="color:#111">.</span><span style="color:#75af00">PodSandboxStatus</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#f92672">||</span> <span style="color:#75af00">event</span><span style="color:#111">.</span><span style="color:#75af00">PodSandboxStatus</span><span style="color:#111">.</span><span style="color:#75af00">Metadata</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">ErrorS</span><span style="color:#111">(</span><span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Evented PLEG: received ContainerEventResponse with nil PodSandboxStatus or PodSandboxStatus.Metadata&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;containerEventResponse&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">event</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">continue</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">podID</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">types</span><span style="color:#111">.</span><span style="color:#75af00">UID</span><span style="color:#111">(</span><span style="color:#75af00">event</span><span style="color:#111">.</span><span style="color:#75af00">PodSandboxStatus</span><span style="color:#111">.</span><span style="color:#75af00">Metadata</span><span style="color:#111">.</span><span style="color:#75af00">Uid</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">shouldSendPLEGEvent</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">false</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">status</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">runtime</span><span style="color:#111">.</span><span style="color:#75af00">GeneratePodStatus</span><span style="color:#111">(</span><span style="color:#75af00">event</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// nolint:logcheck // Not using the result of klog.V inside the</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// if branch is okay, we just use it to determine whether the</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// additional &#34;podStatus&#34; key and its value should be added.</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#ae81ff">6</span><span style="color:#111">).</span><span style="color:#75af00">Enabled</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">ErrorS</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Evented PLEG: error generating pod status from the received event&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;podUID&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">podID</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;podStatus&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">status</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">ErrorS</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Evented PLEG: error generating pod status from the received event&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;podUID&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">podID</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">klogV</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#ae81ff">6</span><span style="color:#111">);</span> <span style="color:#75af00">klogV</span><span style="color:#111">.</span><span style="color:#75af00">Enabled</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">klogV</span><span style="color:#111">.</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Evented PLEG: Generated pod status from the received event&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;podUID&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">podID</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;podStatus&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">status</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">klog</span><span style="color:#111">.</span><span style="color:#75af00">V</span><span style="color:#111">(</span><span style="color:#ae81ff">4</span><span style="color:#111">).</span><span style="color:#75af00">InfoS</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Evented PLEG: Generated pod status from the received event&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;podUID&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">podID</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// Preserve the pod IP across cache updates if the new IP is empty.</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// When a pod is torn down, kubelet may race with PLEG and retrieve</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// a pod status after network teardown, but the kubernetes API expects</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// the completed pod&#39;s IP to be available after the pod is dead.</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">status</span><span style="color:#111">.</span><span style="color:#75af00">IPs</span> <span style="color:#111">=</span> <span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">getPodIPs</span><span style="color:#111">(</span><span style="color:#75af00">podID</span><span style="color:#111">,</span> <span style="color:#75af00">status</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">updateRunningPodMetric</span><span style="color:#111">(</span><span style="color:#75af00">status</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">updateRunningContainerMetric</span><span style="color:#111">(</span><span style="color:#75af00">status</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">updateLatencyMetric</span><span style="color:#111">(</span><span style="color:#75af00">event</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">event</span><span style="color:#111">.</span><span style="color:#75af00">ContainerEventType</span> <span style="color:#f92672">==</span> <span style="color:#75af00">runtimeapi</span><span style="color:#111">.</span><span style="color:#75af00">ContainerEventType_CONTAINER_DELETED_EVENT</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">sandbox</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">status</span><span style="color:#111">.</span><span style="color:#75af00">SandboxStatuses</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">if</span> <span style="color:#75af00">sandbox</span><span style="color:#111">.</span><span style="color:#75af00">Id</span> <span style="color:#f92672">==</span> <span style="color:#75af00">event</span><span style="color:#111">.</span><span style="color:#75af00">ContainerId</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75715e">// When the CONTAINER_DELETED_EVENT is received by the kubelet,</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75715e">// the runtime has indicated that the container has been removed</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75715e">// by the runtime and hence, it must be removed from the cache</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75715e">// of kubelet too.</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">cache</span><span style="color:#111">.</span><span style="color:#75af00">Delete</span><span style="color:#111">(</span><span style="color:#75af00">podID</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">shouldSendPLEGEvent</span> <span style="color:#111">=</span> <span style="color:#00a8c8">true</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">cache</span><span style="color:#111">.</span><span style="color:#75af00">Set</span><span style="color:#111">(</span><span style="color:#75af00">podID</span><span style="color:#111">,</span> <span style="color:#75af00">status</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Unix</span><span style="color:#111">(</span><span style="color:#75af00">event</span><span style="color:#111">.</span><span style="color:#75af00">GetCreatedAt</span><span style="color:#111">(),</span> <span style="color:#ae81ff">0</span><span style="color:#111">))</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">shouldSendPLEGEvent</span> <span style="color:#111">=</span> <span style="color:#00a8c8">true</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">shouldSendPLEGEvent</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">processCRIEvent</span><span style="color:#111">(</span><span style="color:#75af00">event</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>从代码中可以看到 EventPLEG 可以从 runtime 获取容器事件。</p>
]]></content:encoded><category>cloud</category><category>kubelet</category><category>kubernetes</category><category>源码分析</category><category>golang</category></item><item><title>容器启动流程（containerd 和 runc）</title><link>https://daemon365.dev/post/cloud/container_startup_process_containerd_and_runc/</link><pubDate>Thu, 07 Dec 2023 00:00:00 +0800</pubDate><guid>https://daemon365.dev/post/cloud/container_startup_process_containerd_and_runc/</guid><description>&lt;h2 id="启动流程"&gt;启动流程&lt;/h2&gt;
&lt;p&gt;containerd 作为一个 api 服务，提供了一系列的接口供外部调用，比如创建容器、删除容器、创建镜像、删除镜像等等。使用 docker 和 ctr 等工具，都是通过调用 containerd 的 api 来实现的。
kubelet 通过 cri 调用 containerd 和这些不一样，后续我会介绍到。&lt;/p&gt;
&lt;p&gt;containerd 创建容器流程如下：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;接收到 api 请求，通过调用 containerd-shim-runc-v2 调用 runc 创建容器，主要是做解压文件和准备环境的工作。&lt;/li&gt;
&lt;li&gt;接收到 api 请求，创建一个 task，task 是一个容器的抽象，包含了容器的所有信息，比如容器的 id、容器的状态、容器的配置等等。&lt;/li&gt;
&lt;li&gt;containerd 启动一个 containerd-shim-runc-v2 进程。&lt;/li&gt;
&lt;li&gt;containerd-shim-runc-v2 进程 在启动一个 containerd-shim-runc-v2 进程，然后第一个 containerd-shim-runc-v2 进程退出。&lt;/li&gt;
&lt;li&gt;containerd 通过 IPC 通信，让第二个 containerd-shim-runc-v2 启动容器。&lt;/li&gt;
&lt;li&gt;containerd-shim-runc-v2 进程通过调用 runc start 启动容器。&lt;/li&gt;
&lt;li&gt;runc 会调用 runc init 启动容器的 init 进程。&lt;/li&gt;
&lt;li&gt;runc init 进程会调用 &lt;code&gt;unix.Exec&lt;/code&gt; 的方式，替换自己的进程，启动容器的第一个进程。这个进程既是容器的启动命令，也是容器的 pid 1 进程。完成之后，runc create 进程退出。&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;这样 containerd-shim-runc-v2 的父进程就是 init 进程（1），而 init 进程的父进程是 containerd-shim-runc-v2 进程，这样就形成了一个进程树。&lt;/p&gt;</description><content:encoded><![CDATA[<h2 id="启动流程">启动流程</h2>
<p>containerd 作为一个 api 服务，提供了一系列的接口供外部调用，比如创建容器、删除容器、创建镜像、删除镜像等等。使用 docker 和 ctr 等工具，都是通过调用 containerd 的 api 来实现的。
kubelet 通过 cri 调用 containerd 和这些不一样，后续我会介绍到。</p>
<p>containerd 创建容器流程如下：</p>
<ol>
<li>接收到 api 请求，通过调用 containerd-shim-runc-v2 调用 runc 创建容器，主要是做解压文件和准备环境的工作。</li>
<li>接收到 api 请求，创建一个 task，task 是一个容器的抽象，包含了容器的所有信息，比如容器的 id、容器的状态、容器的配置等等。</li>
<li>containerd 启动一个 containerd-shim-runc-v2 进程。</li>
<li>containerd-shim-runc-v2 进程 在启动一个 containerd-shim-runc-v2 进程，然后第一个 containerd-shim-runc-v2 进程退出。</li>
<li>containerd 通过 IPC 通信，让第二个 containerd-shim-runc-v2 启动容器。</li>
<li>containerd-shim-runc-v2 进程通过调用 runc start 启动容器。</li>
<li>runc 会调用 runc init 启动容器的 init 进程。</li>
<li>runc init 进程会调用 <code>unix.Exec</code> 的方式，替换自己的进程，启动容器的第一个进程。这个进程既是容器的启动命令，也是容器的 pid 1 进程。完成之后，runc create 进程退出。</li>
</ol>
<p>这样 containerd-shim-runc-v2 的父进程就是 init 进程（1），而 init 进程的父进程是 containerd-shim-runc-v2 进程，这样就形成了一个进程树。</p>
<p>我通过 docker 启动一个容器，示例一下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>❯ docker run -d --rm -it docker.m.daocloud.io/ubuntu:22.10 sleep <span style="color:#ae81ff">3000</span>
</span></span><span style="display:flex;"><span>❯ ps -ef<span style="color:#111">|</span>grep <span style="color:#d88200">&#34;sleep 3000&#34;</span>
</span></span><span style="display:flex;"><span>root       <span style="color:#ae81ff">15042</span>   <span style="color:#ae81ff">15021</span>  <span style="color:#ae81ff">0</span> 22:02 pts/0    00:00:00 sleep <span style="color:#ae81ff">3000</span>
</span></span><span style="display:flex;"><span>❯ ps -ef<span style="color:#111">|</span>grep <span style="color:#d88200">&#34;15021&#34;</span>
</span></span><span style="display:flex;"><span>root       <span style="color:#ae81ff">15021</span>       <span style="color:#ae81ff">1</span>  <span style="color:#ae81ff">0</span> 22:02 ?        00:00:00 /usr/bin/containerd-shim-runc-v2 -namespace moby -id 4346ca602cd85d35b0a4a81762be6142bc6a2222f859f4af47563992efc3c59c -address /run/containerd/containerd.sock
</span></span><span style="display:flex;"><span>root       <span style="color:#ae81ff">15042</span>   <span style="color:#ae81ff">15021</span>  <span style="color:#ae81ff">0</span> 22:02 pts/0    00:00:00 sleep <span style="color:#ae81ff">3000</span>
</span></span></code></pre></div><p>可以看到我们的结论是正确的。</p>
<h3 id="疑问解答">疑问解答</h3>
<p><strong>1.为什么要创建两个 containerd-shim 不嫌麻烦吗？</strong></p>
<p>因为 第一个 containerd-shim 会在创建完第二个 containerd-shim 后退出，而作为第一个进程子进程的第二个 containerd-shim 会成为孤儿进程，这样就会被 init 进程接管，而和 containerd 本身脱离了关系。</p>
<p><strong>2.为什么要想法设法把 containerd-shim 挂在 init 进程下面，而不是 containerd？</strong></p>
<p>为了保证稳定性和独立性。这样做可以确保即使 containerd 崩溃或重启，由 containerd-shim 管理的容器进程仍然可以继续运行，不受影响。此外，这种设计还有助于更好地管理资源和防止资源泄露。</p>
<p><strong>3.为什么 runc start 进程退出了 runc init 进程（用户进程）没有变成 init 的子进程 而是containerd-shim的子进程？</strong></p>
<p>因为 containerd-shim 做了 unix 的 <code>PR_SET_CHILD_SUBREAPER</code> 调用, 这个系统调用大概作用为 当这个进程的子子孙孙进程变成孤儿进程的时候，这个进程会接管这个孤儿进程，而不是 init 进程接管。</p>
<h2 id="架构图">架构图</h2>
<p><img src="/images/1a309094-015a-4bcf-b371-134a5a275089.png" alt=""></p>
<h2 id="代码分析">代码分析</h2>
<h3 id="containerd-api-注册-代码分析">containerd api 注册 代码分析</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-GO" data-lang="GO"><span style="display:flex;"><span><span style="color:#00a8c8">var</span> <span style="color:#75af00">register</span> <span style="color:#111">=</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">sync</span><span style="color:#111">.</span><span style="color:#75af00">RWMutex</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span> <span style="color:#75af00">plugin</span><span style="color:#111">.</span><span style="color:#75af00">Registry</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Registry</span> <span style="color:#111">[]</span><span style="color:#f92672">*</span><span style="color:#75af00">Registration</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Registration</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Type of the plugin</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Type</span> <span style="color:#75af00">Type</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ID of the plugin</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ID</span> <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Config specific to the plugin</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Config</span> <span style="color:#00a8c8">interface</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Requires is a list of plugins that the registered plugin requires to be available</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Requires</span> <span style="color:#111">[]</span><span style="color:#75af00">Type</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// InitFn is called when initializing a plugin. The registration and</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// context are passed in. The init function may modify the registration to</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// add exports, capabilities and platform support declarations.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">InitFn</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">InitContext</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#00a8c8">interface</span><span style="color:#111">{},</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ConfigMigration allows a plugin to migrate configurations from an older</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// version to handle plugin renames or moving of features from one plugin</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// to another in a later version.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// The configuration map is keyed off the plugin name and the value</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// is the configuration for that objects, with the structure defined</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// for the plugin. No validation is done on the value before performing</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// the migration.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ConfigMigration</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">,</span> <span style="color:#00a8c8">int</span><span style="color:#111">,</span> <span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#00a8c8">string</span><span style="color:#111">]</span><span style="color:#00a8c8">interface</span><span style="color:#111">{})</span> <span style="color:#00a8c8">error</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>通过 init 把接口注册进去 比如 task api 注册</p>
<p>代码位置 ： <code>services/tasks/local.go</code></p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-GO" data-lang="GO"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">init</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">registry</span><span style="color:#111">.</span><span style="color:#75af00">Register</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">plugin</span><span style="color:#111">.</span><span style="color:#75af00">Registration</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">Type</span><span style="color:#111">:</span>     <span style="color:#75af00">plugins</span><span style="color:#111">.</span><span style="color:#75af00">ServicePlugin</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">ID</span><span style="color:#111">:</span>       <span style="color:#75af00">services</span><span style="color:#111">.</span><span style="color:#75af00">TasksService</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">Requires</span><span style="color:#111">:</span> <span style="color:#75af00">tasksServiceRequires</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">Config</span><span style="color:#111">:</span>   <span style="color:#f92672">&amp;</span><span style="color:#75af00">Config</span><span style="color:#111">{},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">InitFn</span><span style="color:#111">:</span>   <span style="color:#75af00">initFunc</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">timeout</span><span style="color:#111">.</span><span style="color:#75af00">Set</span><span style="color:#111">(</span><span style="color:#75af00">stateTimeout</span><span style="color:#111">,</span> <span style="color:#ae81ff">2</span><span style="color:#f92672">*</span><span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Second</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">initFunc</span><span style="color:#111">(</span><span style="color:#75af00">ic</span> <span style="color:#f92672">*</span><span style="color:#75af00">plugin</span><span style="color:#111">.</span><span style="color:#75af00">InitContext</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#00a8c8">interface</span><span style="color:#111">{},</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">config</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">ic</span><span style="color:#111">.</span><span style="color:#75af00">Config</span><span style="color:#111">.(</span><span style="color:#f92672">*</span><span style="color:#75af00">Config</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">v2r</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">ic</span><span style="color:#111">.</span><span style="color:#75af00">GetByID</span><span style="color:#111">(</span><span style="color:#75af00">plugins</span><span style="color:#111">.</span><span style="color:#75af00">RuntimePluginV2</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;task&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">m</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">ic</span><span style="color:#111">.</span><span style="color:#75af00">GetSingle</span><span style="color:#111">(</span><span style="color:#75af00">plugins</span><span style="color:#111">.</span><span style="color:#75af00">MetadataPlugin</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ep</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">ic</span><span style="color:#111">.</span><span style="color:#75af00">GetSingle</span><span style="color:#111">(</span><span style="color:#75af00">plugins</span><span style="color:#111">.</span><span style="color:#75af00">EventPlugin</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">monitor</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">ic</span><span style="color:#111">.</span><span style="color:#75af00">GetSingle</span><span style="color:#111">(</span><span style="color:#75af00">plugins</span><span style="color:#111">.</span><span style="color:#75af00">TaskMonitorPlugin</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">errors</span><span style="color:#111">.</span><span style="color:#75af00">Is</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#75af00">plugin</span><span style="color:#111">.</span><span style="color:#75af00">ErrPluginNotFound</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">monitor</span> <span style="color:#111">=</span> <span style="color:#75af00">runtime</span><span style="color:#111">.</span><span style="color:#75af00">NewNoopMonitor</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">db</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">m</span><span style="color:#111">.(</span><span style="color:#f92672">*</span><span style="color:#75af00">metadata</span><span style="color:#111">.</span><span style="color:#75af00">DB</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">l</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">local</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">containers</span><span style="color:#111">:</span> <span style="color:#75af00">metadata</span><span style="color:#111">.</span><span style="color:#75af00">NewContainerStore</span><span style="color:#111">(</span><span style="color:#75af00">db</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">store</span><span style="color:#111">:</span>      <span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">ContentStore</span><span style="color:#111">(),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">publisher</span><span style="color:#111">:</span>  <span style="color:#75af00">ep</span><span style="color:#111">.(</span><span style="color:#75af00">events</span><span style="color:#111">.</span><span style="color:#75af00">Publisher</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">monitor</span><span style="color:#111">:</span>    <span style="color:#75af00">monitor</span><span style="color:#111">.(</span><span style="color:#75af00">runtime</span><span style="color:#111">.</span><span style="color:#75af00">TaskMonitor</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">v2Runtime</span><span style="color:#111">:</span>  <span style="color:#75af00">v2r</span><span style="color:#111">.(</span><span style="color:#75af00">runtime</span><span style="color:#111">.</span><span style="color:#75af00">PlatformRuntime</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">v2Tasks</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">l</span><span style="color:#111">.</span><span style="color:#75af00">v2Runtime</span><span style="color:#111">.</span><span style="color:#75af00">Tasks</span><span style="color:#111">(</span><span style="color:#75af00">ic</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">,</span> <span style="color:#00a8c8">true</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">t</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">v2Tasks</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">l</span><span style="color:#111">.</span><span style="color:#75af00">monitor</span><span style="color:#111">.</span><span style="color:#75af00">Monitor</span><span style="color:#111">(</span><span style="color:#75af00">t</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">blockio</span><span style="color:#111">.</span><span style="color:#75af00">SetConfig</span><span style="color:#111">(</span><span style="color:#75af00">config</span><span style="color:#111">.</span><span style="color:#75af00">BlockIOConfigFile</span><span style="color:#111">);</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">G</span><span style="color:#111">(</span><span style="color:#75af00">ic</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">).</span><span style="color:#75af00">WithError</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">).</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;blockio initialization failed&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">rdt</span><span style="color:#111">.</span><span style="color:#75af00">SetConfig</span><span style="color:#111">(</span><span style="color:#75af00">config</span><span style="color:#111">.</span><span style="color:#75af00">RdtConfigFile</span><span style="color:#111">);</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">G</span><span style="color:#111">(</span><span style="color:#75af00">ic</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">).</span><span style="color:#75af00">WithError</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">).</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;RDT initialization failed&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">l</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>然后在 containerd 启动的时候 注册api</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-GO" data-lang="GO"><span style="display:flex;"><span><span style="color:#75af00">loaded</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">registry</span><span style="color:#111">.</span><span style="color:#75af00">Graph</span><span style="color:#111">(</span><span style="color:#75af00">filter</span><span style="color:#111">(</span><span style="color:#75af00">config</span><span style="color:#111">.</span><span style="color:#75af00">DisabledPlugins</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">p</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">loaded</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">result</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">Init</span><span style="color:#111">(</span><span style="color:#75af00">initContext</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">initialized</span><span style="color:#111">.</span><span style="color:#75af00">Add</span><span style="color:#111">(</span><span style="color:#75af00">result</span><span style="color:#111">);</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;could not add plugin result to plugin set: %w&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">instance</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">result</span><span style="color:#111">.</span><span style="color:#75af00">Instance</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">delete</span><span style="color:#111">(</span><span style="color:#75af00">required</span><span style="color:#111">,</span> <span style="color:#75af00">id</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// check for grpc services that should be registered with the server</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">src</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">instance</span><span style="color:#111">.(</span><span style="color:#75af00">grpcService</span><span style="color:#111">);</span> <span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">grpcServices</span> <span style="color:#111">=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">grpcServices</span><span style="color:#111">,</span> <span style="color:#75af00">src</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">src</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">instance</span><span style="color:#111">.(</span><span style="color:#75af00">ttrpcService</span><span style="color:#111">);</span> <span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">ttrpcServices</span> <span style="color:#111">=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">ttrpcServices</span><span style="color:#111">,</span> <span style="color:#75af00">src</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">service</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">instance</span><span style="color:#111">.(</span><span style="color:#75af00">tcpService</span><span style="color:#111">);</span> <span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">tcpServices</span> <span style="color:#111">=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">tcpServices</span><span style="color:#111">,</span> <span style="color:#75af00">service</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">plugins</span> <span style="color:#111">=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">plugins</span><span style="color:#111">,</span> <span style="color:#75af00">result</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// register services after all plugins have been initialized</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">service</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">grpcServices</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">service</span><span style="color:#111">.</span><span style="color:#75af00">Register</span><span style="color:#111">(</span><span style="color:#75af00">grpcServer</span><span style="color:#111">);</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">service</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">ttrpcServices</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">service</span><span style="color:#111">.</span><span style="color:#75af00">RegisterTTRPC</span><span style="color:#111">(</span><span style="color:#75af00">ttrpcServer</span><span style="color:#111">);</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">service</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">tcpServices</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">service</span><span style="color:#111">.</span><span style="color:#75af00">RegisterTCP</span><span style="color:#111">(</span><span style="color:#75af00">tcpServer</span><span style="color:#111">);</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="create-task">create task</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">l</span> <span style="color:#f92672">*</span><span style="color:#75af00">local</span><span style="color:#111">)</span> <span style="color:#75af00">Create</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">,</span> <span style="color:#75af00">r</span> <span style="color:#f92672">*</span><span style="color:#75af00">api</span><span style="color:#111">.</span><span style="color:#75af00">CreateTaskRequest</span><span style="color:#111">,</span> <span style="color:#75af00">_</span> <span style="color:#f92672">...</span><span style="color:#75af00">grpc</span><span style="color:#111">.</span><span style="color:#75af00">CallOption</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">api</span><span style="color:#111">.</span><span style="color:#75af00">CreateTaskResponse</span><span style="color:#111">,</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">rtime</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">l</span><span style="color:#111">.</span><span style="color:#75af00">v2Runtime</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">rtime</span><span style="color:#111">.</span><span style="color:#75af00">Get</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">ContainerID</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#111">!</span><span style="color:#75af00">errdefs</span><span style="color:#111">.</span><span style="color:#75af00">IsNotFound</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">errdefs</span><span style="color:#111">.</span><span style="color:#75af00">ToGRPC</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">errdefs</span><span style="color:#111">.</span><span style="color:#75af00">ToGRPC</span><span style="color:#111">(</span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;task %s: %w&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">ContainerID</span><span style="color:#111">,</span> <span style="color:#75af00">errdefs</span><span style="color:#111">.</span><span style="color:#75af00">ErrAlreadyExists</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">c</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">rtime</span><span style="color:#111">.</span><span style="color:#75af00">Create</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">ContainerID</span><span style="color:#111">,</span> <span style="color:#75af00">opts</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">m</span> <span style="color:#f92672">*</span><span style="color:#75af00">TaskManager</span><span style="color:#111">)</span> <span style="color:#75af00">Create</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">,</span> <span style="color:#75af00">taskID</span> <span style="color:#00a8c8">string</span><span style="color:#111">,</span> <span style="color:#75af00">opts</span> <span style="color:#75af00">runtime</span><span style="color:#111">.</span><span style="color:#75af00">CreateOpts</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#75af00">runtime</span><span style="color:#111">.</span><span style="color:#75af00">Task</span><span style="color:#111">,</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 启动第一个 containerd-shim-runc-v2 进程</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">shimTask</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">newShimTask</span><span style="color:#111">(</span><span style="color:#75af00">shim</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 给第二个 containerd-shim-runc-v2 进程传递参数</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">t</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">shimTask</span><span style="color:#111">.</span><span style="color:#75af00">Create</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">opts</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">t</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="cri-代码">cri 代码</h3>
<p>cri 和 task 和上述的是一样的， 通过 register 注册 api.</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">init</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">registry</span><span style="color:#111">.</span><span style="color:#75af00">Register</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">plugin</span><span style="color:#111">.</span><span style="color:#75af00">Registration</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">Type</span><span style="color:#111">:</span> <span style="color:#75af00">plugins</span><span style="color:#111">.</span><span style="color:#75af00">GRPCPlugin</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">ID</span><span style="color:#111">:</span>   <span style="color:#d88200">&#34;cri&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">Requires</span><span style="color:#111">:</span> <span style="color:#111">[]</span><span style="color:#75af00">plugin</span><span style="color:#111">.</span><span style="color:#75af00">Type</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">plugins</span><span style="color:#111">.</span><span style="color:#75af00">CRIImagePlugin</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">plugins</span><span style="color:#111">.</span><span style="color:#75af00">InternalPlugin</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">plugins</span><span style="color:#111">.</span><span style="color:#75af00">SandboxControllerPlugin</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">plugins</span><span style="color:#111">.</span><span style="color:#75af00">NRIApiPlugin</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">plugins</span><span style="color:#111">.</span><span style="color:#75af00">EventPlugin</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">plugins</span><span style="color:#111">.</span><span style="color:#75af00">ServicePlugin</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">plugins</span><span style="color:#111">.</span><span style="color:#75af00">LeasePlugin</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">plugins</span><span style="color:#111">.</span><span style="color:#75af00">SandboxStorePlugin</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">InitFn</span><span style="color:#111">:</span> <span style="color:#75af00">initCRIService</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>startContainer 接口</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-GO" data-lang="GO"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">in</span> <span style="color:#f92672">*</span><span style="color:#75af00">instrumentedService</span><span style="color:#111">)</span> <span style="color:#75af00">StartContainer</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">,</span> <span style="color:#75af00">r</span> <span style="color:#f92672">*</span><span style="color:#75af00">runtime</span><span style="color:#111">.</span><span style="color:#75af00">StartContainerRequest</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#75af00">_</span> <span style="color:#f92672">*</span><span style="color:#75af00">runtime</span><span style="color:#111">.</span><span style="color:#75af00">StartContainerResponse</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">in</span><span style="color:#111">.</span><span style="color:#75af00">checkInitialized</span><span style="color:#111">();</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">G</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">).</span><span style="color:#75af00">Infof</span><span style="color:#111">(</span><span style="color:#d88200">&#34;StartContainer for %q&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">GetContainerId</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">G</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">).</span><span style="color:#75af00">WithError</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">).</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;StartContainer for %q failed&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">GetContainerId</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">G</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">).</span><span style="color:#75af00">Infof</span><span style="color:#111">(</span><span style="color:#d88200">&#34;StartContainer for %q returns successfully&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">GetContainerId</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">res</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">in</span><span style="color:#111">.</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">StartContainer</span><span style="color:#111">(</span><span style="color:#75af00">ctrdutil</span><span style="color:#111">.</span><span style="color:#75af00">WithNamespace</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">),</span> <span style="color:#75af00">r</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">res</span><span style="color:#111">,</span> <span style="color:#75af00">errdefs</span><span style="color:#111">.</span><span style="color:#75af00">ToGRPC</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">criService</span><span style="color:#111">)</span> <span style="color:#75af00">StartContainer</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">,</span> <span style="color:#75af00">r</span> <span style="color:#f92672">*</span><span style="color:#75af00">runtime</span><span style="color:#111">.</span><span style="color:#75af00">StartContainerRequest</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#75af00">retRes</span> <span style="color:#f92672">*</span><span style="color:#75af00">runtime</span><span style="color:#111">.</span><span style="color:#75af00">StartContainerResponse</span><span style="color:#111">,</span> <span style="color:#75af00">retErr</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">task</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">container</span><span style="color:#111">.</span><span style="color:#75af00">NewTask</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">ioCreation</span><span style="color:#111">,</span> <span style="color:#75af00">taskOpts</span><span style="color:#f92672">...</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">container</span><span style="color:#111">)</span> <span style="color:#75af00">NewTask</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">,</span> <span style="color:#75af00">ioCreate</span> <span style="color:#75af00">cio</span><span style="color:#111">.</span><span style="color:#75af00">Creator</span><span style="color:#111">,</span> <span style="color:#75af00">opts</span> <span style="color:#f92672">...</span><span style="color:#75af00">NewTaskOpts</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#75af00">_</span> <span style="color:#75af00">Task</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 通过 unix socket 的方式调用上述的 create task 接口</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">response</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">client</span><span style="color:#111">.</span><span style="color:#75af00">TaskService</span><span style="color:#111">().</span><span style="color:#75af00">Create</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">request</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="containerd-shim">containerd-shim</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">run</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">,</span> <span style="color:#75af00">manager</span> <span style="color:#75af00">Manager</span><span style="color:#111">,</span> <span style="color:#75af00">config</span> <span style="color:#75af00">Config</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Handle explicit actions</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">switch</span> <span style="color:#75af00">action</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">case</span> <span style="color:#d88200">&#34;delete&#34;</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">case</span> <span style="color:#d88200">&#34;start&#34;</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 如果是 start 参数的话启动一个 containerd-shim-runc-v2 进程</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">opts</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">StartOpts</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">Address</span><span style="color:#111">:</span>      <span style="color:#75af00">addressFlag</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">TTRPCAddress</span><span style="color:#111">:</span> <span style="color:#75af00">ttrpcAddress</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">Debug</span><span style="color:#111">:</span>        <span style="color:#75af00">debugFlag</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">params</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">manager</span><span style="color:#111">.</span><span style="color:#75af00">Start</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">id</span><span style="color:#111">,</span> <span style="color:#75af00">opts</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">data</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">json</span><span style="color:#111">.</span><span style="color:#75af00">Marshal</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">params</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;failed to marshal bootstrap params to json: %w&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">Stdout</span><span style="color:#111">.</span><span style="color:#75af00">Write</span><span style="color:#111">(</span><span style="color:#75af00">data</span><span style="color:#111">);</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// manager.Start 中创建的 command 指定三个参数 Namespace 容器 id 和 containerd socket 文件的地址</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">newCommand</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">,</span> <span style="color:#75af00">id</span><span style="color:#111">,</span> <span style="color:#75af00">containerdAddress</span><span style="color:#111">,</span> <span style="color:#75af00">containerdTTRPCAddress</span> <span style="color:#00a8c8">string</span><span style="color:#111">,</span> <span style="color:#75af00">debug</span> <span style="color:#00a8c8">bool</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">exec</span><span style="color:#111">.</span><span style="color:#75af00">Cmd</span><span style="color:#111">,</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ns</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">namespaces</span><span style="color:#111">.</span><span style="color:#75af00">NamespaceRequired</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">self</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">Executable</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">cwd</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">Getwd</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">args</span> <span style="color:#f92672">:=</span> <span style="color:#111">[]</span><span style="color:#00a8c8">string</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#d88200">&#34;-namespace&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">ns</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#d88200">&#34;-id&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">id</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#d88200">&#34;-address&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">containerdAddress</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">debug</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">args</span> <span style="color:#111">=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">args</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;-debug&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">cmd</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">exec</span><span style="color:#111">.</span><span style="color:#75af00">Command</span><span style="color:#111">(</span><span style="color:#75af00">self</span><span style="color:#111">,</span> <span style="color:#75af00">args</span><span style="color:#f92672">...</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">cmd</span><span style="color:#111">.</span><span style="color:#75af00">Dir</span> <span style="color:#111">=</span> <span style="color:#75af00">cwd</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">cmd</span><span style="color:#111">.</span><span style="color:#75af00">Env</span> <span style="color:#111">=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">Environ</span><span style="color:#111">(),</span> <span style="color:#d88200">&#34;GOMAXPROCS=4&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">cmd</span><span style="color:#111">.</span><span style="color:#75af00">SysProcAttr</span> <span style="color:#111">=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">syscall</span><span style="color:#111">.</span><span style="color:#75af00">SysProcAttr</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">Setpgid</span><span style="color:#111">:</span> <span style="color:#00a8c8">true</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">cmd</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>第二个 containerd-shim 也会开启一些api服务 ，比如启动容器</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-GO" data-lang="GO"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">s</span> <span style="color:#f92672">*</span><span style="color:#75af00">service</span><span style="color:#111">)</span> <span style="color:#75af00">Start</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">,</span> <span style="color:#75af00">r</span> <span style="color:#f92672">*</span><span style="color:#75af00">taskAPI</span><span style="color:#111">.</span><span style="color:#75af00">StartRequest</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">taskAPI</span><span style="color:#111">.</span><span style="color:#75af00">StartResponse</span><span style="color:#111">,</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">p</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">container</span><span style="color:#111">.</span><span style="color:#75af00">Start</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">r</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">Container</span><span style="color:#111">)</span> <span style="color:#75af00">Start</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">,</span> <span style="color:#75af00">r</span> <span style="color:#f92672">*</span><span style="color:#75af00">task</span><span style="color:#111">.</span><span style="color:#75af00">StartRequest</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#75af00">process</span><span style="color:#111">.</span><span style="color:#75af00">Process</span><span style="color:#111">,</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">p</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">Start</span><span style="color:#111">(</span><span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">ExecID</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// command 及调用 runc 启动 runc create 的进程</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">r</span> <span style="color:#f92672">*</span><span style="color:#75af00">Runc</span><span style="color:#111">)</span> <span style="color:#75af00">Start</span><span style="color:#111">(</span><span style="color:#75af00">context</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">,</span> <span style="color:#75af00">id</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">runOrError</span><span style="color:#111">(</span><span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">command</span><span style="color:#111">(</span><span style="color:#75af00">context</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;start&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">id</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="runc">runc</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">r</span> <span style="color:#f92672">*</span><span style="color:#75af00">runner</span><span style="color:#111">)</span> <span style="color:#75af00">run</span><span style="color:#111">(</span><span style="color:#75af00">config</span> <span style="color:#f92672">*</span><span style="color:#75af00">specs</span><span style="color:#111">.</span><span style="color:#75af00">Process</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#00a8c8">int</span><span style="color:#111">,</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">switch</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">action</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">case</span> <span style="color:#75af00">CT_ACT_CREATE</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">container</span><span style="color:#111">.</span><span style="color:#75af00">Start</span><span style="color:#111">(</span><span style="color:#75af00">process</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">case</span> <span style="color:#75af00">CT_ACT_RESTORE</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">container</span><span style="color:#111">.</span><span style="color:#75af00">Restore</span><span style="color:#111">(</span><span style="color:#75af00">process</span><span style="color:#111">,</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">criuOpts</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">case</span> <span style="color:#75af00">CT_ACT_RUN</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">container</span><span style="color:#111">.</span><span style="color:#75af00">Run</span><span style="color:#111">(</span><span style="color:#75af00">process</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">default</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Unknown action&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">Container</span><span style="color:#111">)</span> <span style="color:#75af00">Start</span><span style="color:#111">(</span><span style="color:#75af00">process</span> <span style="color:#f92672">*</span><span style="color:#75af00">Process</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">Lock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">Unlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">config</span><span style="color:#111">.</span><span style="color:#75af00">Cgroups</span><span style="color:#111">.</span><span style="color:#75af00">Resources</span><span style="color:#111">.</span><span style="color:#75af00">SkipDevices</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">errors</span><span style="color:#111">.</span><span style="color:#75af00">New</span><span style="color:#111">(</span><span style="color:#d88200">&#34;can&#39;t start container with SkipDevices set&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">process</span><span style="color:#111">.</span><span style="color:#75af00">Init</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">createExecFifo</span><span style="color:#111">();</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">start</span><span style="color:#111">(</span><span style="color:#75af00">process</span><span style="color:#111">);</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">process</span><span style="color:#111">.</span><span style="color:#75af00">Init</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">deleteExecFifo</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 调用 runc init 进程 /proc/self/exe 是自己的二进制文件</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">Container</span><span style="color:#111">)</span> <span style="color:#75af00">newParentProcess</span><span style="color:#111">(</span><span style="color:#75af00">p</span> <span style="color:#f92672">*</span><span style="color:#75af00">Process</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#75af00">parentProcess</span><span style="color:#111">,</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">comm</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">newProcessComm</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Make sure we use a new safe copy of /proc/self/exe or the runc-dmz</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// binary each time this is called, to make sure that if a container</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// manages to overwrite the file it cannot affect other containers on the</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// system. For runc, this code will only ever be called once, but</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// libcontainer users might call this more than once.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">closeClonedExes</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">var</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">exePath</span> <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// only one of dmzExe or safeExe are used at a time</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">dmzExe</span><span style="color:#111">,</span> <span style="color:#75af00">safeExe</span> <span style="color:#f92672">*</span><span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">File</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">dmz</span><span style="color:#111">.</span><span style="color:#75af00">IsSelfExeCloned</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// /proc/self/exe is already a cloned binary -- no need to do anything</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">logrus</span><span style="color:#111">.</span><span style="color:#75af00">Debug</span><span style="color:#111">(</span><span style="color:#d88200">&#34;skipping binary cloning -- /proc/self/exe is already cloned!&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">exePath</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;/proc/self/exe&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span> 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">cmd</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">exec</span><span style="color:#111">.</span><span style="color:#75af00">Command</span><span style="color:#111">(</span><span style="color:#75af00">exePath</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;init&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">cmd</span><span style="color:#111">.</span><span style="color:#75af00">Args</span><span style="color:#111">[</span><span style="color:#ae81ff">0</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">Args</span><span style="color:#111">[</span><span style="color:#ae81ff">0</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">cmd</span><span style="color:#111">.</span><span style="color:#75af00">Stdin</span> <span style="color:#111">=</span> <span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">Stdin</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">cmd</span><span style="color:#111">.</span><span style="color:#75af00">Stdout</span> <span style="color:#111">=</span> <span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">Stdout</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">cmd</span><span style="color:#111">.</span><span style="color:#75af00">Stderr</span> <span style="color:#111">=</span> <span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">Stderr</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">cmd</span><span style="color:#111">.</span><span style="color:#75af00">Dir</span> <span style="color:#111">=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">config</span><span style="color:#111">.</span><span style="color:#75af00">Rootfs</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">cmd</span><span style="color:#111">.</span><span style="color:#75af00">SysProcAttr</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">cmd</span><span style="color:#111">.</span><span style="color:#75af00">SysProcAttr</span> <span style="color:#111">=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">unix</span><span style="color:#111">.</span><span style="color:#75af00">SysProcAttr</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>runc init</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">init</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">Args</span><span style="color:#111">)</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">Args</span><span style="color:#111">[</span><span style="color:#ae81ff">1</span><span style="color:#111">]</span> <span style="color:#f92672">==</span> <span style="color:#d88200">&#34;init&#34;</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// This is the golang entry point for runc init, executed</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// before main() but after libcontainer/nsenter&#39;s nsexec().</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">libcontainer</span><span style="color:#111">.</span><span style="color:#75af00">Init</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// libcontainer.Init() 中调用的</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">startInitialization</span><span style="color:#111">()</span> <span style="color:#111">(</span><span style="color:#75af00">retErr</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#75af00">containerInit</span><span style="color:#111">(</span><span style="color:#75af00">it</span><span style="color:#111">,</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">config</span><span style="color:#111">,</span> <span style="color:#75af00">syncPipe</span><span style="color:#111">,</span> <span style="color:#75af00">consoleSocket</span><span style="color:#111">,</span> <span style="color:#75af00">pidfdSocket</span><span style="color:#111">,</span> <span style="color:#75af00">fifofd</span><span style="color:#111">,</span> <span style="color:#75af00">logFD</span><span style="color:#111">,</span> <span style="color:#75af00">dmzExe</span><span style="color:#111">,</span> <span style="color:#75af00">mountFds</span><span style="color:#111">{</span><span style="color:#75af00">sourceFds</span><span style="color:#111">:</span> <span style="color:#75af00">mountSrcFds</span><span style="color:#111">,</span> <span style="color:#75af00">idmapFds</span><span style="color:#111">:</span> <span style="color:#75af00">idmapFds</span><span style="color:#111">})</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// linuxSetnsInit 是 exec 的时候调用的 在启动的容器执行命令</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// initStandard 是启动容器</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">containerInit</span><span style="color:#111">(</span><span style="color:#75af00">t</span> <span style="color:#75af00">initType</span><span style="color:#111">,</span> <span style="color:#75af00">config</span> <span style="color:#f92672">*</span><span style="color:#75af00">initConfig</span><span style="color:#111">,</span> <span style="color:#75af00">pipe</span> <span style="color:#f92672">*</span><span style="color:#75af00">syncSocket</span><span style="color:#111">,</span> <span style="color:#75af00">consoleSocket</span><span style="color:#111">,</span> <span style="color:#75af00">pidfdSocket</span> <span style="color:#f92672">*</span><span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">File</span><span style="color:#111">,</span> <span style="color:#75af00">fifoFd</span><span style="color:#111">,</span> <span style="color:#75af00">logFd</span> <span style="color:#00a8c8">int</span><span style="color:#111">,</span> <span style="color:#75af00">dmzExe</span> <span style="color:#f92672">*</span><span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">File</span><span style="color:#111">,</span> <span style="color:#75af00">mountFds</span> <span style="color:#75af00">mountFds</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">populateProcessEnvironment</span><span style="color:#111">(</span><span style="color:#75af00">config</span><span style="color:#111">.</span><span style="color:#75af00">Env</span><span style="color:#111">);</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">switch</span> <span style="color:#75af00">t</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">case</span> <span style="color:#75af00">initSetns</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// mount and idmap fds must be nil in this case. We don&#39;t mount while doing runc exec.</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">mountFds</span><span style="color:#111">.</span><span style="color:#75af00">sourceFds</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#f92672">||</span> <span style="color:#75af00">mountFds</span><span style="color:#111">.</span><span style="color:#75af00">idmapFds</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#75af00">errors</span><span style="color:#111">.</span><span style="color:#75af00">New</span><span style="color:#111">(</span><span style="color:#d88200">&#34;mount and idmap fds must be nil; can&#39;t mount from exec&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">i</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">linuxSetnsInit</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">pipe</span><span style="color:#111">:</span>          <span style="color:#75af00">pipe</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">consoleSocket</span><span style="color:#111">:</span> <span style="color:#75af00">consoleSocket</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">pidfdSocket</span><span style="color:#111">:</span>   <span style="color:#75af00">pidfdSocket</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">config</span><span style="color:#111">:</span>        <span style="color:#75af00">config</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">logFd</span><span style="color:#111">:</span>         <span style="color:#75af00">logFd</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">dmzExe</span><span style="color:#111">:</span>        <span style="color:#75af00">dmzExe</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">i</span><span style="color:#111">.</span><span style="color:#75af00">Init</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">case</span> <span style="color:#75af00">initStandard</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">i</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">linuxStandardInit</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">pipe</span><span style="color:#111">:</span>          <span style="color:#75af00">pipe</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">consoleSocket</span><span style="color:#111">:</span> <span style="color:#75af00">consoleSocket</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">pidfdSocket</span><span style="color:#111">:</span>   <span style="color:#75af00">pidfdSocket</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">parentPid</span><span style="color:#111">:</span>     <span style="color:#75af00">unix</span><span style="color:#111">.</span><span style="color:#75af00">Getppid</span><span style="color:#111">(),</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">config</span><span style="color:#111">:</span>        <span style="color:#75af00">config</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">fifoFd</span><span style="color:#111">:</span>        <span style="color:#75af00">fifoFd</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">logFd</span><span style="color:#111">:</span>         <span style="color:#75af00">logFd</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">dmzExe</span><span style="color:#111">:</span>        <span style="color:#75af00">dmzExe</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">mountFds</span><span style="color:#111">:</span>      <span style="color:#75af00">mountFds</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">i</span><span style="color:#111">.</span><span style="color:#75af00">Init</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;unknown init type %q&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">t</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">l</span> <span style="color:#f92672">*</span><span style="color:#75af00">linuxStandardInit</span><span style="color:#111">)</span> <span style="color:#75af00">Init</span><span style="color:#111">()</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#75af00">system</span><span style="color:#111">.</span><span style="color:#75af00">Exec</span><span style="color:#111">(</span><span style="color:#75af00">name</span><span style="color:#111">,</span> <span style="color:#75af00">l</span><span style="color:#111">.</span><span style="color:#75af00">config</span><span style="color:#111">.</span><span style="color:#75af00">Args</span><span style="color:#111">,</span> <span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">Environ</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 替换进程</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">Exec</span><span style="color:#111">(</span><span style="color:#75af00">cmd</span> <span style="color:#00a8c8">string</span><span style="color:#111">,</span> <span style="color:#75af00">args</span> <span style="color:#111">[]</span><span style="color:#00a8c8">string</span><span style="color:#111">,</span> <span style="color:#75af00">env</span> <span style="color:#111">[]</span><span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">unix</span><span style="color:#111">.</span><span style="color:#75af00">Exec</span><span style="color:#111">(</span><span style="color:#75af00">cmd</span><span style="color:#111">,</span> <span style="color:#75af00">args</span><span style="color:#111">,</span> <span style="color:#75af00">env</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#75af00">unix</span><span style="color:#111">.</span><span style="color:#75af00">EINTR</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">PathError</span><span style="color:#111">{</span><span style="color:#75af00">Op</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;exec&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">Path</span><span style="color:#111">:</span> <span style="color:#75af00">cmd</span><span style="color:#111">,</span> <span style="color:#75af00">Err</span><span style="color:#111">:</span> <span style="color:#75af00">err</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div>]]></content:encoded><category>cloud</category><category>docker</category><category>containerd</category><category>runc</category><category>containerd-shim</category><category>kubernetes</category><category>源码分析</category></item><item><title>kratos http原理</title><link>https://daemon365.dev/post/kratos/kratos_http_principle/</link><pubDate>Thu, 29 Jun 2023 00:00:00 +0800</pubDate><guid>https://daemon365.dev/post/kratos/kratos_http_principle/</guid><description>&lt;h2 id="概念"&gt;概念&lt;/h2&gt;
&lt;p&gt;&lt;a href="https://github.com/go-kratos/kratos"&gt;kratos&lt;/a&gt; 为了使http协议的逻辑代码和grpc的逻辑代码使用同一份，选择了基于protobuf的IDL文件使用proto插件生成辅助代码的方式。&lt;/p&gt;
&lt;p&gt;protoc http插件的地址为：&lt;a href="https://github.com/go-kratos/kratos/tree/main/cmd/protoc-gen-go-http"&gt;https://github.com/go-kratos/kratos/tree/main/cmd/protoc-gen-go-http&lt;/a&gt;&lt;/p&gt;
&lt;h2 id="示例"&gt;示例&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-protobuf" data-lang="protobuf"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;syntax&lt;/span&gt; &lt;span style="color:#f92672"&gt;=&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;proto3&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;;&lt;/span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt;&lt;span style="color:#f92672"&gt;package&lt;/span&gt; &lt;span style="color:#111"&gt;helloworld&lt;/span&gt;&lt;span style="color:#111"&gt;;&lt;/span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;option&lt;/span&gt; &lt;span style="color:#111"&gt;go_package&lt;/span&gt; &lt;span style="color:#f92672"&gt;=&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;test/helloworld;helloworld&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;;&lt;/span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;option&lt;/span&gt; &lt;span style="color:#111"&gt;java_multiple_files&lt;/span&gt; &lt;span style="color:#f92672"&gt;=&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;true&lt;/span&gt;&lt;span style="color:#111"&gt;;&lt;/span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;option&lt;/span&gt; &lt;span style="color:#111"&gt;java_package&lt;/span&gt; &lt;span style="color:#f92672"&gt;=&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;helloworld&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;;&lt;/span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;import&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;google/api/annotations.proto&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;;&lt;/span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;service&lt;/span&gt; &lt;span style="color:#111"&gt;Greeter&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;rpc&lt;/span&gt; &lt;span style="color:#111"&gt;SayHello&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#111"&gt;HelloRequest&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;returns&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#111"&gt;HelloReply&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;option&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#111"&gt;google.api.http&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#f92672"&gt;=&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt; &lt;span style="color:#111"&gt;post&lt;/span&gt;&lt;span style="color:#f92672"&gt;:&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;/helloworld&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 声明路由
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;&lt;/span&gt; &lt;span style="color:#111"&gt;body&lt;/span&gt;&lt;span style="color:#f92672"&gt;:&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;*&amp;#34;&lt;/span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt; &lt;span style="color:#111"&gt;};&lt;/span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt; &lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;message&lt;/span&gt; &lt;span style="color:#75af00"&gt;HelloRequest&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;string&lt;/span&gt; &lt;span style="color:#111"&gt;name&lt;/span&gt; &lt;span style="color:#f92672"&gt;=&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;1&lt;/span&gt;&lt;span style="color:#111"&gt;;&lt;/span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt; &lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;message&lt;/span&gt; &lt;span style="color:#75af00"&gt;HelloReply&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;string&lt;/span&gt; &lt;span style="color:#111"&gt;msg&lt;/span&gt; &lt;span style="color:#f92672"&gt;=&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;1&lt;/span&gt;&lt;span style="color:#111"&gt;;&lt;/span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;使用&lt;code&gt;kratos proto client xxx&lt;/code&gt; 生成的代码为：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;// Code generated by protoc-gen-go-http. DO NOT EDIT.&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;// versions:&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;// - protoc-gen-go-http v2.4.0&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;// - protoc v3.19.4&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;// source: helloworld/helloworld.proto&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;package&lt;/span&gt; &lt;span style="color:#75af00"&gt;helloworld&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;import&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;context&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;context&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;http&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;github.com/go-kratos/kratos/v2/transport/http&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;binding&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;github.com/go-kratos/kratos/v2/transport/http/binding&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;// This is a compile-time assertion to ensure that this generated file&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;// is compatible with the kratos package it is being compiled against.&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;var&lt;/span&gt; &lt;span style="color:#75af00"&gt;_&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#111"&gt;new&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;context&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Context&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;var&lt;/span&gt; &lt;span style="color:#75af00"&gt;_&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#75af00"&gt;binding&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;EncodeURL&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;const&lt;/span&gt; &lt;span style="color:#75af00"&gt;_&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#75af00"&gt;http&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;SupportPackageIsVersion1&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;const&lt;/span&gt; &lt;span style="color:#75af00"&gt;OperationGreeterSayHello&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;/helloworld.Greeter/SayHello&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;type&lt;/span&gt; &lt;span style="color:#75af00"&gt;GreeterHTTPServer&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;interface&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;SayHello&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;context&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Context&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;HelloRequest&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;HelloReply&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;error&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;RegisterGreeterHTTPServer&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;s&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;http&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Server&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;srv&lt;/span&gt; &lt;span style="color:#75af00"&gt;GreeterHTTPServer&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;r&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;s&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Route&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;/&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;r&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;POST&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;/helloworld&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;_Greeter_SayHello0_HTTP_Handler&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;srv&lt;/span&gt;&lt;span style="color:#111"&gt;))&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;_Greeter_SayHello0_HTTP_Handler&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;srv&lt;/span&gt; &lt;span style="color:#75af00"&gt;GreeterHTTPServer&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;func&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;ctx&lt;/span&gt; &lt;span style="color:#75af00"&gt;http&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Context&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;error&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;func&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;ctx&lt;/span&gt; &lt;span style="color:#75af00"&gt;http&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Context&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;error&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;var&lt;/span&gt; &lt;span style="color:#75af00"&gt;in&lt;/span&gt; &lt;span style="color:#75af00"&gt;HelloRequest&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;ctx&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Bind&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#f92672"&gt;&amp;amp;&lt;/span&gt;&lt;span style="color:#75af00"&gt;in&lt;/span&gt;&lt;span style="color:#111"&gt;);&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;!=&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;http&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;SetOperation&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;ctx&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;OperationGreeterSayHello&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;h&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;ctx&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Middleware&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;ctx&lt;/span&gt; &lt;span style="color:#75af00"&gt;context&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Context&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;req&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;interface&lt;/span&gt;&lt;span style="color:#111"&gt;{})&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;interface&lt;/span&gt;&lt;span style="color:#111"&gt;{},&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;error&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt; &lt;span style="color:#75af00"&gt;srv&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;SayHello&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;ctx&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;req&lt;/span&gt;&lt;span style="color:#111"&gt;.(&lt;/span&gt;&lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;HelloRequest&lt;/span&gt;&lt;span style="color:#111"&gt;))&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;})&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;out&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;h&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;ctx&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#f92672"&gt;&amp;amp;&lt;/span&gt;&lt;span style="color:#75af00"&gt;in&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;!=&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;reply&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;out&lt;/span&gt;&lt;span style="color:#111"&gt;.(&lt;/span&gt;&lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;HelloReply&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt; &lt;span style="color:#75af00"&gt;ctx&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Result&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;200&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;reply&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;type&lt;/span&gt; &lt;span style="color:#75af00"&gt;GreeterHTTPClient&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;interface&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;SayHello&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;ctx&lt;/span&gt; &lt;span style="color:#75af00"&gt;context&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Context&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;req&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;HelloRequest&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;opts&lt;/span&gt; &lt;span style="color:#f92672"&gt;...&lt;/span&gt;&lt;span style="color:#75af00"&gt;http&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;CallOption&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;rsp&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;HelloReply&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;error&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;type&lt;/span&gt; &lt;span style="color:#75af00"&gt;GreeterHTTPClientImpl&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;struct&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;cc&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;http&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Client&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;NewGreeterHTTPClient&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;client&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;http&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Client&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75af00"&gt;GreeterHTTPClient&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt; &lt;span style="color:#f92672"&gt;&amp;amp;&lt;/span&gt;&lt;span style="color:#75af00"&gt;GreeterHTTPClientImpl&lt;/span&gt;&lt;span style="color:#111"&gt;{&lt;/span&gt;&lt;span style="color:#75af00"&gt;client&lt;/span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;c&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;GreeterHTTPClientImpl&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75af00"&gt;SayHello&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;ctx&lt;/span&gt; &lt;span style="color:#75af00"&gt;context&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Context&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;in&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;HelloRequest&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;opts&lt;/span&gt; &lt;span style="color:#f92672"&gt;...&lt;/span&gt;&lt;span style="color:#75af00"&gt;http&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;CallOption&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;HelloReply&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;error&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;var&lt;/span&gt; &lt;span style="color:#75af00"&gt;out&lt;/span&gt; &lt;span style="color:#75af00"&gt;HelloReply&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;pattern&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;/helloworld&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;path&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;binding&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;EncodeURL&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;pattern&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;in&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;false&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;opts&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#111"&gt;append&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;opts&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;http&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Operation&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;OperationGreeterSayHello&lt;/span&gt;&lt;span style="color:#111"&gt;))&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;opts&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#111"&gt;append&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;opts&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;http&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;PathTemplate&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;pattern&lt;/span&gt;&lt;span style="color:#111"&gt;))&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;c&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;cc&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Invoke&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;ctx&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;POST&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;path&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;in&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#f92672"&gt;&amp;amp;&lt;/span&gt;&lt;span style="color:#75af00"&gt;out&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;opts&lt;/span&gt;&lt;span style="color:#f92672"&gt;...&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;!=&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt; &lt;span style="color:#f92672"&gt;&amp;amp;&lt;/span&gt;&lt;span style="color:#75af00"&gt;out&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;开启一个grpc及http服务:&lt;/p&gt;</description><content:encoded><![CDATA[<h2 id="概念">概念</h2>
<p><a href="https://github.com/go-kratos/kratos">kratos</a> 为了使http协议的逻辑代码和grpc的逻辑代码使用同一份，选择了基于protobuf的IDL文件使用proto插件生成辅助代码的方式。</p>
<p>protoc http插件的地址为：<a href="https://github.com/go-kratos/kratos/tree/main/cmd/protoc-gen-go-http">https://github.com/go-kratos/kratos/tree/main/cmd/protoc-gen-go-http</a></p>
<h2 id="示例">示例</h2>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-protobuf" data-lang="protobuf"><span style="display:flex;"><span><span style="color:#111">syntax</span> <span style="color:#f92672">=</span> <span style="color:#d88200">&#34;proto3&#34;</span><span style="color:#111">;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#f92672">package</span> <span style="color:#111">helloworld</span><span style="color:#111">;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#00a8c8">option</span> <span style="color:#111">go_package</span> <span style="color:#f92672">=</span> <span style="color:#d88200">&#34;test/helloworld;helloworld&#34;</span><span style="color:#111">;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#00a8c8">option</span> <span style="color:#111">java_multiple_files</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">true</span><span style="color:#111">;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#00a8c8">option</span> <span style="color:#111">java_package</span> <span style="color:#f92672">=</span> <span style="color:#d88200">&#34;helloworld&#34;</span><span style="color:#111">;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#00a8c8">import</span> <span style="color:#d88200">&#34;google/api/annotations.proto&#34;</span><span style="color:#111">;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#00a8c8">service</span> <span style="color:#111">Greeter</span> <span style="color:#111">{</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>	<span style="color:#00a8c8">rpc</span> <span style="color:#111">SayHello</span> <span style="color:#111">(</span><span style="color:#111">HelloRequest</span><span style="color:#111">)</span> <span style="color:#00a8c8">returns</span> <span style="color:#111">(</span><span style="color:#111">HelloReply</span><span style="color:#111">)</span>  <span style="color:#111">{</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>		  <span style="color:#00a8c8">option</span> <span style="color:#111">(</span><span style="color:#111">google.api.http</span><span style="color:#111">)</span> <span style="color:#f92672">=</span> <span style="color:#111">{</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>			  <span style="color:#111">post</span><span style="color:#f92672">:</span> <span style="color:#d88200">&#34;/helloworld&#34;</span><span style="color:#111">,</span> <span style="color:#75715e">// 声明路由
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			  <span style="color:#111">body</span><span style="color:#f92672">:</span> <span style="color:#d88200">&#34;*&#34;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>		  <span style="color:#111">};</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>	<span style="color:#111">}</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#111">}</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#00a8c8">message</span> <span style="color:#75af00">HelloRequest</span> <span style="color:#111">{</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>	<span style="color:#00a8c8">string</span> <span style="color:#111">name</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span><span style="color:#111">;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#111">}</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#00a8c8">message</span> <span style="color:#75af00">HelloReply</span> <span style="color:#111">{</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>	<span style="color:#00a8c8">string</span> <span style="color:#111">msg</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span><span style="color:#111">;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#111">}</span><span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>使用<code>kratos proto client xxx</code> 生成的代码为：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// Code generated by protoc-gen-go-http. DO NOT EDIT.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// versions:</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// - protoc-gen-go-http v2.4.0</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// - protoc             v3.19.4</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// source: helloworld/helloworld.proto</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">helloworld</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">context</span> <span style="color:#d88200">&#34;context&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">http</span> <span style="color:#d88200">&#34;github.com/go-kratos/kratos/v2/transport/http&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">binding</span> <span style="color:#d88200">&#34;github.com/go-kratos/kratos/v2/transport/http/binding&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// This is a compile-time assertion to ensure that this generated file</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// is compatible with the kratos package it is being compiled against.</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">var</span> <span style="color:#75af00">_</span> <span style="color:#111">=</span> <span style="color:#111">new</span><span style="color:#111">(</span><span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">var</span> <span style="color:#75af00">_</span> <span style="color:#111">=</span> <span style="color:#75af00">binding</span><span style="color:#111">.</span><span style="color:#75af00">EncodeURL</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">const</span> <span style="color:#75af00">_</span> <span style="color:#111">=</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">SupportPackageIsVersion1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">const</span> <span style="color:#75af00">OperationGreeterSayHello</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;/helloworld.Greeter/SayHello&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">GreeterHTTPServer</span> <span style="color:#00a8c8">interface</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">SayHello</span><span style="color:#111">(</span><span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">,</span> <span style="color:#f92672">*</span><span style="color:#75af00">HelloRequest</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">HelloReply</span><span style="color:#111">,</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">RegisterGreeterHTTPServer</span><span style="color:#111">(</span><span style="color:#75af00">s</span> <span style="color:#f92672">*</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Server</span><span style="color:#111">,</span> <span style="color:#75af00">srv</span> <span style="color:#75af00">GreeterHTTPServer</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">Route</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">POST</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/helloworld&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">_Greeter_SayHello0_HTTP_Handler</span><span style="color:#111">(</span><span style="color:#75af00">srv</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">_Greeter_SayHello0_HTTP_Handler</span><span style="color:#111">(</span><span style="color:#75af00">srv</span> <span style="color:#75af00">GreeterHTTPServer</span><span style="color:#111">)</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">var</span> <span style="color:#75af00">in</span> <span style="color:#75af00">HelloRequest</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">ctx</span><span style="color:#111">.</span><span style="color:#75af00">Bind</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">in</span><span style="color:#111">);</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">SetOperation</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">OperationGreeterSayHello</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">h</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">ctx</span><span style="color:#111">.</span><span style="color:#75af00">Middleware</span><span style="color:#111">(</span><span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">,</span> <span style="color:#75af00">req</span> <span style="color:#00a8c8">interface</span><span style="color:#111">{})</span> <span style="color:#111">(</span><span style="color:#00a8c8">interface</span><span style="color:#111">{},</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#75af00">srv</span><span style="color:#111">.</span><span style="color:#75af00">SayHello</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">req</span><span style="color:#111">.(</span><span style="color:#f92672">*</span><span style="color:#75af00">HelloRequest</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">out</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">h</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">in</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">reply</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">out</span><span style="color:#111">.(</span><span style="color:#f92672">*</span><span style="color:#75af00">HelloReply</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">ctx</span><span style="color:#111">.</span><span style="color:#75af00">Result</span><span style="color:#111">(</span><span style="color:#ae81ff">200</span><span style="color:#111">,</span> <span style="color:#75af00">reply</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">GreeterHTTPClient</span> <span style="color:#00a8c8">interface</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">SayHello</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">,</span> <span style="color:#75af00">req</span> <span style="color:#f92672">*</span><span style="color:#75af00">HelloRequest</span><span style="color:#111">,</span> <span style="color:#75af00">opts</span> <span style="color:#f92672">...</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">CallOption</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#75af00">rsp</span> <span style="color:#f92672">*</span><span style="color:#75af00">HelloReply</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">GreeterHTTPClientImpl</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">cc</span> <span style="color:#f92672">*</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Client</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">NewGreeterHTTPClient</span><span style="color:#111">(</span><span style="color:#75af00">client</span> <span style="color:#f92672">*</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Client</span><span style="color:#111">)</span> <span style="color:#75af00">GreeterHTTPClient</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">GreeterHTTPClientImpl</span><span style="color:#111">{</span><span style="color:#75af00">client</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">GreeterHTTPClientImpl</span><span style="color:#111">)</span> <span style="color:#75af00">SayHello</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">,</span> <span style="color:#75af00">in</span> <span style="color:#f92672">*</span><span style="color:#75af00">HelloRequest</span><span style="color:#111">,</span> <span style="color:#75af00">opts</span> <span style="color:#f92672">...</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">CallOption</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">HelloReply</span><span style="color:#111">,</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">var</span> <span style="color:#75af00">out</span> <span style="color:#75af00">HelloReply</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">pattern</span> <span style="color:#f92672">:=</span> <span style="color:#d88200">&#34;/helloworld&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">path</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">binding</span><span style="color:#111">.</span><span style="color:#75af00">EncodeURL</span><span style="color:#111">(</span><span style="color:#75af00">pattern</span><span style="color:#111">,</span> <span style="color:#75af00">in</span><span style="color:#111">,</span> <span style="color:#00a8c8">false</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">opts</span> <span style="color:#111">=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">opts</span><span style="color:#111">,</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Operation</span><span style="color:#111">(</span><span style="color:#75af00">OperationGreeterSayHello</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">opts</span> <span style="color:#111">=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">opts</span><span style="color:#111">,</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">PathTemplate</span><span style="color:#111">(</span><span style="color:#75af00">pattern</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">cc</span><span style="color:#111">.</span><span style="color:#75af00">Invoke</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;POST&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">path</span><span style="color:#111">,</span> <span style="color:#75af00">in</span><span style="color:#111">,</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">out</span><span style="color:#111">,</span> <span style="color:#75af00">opts</span><span style="color:#f92672">...</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">out</span><span style="color:#111">,</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>开启一个grpc及http服务:</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;context&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;test/helloworld&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;github.com/go-kratos/kratos/v2&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;github.com/go-kratos/kratos/v2/middleware/recovery&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;github.com/go-kratos/kratos/v2/transport/grpc&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;github.com/go-kratos/kratos/v2/transport/http&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">server</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">helloworld</span><span style="color:#111">.</span><span style="color:#75af00">UnimplementedGreeterServer</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">s</span> <span style="color:#f92672">*</span><span style="color:#75af00">server</span><span style="color:#111">)</span> <span style="color:#75af00">SayHello</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">,</span> <span style="color:#75af00">in</span> <span style="color:#f92672">*</span><span style="color:#75af00">helloworld</span><span style="color:#111">.</span><span style="color:#75af00">HelloRequest</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">helloworld</span><span style="color:#111">.</span><span style="color:#75af00">HelloReply</span><span style="color:#111">,</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">helloworld</span><span style="color:#111">.</span><span style="color:#75af00">HelloReply</span><span style="color:#111">{</span><span style="color:#75af00">Msg</span><span style="color:#111">:</span> <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Sprintf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Hello %+v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">in</span><span style="color:#111">.</span><span style="color:#75af00">Name</span><span style="color:#111">)},</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">s</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">server</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">httpSrv</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">NewServer</span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Address</span><span style="color:#111">(</span><span style="color:#d88200">&#34;:8000&#34;</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Middleware</span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">recovery</span><span style="color:#111">.</span><span style="color:#75af00">Recovery</span><span style="color:#111">(),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">grpcSrv</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">grpc</span><span style="color:#111">.</span><span style="color:#75af00">NewServer</span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">grpc</span><span style="color:#111">.</span><span style="color:#75af00">Address</span><span style="color:#111">(</span><span style="color:#d88200">&#34;:9000&#34;</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">grpc</span><span style="color:#111">.</span><span style="color:#75af00">Middleware</span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">recovery</span><span style="color:#111">.</span><span style="color:#75af00">Recovery</span><span style="color:#111">(),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">helloworld</span><span style="color:#111">.</span><span style="color:#75af00">RegisterGreeterServer</span><span style="color:#111">(</span><span style="color:#75af00">grpcSrv</span><span style="color:#111">,</span> <span style="color:#75af00">s</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">helloworld</span><span style="color:#111">.</span><span style="color:#75af00">RegisterGreeterHTTPServer</span><span style="color:#111">(</span><span style="color:#75af00">httpSrv</span><span style="color:#111">,</span> <span style="color:#75af00">s</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">app</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">kratos</span><span style="color:#111">.</span><span style="color:#75af00">New</span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">kratos</span><span style="color:#111">.</span><span style="color:#75af00">Name</span><span style="color:#111">(</span><span style="color:#d88200">&#34;test&#34;</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">kratos</span><span style="color:#111">.</span><span style="color:#75af00">Server</span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">httpSrv</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">grpcSrv</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">app</span><span style="color:#111">.</span><span style="color:#75af00">Run</span><span style="color:#111">();</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Fatal</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>http client：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;context&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;test/helloworld&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;github.com/go-kratos/kratos/v2/middleware/recovery&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">transhttp</span> <span style="color:#d88200">&#34;github.com/go-kratos/kratos/v2/transport/http&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">callHTTP</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">callHTTP</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">conn</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">transhttp</span><span style="color:#111">.</span><span style="color:#75af00">NewClient</span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Background</span><span style="color:#111">(),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">transhttp</span><span style="color:#111">.</span><span style="color:#75af00">WithMiddleware</span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">recovery</span><span style="color:#111">.</span><span style="color:#75af00">Recovery</span><span style="color:#111">(),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">transhttp</span><span style="color:#111">.</span><span style="color:#75af00">WithEndpoint</span><span style="color:#111">(</span><span style="color:#d88200">&#34;127.0.0.1:8000&#34;</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">conn</span><span style="color:#111">.</span><span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">client</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">helloworld</span><span style="color:#111">.</span><span style="color:#75af00">NewGreeterHTTPClient</span><span style="color:#111">(</span><span style="color:#75af00">conn</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">reply</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">client</span><span style="color:#111">.</span><span style="color:#75af00">SayHello</span><span style="color:#111">(</span><span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Background</span><span style="color:#111">(),</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">helloworld</span><span style="color:#111">.</span><span style="color:#75af00">HelloRequest</span><span style="color:#111">{</span><span style="color:#75af00">Name</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;kratos&#34;</span><span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Fatal</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;[http] SayHello %s\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">reply</span><span style="color:#111">.</span><span style="color:#75af00">Msg</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="http-server端实现原理">http server端实现原理</h2>
<p>核心流程为下图 ：</p>
<p><img src="/images/4fe2f5ff-fbaf-462f-8fd1-1fcced329791.jpg" alt=""></p>
<p>首先新建一个struct 并实现 http_pb.go种 GreeterHTTPServer interface  的方法，GreeterHTTPServer的命名方式为protobuf文件中的 <code>service</code>+<code>HTTPServer</code>，interface的方法为<code>protobuf</code>中使用<code>google.api.http</code>生命http路由所有的method。</p>
<p>然后使用RegisterGreeterHTTPServer方法把服务注册进去。大体的流程如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">const</span> <span style="color:#75af00">OperationGreeterSayHello</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;/helloworld.Greeter/SayHello&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">RegisterGreeterHTTPServer</span><span style="color:#111">(</span><span style="color:#75af00">s</span> <span style="color:#f92672">*</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Server</span><span style="color:#111">,</span> <span style="color:#75af00">srv</span> <span style="color:#75af00">GreeterHTTPServer</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">Route</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">POST</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/helloworld&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">_Greeter_SayHello0_HTTP_Handler</span><span style="color:#111">(</span><span style="color:#75af00">srv</span><span style="color:#111">))</span> <span style="color:#75715e">// 注册路由</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">_Greeter_SayHello0_HTTP_Handler</span><span style="color:#111">(</span><span style="color:#75af00">srv</span> <span style="color:#75af00">GreeterHTTPServer</span><span style="color:#111">)</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">var</span> <span style="color:#75af00">in</span> <span style="color:#75af00">HelloRequest</span> <span style="color:#75715e">// protobuf 中声明的request</span>
</span></span><span style="display:flex;"><span> 		<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">ctx</span><span style="color:#111">.</span><span style="color:#75af00">Bind</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">in</span><span style="color:#111">);</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span> <span style="color:#75715e">// 把http的参数绑定到 in</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">SetOperation</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">OperationGreeterSayHello</span><span style="color:#111">)</span> <span style="color:#75715e">// 设置Operation 和grpc一值，用于middleware select 等</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">h</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">ctx</span><span style="color:#111">.</span><span style="color:#75af00">Middleware</span><span style="color:#111">(</span><span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">,</span> <span style="color:#75af00">req</span> <span style="color:#00a8c8">interface</span><span style="color:#111">{})</span> <span style="color:#111">(</span><span style="color:#00a8c8">interface</span><span style="color:#111">{},</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#75af00">srv</span><span style="color:#111">.</span><span style="color:#75af00">SayHello</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">req</span><span style="color:#111">.(</span><span style="color:#f92672">*</span><span style="color:#75af00">HelloRequest</span><span style="color:#111">))</span> <span style="color:#75715e">// 这个方法也就是上文提到的GreeterHTTPServer接口的方法，也就是我们自己实现的struct server里的SayHello方法</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">})</span> <span style="color:#75715e">// 使用责任链模式middleware 这里没有任何中间件</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">out</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">h</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">in</span><span style="color:#111">)</span> <span style="color:#75715e">// 执行</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">reply</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">out</span><span style="color:#111">.(</span><span style="color:#f92672">*</span><span style="color:#75af00">HelloReply</span><span style="color:#111">)</span> 
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">ctx</span><span style="color:#111">.</span><span style="color:#75af00">Result</span><span style="color:#111">(</span><span style="color:#ae81ff">200</span><span style="color:#111">,</span> <span style="color:#75af00">reply</span><span style="color:#111">)</span> 
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><blockquote>
<p>什么事责任链模式？</p>
<p><a href="https://haiyux.cc/post/designmode/behavioral/#%E8%B4%A3%E4%BB%BB%E9%93%BE%E6%A8%A1%E5%BC%8F">https://haiyux.cc/post/designmode/behavioral/#责任链模式</a></p>
</blockquote>
<p>上段代码中的POST方法为：</p>
<p>代码在https://github.com/go-kratos/kratos/blob/main/transport/http/router.go#L76</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">r</span> <span style="color:#f92672">*</span><span style="color:#75af00">Router</span><span style="color:#111">)</span> <span style="color:#75af00">POST</span><span style="color:#111">(</span><span style="color:#75af00">path</span> <span style="color:#00a8c8">string</span><span style="color:#111">,</span> <span style="color:#75af00">h</span> <span style="color:#75af00">HandlerFunc</span><span style="color:#111">,</span> <span style="color:#75af00">m</span> <span style="color:#f92672">...</span><span style="color:#75af00">FilterFunc</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">Handle</span><span style="color:#111">(</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">MethodPost</span><span style="color:#111">,</span> <span style="color:#75af00">path</span><span style="color:#111">,</span> <span style="color:#75af00">h</span><span style="color:#111">,</span> <span style="color:#75af00">m</span><span style="color:#f92672">...</span><span style="color:#111">)</span> <span style="color:#75715e">// MethodPost = POST net/http下的常量</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// h 为上段xxx_http_pb.go代码中_Greeter_SayHello0_HTTP_Handler的返回值</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">r</span> <span style="color:#f92672">*</span><span style="color:#75af00">Router</span><span style="color:#111">)</span> <span style="color:#75af00">Handle</span><span style="color:#111">(</span><span style="color:#75af00">method</span><span style="color:#111">,</span> <span style="color:#75af00">relativePath</span> <span style="color:#00a8c8">string</span><span style="color:#111">,</span> <span style="color:#75af00">h</span> <span style="color:#75af00">HandlerFunc</span><span style="color:#111">,</span> <span style="color:#75af00">filters</span> <span style="color:#f92672">...</span><span style="color:#75af00">FilterFunc</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">next</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Handler</span><span style="color:#111">(</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">HandlerFunc</span><span style="color:#111">(</span><span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">res</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">ResponseWriter</span><span style="color:#111">,</span> <span style="color:#75af00">req</span> <span style="color:#f92672">*</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Request</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">ctx</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">pool</span><span style="color:#111">.</span><span style="color:#75af00">Get</span><span style="color:#111">().(</span><span style="color:#75af00">Context</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">ctx</span><span style="color:#111">.</span><span style="color:#75af00">Reset</span><span style="color:#111">(</span><span style="color:#75af00">res</span><span style="color:#111">,</span> <span style="color:#75af00">req</span><span style="color:#111">)</span> <span style="color:#75715e">// 把 net/http的http.ResponseWriter 和*http.Request 设置ctx中</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">h</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">);</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span> <span style="color:#75715e">// 执行h </span>
</span></span><span style="display:flex;"><span>            <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">srv</span><span style="color:#111">.</span><span style="color:#75af00">ene</span><span style="color:#111">(</span><span style="color:#75af00">res</span><span style="color:#111">,</span> <span style="color:#75af00">req</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span> <span style="color:#75715e">// 如果出错了 执行 ene(EncodeErrorFunc)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">ctx</span><span style="color:#111">.</span><span style="color:#75af00">Reset</span><span style="color:#111">(</span><span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">pool</span><span style="color:#111">.</span><span style="color:#75af00">Put</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">next</span> <span style="color:#111">=</span> <span style="color:#75af00">FilterChain</span><span style="color:#111">(</span><span style="color:#75af00">filters</span><span style="color:#f92672">...</span><span style="color:#111">)(</span><span style="color:#75af00">next</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">next</span> <span style="color:#111">=</span> <span style="color:#75af00">FilterChain</span><span style="color:#111">(</span><span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">filters</span><span style="color:#f92672">...</span><span style="color:#111">)(</span><span style="color:#75af00">next</span><span style="color:#111">)</span> <span style="color:#75715e">// 添加filter 责任链模式</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">srv</span><span style="color:#111">.</span><span style="color:#75af00">router</span><span style="color:#111">.</span><span style="color:#75af00">Handle</span><span style="color:#111">(</span><span style="color:#75af00">path</span><span style="color:#111">.</span><span style="color:#75af00">Join</span><span style="color:#111">(</span><span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">prefix</span><span style="color:#111">,</span> <span style="color:#75af00">relativePath</span><span style="color:#111">),</span> <span style="color:#75af00">next</span><span style="color:#111">).</span><span style="color:#75af00">Methods</span><span style="color:#111">(</span><span style="color:#75af00">method</span><span style="color:#111">)</span> <span style="color:#75715e">// router 为 mux的router 把方法注册到路由中</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>当我们访问 <code>path.Join(r.prefix, relativePath)</code>也就是<code>/helloworld</code> 时，会执行上段代码中的<code>next</code>方法，next是一个责任链。</p>
<p>核心为会执行_Greeter_SayHello0_HTTP_Handler方法，</p>
<p>如果没发生错误，执行<code>ctx.Result(200, reply)</code></p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">wrapper</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">router</span> <span style="color:#f92672">*</span><span style="color:#75af00">Router</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">req</span>    <span style="color:#f92672">*</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Request</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">res</span>    <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">ResponseWriter</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">w</span>      <span style="color:#75af00">responseWriter</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">wrapper</span><span style="color:#111">)</span> <span style="color:#75af00">Result</span><span style="color:#111">(</span><span style="color:#75af00">code</span> <span style="color:#00a8c8">int</span><span style="color:#111">,</span> <span style="color:#75af00">v</span> <span style="color:#00a8c8">interface</span><span style="color:#111">{})</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">w</span><span style="color:#111">.</span><span style="color:#75af00">WriteHeader</span><span style="color:#111">(</span><span style="color:#75af00">code</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">router</span><span style="color:#111">.</span><span style="color:#75af00">srv</span><span style="color:#111">.</span><span style="color:#75af00">enc</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">w</span><span style="color:#111">,</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">req</span><span style="color:#111">,</span> <span style="color:#75af00">v</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>enc也就是<code>EncodeResponseFunc</code>, 为kratos预留的返回值函数</p>
<pre tabindex="0"><code>type EncodeResponseFunc func(http.ResponseWriter, *http.Request, interface{}) error
</code></pre><p>kratos提供了默认的EncodeResponseFunc</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">DefaultResponseEncoder</span><span style="color:#111">(</span><span style="color:#75af00">w</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">ResponseWriter</span><span style="color:#111">,</span> <span style="color:#75af00">r</span> <span style="color:#f92672">*</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Request</span><span style="color:#111">,</span> <span style="color:#75af00">v</span> <span style="color:#00a8c8">interface</span><span style="color:#111">{})</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">v</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">rd</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">v</span><span style="color:#111">.(</span><span style="color:#75af00">Redirector</span><span style="color:#111">);</span> <span style="color:#75af00">ok</span> <span style="color:#111">{</span> <span style="color:#75715e">// 检查有无Redirect方法，如果实现了interface 为跳转路由 也就是http的301 302等</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">url</span><span style="color:#111">,</span> <span style="color:#75af00">code</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">rd</span><span style="color:#111">.</span><span style="color:#75af00">Redirect</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Redirect</span><span style="color:#111">(</span><span style="color:#75af00">w</span><span style="color:#111">,</span> <span style="color:#75af00">r</span><span style="color:#111">,</span> <span style="color:#75af00">url</span><span style="color:#111">,</span> <span style="color:#75af00">code</span><span style="color:#111">)</span> <span style="color:#75715e">// 跳转</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">codec</span><span style="color:#111">,</span> <span style="color:#75af00">_</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">CodecForRequest</span><span style="color:#111">(</span><span style="color:#75af00">r</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Accept&#34;</span><span style="color:#111">)</span> <span style="color:#75715e">// 查看需要返回的参数类型 比如json</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">data</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">codec</span><span style="color:#111">.</span><span style="color:#75af00">Marshal</span><span style="color:#111">(</span><span style="color:#75af00">v</span><span style="color:#111">)</span> <span style="color:#75715e">// 把数据Marshal成[]byte</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">w</span><span style="color:#111">.</span><span style="color:#75af00">Header</span><span style="color:#111">().</span><span style="color:#75af00">Set</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Content-Type&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">httputil</span><span style="color:#111">.</span><span style="color:#75af00">ContentType</span><span style="color:#111">(</span><span style="color:#75af00">codec</span><span style="color:#111">.</span><span style="color:#75af00">Name</span><span style="color:#111">()))</span> <span style="color:#75715e">// 设置header</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">w</span><span style="color:#111">.</span><span style="color:#75af00">Write</span><span style="color:#111">(</span><span style="color:#75af00">data</span><span style="color:#111">)</span> <span style="color:#75715e">// 写数据</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>如果没发生错误，执行<code>ene</code>,也就是<code>EncodeErrorFunc</code>, 为kratos预留的错误返回值删除</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">EncodeErrorFunc</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">ResponseWriter</span><span style="color:#111">,</span> <span style="color:#f92672">*</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Request</span><span style="color:#111">,</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span>
</span></span></code></pre></div><p>kratos提供了默认的EncodeErrorFunc</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">DefaultErrorEncoder</span><span style="color:#111">(</span><span style="color:#75af00">w</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">ResponseWriter</span><span style="color:#111">,</span> <span style="color:#75af00">r</span> <span style="color:#f92672">*</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Request</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">se</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">errors</span><span style="color:#111">.</span><span style="color:#75af00">FromError</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span> <span style="color:#75715e">// 把error变成自定义的实现error的结构体</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">codec</span><span style="color:#111">,</span> <span style="color:#75af00">_</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">CodecForRequest</span><span style="color:#111">(</span><span style="color:#75af00">r</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Accept&#34;</span><span style="color:#111">)</span> <span style="color:#75715e">// 查看需要返回的参数类型 比如json</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">body</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">codec</span><span style="color:#111">.</span><span style="color:#75af00">Marshal</span><span style="color:#111">(</span><span style="color:#75af00">se</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">w</span><span style="color:#111">.</span><span style="color:#75af00">WriteHeader</span><span style="color:#111">(</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">StatusInternalServerError</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">w</span><span style="color:#111">.</span><span style="color:#75af00">Header</span><span style="color:#111">().</span><span style="color:#75af00">Set</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Content-Type&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">httputil</span><span style="color:#111">.</span><span style="color:#75af00">ContentType</span><span style="color:#111">(</span><span style="color:#75af00">codec</span><span style="color:#111">.</span><span style="color:#75af00">Name</span><span style="color:#111">()))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">w</span><span style="color:#111">.</span><span style="color:#75af00">WriteHeader</span><span style="color:#111">(</span><span style="color:#111">int</span><span style="color:#111">(</span><span style="color:#75af00">se</span><span style="color:#111">.</span><span style="color:#75af00">Code</span><span style="color:#111">))</span> <span style="color:#75715e">// 写入 error中的code</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">_</span> <span style="color:#111">=</span> <span style="color:#75af00">w</span><span style="color:#111">.</span><span style="color:#75af00">Write</span><span style="color:#111">(</span><span style="color:#75af00">body</span><span style="color:#111">)</span> <span style="color:#75715e">// 返回错误信息</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="http-client端实现原理">http client端实现原理</h2>
<p>在上传的代码中http client的部分为</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">GreeterHTTPClient</span> <span style="color:#00a8c8">interface</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">SayHello</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">,</span> <span style="color:#75af00">req</span> <span style="color:#f92672">*</span><span style="color:#75af00">HelloRequest</span><span style="color:#111">,</span> <span style="color:#75af00">opts</span> <span style="color:#f92672">...</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">CallOption</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#75af00">rsp</span> <span style="color:#f92672">*</span><span style="color:#75af00">HelloReply</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">GreeterHTTPClientImpl</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span> <span style="color:#75715e">// 实现 GreeterHTTPClient 接口</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">cc</span> <span style="color:#f92672">*</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Client</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">NewGreeterHTTPClient</span><span style="color:#111">(</span><span style="color:#75af00">client</span> <span style="color:#f92672">*</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Client</span><span style="color:#111">)</span> <span style="color:#75af00">GreeterHTTPClient</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">GreeterHTTPClientImpl</span><span style="color:#111">{</span><span style="color:#75af00">client</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">GreeterHTTPClientImpl</span><span style="color:#111">)</span> <span style="color:#75af00">SayHello</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">,</span> <span style="color:#75af00">in</span> <span style="color:#f92672">*</span><span style="color:#75af00">HelloRequest</span><span style="color:#111">,</span> <span style="color:#75af00">opts</span> <span style="color:#f92672">...</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">CallOption</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">HelloReply</span><span style="color:#111">,</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">var</span> <span style="color:#75af00">out</span> <span style="color:#75af00">HelloReply</span> <span style="color:#75715e">// 返回值</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">pattern</span> <span style="color:#f92672">:=</span> <span style="color:#d88200">&#34;/helloworld&#34;</span> 
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">path</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">binding</span><span style="color:#111">.</span><span style="color:#75af00">EncodeURL</span><span style="color:#111">(</span><span style="color:#75af00">pattern</span><span style="color:#111">,</span> <span style="color:#75af00">in</span><span style="color:#111">,</span> <span style="color:#00a8c8">false</span><span style="color:#111">)</span> <span style="color:#75715e">// 整理path 传入in 是由于可能有path参数或者query</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">opts</span> <span style="color:#111">=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">opts</span><span style="color:#111">,</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Operation</span><span style="color:#111">(</span><span style="color:#75af00">OperationGreeterSayHello</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">opts</span> <span style="color:#111">=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">opts</span><span style="color:#111">,</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">PathTemplate</span><span style="color:#111">(</span><span style="color:#75af00">pattern</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">cc</span><span style="color:#111">.</span><span style="color:#75af00">Invoke</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;POST&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">path</span><span style="color:#111">,</span> <span style="color:#75af00">in</span><span style="color:#111">,</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">out</span><span style="color:#111">,</span> <span style="color:#75af00">opts</span><span style="color:#f92672">...</span><span style="color:#111">)</span> <span style="color:#75715e">// 访问接口</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">out</span><span style="color:#111">,</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>上段代码中的Invoke方法为：</p>
<p>代码在https://github.com/go-kratos/kratos/blob/main/transport/http/client.go#L192</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">client</span> <span style="color:#f92672">*</span><span style="color:#75af00">Client</span><span style="color:#111">)</span> <span style="color:#75af00">Invoke</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">,</span> <span style="color:#75af00">method</span><span style="color:#111">,</span> <span style="color:#75af00">path</span> <span style="color:#00a8c8">string</span><span style="color:#111">,</span> <span style="color:#75af00">args</span> <span style="color:#00a8c8">interface</span><span style="color:#111">{},</span> <span style="color:#75af00">reply</span> <span style="color:#00a8c8">interface</span><span style="color:#111">{},</span> <span style="color:#75af00">opts</span> <span style="color:#f92672">...</span><span style="color:#75af00">CallOption</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">var</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">contentType</span> <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">body</span>        <span style="color:#75af00">io</span><span style="color:#111">.</span><span style="color:#75af00">Reader</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">c</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">defaultCallInfo</span><span style="color:#111">(</span><span style="color:#75af00">path</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">o</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">opts</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">o</span><span style="color:#111">.</span><span style="color:#75af00">before</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">c</span><span style="color:#111">);</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">args</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">data</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">client</span><span style="color:#111">.</span><span style="color:#75af00">opts</span><span style="color:#111">.</span><span style="color:#75af00">encoder</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">contentType</span><span style="color:#111">,</span> <span style="color:#75af00">args</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">contentType</span> <span style="color:#111">=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">contentType</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">body</span> <span style="color:#111">=</span> <span style="color:#75af00">bytes</span><span style="color:#111">.</span><span style="color:#75af00">NewReader</span><span style="color:#111">(</span><span style="color:#75af00">data</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">url</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Sprintf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;%s://%s%s&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">client</span><span style="color:#111">.</span><span style="color:#75af00">target</span><span style="color:#111">.</span><span style="color:#75af00">Scheme</span><span style="color:#111">,</span> <span style="color:#75af00">client</span><span style="color:#111">.</span><span style="color:#75af00">target</span><span style="color:#111">.</span><span style="color:#75af00">Authority</span><span style="color:#111">,</span> <span style="color:#75af00">path</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">req</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">NewRequest</span><span style="color:#111">(</span><span style="color:#75af00">method</span><span style="color:#111">,</span> <span style="color:#75af00">url</span><span style="color:#111">,</span> <span style="color:#75af00">body</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">contentType</span> <span style="color:#f92672">!=</span> <span style="color:#d88200">&#34;&#34;</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">req</span><span style="color:#111">.</span><span style="color:#75af00">Header</span><span style="color:#111">.</span><span style="color:#75af00">Set</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Content-Type&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">contentType</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">client</span><span style="color:#111">.</span><span style="color:#75af00">opts</span><span style="color:#111">.</span><span style="color:#75af00">userAgent</span> <span style="color:#f92672">!=</span> <span style="color:#d88200">&#34;&#34;</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">req</span><span style="color:#111">.</span><span style="color:#75af00">Header</span><span style="color:#111">.</span><span style="color:#75af00">Set</span><span style="color:#111">(</span><span style="color:#d88200">&#34;User-Agent&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">client</span><span style="color:#111">.</span><span style="color:#75af00">opts</span><span style="color:#111">.</span><span style="color:#75af00">userAgent</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ctx</span> <span style="color:#111">=</span> <span style="color:#75af00">transport</span><span style="color:#111">.</span><span style="color:#75af00">NewClientContext</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">Transport</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">endpoint</span><span style="color:#111">:</span>     <span style="color:#75af00">client</span><span style="color:#111">.</span><span style="color:#75af00">opts</span><span style="color:#111">.</span><span style="color:#75af00">endpoint</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">reqHeader</span><span style="color:#111">:</span>    <span style="color:#75af00">headerCarrier</span><span style="color:#111">(</span><span style="color:#75af00">req</span><span style="color:#111">.</span><span style="color:#75af00">Header</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">operation</span><span style="color:#111">:</span>    <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">operation</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">request</span><span style="color:#111">:</span>      <span style="color:#75af00">req</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">pathTemplate</span><span style="color:#111">:</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">pathTemplate</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">client</span><span style="color:#111">.</span><span style="color:#75af00">invoke</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">req</span><span style="color:#111">,</span> <span style="color:#75af00">args</span><span style="color:#111">,</span> <span style="color:#75af00">reply</span><span style="color:#111">,</span> <span style="color:#75af00">c</span><span style="color:#111">,</span> <span style="color:#75af00">opts</span><span style="color:#f92672">...</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">client</span> <span style="color:#f92672">*</span><span style="color:#75af00">Client</span><span style="color:#111">)</span> <span style="color:#75af00">invoke</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">,</span> <span style="color:#75af00">req</span> <span style="color:#f92672">*</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Request</span><span style="color:#111">,</span> <span style="color:#75af00">args</span> <span style="color:#00a8c8">interface</span><span style="color:#111">{},</span> <span style="color:#75af00">reply</span> <span style="color:#00a8c8">interface</span><span style="color:#111">{},</span> <span style="color:#75af00">c</span> <span style="color:#75af00">callInfo</span><span style="color:#111">,</span> <span style="color:#75af00">opts</span> <span style="color:#f92672">...</span><span style="color:#75af00">CallOption</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">h</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">,</span> <span style="color:#75af00">in</span> <span style="color:#00a8c8">interface</span><span style="color:#111">{})</span> <span style="color:#111">(</span><span style="color:#00a8c8">interface</span><span style="color:#111">{},</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">res</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">client</span><span style="color:#111">.</span><span style="color:#75af00">do</span><span style="color:#111">(</span><span style="color:#75af00">req</span><span style="color:#111">.</span><span style="color:#75af00">WithContext</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">res</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">cs</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">csAttempt</span><span style="color:#111">{</span><span style="color:#75af00">res</span><span style="color:#111">:</span> <span style="color:#75af00">res</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">o</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">opts</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">o</span><span style="color:#111">.</span><span style="color:#75af00">after</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">c</span><span style="color:#111">,</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">cs</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">defer</span> <span style="color:#75af00">res</span><span style="color:#111">.</span><span style="color:#75af00">Body</span><span style="color:#111">.</span><span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">client</span><span style="color:#111">.</span><span style="color:#75af00">opts</span><span style="color:#111">.</span><span style="color:#75af00">decoder</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">res</span><span style="color:#111">,</span> <span style="color:#75af00">reply</span><span style="color:#111">);</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">reply</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">var</span> <span style="color:#75af00">p</span> <span style="color:#75af00">selector</span><span style="color:#111">.</span><span style="color:#75af00">Peer</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ctx</span> <span style="color:#111">=</span> <span style="color:#75af00">selector</span><span style="color:#111">.</span><span style="color:#75af00">NewPeerContext</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">p</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">client</span><span style="color:#111">.</span><span style="color:#75af00">opts</span><span style="color:#111">.</span><span style="color:#75af00">middleware</span><span style="color:#111">)</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">h</span> <span style="color:#111">=</span> <span style="color:#75af00">middleware</span><span style="color:#111">.</span><span style="color:#75af00">Chain</span><span style="color:#111">(</span><span style="color:#75af00">client</span><span style="color:#111">.</span><span style="color:#75af00">opts</span><span style="color:#111">.</span><span style="color:#75af00">middleware</span><span style="color:#f92672">...</span><span style="color:#111">)(</span><span style="color:#75af00">h</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">h</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">args</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div>]]></content:encoded><category>kratos</category><category>go</category><category>kratos</category><category>源码分析</category></item><item><title>从kratos分析breaker熔断器源码实现</title><link>https://daemon365.dev/post/kratos/analyzing_the_breaker_fuse_source_code_implementation_from_kratos/</link><pubDate>Sat, 04 Sep 2021 17:55:01 +0800</pubDate><guid>https://daemon365.dev/post/kratos/analyzing_the_breaker_fuse_source_code_implementation_from_kratos/</guid><description>&lt;h2 id="为什么要用熔断"&gt;为什么要用熔断&lt;/h2&gt;
&lt;p&gt;前面我们讲过限流保证服务的可用性，不被突如其来的流量打爆。但是两种情况是限流解决不了的。&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;如果我们服务只能处理1000QPS，但是有10wQPS打过来，服务还是会炸。因为拒绝请求也需要成本。&lt;/li&gt;
&lt;li&gt;服务但是io型的，会把mysql，redis，mq等中间件打挂。&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;所以，我们遵循一个思路，可不可以client端在失败的多的时候就不调用了，直接返回错误呢？&lt;/p&gt;
&lt;h2 id="什么是熔断"&gt;什么是熔断&lt;/h2&gt;
&lt;p&gt;熔断器是为了当依赖的服务已经出现故障时，主动阻止对依赖服务的请求。保证自身服务的正常运行不受依赖服务影响，防止雪崩效应。&lt;/p&gt;
&lt;h2 id="源码分析"&gt;源码分析&lt;/h2&gt;
&lt;h3 id="源码地址"&gt;源码地址&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="https://github.com/go-kratos/aegis/tree/main/circuitbreaker"&gt;https://github.com/go-kratos/aegis/tree/main/circuitbreaker&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id="circuitbreaker-接口"&gt;CircuitBreaker 接口&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;type&lt;/span&gt; &lt;span style="color:#75af00"&gt;CircuitBreaker&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;interface&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;Allow&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;error&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;MarkSuccess&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;MarkFailed&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ol&gt;
&lt;li&gt;Allow()
&lt;ul&gt;
&lt;li&gt;判断熔断器是否允许通过&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;MarkSuccess()
&lt;ul&gt;
&lt;li&gt;熔断器成功的回调&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;MarkFailed()
&lt;ul&gt;
&lt;li&gt;熔断器失败的回调&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id="group-结构体"&gt;Group 结构体&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;type&lt;/span&gt; &lt;span style="color:#75af00"&gt;Group&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;struct&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;mutex&lt;/span&gt; &lt;span style="color:#75af00"&gt;sync&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Mutex&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;val&lt;/span&gt; &lt;span style="color:#75af00"&gt;atomic&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Value&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;New&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;func&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#75af00"&gt;CircuitBreaker&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ol&gt;
&lt;li&gt;&lt;code&gt;mutex&lt;/code&gt;
&lt;ul&gt;
&lt;li&gt;互斥锁，使val这个map不产生数据竞争&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;code&gt;val&lt;/code&gt;
&lt;ul&gt;
&lt;li&gt;map，存储name -&amp;gt; CircuitBreaker&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;code&gt;New&lt;/code&gt;
&lt;ul&gt;
&lt;li&gt;生成一个CircuitBreaker&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;h4 id="get方法"&gt;Get方法&lt;/h4&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;// Get .&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;g&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;Group&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75af00"&gt;Get&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;name&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;string&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75af00"&gt;CircuitBreaker&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;m&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;ok&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;g&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;val&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Load&lt;/span&gt;&lt;span style="color:#111"&gt;().(&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;map&lt;/span&gt;&lt;span style="color:#111"&gt;[&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;string&lt;/span&gt;&lt;span style="color:#111"&gt;]&lt;/span&gt;&lt;span style="color:#75af00"&gt;CircuitBreaker&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;ok&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;breaker&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;ok&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;m&lt;/span&gt;&lt;span style="color:#111"&gt;[&lt;/span&gt;&lt;span style="color:#75af00"&gt;name&lt;/span&gt;&lt;span style="color:#111"&gt;]&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;ok&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt; &lt;span style="color:#75af00"&gt;breaker&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 很具name从val拿出 breaker 如果存在返回&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// slowpath for group don`t have specified name breaker.&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;g&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;mutex&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Lock&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;nm&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#111"&gt;make&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;map&lt;/span&gt;&lt;span style="color:#111"&gt;[&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;string&lt;/span&gt;&lt;span style="color:#111"&gt;]&lt;/span&gt;&lt;span style="color:#75af00"&gt;CircuitBreaker&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#111"&gt;len&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;m&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;&lt;span style="color:#f92672"&gt;+&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;1&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;for&lt;/span&gt; &lt;span style="color:#75af00"&gt;k&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;v&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;range&lt;/span&gt; &lt;span style="color:#75af00"&gt;m&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;nm&lt;/span&gt;&lt;span style="color:#111"&gt;[&lt;/span&gt;&lt;span style="color:#75af00"&gt;k&lt;/span&gt;&lt;span style="color:#111"&gt;]&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#75af00"&gt;v&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;breaker&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;g&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;New&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;nm&lt;/span&gt;&lt;span style="color:#111"&gt;[&lt;/span&gt;&lt;span style="color:#75af00"&gt;name&lt;/span&gt;&lt;span style="color:#111"&gt;]&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#75af00"&gt;breaker&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 如果不存在 生成一个 并放入map 并返回&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;g&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;val&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Store&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;nm&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;g&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;mutex&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Unlock&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt; &lt;span style="color:#75af00"&gt;breaker&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id="breaker-结构体"&gt;Breaker 结构体&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;// Breaker is a sre CircuitBreaker pattern.&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;type&lt;/span&gt; &lt;span style="color:#75af00"&gt;Breaker&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;struct&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;stat&lt;/span&gt; &lt;span style="color:#75af00"&gt;window&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;RollingCounter&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;r&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;rand&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Rand&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// rand.New(...) returns a non thread safe object&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;randLock&lt;/span&gt; &lt;span style="color:#75af00"&gt;sync&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Mutex&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// Reducing the k will make adaptive throttling behave more aggressively,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// Increasing the k will make adaptive throttling behave less aggressively.&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;k&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;float64&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;request&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;int64&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;state&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;int32&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ol&gt;
&lt;li&gt;stat
&lt;ul&gt;
&lt;li&gt;滑动窗口，记录成功失败&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;r
&lt;ul&gt;
&lt;li&gt;随机数&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;randLock
&lt;ul&gt;
&lt;li&gt;读写锁&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;k 成功系数
&lt;ul&gt;
&lt;li&gt;total(总数) = success * k&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;request 请求数
&lt;ul&gt;
&lt;li&gt;当总数 &amp;lt; request时，不判断是否熔断&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;state
&lt;ul&gt;
&lt;li&gt;熔断器状态 打开或者关闭&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id="allow方法"&gt;Allow()方法&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;// Allow request if error returns nil.&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;b&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;Breaker&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75af00"&gt;Allow&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;error&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;success&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;total&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;b&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;summary&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 从活动窗口获取成功数和总数&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;k&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;b&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;k&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt; &lt;span style="color:#111"&gt;float64&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;success&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 根据k成功系数 获取&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// check overflow requests = K * success&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;total&lt;/span&gt; &lt;span style="color:#111"&gt;&amp;lt;&lt;/span&gt; &lt;span style="color:#75af00"&gt;b&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;request&lt;/span&gt; &lt;span style="color:#f92672"&gt;||&lt;/span&gt; &lt;span style="color:#111"&gt;float64&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;total&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#111"&gt;&amp;lt;&lt;/span&gt; &lt;span style="color:#75af00"&gt;k&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 如果总数&amp;lt;request 或者 总数 &amp;lt; k &lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;atomic&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;LoadInt32&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#f92672"&gt;&amp;amp;&lt;/span&gt;&lt;span style="color:#75af00"&gt;b&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;state&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#f92672"&gt;==&lt;/span&gt; &lt;span style="color:#75af00"&gt;StateOpen&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;atomic&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;CompareAndSwapInt32&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#f92672"&gt;&amp;amp;&lt;/span&gt;&lt;span style="color:#75af00"&gt;b&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;state&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;StateOpen&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;StateClosed&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 如果state是打开 关闭&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;atomic&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;LoadInt32&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#f92672"&gt;&amp;amp;&lt;/span&gt;&lt;span style="color:#75af00"&gt;b&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;state&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#f92672"&gt;==&lt;/span&gt; &lt;span style="color:#75af00"&gt;StateClosed&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;atomic&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;CompareAndSwapInt32&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#f92672"&gt;&amp;amp;&lt;/span&gt;&lt;span style="color:#75af00"&gt;b&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;state&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;StateClosed&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;StateOpen&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 如果state是关闭 打开&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;dr&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;math&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Max&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;0&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#111"&gt;float64&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;total&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;&lt;span style="color:#f92672"&gt;-&lt;/span&gt;&lt;span style="color:#75af00"&gt;k&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;&lt;span style="color:#f92672"&gt;/&lt;/span&gt;&lt;span style="color:#111"&gt;float64&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;total&lt;/span&gt;&lt;span style="color:#f92672"&gt;+&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;1&lt;/span&gt;&lt;span style="color:#111"&gt;))&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 获取系数，当k越大 dr越小&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;drop&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;b&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;trueOnProba&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;dr&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// trueOnProba 获取水机数&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// 返回是否&amp;lt;dr&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;drop&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt; &lt;span style="color:#75715e"&gt;// 如果是 拒绝请求&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt; &lt;span style="color:#75af00"&gt;circuitbreaker&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;ErrNotAllowed&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;b&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;Breaker&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75af00"&gt;trueOnProba&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;proba&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;float64&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;truth&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;bool&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;b&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;randLock&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Lock&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;truth&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#75af00"&gt;b&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;r&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Float64&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#111"&gt;&amp;lt;&lt;/span&gt; &lt;span style="color:#75af00"&gt;proba&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;b&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;randLock&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Unlock&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;使用trueOnProba的原因是，当熔断器关闭时，随机让一部分请求通过，当success越大，请求的通过的数量就越多。用这些数据成功与否，放入窗口统计，当成功数达到要求时，就可以关闭熔断器了。&lt;/p&gt;</description><content:encoded><![CDATA[<h2 id="为什么要用熔断">为什么要用熔断</h2>
<p>前面我们讲过限流保证服务的可用性，不被突如其来的流量打爆。但是两种情况是限流解决不了的。</p>
<ol>
<li>如果我们服务只能处理1000QPS，但是有10wQPS打过来，服务还是会炸。因为拒绝请求也需要成本。</li>
<li>服务但是io型的，会把mysql，redis，mq等中间件打挂。</li>
</ol>
<p>所以，我们遵循一个思路，可不可以client端在失败的多的时候就不调用了，直接返回错误呢？</p>
<h2 id="什么是熔断">什么是熔断</h2>
<p>熔断器是为了当依赖的服务已经出现故障时，主动阻止对依赖服务的请求。保证自身服务的正常运行不受依赖服务影响，防止雪崩效应。</p>
<h2 id="源码分析">源码分析</h2>
<h3 id="源码地址">源码地址</h3>
<ul>
<li><a href="https://github.com/go-kratos/aegis/tree/main/circuitbreaker">https://github.com/go-kratos/aegis/tree/main/circuitbreaker</a></li>
</ul>
<h3 id="circuitbreaker-接口">CircuitBreaker 接口</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">CircuitBreaker</span> <span style="color:#00a8c8">interface</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Allow</span><span style="color:#111">()</span> <span style="color:#00a8c8">error</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">MarkSuccess</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">MarkFailed</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><ol>
<li>Allow()
<ul>
<li>判断熔断器是否允许通过</li>
</ul>
</li>
<li>MarkSuccess()
<ul>
<li>熔断器成功的回调</li>
</ul>
</li>
<li>MarkFailed()
<ul>
<li>熔断器失败的回调</li>
</ul>
</li>
</ol>
<h3 id="group-结构体">Group 结构体</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Group</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75af00">mutex</span> <span style="color:#75af00">sync</span><span style="color:#111">.</span><span style="color:#75af00">Mutex</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75af00">val</span>   <span style="color:#75af00">atomic</span><span style="color:#111">.</span><span style="color:#75af00">Value</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#75af00">New</span> <span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#75af00">CircuitBreaker</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><ol>
<li><code>mutex</code>
<ul>
<li>互斥锁，使val这个map不产生数据竞争</li>
</ul>
</li>
<li><code>val</code>
<ul>
<li>map，存储name -&gt; CircuitBreaker</li>
</ul>
</li>
<li><code>New</code>
<ul>
<li>生成一个CircuitBreaker</li>
</ul>
</li>
</ol>
<h4 id="get方法">Get方法</h4>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// Get .</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">g</span> <span style="color:#f92672">*</span><span style="color:#75af00">Group</span><span style="color:#111">)</span> <span style="color:#75af00">Get</span><span style="color:#111">(</span><span style="color:#75af00">name</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#75af00">CircuitBreaker</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">m</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">val</span><span style="color:#111">.</span><span style="color:#75af00">Load</span><span style="color:#111">().(</span><span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#00a8c8">string</span><span style="color:#111">]</span><span style="color:#75af00">CircuitBreaker</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">breaker</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">m</span><span style="color:#111">[</span><span style="color:#75af00">name</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#75af00">breaker</span> <span style="color:#75715e">// 很具name从val拿出 breaker 如果存在返回</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// slowpath for group don`t have specified name breaker.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">mutex</span><span style="color:#111">.</span><span style="color:#75af00">Lock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">nm</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#00a8c8">string</span><span style="color:#111">]</span><span style="color:#75af00">CircuitBreaker</span><span style="color:#111">,</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">m</span><span style="color:#111">)</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">k</span><span style="color:#111">,</span> <span style="color:#75af00">v</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">m</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">nm</span><span style="color:#111">[</span><span style="color:#75af00">k</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#75af00">v</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">breaker</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">New</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">nm</span><span style="color:#111">[</span><span style="color:#75af00">name</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#75af00">breaker</span> <span style="color:#75715e">// 如果不存在 生成一个 并放入map 并返回</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">val</span><span style="color:#111">.</span><span style="color:#75af00">Store</span><span style="color:#111">(</span><span style="color:#75af00">nm</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">g</span><span style="color:#111">.</span><span style="color:#75af00">mutex</span><span style="color:#111">.</span><span style="color:#75af00">Unlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">breaker</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="breaker-结构体">Breaker 结构体</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// Breaker is a sre CircuitBreaker pattern.</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Breaker</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75af00">stat</span> <span style="color:#75af00">window</span><span style="color:#111">.</span><span style="color:#75af00">RollingCounter</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75af00">r</span>    <span style="color:#f92672">*</span><span style="color:#75af00">rand</span><span style="color:#111">.</span><span style="color:#75af00">Rand</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75715e">// rand.New(...) returns a non thread safe object</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75af00">randLock</span> <span style="color:#75af00">sync</span><span style="color:#111">.</span><span style="color:#75af00">Mutex</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#75715e">// Reducing the k will make adaptive throttling behave more aggressively,</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75715e">// Increasing the k will make adaptive throttling behave less aggressively.</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75af00">k</span>       <span style="color:#00a8c8">float64</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75af00">request</span> <span style="color:#00a8c8">int64</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#75af00">state</span> <span style="color:#00a8c8">int32</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><ol>
<li>stat
<ul>
<li>滑动窗口，记录成功失败</li>
</ul>
</li>
<li>r
<ul>
<li>随机数</li>
</ul>
</li>
<li>randLock
<ul>
<li>读写锁</li>
</ul>
</li>
<li>k 成功系数
<ul>
<li>total(总数) = success * k</li>
</ul>
</li>
<li>request 请求数
<ul>
<li>当总数 &lt; request时，不判断是否熔断</li>
</ul>
</li>
<li>state
<ul>
<li>熔断器状态 打开或者关闭</li>
</ul>
</li>
</ol>
<h3 id="allow方法">Allow()方法</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// Allow request if error returns nil.</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">b</span> <span style="color:#f92672">*</span><span style="color:#75af00">Breaker</span><span style="color:#111">)</span> <span style="color:#75af00">Allow</span><span style="color:#111">()</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">success</span><span style="color:#111">,</span> <span style="color:#75af00">total</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">summary</span><span style="color:#111">()</span> <span style="color:#75715e">// 从活动窗口获取成功数和总数</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">k</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">k</span> <span style="color:#f92672">*</span> <span style="color:#111">float64</span><span style="color:#111">(</span><span style="color:#75af00">success</span><span style="color:#111">)</span> <span style="color:#75715e">// 根据k成功系数 获取</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// check overflow requests = K * success</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">total</span> <span style="color:#111">&lt;</span> <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">request</span> <span style="color:#f92672">||</span> <span style="color:#111">float64</span><span style="color:#111">(</span><span style="color:#75af00">total</span><span style="color:#111">)</span> <span style="color:#111">&lt;</span> <span style="color:#75af00">k</span> <span style="color:#111">{</span> <span style="color:#75715e">// 如果总数&lt;request 或者  总数 &lt; k </span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">atomic</span><span style="color:#111">.</span><span style="color:#75af00">LoadInt32</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">state</span><span style="color:#111">)</span> <span style="color:#f92672">==</span> <span style="color:#75af00">StateOpen</span> <span style="color:#111">{</span> 
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">atomic</span><span style="color:#111">.</span><span style="color:#75af00">CompareAndSwapInt32</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">state</span><span style="color:#111">,</span> <span style="color:#75af00">StateOpen</span><span style="color:#111">,</span> <span style="color:#75af00">StateClosed</span><span style="color:#111">)</span> <span style="color:#75715e">// 如果state是打开 关闭</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">atomic</span><span style="color:#111">.</span><span style="color:#75af00">LoadInt32</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">state</span><span style="color:#111">)</span> <span style="color:#f92672">==</span> <span style="color:#75af00">StateClosed</span> <span style="color:#111">{</span> 
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">atomic</span><span style="color:#111">.</span><span style="color:#75af00">CompareAndSwapInt32</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">state</span><span style="color:#111">,</span> <span style="color:#75af00">StateClosed</span><span style="color:#111">,</span> <span style="color:#75af00">StateOpen</span><span style="color:#111">)</span> <span style="color:#75715e">// 如果state是关闭 打开</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">dr</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">math</span><span style="color:#111">.</span><span style="color:#75af00">Max</span><span style="color:#111">(</span><span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#111">(</span><span style="color:#111">float64</span><span style="color:#111">(</span><span style="color:#75af00">total</span><span style="color:#111">)</span><span style="color:#f92672">-</span><span style="color:#75af00">k</span><span style="color:#111">)</span><span style="color:#f92672">/</span><span style="color:#111">float64</span><span style="color:#111">(</span><span style="color:#75af00">total</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span><span style="color:#111">))</span> <span style="color:#75715e">// 获取系数，当k越大 dr越小</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">drop</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">trueOnProba</span><span style="color:#111">(</span><span style="color:#75af00">dr</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// trueOnProba 获取水机数</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 返回是否&lt;dr</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">drop</span> <span style="color:#111">{</span> <span style="color:#75715e">// 如果是 拒绝请求</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">circuitbreaker</span><span style="color:#111">.</span><span style="color:#75af00">ErrNotAllowed</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">b</span> <span style="color:#f92672">*</span><span style="color:#75af00">Breaker</span><span style="color:#111">)</span> <span style="color:#75af00">trueOnProba</span><span style="color:#111">(</span><span style="color:#75af00">proba</span> <span style="color:#00a8c8">float64</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#75af00">truth</span> <span style="color:#00a8c8">bool</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">randLock</span><span style="color:#111">.</span><span style="color:#75af00">Lock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">truth</span> <span style="color:#111">=</span> <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">Float64</span><span style="color:#111">()</span> <span style="color:#111">&lt;</span> <span style="color:#75af00">proba</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">randLock</span><span style="color:#111">.</span><span style="color:#75af00">Unlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>使用trueOnProba的原因是，当熔断器关闭时，随机让一部分请求通过，当success越大，请求的通过的数量就越多。用这些数据成功与否，放入窗口统计，当成功数达到要求时，就可以关闭熔断器了。</p>
<h3 id="marksuccess以及markfailed方法">MarkSuccess()以及MarkFailed()方法</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// MarkSuccess mark requeest is success.</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">b</span> <span style="color:#f92672">*</span><span style="color:#75af00">Breaker</span><span style="color:#111">)</span> <span style="color:#75af00">MarkSuccess</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">stat</span><span style="color:#111">.</span><span style="color:#75af00">Add</span><span style="color:#111">(</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span> <span style="color:#75715e">// 成功数+1</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// MarkFailed mark request is failed.</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">b</span> <span style="color:#f92672">*</span><span style="color:#75af00">Breaker</span><span style="color:#111">)</span> <span style="color:#75af00">MarkFailed</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// NOTE: when client reject requets locally, continue add counter let the</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// drop ratio higher.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">stat</span><span style="color:#111">.</span><span style="color:#75af00">Add</span><span style="color:#111">(</span><span style="color:#ae81ff">0</span><span style="color:#111">)</span> <span style="color:#75715e">// 失败数+1</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="流程图">流程图</h2>
<p><img src="/images/304df75e-973a-4a9f-8bcd-c1f5315092b4.png" alt=""></p>
<h2 id="原文地址">原文地址</h2>
<ul>
<li><a href="https://zhaohaiyu.com/posts/microservice/breaker/">https://zhaohaiyu.com/posts/microservice/breaker/</a></li>
</ul>
<hr>
<p><img src="/images/5a7a74d9-0f0f-415c-825a-7da85dcbd4d9.png" alt=""></p>
<p><img src="/images/e3bfa05c-c2aa-4ae9-94b2-a8a12aa4bd7e.gif" alt=""></p>
]]></content:encoded><category>kratos</category><category>go</category><category>kratos</category><category>breaker</category><category>源码分析</category></item><item><title>从kratos分析BBR限流源码实现</title><link>https://daemon365.dev/post/kratos/analyzing_the_implementation_of_bbr_current_limiting_source_code_from_kratos/</link><pubDate>Sat, 04 Sep 2021 00:00:00 +0800</pubDate><guid>https://daemon365.dev/post/kratos/analyzing_the_implementation_of_bbr_current_limiting_source_code_from_kratos/</guid><description>&lt;h2 id="什么是自适应限流"&gt;什么是自适应限流&lt;/h2&gt;
&lt;p&gt;自适应限流从整体维度对应用入口流量进行控制，结合应用的 Load、CPU 使用率、总体平均 RT、入口 QPS 和并发线程数等几个维度的监控指标，通过自适应的流控策略，让系统的入口流量和系统的负载达到一个平衡，让系统尽可能跑在最大吞吐量的同时保证系统整体的稳定性。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;核心目标：&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;自动嗅探负载和 qps，减少人工配置&lt;/li&gt;
&lt;li&gt;削顶，保证超载时系统不被拖垮，并能以高水位 qps 继续运行&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="限流规则"&gt;限流规则&lt;/h2&gt;
&lt;p&gt;&lt;img src="https://daemon365.dev/images/fdc8a49d-6a85-4ad6-b266-994260aa8350.png" alt=""&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;计算吞吐量：利特尔法则 &lt;code&gt;L = λ * W&lt;/code&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;如上图所示，如果我们开一个小店，平均每分钟进店 2 个客人(λ)，每位客人从等待到完成交易需要 4 分钟(W)，那我们店里能承载的客人数量就是 2 * 4 = 8 个人&lt;/p&gt;
&lt;p&gt;同理，我们可以将 &lt;code&gt;λ&lt;/code&gt; 当做 QPS， &lt;code&gt;W&lt;/code&gt; 呢是每个请求需要花费的时间，那我们的系统的吞吐就是 &lt;code&gt;L = λ * W&lt;/code&gt; ，所以我们可以使用利特尔法则来计算系统的吞吐量。&lt;/p&gt;
&lt;h3 id="指标介绍"&gt;指标介绍&lt;/h3&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;指标名称&lt;/th&gt;
&lt;th&gt;指标含义&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;cpu&lt;/td&gt;
&lt;td&gt;最近 1s 的 CPU 使用率均值，使用滑动平均计算，采样周期是 250ms&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;inflight&lt;/td&gt;
&lt;td&gt;当前处理中正在处理的请求数量&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;pass&lt;/td&gt;
&lt;td&gt;请求处理成功的量&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;rt&lt;/td&gt;
&lt;td&gt;请求成功的响应耗时&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h3 id="滑动窗口"&gt;滑动窗口&lt;/h3&gt;
&lt;p&gt;在自适应限流保护中，采集到的指标的时效性非常强，系统只需要采集最近一小段时间内的 qps、rt 即可，对于较老的数据，会自动丢弃。为了实现这个效果，kratos 使用了滑动窗口来保存采样数据。&lt;/p&gt;
&lt;p&gt;&lt;img src="https://daemon365.dev/images/d3cc3465-12f9-4400-bc50-8a7af654570c.png" alt=""&gt;&lt;/p&gt;
&lt;p&gt;如上图，展示了一个具有两个桶（bucket）的滑动窗口（rolling window）。整个滑动窗口用来保存最近 1s 的采样数据，每个小的桶用来保存 500ms 的采样数据。 当时间流动之后，过期的桶会自动被新桶的数据覆盖掉，在图中，在 1000-1500ms 时，bucket 1 的数据因为过期而被丢弃，之后 bucket 3 的数据填到了窗口的头部。&lt;/p&gt;</description><content:encoded><![CDATA[<h2 id="什么是自适应限流">什么是自适应限流</h2>
<p>自适应限流从整体维度对应用入口流量进行控制，结合应用的 Load、CPU 使用率、总体平均 RT、入口 QPS 和并发线程数等几个维度的监控指标，通过自适应的流控策略，让系统的入口流量和系统的负载达到一个平衡，让系统尽可能跑在最大吞吐量的同时保证系统整体的稳定性。</p>
<p><strong>核心目标：</strong></p>
<ul>
<li>自动嗅探负载和 qps，减少人工配置</li>
<li>削顶，保证超载时系统不被拖垮，并能以高水位 qps 继续运行</li>
</ul>
<h2 id="限流规则">限流规则</h2>
<p><img src="/images/fdc8a49d-6a85-4ad6-b266-994260aa8350.png" alt=""></p>
<p><strong>计算吞吐量：利特尔法则 <code>L = λ * W</code></strong></p>
<p>如上图所示，如果我们开一个小店，平均每分钟进店 2 个客人(λ)，每位客人从等待到完成交易需要 4 分钟(W)，那我们店里能承载的客人数量就是 2 * 4 = 8 个人</p>
<p>同理，我们可以将 <code>λ</code> 当做 QPS， <code>W</code> 呢是每个请求需要花费的时间，那我们的系统的吞吐就是 <code>L = λ * W</code> ，所以我们可以使用利特尔法则来计算系统的吞吐量。</p>
<h3 id="指标介绍">指标介绍</h3>
<table>
  <thead>
      <tr>
          <th>指标名称</th>
          <th>指标含义</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>cpu</td>
          <td>最近 1s 的 CPU 使用率均值，使用滑动平均计算，采样周期是 250ms</td>
      </tr>
      <tr>
          <td>inflight</td>
          <td>当前处理中正在处理的请求数量</td>
      </tr>
      <tr>
          <td>pass</td>
          <td>请求处理成功的量</td>
      </tr>
      <tr>
          <td>rt</td>
          <td>请求成功的响应耗时</td>
      </tr>
  </tbody>
</table>
<h3 id="滑动窗口">滑动窗口</h3>
<p>在自适应限流保护中，采集到的指标的时效性非常强，系统只需要采集最近一小段时间内的 qps、rt 即可，对于较老的数据，会自动丢弃。为了实现这个效果，kratos 使用了滑动窗口来保存采样数据。</p>
<p><img src="/images/d3cc3465-12f9-4400-bc50-8a7af654570c.png" alt=""></p>
<p>如上图，展示了一个具有两个桶（bucket）的滑动窗口（rolling window）。整个滑动窗口用来保存最近 1s 的采样数据，每个小的桶用来保存 500ms 的采样数据。 当时间流动之后，过期的桶会自动被新桶的数据覆盖掉，在图中，在 1000-1500ms 时，bucket 1 的数据因为过期而被丢弃，之后 bucket 3 的数据填到了窗口的头部。</p>
<h3 id="限流公式">限流公式</h3>
<p>判断是否丢弃当前请求的算法如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">cpu</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">800</span> <span style="color:#75af00">AND</span> <span style="color:#111">(</span><span style="color:#75af00">Now</span> <span style="color:#f92672">-</span> <span style="color:#75af00">PrevDrop</span><span style="color:#111">)</span> <span style="color:#111">&lt;</span> <span style="color:#ae81ff">1</span><span style="color:#75af00">s</span> <span style="color:#75af00">AND</span> <span style="color:#111">(</span><span style="color:#75af00">MaxPass</span> <span style="color:#f92672">*</span> <span style="color:#75af00">MinRt</span> <span style="color:#f92672">*</span> <span style="color:#75af00">windows</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">1000</span><span style="color:#111">)</span> <span style="color:#111">&lt;</span> <span style="color:#75af00">InFlight</span>
</span></span></code></pre></div><p>MaxPass 表示最近 5s 内，单个采样窗口中最大的请求数。 MinRt 表示最近 5s 内，单个采样窗口中最小的响应时间。 windows 表示一秒内采样窗口的数量，默认配置中是 5s 50 个采样，那么 windows 的值为 10。</p>
<h2 id="源码分析">源码分析</h2>
<h2 id="代码地址">代码地址：</h2>
<ul>
<li><a href="https://github.com/go-kratos/aegis/tree/main/ratelimit/bbr">https://github.com/go-kratos/aegis/tree/main/ratelimit/bbr</a></li>
</ul>
<h3 id="bbr-struct">BBR struct</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">BBR</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">cpu</span>             <span style="color:#75af00">cpuGetter</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">passStat</span>        <span style="color:#75af00">window</span><span style="color:#111">.</span><span style="color:#75af00">RollingCounter</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">rtStat</span>          <span style="color:#75af00">window</span><span style="color:#111">.</span><span style="color:#75af00">RollingCounter</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">inFlight</span>        <span style="color:#00a8c8">int64</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">bucketPerSecond</span> <span style="color:#00a8c8">int64</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">bucketSize</span>      <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Duration</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// prevDropTime defines previous start drop since initTime</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">prevDropTime</span> <span style="color:#75af00">atomic</span><span style="color:#111">.</span><span style="color:#75af00">Value</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">maxPASSCache</span> <span style="color:#75af00">atomic</span><span style="color:#111">.</span><span style="color:#75af00">Value</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">minRtCache</span>   <span style="color:#75af00">atomic</span><span style="color:#111">.</span><span style="color:#75af00">Value</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">opts</span> <span style="color:#f92672">*</span><span style="color:#75af00">options</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><ol>
<li><code>cpu</code>
<ul>
<li>cpu的指标函数，CPU的使用率， 这里为了减小误差，把数字扩大化，乘以1000，比赛使用率60%，也就是0.6 cpu的值就为600</li>
</ul>
</li>
<li><code>passStat</code>
<ul>
<li>请求数的采样数据，使用滑动窗口进行统计</li>
</ul>
</li>
<li><code>rtStat</code>
<ul>
<li>响应时间的采样数据，同样使用滑动窗口进行统计</li>
</ul>
</li>
<li><code>inFlight</code>
<ul>
<li>当前系统中的请求数，数据得来方法是：中间件原理在处理前+1，处理handle之后不管成功失败都减去1</li>
</ul>
</li>
<li><code>bucketPerSecond</code>
<ul>
<li>一个 bucket 的时间</li>
</ul>
</li>
<li><code>bucketSize</code>
<ul>
<li>桶的数量</li>
</ul>
</li>
<li><code>prevDropTime</code>
<ul>
<li>上次触发限流时间</li>
</ul>
</li>
<li><code>maxPASSCache</code>
<ul>
<li>单个采样窗口中最大的请求数的缓存数据</li>
</ul>
</li>
<li><code>minRtCache</code>
<ul>
<li>单个采样窗口中最小的响应时间的缓存数据</li>
</ul>
</li>
</ol>
<h2 id="allow接口">Allow接口</h2>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// Allow checks all inbound traffic.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Once overload is detected, it raises limit.ErrLimitExceed error.</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">l</span> <span style="color:#f92672">*</span><span style="color:#75af00">BBR</span><span style="color:#111">)</span> <span style="color:#75af00">Allow</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#00a8c8">func</span><span style="color:#111">(),</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">l</span><span style="color:#111">.</span><span style="color:#75af00">shouldDrop</span><span style="color:#111">()</span> <span style="color:#111">{</span> <span style="color:#75715e">// shouldDrop 判断是否需要限流，如果true表示拒绝 之后重点讲</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">ErrLimitExceed</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">atomic</span><span style="color:#111">.</span><span style="color:#75af00">AddInt64</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">l</span><span style="color:#111">.</span><span style="color:#75af00">inFlight</span><span style="color:#111">,</span> <span style="color:#ae81ff">1</span><span style="color:#111">)</span> <span style="color:#75715e">// 之前说的，正在处理数+1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">stime</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Since</span><span style="color:#111">(</span><span style="color:#75af00">initTime</span><span style="color:#111">)</span> <span style="color:#75715e">// 现在时间减去程序初始化时间 表示程序开始执行时刻</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#111">{</span> <span style="color:#75715e">// allow返回函数 在中间件（拦截器）中handle执行完成后调用</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">rt</span> <span style="color:#f92672">:=</span> <span style="color:#111">int64</span><span style="color:#111">((</span><span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Since</span><span style="color:#111">(</span><span style="color:#75af00">initTime</span><span style="color:#111">)</span> <span style="color:#f92672">-</span> <span style="color:#75af00">stime</span><span style="color:#111">)</span> <span style="color:#f92672">/</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Millisecond</span><span style="color:#111">)</span>  <span style="color:#75715e">// 执行完handle的时间减去stime 表示 程序执行的总时间 单位ms</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">l</span><span style="color:#111">.</span><span style="color:#75af00">rtStat</span><span style="color:#111">.</span><span style="color:#75af00">Add</span><span style="color:#111">(</span><span style="color:#75af00">rt</span><span style="color:#111">)</span> <span style="color:#75715e">// 把处理时间放进采样数据window</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">atomic</span><span style="color:#111">.</span><span style="color:#75af00">AddInt64</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">l</span><span style="color:#111">.</span><span style="color:#75af00">inFlight</span><span style="color:#111">,</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span> <span style="color:#75715e">// 正在处理数-1 便是处理完成</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">l</span><span style="color:#111">.</span><span style="color:#75af00">passStat</span><span style="color:#111">.</span><span style="color:#75af00">Add</span><span style="color:#111">(</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span> <span style="color:#75715e">// 成功了，把通过数的采样数据window加1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">},</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="shoulddrop方法">shouldDrop方法</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">l</span> <span style="color:#f92672">*</span><span style="color:#75af00">BBR</span><span style="color:#111">)</span> <span style="color:#75af00">shouldDrop</span><span style="color:#111">()</span> <span style="color:#00a8c8">bool</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">curTime</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Since</span><span style="color:#111">(</span><span style="color:#75af00">initTime</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">l</span><span style="color:#111">.</span><span style="color:#75af00">cpu</span><span style="color:#111">()</span> <span style="color:#111">&lt;</span> <span style="color:#75af00">l</span><span style="color:#111">.</span><span style="color:#75af00">opts</span><span style="color:#111">.</span><span style="color:#75af00">CPUThreshold</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// current cpu payload below the threshold</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">prevDropTime</span><span style="color:#111">,</span> <span style="color:#75af00">_</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">l</span><span style="color:#111">.</span><span style="color:#75af00">prevDropTime</span><span style="color:#111">.</span><span style="color:#75af00">Load</span><span style="color:#111">().(</span><span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Duration</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">prevDropTime</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// haven&#39;t start drop,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// accept current request</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">false</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">curTime</span><span style="color:#f92672">-</span><span style="color:#75af00">prevDropTime</span> <span style="color:#f92672">&lt;=</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Second</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// just start drop one second ago,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// check current inflight count</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">inFlight</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">atomic</span><span style="color:#111">.</span><span style="color:#75af00">LoadInt64</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">l</span><span style="color:#111">.</span><span style="color:#75af00">inFlight</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#75af00">inFlight</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">inFlight</span> <span style="color:#111">&gt;</span> <span style="color:#75af00">l</span><span style="color:#111">.</span><span style="color:#75af00">maxInFlight</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">l</span><span style="color:#111">.</span><span style="color:#75af00">prevDropTime</span><span style="color:#111">.</span><span style="color:#75af00">Store</span><span style="color:#111">(</span><span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Duration</span><span style="color:#111">(</span><span style="color:#ae81ff">0</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">false</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// current cpu payload exceeds the threshold</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">inFlight</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">atomic</span><span style="color:#111">.</span><span style="color:#75af00">LoadInt64</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">l</span><span style="color:#111">.</span><span style="color:#75af00">inFlight</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">drop</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">inFlight</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">inFlight</span> <span style="color:#111">&gt;</span> <span style="color:#75af00">l</span><span style="color:#111">.</span><span style="color:#75af00">maxInFlight</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">drop</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">prevDrop</span><span style="color:#111">,</span> <span style="color:#75af00">_</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">l</span><span style="color:#111">.</span><span style="color:#75af00">prevDropTime</span><span style="color:#111">.</span><span style="color:#75af00">Load</span><span style="color:#111">().(</span><span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Duration</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">prevDrop</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// already started drop, return directly</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#75af00">drop</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// store start drop time</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">l</span><span style="color:#111">.</span><span style="color:#75af00">prevDropTime</span><span style="color:#111">.</span><span style="color:#75af00">Store</span><span style="color:#111">(</span><span style="color:#75af00">curTime</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">drop</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p><strong>maxInFlight()方法代表过去的负载</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#111">int64</span><span style="color:#111">(</span><span style="color:#75af00">math</span><span style="color:#111">.</span><span style="color:#75af00">Floor</span><span style="color:#111">(</span><span style="color:#111">float64</span><span style="color:#111">(</span><span style="color:#75af00">l</span><span style="color:#111">.</span><span style="color:#75af00">maxPASS</span><span style="color:#111">()</span><span style="color:#f92672">*</span><span style="color:#75af00">l</span><span style="color:#111">.</span><span style="color:#75af00">minRT</span><span style="color:#111">()</span><span style="color:#f92672">*</span><span style="color:#75af00">l</span><span style="color:#111">.</span><span style="color:#75af00">bucketPerSecond</span><span style="color:#111">)</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1000.0</span><span style="color:#111">)</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0.5</span><span style="color:#111">)</span>
</span></span></code></pre></div><p>参考算法：https://github.com/alibaba/Sentinel/wiki/%E7%B3%BB%E7%BB%9F%E8%87%AA%E9%80%82%E5%BA%94%E9%99%90%E6%B5%81</p>
<ul>
<li>maxPass * bucketPerSecond / 1000 为每毫秒处理的请求数</li>
<li>l.minRT() 为 单个采样窗口中最小的响应时间</li>
<li>T ≈ QPS * Avg(RT)</li>
<li><code> + 0.5</code>为向上取整</li>
</ul>
<h3 id="流程图">流程图</h3>
<p><img src="/images/c13f3623-a858-4322-9695-f1db1a4f85a5.png" alt=""></p>
<h2 id="压测报告">压测报告</h2>
<p>场景1，请求以每秒增加1个的速度不停上升，压测效果如下：</p>
<p><img src="/images/fcae1ea8-da01-470a-823d-ab394851b01a.png" alt=""></p>
<p>左测是没有限流的压测效果，右侧是带限流的压测效果。 可以看到，没有限流的场景里，系统在 700qps 时开始抖动，在 1k qps 时被拖垮，几乎没有新的请求能被放行，然而在使用限流之后，系统请求能够稳定在 600 qps 左右，rt 没有暴增，服务也没有被打垮，可见，限流有效的保护了服务。</p>
<h2 id="原文地址">原文地址：</h2>
<ul>
<li><a href="https://zhaohaiyu.com/posts/microservice/overload/">https://zhaohaiyu.com/posts/microservice/overload/</a></li>
</ul>
<p>参考文章：</p>
<ul>
<li><a href="https://v1.go-kratos.dev/#/ratelimit">https://v1.go-kratos.dev/#/ratelimit</a></li>
<li><a href="https://github.com/alibaba/Sentinel/wiki/%E7%B3%BB%E7%BB%9F%E8%87%AA%E9%80%82%E5%BA%94%E9%99%90%E6%B5%81">https://github.com/alibaba/Sentinel/wiki/%E7%B3%BB%E7%BB%9F%E8%87%AA%E9%80%82%E5%BA%94%E9%99%90%E6%B5%81</a></li>
</ul>
<hr>
<p><img src="/images/f3c8339b-cae8-4cde-9f92-dd68eba61462.png" alt=""></p>
<p><img src="/images/cec35d8f-b7d4-4c38-adb3-1fe46b6c7a1b.gif" alt=""></p>
]]></content:encoded><category>kratos</category><category>go</category><category>kratos</category><category>BBR</category><category>源码分析</category></item><item><title>golang map实现原理</title><link>https://daemon365.dev/post/go/golang_map_implementation_principle/</link><pubDate>Sat, 22 May 2021 00:00:00 +0800</pubDate><guid>https://daemon365.dev/post/go/golang_map_implementation_principle/</guid><description>&lt;p&gt;这篇文章主要讲 map 的赋值、删除、查询、扩容的具体执行过程，仍然是从底层的角度展开。结合源码，看完本文一定会彻底明白 map 底层原理。&lt;/p&gt;
&lt;p&gt;我要说明的是，这里对 map 的基本用法涉及比较少，我相信可以通过阅读其他入门书籍了解。本文的内容比较深入，但是由于我画了各种图，我相信很容易看懂。&lt;/p&gt;
&lt;h2 id="什么是-map"&gt;什么是 map&lt;/h2&gt;
&lt;p&gt;维基百科里这样定义 map：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;In computer science, an associative array, map, symbol table, or dictionary is an abstract data type composed of a collection of (key, value) pairs, such that each possible key appears at most once in the collection.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;简单说明一下：在计算机科学里，被称为相关数组、map、符号表或者字典，是由一组 &lt;code&gt;&amp;lt;key, value&amp;gt;&lt;/code&gt; 对组成的抽象数据结构，并且同一个 key 只会出现一次。&lt;/p&gt;
&lt;p&gt;有两个关键点：map 是由 &lt;code&gt;key-value&lt;/code&gt; 对组成的；&lt;code&gt;key&lt;/code&gt; 只会出现一次。&lt;/p&gt;
&lt;p&gt;和 map 相关的操作主要是：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;增加一个 k-v 对 —— Add or insert；&lt;/li&gt;
&lt;li&gt;删除一个 k-v 对 —— Remove or delete；&lt;/li&gt;
&lt;li&gt;修改某个 k 对应的 v —— Reassign；&lt;/li&gt;
&lt;li&gt;查询某个 k 对应的 v —— Lookup；&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;简单说就是最基本的 &lt;code&gt;增删查改&lt;/code&gt;。&lt;/p&gt;</description><content:encoded><![CDATA[<p>这篇文章主要讲 map 的赋值、删除、查询、扩容的具体执行过程，仍然是从底层的角度展开。结合源码，看完本文一定会彻底明白 map 底层原理。</p>
<p>我要说明的是，这里对 map 的基本用法涉及比较少，我相信可以通过阅读其他入门书籍了解。本文的内容比较深入，但是由于我画了各种图，我相信很容易看懂。</p>
<h2 id="什么是-map">什么是 map</h2>
<p>维基百科里这样定义 map：</p>
<blockquote>
<p>In computer science, an associative array, map, symbol table, or dictionary is an abstract data type composed of a collection of (key, value) pairs, such that each possible key appears at most once in the collection.</p>
</blockquote>
<p>简单说明一下：在计算机科学里，被称为相关数组、map、符号表或者字典，是由一组 <code>&lt;key, value&gt;</code> 对组成的抽象数据结构，并且同一个 key 只会出现一次。</p>
<p>有两个关键点：map 是由 <code>key-value</code> 对组成的；<code>key</code> 只会出现一次。</p>
<p>和 map 相关的操作主要是：</p>
<ol>
<li>增加一个 k-v 对 —— Add or insert；</li>
<li>删除一个 k-v 对 —— Remove or delete；</li>
<li>修改某个 k 对应的 v —— Reassign；</li>
<li>查询某个 k 对应的 v —— Lookup；</li>
</ol>
<p>简单说就是最基本的 <code>增删查改</code>。</p>
<p>map 的设计也被称为 “The dictionary problem”，它的任务是设计一种数据结构用来维护一个集合的数据，并且可以同时对集合进行增删查改的操作。最主要的数据结构有两种：<code>哈希查找表（Hash table）</code>、<code>搜索树（Search tree）</code>。</p>
<p>哈希查找表用一个哈希函数将 key 分配到不同的桶（bucket，也就是数组的不同 index）。这样，开销主要在哈希函数的计算以及数组的常数访问时间。在很多场景下，哈希查找表的性能很高。</p>
<p>哈希查找表一般会存在“碰撞”的问题，就是说不同的 key 被哈希到了同一个 bucket。一般有两种应对方法：<code>链表法</code>和<code>开放地址法</code>。<code>链表法</code>将一个 bucket 实现成一个链表，落在同一个 bucket 中的 key 都会插入这个链表。<code>开放地址法</code>则是碰撞发生后，通过一定的规律，在数组的后面挑选“空位”，用来放置新的 key。</p>
<p>搜索树法一般采用自平衡搜索树，包括：AVL 树，红黑树。面试时经常会被问到，甚至被要求手写红黑树代码，很多时候，面试官自己都写不上来，非常过分。</p>
<p>自平衡搜索树法的最差搜索效率是 O(logN)，而哈希查找表最差是 O(N)。当然，哈希查找表的平均查找效率是 O(1)，如果哈希函数设计的很好，最坏的情况基本不会出现。还有一点，遍历自平衡搜索树，返回的 key 序列，一般会按照从小到大的顺序；而哈希查找表则是乱序的。</p>
<h2 id="为什么要用-map">为什么要用 map</h2>
<p>从 Go 语言官方博客摘录一段话：</p>
<blockquote>
<p>One of the most useful data structures in computer science is the hash table. Many hash table implementations exist with varying properties, but in general they offer fast lookups, adds, and deletes. Go provides a built-in map type that implements a hash table.</p>
</blockquote>
<p>hash table 是计算机数据结构中一个最重要的设计。大部分 hash table 都实现了快速查找、添加、删除的功能。Go 语言内置的 map 实现了上述所有功能。</p>
<p>很难想象写一个程序不使用 map，以至于在回答为什么要用 map 这个问题上犯了难。</p>
<p>所以，到底为什么要用 map 呢？因为它太强大了，各种增删查改的操作效率非常高。</p>
<h2 id="map-的底层如何实现">map 的底层如何实现</h2>
<p>首先声明我用的 Go 版本：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>go version go1.9.2 darwin/amd64
</span></span></code></pre></div><p>前面说了 map 实现的几种方案，Go 语言采用的是哈希查找表，并且使用链表解决哈希冲突。</p>
<p>接下来我们要探索 map 的核心原理，一窥它的内部结构。</p>
<h3 id="map-内存模型">map 内存模型</h3>
<p>在源码中，表示 map 的结构体是 hmap，它是 hashmap 的“缩写”：</p>
<pre tabindex="0"><code>// A header for a Go map.
type hmap struct {
    // 元素个数，调用 len(map) 时，直接返回此值
	count     int
	flags     uint8
	// buckets 的对数 log_2
	B         uint8
	// overflow 的 bucket 近似数
	noverflow uint16
	// 计算 key 的哈希的时候会传入哈希函数
	hash0     uint32
    // 指向 buckets 数组，大小为 2^B
    // 如果元素个数为0，就为 nil
	buckets    unsafe.Pointer
	// 扩容的时候，buckets 长度会是 oldbuckets 的两倍
	oldbuckets unsafe.Pointer
	// 指示扩容进度，小于此地址的 buckets 迁移完成
	nevacuate  uintptr
	extra *mapextra // optional fields
}
</code></pre><p>说明一下，<code>B</code> 是 buckets 数组的长度的对数，也就是说 buckets 数组的长度就是 2^B。bucket 里面存储了 key 和 value，后面会再讲。</p>
<p>buckets 是一个指针，最终它指向的是一个结构体：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">bmap</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">tophash</span> <span style="color:#111">[</span><span style="color:#75af00">bucketCnt</span><span style="color:#111">]</span><span style="color:#00a8c8">uint8</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>但这只是表面(src/runtime/hashmap.go)的结构，编译期间会给它加料，动态地创建一个新的结构：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">bmap</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">topbits</span>  <span style="color:#111">[</span><span style="color:#ae81ff">8</span><span style="color:#111">]</span><span style="color:#00a8c8">uint8</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">keys</span>     <span style="color:#111">[</span><span style="color:#ae81ff">8</span><span style="color:#111">]</span><span style="color:#75af00">keytype</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">values</span>   <span style="color:#111">[</span><span style="color:#ae81ff">8</span><span style="color:#111">]</span><span style="color:#75af00">valuetype</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">pad</span>      <span style="color:#00a8c8">uintptr</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">overflow</span> <span style="color:#00a8c8">uintptr</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p><code>bmap</code> 就是我们常说的“桶”，桶里面会最多装 8 个 key，这些 key 之所以会落入同一个桶，是因为它们经过哈希计算后，哈希结果是“一类”的。在桶内，又会根据 key 计算出来的 hash 值的高 8 位来决定 key 到底落入桶内的哪个位置（一个桶内最多有8个位置）。</p>
<p>来一个整体的图：</p>
<p><img src="/images/bc444966-b890-4be6-b1d8-9d2596d5d4ec.png" alt=""></p>
<p>当 map 的 key 和 value 都不是指针，并且 size 都小于 128 字节的情况下，会把 bmap 标记为不含指针，这样可以避免 gc 时扫描整个 hmap。但是，我们看 bmap 其实有一个 overflow 的字段，是指针类型的，破坏了 bmap 不含指针的设想，这时会把 overflow 移动到 extra 字段来。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">mapextra</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// overflow[0] contains overflow buckets for hmap.buckets.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// overflow[1] contains overflow buckets for hmap.oldbuckets.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">overflow</span> <span style="color:#111">[</span><span style="color:#ae81ff">2</span><span style="color:#111">]</span><span style="color:#f92672">*</span><span style="color:#111">[]</span><span style="color:#f92672">*</span><span style="color:#75af00">bmap</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// nextOverflow 包含空闲的 overflow bucket，这是预分配的 bucket</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">nextOverflow</span> <span style="color:#f92672">*</span><span style="color:#75af00">bmap</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>bmap 是存放 k-v 的地方，我们把视角拉近，仔细看 bmap 的内部组成。</p>
<p><img src="/images/ada04ce4-b4ec-4bb3-8add-e0d192f97184.png" alt=""></p>
<p>上图就是 bucket 的内存模型，<code>HOB Hash</code> 指的就是 top hash。 注意到 key 和 value 是各自放在一起的，并不是 <code>key/value/key/value/...</code> 这样的形式。源码里说明这样的好处是在某些情况下可以省略掉 padding 字段，节省内存空间。</p>
<p>例如，有这样一个类型的 map：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#00a8c8">int64</span><span style="color:#111">]</span><span style="color:#00a8c8">int8</span>
</span></span></code></pre></div><p>如果按照 <code>key/value/key/value/...</code> 这样的模式存储，那在每一个 key/value 对之后都要额外 padding 7 个字节；而将所有的 key，value 分别绑定到一起，这种形式 <code>key/key/.../value/value/...</code>，则只需要在最后添加 padding。</p>
<p>每个 bucket 设计成最多只能放 8 个 key-value 对，如果有第 9 个 key-value 落入当前的 bucket，那就需要再构建一个 bucket ，通过 <code>overflow</code> 指针连接起来。</p>
<h3 id="创建-map">创建 map</h3>
<p>从语法层面上来说，创建 map 很简单：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">ageMp</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#00a8c8">string</span><span style="color:#111">]</span><span style="color:#00a8c8">int</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 指定 map 长度</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">ageMp</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#00a8c8">string</span><span style="color:#111">]</span><span style="color:#00a8c8">int</span><span style="color:#111">,</span> <span style="color:#ae81ff">8</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// ageMp 为 nil，不能向其添加元素，会直接panic</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">var</span> <span style="color:#75af00">ageMp</span> <span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#00a8c8">string</span><span style="color:#111">]</span><span style="color:#00a8c8">int</span>
</span></span></code></pre></div><p>通过汇编语言可以看到，实际上底层调用的是 <code>makemap</code> 函数，主要做的工作就是初始化 <code>hmap</code> 结构体的各种字段，例如计算 B 的大小，设置哈希种子 hash0 等等。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">makemap</span><span style="color:#111">(</span><span style="color:#75af00">t</span> <span style="color:#f92672">*</span><span style="color:#75af00">maptype</span><span style="color:#111">,</span> <span style="color:#75af00">hint</span> <span style="color:#00a8c8">int64</span><span style="color:#111">,</span> <span style="color:#75af00">h</span> <span style="color:#f92672">*</span><span style="color:#75af00">hmap</span><span style="color:#111">,</span> <span style="color:#75af00">bucket</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">)</span> <span style="color:#f92672">*</span><span style="color:#75af00">hmap</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 省略各种条件检查...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 找到一个 B，使得 map 的装载因子在正常范围内</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">B</span> <span style="color:#f92672">:=</span> <span style="color:#111">uint8</span><span style="color:#111">(</span><span style="color:#ae81ff">0</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#111">;</span> <span style="color:#75af00">overLoadFactor</span><span style="color:#111">(</span><span style="color:#75af00">hint</span><span style="color:#111">,</span> <span style="color:#75af00">B</span><span style="color:#111">);</span> <span style="color:#75af00">B</span><span style="color:#f92672">++</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 初始化 hash table</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 如果 B 等于 0，那么 buckets 就会在赋值的时候再分配</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 如果长度比较大，分配内存会花费长一点</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">buckets</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">bucket</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">var</span> <span style="color:#75af00">extra</span> <span style="color:#f92672">*</span><span style="color:#75af00">mapextra</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">B</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">var</span> <span style="color:#75af00">nextOverflow</span> <span style="color:#f92672">*</span><span style="color:#75af00">bmap</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">buckets</span><span style="color:#111">,</span> <span style="color:#75af00">nextOverflow</span> <span style="color:#111">=</span> <span style="color:#75af00">makeBucketArray</span><span style="color:#111">(</span><span style="color:#75af00">t</span><span style="color:#111">,</span> <span style="color:#75af00">B</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">nextOverflow</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">extra</span> <span style="color:#111">=</span> <span style="color:#111">new</span><span style="color:#111">(</span><span style="color:#75af00">mapextra</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">extra</span><span style="color:#111">.</span><span style="color:#75af00">nextOverflow</span> <span style="color:#111">=</span> <span style="color:#75af00">nextOverflow</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 初始化 hamp</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">h</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">h</span> <span style="color:#111">=</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">hmap</span><span style="color:#111">)(</span><span style="color:#75af00">newobject</span><span style="color:#111">(</span><span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">hmap</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">count</span> <span style="color:#111">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">B</span> <span style="color:#111">=</span> <span style="color:#75af00">B</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">extra</span> <span style="color:#111">=</span> <span style="color:#75af00">extra</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">flags</span> <span style="color:#111">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">hash0</span> <span style="color:#111">=</span> <span style="color:#75af00">fastrand</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">buckets</span> <span style="color:#111">=</span> <span style="color:#75af00">buckets</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">oldbuckets</span> <span style="color:#111">=</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">nevacuate</span> <span style="color:#111">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">noverflow</span> <span style="color:#111">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">h</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>注意，这个函数返回的结果：<code>*hmap</code>，它是一个指针，而我们之前讲过的 <code>makeslice</code> 函数返回的是 <code>Slice</code> 结构体：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">makeslice</span><span style="color:#111">(</span><span style="color:#75af00">et</span> <span style="color:#f92672">*</span><span style="color:#75af00">_type</span><span style="color:#111">,</span> <span style="color:#75af00">len</span><span style="color:#111">,</span> <span style="color:#75af00">cap</span> <span style="color:#00a8c8">int</span><span style="color:#111">)</span> <span style="color:#75af00">slice</span>
</span></span></code></pre></div><p>回顾一下 slice 的结构体定义：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// runtime/slice.go</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">slice</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">array</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span> <span style="color:#75715e">// 元素指针</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">len</span>   <span style="color:#00a8c8">int</span> <span style="color:#75715e">// 长度 </span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">cap</span>   <span style="color:#00a8c8">int</span> <span style="color:#75715e">// 容量</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>结构体内部包含底层的数据指针。</p>
<p>makemap 和 makeslice 的区别，带来一个不同点：当 map 和 slice 作为函数参数时，在函数参数内部对 map 的操作会影响 map 自身；而对 slice 却不会（之前讲 slice 的文章里有讲过）。</p>
<p>主要原因：一个是指针（<code>*hmap</code>），一个是结构体（<code>slice</code>）。Go 语言中的函数传参都是值传递，在函数内部，参数会被 copy 到本地。<code>*hmap</code>指针 copy 完之后，仍然指向同一个 map，因此函数内部对 map 的操作会影响实参。而 slice 被 copy 后，会成为一个新的 slice，对它进行的操作不会影响到实参。</p>
<h3 id="哈希函数">哈希函数</h3>
<p>map 的一个关键点在于，哈希函数的选择。在程序启动时，会检测 cpu 是否支持 aes，如果支持，则使用 aes hash，否则使用 memhash。这是在函数 <code>alginit()</code> 中完成，位于路径：<code>src/runtime/alg.go</code> 下。</p>
<blockquote>
<p>hash 函数，有加密型和非加密型。 加密型的一般用于加密数据、数字摘要等，典型代表就是 md5、sha1、sha256、aes256 这种； 非加密型的一般就是查找。在 map 的应用场景中，用的是查找。 选择 hash 函数主要考察的是两点：性能、碰撞概率。</p>
</blockquote>
<p>之前我们讲过，表示类型的结构体：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">_type</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">size</span>       <span style="color:#00a8c8">uintptr</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ptrdata</span>    <span style="color:#00a8c8">uintptr</span> <span style="color:#75715e">// size of memory prefix holding all pointers</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">hash</span>       <span style="color:#00a8c8">uint32</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">tflag</span>      <span style="color:#75af00">tflag</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">align</span>      <span style="color:#00a8c8">uint8</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fieldalign</span> <span style="color:#00a8c8">uint8</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">kind</span>       <span style="color:#00a8c8">uint8</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">alg</span>        <span style="color:#f92672">*</span><span style="color:#75af00">typeAlg</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">gcdata</span>    <span style="color:#f92672">*</span><span style="color:#00a8c8">byte</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">str</span>       <span style="color:#75af00">nameOff</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ptrToThis</span> <span style="color:#75af00">typeOff</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>其中 <code>alg</code> 字段就和哈希相关，它是指向如下结构体的指针：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// src/runtime/alg.go</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">typeAlg</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// (ptr to object, seed) -&gt; hash</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">hash</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">,</span> <span style="color:#00a8c8">uintptr</span><span style="color:#111">)</span> <span style="color:#00a8c8">uintptr</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// (ptr to object A, ptr to object B) -&gt; ==?</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">equal</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">,</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">)</span> <span style="color:#00a8c8">bool</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>typeAlg 包含两个函数，hash 函数计算类型的哈希值，而 equal 函数则计算两个类型是否“哈希相等”。</p>
<p>对于 string 类型，它的 hash、equal 函数如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">strhash</span><span style="color:#111">(</span><span style="color:#75af00">a</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">,</span> <span style="color:#75af00">h</span> <span style="color:#00a8c8">uintptr</span><span style="color:#111">)</span> <span style="color:#00a8c8">uintptr</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">x</span> <span style="color:#f92672">:=</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">stringStruct</span><span style="color:#111">)(</span><span style="color:#75af00">a</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">memhash</span><span style="color:#111">(</span><span style="color:#75af00">x</span><span style="color:#111">.</span><span style="color:#75af00">str</span><span style="color:#111">,</span> <span style="color:#75af00">h</span><span style="color:#111">,</span> <span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">x</span><span style="color:#111">.</span><span style="color:#75af00">len</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">strequal</span><span style="color:#111">(</span><span style="color:#75af00">p</span><span style="color:#111">,</span> <span style="color:#75af00">q</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">)</span> <span style="color:#00a8c8">bool</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#f92672">*</span><span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#00a8c8">string</span><span style="color:#111">)(</span><span style="color:#75af00">p</span><span style="color:#111">)</span> <span style="color:#f92672">==</span> <span style="color:#f92672">*</span><span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#00a8c8">string</span><span style="color:#111">)(</span><span style="color:#75af00">q</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>根据 key 的类型，_type 结构体的 alg 字段会被设置对应类型的 hash 和 equal 函数。</p>
<h3 id="key-定位过程">key 定位过程</h3>
<p>key 经过哈希计算后得到哈希值，共 64 个 bit 位（64位机，32位机就不讨论了，现在主流都是64位机），计算它到底要落在哪个桶时，只会用到最后 B 个 bit 位。还记得前面提到过的 B 吗？如果 B = 5，那么桶的数量，也就是 buckets 数组的长度是 2^5 = 32。</p>
<p>例如，现在有一个 key 经过哈希函数计算后，得到的哈希结果是：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span> <span style="color:#ae81ff">10010111</span> <span style="color:#111">|</span> <span style="color:#ae81ff">000011110110110010001111001010100010010110010101010</span> │ <span style="color:#ae81ff">01010</span>
</span></span></code></pre></div><p>用最后的 5 个 bit 位，也就是 <code>01010</code>，值为 10，也就是 10 号桶。这个操作实际上就是取余操作，但是取余开销太大，所以代码实现上用的位操作代替。</p>
<p>再用哈希值的高 8 位，找到此 key 在 bucket 中的位置，这是在寻找已有的 key。最开始桶内还没有 key，新加入的 key 会找到第一个空位，放入。</p>
<p>buckets 编号就是桶编号，当两个不同的 key 落在同一个桶中，也就是发生了哈希冲突。冲突的解决手段是用链表法：在 bucket 中，从前往后找到第一个空位。这样，在查找某个 key 时，先找到对应的桶，再去遍历 bucket 中的 key。</p>
<p>这里参考曹大 github 博客里的一张图，原图是 ascii 图，geek 味十足，可以从参考资料找到曹大的博客，推荐大家去看看。</p>
<p><img src="/images/f2be4f24-de4f-451a-a8d5-98b3f6b005af.png" alt=""></p>
<p>上图中，假定 B = 5，所以 bucket 总数就是 2^5 = 32。首先计算出待查找 key 的哈希，使用低 5 位 <code>00110</code>，找到对应的 6 号 bucket，使用高 8 位 <code>10010111</code>，对应十进制 151，在 6 号 bucket 中寻找 tophash 值（HOB hash）为 151 的 key，找到了 2 号槽位，这样整个查找过程就结束了。</p>
<p>如果在 bucket 中没找到，并且 overflow 不为空，还要继续去 overflow bucket 中寻找，直到找到或是所有的 key 槽位都找遍了，包括所有的 overflow bucket。</p>
<p>我们来看下源码吧，哈哈！通过汇编语言可以看到，查找某个 key 的底层函数是 <code>mapacess</code> 系列函数，函数的作用类似，区别在下一节会讲到。这里我们直接看 <code>mapacess1</code> 函数：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">mapaccess1</span><span style="color:#111">(</span><span style="color:#75af00">t</span> <span style="color:#f92672">*</span><span style="color:#75af00">maptype</span><span style="color:#111">,</span> <span style="color:#75af00">h</span> <span style="color:#f92672">*</span><span style="color:#75af00">hmap</span><span style="color:#111">,</span> <span style="color:#75af00">key</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">)</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ……</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 如果 h 什么都没有，返回零值</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">h</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#f92672">||</span> <span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">count</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">zeroVal</span><span style="color:#111">[</span><span style="color:#ae81ff">0</span><span style="color:#111">])</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 写和读冲突</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">flags</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">hashWriting</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">throw</span><span style="color:#111">(</span><span style="color:#d88200">&#34;concurrent map read and map write&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 不同类型 key 使用的 hash 算法在编译期确定</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">alg</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">key</span><span style="color:#111">.</span><span style="color:#75af00">alg</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 计算哈希值，并且加入 hash0 引入随机性</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">hash</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">alg</span><span style="color:#111">.</span><span style="color:#75af00">hash</span><span style="color:#111">(</span><span style="color:#75af00">key</span><span style="color:#111">,</span> <span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">hash0</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 比如 B=5，那 m 就是31，二进制是全 1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 求 bucket num 时，将 hash 与 m 相与，</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 达到 bucket num 由 hash 的低 8 位决定的效果</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">m</span> <span style="color:#f92672">:=</span> <span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span><span style="color:#f92672">&lt;&lt;</span><span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">B</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// b 就是 bucket 的地址</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">b</span> <span style="color:#f92672">:=</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">bmap</span><span style="color:#111">)(</span><span style="color:#75af00">add</span><span style="color:#111">(</span><span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">buckets</span><span style="color:#111">,</span> <span style="color:#111">(</span><span style="color:#75af00">hash</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">m</span><span style="color:#111">)</span><span style="color:#f92672">*</span><span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">bucketsize</span><span style="color:#111">)))</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// oldbuckets 不为 nil，说明发生了扩容</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">c</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">oldbuckets</span><span style="color:#111">;</span> <span style="color:#75af00">c</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	    <span style="color:#75715e">// 如果不是同 size 扩容（看后面扩容的内容）</span>
</span></span><span style="display:flex;"><span>	    <span style="color:#75715e">// 对应条件 1 的解决方案</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">sameSizeGrow</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 新 bucket 数量是老的 2 倍</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">m</span> <span style="color:#f92672">&gt;&gt;=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 求出 key 在老的 map 中的 bucket 位置</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">oldb</span> <span style="color:#f92672">:=</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">bmap</span><span style="color:#111">)(</span><span style="color:#75af00">add</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">,</span> <span style="color:#111">(</span><span style="color:#75af00">hash</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">m</span><span style="color:#111">)</span><span style="color:#f92672">*</span><span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">bucketsize</span><span style="color:#111">)))</span>
</span></span><span style="display:flex;"><span>		
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 如果 oldb 没有搬迁到新的 bucket</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 那就在老的 bucket 中寻找</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">evacuated</span><span style="color:#111">(</span><span style="color:#75af00">oldb</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">b</span> <span style="color:#111">=</span> <span style="color:#75af00">oldb</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 计算出高 8 位的 hash</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 相当于右移 56 位，只取高8位</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">top</span> <span style="color:#f92672">:=</span> <span style="color:#111">uint8</span><span style="color:#111">(</span><span style="color:#75af00">hash</span> <span style="color:#f92672">&gt;&gt;</span> <span style="color:#111">(</span><span style="color:#75af00">sys</span><span style="color:#111">.</span><span style="color:#75af00">PtrSize</span><span style="color:#f92672">*</span><span style="color:#ae81ff">8</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">8</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 增加一个 minTopHash</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">top</span> <span style="color:#111">&lt;</span> <span style="color:#75af00">minTopHash</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">top</span> <span style="color:#f92672">+=</span> <span style="color:#75af00">minTopHash</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	    <span style="color:#75715e">// 遍历 8 个 bucket</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">for</span> <span style="color:#75af00">i</span> <span style="color:#f92672">:=</span> <span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#ae81ff">0</span><span style="color:#111">);</span> <span style="color:#75af00">i</span> <span style="color:#111">&lt;</span> <span style="color:#75af00">bucketCnt</span><span style="color:#111">;</span> <span style="color:#75af00">i</span><span style="color:#f92672">++</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		    <span style="color:#75715e">// tophash 不匹配，继续</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">tophash</span><span style="color:#111">[</span><span style="color:#75af00">i</span><span style="color:#111">]</span> <span style="color:#f92672">!=</span> <span style="color:#75af00">top</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">continue</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// tophash 匹配，定位到 key 的位置</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">k</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">add</span><span style="color:#111">(</span><span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">(</span><span style="color:#75af00">b</span><span style="color:#111">),</span> <span style="color:#75af00">dataOffset</span><span style="color:#f92672">+</span><span style="color:#75af00">i</span><span style="color:#f92672">*</span><span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">keysize</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// key 是指针</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">indirectkey</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			    <span style="color:#75715e">// 解引用</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">k</span> <span style="color:#111">=</span> <span style="color:#f92672">*</span><span style="color:#111">((</span><span style="color:#f92672">*</span><span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">)(</span><span style="color:#75af00">k</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 如果 key 相等</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">alg</span><span style="color:#111">.</span><span style="color:#75af00">equal</span><span style="color:#111">(</span><span style="color:#75af00">key</span><span style="color:#111">,</span> <span style="color:#75af00">k</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			    <span style="color:#75715e">// 定位到 value 的位置</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">v</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">add</span><span style="color:#111">(</span><span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">(</span><span style="color:#75af00">b</span><span style="color:#111">),</span> <span style="color:#75af00">dataOffset</span><span style="color:#f92672">+</span><span style="color:#75af00">bucketCnt</span><span style="color:#f92672">*</span><span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">keysize</span><span style="color:#111">)</span><span style="color:#f92672">+</span><span style="color:#75af00">i</span><span style="color:#f92672">*</span><span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">valuesize</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// value 解引用</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">if</span> <span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">indirectvalue</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">v</span> <span style="color:#111">=</span> <span style="color:#f92672">*</span><span style="color:#111">((</span><span style="color:#f92672">*</span><span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">)(</span><span style="color:#75af00">v</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>				<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">return</span> <span style="color:#75af00">v</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// bucket 找完（还没找到），继续到 overflow bucket 里找</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">b</span> <span style="color:#111">=</span> <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">overflow</span><span style="color:#111">(</span><span style="color:#75af00">t</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// overflow bucket 也找完了，说明没有目标 key</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 返回零值</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">b</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">zeroVal</span><span style="color:#111">[</span><span style="color:#ae81ff">0</span><span style="color:#111">])</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>函数返回 h[key] 的指针，如果 h 中没有此 key，那就会返回一个 key 相应类型的零值，不会返回 nil。</p>
<p>代码整体比较直接，没什么难懂的地方。跟着上面的注释一步步理解就好了。</p>
<p>这里，说一下定位 key 和 value 的方法以及整个循环的写法。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// key 定位公式</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">k</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">add</span><span style="color:#111">(</span><span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">(</span><span style="color:#75af00">b</span><span style="color:#111">),</span> <span style="color:#75af00">dataOffset</span><span style="color:#f92672">+</span><span style="color:#75af00">i</span><span style="color:#f92672">*</span><span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">keysize</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// value 定位公式</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">v</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">add</span><span style="color:#111">(</span><span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">(</span><span style="color:#75af00">b</span><span style="color:#111">),</span> <span style="color:#75af00">dataOffset</span><span style="color:#f92672">+</span><span style="color:#75af00">bucketCnt</span><span style="color:#f92672">*</span><span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">keysize</span><span style="color:#111">)</span><span style="color:#f92672">+</span><span style="color:#75af00">i</span><span style="color:#f92672">*</span><span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">valuesize</span><span style="color:#111">))</span>
</span></span></code></pre></div><p>b 是 bmap 的地址，这里 bmap 还是源码里定义的结构体，只包含一个 tophash 数组，经编译器扩充之后的结构体才包含 key，value，overflow 这些字段。dataOffset 是 key 相对于 bmap 起始地址的偏移：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">dataOffset</span> <span style="color:#111">=</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Offsetof</span><span style="color:#111">(</span><span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">b</span> <span style="color:#75af00">bmap</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">v</span> <span style="color:#00a8c8">int64</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}{}.</span><span style="color:#75af00">v</span><span style="color:#111">)</span>
</span></span></code></pre></div><p>因此 bucket 里 key 的起始地址就是 unsafe.Pointer(b)+dataOffset。第 i 个 key 的地址就要在此基础上跨过 i 个 key 的大小；而我们又知道，value 的地址是在所有 key 之后，因此第 i 个 value 的地址还需要加上所有 key 的偏移。理解了这些，上面 key 和 value 的定位公式就很好理解了。</p>
<p>再说整个大循环的写法，最外层是一个无限循环，通过</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">b</span> <span style="color:#111">=</span> <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">overflow</span><span style="color:#111">(</span><span style="color:#75af00">t</span><span style="color:#111">)</span>
</span></span></code></pre></div><p>遍历所有的 bucket，这相当于是一个 bucket 链表。</p>
<p>当定位到一个具体的 bucket 时，里层循环就是遍历这个 bucket 里所有的 cell，或者说所有的槽位，也就是 bucketCnt=8 个槽位。整个循环过程：</p>
<p><img src="/images/a9cc075b-aa24-4fab-8eb4-1061f4264fca.png" alt=""></p>
<p>再说一下 minTopHash，当一个 cell 的 tophash 值小于 minTopHash 时，标志这个 cell 的迁移状态。因为这个状态值是放在 tophash 数组里，为了和正常的哈希值区分开，会给 key 计算出来的哈希值一个增量：minTopHash。这样就能区分正常的 top hash 值和表示状态的哈希值。</p>
<p>下面的这几种状态就表征了 bucket 的情况：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// 空的 cell，也是初始时 bucket 的状态</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">empty</span>          <span style="color:#111">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 空的 cell，表示 cell 已经被迁移到新的 bucket</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">evacuatedEmpty</span> <span style="color:#111">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// key,value 已经搬迁完毕，但是 key 都在新 bucket 前半部分，</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 后面扩容部分会再讲到。</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">evacuatedX</span>     <span style="color:#111">=</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 同上，key 在后半部分</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">evacuatedY</span>     <span style="color:#111">=</span> <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// tophash 的最小正常值</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">minTopHash</span>     <span style="color:#111">=</span> <span style="color:#ae81ff">4</span>
</span></span></code></pre></div><p>源码里判断这个 bucket 是否已经搬迁完毕，用到的函数：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">evacuated</span><span style="color:#111">(</span><span style="color:#75af00">b</span> <span style="color:#f92672">*</span><span style="color:#75af00">bmap</span><span style="color:#111">)</span> <span style="color:#00a8c8">bool</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">h</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">tophash</span><span style="color:#111">[</span><span style="color:#ae81ff">0</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">h</span> <span style="color:#111">&gt;</span> <span style="color:#75af00">empty</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">h</span> <span style="color:#111">&lt;</span> <span style="color:#75af00">minTopHash</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>只取了 tophash 数组的第一个值，判断它是否在 0-4 之间。对比上面的常量，当 top hash 是 <code>evacuatedEmpty</code>、<code>evacuatedX</code>、<code>evacuatedY</code> 这三个值之一，说明此 bucket 中的 key 全部被搬迁到了新 bucket。</p>
<h3 id="map-的两种-get-操作">map 的两种 get 操作</h3>
<p>Go 语言中读取 map 有两种语法：带 comma 和 不带 comma。当要查询的 key 不在 map 里，带 comma 的用法会返回一个 bool 型变量提示 key 是否在 map 中；而不带 comma 的语句则会返回一个 value 类型的零值。如果 value 是 int 型就会返回 0，如果 value 是 string 类型，就会返回空字符串。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ageMap</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#00a8c8">string</span><span style="color:#111">]</span><span style="color:#00a8c8">int</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ageMap</span><span style="color:#111">[</span><span style="color:#d88200">&#34;qcrao&#34;</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#ae81ff">18</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 不带 comma 用法</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">age1</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">ageMap</span><span style="color:#111">[</span><span style="color:#d88200">&#34;stefno&#34;</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">age1</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 带 comma 用法</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">age2</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">ageMap</span><span style="color:#111">[</span><span style="color:#d88200">&#34;stefno&#34;</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">age2</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>运行结果：</p>
<pre tabindex="0"><code>0
0 false
</code></pre><p>以前一直觉得好神奇，怎么实现的？这其实是编译器在背后做的工作：分析代码后，将两种语法对应到底层两个不同的函数。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// src/runtime/hashmap.go</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">mapaccess1</span><span style="color:#111">(</span><span style="color:#75af00">t</span> <span style="color:#f92672">*</span><span style="color:#75af00">maptype</span><span style="color:#111">,</span> <span style="color:#75af00">h</span> <span style="color:#f92672">*</span><span style="color:#75af00">hmap</span><span style="color:#111">,</span> <span style="color:#75af00">key</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">)</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">mapaccess2</span><span style="color:#111">(</span><span style="color:#75af00">t</span> <span style="color:#f92672">*</span><span style="color:#75af00">maptype</span><span style="color:#111">,</span> <span style="color:#75af00">h</span> <span style="color:#f92672">*</span><span style="color:#75af00">hmap</span><span style="color:#111">,</span> <span style="color:#75af00">key</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">,</span> <span style="color:#00a8c8">bool</span><span style="color:#111">)</span>
</span></span></code></pre></div><p>源码里，函数命名不拘小节，直接带上后缀 1，2，完全不理会《代码大全》里的那一套命名的做法。从上面两个函数的声明也可以看出差别了，<code>mapaccess2</code> 函数返回值多了一个 bool 型变量，两者的代码也是完全一样的，只是在返回值后面多加了一个 false 或者 true。</p>
<p>另外，根据 key 的不同类型，编译器还会将查找、插入、删除的函数用更具体的函数替换，以优化效率：</p>
<table>
  <thead>
      <tr>
          <th>key 类型</th>
          <th>查找</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>uint32</td>
          <td>mapaccess1_fast32(t *maptype, h *hmap, key uint32) unsafe.Pointer</td>
      </tr>
      <tr>
          <td>uint32</td>
          <td>mapaccess2_fast32(t *maptype, h *hmap, key uint32) (unsafe.Pointer, bool)</td>
      </tr>
      <tr>
          <td>uint64</td>
          <td>mapaccess1_fast64(t *maptype, h *hmap, key uint64) unsafe.Pointer</td>
      </tr>
      <tr>
          <td>uint64</td>
          <td>mapaccess2_fast64(t *maptype, h *hmap, key uint64) (unsafe.Pointer, bool)</td>
      </tr>
      <tr>
          <td>string</td>
          <td>mapaccess1_faststr(t *maptype, h *hmap, ky string) unsafe.Pointer</td>
      </tr>
      <tr>
          <td>string</td>
          <td>mapaccess2_faststr(t *maptype, h *hmap, ky string) (unsafe.Pointer, bool)</td>
      </tr>
  </tbody>
</table>
<p>这些函数的参数类型直接是具体的 uint32、unt64、string，在函数内部由于提前知晓了 key 的类型，所以内存布局是很清楚的，因此能节省很多操作，提高效率。</p>
<p>上面这些函数都是在文件 <code>src/runtime/hashmap_fast.go</code> 里。</p>
<h3 id="如何进行扩容">如何进行扩容</h3>
<p>使用哈希表的目的就是要快速查找到目标 key，然而，随着向 map 中添加的 key 越来越多，key 发生碰撞的概率也越来越大。bucket 中的 8 个 cell 会被逐渐塞满，查找、插入、删除 key 的效率也会越来越低。最理想的情况是一个 bucket 只装一个 key，这样，就能达到 <code>O(1)</code> 的效率，但这样空间消耗太大，用空间换时间的代价太高。</p>
<p>Go 语言采用一个 bucket 里装载 8 个 key，定位到某个 bucket 后，还需要再定位到具体的 key，这实际上又用了时间换空间。</p>
<p>当然，这样做，要有一个度，不然所有的 key 都落在了同一个 bucket 里，直接退化成了链表，各种操作的效率直接降为 O(n)，是不行的。</p>
<p>因此，需要有一个指标来衡量前面描述的情况，这就是<code>装载因子</code>。Go 源码里这样定义 <code>装载因子</code>：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">loadFactor</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">count</span> <span style="color:#f92672">/</span> <span style="color:#111">(</span><span style="color:#ae81ff">2</span><span style="color:#111">^</span><span style="color:#75af00">B</span><span style="color:#111">)</span>
</span></span></code></pre></div><p>count 就是 map 的元素个数，2^B 表示 bucket 数量。</p>
<p>再来说触发 map 扩容的时机：在向 map 插入新 key 的时候，会进行条件检测，符合下面这 2 个条件，就会触发扩容：</p>
<ol>
<li>装载因子超过阈值，源码里定义的阈值是 6.5。</li>
<li>overflow 的 bucket 数量过多：当 B 小于 15，也就是 bucket 总数 2^B 小于 2^15 时，如果 overflow 的 bucket 数量超过 2^B；当 B &gt;= 15，也就是 bucket 总数 2^B 大于等于 2^15，如果 overflow 的 bucket 数量超过 2^15。</li>
</ol>
<p>通过汇编语言可以找到赋值操作对应源码中的函数是 <code>mapassign</code>，对应扩容条件的源码如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// src/runtime/hashmap.go/mapassign</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 触发扩容时机</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">growing</span><span style="color:#111">()</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#111">(</span><span style="color:#75af00">overLoadFactor</span><span style="color:#111">(</span><span style="color:#111">int64</span><span style="color:#111">(</span><span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">count</span><span style="color:#111">),</span> <span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">B</span><span style="color:#111">)</span> <span style="color:#f92672">||</span> <span style="color:#75af00">tooManyOverflowBuckets</span><span style="color:#111">(</span><span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">noverflow</span><span style="color:#111">,</span> <span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">B</span><span style="color:#111">))</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">hashGrow</span><span style="color:#111">(</span><span style="color:#75af00">t</span><span style="color:#111">,</span> <span style="color:#75af00">h</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 装载因子超过 6.5</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">overLoadFactor</span><span style="color:#111">(</span><span style="color:#75af00">count</span> <span style="color:#00a8c8">int64</span><span style="color:#111">,</span> <span style="color:#75af00">B</span> <span style="color:#00a8c8">uint8</span><span style="color:#111">)</span> <span style="color:#00a8c8">bool</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">count</span> <span style="color:#f92672">&gt;=</span> <span style="color:#75af00">bucketCnt</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#111">float32</span><span style="color:#111">(</span><span style="color:#75af00">count</span><span style="color:#111">)</span> <span style="color:#f92672">&gt;=</span> <span style="color:#75af00">loadFactor</span><span style="color:#f92672">*</span><span style="color:#111">float32</span><span style="color:#111">((</span><span style="color:#111">uint64</span><span style="color:#111">(</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span><span style="color:#f92672">&lt;&lt;</span><span style="color:#75af00">B</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// overflow buckets 太多</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">tooManyOverflowBuckets</span><span style="color:#111">(</span><span style="color:#75af00">noverflow</span> <span style="color:#00a8c8">uint16</span><span style="color:#111">,</span> <span style="color:#75af00">B</span> <span style="color:#00a8c8">uint8</span><span style="color:#111">)</span> <span style="color:#00a8c8">bool</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">B</span> <span style="color:#111">&lt;</span> <span style="color:#ae81ff">16</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">noverflow</span> <span style="color:#f92672">&gt;=</span> <span style="color:#111">uint16</span><span style="color:#111">(</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span><span style="color:#f92672">&lt;&lt;</span><span style="color:#75af00">B</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">noverflow</span> <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">&lt;&lt;</span><span style="color:#ae81ff">15</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>解释一下：</p>
<p>第 1 点：我们知道，每个 bucket 有 8 个空位，在没有溢出，且所有的桶都装满了的情况下，装载因子算出来的结果是 8。因此当装载因子超过 6.5 时，表明很多 bucket 都快要装满了，查找效率和插入效率都变低了。在这个时候进行扩容是有必要的。</p>
<p>第 2 点：是对第 1 点的补充。就是说在装载因子比较小的情况下，这时候 map 的查找和插入效率也很低，而第 1 点识别不出来这种情况。表面现象就是计算装载因子的分子比较小，即 map 里元素总数少，但是 bucket 数量多（真实分配的 bucket 数量多，包括大量的 overflow bucket）。</p>
<p>不难想像造成这种情况的原因：不停地插入、删除元素。先插入很多元素，导致创建了很多 bucket，但是装载因子达不到第 1 点的临界值，未触发扩容来缓解这种情况。之后，删除元素降低元素总数量，再插入很多元素，导致创建很多的 overflow bucket，但就是不会触犯第 1 点的规定，你能拿我怎么办？overflow bucket 数量太多，导致 key 会很分散，查找插入效率低得吓人，因此出台第 2 点规定。这就像是一座空城，房子很多，但是住户很少，都分散了，找起人来很困难。</p>
<p>对于命中条件 1，2 的限制，都会发生扩容。但是扩容的策略并不相同，毕竟两种条件应对的场景不同。</p>
<p>对于条件 1，元素太多，而 bucket 数量太少，很简单：将 B 加 1，bucket 最大数量（2^B）直接变成原来 bucket 数量的 2 倍。于是，就有新老 bucket 了。注意，这时候元素都在老 bucket 里，还没迁移到新的 bucket 来。而且，新 bucket 只是最大数量变为原来最大数量（2^B）的 2 倍（2^B * 2）。</p>
<p>对于条件 2，其实元素没那么多，但是 overflow bucket 数特别多，说明很多 bucket 都没装满。解决办法就是开辟一个新 bucket 空间，将老 bucket 中的元素移动到新 bucket，使得同一个 bucket 中的 key 排列地更紧密。这样，原来，在 overflow bucket 中的 key 可以移动到 bucket 中来。结果是节省空间，提高 bucket 利用率，map 的查找和插入效率自然就会提升。</p>
<p>对于条件 2 的解决方案，曹大的博客里还提出了一个极端的情况：如果插入 map 的 key 哈希都一样，就会落到同一个 bucket 里，超过 8 个就会产生 overflow bucket，结果也会造成 overflow bucket 数过多。移动元素其实解决不了问题，因为这时整个哈希表已经退化成了一个链表，操作效率变成了 <code>O(n)</code>。</p>
<p>再来看一下扩容具体是怎么做的。由于 map 扩容需要将原有的 key/value 重新搬迁到新的内存地址，如果有大量的 key/value 需要搬迁，会非常影响性能。因此 Go map 的扩容采取了一种称为“渐进式”地方式，原有的 key 并不会一次性搬迁完毕，每次最多只会搬迁 2 个 bucket。</p>
<p>上面说的 <code>hashGrow()</code> 函数实际上并没有真正地“搬迁”，它只是分配好了新的 buckets，并将老的 buckets 挂到了 oldbuckets 字段上。真正搬迁 buckets 的动作在 <code>growWork()</code> 函数中，而调用 <code>growWork()</code> 函数的动作是在 mapassign 和 mapdelete 函数中。也就是插入或修改、删除 key 的时候，都会尝试进行搬迁 buckets 的工作。先检查 oldbuckets 是否搬迁完毕，具体来说就是检查 oldbuckets 是否为 nil。</p>
<p>我们先看 <code>hashGrow()</code> 函数所做的工作，再来看具体的搬迁 buckets 是如何进行的。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">hashGrow</span><span style="color:#111">(</span><span style="color:#75af00">t</span> <span style="color:#f92672">*</span><span style="color:#75af00">maptype</span><span style="color:#111">,</span> <span style="color:#75af00">h</span> <span style="color:#f92672">*</span><span style="color:#75af00">hmap</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// B+1 相当于是原来 2 倍的空间</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">bigger</span> <span style="color:#f92672">:=</span> <span style="color:#111">uint8</span><span style="color:#111">(</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 对应条件 2</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">overLoadFactor</span><span style="color:#111">(</span><span style="color:#111">int64</span><span style="color:#111">(</span><span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">count</span><span style="color:#111">),</span> <span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">B</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 进行等量的内存扩容，所以 B 不变</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">bigger</span> <span style="color:#111">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">flags</span> <span style="color:#f92672">|=</span> <span style="color:#75af00">sameSizeGrow</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 将老 buckets 挂到 buckets 上</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">oldbuckets</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">buckets</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 申请新的 buckets 空间</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">newbuckets</span><span style="color:#111">,</span> <span style="color:#75af00">nextOverflow</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">makeBucketArray</span><span style="color:#111">(</span><span style="color:#75af00">t</span><span style="color:#111">,</span> <span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">B</span><span style="color:#f92672">+</span><span style="color:#75af00">bigger</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">flags</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">flags</span> <span style="color:#f92672">&amp;^</span> <span style="color:#111">(</span><span style="color:#75af00">iterator</span> <span style="color:#111">|</span> <span style="color:#75af00">oldIterator</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">flags</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">iterator</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">flags</span> <span style="color:#f92672">|=</span> <span style="color:#75af00">oldIterator</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 提交 grow 的动作</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">B</span> <span style="color:#f92672">+=</span> <span style="color:#75af00">bigger</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">flags</span> <span style="color:#111">=</span> <span style="color:#75af00">flags</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">oldbuckets</span> <span style="color:#111">=</span> <span style="color:#75af00">oldbuckets</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">buckets</span> <span style="color:#111">=</span> <span style="color:#75af00">newbuckets</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 搬迁进度为 0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">nevacuate</span> <span style="color:#111">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// overflow buckets 数为 0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">noverflow</span> <span style="color:#111">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ……</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>主要是申请到了新的 buckets 空间，把相关的标志位都进行了处理：例如标志 nevacuate 被置为 0， 表示当前搬迁进度为 0。</p>
<p>值得一说的是对 <code>h.flags</code> 的处理：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">flags</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">flags</span> <span style="color:#f92672">&amp;^</span> <span style="color:#111">(</span><span style="color:#75af00">iterator</span> <span style="color:#111">|</span> <span style="color:#75af00">oldIterator</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">flags</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">iterator</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">flags</span> <span style="color:#f92672">|=</span> <span style="color:#75af00">oldIterator</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>这里得先说下运算符：&amp;^。这叫<code>按位置 0</code>运算符。例如：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">x</span> <span style="color:#111">=</span> <span style="color:#ae81ff">01010011</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">y</span> <span style="color:#111">=</span> <span style="color:#ae81ff">01010100</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">z</span> <span style="color:#111">=</span> <span style="color:#75af00">x</span> <span style="color:#f92672">&amp;^</span> <span style="color:#75af00">y</span> <span style="color:#111">=</span> <span style="color:#ae81ff">00000011</span>
</span></span></code></pre></div><p>如果 y bit 位为 1，那么结果 z 对应 bit 位就为 0，否则 z 对应 bit 位就和 x 对应 bit 位的值相同。</p>
<p>所以上面那段对 flags 一顿操作的代码的意思是：先把 h.flags 中 iterator 和 oldIterator 对应位清 0，然后如果发现 iterator 位为 1，那就把它转接到 oldIterator 位，使得 oldIterator 标志位变成 1。潜台词就是：buckets 现在挂到了 oldBuckets 名下了，对应的标志位也转接过去吧。</p>
<p>几个标志位如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// 可能有迭代器使用 buckets</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">iterator</span>     <span style="color:#111">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 可能有迭代器使用 oldbuckets</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">oldIterator</span>  <span style="color:#111">=</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 有协程正在向 map 中写入 key</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">hashWriting</span>  <span style="color:#111">=</span> <span style="color:#ae81ff">4</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 等量扩容（对应条件 2）</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">sameSizeGrow</span> <span style="color:#111">=</span> <span style="color:#ae81ff">8</span>
</span></span></code></pre></div><p>再来看看真正执行搬迁工作的 growWork() 函数。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">growWork</span><span style="color:#111">(</span><span style="color:#75af00">t</span> <span style="color:#f92672">*</span><span style="color:#75af00">maptype</span><span style="color:#111">,</span> <span style="color:#75af00">h</span> <span style="color:#f92672">*</span><span style="color:#75af00">hmap</span><span style="color:#111">,</span> <span style="color:#75af00">bucket</span> <span style="color:#00a8c8">uintptr</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 确认搬迁老的 bucket 对应正在使用的 bucket</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">evacuate</span><span style="color:#111">(</span><span style="color:#75af00">t</span><span style="color:#111">,</span> <span style="color:#75af00">h</span><span style="color:#111">,</span> <span style="color:#75af00">bucket</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">oldbucketmask</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 再搬迁一个 bucket，以加快搬迁进程</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">growing</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">evacuate</span><span style="color:#111">(</span><span style="color:#75af00">t</span><span style="color:#111">,</span> <span style="color:#75af00">h</span><span style="color:#111">,</span> <span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">nevacuate</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>h.growing() 函数非常简单：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">h</span> <span style="color:#f92672">*</span><span style="color:#75af00">hmap</span><span style="color:#111">)</span> <span style="color:#75af00">growing</span><span style="color:#111">()</span> <span style="color:#00a8c8">bool</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">oldbuckets</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>如果 <code>oldbuckets</code> 不为空，说明还没有搬迁完毕，还得继续搬。</p>
<p><code>bucket&amp;h.oldbucketmask()</code> 这行代码，如源码注释里说的，是为了确认搬迁的 bucket 是我们正在使用的 bucket。<code>oldbucketmask()</code> 函数返回扩容前的 map 的 bucketmask。</p>
<p>所谓的 bucketmask，作用就是将 key 计算出来的哈希值与 bucketmask 相与，得到的结果就是 key 应该落入的桶。比如 B = 5，那么 bucketmask 的低 5 位是 <code>11111</code>，其余位是 <code>0</code>，hash 值与其相与的意思是，只有 hash 值的低 5 位决策 key 到底落入哪个 bucket。</p>
<p>接下来，我们集中所有的精力在搬迁的关键函数 evacuate。源码贴在下面，不要紧张，我会加上大面积的注释，通过注释绝对是能看懂的。之后，我会再对搬迁过程作详细说明。</p>
<p>源码如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">evacuate</span><span style="color:#111">(</span><span style="color:#75af00">t</span> <span style="color:#f92672">*</span><span style="color:#75af00">maptype</span><span style="color:#111">,</span> <span style="color:#75af00">h</span> <span style="color:#f92672">*</span><span style="color:#75af00">hmap</span><span style="color:#111">,</span> <span style="color:#75af00">oldbucket</span> <span style="color:#00a8c8">uintptr</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 定位老的 bucket 地址</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">b</span> <span style="color:#f92672">:=</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">bmap</span><span style="color:#111">)(</span><span style="color:#75af00">add</span><span style="color:#111">(</span><span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">oldbuckets</span><span style="color:#111">,</span> <span style="color:#75af00">oldbucket</span><span style="color:#f92672">*</span><span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">bucketsize</span><span style="color:#111">)))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 结果是 2^B，如 B = 5，结果为32</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">newbit</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">noldbuckets</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// key 的哈希函数</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">alg</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">key</span><span style="color:#111">.</span><span style="color:#75af00">alg</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 如果 b 没有被搬迁过</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">evacuated</span><span style="color:#111">(</span><span style="color:#75af00">b</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">var</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 表示bucket 移动的目标地址</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">x</span><span style="color:#111">,</span> <span style="color:#75af00">y</span>   <span style="color:#f92672">*</span><span style="color:#75af00">bmap</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 指向 x,y 中的 key/val</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">xi</span><span style="color:#111">,</span> <span style="color:#75af00">yi</span> <span style="color:#00a8c8">int</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 指向 x，y 中的 key</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">xk</span><span style="color:#111">,</span> <span style="color:#75af00">yk</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 指向 x，y 中的 value</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">xv</span><span style="color:#111">,</span> <span style="color:#75af00">yv</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 默认是等 size 扩容，前后 bucket 序号不变</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 使用 x 来进行搬迁</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">x</span> <span style="color:#111">=</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">bmap</span><span style="color:#111">)(</span><span style="color:#75af00">add</span><span style="color:#111">(</span><span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">buckets</span><span style="color:#111">,</span> <span style="color:#75af00">oldbucket</span><span style="color:#f92672">*</span><span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">bucketsize</span><span style="color:#111">)))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">xi</span> <span style="color:#111">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">xk</span> <span style="color:#111">=</span> <span style="color:#75af00">add</span><span style="color:#111">(</span><span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">(</span><span style="color:#75af00">x</span><span style="color:#111">),</span> <span style="color:#75af00">dataOffset</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">xv</span> <span style="color:#111">=</span> <span style="color:#75af00">add</span><span style="color:#111">(</span><span style="color:#75af00">xk</span><span style="color:#111">,</span> <span style="color:#75af00">bucketCnt</span><span style="color:#f92672">*</span><span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">keysize</span><span style="color:#111">))</span><span style="color:#960050;background-color:#1e0010">、</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 如果不是等 size 扩容，前后 bucket 序号有变</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 使用 y 来进行搬迁</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">sameSizeGrow</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// y 代表的 bucket 序号增加了 2^B</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">y</span> <span style="color:#111">=</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">bmap</span><span style="color:#111">)(</span><span style="color:#75af00">add</span><span style="color:#111">(</span><span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">buckets</span><span style="color:#111">,</span> <span style="color:#111">(</span><span style="color:#75af00">oldbucket</span><span style="color:#f92672">+</span><span style="color:#75af00">newbit</span><span style="color:#111">)</span><span style="color:#f92672">*</span><span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">bucketsize</span><span style="color:#111">)))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">yi</span> <span style="color:#111">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">yk</span> <span style="color:#111">=</span> <span style="color:#75af00">add</span><span style="color:#111">(</span><span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">(</span><span style="color:#75af00">y</span><span style="color:#111">),</span> <span style="color:#75af00">dataOffset</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">yv</span> <span style="color:#111">=</span> <span style="color:#75af00">add</span><span style="color:#111">(</span><span style="color:#75af00">yk</span><span style="color:#111">,</span> <span style="color:#75af00">bucketCnt</span><span style="color:#f92672">*</span><span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">keysize</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 遍历所有的 bucket，包括 overflow buckets</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// b 是老的 bucket 地址</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">for</span> <span style="color:#111">;</span> <span style="color:#75af00">b</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span><span style="color:#111">;</span> <span style="color:#75af00">b</span> <span style="color:#111">=</span> <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">overflow</span><span style="color:#111">(</span><span style="color:#75af00">t</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">k</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">add</span><span style="color:#111">(</span><span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">(</span><span style="color:#75af00">b</span><span style="color:#111">),</span> <span style="color:#75af00">dataOffset</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">v</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">add</span><span style="color:#111">(</span><span style="color:#75af00">k</span><span style="color:#111">,</span> <span style="color:#75af00">bucketCnt</span><span style="color:#f92672">*</span><span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">keysize</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 遍历 bucket 中的所有 cell</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">for</span> <span style="color:#75af00">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span><span style="color:#111">;</span> <span style="color:#75af00">i</span> <span style="color:#111">&lt;</span> <span style="color:#75af00">bucketCnt</span><span style="color:#111">;</span> <span style="color:#75af00">i</span><span style="color:#111">,</span> <span style="color:#75af00">k</span><span style="color:#111">,</span> <span style="color:#75af00">v</span> <span style="color:#111">=</span> <span style="color:#75af00">i</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span><span style="color:#111">,</span> <span style="color:#75af00">add</span><span style="color:#111">(</span><span style="color:#75af00">k</span><span style="color:#111">,</span> <span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">keysize</span><span style="color:#111">)),</span> <span style="color:#75af00">add</span><span style="color:#111">(</span><span style="color:#75af00">v</span><span style="color:#111">,</span> <span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">valuesize</span><span style="color:#111">))</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// 当前 cell 的 top hash 值</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">top</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">tophash</span><span style="color:#111">[</span><span style="color:#75af00">i</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// 如果 cell 为空，即没有 key</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">if</span> <span style="color:#75af00">top</span> <span style="color:#f92672">==</span> <span style="color:#75af00">empty</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75715e">// 那就标志它被&#34;搬迁&#34;过</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">tophash</span><span style="color:#111">[</span><span style="color:#75af00">i</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#75af00">evacuatedEmpty</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75715e">// 继续下个 cell</span>
</span></span><span style="display:flex;"><span>					<span style="color:#00a8c8">continue</span>
</span></span><span style="display:flex;"><span>				<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// 正常不会出现这种情况</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// 未被搬迁的 cell 只可能是 empty 或是</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// 正常的 top hash（大于 minTopHash）</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">if</span> <span style="color:#75af00">top</span> <span style="color:#111">&lt;</span> <span style="color:#75af00">minTopHash</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">throw</span><span style="color:#111">(</span><span style="color:#d88200">&#34;bad map state&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">k2</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">k</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// 如果 key 是指针，则解引用</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">if</span> <span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">indirectkey</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">k2</span> <span style="color:#111">=</span> <span style="color:#f92672">*</span><span style="color:#111">((</span><span style="color:#f92672">*</span><span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">)(</span><span style="color:#75af00">k2</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>				<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// 默认使用 X，等量扩容</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">useX</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">true</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// 如果不是等量扩容</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">sameSizeGrow</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75715e">// 计算 hash 值，和 key 第一次写入时一样</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">hash</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">alg</span><span style="color:#111">.</span><span style="color:#75af00">hash</span><span style="color:#111">(</span><span style="color:#75af00">k2</span><span style="color:#111">,</span> <span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">hash0</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>					<span style="color:#75715e">// 如果有协程正在遍历 map</span>
</span></span><span style="display:flex;"><span>					<span style="color:#00a8c8">if</span> <span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">flags</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">iterator</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>						<span style="color:#75715e">// 如果出现 相同的 key 值，算出来的 hash 值不同</span>
</span></span><span style="display:flex;"><span>						<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">reflexivekey</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#111">!</span><span style="color:#75af00">alg</span><span style="color:#111">.</span><span style="color:#75af00">equal</span><span style="color:#111">(</span><span style="color:#75af00">k2</span><span style="color:#111">,</span> <span style="color:#75af00">k2</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>							<span style="color:#75715e">// 只有在 float 变量的 NaN() 情况下会出现</span>
</span></span><span style="display:flex;"><span>							<span style="color:#00a8c8">if</span> <span style="color:#75af00">top</span><span style="color:#f92672">&amp;</span><span style="color:#ae81ff">1</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>								<span style="color:#75715e">// 第 B 位置 1</span>
</span></span><span style="display:flex;"><span>								<span style="color:#75af00">hash</span> <span style="color:#f92672">|=</span> <span style="color:#75af00">newbit</span>
</span></span><span style="display:flex;"><span>							<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>								<span style="color:#75715e">// 第 B 位置 0</span>
</span></span><span style="display:flex;"><span>								<span style="color:#75af00">hash</span> <span style="color:#f92672">&amp;^=</span> <span style="color:#75af00">newbit</span>
</span></span><span style="display:flex;"><span>							<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>							<span style="color:#75715e">// 取高 8 位作为 top hash 值</span>
</span></span><span style="display:flex;"><span>							<span style="color:#75af00">top</span> <span style="color:#111">=</span> <span style="color:#111">uint8</span><span style="color:#111">(</span><span style="color:#75af00">hash</span> <span style="color:#f92672">&gt;&gt;</span> <span style="color:#111">(</span><span style="color:#75af00">sys</span><span style="color:#111">.</span><span style="color:#75af00">PtrSize</span><span style="color:#f92672">*</span><span style="color:#ae81ff">8</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">8</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>							<span style="color:#00a8c8">if</span> <span style="color:#75af00">top</span> <span style="color:#111">&lt;</span> <span style="color:#75af00">minTopHash</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>								<span style="color:#75af00">top</span> <span style="color:#f92672">+=</span> <span style="color:#75af00">minTopHash</span>
</span></span><span style="display:flex;"><span>							<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>						<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>					<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>					<span style="color:#75715e">// 取决于新哈希值的 oldB+1 位是 0 还是 1</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75715e">// 详细看后面的文章</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">useX</span> <span style="color:#111">=</span> <span style="color:#75af00">hash</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">newbit</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>				<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// 如果 key 搬到 X 部分</span>
</span></span><span style="display:flex;"><span>				<span style="color:#00a8c8">if</span> <span style="color:#75af00">useX</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75715e">// 标志老的 cell 的 top hash 值，表示搬移到 X 部分</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">tophash</span><span style="color:#111">[</span><span style="color:#75af00">i</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#75af00">evacuatedX</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75715e">// 如果 xi 等于 8，说明要溢出了</span>
</span></span><span style="display:flex;"><span>					<span style="color:#00a8c8">if</span> <span style="color:#75af00">xi</span> <span style="color:#f92672">==</span> <span style="color:#75af00">bucketCnt</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>						<span style="color:#75715e">// 新建一个 bucket</span>
</span></span><span style="display:flex;"><span>						<span style="color:#75af00">newx</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">newoverflow</span><span style="color:#111">(</span><span style="color:#75af00">t</span><span style="color:#111">,</span> <span style="color:#75af00">x</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>						<span style="color:#75af00">x</span> <span style="color:#111">=</span> <span style="color:#75af00">newx</span>
</span></span><span style="display:flex;"><span>						<span style="color:#75715e">// xi 从 0 开始计数</span>
</span></span><span style="display:flex;"><span>						<span style="color:#75af00">xi</span> <span style="color:#111">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>						<span style="color:#75715e">// xk 表示 key 要移动到的位置</span>
</span></span><span style="display:flex;"><span>						<span style="color:#75af00">xk</span> <span style="color:#111">=</span> <span style="color:#75af00">add</span><span style="color:#111">(</span><span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">(</span><span style="color:#75af00">x</span><span style="color:#111">),</span> <span style="color:#75af00">dataOffset</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>						<span style="color:#75715e">// xv 表示 value 要移动到的位置</span>
</span></span><span style="display:flex;"><span>						<span style="color:#75af00">xv</span> <span style="color:#111">=</span> <span style="color:#75af00">add</span><span style="color:#111">(</span><span style="color:#75af00">xk</span><span style="color:#111">,</span> <span style="color:#75af00">bucketCnt</span><span style="color:#f92672">*</span><span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">keysize</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>					<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75715e">// 设置 top hash 值</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">x</span><span style="color:#111">.</span><span style="color:#75af00">tophash</span><span style="color:#111">[</span><span style="color:#75af00">xi</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#75af00">top</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75715e">// key 是指针</span>
</span></span><span style="display:flex;"><span>					<span style="color:#00a8c8">if</span> <span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">indirectkey</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>						<span style="color:#75715e">// 将原 key（是指针）复制到新位置</span>
</span></span><span style="display:flex;"><span>						<span style="color:#f92672">*</span><span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">)(</span><span style="color:#75af00">xk</span><span style="color:#111">)</span> <span style="color:#111">=</span> <span style="color:#75af00">k2</span> <span style="color:#75715e">// copy pointer</span>
</span></span><span style="display:flex;"><span>					<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>						<span style="color:#75715e">// 将原 key（是值）复制到新位置</span>
</span></span><span style="display:flex;"><span>						<span style="color:#75af00">typedmemmove</span><span style="color:#111">(</span><span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">key</span><span style="color:#111">,</span> <span style="color:#75af00">xk</span><span style="color:#111">,</span> <span style="color:#75af00">k</span><span style="color:#111">)</span> <span style="color:#75715e">// copy value</span>
</span></span><span style="display:flex;"><span>					<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75715e">// value 是指针，操作同 key</span>
</span></span><span style="display:flex;"><span>					<span style="color:#00a8c8">if</span> <span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">indirectvalue</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>						<span style="color:#f92672">*</span><span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">)(</span><span style="color:#75af00">xv</span><span style="color:#111">)</span> <span style="color:#111">=</span> <span style="color:#f92672">*</span><span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">)(</span><span style="color:#75af00">v</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>					<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>						<span style="color:#75af00">typedmemmove</span><span style="color:#111">(</span><span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">elem</span><span style="color:#111">,</span> <span style="color:#75af00">xv</span><span style="color:#111">,</span> <span style="color:#75af00">v</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>					<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>					<span style="color:#75715e">// 定位到下一个 cell</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">xi</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">xk</span> <span style="color:#111">=</span> <span style="color:#75af00">add</span><span style="color:#111">(</span><span style="color:#75af00">xk</span><span style="color:#111">,</span> <span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">keysize</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75af00">xv</span> <span style="color:#111">=</span> <span style="color:#75af00">add</span><span style="color:#111">(</span><span style="color:#75af00">xv</span><span style="color:#111">,</span> <span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">valuesize</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>				<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span> <span style="color:#75715e">// key 搬到 Y 部分，操作同 X 部分</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75715e">// ……</span>
</span></span><span style="display:flex;"><span>					<span style="color:#75715e">// 省略了这部分，操作和 X 部分相同</span>
</span></span><span style="display:flex;"><span>				<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 如果没有协程在使用老的 buckets，就把老 buckets 清除掉，帮助gc</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">flags</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">oldIterator</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">b</span> <span style="color:#111">=</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">bmap</span><span style="color:#111">)(</span><span style="color:#75af00">add</span><span style="color:#111">(</span><span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">oldbuckets</span><span style="color:#111">,</span> <span style="color:#75af00">oldbucket</span><span style="color:#f92672">*</span><span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">bucketsize</span><span style="color:#111">)))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 只清除bucket 的 key,value 部分，保留 top hash 部分，指示搬迁状态</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">bucket</span><span style="color:#111">.</span><span style="color:#75af00">kind</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">kindNoPointers</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">memclrHasPointers</span><span style="color:#111">(</span><span style="color:#75af00">add</span><span style="color:#111">(</span><span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">(</span><span style="color:#75af00">b</span><span style="color:#111">),</span> <span style="color:#75af00">dataOffset</span><span style="color:#111">),</span> <span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">bucketsize</span><span style="color:#111">)</span><span style="color:#f92672">-</span><span style="color:#75af00">dataOffset</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">memclrNoHeapPointers</span><span style="color:#111">(</span><span style="color:#75af00">add</span><span style="color:#111">(</span><span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">(</span><span style="color:#75af00">b</span><span style="color:#111">),</span> <span style="color:#75af00">dataOffset</span><span style="color:#111">),</span> <span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">bucketsize</span><span style="color:#111">)</span><span style="color:#f92672">-</span><span style="color:#75af00">dataOffset</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 更新搬迁进度</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 如果此次搬迁的 bucket 等于当前进度</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">oldbucket</span> <span style="color:#f92672">==</span> <span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">nevacuate</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 进度加 1</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">nevacuate</span> <span style="color:#111">=</span> <span style="color:#75af00">oldbucket</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Experiments suggest that 1024 is overkill by at least an order of magnitude.</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Put it in there as a safeguard anyway, to ensure O(1) behavior.</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 尝试往后看 1024 个 bucket</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">stop</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">nevacuate</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1024</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">stop</span> <span style="color:#111">&gt;</span> <span style="color:#75af00">newbit</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">stop</span> <span style="color:#111">=</span> <span style="color:#75af00">newbit</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 寻找没有搬迁的 bucket</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">for</span> <span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">nevacuate</span> <span style="color:#f92672">!=</span> <span style="color:#75af00">stop</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">bucketEvacuated</span><span style="color:#111">(</span><span style="color:#75af00">t</span><span style="color:#111">,</span> <span style="color:#75af00">h</span><span style="color:#111">,</span> <span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">nevacuate</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">nevacuate</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 现在 h.nevacuate 之前的 bucket 都被搬迁完毕</span>
</span></span><span style="display:flex;"><span>		
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 所有的 buckets 搬迁完毕</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">nevacuate</span> <span style="color:#f92672">==</span> <span style="color:#75af00">newbit</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 清除老的 buckets</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">oldbuckets</span> <span style="color:#111">=</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 清除老的 overflow bucket</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 回忆一下：[0] 表示当前 overflow bucket</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// [1] 表示 old overflow bucket</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">if</span> <span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">extra</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">extra</span><span style="color:#111">.</span><span style="color:#75af00">overflow</span><span style="color:#111">[</span><span style="color:#ae81ff">1</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 清除正在扩容的标志位</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">flags</span> <span style="color:#f92672">&amp;^=</span> <span style="color:#75af00">sameSizeGrow</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>evacuate 函数的代码注释非常清晰，对着代码和注释是很容易看懂整个的搬迁过程的，耐心点。</p>
<p>搬迁的目的就是将老的 buckets 搬迁到新的 buckets。而通过前面的说明我们知道，应对条件 1，新的 buckets 数量是之前的一倍，应对条件 2，新的 buckets 数量和之前相等。</p>
<p>对于条件 1，从老的 buckets 搬迁到新的 buckets，由于 bucktes 数量不变，因此可以按序号来搬，比如原来在 0 号 bucktes，到新的地方后，仍然放在 0 号 buckets。</p>
<p>对于条件 2，就没这么简单了。要重新计算 key 的哈希，才能决定它到底落在哪个 bucket。例如，原来 B = 5，计算出 key 的哈希后，只用看它的低 5 位，就能决定它落在哪个 bucket。扩容后，B 变成了 6，因此需要多看一位，它的低 6 位决定 key 落在哪个 bucket。这称为 <code>rehash</code>。</p>
<p><img src="/images/56e139d0-b8ed-40e0-b096-5a3f7659f208.png" alt=""></p>
<p>因此，某个 key 在搬迁前后 bucket 序号可能和原来相等，也可能是相比原来加上 2^B（原来的 B 值），取决于 hash 值 第 6 bit 位是 0  还是 1。</p>
<p>理解了上面 bucket 序号的变化，我们就可以回答另一个问题了：为什么遍历 map 是无序的？</p>
<p>map 在扩容后，会发生 key 的搬迁，原来落在同一个 bucket 中的 key，搬迁后，有些 key 就要远走高飞了（bucket 序号加上了 2^B）。而遍历的过程，就是按顺序遍历 bucket，同时按顺序遍历 bucket 中的 key。搬迁后，key 的位置发生了重大的变化，有些 key 飞上高枝，有些 key 则原地不动。这样，遍历 map 的结果就不可能按原来的顺序了。</p>
<p>当然，如果我就一个 hard code 的 map，我也不会向 map 进行插入删除的操作，按理说每次遍历这样的 map 都会返回一个固定顺序的 key/value 序列吧。的确是这样，但是 Go 杜绝了这种做法，因为这样会给新手程序员带来误解，以为这是一定会发生的事情，在某些情况下，可能会酿成大错。</p>
<p>当然，Go 做得更绝，当我们在遍历 map 时，并不是固定地从 0 号 bucket 开始遍历，每次都是从一个随机值序号的 bucket 开始遍历，并且是从这个 bucket 的一个随机序号的 cell 开始遍历。这样，即使你是一个写死的 map，仅仅只是遍历它，也不太可能会返回一个固定序列的 key/value 对了。</p>
<p>多说一句，“迭代 map 的结果是无序的”这个特性是从 go 1.0 开始加入的。</p>
<p>再明确一个问题：如果扩容后，B 增加了 1，意味着 buckets 总数是原来的 2 倍，原来 1 号的桶“裂变”到两个桶。</p>
<p>例如，原始 B = 2，1号 bucket 中有 2 个 key 的哈希值低 3 位分别为：010，110。由于原来 B = 2，所以低 2 位 <code>10</code> 决定它们落在 2 号桶，现在 B 变成 3，所以 <code>010</code>、<code>110</code> 分别落入 2、6 号桶。</p>
<p><img src="/images/404e0490-65f9-40d2-be46-6ad3d207ca33.png" alt=""></p>
<p>理解了这个，后面讲 map 迭代的时候会用到。</p>
<p>再来讲搬迁函数中的几个关键点：</p>
<p>evacuate 函数每次只完成一个 bucket 的搬迁工作，因此要遍历完此 bucket 的所有的 cell，将有值的 cell copy 到新的地方。bucket 还会链接 overflow bucket，它们同样需要搬迁。因此会有 2 层循环，外层遍历 bucket 和 overflow bucket，内层遍历 bucket 的所有 cell。这样的循环在 map 的源码里到处都是，要理解透了。</p>
<p>源码里提到 X, Y part，其实就是我们说的如果是扩容到原来的 2 倍，桶的数量是原来的 2 倍，前一半桶被称为 X part，后一半桶被称为 Y part。一个 bucket 中的 key 可能会分裂落到 2 个桶，一个位于 X part，一个位于 Y part。所以在搬迁一个 cell 之前，需要知道这个 cell 中的 key 是落到哪个 Part。很简单，重新计算 cell 中 key 的 hash，并向前“多看”一位，决定落入哪个 Part，这个前面也说得很详细了。</p>
<p>有一个特殊情况是：有一种 key，每次对它计算 hash，得到的结果都不一样。这个 key 就是 <code>math.NaN()</code> 的结果，它的含义是 <code>not a number</code>，类型是 float64。当它作为 map 的 key，在搬迁的时候，会遇到一个问题：再次计算它的哈希值和它当初插入 map 时的计算出来的哈希值不一样！</p>
<p>你可能想到了，这样带来的一个后果是，这个 key 是永远不会被 Get 操作获取的！当我使用 <code>m[math.NaN()]</code> 语句的时候，是查不出来结果的。这个 key 只有在遍历整个 map 的时候，才有机会现身。所以，可以向一个 map 插入任意数量的 <code>math.NaN()</code> 作为 key。</p>
<p>当搬迁碰到 <code>math.NaN()</code> 的 key 时，只通过 tophash 的最低位决定分配到 X part 还是 Y part（如果扩容后是原来 buckets 数量的 2 倍）。如果 tophash 的最低位是 0 ，分配到 X part；如果是 1 ，则分配到 Y part。</p>
<p>这是通过 tophash 值与新算出来的哈希值进行运算得到的：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#75af00">top</span><span style="color:#f92672">&amp;</span><span style="color:#ae81ff">1</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// top hash 最低位为 1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 新算出来的 hash 值的 B 位置 1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">hash</span> <span style="color:#f92672">|=</span> <span style="color:#75af00">newbit</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 新算出来的 hash 值的 B 位置 0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">hash</span> <span style="color:#f92672">&amp;^=</span> <span style="color:#75af00">newbit</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// hash 值的 B 位为 0，则搬迁到 x part</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 当 B = 5时，newbit = 32，二进制低 6 位为 10 0000</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">useX</span> <span style="color:#111">=</span> <span style="color:#75af00">hash</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">newbit</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>
</span></span></code></pre></div><p>其实这样的 key 我随便搬迁到哪个 bucket 都行，当然，还是要搬迁到上面裂变那张图中的两个 bucket 中去。但这样做是有好处的，在后面讲 map 迭代的时候会再详细解释，暂时知道是这样分配的就行。</p>
<p>确定了要搬迁到的目标 bucket 后，搬迁操作就比较好进行了。将源 key/value 值 copy 到目的地相应的位置。</p>
<p>设置 key 在原始 buckets 的 tophash 为 <code>evacuatedX</code> 或是 <code>evacuatedY</code>，表示已经搬迁到了新 map 的 x part 或是 y part。新 map 的 tophash 则正常取 key 哈希值的高 8 位。</p>
<p>下面通过图来宏观地看一下扩容前后的变化。</p>
<p>扩容前，B = 2，共有 4 个 buckets，lowbits 表示 hash 值的低位。假设我们不关注其他 buckets 情况，专注在 2 号 bucket。并且假设 overflow 太多，触发了等量扩容（对应于前面的条件 2）。</p>
<p><img src="/images/d8a63f0a-3592-4d2d-abbf-1d308dc24d1f.png" alt=""></p>
<p>扩容完成后，overflow bucket 消失了，key 都集中到了一个 bucket，更为紧凑了，提高了查找的效率。</p>
<p><img src="/images/7bcdec53-7b75-42bc-8cc4-55511b02c758.png" alt=""></p>
<p>假设触发了 2 倍的扩容，那么扩容完成后，老 buckets 中的 key 分裂到了 2 个 新的 bucket。一个在 x part，一个在 y 的 part。依据是 hash 的 lowbits。新 map 中 <code>0-3</code> 称为 x part，<code>4-7</code> 称为 y part。</p>
<p><img src="/images/307e9ec7-d7e0-4a77-b188-ce43cd8ec41a.png" alt=""></p>
<p>注意，上面的两张图忽略了其他 buckets 的搬迁情况，表示所有的 bucket 都搬迁完毕后的情形。实际上，我们知道，搬迁是一个“渐进”的过程，并不会一下子就全部搬迁完毕。所以在搬迁过程中，oldbuckets 指针还会指向原来老的 []bmap，并且已经搬迁完毕的 key 的 tophash 值会是一个状态值，表示 key 的搬迁去向。</p>
<h3 id="map-的遍历">map 的遍历</h3>
<p>本来 map 的遍历过程比较简单：遍历所有的 bucket 以及它后面挂的 overflow bucket，然后挨个遍历 bucket 中的所有 cell。每个 bucket 中包含 8 个 cell，从有 key 的 cell 中取出 key 和 value，这个过程就完成了。</p>
<p>但是，现实并没有这么简单。还记得前面讲过的扩容过程吗？扩容过程不是一个原子的操作，它每次最多只搬运 2 个 bucket，所以如果触发了扩容操作，那么在很长时间里，map 的状态都是处于一个中间态：有些 bucket 已经搬迁到新家，而有些 bucket 还待在老地方。</p>
<p>因此，遍历如果发生在扩容的过程中，就会涉及到遍历新老 bucket 的过程，这是难点所在。</p>
<p>我先写一个简单的代码样例，假装不知道遍历过程具体调用的是什么函数：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ageMp</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#00a8c8">string</span><span style="color:#111">]</span><span style="color:#00a8c8">int</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ageMp</span><span style="color:#111">[</span><span style="color:#d88200">&#34;qcrao&#34;</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#ae81ff">18</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">name</span><span style="color:#111">,</span> <span style="color:#75af00">age</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">ageMp</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">name</span><span style="color:#111">,</span> <span style="color:#75af00">age</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>执行命令：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>go tool compile -S main.go
</span></span></code></pre></div><p>得到汇编命令。这里就不逐行讲解了，可以去看之前的几篇文章，说得很详细。</p>
<p>关键的几行汇编代码如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// ......</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x0124</span> <span style="color:#ae81ff">002</span><span style="color:#ae81ff">92</span> <span style="color:#111">(</span><span style="color:#75af00">test16</span><span style="color:#111">.</span><span style="color:#00a8c8">go</span><span style="color:#111">:</span><span style="color:#ae81ff">9</span><span style="color:#111">)</span>      <span style="color:#75af00">CALL</span>    <span style="color:#75af00">runtime</span><span style="color:#111">.</span><span style="color:#75af00">mapiterinit</span><span style="color:#111">(</span><span style="color:#75af00">SB</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// ......</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x01fb</span> <span style="color:#ae81ff">00507</span> <span style="color:#111">(</span><span style="color:#75af00">test16</span><span style="color:#111">.</span><span style="color:#00a8c8">go</span><span style="color:#111">:</span><span style="color:#ae81ff">9</span><span style="color:#111">)</span>      <span style="color:#75af00">CALL</span>    <span style="color:#75af00">runtime</span><span style="color:#111">.</span><span style="color:#75af00">mapiternext</span><span style="color:#111">(</span><span style="color:#75af00">SB</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x0200</span> <span style="color:#ae81ff">00512</span> <span style="color:#111">(</span><span style="color:#75af00">test16</span><span style="color:#111">.</span><span style="color:#00a8c8">go</span><span style="color:#111">:</span><span style="color:#ae81ff">9</span><span style="color:#111">)</span>      <span style="color:#75af00">MOVQ</span>    <span style="color:#d88200">&#34;&#34;</span><span style="color:#111">..</span><span style="color:#75af00">autotmp_4</span><span style="color:#f92672">+</span><span style="color:#ae81ff">160</span><span style="color:#111">(</span><span style="color:#75af00">SP</span><span style="color:#111">),</span> <span style="color:#75af00">AX</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x0208</span> <span style="color:#ae81ff">00520</span> <span style="color:#111">(</span><span style="color:#75af00">test16</span><span style="color:#111">.</span><span style="color:#00a8c8">go</span><span style="color:#111">:</span><span style="color:#ae81ff">9</span><span style="color:#111">)</span>      <span style="color:#75af00">TESTQ</span>   <span style="color:#75af00">AX</span><span style="color:#111">,</span> <span style="color:#75af00">AX</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x020b</span> <span style="color:#ae81ff">00523</span> <span style="color:#111">(</span><span style="color:#75af00">test16</span><span style="color:#111">.</span><span style="color:#00a8c8">go</span><span style="color:#111">:</span><span style="color:#ae81ff">9</span><span style="color:#111">)</span>      <span style="color:#75af00">JNE</span>     <span style="color:#ae81ff">302</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// ......</span>
</span></span></code></pre></div><p>这样，关于 map 迭代，底层的函数调用关系一目了然。先是调用 <code>mapiterinit</code> 函数初始化迭代器，然后循环调用 <code>mapiternext</code> 函数进行 map 迭代。</p>
<p><img src="/images/275dddcd-9417-4ff2-bd86-1caa120df293.png" alt=""></p>
<p>迭代器的结构体定义：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">hiter</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// key 指针</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">key</span>         <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// value 指针</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">value</span>       <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// map 类型，包含如 key size 大小等</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">t</span>           <span style="color:#f92672">*</span><span style="color:#75af00">maptype</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// map header</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">h</span>           <span style="color:#f92672">*</span><span style="color:#75af00">hmap</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 初始化时指向的 bucket</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">buckets</span>     <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 当前遍历到的 bmap</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">bptr</span>        <span style="color:#f92672">*</span><span style="color:#75af00">bmap</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">overflow</span>    <span style="color:#111">[</span><span style="color:#ae81ff">2</span><span style="color:#111">]</span><span style="color:#f92672">*</span><span style="color:#111">[]</span><span style="color:#f92672">*</span><span style="color:#75af00">bmap</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 起始遍历的 bucet 编号</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">startBucket</span> <span style="color:#00a8c8">uintptr</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 遍历开始时 cell 的编号（每个 bucket 中有 8 个 cell）</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">offset</span>      <span style="color:#00a8c8">uint8</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 是否从头遍历了</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">wrapped</span>     <span style="color:#00a8c8">bool</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// B 的大小</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">B</span>           <span style="color:#00a8c8">uint8</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 指示当前 cell 序号</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">i</span>           <span style="color:#00a8c8">uint8</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 指向当前的 bucket</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">bucket</span>      <span style="color:#00a8c8">uintptr</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 因为扩容，需要检查的 bucket</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">checkBucket</span> <span style="color:#00a8c8">uintptr</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p><code>mapiterinit</code> 就是对 hiter 结构体里的字段进行初始化赋值操作。</p>
<p>前面已经提到过，即使是对一个写死的 map 进行遍历，每次出来的结果也是无序的。下面我们就可以近距离地观察他们的实现了。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// 生成随机数 r</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">r</span> <span style="color:#f92672">:=</span> <span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">fastrand</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">B</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">31</span><span style="color:#f92672">-</span><span style="color:#75af00">bucketCntBits</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span> <span style="color:#f92672">+=</span> <span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">fastrand</span><span style="color:#111">())</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">31</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 从哪个 bucket 开始遍历</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">it</span><span style="color:#111">.</span><span style="color:#75af00">startBucket</span> <span style="color:#111">=</span> <span style="color:#75af00">r</span> <span style="color:#f92672">&amp;</span> <span style="color:#111">(</span><span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span><span style="color:#f92672">&lt;&lt;</span><span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">B</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 从 bucket 的哪个 cell 开始遍历</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">it</span><span style="color:#111">.</span><span style="color:#75af00">offset</span> <span style="color:#111">=</span> <span style="color:#111">uint8</span><span style="color:#111">(</span><span style="color:#75af00">r</span> <span style="color:#f92672">&gt;&gt;</span> <span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">B</span> <span style="color:#f92672">&amp;</span> <span style="color:#111">(</span><span style="color:#75af00">bucketCnt</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span><span style="color:#111">))</span>
</span></span></code></pre></div><p>例如，B = 2，那 <code>uintptr(1)&lt;&lt;h.B - 1</code> 结果就是 3，低 8 位为 <code>0000 0011</code>，将 r 与之相与，就可以得到一个 <code>0~3</code> 的 bucket 序号；bucketCnt - 1 等于 7，低 8 位为 <code>0000 0111</code>，将 r 右移 2 位后，与 7 相与，就可以得到一个 <code>0~7</code> 号的 cell。</p>
<p>于是，在 <code>mapiternext</code> 函数中就会从 it.startBucket 的 it.offset 号的 cell 开始遍历，取出其中的 key 和 value，直到又回到起点 bucket，完成遍历过程。</p>
<p>源码部分比较好看懂，尤其是理解了前面注释的几段代码后，再看这部分代码就没什么压力了。所以，接下来，我将通过图形化的方式讲解整个遍历过程，希望能够清晰易懂。</p>
<p>假设我们有下图所示的一个 map，起始时 B = 1，有两个 bucket，后来触发了扩容（这里不要深究扩容条件，只是一个设定），B 变成 2。并且， 1 号 bucket 中的内容搬迁到了新的 bucket，<code>1 号</code>裂变成 <code>1 号</code>和 <code>3 号</code>；<code>0 号</code> bucket 暂未搬迁。老的 bucket 挂在在 <code>*oldbuckets</code> 指针上面，新的 bucket 则挂在 <code>*buckets</code> 指针上面。</p>
<p><img src="/images/ad3e49ca-d762-496e-81ac-5795bf1b19b3.png" alt=""></p>
<p>这时，我们对此 map 进行遍历。假设经过初始化后，startBucket = 3，offset = 2。于是，遍历的起点将是 3 号 bucket 的 2 号 cell，下面这张图就是开始遍历时的状态：</p>
<p><img src="/images/c26ab30d-161e-43d3-ab72-2420656e4cca.png" alt=""></p>
<p>标红的表示起始位置，bucket 遍历顺序为：3 -&gt; 0 -&gt; 1 -&gt; 2。</p>
<p>因为 3 号 bucket 对应老的 1 号 bucket，因此先检查老 1 号 bucket 是否已经被搬迁过。判断方法就是：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">evacuated</span><span style="color:#111">(</span><span style="color:#75af00">b</span> <span style="color:#f92672">*</span><span style="color:#75af00">bmap</span><span style="color:#111">)</span> <span style="color:#00a8c8">bool</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">h</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">b</span><span style="color:#111">.</span><span style="color:#75af00">tophash</span><span style="color:#111">[</span><span style="color:#ae81ff">0</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">h</span> <span style="color:#111">&gt;</span> <span style="color:#75af00">empty</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">h</span> <span style="color:#111">&lt;</span> <span style="color:#75af00">minTopHash</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>如果 b.tophash[0] 的值在标志值范围内，即在 (0,4) 区间里，说明已经被搬迁过了。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">empty</span> <span style="color:#111">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">evacuatedEmpty</span> <span style="color:#111">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">evacuatedX</span> <span style="color:#111">=</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">evacuatedY</span> <span style="color:#111">=</span> <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">minTopHash</span> <span style="color:#111">=</span> <span style="color:#ae81ff">4</span>
</span></span></code></pre></div><p>在本例中，老 1 号 bucket 已经被搬迁过了。所以它的 tophash[0] 值在 (0,4) 范围内，因此只用遍历新的 3 号 bucket。</p>
<p>依次遍历 3 号 bucket 的 cell，这时候会找到第一个非空的 key：元素 e。到这里，mapiternext 函数返回，这时我们的遍历结果仅有一个元素：</p>
<p><img src="/images/583ed90d-8021-419f-920b-fb26156a9403.png" alt=""></p>
<p>由于返回的 key 不为空，所以会继续调用 mapiternext 函数。</p>
<p>继续从上次遍历到的地方往后遍历，从新 3 号 overflow bucket 中找到了元素 f 和 元素 g。</p>
<p>遍历结果集也因此壮大：</p>
<p><img src="/images/c1e81445-397f-430c-86bb-dc62f261d074.png" alt=""></p>
<p>新 3 号 bucket 遍历完之后，回到了新 0 号 bucket。0 号 bucket 对应老的 0 号 bucket，经检查，老 0 号 bucket 并未搬迁，因此对新 0 号 bucket 的遍历就改为遍历老 0 号 bucket。那是不是把老 0 号 bucket 中的所有 key 都取出来呢？</p>
<p>并没有这么简单，回忆一下，老 0 号 bucket 在搬迁后将裂变成 2 个 bucket：新 0 号、新 2 号。而我们此时正在遍历的只是新 0 号 bucket（注意，遍历都是遍历的 <code>*bucket</code> 指针，也就是所谓的新 buckets）。所以，我们只会取出老 0 号 bucket 中那些在裂变之后，分配到新 0 号 bucket 中的那些 key。</p>
<p>因此，<code>lowbits == 00</code> 的将进入遍历结果集：</p>
<p><img src="/images/02c7c564-1e6c-463c-a3c6-e60b0f631cc5.png" alt=""></p>
<p>和之前的流程一样，继续遍历新 1 号 bucket，发现老 1 号 bucket 已经搬迁，只用遍历新 1 号 bucket 中现有的元素就可以了。结果集变成：</p>
<p><img src="/images/7de551d7-64c5-4c2f-8f54-73ac7c1c5e01.png" alt=""></p>
<p>继续遍历新 2 号 bucket，它来自老 0 号 bucket，因此需要在老 0 号 bucket 中那些会裂变到新 2 号 bucket 中的 key，也就是 <code>lowbit == 10</code> 的那些 key。</p>
<p>这样，遍历结果集变成：</p>
<p><img src="/images/7369c973-b871-4903-b907-00a5a1d0a95a.png" alt=""></p>
<p>最后，继续遍历到新 3 号 bucket 时，发现所有的 bucket 都已经遍历完毕，整个迭代过程执行完毕。</p>
<p>顺便说一下，如果碰到 key 是 <code>math.NaN()</code> 这种的，处理方式类似。核心还是要看它被分裂后具体落入哪个 bucket。只不过只用看它 top hash 的最低位。如果 top hash 的最低位是 0 ，分配到 X part；如果是 1 ，则分配到 Y part。据此决定是否取出 key，放到遍历结果集里。</p>
<p>map 遍历的核心在于理解 2 倍扩容时，老 bucket 会分裂到 2 个新 bucket 中去。而遍历操作，会按照新 bucket 的序号顺序进行，碰到老 bucket 未搬迁的情况时，要在老 bucket 中找到将来要搬迁到新 bucket 来的 key。</p>
<h3 id="map-的赋值">map 的赋值</h3>
<p>通过汇编语言可以看到，向 map 中插入或者修改 key，最终调用的是 <code>mapassign</code> 函数。</p>
<p>实际上插入或修改 key 的语法是一样的，只不过前者操作的 key 在 map 中不存在，而后者操作的 key 存在 map 中。</p>
<p>mapassign 有一个系列的函数，根据 key 类型的不同，编译器会将其优化为相应的“快速函数”。</p>
<table>
  <thead>
      <tr>
          <th>key 类型</th>
          <th>插入</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>uint32</td>
          <td>mapassign_fast32(t *maptype, h *hmap, key uint32) unsafe.Pointer</td>
      </tr>
      <tr>
          <td>uint64</td>
          <td>mapassign_fast64(t *maptype, h *hmap, key uint64) unsafe.Pointer</td>
      </tr>
      <tr>
          <td>string</td>
          <td>mapassign_faststr(t *maptype, h *hmap, ky string) unsafe.Pointer</td>
      </tr>
  </tbody>
</table>
<p>我们只用研究最一般的赋值函数 <code>mapassign</code>。</p>
<p>整体来看，流程非常得简单：对 key 计算 hash 值，根据 hash 值按照之前的流程，找到要赋值的位置（可能是插入新 key，也可能是更新老 key），对相应位置进行赋值。</p>
<p>源码大体和之前讲的类似，核心还是一个双层循环，外层遍历 bucket 和它的 overflow bucket，内层遍历整个 bucket 的各个 cell。限于篇幅，这部分代码的注释我也不展示了，有兴趣的可以去看，保证理解了这篇文章内容后，能够看懂。</p>
<p>我这里会针对这个过程提几点重要的。</p>
<p>函数首先会检查 map 的标志位 flags。如果 flags 的写标志位此时被置 1 了，说明有其他协程在执行“写”操作，进而导致程序 panic。这也说明了 map 对协程是不安全的。</p>
<p>通过前文我们知道扩容是渐进式的，如果 map 处在扩容的过程中，那么当 key 定位到了某个 bucket 后，需要确保这个 bucket 对应的老 bucket 完成了迁移过程。即老 bucket 里的 key 都要迁移到新的 bucket 中来（分裂到 2 个新 bucket），才能在新的 bucket 中进行插入或者更新的操作。</p>
<p>上面说的操作是在函数靠前的位置进行的，只有进行完了这个搬迁操作后，我们才能放心地在新 bucket 里定位 key 要安置的地址，再进行之后的操作。</p>
<p>现在到了定位 key 应该放置的位置了，所谓找准自己的位置很重要。准备两个指针，一个（<code>inserti</code>）指向 key 的 hash 值在 tophash 数组所处的位置，另一个(<code>insertk</code>)指向 cell 的位置（也就是 key 最终放置的地址），当然，对应 value 的位置就很容易定位出来了。这三者实际上都是关联的，在 tophash 数组中的索引位置决定了 key 在整个 bucket 中的位置（共 8 个 key），而 value 的位置需要“跨过” 8 个 key 的长度。</p>
<p>在循环的过程中，inserti 和 insertk 分别指向第一个找到的空闲的 cell。如果之后在 map 没有找到 key 的存在，也就是说原来 map 中没有此 key，这意味着插入新 key。那最终 key 的安置地址就是第一次发现的“空位”（tophash 是 empty）。</p>
<p>如果这个 bucket 的 8 个 key 都已经放置满了，那在跳出循环后，发现 inserti 和 insertk 都是空，这时候需要在 bucket 后面挂上 overflow bucket。当然，也有可能是在 overflow bucket 后面再挂上一个 overflow bucket。这就说明，太多 key hash 到了此 bucket。</p>
<p>在正式安置 key 之前，还要检查 map 的状态，看它是否需要进行扩容。如果满足扩容的条件，就主动触发一次扩容操作。</p>
<p>这之后，整个之前的查找定位 key 的过程，还得再重新走一次。因为扩容之后，key 的分布都发生了变化。</p>
<p>最后，会更新 map 相关的值，如果是插入新 key，map 的元素数量字段 count 值会加 1；在函数之初设置的 <code>hashWriting</code> 写标志出会清零。</p>
<p>另外，有一个重要的点要说一下。前面说的找到 key 的位置，进行赋值操作，实际上并不准确。我们看 <code>mapassign</code> 函数的原型就知道，函数并没有传入 value 值，所以赋值操作是什么时候执行的呢？</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">mapassign</span><span style="color:#111">(</span><span style="color:#75af00">t</span> <span style="color:#f92672">*</span><span style="color:#75af00">maptype</span><span style="color:#111">,</span> <span style="color:#75af00">h</span> <span style="color:#f92672">*</span><span style="color:#75af00">hmap</span><span style="color:#111">,</span> <span style="color:#75af00">key</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">)</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span>
</span></span></code></pre></div><p>答案还得从汇编语言中寻找。我直接揭晓答案，有兴趣可以私下去研究一下。<code>mapassign</code> 函数返回的指针就是指向的 key 所对应的 value 值位置，有了地址，就很好操作赋值了。</p>
<h3 id="map-的删除">map 的删除</h3>
<p>写操作底层的执行函数是 <code>mapdelete</code>：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">mapdelete</span><span style="color:#111">(</span><span style="color:#75af00">t</span> <span style="color:#f92672">*</span><span style="color:#75af00">maptype</span><span style="color:#111">,</span> <span style="color:#75af00">h</span> <span style="color:#f92672">*</span><span style="color:#75af00">hmap</span><span style="color:#111">,</span> <span style="color:#75af00">key</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">)</span> 
</span></span></code></pre></div><p>根据 key 类型的不同，删除操作会被优化成更具体的函数：</p>
<table>
  <thead>
      <tr>
          <th>key 类型</th>
          <th>删除</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>uint32</td>
          <td>mapdelete_fast32(t *maptype, h *hmap, key uint32)</td>
      </tr>
      <tr>
          <td>uint64</td>
          <td>mapdelete_fast64(t *maptype, h *hmap, key uint64)</td>
      </tr>
      <tr>
          <td>string</td>
          <td>mapdelete_faststr(t *maptype, h *hmap, ky string)</td>
      </tr>
  </tbody>
</table>
<p>当然，我们只关心 <code>mapdelete</code> 函数。它首先会检查 h.flags 标志，如果发现写标位是 1，直接 panic，因为这表明有其他协程同时在进行写操作。</p>
<p>计算 key 的哈希，找到落入的 bucket。检查此 map 如果正在扩容的过程中，直接触发一次搬迁操作。</p>
<p>删除操作同样是两层循环，核心还是找到 key 的具体位置。寻找过程都是类似的，在 bucket 中挨个 cell 寻找。</p>
<p>找到对应位置后，对 key 或者 value 进行“清零”操作：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// 对 key 清零</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">indirectkey</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">*</span><span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">)(</span><span style="color:#75af00">k</span><span style="color:#111">)</span> <span style="color:#111">=</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">typedmemclr</span><span style="color:#111">(</span><span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">key</span><span style="color:#111">,</span> <span style="color:#75af00">k</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 对 value 清零</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">indirectvalue</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">*</span><span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">)(</span><span style="color:#75af00">v</span><span style="color:#111">)</span> <span style="color:#111">=</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">typedmemclr</span><span style="color:#111">(</span><span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">elem</span><span style="color:#111">,</span> <span style="color:#75af00">v</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>最后，将 count 值减 1，将对应位置的 tophash 值置成 <code>Empty</code>。</p>
<p>这块源码同样比较简单，感兴起直接去看代码。</p>
<h2 id="map-进阶">map 进阶</h2>
<h3 id="可以边遍历边删除吗">可以边遍历边删除吗</h3>
<p>map 并不是一个线程安全的数据结构。同时读写一个 map 是未定义的行为，如果被检测到，会直接 panic。</p>
<p>一般而言，这可以通过读写锁来解决：<code>sync.RWMutex</code>。</p>
<p>读之前调用 <code>RLock()</code> 函数，读完之后调用 <code>RUnlock()</code> 函数解锁；写之前调用 <code>Lock()</code> 函数，写完之后，调用 <code>Unlock()</code> 解锁。</p>
<p>另外，<code>sync.Map</code> 是线程安全的 map，也可以使用。它的实现原理，这次先不说了。</p>
<h3 id="key-可以是-float-型吗">key 可以是 float 型吗？</h3>
<p>从语法上看，是可以的。Go 语言中只要是可比较的类型都可以作为 key。除开 slice，map，functions 这几种类型，其他类型都是 OK 的。具体包括：布尔值、数字、字符串、指针、通道、接口类型、结构体、只包含上述类型的数组。这些类型的共同特征是支持 <code>==</code> 和 <code>!=</code> 操作符，<code>k1 == k2</code> 时，可认为 k1 和 k2 是同一个 key。如果是结构体，则需要它们的字段值都相等，才被认为是相同的 key。</p>
<p>顺便说一句，任何类型都可以作为 value，包括 map 类型。</p>
<p>来看个例子：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">m</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#00a8c8">float64</span><span style="color:#111">]</span><span style="color:#00a8c8">int</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">m</span><span style="color:#111">[</span><span style="color:#ae81ff">1.4</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">m</span><span style="color:#111">[</span><span style="color:#ae81ff">2.4</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">m</span><span style="color:#111">[</span><span style="color:#75af00">math</span><span style="color:#111">.</span><span style="color:#75af00">NaN</span><span style="color:#111">()]</span> <span style="color:#111">=</span> <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">m</span><span style="color:#111">[</span><span style="color:#75af00">math</span><span style="color:#111">.</span><span style="color:#75af00">NaN</span><span style="color:#111">()]</span> <span style="color:#111">=</span> <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">k</span><span style="color:#111">,</span> <span style="color:#75af00">v</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">m</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;[%v, %d] &#34;</span><span style="color:#111">,</span> <span style="color:#75af00">k</span><span style="color:#111">,</span> <span style="color:#75af00">v</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;\nk: %v, v: %d\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">math</span><span style="color:#111">.</span><span style="color:#75af00">NaN</span><span style="color:#111">(),</span> <span style="color:#75af00">m</span><span style="color:#111">[</span><span style="color:#75af00">math</span><span style="color:#111">.</span><span style="color:#75af00">NaN</span><span style="color:#111">()])</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;k: %v, v: %d\n&#34;</span><span style="color:#111">,</span> <span style="color:#ae81ff">2.400000000001</span><span style="color:#111">,</span> <span style="color:#75af00">m</span><span style="color:#111">[</span><span style="color:#ae81ff">2.400000000001</span><span style="color:#111">])</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;k: %v, v: %d\n&#34;</span><span style="color:#111">,</span> <span style="color:#ae81ff">2.4000000000000000000000001</span><span style="color:#111">,</span> <span style="color:#75af00">m</span><span style="color:#111">[</span><span style="color:#ae81ff">2.4000000000000000000000001</span><span style="color:#111">])</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">math</span><span style="color:#111">.</span><span style="color:#75af00">NaN</span><span style="color:#111">()</span> <span style="color:#f92672">==</span> <span style="color:#75af00">math</span><span style="color:#111">.</span><span style="color:#75af00">NaN</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>程序的输出：</p>
<pre tabindex="0"><code>[2.4, 2] [NaN, 3] [NaN, 3] [1.4, 1] 
k: NaN, v: 0
k: 2.400000000001, v: 0
k: 2.4, v: 2
false
</code></pre><p>例子中定义了一个 key 类型是 float 型的 map，并向其中插入了 4 个 key：1.4， 2.4， NAN，NAN。</p>
<p>打印的时候也打印出了 4 个 key，如果你知道 NAN != NAN，也就不奇怪了。因为他们比较的结果不相等，自然，在 map 看来就是两个不同的 key 了。</p>
<p>接着，我们查询了几个 key，发现 NAN 不存在，2.400000000001 也不存在，而 2.4000000000000000000000001 却存在。</p>
<p>有点诡异，不是吗？</p>
<p>接着，我通过汇编发现了如下的事实：</p>
<p>当用 float64 作为 key 的时候，先要将其转成 unit64 类型，再插入 key 中。</p>
<p>具体是通过 <code>Float64frombits</code> 函数完成：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// Float64frombits returns the floating point number corresponding</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// the IEEE 754 binary representation b.</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">Float64frombits</span><span style="color:#111">(</span><span style="color:#75af00">b</span> <span style="color:#00a8c8">uint64</span><span style="color:#111">)</span> <span style="color:#00a8c8">float64</span> <span style="color:#111">{</span> <span style="color:#00a8c8">return</span> <span style="color:#f92672">*</span><span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#00a8c8">float64</span><span style="color:#111">)(</span><span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">b</span><span style="color:#111">))</span> <span style="color:#111">}</span>
</span></span></code></pre></div><p>也就是将浮点数表示成 IEEE 754 规定的格式。如赋值语句：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ae81ff">0x00bd</span> <span style="color:#ae81ff">001</span><span style="color:#ae81ff">89</span> <span style="color:#111">(</span><span style="color:#75af00">test18</span><span style="color:#111">.</span><span style="color:#00a8c8">go</span><span style="color:#111">:</span><span style="color:#ae81ff">9</span><span style="color:#111">)</span>      <span style="color:#75af00">LEAQ</span>    <span style="color:#d88200">&#34;&#34;</span><span style="color:#111">.</span><span style="color:#75af00">statictmp_0</span><span style="color:#111">(</span><span style="color:#75af00">SB</span><span style="color:#111">),</span> <span style="color:#75af00">DX</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x00c4</span> <span style="color:#ae81ff">001</span><span style="color:#ae81ff">96</span> <span style="color:#111">(</span><span style="color:#75af00">test18</span><span style="color:#111">.</span><span style="color:#00a8c8">go</span><span style="color:#111">:</span><span style="color:#ae81ff">9</span><span style="color:#111">)</span>      <span style="color:#75af00">MOVQ</span>    <span style="color:#75af00">DX</span><span style="color:#111">,</span> <span style="color:#ae81ff">16</span><span style="color:#111">(</span><span style="color:#75af00">SP</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x00c9</span> <span style="color:#ae81ff">00201</span> <span style="color:#111">(</span><span style="color:#75af00">test18</span><span style="color:#111">.</span><span style="color:#00a8c8">go</span><span style="color:#111">:</span><span style="color:#ae81ff">9</span><span style="color:#111">)</span>      <span style="color:#75af00">PCDATA</span>  <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x00c9</span> <span style="color:#ae81ff">00201</span> <span style="color:#111">(</span><span style="color:#75af00">test18</span><span style="color:#111">.</span><span style="color:#00a8c8">go</span><span style="color:#111">:</span><span style="color:#ae81ff">9</span><span style="color:#111">)</span>      <span style="color:#75af00">CALL</span>    <span style="color:#75af00">runtime</span><span style="color:#111">.</span><span style="color:#75af00">mapassign</span><span style="color:#111">(</span><span style="color:#75af00">SB</span><span style="color:#111">)</span>
</span></span></code></pre></div><p><code>&quot;&quot;.statictmp_0(SB)</code> 变量是这样的：</p>
<pre tabindex="0"><code>&#34;&#34;.statictmp_0 SRODATA size=8
        0x0000 33 33 33 33 33 33 03 40
&#34;&#34;.statictmp_1 SRODATA size=8
        0x0000 ff 3b 33 33 33 33 03 40
&#34;&#34;.statictmp_2 SRODATA size=8
        0x0000 33 33 33 33 33 33 03 40
</code></pre><p>我们再来输出点东西：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;math&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">m</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#00a8c8">float64</span><span style="color:#111">]</span><span style="color:#00a8c8">int</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">m</span><span style="color:#111">[</span><span style="color:#ae81ff">2.4</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">math</span><span style="color:#111">.</span><span style="color:#75af00">Float64bits</span><span style="color:#111">(</span><span style="color:#ae81ff">2.4</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">math</span><span style="color:#111">.</span><span style="color:#75af00">Float64bits</span><span style="color:#111">(</span><span style="color:#ae81ff">2.400000000001</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">math</span><span style="color:#111">.</span><span style="color:#75af00">Float64bits</span><span style="color:#111">(</span><span style="color:#ae81ff">2.4000000000000000000000001</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">4612586738352864255</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">4612586738352862003</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">4612586738352862003</span>
</span></span></code></pre></div><p>转成十六进制为：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ae81ff">0x4003333333333333</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x4003333333333BFF</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x4003333333333333</span>
</span></span></code></pre></div><p>和前面的 <code>&quot;&quot;.statictmp_0</code> 比较一下，很清晰了吧。<code>2.4</code> 和 <code>2.4000000000000000000000001</code> 经过 <code>math.Float64bits()</code> 函数转换后的结果是一样的。自然，二者在 map 看来，就是同一个 key 了。</p>
<p>再来看一下 NAN（not a number）：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// NaN returns an IEEE 754 ``not-a-number&#39;&#39; value.</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">NaN</span><span style="color:#111">()</span> <span style="color:#00a8c8">float64</span> <span style="color:#111">{</span> <span style="color:#00a8c8">return</span> <span style="color:#75af00">Float64frombits</span><span style="color:#111">(</span><span style="color:#75af00">uvnan</span><span style="color:#111">)</span> <span style="color:#111">}</span>
</span></span></code></pre></div><p>uvan 的定义为：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">uvnan</span>    <span style="color:#111">=</span> <span style="color:#ae81ff">0x7FF8000000000001</span>
</span></span></code></pre></div><p>NAN() 直接调用 <code>Float64frombits</code>，传入写死的 const 型变量 <code>0x7FF8000000000001</code>，得到 NAN 型值。既然，NAN 是从一个常量解析得来的，为什么插入 map 时，会被认为是不同的 key？</p>
<p>这是由类型的哈希函数决定的，例如，对于 64 位的浮点数，它的哈希函数如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">f64hash</span><span style="color:#111">(</span><span style="color:#75af00">p</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span><span style="color:#111">,</span> <span style="color:#75af00">h</span> <span style="color:#00a8c8">uintptr</span><span style="color:#111">)</span> <span style="color:#00a8c8">uintptr</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">f</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">*</span><span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#00a8c8">float64</span><span style="color:#111">)(</span><span style="color:#75af00">p</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">switch</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">case</span> <span style="color:#75af00">f</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">c1</span> <span style="color:#f92672">*</span> <span style="color:#111">(</span><span style="color:#75af00">c0</span> <span style="color:#111">^</span> <span style="color:#75af00">h</span><span style="color:#111">)</span> <span style="color:#75715e">// +0, -0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">case</span> <span style="color:#75af00">f</span> <span style="color:#f92672">!=</span> <span style="color:#75af00">f</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">c1</span> <span style="color:#f92672">*</span> <span style="color:#111">(</span><span style="color:#75af00">c0</span> <span style="color:#111">^</span> <span style="color:#75af00">h</span> <span style="color:#111">^</span> <span style="color:#111">uintptr</span><span style="color:#111">(</span><span style="color:#75af00">fastrand</span><span style="color:#111">()))</span> <span style="color:#75715e">// any kind of NaN</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">default</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">memhash</span><span style="color:#111">(</span><span style="color:#75af00">p</span><span style="color:#111">,</span> <span style="color:#75af00">h</span><span style="color:#111">,</span> <span style="color:#ae81ff">8</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>第二个 case，<code>f != f</code> 就是针对 <code>NAN</code>，这里会再加一个随机数。</p>
<p>这样，所有的谜题都解开了。</p>
<p>由于 NAN 的特性：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">NAN</span> <span style="color:#f92672">!=</span> <span style="color:#75af00">NAN</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">hash</span><span style="color:#111">(</span><span style="color:#75af00">NAN</span><span style="color:#111">)</span> <span style="color:#f92672">!=</span> <span style="color:#75af00">hash</span><span style="color:#111">(</span><span style="color:#75af00">NAN</span><span style="color:#111">)</span>
</span></span></code></pre></div><p>因此向 map 中查找的 key 为 NAN 时，什么也查不到；如果向其中增加了 4 次 NAN，遍历会得到 4 个 NAN。</p>
<p>最后说结论：float 型可以作为 key，但是由于精度的问题，会导致一些诡异的问题，慎用之。</p>
<h2 id="文章转自">文章转自</h2>
<ul>
<li><a href="https://juejin.cn/post/6844903848587296781">https://juejin.cn/post/6844903848587296781</a></li>
</ul>
]]></content:encoded><category>go</category><category>go</category><category>源码分析</category></item><item><title>golang channel原理</title><link>https://daemon365.dev/post/go/golang_channel_principle/</link><pubDate>Sun, 21 Feb 2021 00:00:00 +0800</pubDate><guid>https://daemon365.dev/post/go/golang_channel_principle/</guid><description>&lt;h2 id="channel介绍"&gt;channel介绍&lt;/h2&gt;
&lt;p&gt;channel一个类型管道，通过它可以在goroutine之间发送和接收消息。它是Golang在语言层面提供的goroutine间的通信方式。&lt;/p&gt;
&lt;p&gt;众所周知，Go依赖于称为CSP（Communicating Sequential Processes）的并发模型，通过Channel实现这种同步模式。Go并发的核心哲学是不要通过共享内存进行通信; 相反，通过沟通分享记忆。&lt;/p&gt;
&lt;p&gt;下面以简单的示例来演示Go如何通过channel来实现通信。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;package&lt;/span&gt; &lt;span style="color:#75af00"&gt;main&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;import&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;fmt&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;time&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;goRoutineA&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;a&lt;/span&gt; &lt;span style="color:#f92672"&gt;&amp;lt;-&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;chan&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;int&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;val&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#f92672"&gt;&amp;lt;-&lt;/span&gt;&lt;span style="color:#75af00"&gt;a&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;goRoutineA received the data&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;val&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;goRoutineB&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;b&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;chan&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;int&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;val&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#f92672"&gt;&amp;lt;-&lt;/span&gt;&lt;span style="color:#75af00"&gt;b&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;goRoutineB received the data&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;val&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;main&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;ch&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#111"&gt;make&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;chan&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;int&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;3&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;go&lt;/span&gt; &lt;span style="color:#75af00"&gt;goRoutineA&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;ch&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;go&lt;/span&gt; &lt;span style="color:#75af00"&gt;goRoutineB&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;ch&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;ch&lt;/span&gt; &lt;span style="color:#f92672"&gt;&amp;lt;-&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;3&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;time&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Sleep&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;time&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Second&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;1&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;结果为：&lt;code&gt;goRoutineA received the data 3&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;上面只是个简单的例子，只输出goRoutineA ，没有执行goRoutineB，说明channel仅允许被一个goroutine读写。&lt;/p&gt;
&lt;p&gt;go并发知识：&lt;a href="https://www.cnblogs.com/yuemoxi/p/15161276.html"&gt;链接&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;说道channel这里不得不提通道的结构hchan。&lt;/p&gt;
&lt;h2 id="hchan"&gt;hchan&lt;/h2&gt;
&lt;p&gt;源代码在src/runtime/chan.go&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;type&lt;/span&gt; &lt;span style="color:#75af00"&gt;hchan&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;struct&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;qcount&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;uint&lt;/span&gt; &lt;span style="color:#75715e"&gt;// total data in the queue&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;dataqsiz&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;uint&lt;/span&gt; &lt;span style="color:#75715e"&gt;// size of the circular queue&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;buf&lt;/span&gt; &lt;span style="color:#75af00"&gt;unsafe&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Pointer&lt;/span&gt; &lt;span style="color:#75715e"&gt;// points to an array of dataqsiz elements&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;elemsize&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;uint16&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;closed&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;uint32&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;elemtype&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;_type&lt;/span&gt; &lt;span style="color:#75715e"&gt;// element type&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;sendx&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;uint&lt;/span&gt; &lt;span style="color:#75715e"&gt;// send index&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;recvx&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;uint&lt;/span&gt; &lt;span style="color:#75715e"&gt;// receive index&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;recvq&lt;/span&gt; &lt;span style="color:#75af00"&gt;waitq&lt;/span&gt; &lt;span style="color:#75715e"&gt;// list of recv waiters&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;sendq&lt;/span&gt; &lt;span style="color:#75af00"&gt;waitq&lt;/span&gt; &lt;span style="color:#75715e"&gt;// list of send waiters&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// lock protects all fields in hchan, as well as several&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// fields in sudogs blocked on this channel.&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;//
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt; // Do not change another G&amp;#39;s status while holding this lock&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// (in particular, do not ready a G), as this can deadlock&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// with stack shrinking.&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;lock&lt;/span&gt; &lt;span style="color:#75af00"&gt;mutex&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;type&lt;/span&gt; &lt;span style="color:#75af00"&gt;waitq&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;struct&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;first&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;sudog&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;last&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;sudog&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;说明：&lt;/p&gt;</description><content:encoded><![CDATA[<h2 id="channel介绍">channel介绍</h2>
<p>channel一个类型管道，通过它可以在goroutine之间发送和接收消息。它是Golang在语言层面提供的goroutine间的通信方式。</p>
<p>众所周知，Go依赖于称为CSP（Communicating Sequential Processes）的并发模型，通过Channel实现这种同步模式。Go并发的核心哲学是不要通过共享内存进行通信; 相反，通过沟通分享记忆。</p>
<p>下面以简单的示例来演示Go如何通过channel来实现通信。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d88200">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">goRoutineA</span><span style="color:#111">(</span><span style="color:#75af00">a</span> <span style="color:#f92672">&lt;-</span><span style="color:#00a8c8">chan</span> <span style="color:#00a8c8">int</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">val</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#75af00">a</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;goRoutineA received the data&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">val</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">goRoutineB</span><span style="color:#111">(</span><span style="color:#75af00">b</span> <span style="color:#00a8c8">chan</span> <span style="color:#00a8c8">int</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">val</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#75af00">b</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;goRoutineB  received the data&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">val</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">ch</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">chan</span> <span style="color:#00a8c8">int</span><span style="color:#111">,</span> <span style="color:#ae81ff">3</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">go</span> <span style="color:#75af00">goRoutineA</span><span style="color:#111">(</span><span style="color:#75af00">ch</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">go</span> <span style="color:#75af00">goRoutineB</span><span style="color:#111">(</span><span style="color:#75af00">ch</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">ch</span> <span style="color:#f92672">&lt;-</span> <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Sleep</span><span style="color:#111">(</span><span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Second</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">1</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>结果为：<code>goRoutineA received the data 3</code></p>
<p>上面只是个简单的例子，只输出goRoutineA ，没有执行goRoutineB，说明channel仅允许被一个goroutine读写。</p>
<p>go并发知识：<a href="https://www.cnblogs.com/yuemoxi/p/15161276.html">链接</a></p>
<p>说道channel这里不得不提通道的结构hchan。</p>
<h2 id="hchan">hchan</h2>
<p>源代码在src/runtime/chan.go</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">hchan</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75af00">qcount</span>   <span style="color:#00a8c8">uint</span>           <span style="color:#75715e">// total data in the queue</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75af00">dataqsiz</span> <span style="color:#00a8c8">uint</span>           <span style="color:#75715e">// size of the circular queue</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75af00">buf</span>      <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span> <span style="color:#75715e">// points to an array of dataqsiz elements</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75af00">elemsize</span> <span style="color:#00a8c8">uint16</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75af00">closed</span>   <span style="color:#00a8c8">uint32</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75af00">elemtype</span> <span style="color:#f92672">*</span><span style="color:#75af00">_type</span> <span style="color:#75715e">// element type</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75af00">sendx</span>    <span style="color:#00a8c8">uint</span>   <span style="color:#75715e">// send index</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75af00">recvx</span>    <span style="color:#00a8c8">uint</span>   <span style="color:#75715e">// receive index</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75af00">recvq</span>    <span style="color:#75af00">waitq</span>  <span style="color:#75715e">// list of recv waiters</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75af00">sendq</span>    <span style="color:#75af00">waitq</span>  <span style="color:#75715e">// list of send waiters</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#75715e">// lock protects all fields in hchan, as well as several</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75715e">// fields in sudogs blocked on this channel.</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   // Do not change another G&#39;s status while holding this lock</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75715e">// (in particular, do not ready a G), as this can deadlock</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75715e">// with stack shrinking.</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75af00">lock</span> <span style="color:#75af00">mutex</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">waitq</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">first</span> <span style="color:#f92672">*</span><span style="color:#75af00">sudog</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">last</span>  <span style="color:#f92672">*</span><span style="color:#75af00">sudog</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>说明：</p>
<ul>
<li><strong>qcount</strong> uint // 当前队列中剩余元素个数</li>
<li><strong>dataqsiz</strong> uint // 环形队列长度，即缓冲区的大小，即make（chan T，N），N.</li>
<li><strong>buf</strong> unsafe.Pointer // 环形队列指针</li>
<li><strong>elemsize</strong> uint16 // 每个元素的大小</li>
<li><strong>closed</strong> uint32 // 表示当前通道是否处于关闭状态。创建通道后，该字段设置为0，即通道打开; 通过调用close将其设置为1，通道关闭。</li>
<li><strong>elemtype</strong> *_type // 元素类型，用于数据传递过程中的赋值；</li>
<li><strong>sendx</strong> uint和<strong>recvx</strong> uint是环形缓冲区的状态字段，它指示缓冲区的当前索引 - 支持数组，它可以从中发送数据和接收数据。</li>
<li><strong>recvq</strong> waitq // 等待读消息的goroutine队列</li>
<li><strong>sendq</strong> waitq // 等待写消息的goroutine队列</li>
<li><strong>lock</strong> mutex // 互斥锁，为每个读写操作锁定通道，因为发送和接收必须是互斥操作。</li>
</ul>
<p>这里<strong>sudog代表goroutine。</strong></p>
<h2 id="make-chan">make chan</h2>
<p>make函数在创建channel的时候会在该进程的heap区申请一块内存，创建一个hchan结构体，返回执行该内存的指针，所以获取的的ch变量本身就是一个指针，在函数之间传递的时候是同一个channel。</p>
<p>hchan结构体使<strong>用一个环形队列</strong>来保存groutine之间传递的数据(如果是缓存channel的话)，使用<strong>两个list</strong>保存像该chan发送和从该chan接收数据的goroutine，还有一个mutex来保证操作这些结构的安全。</p>
<p>创建channel 有两种，一种是带缓冲的channel，一种是不带缓冲的channel</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// 带缓冲</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">ch</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">chan</span> <span style="color:#75af00">Task</span><span style="color:#111">,</span> <span style="color:#ae81ff">3</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 不带缓冲</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">ch</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">chan</span> <span style="color:#00a8c8">int</span><span style="color:#111">)</span>
</span></span></code></pre></div><p>这里我们先讨论带缓冲</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">ch</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">chan</span> <span style="color:#00a8c8">int</span><span style="color:#111">,</span> <span style="color:#ae81ff">3</span><span style="color:#111">)</span>
</span></span></code></pre></div><p>创建通道后的缓冲通道结构</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">hchan</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">qcount</span> <span style="color:#00a8c8">uint</span> <span style="color:#111">:</span> <span style="color:#ae81ff">0</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">dataqsiz</span> <span style="color:#00a8c8">uint</span> <span style="color:#111">:</span> <span style="color:#ae81ff">3</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">buf</span> <span style="color:#75af00">unsafe</span><span style="color:#111">.</span><span style="color:#75af00">Pointer</span> <span style="color:#111">:</span> <span style="color:#ae81ff">0xc00007e0e0</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">elemsize</span> <span style="color:#00a8c8">uint16</span> <span style="color:#111">:</span> <span style="color:#ae81ff">8</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">closed</span> <span style="color:#00a8c8">uint32</span> <span style="color:#111">:</span> <span style="color:#ae81ff">0</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">elemtype</span> <span style="color:#f92672">*</span><span style="color:#75af00">runtime</span><span style="color:#111">.</span><span style="color:#75af00">_type</span> <span style="color:#111">:</span> <span style="color:#f92672">&amp;</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">size</span><span style="color:#111">:</span><span style="color:#ae81ff">8</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">ptrdata</span><span style="color:#111">:</span><span style="color:#ae81ff">0</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">hash</span><span style="color:#111">:</span><span style="color:#ae81ff">4149441018</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">tflag</span><span style="color:#111">:</span><span style="color:#ae81ff">7</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">align</span><span style="color:#111">:</span><span style="color:#ae81ff">8</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">fieldalign</span><span style="color:#111">:</span><span style="color:#ae81ff">8</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">kind</span><span style="color:#111">:</span><span style="color:#ae81ff">130</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">alg</span><span style="color:#111">:</span><span style="color:#ae81ff">0x55cdf0</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">gcdata</span><span style="color:#111">:</span><span style="color:#ae81ff">0x4d61b4</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">str</span><span style="color:#111">:</span><span style="color:#ae81ff">1055</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">ptrToThis</span><span style="color:#111">:</span><span style="color:#ae81ff">45152</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">sendx</span> <span style="color:#00a8c8">uint</span> <span style="color:#111">:</span> <span style="color:#ae81ff">0</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">recvx</span> <span style="color:#00a8c8">uint</span> <span style="color:#111">:</span> <span style="color:#ae81ff">0</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">recvq</span> <span style="color:#75af00">runtime</span><span style="color:#111">.</span><span style="color:#75af00">waitq</span> <span style="color:#111">:</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#111">{</span><span style="color:#75af00">first</span><span style="color:#111">:&lt;</span><span style="color:#00a8c8">nil</span><span style="color:#111">&gt;</span> <span style="color:#75af00">last</span><span style="color:#111">:&lt;</span><span style="color:#00a8c8">nil</span><span style="color:#111">&gt;}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">sendq</span> <span style="color:#75af00">runtime</span><span style="color:#111">.</span><span style="color:#75af00">waitq</span> <span style="color:#111">:</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#111">{</span><span style="color:#75af00">first</span><span style="color:#111">:&lt;</span><span style="color:#00a8c8">nil</span><span style="color:#111">&gt;</span> <span style="color:#75af00">last</span><span style="color:#111">:&lt;</span><span style="color:#00a8c8">nil</span><span style="color:#111">&gt;}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">lock</span> <span style="color:#75af00">runtime</span><span style="color:#111">.</span><span style="color:#75af00">mutex</span> <span style="color:#111">:</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#111">{</span><span style="color:#75af00">key</span><span style="color:#111">:</span><span style="color:#ae81ff">0</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>源代码</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">makechan</span><span style="color:#111">(</span><span style="color:#75af00">t</span> <span style="color:#f92672">*</span><span style="color:#75af00">chantype</span><span style="color:#111">,</span> <span style="color:#75af00">size</span> <span style="color:#00a8c8">int</span><span style="color:#111">)</span> <span style="color:#f92672">*</span><span style="color:#75af00">hchan</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#75af00">elem</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">t</span><span style="color:#111">.</span><span style="color:#75af00">elem</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>如果我们创建一个带buffer的channel，底层的数据模型如下图：</p>
<p><img src="/images/44becf0e-3cef-4a92-ad1b-74b0d3be075d.png" alt=""></p>
<h2 id="发送和接受数据">发送和接受数据</h2>
<p>向channel发送和从channel接收数据主要涉及hchan里的四个成员变量，借用Kavya ppt里的图示，来分析发送和接收的过程。</p>
<p><img src="/images/1c0e0400-0356-483d-9144-1ed65764ec37.png" alt=""></p>
<h3 id="向channel写入数据">向channel写入数据</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">ch</span> <span style="color:#f92672">&lt;-</span> <span style="color:#ae81ff">3</span>
</span></span></code></pre></div><p>底层hchan数据流程如图</p>
<p><img src="/images/dbd15c57-37a3-4d27-b110-d78695a1ed23.png" alt="">
<img src="/images/aeb25cf7-f059-4086-a8e7-26efb72aa85e.png" alt=""></p>
<p>发送操作概要</p>
<p>1、锁定整个通道结构。</p>
<p>2、确定写入。尝试<code>recvq</code>从等待队列中等待goroutine，然后将元素直接写入goroutine。</p>
<p>3、如果recvq为Empty，则确定缓冲区是否可用。如果可用，从当前goroutine复制数据到缓冲区。</p>
<p>4、如果缓冲区已满，<strong>则要</strong>写入的元素将保存在当前正在执行的goroutine的结构中，并且当前goroutine将在<strong>sendq中</strong>排队并从运行时挂起。</p>
<p>5、写入完成释放锁。</p>
<p>这里我们要注意几个属性buf、sendx、lock的变化。</p>
<p>流程图</p>
<p><img src="/images/45ec829d-b33d-49df-8be8-a2adb1f6c2f2.png" alt=""></p>
<h3 id="从channel读取操作">从channel读取操作</h3>
<p>几乎和写入操作相同</p>
<p>代码</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">goRoutineA</span><span style="color:#111">(</span><span style="color:#75af00">a</span> <span style="color:#f92672">&lt;-</span><span style="color:#00a8c8">chan</span> <span style="color:#00a8c8">int</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75af00">val</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#75af00">a</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;goRoutineA received the data&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">val</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>底层hchan数据流程如图</p>
<p><img src="/images/35c33001-5ed0-43b5-88bb-78d533a3174d.png" alt="">
<img src="/images/0386fc04-eeb6-4fb8-bcca-dec41f787ddd.png" alt=""></p>
<p>这里我们要注意几个属性buf、sendx、recvx、lock的变化。</p>
<p>读取操作概要</p>
<ol>
<li>先获取channel全局锁</li>
<li>尝试sendq从等待队列中获取等待的goroutine，</li>
<li>如有等待的goroutine，没有缓冲区，取出goroutine并读取数据，然后唤醒这个goroutine，结束读取释放锁。</li>
<li>如有等待的goroutine，且有缓冲区（此时缓冲区已满），从缓冲区队首取出数据，再从sendq取出一个goroutine，将goroutine中的数据存入buf队尾，结束读取释放锁。</li>
<li>如没有等待的goroutine，且缓冲区有数据，直接读取缓冲区数据，结束读取释放锁。</li>
<li>如没有等待的goroutine，且没有缓冲区或缓冲区为空，将当前的goroutine加入<strong>recvq</strong>排队，进入睡眠，等待被写goroutine唤醒。结束读取释放锁。</li>
</ol>
<p>流程图</p>
<p><img src="/images/3f234e37-388e-4070-ae49-5e3b22f59382.png" alt=""></p>
<h2 id="recvq和sendq-结构">recvq和sendq 结构</h2>
<p>recvq和sendq基本上是链表，看起来基本如下</p>
<p><img src="/images/d46ef751-eb47-4517-bdf7-a9e0b42a169e.png" alt=""></p>
<h2 id="goroutine-pauseresume">Goroutine Pause/Resume</h2>
<p>goroutine是Golang实现的用户空间的轻量级的线程，有runtime调度器调度，与操作系统的thread有多对一的关系，相关的数据结构如下图:</p>
<p><img src="/images/982fea32-4940-4297-bf63-b608f4e04e44.png" alt=""></p>
<p>其中M是操作系统的线程，G是用户启动的goroutine，P是与调度相关的context，每个M都拥有一个P，P维护了一个能够运行的goutine队列，用于该线程执行。</p>
<p>当G1向buf已经满了的ch发送数据的时候，当runtine检测到对应的hchan的buf已经满了，会通知调度器，调度器会将G1的状态设置为waiting, 移除与线程M的联系，然后从P的runqueue中选择一个goroutine在线程M中执行，此时G1就是阻塞状态，但是不是操作系统的线程阻塞，所以这个时候只用消耗少量的资源。</p>
<p>那么G1设置为waiting状态后去哪了？怎们去resume呢？我们再回到hchan结构体，注意到hchan有个sendq的成员，其类型是waitq，查看源码如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">hchan</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">recvq</span> <span style="color:#75af00">waitq</span> <span style="color:#75715e">// list of recv waiters </span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">sendq</span> <span style="color:#75af00">waitq</span> <span style="color:#75715e">// list of send waiters </span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span> 
</span></span><span style="display:flex;"><span><span style="color:#111">}</span> 
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">type waitq struct { </span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">first</span> <span style="color:#f92672">*</span><span style="color:#75af00">sudog</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">last</span> <span style="color:#f92672">*</span><span style="color:#75af00">sudog</span> 
</span></span><span style="display:flex;"><span><span style="color:#111">}</span> 
</span></span></code></pre></div><p>实际上，当G1变为waiting状态后，会创建一个代表自己的sudog的结构，然后放到sendq这个list中，sudog结构中保存了channel相关的变量的指针(如果该Goroutine是sender，那么保存的是待发送数据的变量的地址，如果是receiver则为接收数据的变量的地址，之所以是地址，前面我们提到在传输数据的时候使用的是copy的方式)</p>
<p><img src="/images/f8569a70-a969-44db-bd7f-e777dcaa597e.png" alt=""></p>
<p>当G2从ch中接收一个数据时，会通知调度器，设置G1的状态为runnable，然后将加入P的runqueue里，等待线程执行.</p>
<p><img src="/images/770ea2fb-2a34-4061-b34b-a1e600e62be8.png" alt=""></p>
<h2 id="wait-empty-channel">wait empty channel</h2>
<p>前面我们是假设G1先运行，如果G2先运行会怎么样呢？如果G2先运行，那么G2会从一个empty的channel里取数据，这个时候G2就会阻塞，和前面介绍的G1阻塞一样，G2也会创建一个sudog结构体，保存接收数据的变量的地址，但是该sudog结构体是放到了recvq列表里，当G1向ch发送数据的时候，<strong>runtime并没有对hchan结构体题的buf进行加锁，而是直接将G1里的发送到ch的数据copy到了G2 sudog里对应的elem指向的内存地址！</strong></p>
<p><img src="/images/daa8420b-64fe-4672-8de1-e68160550fe7.png" alt=""></p>
<h2 id="select">select</h2>
<p>select就是用来监听和channel有关的IO操作，当 IO 操作发生时，触发相应的动作。</p>
<p>一个简单的示例如下</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>   <span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#d88200">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">goRoutineD</span><span style="color:#111">(</span><span style="color:#75af00">ch</span> <span style="color:#00a8c8">chan</span> <span style="color:#00a8c8">int</span><span style="color:#111">,</span> <span style="color:#75af00">i</span> <span style="color:#00a8c8">int</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Sleep</span><span style="color:#111">(</span><span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Second</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">3</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75af00">ch</span> <span style="color:#f92672">&lt;-</span> <span style="color:#75af00">i</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">goRoutineE</span><span style="color:#111">(</span><span style="color:#75af00">chs</span> <span style="color:#00a8c8">chan</span> <span style="color:#00a8c8">string</span><span style="color:#111">,</span> <span style="color:#75af00">i</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Sleep</span><span style="color:#111">(</span><span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Second</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">3</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75af00">chs</span> <span style="color:#f92672">&lt;-</span> <span style="color:#75af00">i</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75af00">ch</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">chan</span> <span style="color:#00a8c8">int</span><span style="color:#111">,</span> <span style="color:#ae81ff">5</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75af00">chs</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">chan</span> <span style="color:#00a8c8">string</span><span style="color:#111">,</span> <span style="color:#ae81ff">5</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#00a8c8">go</span> <span style="color:#75af00">goRoutineD</span><span style="color:#111">(</span><span style="color:#75af00">ch</span><span style="color:#111">,</span> <span style="color:#ae81ff">5</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>   <span style="color:#00a8c8">go</span> <span style="color:#75af00">goRoutineE</span><span style="color:#111">(</span><span style="color:#75af00">chs</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;ok&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">select</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">case</span> <span style="color:#75af00">msg</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#75af00">ch</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34; received the data &#34;</span><span style="color:#111">,</span> <span style="color:#75af00">msg</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">case</span> <span style="color:#75af00">msgs</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#75af00">chs</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34; received the data &#34;</span><span style="color:#111">,</span> <span style="color:#75af00">msgs</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">default</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;no data received &#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Sleep</span><span style="color:#111">(</span><span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Second</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">1</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>运行程序，因为当前时间没有到3s，所以select 选择defult</p>
<p><code>no data received</code></p>
<p>修改程序，我们注释掉default，并多执行几次结果为</p>
<pre tabindex="0"><code>received the data 5

received the data ok

received the data ok

received the data ok
</code></pre><p>select语句会阻塞，直到监测到一个可以执行的IO操作为止，而这里goRoutineD和goRoutineE睡眠时间是相同的，都是3s，从输出可看出，从channel中读出数据的顺序是随机的。</p>
<p>再修改代码，goRoutineD睡眠时间改成4s</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">goRoutineD</span><span style="color:#111">(</span><span style="color:#75af00">ch</span> <span style="color:#00a8c8">chan</span> <span style="color:#00a8c8">int</span><span style="color:#111">,</span> <span style="color:#75af00">i</span> <span style="color:#00a8c8">int</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Sleep</span><span style="color:#111">(</span><span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Second</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">4</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75af00">ch</span> <span style="color:#f92672">&lt;-</span> <span style="color:#75af00">i</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>此时会先执行goRoutineE，select 选择case msgs := &lt;-chs。</p>
<h2 id="range">range</h2>
<p>可以持续从channel读取数据，一直到channel被关闭，当channel中没有数据时会阻塞当前goroutine，与读channel时阻塞处理机制一样。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>   <span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#d88200">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">goRoutineD</span><span style="color:#111">(</span><span style="color:#75af00">ch</span> <span style="color:#00a8c8">chan</span> <span style="color:#00a8c8">int</span><span style="color:#111">,</span> <span style="color:#75af00">i</span> <span style="color:#00a8c8">int</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>   <span style="color:#00a8c8">for</span>   <span style="color:#75af00">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">1</span><span style="color:#111">;</span> <span style="color:#75af00">i</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">5</span><span style="color:#111">;</span> <span style="color:#75af00">i</span><span style="color:#f92672">++</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75af00">ch</span> <span style="color:#f92672">&lt;-</span> <span style="color:#75af00">i</span>
</span></span><span style="display:flex;"><span>   <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">chanRange</span><span style="color:#111">(</span><span style="color:#75af00">chanName</span> <span style="color:#00a8c8">chan</span> <span style="color:#00a8c8">int</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>   <span style="color:#00a8c8">for</span> <span style="color:#75af00">e</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">chanName</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Get element from chan: %d\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">e</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#00a8c8">if</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">chanName</span><span style="color:#111">)</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span> <span style="color:#75715e">// 如果现有数据量为0，跳出循环</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">break</span>
</span></span><span style="display:flex;"><span>      <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>   <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75af00">ch</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">chan</span> <span style="color:#00a8c8">int</span><span style="color:#111">,</span> <span style="color:#ae81ff">5</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>   <span style="color:#00a8c8">go</span> <span style="color:#75af00">goRoutineD</span><span style="color:#111">(</span><span style="color:#75af00">ch</span><span style="color:#111">,</span> <span style="color:#ae81ff">5</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75af00">chanRange</span><span style="color:#111">(</span><span style="color:#75af00">ch</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>结果：</p>
<pre tabindex="0"><code>Get element from chan: 1
Get element from chan: 2
Get element from chan: 3
Get element from chan: 4
Get element from chan: 5
</code></pre><h2 id="死锁deadlock">死锁（deadlock）</h2>
<p>指两个或两个以上的协程的执行过程中，由于竞争资源或由于彼此通信而造成的一种阻塞的现象。</p>
<p>在非缓冲信道若发生只流入不流出，或只流出不流入，就会发生死锁。</p>
<p>下面是一些死锁的例子</p>
<p>1、</p>
<pre tabindex="0"><code>package main

func main() {
   ch := make(chan int)
   ch &lt;- 3
}
</code></pre><p>上面情况，向非缓冲通道写数据会发生阻塞，导致死锁。解决办法创建缓冲区 ch := make(chan int，3)</p>
<p>2、</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>   <span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75af00">ch</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">chan</span> <span style="color:#00a8c8">int</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#f92672">&lt;-</span><span style="color:#75af00">ch</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>向非缓冲通道读取数据会发生阻塞，导致死锁。 解决办法开启缓冲区，先向channel写入数据。</p>
<p>3、</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75af00">ch</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">chan</span> <span style="color:#00a8c8">int</span><span style="color:#111">,</span> <span style="color:#ae81ff">3</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75af00">ch</span> <span style="color:#f92672">&lt;-</span> <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75af00">ch</span> <span style="color:#f92672">&lt;-</span> <span style="color:#ae81ff">4</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75af00">ch</span> <span style="color:#f92672">&lt;-</span> <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75af00">ch</span> <span style="color:#f92672">&lt;-</span> <span style="color:#ae81ff">6</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>写入数据超过缓冲区数量也会发生死锁。解决办法将写入数据取走。</p>
<p>死锁的情况有很多这里不再赘述。
还有一种情况，向关闭的channel写入数据，不会产生死锁，产生panic。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">ch</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">chan</span> <span style="color:#00a8c8">int</span><span style="color:#111">,</span> <span style="color:#ae81ff">3</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">ch</span> <span style="color:#f92672">&lt;-</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">close</span><span style="color:#111">(</span><span style="color:#75af00">ch</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">ch</span> <span style="color:#f92672">&lt;-</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>解决办法别向关闭的channel写入数据。</p>
<h2 id="参考文章">参考文章</h2>
<ul>
<li><a href="https://segmentfault.com/a/1190000019172554">Go channel 实现原理分析</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/27917262">深入理解Golang Channel</a></li>
</ul>
]]></content:encoded><category>go</category><category>go</category><category>源码分析</category></item><item><title>golang web源码解析</title><link>https://daemon365.dev/post/go/golang_web_source_code_analysis/</link><pubDate>Sat, 21 Mar 2020 00:00:00 +0800</pubDate><guid>https://daemon365.dev/post/go/golang_web_source_code_analysis/</guid><description>&lt;h2 id="go的web工作原理"&gt;Go的web工作原理&lt;/h2&gt;
&lt;p&gt;在Go中使用及其简单的代码即可开启一个web服务。如下：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;//开启web服务&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;test&lt;/span&gt;&lt;span style="color:#111"&gt;(){&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;http&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;HandleFunc&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;/&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;sayHello&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;http&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;ListenAndServe&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;:9090&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt;&lt;span style="color:#f92672"&gt;!=&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;log&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Fatal&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;ListenAndServer:&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt;&lt;span style="color:#75af00"&gt;err&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;sayHello&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;w&lt;/span&gt; &lt;span style="color:#75af00"&gt;http&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;ResponseWriter&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;r&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;http&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Request&lt;/span&gt;&lt;span style="color:#111"&gt;){&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;r&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;ParseForm&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;path&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt;&lt;span style="color:#75af00"&gt;r&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;URL&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Path&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;scheme&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt;&lt;span style="color:#75af00"&gt;r&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;URL&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Scheme&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Fprintf&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;w&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;Hello Guest!&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;在使用&lt;code&gt;ListenAndServe&lt;/code&gt;这个方法时，系统就会给我们指派一个路由器，&lt;code&gt;DefaultServeMux&lt;/code&gt;是系统默认使用的路由器，如果&lt;code&gt;ListenAndServe&lt;/code&gt;这个方法的第2个参数传入nil，系统就会默认使用&lt;code&gt;DefaultServeMux&lt;/code&gt;。当然，这里也可以传入自定义的路由器。&lt;/p&gt;
&lt;p&gt;先来看&lt;code&gt;http.HandleFunc(&amp;quot;/&amp;quot;, sayHello)&lt;/code&gt;，从&lt;code&gt;HandleFunc&lt;/code&gt;方法点进去，如下：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;HandleFunc&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;pattern&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;string&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;handler&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;func&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;ResponseWriter&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;Request&lt;/span&gt;&lt;span style="color:#111"&gt;))&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;DefaultServeMux&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;HandleFunc&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;pattern&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;handler&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;在这里调用了&lt;code&gt;DefaultServeMux&lt;/code&gt;的&lt;code&gt;HandleFunc&lt;/code&gt;方法，这个方法有两个参数，&lt;code&gt;pattern&lt;/code&gt;是匹配的路由规则，&lt;code&gt;handler&lt;/code&gt;表示这个路由规则对应的处理方法，并且这个处理方法有两个参数。&lt;/p&gt;
&lt;p&gt;在我们书写的代码示例中，&lt;code&gt;pattern&lt;/code&gt;对应&lt;code&gt;/&lt;/code&gt;，&lt;code&gt;handler&lt;/code&gt;对应&lt;code&gt;sayHello&lt;/code&gt;，当我们在浏览器中输入&lt;code&gt;http://localhost:9090&lt;/code&gt;时，就会触发&lt;code&gt;sayHello&lt;/code&gt;方法。&lt;/p&gt;
&lt;p&gt;我们再顺着&lt;code&gt;DefaultServeMux&lt;/code&gt;的&lt;code&gt;HandleFunc&lt;/code&gt;方法继续点下去，如下：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;mux&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;ServeMux&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75af00"&gt;HandleFunc&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;pattern&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;string&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;handler&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;func&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;ResponseWriter&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;Request&lt;/span&gt;&lt;span style="color:#111"&gt;))&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;mux&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Handle&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;pattern&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;HandlerFunc&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;handler&lt;/span&gt;&lt;span style="color:#111"&gt;))&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;在这个方法中，路由器又调用了&lt;code&gt;Handle&lt;/code&gt;方法，注意这个&lt;code&gt;Handle&lt;/code&gt;方法的第2个参数，将之前传入的&lt;code&gt;handler&lt;/code&gt;这个响应方法强制转换成了&lt;code&gt;HandlerFunc&lt;/code&gt;类型。&lt;/p&gt;
&lt;p&gt;这个&lt;code&gt;HandlerFunc&lt;/code&gt;类型到底是个什么呢？如下：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;type&lt;/span&gt; &lt;span style="color:#75af00"&gt;HandlerFunc&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;func&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;ResponseWriter&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;Request&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;看来和我们定义的&lt;code&gt;SayHello&lt;/code&gt;方法的类型都差不多。但是！！！
这个&lt;code&gt;HandlerFunc&lt;/code&gt;默认实现了&lt;code&gt;ServeHTTP&lt;/code&gt;接口！这样&lt;code&gt;HandlerFunc&lt;/code&gt;对象就有了&lt;code&gt;ServeHTTP&lt;/code&gt;方法！如下：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;// ServeHTTP calls f(w, r).&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;f&lt;/span&gt; &lt;span style="color:#75af00"&gt;HandlerFunc&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75af00"&gt;ServeHTTP&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;w&lt;/span&gt; &lt;span style="color:#75af00"&gt;ResponseWriter&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;r&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;Request&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;f&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;w&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;r&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;这个细节是十分重要的，因为这一步关乎到当路由规则匹配时，相应的响应方法是否会被调用的问题！这个方法的调用时机会在下一小节中讲到。&lt;/p&gt;
&lt;p&gt;接下来，我们返回去继续看&lt;code&gt;mux&lt;/code&gt;的&lt;code&gt;Handle&lt;/code&gt;方法，也就是这段代码&lt;code&gt;mux.Handle(pattern, HandlerFunc(handler))&lt;/code&gt;。这段代码做了哪些事呢？源码如下：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;mux&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;ServeMux&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75af00"&gt;Handle&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;pattern&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;string&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;handler&lt;/span&gt; &lt;span style="color:#75af00"&gt;Handler&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;mux&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;mu&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Lock&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;defer&lt;/span&gt; &lt;span style="color:#75af00"&gt;mux&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;mu&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Unlock&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;pattern&lt;/span&gt; &lt;span style="color:#f92672"&gt;==&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;&amp;#34;&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;panic&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;http: invalid pattern &amp;#34;&lt;/span&gt; &lt;span style="color:#f92672"&gt;+&lt;/span&gt; &lt;span style="color:#75af00"&gt;pattern&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;handler&lt;/span&gt; &lt;span style="color:#f92672"&gt;==&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;panic&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;http: nil handler&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;mux&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;m&lt;/span&gt;&lt;span style="color:#111"&gt;[&lt;/span&gt;&lt;span style="color:#75af00"&gt;pattern&lt;/span&gt;&lt;span style="color:#111"&gt;].&lt;/span&gt;&lt;span style="color:#75af00"&gt;explicit&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;panic&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;http: multiple registrations for &amp;#34;&lt;/span&gt; &lt;span style="color:#f92672"&gt;+&lt;/span&gt; &lt;span style="color:#75af00"&gt;pattern&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;mux&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;m&lt;/span&gt; &lt;span style="color:#f92672"&gt;==&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;mux&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;m&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#111"&gt;make&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;map&lt;/span&gt;&lt;span style="color:#111"&gt;[&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;string&lt;/span&gt;&lt;span style="color:#111"&gt;]&lt;/span&gt;&lt;span style="color:#75af00"&gt;muxEntry&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;mux&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;m&lt;/span&gt;&lt;span style="color:#111"&gt;[&lt;/span&gt;&lt;span style="color:#75af00"&gt;pattern&lt;/span&gt;&lt;span style="color:#111"&gt;]&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#75af00"&gt;muxEntry&lt;/span&gt;&lt;span style="color:#111"&gt;{&lt;/span&gt;&lt;span style="color:#75af00"&gt;explicit&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;true&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;h&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#75af00"&gt;handler&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;pattern&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#75af00"&gt;pattern&lt;/span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;pattern&lt;/span&gt;&lt;span style="color:#111"&gt;[&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;0&lt;/span&gt;&lt;span style="color:#111"&gt;]&lt;/span&gt; &lt;span style="color:#f92672"&gt;!=&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#39;/&amp;#39;&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;mux&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;hosts&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;true&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// Helpful behavior:&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// If pattern is /tree/, insert an implicit permanent redirect for /tree.&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// It can be overridden by an explicit registration.&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;n&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#111"&gt;len&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;pattern&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;n&lt;/span&gt; &lt;span style="color:#111"&gt;&amp;gt;&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;0&lt;/span&gt; &lt;span style="color:#f92672"&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span style="color:#75af00"&gt;pattern&lt;/span&gt;&lt;span style="color:#111"&gt;[&lt;/span&gt;&lt;span style="color:#75af00"&gt;n&lt;/span&gt;&lt;span style="color:#f92672"&gt;-&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;1&lt;/span&gt;&lt;span style="color:#111"&gt;]&lt;/span&gt; &lt;span style="color:#f92672"&gt;==&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#39;/&amp;#39;&lt;/span&gt; &lt;span style="color:#f92672"&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span style="color:#111"&gt;!&lt;/span&gt;&lt;span style="color:#75af00"&gt;mux&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;m&lt;/span&gt;&lt;span style="color:#111"&gt;[&lt;/span&gt;&lt;span style="color:#75af00"&gt;pattern&lt;/span&gt;&lt;span style="color:#111"&gt;[&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;0&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt;&lt;span style="color:#75af00"&gt;n&lt;/span&gt;&lt;span style="color:#f92672"&gt;-&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;1&lt;/span&gt;&lt;span style="color:#111"&gt;]].&lt;/span&gt;&lt;span style="color:#75af00"&gt;explicit&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// If pattern contains a host name, strip it and use remaining&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// path for redirect.&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;path&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;pattern&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;pattern&lt;/span&gt;&lt;span style="color:#111"&gt;[&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;0&lt;/span&gt;&lt;span style="color:#111"&gt;]&lt;/span&gt; &lt;span style="color:#f92672"&gt;!=&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#39;/&amp;#39;&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// In pattern, at least the last character is a &amp;#39;/&amp;#39;, so&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// strings.Index can&amp;#39;t be -1.&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;path&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#75af00"&gt;pattern&lt;/span&gt;&lt;span style="color:#111"&gt;[&lt;/span&gt;&lt;span style="color:#75af00"&gt;strings&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Index&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;pattern&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;/&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;):]&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;url&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#f92672"&gt;&amp;amp;&lt;/span&gt;&lt;span style="color:#75af00"&gt;url&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;URL&lt;/span&gt;&lt;span style="color:#111"&gt;{&lt;/span&gt;&lt;span style="color:#75af00"&gt;Path&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#75af00"&gt;path&lt;/span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;mux&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;m&lt;/span&gt;&lt;span style="color:#111"&gt;[&lt;/span&gt;&lt;span style="color:#75af00"&gt;pattern&lt;/span&gt;&lt;span style="color:#111"&gt;[&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;0&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt;&lt;span style="color:#75af00"&gt;n&lt;/span&gt;&lt;span style="color:#f92672"&gt;-&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;1&lt;/span&gt;&lt;span style="color:#111"&gt;]]&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#75af00"&gt;muxEntry&lt;/span&gt;&lt;span style="color:#111"&gt;{&lt;/span&gt;&lt;span style="color:#75af00"&gt;h&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#75af00"&gt;RedirectHandler&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;url&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;String&lt;/span&gt;&lt;span style="color:#111"&gt;(),&lt;/span&gt; &lt;span style="color:#75af00"&gt;StatusMovedPermanently&lt;/span&gt;&lt;span style="color:#111"&gt;),&lt;/span&gt; &lt;span style="color:#75af00"&gt;pattern&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#75af00"&gt;pattern&lt;/span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;代码挺多，其实主要就做了一件事，向&lt;code&gt;DefaultServeMux&lt;/code&gt;的&lt;code&gt;map[string]muxEntry&lt;/code&gt;中增加对应的路由规则和&lt;code&gt;handler&lt;/code&gt;。&lt;/p&gt;</description><content:encoded><![CDATA[<h2 id="go的web工作原理">Go的web工作原理</h2>
<p>在Go中使用及其简单的代码即可开启一个web服务。如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">//开启web服务</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">test</span><span style="color:#111">(){</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">HandleFunc</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">sayHello</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">ListenAndServe</span><span style="color:#111">(</span><span style="color:#d88200">&#34;:9090&#34;</span><span style="color:#111">,</span><span style="color:#00a8c8">nil</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span><span style="color:#f92672">!=</span><span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Fatal</span><span style="color:#111">(</span><span style="color:#d88200">&#34;ListenAndServer:&#34;</span><span style="color:#111">,</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">sayHello</span><span style="color:#111">(</span><span style="color:#75af00">w</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">ResponseWriter</span><span style="color:#111">,</span> <span style="color:#75af00">r</span> <span style="color:#f92672">*</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Request</span><span style="color:#111">){</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">ParseForm</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;path&#34;</span><span style="color:#111">,</span><span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">URL</span><span style="color:#111">.</span><span style="color:#75af00">Path</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;scheme&#34;</span><span style="color:#111">,</span><span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">URL</span><span style="color:#111">.</span><span style="color:#75af00">Scheme</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Fprintf</span><span style="color:#111">(</span><span style="color:#75af00">w</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Hello Guest!&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>在使用<code>ListenAndServe</code>这个方法时，系统就会给我们指派一个路由器，<code>DefaultServeMux</code>是系统默认使用的路由器，如果<code>ListenAndServe</code>这个方法的第2个参数传入nil，系统就会默认使用<code>DefaultServeMux</code>。当然，这里也可以传入自定义的路由器。</p>
<p>先来看<code>http.HandleFunc(&quot;/&quot;, sayHello)</code>，从<code>HandleFunc</code>方法点进去，如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">HandleFunc</span><span style="color:#111">(</span><span style="color:#75af00">pattern</span> <span style="color:#00a8c8">string</span><span style="color:#111">,</span> <span style="color:#75af00">handler</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">ResponseWriter</span><span style="color:#111">,</span> <span style="color:#f92672">*</span><span style="color:#75af00">Request</span><span style="color:#111">))</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">DefaultServeMux</span><span style="color:#111">.</span><span style="color:#75af00">HandleFunc</span><span style="color:#111">(</span><span style="color:#75af00">pattern</span><span style="color:#111">,</span> <span style="color:#75af00">handler</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>在这里调用了<code>DefaultServeMux</code>的<code>HandleFunc</code>方法，这个方法有两个参数，<code>pattern</code>是匹配的路由规则，<code>handler</code>表示这个路由规则对应的处理方法，并且这个处理方法有两个参数。</p>
<p>在我们书写的代码示例中，<code>pattern</code>对应<code>/</code>，<code>handler</code>对应<code>sayHello</code>，当我们在浏览器中输入<code>http://localhost:9090</code>时，就会触发<code>sayHello</code>方法。</p>
<p>我们再顺着<code>DefaultServeMux</code>的<code>HandleFunc</code>方法继续点下去，如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">mux</span> <span style="color:#f92672">*</span><span style="color:#75af00">ServeMux</span><span style="color:#111">)</span> <span style="color:#75af00">HandleFunc</span><span style="color:#111">(</span><span style="color:#75af00">pattern</span> <span style="color:#00a8c8">string</span><span style="color:#111">,</span> <span style="color:#75af00">handler</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">ResponseWriter</span><span style="color:#111">,</span> <span style="color:#f92672">*</span><span style="color:#75af00">Request</span><span style="color:#111">))</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">Handle</span><span style="color:#111">(</span><span style="color:#75af00">pattern</span><span style="color:#111">,</span> <span style="color:#75af00">HandlerFunc</span><span style="color:#111">(</span><span style="color:#75af00">handler</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>在这个方法中，路由器又调用了<code>Handle</code>方法，注意这个<code>Handle</code>方法的第2个参数，将之前传入的<code>handler</code>这个响应方法强制转换成了<code>HandlerFunc</code>类型。</p>
<p>这个<code>HandlerFunc</code>类型到底是个什么呢？如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">HandlerFunc</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">ResponseWriter</span><span style="color:#111">,</span> <span style="color:#f92672">*</span><span style="color:#75af00">Request</span><span style="color:#111">)</span>
</span></span></code></pre></div><p>看来和我们定义的<code>SayHello</code>方法的类型都差不多。但是！！！
这个<code>HandlerFunc</code>默认实现了<code>ServeHTTP</code>接口！这样<code>HandlerFunc</code>对象就有了<code>ServeHTTP</code>方法！如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// ServeHTTP calls f(w, r).</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">f</span> <span style="color:#75af00">HandlerFunc</span><span style="color:#111">)</span> <span style="color:#75af00">ServeHTTP</span><span style="color:#111">(</span><span style="color:#75af00">w</span> <span style="color:#75af00">ResponseWriter</span><span style="color:#111">,</span> <span style="color:#75af00">r</span> <span style="color:#f92672">*</span><span style="color:#75af00">Request</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">f</span><span style="color:#111">(</span><span style="color:#75af00">w</span><span style="color:#111">,</span> <span style="color:#75af00">r</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>这个细节是十分重要的，因为这一步关乎到当路由规则匹配时，相应的响应方法是否会被调用的问题！这个方法的调用时机会在下一小节中讲到。</p>
<p>接下来，我们返回去继续看<code>mux</code>的<code>Handle</code>方法，也就是这段代码<code>mux.Handle(pattern, HandlerFunc(handler))</code>。这段代码做了哪些事呢？源码如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">mux</span> <span style="color:#f92672">*</span><span style="color:#75af00">ServeMux</span><span style="color:#111">)</span> <span style="color:#75af00">Handle</span><span style="color:#111">(</span><span style="color:#75af00">pattern</span> <span style="color:#00a8c8">string</span><span style="color:#111">,</span> <span style="color:#75af00">handler</span> <span style="color:#75af00">Handler</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">Lock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">defer</span> <span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">Unlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">pattern</span> <span style="color:#f92672">==</span> <span style="color:#d88200">&#34;&#34;</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#d88200">&#34;http: invalid pattern &#34;</span> <span style="color:#f92672">+</span> <span style="color:#75af00">pattern</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">handler</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#d88200">&#34;http: nil handler&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">m</span><span style="color:#111">[</span><span style="color:#75af00">pattern</span><span style="color:#111">].</span><span style="color:#75af00">explicit</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#d88200">&#34;http: multiple registrations for &#34;</span> <span style="color:#f92672">+</span> <span style="color:#75af00">pattern</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">m</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">m</span> <span style="color:#111">=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#00a8c8">string</span><span style="color:#111">]</span><span style="color:#75af00">muxEntry</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">m</span><span style="color:#111">[</span><span style="color:#75af00">pattern</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#75af00">muxEntry</span><span style="color:#111">{</span><span style="color:#75af00">explicit</span><span style="color:#111">:</span> <span style="color:#00a8c8">true</span><span style="color:#111">,</span> <span style="color:#75af00">h</span><span style="color:#111">:</span> <span style="color:#75af00">handler</span><span style="color:#111">,</span> <span style="color:#75af00">pattern</span><span style="color:#111">:</span> <span style="color:#75af00">pattern</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">pattern</span><span style="color:#111">[</span><span style="color:#ae81ff">0</span><span style="color:#111">]</span> <span style="color:#f92672">!=</span> <span style="color:#d88200">&#39;/&#39;</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">hosts</span> <span style="color:#111">=</span> <span style="color:#00a8c8">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Helpful behavior:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// If pattern is /tree/, insert an implicit permanent redirect for /tree.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// It can be overridden by an explicit registration.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">n</span> <span style="color:#f92672">:=</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">pattern</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">n</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">pattern</span><span style="color:#111">[</span><span style="color:#75af00">n</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">]</span> <span style="color:#f92672">==</span> <span style="color:#d88200">&#39;/&#39;</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#111">!</span><span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">m</span><span style="color:#111">[</span><span style="color:#75af00">pattern</span><span style="color:#111">[</span><span style="color:#ae81ff">0</span><span style="color:#111">:</span><span style="color:#75af00">n</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">]].</span><span style="color:#75af00">explicit</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// If pattern contains a host name, strip it and use remaining</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// path for redirect.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">path</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">pattern</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#75af00">pattern</span><span style="color:#111">[</span><span style="color:#ae81ff">0</span><span style="color:#111">]</span> <span style="color:#f92672">!=</span> <span style="color:#d88200">&#39;/&#39;</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// In pattern, at least the last character is a &#39;/&#39;, so</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// strings.Index can&#39;t be -1.</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75af00">path</span> <span style="color:#111">=</span> <span style="color:#75af00">pattern</span><span style="color:#111">[</span><span style="color:#75af00">strings</span><span style="color:#111">.</span><span style="color:#75af00">Index</span><span style="color:#111">(</span><span style="color:#75af00">pattern</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;/&#34;</span><span style="color:#111">):]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">url</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">url</span><span style="color:#111">.</span><span style="color:#75af00">URL</span><span style="color:#111">{</span><span style="color:#75af00">Path</span><span style="color:#111">:</span> <span style="color:#75af00">path</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">m</span><span style="color:#111">[</span><span style="color:#75af00">pattern</span><span style="color:#111">[</span><span style="color:#ae81ff">0</span><span style="color:#111">:</span><span style="color:#75af00">n</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">]]</span> <span style="color:#111">=</span> <span style="color:#75af00">muxEntry</span><span style="color:#111">{</span><span style="color:#75af00">h</span><span style="color:#111">:</span> <span style="color:#75af00">RedirectHandler</span><span style="color:#111">(</span><span style="color:#75af00">url</span><span style="color:#111">.</span><span style="color:#75af00">String</span><span style="color:#111">(),</span> <span style="color:#75af00">StatusMovedPermanently</span><span style="color:#111">),</span> <span style="color:#75af00">pattern</span><span style="color:#111">:</span> <span style="color:#75af00">pattern</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>代码挺多，其实主要就做了一件事，向<code>DefaultServeMux</code>的<code>map[string]muxEntry</code>中增加对应的路由规则和<code>handler</code>。</p>
<p><code>map[string]muxEntry</code>是个什么鬼？</p>
<ul>
<li><code>map</code>是一个字典对象，它保存的是<code>key-value</code>。</li>
<li><code>[string]</code>表示这个字典的<code>key</code>是<code>string</code>类型的，这个<code>key</code>值会保存我们的路由规则。</li>
<li><code>muxEntry</code>是一个实例对象，这个对象内保存了路由规则对应的处理方法。</li>
</ul>
<p>找到相应代码，如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">//路由器</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">ServeMux</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">mu</span>    <span style="color:#75af00">sync</span><span style="color:#111">.</span><span style="color:#75af00">RWMutex</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">m</span>     <span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#00a8c8">string</span><span style="color:#111">]</span><span style="color:#75af00">muxEntry</span> <span style="color:#75715e">//路由规则，一个string对应一个mux实例对象，map的key就是注册的路由表达式(string类型的)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">hosts</span> <span style="color:#00a8c8">bool</span> <span style="color:#75715e">// whether any patterns contain hostnames</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//muxEntry</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">muxEntry</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">explicit</span> <span style="color:#00a8c8">bool</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">h</span>        <span style="color:#75af00">Handler</span> <span style="color:#75715e">//这个路由表达式对应哪个handler</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">pattern</span>  <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//路由响应方法</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Handler</span> <span style="color:#00a8c8">interface</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">ServeHTTP</span><span style="color:#111">(</span><span style="color:#75af00">ResponseWriter</span><span style="color:#111">,</span> <span style="color:#f92672">*</span><span style="color:#75af00">Request</span><span style="color:#111">)</span>  <span style="color:#75715e">//handler的路由实现器</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p><code>ServeMux</code>就是这个系统默认的路由器。</p>
<p>最后，总结一下这个部分：</p>
<ol>
<li>调用<code>http.HandleFunc(&quot;/&quot;, sayHello)</code></li>
<li>调用<code>DefaultServeMux</code>的<code>HandleFunc()</code>，把我们定义的<code>sayHello()</code>包装成<code>HandlerFunc</code>类型</li>
<li>继续调用<code>DefaultServeMux</code>的<code>Handle()</code>，向<code>DefaultServeMux</code>的<code>map[string]muxEntry</code>中增加路由规则和对应的<code>handler</code></li>
</ol>
<p>OK，这部分代码做的事就这么多，第一部分结束。</p>
<p>第二部分主要就是研究这句代码<code>err := http.ListenAndServe(&quot;:9090&quot;,nil)</code>，也就是<code>ListenAndServe</code>这个方法。从这个方法点进去，如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">ListenAndServe</span><span style="color:#111">(</span><span style="color:#75af00">addr</span> <span style="color:#00a8c8">string</span><span style="color:#111">,</span> <span style="color:#75af00">handler</span> <span style="color:#75af00">Handler</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">server</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">Server</span><span style="color:#111">{</span><span style="color:#75af00">Addr</span><span style="color:#111">:</span> <span style="color:#75af00">addr</span><span style="color:#111">,</span> <span style="color:#75af00">Handler</span><span style="color:#111">:</span> <span style="color:#75af00">handler</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#75af00">server</span><span style="color:#111">.</span><span style="color:#75af00">ListenAndServe</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>在这个方法中，初始化了一个<code>server</code>对象，然后调用这个<code>server</code>对象的<code>ListenAndServe</code>方法，在这个方法中，如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">srv</span> <span style="color:#f92672">*</span><span style="color:#75af00">Server</span><span style="color:#111">)</span> <span style="color:#75af00">ListenAndServe</span><span style="color:#111">()</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">addr</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">srv</span><span style="color:#111">.</span><span style="color:#75af00">Addr</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">addr</span> <span style="color:#f92672">==</span> <span style="color:#d88200">&#34;&#34;</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">addr</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;:http&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">ln</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">net</span><span style="color:#111">.</span><span style="color:#75af00">Listen</span><span style="color:#111">(</span><span style="color:#d88200">&#34;tcp&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">addr</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#75af00">srv</span><span style="color:#111">.</span><span style="color:#75af00">Serve</span><span style="color:#111">(</span><span style="color:#75af00">tcpKeepAliveListener</span><span style="color:#111">{</span><span style="color:#75af00">ln</span><span style="color:#111">.(</span><span style="color:#f92672">*</span><span style="color:#75af00">net</span><span style="color:#111">.</span><span style="color:#75af00">TCPListener</span><span style="color:#111">)})</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>在这个方法中，调用了<code>net.Listen(&quot;tcp&quot;, addr)</code>，也就是底层用TCP协议搭建了一个服务，然后监控我们设置的端口。</p>
<p>代码的最后，调用了<code>srv</code>的<code>Serve</code>方法，如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">srv</span> <span style="color:#f92672">*</span><span style="color:#75af00">Server</span><span style="color:#111">)</span> <span style="color:#75af00">Serve</span><span style="color:#111">(</span><span style="color:#75af00">l</span> <span style="color:#75af00">net</span><span style="color:#111">.</span><span style="color:#75af00">Listener</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">defer</span> <span style="color:#75af00">l</span><span style="color:#111">.</span><span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">fn</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">testHookServerServe</span><span style="color:#111">;</span> <span style="color:#75af00">fn</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">fn</span><span style="color:#111">(</span><span style="color:#75af00">srv</span><span style="color:#111">,</span> <span style="color:#75af00">l</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">var</span> <span style="color:#75af00">tempDelay</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Duration</span> <span style="color:#75715e">// how long to sleep on accept failure</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">srv</span><span style="color:#111">.</span><span style="color:#75af00">setupHTTP2_Serve</span><span style="color:#111">();</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">srv</span><span style="color:#111">.</span><span style="color:#75af00">trackListener</span><span style="color:#111">(</span><span style="color:#75af00">l</span><span style="color:#111">,</span> <span style="color:#00a8c8">true</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">defer</span> <span style="color:#75af00">srv</span><span style="color:#111">.</span><span style="color:#75af00">trackListener</span><span style="color:#111">(</span><span style="color:#75af00">l</span><span style="color:#111">,</span> <span style="color:#00a8c8">false</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">baseCtx</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Background</span><span style="color:#111">()</span> <span style="color:#75715e">// base is always background, per Issue 16220</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">ctx</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">WithValue</span><span style="color:#111">(</span><span style="color:#75af00">baseCtx</span><span style="color:#111">,</span> <span style="color:#75af00">ServerContextKey</span><span style="color:#111">,</span> <span style="color:#75af00">srv</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">ctx</span> <span style="color:#111">=</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">WithValue</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">LocalAddrContextKey</span><span style="color:#111">,</span> <span style="color:#75af00">l</span><span style="color:#111">.</span><span style="color:#75af00">Addr</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">for</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">rw</span><span style="color:#111">,</span> <span style="color:#75af00">e</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">l</span><span style="color:#111">.</span><span style="color:#75af00">Accept</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#75af00">e</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">select</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#75af00">srv</span><span style="color:#111">.</span><span style="color:#75af00">getDoneChan</span><span style="color:#111">():</span>
</span></span><span style="display:flex;"><span>                <span style="color:#00a8c8">return</span> <span style="color:#75af00">ErrServerClosed</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">default</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">if</span> <span style="color:#75af00">ne</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">e</span><span style="color:#111">.(</span><span style="color:#75af00">net</span><span style="color:#111">.</span><span style="color:#75af00">Error</span><span style="color:#111">);</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">ne</span><span style="color:#111">.</span><span style="color:#75af00">Temporary</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#00a8c8">if</span> <span style="color:#75af00">tempDelay</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#75af00">tempDelay</span> <span style="color:#111">=</span> <span style="color:#ae81ff">5</span> <span style="color:#f92672">*</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Millisecond</span>
</span></span><span style="display:flex;"><span>                <span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#75af00">tempDelay</span> <span style="color:#f92672">*=</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>                <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#00a8c8">if</span> <span style="color:#75af00">max</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">*</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Second</span><span style="color:#111">;</span> <span style="color:#75af00">tempDelay</span> <span style="color:#111">&gt;</span> <span style="color:#75af00">max</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#75af00">tempDelay</span> <span style="color:#111">=</span> <span style="color:#75af00">max</span>
</span></span><span style="display:flex;"><span>                <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75af00">srv</span><span style="color:#111">.</span><span style="color:#75af00">logf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;http: Accept error: %v; retrying in %v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">e</span><span style="color:#111">,</span> <span style="color:#75af00">tempDelay</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Sleep</span><span style="color:#111">(</span><span style="color:#75af00">tempDelay</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#00a8c8">continue</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">return</span> <span style="color:#75af00">e</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">tempDelay</span> <span style="color:#111">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">c</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">srv</span><span style="color:#111">.</span><span style="color:#75af00">newConn</span><span style="color:#111">(</span><span style="color:#75af00">rw</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">setState</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">rwc</span><span style="color:#111">,</span> <span style="color:#75af00">StateNew</span><span style="color:#111">)</span> <span style="color:#75715e">// before Serve can return</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">go</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">serve</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>最后3段代码比较重要，也是Go语言支持高并发的体现，如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">c</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">srv</span><span style="color:#111">.</span><span style="color:#75af00">newConn</span><span style="color:#111">(</span><span style="color:#75af00">rw</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">setState</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">rwc</span><span style="color:#111">,</span> <span style="color:#75af00">StateNew</span><span style="color:#111">)</span> <span style="color:#75715e">// before Serve can return</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">go</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">serve</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">)</span>
</span></span></code></pre></div><p>上面那一大坨代码，总体意思是进入方法后，首先开了一个<code>for</code>循环，在<code>for</code>循环内时刻Accept请求，请求来了之后，会为每个请求创建一个<code>Conn</code>，然后单独开启一个<code>goroutine</code>，把这个请求的数据当做参数扔给这个<code>Conn</code>去服务：<code>go c.serve()</code>。用户的每一次请求都是在一个新的<code>goroutine</code>去服务，每个请求间相互不影响。</p>
<p>在<code>conn</code>的<code>serve</code>方法中，有一句代码很重要，如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">serverHandler</span><span style="color:#111">{</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">server</span><span style="color:#111">}.</span><span style="color:#75af00">ServeHTTP</span><span style="color:#111">(</span><span style="color:#75af00">w</span><span style="color:#111">,</span> <span style="color:#75af00">w</span><span style="color:#111">.</span><span style="color:#75af00">req</span><span style="color:#111">)</span>
</span></span></code></pre></div><p>表示<code>serverHandler</code>也实现了<code>ServeHTTP</code>接口，<code>ServeHTTP</code>方法实现如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">sh</span> <span style="color:#75af00">serverHandler</span><span style="color:#111">)</span> <span style="color:#75af00">ServeHTTP</span><span style="color:#111">(</span><span style="color:#75af00">rw</span> <span style="color:#75af00">ResponseWriter</span><span style="color:#111">,</span> <span style="color:#75af00">req</span> <span style="color:#f92672">*</span><span style="color:#75af00">Request</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">handler</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">sh</span><span style="color:#111">.</span><span style="color:#75af00">srv</span><span style="color:#111">.</span><span style="color:#75af00">Handler</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">handler</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">handler</span> <span style="color:#111">=</span> <span style="color:#75af00">DefaultServeMux</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">req</span><span style="color:#111">.</span><span style="color:#75af00">RequestURI</span> <span style="color:#f92672">==</span> <span style="color:#d88200">&#34;*&#34;</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">req</span><span style="color:#111">.</span><span style="color:#75af00">Method</span> <span style="color:#f92672">==</span> <span style="color:#d88200">&#34;OPTIONS&#34;</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">handler</span> <span style="color:#111">=</span> <span style="color:#75af00">globalOptionsHandler</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">handler</span><span style="color:#111">.</span><span style="color:#75af00">ServeHTTP</span><span style="color:#111">(</span><span style="color:#75af00">rw</span><span style="color:#111">,</span> <span style="color:#75af00">req</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>在这里如果<code>handler</code>为空（这个<code>handler</code>就可以理解为是我们自定义的路由器），就会使用系统默认的<code>DefaultServeMux</code>，代码的最后调用了<code>DefaultServeMux</code>的<code>ServeHTTP()</code></p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">mux</span> <span style="color:#f92672">*</span><span style="color:#75af00">ServeMux</span><span style="color:#111">)</span> <span style="color:#75af00">ServeHTTP</span><span style="color:#111">(</span><span style="color:#75af00">w</span> <span style="color:#75af00">ResponseWriter</span><span style="color:#111">,</span> <span style="color:#75af00">r</span> <span style="color:#f92672">*</span><span style="color:#75af00">Request</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">RequestURI</span> <span style="color:#f92672">==</span> <span style="color:#d88200">&#34;*&#34;</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">ProtoAtLeast</span><span style="color:#111">(</span><span style="color:#ae81ff">1</span><span style="color:#111">,</span> <span style="color:#ae81ff">1</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75af00">w</span><span style="color:#111">.</span><span style="color:#75af00">Header</span><span style="color:#111">().</span><span style="color:#75af00">Set</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Connection&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;close&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">w</span><span style="color:#111">.</span><span style="color:#75af00">WriteHeader</span><span style="color:#111">(</span><span style="color:#75af00">StatusBadRequest</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">h</span><span style="color:#111">,</span> <span style="color:#75af00">_</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">Handler</span><span style="color:#111">(</span><span style="color:#75af00">r</span><span style="color:#111">)</span>  <span style="color:#75715e">//这里返回的h是Handler接口对象</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">ServeHTTP</span><span style="color:#111">(</span><span style="color:#75af00">w</span><span style="color:#111">,</span> <span style="color:#75af00">r</span><span style="color:#111">)</span>       <span style="color:#75715e">//调用Handler接口对象的ServeHTTP方法实际上就调用了我们定义的sayHello方法</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>路由器接收到请求之后，如果是<code>*</code>那么关闭链接，如果不是<code>*</code>就调用<code>mux.Handler(r)</code>返回该路由对应的处理<code>Handler</code>，然后执行该<code>handler</code>的<code>ServeHTTP</code>方法，也就是这句代码<code>h.ServeHTTP(w, r)</code>，<code>mux.Handler(r)</code>做了什么呢？如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">mux</span> <span style="color:#f92672">*</span><span style="color:#75af00">ServeMux</span><span style="color:#111">)</span> <span style="color:#75af00">Handler</span><span style="color:#111">(</span><span style="color:#75af00">r</span> <span style="color:#f92672">*</span><span style="color:#75af00">Request</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#75af00">h</span> <span style="color:#75af00">Handler</span><span style="color:#111">,</span> <span style="color:#75af00">pattern</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">Method</span> <span style="color:#f92672">!=</span> <span style="color:#d88200">&#34;CONNECT&#34;</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#75af00">p</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">cleanPath</span><span style="color:#111">(</span><span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">URL</span><span style="color:#111">.</span><span style="color:#75af00">Path</span><span style="color:#111">);</span> <span style="color:#75af00">p</span> <span style="color:#f92672">!=</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">URL</span><span style="color:#111">.</span><span style="color:#75af00">Path</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">pattern</span> <span style="color:#111">=</span> <span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">handler</span><span style="color:#111">(</span><span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">Host</span><span style="color:#111">,</span> <span style="color:#75af00">p</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75af00">url</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">*</span><span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">URL</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75af00">url</span><span style="color:#111">.</span><span style="color:#75af00">Path</span> <span style="color:#111">=</span> <span style="color:#75af00">p</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">return</span> <span style="color:#75af00">RedirectHandler</span><span style="color:#111">(</span><span style="color:#75af00">url</span><span style="color:#111">.</span><span style="color:#75af00">String</span><span style="color:#111">(),</span> <span style="color:#75af00">StatusMovedPermanently</span><span style="color:#111">),</span> <span style="color:#75af00">pattern</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">handler</span><span style="color:#111">(</span><span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">Host</span><span style="color:#111">,</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">URL</span><span style="color:#111">.</span><span style="color:#75af00">Path</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">mux</span> <span style="color:#f92672">*</span><span style="color:#75af00">ServeMux</span><span style="color:#111">)</span> <span style="color:#75af00">handler</span><span style="color:#111">(</span><span style="color:#75af00">host</span><span style="color:#111">,</span> <span style="color:#75af00">path</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#75af00">h</span> <span style="color:#75af00">Handler</span><span style="color:#111">,</span> <span style="color:#75af00">pattern</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">RLock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">defer</span> <span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">RUnlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Host-specific pattern takes precedence over generic ones</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">hosts</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">h</span><span style="color:#111">,</span> <span style="color:#75af00">pattern</span> <span style="color:#111">=</span> <span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">match</span><span style="color:#111">(</span><span style="color:#75af00">host</span> <span style="color:#f92672">+</span> <span style="color:#75af00">path</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">h</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">h</span><span style="color:#111">,</span> <span style="color:#75af00">pattern</span> <span style="color:#111">=</span> <span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">match</span><span style="color:#111">(</span><span style="color:#75af00">path</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">h</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">h</span><span style="color:#111">,</span> <span style="color:#75af00">pattern</span> <span style="color:#111">=</span> <span style="color:#75af00">NotFoundHandler</span><span style="color:#111">(),</span> <span style="color:#d88200">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">mux</span> <span style="color:#f92672">*</span><span style="color:#75af00">ServeMux</span><span style="color:#111">)</span> <span style="color:#75af00">match</span><span style="color:#111">(</span><span style="color:#75af00">path</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#75af00">h</span> <span style="color:#75af00">Handler</span><span style="color:#111">,</span> <span style="color:#75af00">pattern</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">var</span> <span style="color:#75af00">n</span> <span style="color:#111">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">for</span> <span style="color:#75af00">k</span><span style="color:#111">,</span> <span style="color:#75af00">v</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">m</span> <span style="color:#111">{</span>  <span style="color:#75715e">//mux.m就是系统默认路由的map</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">pathMatch</span><span style="color:#111">(</span><span style="color:#75af00">k</span><span style="color:#111">,</span> <span style="color:#75af00">path</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">continue</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#75af00">h</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#f92672">||</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">k</span><span style="color:#111">)</span> <span style="color:#111">&gt;</span> <span style="color:#75af00">n</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75af00">n</span> <span style="color:#111">=</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">k</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75af00">h</span> <span style="color:#111">=</span> <span style="color:#75af00">v</span><span style="color:#111">.</span><span style="color:#75af00">h</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75af00">pattern</span> <span style="color:#111">=</span> <span style="color:#75af00">v</span><span style="color:#111">.</span><span style="color:#75af00">pattern</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>它会根据用户请求的<code>URL</code>到路由器里面存储的<code>map</code>中匹配，匹配成功就会返回存储的<code>handler</code>，调用这个<code>handler</code>的<code>ServeHTTP()</code>就可以执行到相应的处理方法了，这个处理方法实际上就是我们刚开始定义的<code>sayHello()</code>，只不过这个<code>sayHello()</code>被<code>HandlerFunc</code>又包了一层，因为<code>HandlerFunc</code>实现了<code>ServeHTTP</code>接口，所以在调用<code>HandlerFunc</code>对象的<code>ServeHTTP()</code>时，实际上在<code>ServeHTTP ()</code>的内部调用了我们的<code>sayHello()</code>。</p>
<p>总结一下：</p>
<ol>
<li>调用<code>http.ListenAndServe(&quot;:9090&quot;,nil)</code></li>
<li>实例化<code>server</code></li>
<li>调用<code>server</code>的<code>ListenAndServe()</code></li>
<li>调用<code>server</code>的<code>Serve</code>方法，开启<code>for</code>循环，在循环中Accept请求</li>
<li>对每一个请求实例化一个<code>Conn</code>，并且开启一个<code>goroutine</code>为这个请求进行服务<code>go c.serve()</code></li>
<li>读取每个请求的内容<code>c.readRequest()</code></li>
<li>调用<code>serverHandler</code>的<code>ServeHTTP()</code>，如果<code>handler</code>为空，就把<code>handler</code>设置为系统默认的路由器<code>DefaultServeMux</code></li>
<li>调用<code>handler</code>的<code>ServeHTTP()</code> =&gt;实际上是调用了<code>DefaultServeMux</code>的<code>ServeHTTP()</code></li>
<li>在<code>ServeHTTP()</code>中会调用路由对应处理<code>handler</code></li>
<li>在路由对应处理<code>handler</code>中会执行<code>sayHello()</code></li>
</ol>
<p>有一个需要注意的点：
<code>DefaultServeMux</code>和路由对应的处理方法<code>handler</code>都实现了<code>ServeHTTP</code>接口，他们俩都有<code>ServeHTTP</code>方法，但是方法要达到的目的不同，在<code>DefaultServeMux</code>的<code>ServeHttp()</code>里会执行路由对应的处理<code>handler</code>的<code>ServeHttp()</code>。</p>
<h2 id="文章转自">文章转自</h2>
<p><a href="https://juejin.cn/post/6844903550993039374">https://juejin.cn/post/6844903550993039374</a></p>
]]></content:encoded><category>go</category><category>go</category><category>源码分析</category></item></channel></rss>