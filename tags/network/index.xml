<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/"><channel><title>Network on Daemon365</title><link>https://daemon365.dev/tags/network/</link><description>Don't let yourself stop.</description><generator>Hugo -- gohugo.io</generator><language>zh-cn</language><lastBuildDate>Tue, 20 Jan 2026 00:00:00 +0800</lastBuildDate><atom:link href="https://daemon365.dev/tags/network/index.xml" rel="self" type="application/rss+xml"/><item><title>kubernetes CNI(Container Network Interface)</title><link>https://daemon365.dev/post/cloud/kubernetes_cni_container_network_interface/</link><pubDate>Tue, 20 Jan 2026 00:00:00 +0800</pubDate><guid>https://daemon365.dev/post/cloud/kubernetes_cni_container_network_interface/</guid><description>&lt;h2 id="为什么需要-cni"&gt;为什么需要 CNI&lt;/h2&gt;
&lt;p&gt;在 kubernetes 中，pod 的网络是使用 network namespace 隔离的，但是我们有时又需要互相访问网络，这就需要一个网络插件来实现 pod 之间的网络通信。CNI 就是为了解决这个问题而诞生的。CNI 是 Container Network Interface 的缩写，它是一个规范，定义了容器运行时如何配置网络。CNI 插件是实现了 CNI 规范的二进制文件，它可以被容器运行时调用，来配置容器的网络。&lt;/p&gt;
&lt;h2 id="cni-规范详解"&gt;CNI 规范详解&lt;/h2&gt;
&lt;h3 id="cni-的设计理念"&gt;CNI 的设计理念&lt;/h3&gt;
&lt;p&gt;CNI 的设计非常简洁，它只关注两件事：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;容器创建时&lt;/strong&gt;：为容器的网络命名空间配置网络&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;容器删除时&lt;/strong&gt;：清理容器的网络资源&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;CNI 采用了插件化的架构，这使得它具有以下优势：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;灵活性&lt;/strong&gt;：不同的环境可以选择不同的网络实现&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;可扩展性&lt;/strong&gt;：容易添加新的网络方案&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;语言无关&lt;/strong&gt;：CNI 插件可以用任何语言实现，只要遵循规范即可&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id="cni-插件的工作流程"&gt;CNI 插件的工作流程&lt;/h3&gt;
&lt;p&gt;当 kubelet 需要为 pod 配置网络时，整个流程如下：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;kubelet&lt;/strong&gt; 调用 CRI（Container Runtime Interface）创建 pod 的 sandbox 容器&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;CRI&lt;/strong&gt; 实现（如 containerd、CRI-O）创建 network namespace&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;CRI&lt;/strong&gt; 读取 CNI 配置文件（通常在 &lt;code&gt;/etc/cni/net.d/&lt;/code&gt;）&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;CRI&lt;/strong&gt; 根据配置调用相应的 CNI 插件（通常在 &lt;code&gt;/opt/cni/bin/&lt;/code&gt;）&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;CNI 插件&lt;/strong&gt; 为容器配置网络（创建 veth pair、配置 IP、设置路由等）&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;CNI 插件&lt;/strong&gt; 返回结果（IP 地址、网关、DNS 等信息）&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id="cni-配置文件示例"&gt;CNI 配置文件示例&lt;/h3&gt;
&lt;p&gt;CNI 的配置文件是 JSON 格式，一个典型的配置如下：&lt;/p&gt;</description><content:encoded><![CDATA[<h2 id="为什么需要-cni">为什么需要 CNI</h2>
<p>在 kubernetes 中，pod 的网络是使用 network namespace 隔离的，但是我们有时又需要互相访问网络，这就需要一个网络插件来实现 pod 之间的网络通信。CNI 就是为了解决这个问题而诞生的。CNI 是 Container Network Interface 的缩写，它是一个规范，定义了容器运行时如何配置网络。CNI 插件是实现了 CNI 规范的二进制文件，它可以被容器运行时调用，来配置容器的网络。</p>
<h2 id="cni-规范详解">CNI 规范详解</h2>
<h3 id="cni-的设计理念">CNI 的设计理念</h3>
<p>CNI 的设计非常简洁，它只关注两件事：</p>
<ol>
<li><strong>容器创建时</strong>：为容器的网络命名空间配置网络</li>
<li><strong>容器删除时</strong>：清理容器的网络资源</li>
</ol>
<p>CNI 采用了插件化的架构，这使得它具有以下优势：</p>
<ul>
<li><strong>灵活性</strong>：不同的环境可以选择不同的网络实现</li>
<li><strong>可扩展性</strong>：容易添加新的网络方案</li>
<li><strong>语言无关</strong>：CNI 插件可以用任何语言实现，只要遵循规范即可</li>
</ul>
<h3 id="cni-插件的工作流程">CNI 插件的工作流程</h3>
<p>当 kubelet 需要为 pod 配置网络时，整个流程如下：</p>
<ol>
<li><strong>kubelet</strong> 调用 CRI（Container Runtime Interface）创建 pod 的 sandbox 容器</li>
<li><strong>CRI</strong> 实现（如 containerd、CRI-O）创建 network namespace</li>
<li><strong>CRI</strong> 读取 CNI 配置文件（通常在 <code>/etc/cni/net.d/</code>）</li>
<li><strong>CRI</strong> 根据配置调用相应的 CNI 插件（通常在 <code>/opt/cni/bin/</code>）</li>
<li><strong>CNI 插件</strong> 为容器配置网络（创建 veth pair、配置 IP、设置路由等）</li>
<li><strong>CNI 插件</strong> 返回结果（IP 地址、网关、DNS 等信息）</li>
</ol>
<h3 id="cni-配置文件示例">CNI 配置文件示例</h3>
<p>CNI 的配置文件是 JSON 格式，一个典型的配置如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;cniVersion&#34;</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;0.4.0&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;name&#34;</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;mynet&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;type&#34;</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;bridge&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;bridge&#34;</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;cni0&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;isGateway&#34;</span><span style="color:#111">:</span> <span style="color:#00a8c8">true</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;ipMasq&#34;</span><span style="color:#111">:</span> <span style="color:#00a8c8">true</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;ipam&#34;</span><span style="color:#111">:</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;type&#34;</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;host-local&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;subnet&#34;</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;10.244.0.0/16&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;routes&#34;</span><span style="color:#111">:</span> <span style="color:#111">[</span>
</span></span><span style="display:flex;"><span>      <span style="color:#111">{</span> <span style="color:#f92672">&#34;dst&#34;</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;0.0.0.0/0&#34;</span> <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>  <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>主要字段说明：</p>
<ul>
<li><code>cniVersion</code>：CNI 规范版本</li>
<li><code>name</code>：网络名称</li>
<li><code>type</code>：插件类型（如 bridge、ipvlan、macvlan 等）</li>
<li><code>ipam</code>：IP 地址管理配置</li>
</ul>
<h3 id="cni-插件类型">CNI 插件类型</h3>
<p>CNI 插件主要分为三类：</p>
<ol>
<li>
<p><strong>Main 插件</strong>：用于创建网络接口</p>
<ul>
<li><code>bridge</code>：创建网桥</li>
<li><code>ipvlan</code>：添加 ipvlan 接口</li>
<li><code>macvlan</code>：添加 macvlan 接口</li>
<li><code>ptp</code>：创建点对点连接</li>
</ul>
</li>
<li>
<p><strong>IPAM 插件</strong>：用于 IP 地址分配</p>
<ul>
<li><code>host-local</code>：在本地维护 IP 地址池</li>
<li><code>dhcp</code>：通过 DHCP 服务器分配 IP</li>
<li><code>static</code>：使用静态 IP</li>
</ul>
</li>
<li>
<p><strong>Meta 插件</strong>：用于调用其他插件或修改配置</p>
<ul>
<li><code>flannel</code>：从 flannel daemon 获取配置</li>
<li><code>tuning</code>：调整网络接口参数</li>
<li><code>portmap</code>：配置端口映射</li>
<li><code>bandwidth</code>：限制带宽</li>
</ul>
</li>
</ol>
<h2 id="docker-网络">Docker 网络</h2>
<h3 id="基础">基础</h3>
<p>计算机五层网络如下：</p>
<p><img src="/images/4bcdd10b-42da-470b-91b0-d87746410aeb.png" alt=""></p>
<p>如果我们想把 pod 中的网络对外，首先想到的就是七层代理，比如nginx，但是我们并不知道 pod 里的网络一定是 http，甚至他可能不是tcp。所以我们像做一些网络操作，就不能在五层做了，只能在二三四层做。</p>
<h3 id="docker-实验">Docker 实验</h3>
<p>当我们在物理机上启动 docker daemon 不需要启动任何容器的时候，使用 ip a 命令查看网卡，发现多了一个 docker0</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>4: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu <span style="color:#ae81ff">1500</span> qdisc noqueue state DOWN group default
</span></span><span style="display:flex;"><span>    link/ether 02:42:9b:65:e1:01 brd ff:ff:ff:ff:ff:ff
</span></span><span style="display:flex;"><span>    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0
</span></span><span style="display:flex;"><span>       valid_lft forever preferred_lft forever
</span></span></code></pre></div><p>docker0 是一个 linux Bridge 设备，这个可以理解成一个虚拟的交换机，用来做二层网络的转发。当我们启动一个容器的时候，docker 会为这个容器创建一个 veth pair 设备，一个端口挂载在容器的 network namespace 中，另一个端口挂载在 docker0 上。这样容器就可以和 docker0 上的其他容器通信了。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker run -d --rm -it ubuntu:22.04 sleep <span style="color:#ae81ff">3000</span>
</span></span></code></pre></div><p>在物理机上查看 ip a</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>8: veth6bc75d9@if7: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span style="color:#ae81ff">1500</span> qdisc noqueue master docker0 state UP group default
</span></span><span style="display:flex;"><span>    link/ether d6:87:ca:5c:54:51 brd ff:ff:ff:ff:ff:ff link-netnsid <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    inet6 fe80::d487:caff:fe5c:5451/64 scope link
</span></span><span style="display:flex;"><span>       valid_lft forever preferred_lft forever
</span></span></code></pre></div><p>docker 容器里面 ip a</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>7: eth0@if8: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span style="color:#ae81ff">1500</span> qdisc noqueue state UP group default
</span></span><span style="display:flex;"><span>    link/ether 02:42:ac:11:00:02 brd ff:ff:ff:ff:ff:ff link-netnsid <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    inet 172.17.0.2/16 brd 172.17.255.255 scope global eth0
</span></span><span style="display:flex;"><span>       valid_lft forever preferred_lft forever
</span></span></code></pre></div><p>再启动一个 docker</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker run --name <span style="color:#111">test</span> -d --rm -it ubuntu:22.04 sleep <span style="color:#ae81ff">3000</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ip a</span>
</span></span><span style="display:flex;"><span>9: eth0@if10: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span style="color:#ae81ff">1500</span> qdisc noqueue state UP group default
</span></span><span style="display:flex;"><span>    link/ether 02:42:ac:11:00:03 brd ff:ff:ff:ff:ff:ff link-netnsid <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    inet 172.17.0.3/16 brd 172.17.255.255 scope global eth0
</span></span><span style="display:flex;"><span>       valid_lft forever preferred_lft forever
</span></span></code></pre></div><p>这样两个容器就可以通过 docker0 通信了。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>root@b19a3dc4b32d:/# ping  172.17.0.2
</span></span><span style="display:flex;"><span>PING 172.17.0.2 <span style="color:#f92672">(</span>172.17.0.2<span style="color:#f92672">)</span> 56<span style="color:#f92672">(</span>84<span style="color:#f92672">)</span> bytes of data.
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">64</span> bytes from 172.17.0.2: <span style="color:#111">icmp_seq</span><span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> <span style="color:#111">ttl</span><span style="color:#f92672">=</span><span style="color:#ae81ff">64</span> <span style="color:#111">time</span><span style="color:#f92672">=</span>0.055 ms
</span></span></code></pre></div><h3 id="通信方式">通信方式</h3>
<p><img src="/images/a6754f75-f177-42d3-b9d3-0d362ef038a9.png" alt=""></p>
<h2 id="常见-cni-插件对比">常见 CNI 插件对比</h2>
<p>在了解具体的网络实现之前，我们先来看看业界常用的 CNI 插件及其特点：</p>
<h2 id="cni-网络">CNI 网络</h2>
<p>当两个 pod 在同一 node 上的时候，我们可以使用像上述 docker 的 bridge 的方式通信是没问题的。但是 kubernetes 是多节点的集群，当 pod 在不同的 node 上的时候，直接通信肯定不行了，这时候我们需要一些办法来解决这个问题。</p>
<h3 id="udp-封包">UDP 封包</h3>
<p>当 pod 在不同节点上的时候，两个 pod 不可以直接通信，那最简单的方式就是通过 udp 封包，把整个网络包使用 udp 封包起来，然后第二个节点再解包，然后发给网桥。</p>
<p><img src="/images/2fca7256-2cac-436f-a379-4e12891fac39.png" alt=""></p>
<p>整个过程就是 node1 上的 pod 把网络包封装，然后由于 <code>process</code> 再封装发给 node2，node2 再解包，然后发给 pod2。</p>
<p>process 是 cni 实现的进程，很多 cni 都实现 udp 封包的方式，比如 flannel,cailco 等。</p>
<p>至于我们怎么知道目标 ip （pod 的 ip） 是在哪台主机上，这个就有很多中方式了，比如把每台机器发配 ip 分配不同的网段，甚至于把这些对应关系写到 etcd 中。</p>
<h3 id="vxlan">VXLAN</h3>
<p>上述的 udp 封包方式，是可以满足基本需求但是。cni 创建的 process 进程是一个用户态的进程，每个包要在 node1 上从内核态 copy 到用户态，然后再封包，再 copy 到内核态，再发给 node2，再从内核态 copy 到用户态，再解包，再 copy 到内核态，再发给 pod2。这样的方式效率很低。所以我们使用一种更加高效的方式，就是 vxlan。</p>
<p><strong>VXLAN 是什么?</strong></p>
<p>VXLAN（Virtual Extensible LAN）是一种网络虚拟化技术，用于解决大规模云计算环境中的网络隔离、扩展性和灵活性问题。VXLAN 允许网络工程师在现有的网络架构上创建一个逻辑网络层，这可以使得数据中心的网络设计变得更加灵活和可扩展。</p>
<p><strong>为什么性能会高？</strong></p>
<p>VXLAN 是在内核态实现的，原理和 udp 封包一样，只不过是在内核态实现的，数据包不会在内核态和用户态之间 copy，所以效率会高很多。</p>
<h3 id="ip-路由">ip 路由</h3>
<p>就算是 vxlan，也是需要封包和解包的，这样的方式效率还是不够高，所以我们可以使用 ip 路由的方式。</p>
<p>ip 路由故名思意，就是使用路由表来实现 pod 之间的通信。这样的方式效率最高，但是配置比较复杂，需要配置路由表。</p>
<p>而且路由表跳转是二层网络实现的，所以又要要求所有 node 在同一个二层网络中。</p>
<p><img src="/images/7be8c8c9-a60b-4717-9f5a-a3e6f44ebed9.png" alt=""></p>
<p>查看 node1 上的 container 的是设备</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-BASH" data-lang="BASH"><span style="display:flex;"><span>ip a
</span></span><span style="display:flex;"><span>2: eth0@if10: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span style="color:#ae81ff">1500</span> qdisc noqueue state UP group default qlen <span style="color:#ae81ff">1000</span>
</span></span><span style="display:flex;"><span>    link/ether 66:5e:d8:8d:86:ba brd ff:ff:ff:ff:ff:ff link-netnsid <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    inet 172.10.184.69/32 scope global eth0
</span></span><span style="display:flex;"><span>       valid_lft forever preferred_lft forever
</span></span><span style="display:flex;"><span>    inet6 fe80::645e:d8ff:fe8d:86ba/64 scope link
</span></span><span style="display:flex;"><span>       valid_lft forever preferred_lft forever
</span></span></code></pre></div><p>这个和主机上是对应的是一个 veth pair 设备，一个端口挂载在容器的 network namespace 中，一边挂载在主机上。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 主机</span>
</span></span><span style="display:flex;"><span>ip a
</span></span><span style="display:flex;"><span>10: calia78b8700057@if2: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span style="color:#ae81ff">1500</span> qdisc noqueue state UP group default qlen <span style="color:#ae81ff">1000</span>
</span></span><span style="display:flex;"><span>    link/ether ee:ee:ee:ee:ee:ee brd ff:ff:ff:ff:ff:ff link-netns cni-0da431c8-dd8b-ca68-55e6-40b04acf78d6
</span></span><span style="display:flex;"><span>    inet6 fe80::ecee:eeff:feee:eeee/64 scope link
</span></span><span style="display:flex;"><span>       valid_lft forever preferred_lft forever
</span></span></code></pre></div><p>当 pod 中的数据包来到主机 查看 node1 上的路由表 会命中一下这条路由 这条的意思是跳到<code>192.168.229.102</code>节点使用 ens33 设备</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ip r
</span></span><span style="display:flex;"><span>172.10.190.0/26 via 192.168.229.102 dev ens33 proto bird
</span></span></code></pre></div><p>当 数据包来到 node2 上的时候 我们看下 node2 的路由表</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-BASH" data-lang="BASH"><span style="display:flex;"><span>ip r
</span></span><span style="display:flex;"><span>172.10.190.2 dev calie28ee63d6b0 scope link
</span></span><span style="display:flex;"><span>ip a
</span></span><span style="display:flex;"><span>7: calie28ee63d6b0@if2: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span style="color:#ae81ff">1500</span> qdisc noqueue state UP group default qlen <span style="color:#ae81ff">1000</span>
</span></span><span style="display:flex;"><span>    link/ether ee:ee:ee:ee:ee:ee brd ff:ff:ff:ff:ff:ff link-netns cni-dd892c92-1826-f648-2b8c-d22618311ca9
</span></span><span style="display:flex;"><span>    inet6 fe80::ecee:eeff:feee:eeee/64 scope link
</span></span><span style="display:flex;"><span>       valid_lft forever preferred_lft forever
</span></span></code></pre></div><p>这个设备是 veth pair 设备，对应的容器内的</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-BASH" data-lang="BASH"><span style="display:flex;"><span>ip a
</span></span><span style="display:flex;"><span>2: eth0@if7: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span style="color:#ae81ff">1500</span> qdisc noqueue state UP group default qlen <span style="color:#ae81ff">1000</span>
</span></span><span style="display:flex;"><span>    link/ether fa:a6:2f:97:58:28 brd ff:ff:ff:ff:ff:ff link-netnsid <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    inet 172.10.190.2/32 scope global eth0
</span></span><span style="display:flex;"><span>       valid_lft forever preferred_lft forever
</span></span><span style="display:flex;"><span>    inet6 fe80::f8a6:2fff:fe97:5828/64 scope link
</span></span><span style="display:flex;"><span>       valid_lft forever preferred_lft forever
</span></span></code></pre></div><p>这样node2上的 172.10.190.2 pod 就可以收到数据包了。</p>
<h4 id="路由跳转">路由跳转</h4>
<p>路由跳转是怎么实现的？</p>
<p>路由跳转是通过路由表来实现的，它作用在二层上，所以当跳转的时候，直接修改数据包的目标 mac 地址（如果不知道的话是使用 ARP 协议获得）。</p>
<p>所以当我们访问百度的时候，获得百度的ip的时候，数据包会经过很多路由器，每个路由器都会修改数据包的目标 mac 地址，这样数据包就可以到达百度的服务器了。</p>
<h4 id="felix">Felix</h4>
<p>那么主机上的路由表是怎么来的呢？</p>
<p>这个就是 cni 的实现了，cni 会调用 felix 这个进程，felix 会根据 cni 的配置来配置路由表。</p>
<h3 id="ip-in-ip">ip in ip</h3>
<p>刚才也说过了，ip 路由是最高效的，是因为它作用在二层网络上，这就需要保证所有的 node 在同一个二层网络上。但是有时候我们的 node 不在同一个二层网络上，这时候我们可以使用 ip in ip。</p>
<p>简单来说就是如果 node 之间在一个二层网络上，那么就直接使用 ip 路由，如果不在，那么就使用 ip in ip，把数据包封装起来，然后再发给对应的 node。</p>
<p>ip-in-ip 是一种隧道技术，它将一个 IP 数据包封装在另一个 IP 数据包中，这样就可以在一个 IP 网络上传输另一个 IP 网络的数据包。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>172.10.180.0/24 via 192.168.228.28 tunl0
</span></span></code></pre></div><p><img src="/images/62ebd840-1785-46f6-bd04-7b4e78c8cc0b.png" alt=""></p>
<p>这个只是在源数据包的三层上再封装一层 IP 头部。相比 VXLAN（封装完整的二层以太网帧），IP-in-IP 只封装 IP 头，开销更小。这样性能方面稍微比使用了 UDP 的 VXLAN 要好一点。但是最好还是避免使用 IP-in-IP，尽量保证 node 在同一个二层网络上。</p>
<h3 id="我怎么知道-pod-ip-在哪台机器上">我怎么知道 Pod IP 在哪台机器上？</h3>
<p>在 Kubernetes 集群中，Pod IP 是一个 虚拟的、动态分配的地址。
当一个数据包需要从一个 Pod 发送到另一个 Pod 时，网络系统必须知道：</p>
<p><code>目标 Pod IP 实际运行在哪一台 Node 上？</code></p>
<p>只有解决了这个问题，数据包才能被正确地转发到对应的节点。
常见的实现思路主要有以下三种。</p>
<p><strong>1.维护 Pod IP → Node 的映射关系</strong></p>
<p>最直接的方式，是显式维护 Pod IP 与 Node 之间的对应关系。</p>
<p>例如：</p>
<ul>
<li>将 Pod IP → Node IP 的映射存储到
<ul>
<li>数据库</li>
<li>etcd</li>
<li>Kubernetes CRD（自定义资源）</li>
</ul>
</li>
<li>当需要转发流量时，先查询映射关系，再决定下一跳</li>
</ul>
<p>这种方式的优点是<strong>逻辑直观、可控性强</strong>，但缺点也很明显：</p>
<ul>
<li>Pod 创建、销毁频繁，映射关系变化快</li>
<li>需要额外的控制面组件来维护一致性</li>
<li>查询与同步本身会带来额外开销</li>
</ul>
<p>因此，这种方案在大规模集群中实现成本较高。</p>
<p><strong>2.以 Node 为单位划分 Pod CIDR</strong></p>
<p>另一种更常见、也更高效的方式，是<strong>按 Node 维度分配 Pod 网段</strong>。</p>
<p>例如：</p>
<ul>
<li>Node A：172.16.100.0/26</li>
<li>Node B：172.16.100.64/26</li>
<li>Node C：172.16.100.128/26</li>
</ul>
<p>在这种模式下：</p>
<ul>
<li>每个 Node 只负责一个固定的 Pod CIDR</li>
<li>只要看到目标 IP 落在哪个 CIDR 中，就能确定对应的 Node</li>
<li>不需要维护单个 Pod 级别的映射关系</li>
</ul>
<p>这种方案的优势在于：</p>
<ul>
<li>路由规则简单</li>
<li>查询效率高</li>
<li>非常适合 Host-Gateway、直连路由 等网络模型</li>
</ul>
<p>这也是 Kubernetes 中 最常见的 Pod IP 定位方式。</p>
<p><strong>3.通过 BGP 动态交换路由信息</strong></p>
<p>在更复杂或规模更大的集群中，通常会引入 BGP（Border Gateway Protocol） 来动态分发路由。</p>
<p>其核心思想是：</p>
<ul>
<li>每个 Node 将自己负责的 Pod CIDR 通过 BGP 广播出去</li>
<li>其他 Node 或上游物理网络设备自动学习这些路由</li>
<li>当 Pod 迁移或节点变化时，路由信息可以自动收敛</li>
</ul>
<p>这种方式的特点是：</p>
<ul>
<li>不需要集中维护映射关系</li>
<li>路由自动学习、自动更新</li>
<li>可与数据中心网络或云网络无缝打通</li>
</ul>
<p>像 Calico（BGP 模式） 就大量使用了这种方案。</p>
<p>当然，代价是：</p>
<ul>
<li>对网络设备和运维能力要求较高</li>
<li>排错和理解成本相对更大</li>
</ul>
<p>Calico encapsulation</p>
<ul>
<li>None： 纯路由</li>
<li>IPIP</li>
<li>VXLAN</li>
<li>IPIPCrossSubnet</li>
<li>VXLANCrossSubnet
IPIPCrossSubnet 和 VXLANCrossSubnet 为同一网段的 node 用路由转发通信 ，否则使用 ipip （vxlan）</li>
</ul>
<h2 id="ebpf">eBPF</h2>
<p><img src="/images/ebpf_netfilter_hooks.jpg" alt=""></p>
<h3 id="为什么需要-ebpf-">为什么需要 eBPF ？</h3>
<p>在传统的 Kubernetes 网络模型中，流量转发高度依赖内核的 Netfilter (iptables/nftables)。但随着集群规模的扩大，这种机制暴露了两个核心痛点：</p>
<ol>
<li>性能瓶颈：每一个数据包经过节点（Node）时，都需要在 Netfilter 和 Conntrack 复杂的规则链中逐一匹配。这种“全量遍历”在大规模 Service 环境下会带来显著的延迟。</li>
<li>调试困难：iptables 规则像一个黑盒，在大流量场景下追踪一个包的去向极其痛苦，可观测性较差。</li>
</ol>
<h3 id="calico-在-vxlan-crosssubnet-模式下如何利用-ebpf">Calico 在 VXLAN (CrossSubnet) 模式下如何利用 eBPF？</h3>
<p>在开启 eBPF 模式后，Calico 会绕过传统的 Netfilter 路径，直接在 tc (Traffic Control) hook （veth-pair host端网卡 egress） 点挂载 eBPF 程序，实现对 Pod 流量的“精准劫持”和快速转发。
核心转发逻辑分解
当一个 Pod 发出的数据包到达主机的 eBPF 程序时，它会进行以下“三步走”的逻辑判断：</p>
<p><strong>第一步</strong>：判断是否为本地流量</p>
<ul>
<li>如果目标容器就在当前节点上，eBPF 直接将包重定向到对应的 veth pair</li>
</ul>
<p><strong>第二步</strong>：判断是否为同网段（二层直连）</p>
<ul>
<li>eBPF 会修改数据包的二层 MAC 地址，直接通过默认物理网卡发送出去。</li>
</ul>
<p><strong>第三步</strong>：跨网段转发（VXLAN 封包）</p>
<ul>
<li>eBPF 自动进行 UDP 封包（符合 VXLAN 格式）。</li>
<li>外层封包格式
<ul>
<li>UDP 头部：目标端口通常为 4789（标准 VXLAN 端口）</li>
<li>VXLAN 头部：包含 VNI（Virtual Network Identifier）</li>
<li>外层 IP 头部：
<ul>
<li>源 IP：当前物理节点的网卡 IP</li>
<li>目标 IP：目标 Pod 所在的远端物理节点网卡 IP。</li>
</ul>
</li>
<li>外层 MAC 头部：
<ul>
<li>源 MAC：当前物理网卡的 MAC 地址。</li>
<li>目标 MAC：下一跳（通常是本地网关）的 MAC 地址。</li>
</ul>
</li>
</ul>
</li>
<li>封装完成后，直接将隧道包转交给物理网卡发出。</li>
</ul>
<h3 id="calico-felix-代码">calico felix 代码</h3>
<p><img src="/images/calico-felix-ebpf.png" alt=""></p>
<p>入口</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">/* calico_tc_main is the main function used in all of the tc programs.  It is specialised
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * for particular hook at build time based on the CALI_F build flags.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">SEC</span><span style="color:#111">(</span><span style="color:#d88200">&#34;tc&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">int</span> <span style="color:#75af00">calico_tc_main</span><span style="color:#111">(</span><span style="color:#00a8c8">struct</span> <span style="color:#75af00">__sk_buff</span> <span style="color:#f92672">*</span><span style="color:#75af00">skb</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 检查是否为环回流量</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#111">(</span><span style="color:#75af00">CALI_F_LO</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">CALI_F_TO_HOST</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/* Do nothing, it is a packet that just looped around. */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">TC_ACT_UNSPEC</span><span style="color:#111">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">finalize</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#75af00">forward_or_drop</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">);</span>
</span></span><span style="display:flex;"><span>     
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-GO" data-lang="GO"><span style="display:flex;"><span><span style="color:#75715e">/* 尝试将数据包重定向到同节点的 Pod（peer） */</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">static</span> <span style="color:#75af00">CALI_BPF_INLINE</span> <span style="color:#00a8c8">int</span> <span style="color:#75af00">try_redirect_to_peer</span><span style="color:#111">(</span><span style="color:#00a8c8">struct</span> <span style="color:#75af00">cali_tc_ctx</span> <span style="color:#f92672">*</span><span style="color:#75af00">ctx</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 检查是否启用 peer 重定向</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">bool</span> <span style="color:#75af00">redirect_peer</span> <span style="color:#111">=</span> <span style="color:#75af00">GLOBAL_FLAGS</span> <span style="color:#f92672">&amp;</span> <span style="color:#75af00">CALI_GLOBALS_REDIRECT_PEER</span><span style="color:#111">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ......</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">rc</span> <span style="color:#111">=</span> <span style="color:#75af00">bpf_redirect_peer</span><span style="color:#111">(</span><span style="color:#75af00">state</span><span style="color:#f92672">-</span><span style="color:#111">&gt;</span><span style="color:#75af00">ct_result</span><span style="color:#111">.</span><span style="color:#75af00">ifindex_fwd</span><span style="color:#111">,</span> <span style="color:#ae81ff">0</span><span style="color:#111">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//......</span>
</span></span><span style="display:flex;"><span>         
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-GO" data-lang="GO"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 1. 执行 FIB  查找</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">*</span><span style="color:#75af00">fib_params</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">)</span> <span style="color:#111">=</span> <span style="color:#111">(</span><span style="color:#00a8c8">struct</span> <span style="color:#75af00">bpf_fib_lookup</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">.</span><span style="color:#75af00">family</span> <span style="color:#111">=</span> <span style="color:#ae81ff">2</span><span style="color:#111">,</span>  <span style="color:#75715e">// AF_INET</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">.</span><span style="color:#75af00">ifindex</span> <span style="color:#111">=</span> <span style="color:#75af00">ctx</span><span style="color:#f92672">-</span><span style="color:#111">&gt;</span><span style="color:#75af00">skb</span><span style="color:#f92672">-</span><span style="color:#111">&gt;</span><span style="color:#75af00">ifindex</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">.</span><span style="color:#75af00">ipv4_src</span> <span style="color:#111">=</span> <span style="color:#75af00">state</span><span style="color:#f92672">-</span><span style="color:#111">&gt;</span><span style="color:#75af00">ip_src</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">.</span><span style="color:#75af00">ipv4_dst</span> <span style="color:#111">=</span> <span style="color:#75af00">state</span><span style="color:#f92672">-</span><span style="color:#111">&gt;</span><span style="color:#75af00">ip_dst</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span><span style="color:#111">};</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#75af00">rc</span> <span style="color:#111">=</span> <span style="color:#75af00">bpf_fib_lookup</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#f92672">-</span><span style="color:#111">&gt;</span><span style="color:#75af00">skb</span><span style="color:#111">,</span> <span style="color:#75af00">fib_params</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">),</span> <span style="color:#75af00">sizeof</span><span style="color:#111">(</span><span style="color:#00a8c8">struct</span> <span style="color:#75af00">bpf_fib_lookup</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#75af00">BPF_FIB_LOOKUP_SKIP_NEIGH</span><span style="color:#111">);</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 2. 赋值</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">nh_params</span><span style="color:#111">.</span><span style="color:#75af00">ipv4_nh</span> <span style="color:#111">=</span> <span style="color:#75af00">fib_params</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">)</span><span style="color:#f92672">-</span><span style="color:#111">&gt;</span><span style="color:#75af00">ipv4_dst</span><span style="color:#111">;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 3. 使用 bpf 函数直接转发</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">rc</span> <span style="color:#111">=</span> <span style="color:#75af00">bpf_redirect_neigh</span><span style="color:#111">(</span><span style="color:#75af00">fib_params</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">)</span><span style="color:#f92672">-</span><span style="color:#111">&gt;</span><span style="color:#75af00">ifindex</span><span style="color:#111">,</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">nh_params</span><span style="color:#111">,</span> <span style="color:#f92672">...</span><span style="color:#111">);</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-GO" data-lang="GO"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 1. VXLAN 封装</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#111">(</span><span style="color:#75af00">vxlan_encap</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">STATE</span><span style="color:#f92672">-</span><span style="color:#111">&gt;</span><span style="color:#75af00">ip_src</span><span style="color:#111">,</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">STATE</span><span style="color:#f92672">-</span><span style="color:#111">&gt;</span><span style="color:#75af00">ip_dst</span><span style="color:#111">,</span> <span style="color:#75af00">vxlan_src_port</span><span style="color:#111">))</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">deny_reason</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">CALI_REASON_ENCAP_FAIL</span><span style="color:#111">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">goto</span> <span style="color:#75af00">deny</span><span style="color:#111">;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 2. 设置隧道元数据</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">struct</span> <span style="color:#75af00">bpf_tunnel_key</span> <span style="color:#75af00">key</span> <span style="color:#111">=</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">.</span><span style="color:#75af00">tunnel_id</span> <span style="color:#111">=</span> <span style="color:#75af00">OVERLAY_TUNNEL_ID</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">.</span><span style="color:#75af00">remote_ipv4</span> <span style="color:#111">=</span> <span style="color:#75af00">bpf_htonl</span><span style="color:#111">(</span><span style="color:#75af00">dest_rt</span><span style="color:#f92672">-</span><span style="color:#111">&gt;</span><span style="color:#75af00">next_hop</span><span style="color:#111">),</span> <span style="color:#75715e">// 下一跳 VTEP IP</span>
</span></span><span style="display:flex;"><span><span style="color:#111">};</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">bpf_skb_set_tunnel_key</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#f92672">-</span><span style="color:#111">&gt;</span><span style="color:#75af00">skb</span><span style="color:#111">,</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">key</span><span style="color:#111">,</span> <span style="color:#75af00">size</span><span style="color:#111">,</span> <span style="color:#75af00">BPF_F_ZERO_CSUM_TX</span><span style="color:#111">);</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 3. 重定向到物理网卡</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">rc</span> <span style="color:#111">=</span> <span style="color:#75af00">bpf_redirect</span><span style="color:#111">(</span><span style="color:#75af00">state</span><span style="color:#f92672">-</span><span style="color:#111">&gt;</span><span style="color:#75af00">ct_result</span><span style="color:#111">.</span><span style="color:#75af00">ifindex_fwd</span><span style="color:#111">,</span> <span style="color:#ae81ff">0</span><span style="color:#111">);</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* VXLAN 封装函数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * ctx: 上下文
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * ip_src: 外层源 IP
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * ip_dst: 外层目标 IP
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * src_port: VXLAN 源端口
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">static</span> <span style="color:#75af00">CALI_BPF_INLINE</span> <span style="color:#00a8c8">int</span> <span style="color:#75af00">vxlan_encap</span><span style="color:#111">(</span><span style="color:#00a8c8">struct</span> <span style="color:#75af00">cali_tc_ctx</span> <span style="color:#f92672">*</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>                                       <span style="color:#75af00">__be32</span> <span style="color:#f92672">*</span><span style="color:#75af00">ip_src</span><span style="color:#111">,</span> <span style="color:#75af00">__be32</span> <span style="color:#f92672">*</span><span style="color:#75af00">ip_dst</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>                                       <span style="color:#75af00">__u16</span> <span style="color:#75af00">src_port</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75715e">// ....</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div>]]></content:encoded><category>cloud</category><category>cni</category><category>kubernetes</category><category>network</category></item><item><title>http和https</title><link>https://daemon365.dev/post/network/http_and_https/</link><pubDate>Wed, 25 Jan 2023 00:00:00 +0800</pubDate><guid>https://daemon365.dev/post/network/http_and_https/</guid><description>&lt;h2 id="http协议是什么"&gt;HTTP协议是什么？&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;HTTP协议是&lt;strong&gt;超文本传输协议&lt;/strong&gt;的缩写，英文是Hyper Text Transfer Protocol。它是从WEB服务器传输超文本标记语言(HTML)到本地浏览器的传送协议。&lt;/li&gt;
&lt;li&gt;设计HTTP最初的目的是为了提供一种发布和接收HTML页面的方法。&lt;/li&gt;
&lt;li&gt;HTPP有多个版本，目前广泛使用的是HTTP/1.1版本。&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="http原理"&gt;HTTP原理&lt;/h2&gt;
&lt;p&gt;HTTP是一个基于TCP/IP通信协议来传递数据的协议，传输的数据类型为HTML 文件,、图片文件, 查询结果等。&lt;/p&gt;
&lt;p&gt;HTTP协议一般用于B/S架构（）。浏览器作为HTTP客户端通过URL向HTTP服务端即WEB服务器发送所有请求。&lt;/p&gt;
&lt;p&gt;我们以访问百度为例：&lt;/p&gt;
&lt;p&gt;&lt;img src="https://daemon365.dev/images/6f6c5ed8-1262-4b44-83a0-c18902821752.png" alt=""&gt;访问百度流程&lt;/p&gt;
&lt;h2 id="http1和http2"&gt;http1.*和http2&lt;/h2&gt;
&lt;p&gt;&lt;img src="https://daemon365.dev/images/b609c812-112f-4e02-8dc1-db7301b03b56.png" alt=""&gt;&lt;/p&gt;
&lt;p&gt;这个Akamai公司建立的一个官方的演示，使用HTTP/1.1和HTTP/2同时请求379张图片，观察请求的时间，明显看出HTTP/2性能占优势。&lt;/p&gt;
&lt;p&gt;&lt;img src="https://daemon365.dev/images/cb0773c4-64c5-4f4a-9bdf-d9af8265f048.png" alt=""&gt;&lt;/p&gt;
&lt;p&gt;多路复用：通过单一的HTTP/2连接请求发起多重的请求-响应消息，多个请求stream共享一个TCP连接，实现多流并行而不是依赖建立多个TCP连接。&lt;/p&gt;
&lt;p&gt;HTTP报文格式&lt;/p&gt;
&lt;p&gt;&lt;img src="https://daemon365.dev/images/abe7991d-7084-403b-91b6-85d9875e93ba.png" alt=""&gt;&lt;/p&gt;
&lt;h2 id="http特点"&gt;HTTP特点&lt;/h2&gt;
&lt;ol&gt;
&lt;li&gt;http协议支持客户端/服务端模式，也是一种请求/响应模式的协议。&lt;/li&gt;
&lt;li&gt;简单快速：客户向服务器请求服务时，只需传送请求方法和路径。请求方法常用的有GET、HEAD、POST。&lt;/li&gt;
&lt;li&gt;灵活：HTTP允许传输任意类型的数据对象。传输的类型由Content-Type加以标记。&lt;/li&gt;
&lt;li&gt;无连接：限制每次连接只处理一个请求。服务器处理完请求，并收到客户的应答后，即断开连接，但是却不利于客户端与服务器保持会话连接，为了弥补这种不足，产生了两项记录http状态的技术，一个叫做Cookie,一个叫做Session。&lt;/li&gt;
&lt;li&gt;无状态：无状态是指协议对于事务处理没有记忆，后续处理需要前面的信息，则必须重传。&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id="为什么要用https"&gt;为什么要用https？&lt;/h2&gt;
&lt;p&gt;实际使用中，绝大说的网站现在都采用的是https协议，这也是未来互联网发展的趋势。下面是通过wireshark抓取的一个博客网站的登录请求过程。&lt;/p&gt;
&lt;p&gt;&lt;img src="https://daemon365.dev/images/0165bba8-ae95-4577-9d6f-ce1ac4aa1224.png" alt=""&gt;博客登录抓包&lt;/p&gt;
&lt;p&gt;可以看到访问的账号密码都是明文传输， 这样客户端发出的请求很容易被不法分子截取利用，因此，HTTP协议不适合传输一些敏感信息，比如：各种账号、密码等信息，使用http协议传输隐私信息非常不安全。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;一般http中存在如下问题：&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;请求信息明文传输，容易被窃听截取。&lt;/li&gt;
&lt;li&gt;数据的完整性未校验，容易被篡改&lt;/li&gt;
&lt;li&gt;没有验证对方身份，存在冒充危险&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="什么是https"&gt;什么是HTTPS?&lt;/h2&gt;
&lt;p&gt;为了解决上述HTTP存在的问题，就用到了HTTPS。&lt;/p&gt;
&lt;p&gt;HTTPS 协议（HyperText Transfer Protocol over Secure Socket Layer）：一般理解为HTTP+SSL/TLS，通过 SSL证书来验证服务器的身份，并为浏览器和服务器之间的通信进行加密。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;那么SSL又是什么？&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;SSL（Secure Socket Layer，安全套接字层）：1994年为 Netscape 所研发，SSL 协议位于 TCP/IP 协议与各种应用层协议之间，为数据通讯提供安全支持。&lt;/p&gt;
&lt;p&gt;TLS（Transport Layer Security，传输层安全）：其前身是 SSL，它最初的几个版本（SSL 1.0、SSL 2.0、SSL 3.0）由网景公司开发，1999年从 3.1 开始被 IETF 标准化并改名，发展至今已经有 TLS 1.0、TLS 1.1、TLS 1.2 三个版本。SSL3.0和TLS1.0由于存在安全漏洞，已经很少被使用到。TLS 1.3 改动会比较大，目前还在草案阶段，目前使用最广泛的是TLS 1.1、TLS 1.2。&lt;/p&gt;</description><content:encoded><![CDATA[<h2 id="http协议是什么">HTTP协议是什么？</h2>
<ul>
<li>HTTP协议是<strong>超文本传输协议</strong>的缩写，英文是Hyper Text Transfer Protocol。它是从WEB服务器传输超文本标记语言(HTML)到本地浏览器的传送协议。</li>
<li>设计HTTP最初的目的是为了提供一种发布和接收HTML页面的方法。</li>
<li>HTPP有多个版本，目前广泛使用的是HTTP/1.1版本。</li>
</ul>
<h2 id="http原理">HTTP原理</h2>
<p>HTTP是一个基于TCP/IP通信协议来传递数据的协议，传输的数据类型为HTML 文件,、图片文件, 查询结果等。</p>
<p>HTTP协议一般用于B/S架构（）。浏览器作为HTTP客户端通过URL向HTTP服务端即WEB服务器发送所有请求。</p>
<p>我们以访问百度为例：</p>
<p><img src="/images/6f6c5ed8-1262-4b44-83a0-c18902821752.png" alt="">访问百度流程</p>
<h2 id="http1和http2">http1.*和http2</h2>
<p><img src="/images/b609c812-112f-4e02-8dc1-db7301b03b56.png" alt=""></p>
<p>这个Akamai公司建立的一个官方的演示，使用HTTP/1.1和HTTP/2同时请求379张图片，观察请求的时间，明显看出HTTP/2性能占优势。</p>
<p><img src="/images/cb0773c4-64c5-4f4a-9bdf-d9af8265f048.png" alt=""></p>
<p>多路复用：通过单一的HTTP/2连接请求发起多重的请求-响应消息，多个请求stream共享一个TCP连接，实现多流并行而不是依赖建立多个TCP连接。</p>
<p>HTTP报文格式</p>
<p><img src="/images/abe7991d-7084-403b-91b6-85d9875e93ba.png" alt=""></p>
<h2 id="http特点">HTTP特点</h2>
<ol>
<li>http协议支持客户端/服务端模式，也是一种请求/响应模式的协议。</li>
<li>简单快速：客户向服务器请求服务时，只需传送请求方法和路径。请求方法常用的有GET、HEAD、POST。</li>
<li>灵活：HTTP允许传输任意类型的数据对象。传输的类型由Content-Type加以标记。</li>
<li>无连接：限制每次连接只处理一个请求。服务器处理完请求，并收到客户的应答后，即断开连接，但是却不利于客户端与服务器保持会话连接，为了弥补这种不足，产生了两项记录http状态的技术，一个叫做Cookie,一个叫做Session。</li>
<li>无状态：无状态是指协议对于事务处理没有记忆，后续处理需要前面的信息，则必须重传。</li>
</ol>
<h2 id="为什么要用https">为什么要用https？</h2>
<p>实际使用中，绝大说的网站现在都采用的是https协议，这也是未来互联网发展的趋势。下面是通过wireshark抓取的一个博客网站的登录请求过程。</p>
<p><img src="/images/0165bba8-ae95-4577-9d6f-ce1ac4aa1224.png" alt="">博客登录抓包</p>
<p>可以看到访问的账号密码都是明文传输， 这样客户端发出的请求很容易被不法分子截取利用，因此，HTTP协议不适合传输一些敏感信息，比如：各种账号、密码等信息，使用http协议传输隐私信息非常不安全。</p>
<p><strong>一般http中存在如下问题：</strong></p>
<ul>
<li>请求信息明文传输，容易被窃听截取。</li>
<li>数据的完整性未校验，容易被篡改</li>
<li>没有验证对方身份，存在冒充危险</li>
</ul>
<h2 id="什么是https">什么是HTTPS?</h2>
<p>为了解决上述HTTP存在的问题，就用到了HTTPS。</p>
<p>HTTPS 协议（HyperText Transfer Protocol over Secure Socket Layer）：一般理解为HTTP+SSL/TLS，通过 SSL证书来验证服务器的身份，并为浏览器和服务器之间的通信进行加密。</p>
<p><strong>那么SSL又是什么？</strong></p>
<p>SSL（Secure Socket Layer，安全套接字层）：1994年为 Netscape 所研发，SSL 协议位于 TCP/IP 协议与各种应用层协议之间，为数据通讯提供安全支持。</p>
<p>TLS（Transport Layer Security，传输层安全）：其前身是 SSL，它最初的几个版本（SSL 1.0、SSL 2.0、SSL 3.0）由网景公司开发，1999年从 3.1 开始被 IETF 标准化并改名，发展至今已经有 TLS 1.0、TLS 1.1、TLS 1.2 三个版本。SSL3.0和TLS1.0由于存在安全漏洞，已经很少被使用到。TLS 1.3 改动会比较大，目前还在草案阶段，目前使用最广泛的是TLS 1.1、TLS 1.2。</p>
<p><strong>SSL发展史（互联网加密通信）</strong></p>
<ol>
<li>1994年NetSpace公司设计SSL协议（Secure Sockets Layout）1.0版本，但未发布。</li>
<li>1995年NetSpace发布SSL/2.0版本，很快发现有严重漏洞</li>
<li>1996年发布SSL/3.0版本，得到大规模应用</li>
<li>1999年，发布了SSL升级版TLS/1.0版本，目前应用最广泛的版本</li>
<li>2006年和2008年，发布了TLS/1.1版本和TLS/1.2版本</li>
</ol>
<h2 id="浏览器在使用https传输数据的流程是什么">浏览器在使用HTTPS传输数据的流程是什么？</h2>
<p><img src="/images/18415c33-f5e7-4033-8343-1e927b670f7b.png" alt="">
HTTPS数据传输流程</p>
<ol>
<li>首先客户端通过URL访问服务器建立SSL连接。</li>
<li>服务端收到客户端请求后，会将网站支持的证书信息（证书中包含公钥）传送一份给客户端。</li>
<li>客户端的服务器开始协商SSL连接的安全等级，也就是信息加密的等级。</li>
<li>客户端的浏览器根据双方同意的安全等级，建立会话密钥，然后利用网站的公钥将会话密钥加密，并传送给网站。</li>
<li>服务器利用自己的私钥解密出会话密钥。</li>
<li>服务器利用会话密钥加密与客户端之间的通信。</li>
</ol>
<h2 id="https的缺点">HTTPS的缺点</h2>
<ul>
<li>HTTPS协议多次握手，导致页面的加载时间延长近50%；</li>
<li>HTTPS连接缓存不如HTTP高效，会增加数据开销和功耗；</li>
<li>申请SSL证书需要钱，功能越强大的证书费用越高。</li>
<li>SSL涉及到的安全算***消耗 CPU 资源，对服务器资源消耗较大。</li>
</ul>
<h2 id="总结https和http的区别">总结HTTPS和HTTP的区别</h2>
<ul>
<li>HTTPS是HTTP协议的安全版本，HTTP协议的数据传输是明文的，是不安全的，HTTPS使用了SSL/TLS协议进行了加密处理。</li>
<li>http和https使用连接方式不同，默认端口也不一样，http是80，https是443。</li>
</ul>
<p>参考文章:</p>
<ul>
<li><a href="https://zhuanlan.zhihu.com/p/72616216">https://zhuanlan.zhihu.com/p/72616216</a></li>
<li><a href="https://baijiahao.baidu.com/s?id=1673721127616042356">https://baijiahao.baidu.com/s?id=1673721127616042356</a></li>
</ul>
]]></content:encoded><category>network</category><category>network</category></item><item><title>网络编程</title><link>https://daemon365.dev/post/network/network_programming/</link><pubDate>Sat, 21 Dec 2019 00:00:00 +0800</pubDate><guid>https://daemon365.dev/post/network/network_programming/</guid><description>&lt;h2 id="网络层次划分"&gt;网络层次划分&lt;/h2&gt;
&lt;p&gt;为了使不同计算机厂家生产的计算机能够相互通信，以便在更大的范围内建立计算机网络，国际标准化组织（ISO）在1978年提出了&amp;quot;开放系统互联参考模型&amp;quot;，即著名的OSI/RM模型（Open System Interconnection/Reference Model）。它将计算机网络体系结构的通信协议划分为七层，自下而上依次为：物理层（Physics Layer）、数据链路层（Data Link Layer）、网络层（Network Layer）、传输层（Transport Layer）、会话层（Session Layer）、表示层（Presentation Layer）、应用层（Application Layer）。其中第四层完成数据传送服务，上面三层面向用户。&lt;/p&gt;
&lt;h2 id="osi七层协议"&gt;osi七层协议&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;互联网协议按照功能不同分为osi七层或tcp/ip五层&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img src="https://daemon365.dev/images/e1eba343-af03-4c75-a1d5-97b18230cad2.png" alt=""&gt;&lt;/p&gt;
&lt;h3 id="物理层"&gt;物理层&lt;/h3&gt;
&lt;p&gt;物理层由来：上面提到，孤立的计算机之间要通信，就必须接入internet&lt;/p&gt;
&lt;p&gt;&lt;img src="https://daemon365.dev/images/118e6820-bb27-4651-b8a1-d86a26c32e27.png" alt=""&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;物理层功能：主要是基于电器特性发送高低电压(电信号)，高电压对应数字1，低电压对应数字0&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;光纤： 双绞线：&lt;/p&gt;
&lt;p&gt;&lt;img src="https://daemon365.dev/images/0a344786-7492-4815-8043-c3a60013b4cc.png" alt=""&gt;&lt;img src="https://daemon365.dev/images/9e604851-7c87-4b33-8c3a-04d181111f69.png" alt=""&gt;&lt;/p&gt;
&lt;h3 id="数据链路层"&gt;数据链路层&lt;/h3&gt;
&lt;p&gt;数据链路层由来：单纯的电信号0和1没有任何意义，必须规定电信号多少位一组，每组什么意思&lt;/p&gt;
&lt;p&gt;数据链路层的功能：定义了电信号的分组方式&lt;/p&gt;
&lt;p&gt;&lt;em&gt;&lt;strong&gt;以太网协议：&lt;/strong&gt;&lt;/em&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;早期的时候各个公司都有自己的分组方式，后来形成了统一的标准，即以太网协议ethernet&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;ethernet规定&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;一组电信号构成一个数据豹，叫做‘帧’&lt;/li&gt;
&lt;li&gt;每一数据帧分成：报头head和数据data两部分&lt;/li&gt;
&lt;/ul&gt;
&lt;ol&gt;
&lt;li&gt;head包含：(固定18个字节)
&lt;ul&gt;
&lt;li&gt;发送者／源地址，6个字节&lt;/li&gt;
&lt;li&gt;接收者／目标地址，6个字节&lt;/li&gt;
&lt;li&gt;数据类型，6个字节&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;data包含：(最短46字节，最长1500字节)
&lt;ul&gt;
&lt;li&gt;数据包的具体内容&lt;/li&gt;
&lt;li&gt;head长度＋data长度＝最短64字节，最长1518字节，超过最大限制就分片发送&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;em&gt;&lt;strong&gt;mac地址：&lt;/strong&gt;&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;每块网卡出厂时都被烧制上一个世界唯一的mac地址，长度为48位2进制，通常由12位16进制数表示（前六位是厂商编号，后六位是流水线号）&lt;/p&gt;
&lt;p&gt;&lt;img src="https://daemon365.dev/images/2af10484-1932-482f-93fb-863f857702fd.png" alt=""&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;广播：&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;有了mac地址，同一网络内的两台主机就可以通信了（一台主机通过arp协议获取另外一台主机的mac地址）&lt;/p&gt;
&lt;p&gt;ethernet采用最原始的方式，广播的方式进行通信，即计算机通信***&lt;/p&gt;
&lt;p&gt;&lt;img src="https://daemon365.dev/images/ee7fe03b-2d47-4115-8c45-37b613b317f2.png" alt=""&gt;&lt;/p&gt;
&lt;h3 id="网络层"&gt;网络层&lt;/h3&gt;
&lt;p&gt;网络层由来：有了ethernet、mac地址、广播的发送方式，世界上的计算机就可以彼此通信了，问题是世界范围的互联网是由&lt;/p&gt;
&lt;p&gt;一个个彼此隔离的小的局域网组成的，那么如果所有的通信都采用以太网的广播方式，那么一台机器发送的包全世界都会收到，&lt;/p&gt;
&lt;p&gt;这就不仅仅是效率低的问题了，这会是一种灾难&lt;/p&gt;
&lt;p&gt;&lt;img src="https://daemon365.dev/images/920d1763-9497-4e14-a384-e29d0acc91f6.png" alt=""&gt;&lt;/p&gt;
&lt;p&gt;上图结论：必须找出一种方法来区分哪些计算机属于同一广播域，哪些不是，如果是就采用广播的方式发送，如果不是，&lt;/p&gt;
&lt;p&gt;就采用路由的方式（向不同广播域／子网分发数据包），mac地址是无法区分的，它只跟厂商有关&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;网络层功能：引入一套新的地址用来区分不同的广播域／子网，这套地址即网络地址&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;em&gt;&lt;strong&gt;IP协议：&lt;/strong&gt;&lt;/em&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;规定网络地址的协议叫ip协议，它定义的地址称之为ip地址，广泛采用的v4版本即ipv4，它规定网络地址由32位2进制表示&lt;/li&gt;
&lt;li&gt;范围0.0.0.0-255.255.255.255&lt;/li&gt;
&lt;li&gt;一个ip地址通常写成四段十进制数，例：172.16.10.1&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;ip地址分成两部分&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;网络部分：标识子网&lt;/li&gt;
&lt;li&gt;主机部分：标识主机&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;注意：单纯的ip地址段只是标识了ip地址的种类，从网络部分或主机部分都无法辨识一个ip所处的子网&lt;/p&gt;
&lt;p&gt;例：172.16.10.1与172.16.10.2并不能确定二者处于同一子网&lt;/p&gt;
&lt;p&gt;&lt;em&gt;&lt;strong&gt;子网掩码&lt;/strong&gt;&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;所谓”子网掩码”，就是表示子网络特征的一个参数。它在形式上等同于IP地址，也是一个32位二进制数字，它的网络部分全部为1，主机部分全部为0。比如，IP地址172.16.10.1，如果已知网络部分是前24位，主机部分是后8位，那么子网络掩码就是11111111.11111111.11111111.00000000，写成十进制就是255.255.255.0。&lt;/p&gt;
&lt;p&gt;知道”子网掩码”，我们就能判断，任意两个IP地址是否处在同一个子网络。方法是将两个IP地址与子网掩码分别进行AND运算（两个数位都为1，运算结果为1，否则为0），然后比较结果是否相同，如果是的话，就表明它们在同一个子网络中，否则就不是。&lt;/p&gt;
&lt;p&gt;比如，已知IP地址172.16.10.1和172.16.10.2的子网掩码都是255.255.255.0，请问它们是否在同一个子网络？两者与子网掩码分别进行AND运算，&lt;/p&gt;
&lt;p&gt;172.16.10.1：10101100.00010000.00001010.000000001&lt;/p&gt;
&lt;p&gt;255255.255.255.0:11111111.11111111.11111111.00000000&lt;/p&gt;
&lt;p&gt;AND运算得网络地址结果：10101100.00010000.00001010.000000001-&amp;gt;172.16.10.0&lt;/p&gt;
&lt;p&gt;172.16.10.2：10101100.00010000.00001010.000000010&lt;/p&gt;</description><content:encoded><![CDATA[<h2 id="网络层次划分">网络层次划分</h2>
<p>为了使不同计算机厂家生产的计算机能够相互通信，以便在更大的范围内建立计算机网络，国际标准化组织（ISO）在1978年提出了&quot;开放系统互联参考模型&quot;，即著名的OSI/RM模型（Open System Interconnection/Reference Model）。它将计算机网络体系结构的通信协议划分为七层，自下而上依次为：物理层（Physics Layer）、数据链路层（Data Link Layer）、网络层（Network Layer）、传输层（Transport Layer）、会话层（Session Layer）、表示层（Presentation Layer）、应用层（Application Layer）。其中第四层完成数据传送服务，上面三层面向用户。</p>
<h2 id="osi七层协议">osi七层协议</h2>
<ul>
<li>互联网协议按照功能不同分为osi七层或tcp/ip五层</li>
</ul>
<p><img src="/images/e1eba343-af03-4c75-a1d5-97b18230cad2.png" alt=""></p>
<h3 id="物理层">物理层</h3>
<p>物理层由来：上面提到，孤立的计算机之间要通信，就必须接入internet</p>
<p><img src="/images/118e6820-bb27-4651-b8a1-d86a26c32e27.png" alt=""></p>
<p><strong>物理层功能：主要是基于电器特性发送高低电压(电信号)，高电压对应数字1，低电压对应数字0</strong></p>
<p>光纤： 双绞线：</p>
<p><img src="/images/0a344786-7492-4815-8043-c3a60013b4cc.png" alt=""><img src="/images/9e604851-7c87-4b33-8c3a-04d181111f69.png" alt=""></p>
<h3 id="数据链路层">数据链路层</h3>
<p>数据链路层由来：单纯的电信号0和1没有任何意义，必须规定电信号多少位一组，每组什么意思</p>
<p>数据链路层的功能：定义了电信号的分组方式</p>
<p><em><strong>以太网协议：</strong></em></p>
<ul>
<li>早期的时候各个公司都有自己的分组方式，后来形成了统一的标准，即以太网协议ethernet</li>
</ul>
<p>ethernet规定</p>
<ul>
<li>一组电信号构成一个数据豹，叫做‘帧’</li>
<li>每一数据帧分成：报头head和数据data两部分</li>
</ul>
<ol>
<li>head包含：(固定18个字节)
<ul>
<li>发送者／源地址，6个字节</li>
<li>接收者／目标地址，6个字节</li>
<li>数据类型，6个字节</li>
</ul>
</li>
<li>data包含：(最短46字节，最长1500字节)
<ul>
<li>数据包的具体内容</li>
<li>head长度＋data长度＝最短64字节，最长1518字节，超过最大限制就分片发送</li>
</ul>
</li>
</ol>
<p><em><strong>mac地址：</strong></em></p>
<p>每块网卡出厂时都被烧制上一个世界唯一的mac地址，长度为48位2进制，通常由12位16进制数表示（前六位是厂商编号，后六位是流水线号）</p>
<p><img src="/images/2af10484-1932-482f-93fb-863f857702fd.png" alt=""></p>
<p><strong>广播：</strong></p>
<p>有了mac地址，同一网络内的两台主机就可以通信了（一台主机通过arp协议获取另外一台主机的mac地址）</p>
<p>ethernet采用最原始的方式，广播的方式进行通信，即计算机通信***</p>
<p><img src="/images/ee7fe03b-2d47-4115-8c45-37b613b317f2.png" alt=""></p>
<h3 id="网络层">网络层</h3>
<p>网络层由来：有了ethernet、mac地址、广播的发送方式，世界上的计算机就可以彼此通信了，问题是世界范围的互联网是由</p>
<p>一个个彼此隔离的小的局域网组成的，那么如果所有的通信都采用以太网的广播方式，那么一台机器发送的包全世界都会收到，</p>
<p>这就不仅仅是效率低的问题了，这会是一种灾难</p>
<p><img src="/images/920d1763-9497-4e14-a384-e29d0acc91f6.png" alt=""></p>
<p>上图结论：必须找出一种方法来区分哪些计算机属于同一广播域，哪些不是，如果是就采用广播的方式发送，如果不是，</p>
<p>就采用路由的方式（向不同广播域／子网分发数据包），mac地址是无法区分的，它只跟厂商有关</p>
<p><strong>网络层功能：引入一套新的地址用来区分不同的广播域／子网，这套地址即网络地址</strong></p>
<p><em><strong>IP协议：</strong></em></p>
<ul>
<li>规定网络地址的协议叫ip协议，它定义的地址称之为ip地址，广泛采用的v4版本即ipv4，它规定网络地址由32位2进制表示</li>
<li>范围0.0.0.0-255.255.255.255</li>
<li>一个ip地址通常写成四段十进制数，例：172.16.10.1</li>
</ul>
<p><strong>ip地址分成两部分</strong></p>
<ul>
<li>网络部分：标识子网</li>
<li>主机部分：标识主机</li>
</ul>
<p>注意：单纯的ip地址段只是标识了ip地址的种类，从网络部分或主机部分都无法辨识一个ip所处的子网</p>
<p>例：172.16.10.1与172.16.10.2并不能确定二者处于同一子网</p>
<p><em><strong>子网掩码</strong></em></p>
<p>所谓”子网掩码”，就是表示子网络特征的一个参数。它在形式上等同于IP地址，也是一个32位二进制数字，它的网络部分全部为1，主机部分全部为0。比如，IP地址172.16.10.1，如果已知网络部分是前24位，主机部分是后8位，那么子网络掩码就是11111111.11111111.11111111.00000000，写成十进制就是255.255.255.0。</p>
<p>知道”子网掩码”，我们就能判断，任意两个IP地址是否处在同一个子网络。方法是将两个IP地址与子网掩码分别进行AND运算（两个数位都为1，运算结果为1，否则为0），然后比较结果是否相同，如果是的话，就表明它们在同一个子网络中，否则就不是。</p>
<p>比如，已知IP地址172.16.10.1和172.16.10.2的子网掩码都是255.255.255.0，请问它们是否在同一个子网络？两者与子网掩码分别进行AND运算，</p>
<p>172.16.10.1：10101100.00010000.00001010.000000001</p>
<p>255255.255.255.0:11111111.11111111.11111111.00000000</p>
<p>AND运算得网络地址结果：10101100.00010000.00001010.000000001-&gt;172.16.10.0</p>
<p>172.16.10.2：10101100.00010000.00001010.000000010</p>
<p>255255.255.255.0:11111111.11111111.11111111.00000000</p>
<p>AND运算得网络地址结果：10101100.00010000.00001010.000000001-&gt;172.16.10.0</p>
<p>结果都是172.16.10.0，因此它们在同一个子网络。</p>
<p>总结一下，IP协议的作用主要有两个，一个是为每一台计算机分配IP地址，另一个是确定哪些地址在同一个子网络。</p>
<p><em><strong>ip数据包</strong></em></p>
<p>ip数据包也分为head和data部分，无须为ip包定义单独的栏位，直接放入以太网包的data部分</p>
<p>head：长度为20到60字节</p>
<p>data：最长为65,515字节。</p>
<p>而以太网数据包的”数据”部分，最长只有1500字节。因此，如果IP数据包超过了1500字节，它就需要分割成几个以太网数据包，分开发送了。</p>
<p><em><strong>ARP协议</strong></em></p>
<p>arp协议由来：计算机通信***，即广播的方式，所有上层的包到最后都要封装上以太网头，然后通过以太网协议发送，在谈及以太网协议时候，我门了解到</p>
<p>通信是基于mac的广播方式实现，计算机在发包时，获取自身的mac是容易的，如何获取目标主机的mac，就需要通过arp协议</p>
<p>arp协议功能：广播的方式发送数据包，获取目标主机的mac地址</p>
<p>协议工作方式：每台主机ip都是已知的</p>
<p>例如：主机172.16.10.10/24访问172.16.10.11/24</p>
<p>一：首先通过ip地址和子网掩码区分出自己所处的子网</p>
<table>
  <thead>
      <tr>
          <th>场景</th>
          <th>数据包地址</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>同一子网</td>
          <td>目标主机mac，目标主机ip</td>
      </tr>
      <tr>
          <td>不同子网</td>
          <td>网关mac，目标主机ip</td>
      </tr>
  </tbody>
</table>
<p>二：分析172.16.10.10/24与172.16.10.11/24处于同一网络(如果不是同一网络，那么下表中目标ip为172.16.10.1,通过arp获取的是网关的mac)</p>
<table>
  <thead>
      <tr>
          <th>源mac</th>
          <th>目标mac</th>
          <th>源ip</th>
          <th>目标ip</th>
          <th>数据部分</th>
          <th></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>发送端主机</td>
          <td>发送端mac</td>
          <td>FF:FF:FF:FF:FF:FF</td>
          <td>172.16.10.10/24</td>
          <td>172.16.10.11/24</td>
          <td>数据</td>
      </tr>
  </tbody>
</table>
<p>三：这个包会以广播的方式在发送端所处的自网内传输，所有主机接收后拆开包，发现目标ip为自己的，就响应，返回自己的mac</p>
<h3 id="传输层">传输层</h3>
<p>传输层的由来：网络层的ip帮我们区分子网，以太网层的mac帮我们找到主机，然后大家使用的都是应用程序，你的电脑上可能同时开启qq，暴风影音，等多个应用程序，</p>
<p>那么我们通过ip和mac找到了一台特定的主机，如何标识这台主机上的应用程序，答案就是端口，端口即应用程序与网卡关联的编号。</p>
<p>传输层功能：建立端口到端口的通信</p>
<p>补充：端口范围0-65535，0-1023为系统占用端口</p>
<p>tcp协议：</p>
<p>可靠传输，TCP数据包没有长度限制，理论上可以无限长，但是为了保证网络的效率，通常TCP数据包的长度不会超过IP数据包的长度，以确保单个TCP数据包不必再分割。</p>
<table>
  <thead>
      <tr>
          <th>以太网头</th>
          <th>ip 头</th>
          <th>tcp头</th>
          <th>数据</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td></td>
          <td></td>
          <td></td>
          <td>udp协议：</td>
      </tr>
  </tbody>
</table>
<p>不可靠传输，”报头”部分一共只有8个字节，总长度不超过65,535字节，正好放进一个IP数据包。</p>
<table>
  <thead>
      <tr>
          <th>以太网头</th>
          <th>ip头</th>
          <th>udp头</th>
          <th>数据</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
      </tr>
  </tbody>
</table>
<p>tcp报文</p>
<p><img src="/images/757a5ec0-36e3-4fc2-95f8-bd2afc1a8f20.png" alt=""></p>
<p><strong>tcp三次握手和四次挥手</strong></p>
<p><img src="/images/15eb11ae-7c93-445b-9809-4d4dd3840b09.png" alt=""></p>
<p><img src="/images/73d687e1-618f-4a40-bce2-29277c4d9207.png" alt=""></p>
<h3 id="应用层">应用层</h3>
<p>应用层由来：用户使用的都是应用程序，均工作于应用层，互联网是开发的，大家都可以开发自己的应用程序，数据多种多样，必须规定好数据的组织形式</p>
<p>应用层功能：规定应用程序的数据格式。</p>
<p>例：TCP协议可以为各种各样的程序传递数据，比如Email、WWW、FTP等等。那么，必须有不同协议规定电子邮件、网页、FTP数据的格式，这些应用程序协议就构成了”应用层”。</p>
<p><img src="/images/488cc59e-6f66-41a0-ace6-873d1e44b0fd.png" alt=""></p>
<h3 id="网络通信实现">网络通信实现</h3>
<p>想实现网络通信，每台主机需具备四要素</p>
<ul>
<li>本机的IP地址</li>
<li>子网掩码</li>
<li>网关的IP地址</li>
<li>DNS的IP地址</li>
</ul>
<p>获取这四要素分两种方式</p>
<p>1.静态获取</p>
<p>即手动配置</p>
<p>2.动态获取</p>
<p>通过dhcp获取</p>
<table>
  <thead>
      <tr>
          <th>以太网头</th>
          <th>ip头</th>
          <th>udp头</th>
          <th>dhcp数据包</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
      </tr>
  </tbody>
</table>
<p>（1）最前面的”以太网标头”，设置发出方（本机）的MAC地址和接收方（DHCP服务器）的MAC地址。前者就是本机网卡的MAC地址，后者这时不知道，就填入一个广播地址：FF-FF-FF-FF-FF-FF。</p>
<p>（2）后面的”IP标头”，设置发出方的IP地址和接收方的IP地址。这时，对于这两者，本机都不知道。于是，发出方的IP地址就设为0.0.0.0，接收方的IP地址设为255.255.255.255。</p>
<p>（3）最后的”UDP标头”，设置发出方的端口和接收方的端口。这一部分是DHCP协议规定好的，发出方是68端口，接收方是67端口。</p>
<p>这个据包构造完成后，就可以发出了。以太网是广播发送，同一个子网络的每台计算机都收到了这个包。因为接收方的MAC地址是FF-FF-FF-FF-FF-FF，看不出是发给谁的，所以每台收到这个包的计算机，还必须分析这个包的IP地址，才能确定是不是发给自己的。当看到发出方IP地址是0.0.0.0，接收方是255.255.255.255，于是DHCP服务器知道”这个包是发给我的”，而其他计算机就可以丢弃这个包。</p>
<p>接下来，DHCP服务器读出这个包的数据内容，分配好IP地址，发送回去一个”DHCP响应”数据包。这个响应包的结构也是类似的，以太网标头的MAC地址是双方的网卡地址，IP标头的IP地址是DHCP服务器的IP地址（发出方）和255.255.255.255（接收方），UDP标头的端口是67（发出方）和68（接收方），分配给请求端的IP地址和本网络的具体参数则包含在Data部分。新加入的计算机收到这个响应包，于是就知道了自己的IP地址、子网掩码、网关地址、DNS服务器等等参数</p>
<h3 id="网络通信流程">网络通信流程</h3>
<h4 id="本机获取">本机获取</h4>
<ul>
<li>本机的IP地址：192.168.1.100</li>
<li>子网掩码：255.255.255.0</li>
<li>网关的IP地址：192.168.1.1</li>
<li>DNS的IP地址：8.8.8.8</li>
</ul>
<h4 id="打开浏览器访问">打开浏览器，访问</h4>
<ul>
<li>想要访问Google，在地址栏输入了网址：www.google.com。</li>
</ul>
<h3 id="dns协议基于udp协议">dns协议(基于udp协议)</h3>
<p><img src="/images/a53369a0-b98e-45dd-a40d-cb9842a20c28.png" alt=""></p>
<p>13台根dns：</p>
<p>A.root-servers.net198.41.0.4美国 B.root-servers.net192.228.79.201美国（另支持<a href="https://www.baidu.com/s?wd=IPv6&amp;tn=44039180_cpr&amp;fenlei=mv6quAkxTZn0IZRqIHckPjm4nH00T1d9ryR4nhnsn1b3ujfYPAfk0ZwV5Hcvrjm3rH6sPfKWUMw85HfYnjn4nH6sgvPsT6KdThsqpZwYTjCEQLGCpyw9Uz4Bmy-bIi4WUvYETgN-TLwGUv3ErH0YPW6snH0">IPv6</a>） C.root-servers.net192.33.4.12法国 D.root-servers.net128.8.10.90美国 E.root-servers.net192.203.230.10美国 F.root-servers.net192.5.5.241美国（另支持<a href="https://www.baidu.com/s?wd=IPv6&amp;tn=44039180_cpr&amp;fenlei=mv6quAkxTZn0IZRqIHckPjm4nH00T1d9ryR4nhnsn1b3ujfYPAfk0ZwV5Hcvrjm3rH6sPfKWUMw85HfYnjn4nH6sgvPsT6KdThsqpZwYTjCEQLGCpyw9Uz4Bmy-bIi4WUvYETgN-TLwGUv3ErH0YPW6snH0">IPv6</a>） G.root-servers.net192.112.36.4美国 H.root-servers.net128.63.2.53美国（另支持<a href="https://www.baidu.com/s?wd=IPv6&amp;tn=44039180_cpr&amp;fenlei=mv6quAkxTZn0IZRqIHckPjm4nH00T1d9ryR4nhnsn1b3ujfYPAfk0ZwV5Hcvrjm3rH6sPfKWUMw85HfYnjn4nH6sgvPsT6KdThsqpZwYTjCEQLGCpyw9Uz4Bmy-bIi4WUvYETgN-TLwGUv3ErH0YPW6snH0">IPv6</a>） I.root-servers.net192.36.148.17瑞典 J.root-servers.net192.58.128.30美国 K.root-servers.net193.0.14.129英国（另支持IPv6） L.root-servers.net198.32.64.12美国 M.root-servers.net202.12.27.33日本（另支持IPv6）</p>
<p>域名定义：http://jingyan.baidu.com/article/1974b289a649daf4b1f774cb.html</p>
<p>顶级域名：以.com,.net,.org,.cn等等属于国际顶级域名，根据目前的国际互联网域名体系，国际顶级域名分为两类：类别顶级域名(gTLD)和地理顶级域名(ccTLD)两种。类别顶级域名是　　　　　　　　 以&quot;COM&quot;、&ldquo;NET&rdquo;、&ldquo;ORG&rdquo;、&ldquo;BIZ&rdquo;、&ldquo;INFO&quot;等结尾的域名，均由国外公司负责管理。地理顶级域名是以国家或地区代码为结尾的域名，如&quot;CN&quot;代表中国，&ldquo;UK&quot;代表英国。地理顶级域名一般由各个国家或地区负责管理。</p>
<p>二级域名：二级域名是以顶级域名为基础的地理域名，比喻中国的二级域有，.com.cn,.net.cn,.org.cn,.gd.cn等.子域名是其父域名的子域名，比喻父域名是abc.com,子域名就是www.abc.com或者*.abc.com. 一般来说，二级域名是域名的一条记录，比如alidiedie.com是一个域名，www.alidiedie.com是其中比较常用的记录，一般默认是用这个，但是类似*.alidiedie.com的域名全部称作是alidiedie.com的二级</p>
<h4 id="http部分的内容">HTTP部分的内容</h4>
<p>类似于这样的：</p>
<blockquote>
<p>GET / HTTP/1.1 Host: <a href="http://www.google.com/">www.google.com</a> Connection: keep-alive User-Agent: Mozilla/5.0 (Windows NT 6.1) …… Accept: text/html,application/xhtml+xml,application/xml;q=0.9,<em>/</em>;q=0.8 Accept-Encoding: gzip,deflate,sdch Accept-Language: zh-CN,zh;q=0.8 Accept-Charset: GBK,utf-8;q=0.7,*;q=0.3 Cookie: … …</p>
</blockquote>
<p>我们假定这个部分的长度为4960字节，它会被嵌在TCP数据包之中。</p>
<h4 id="tcp协议">TCP协议</h4>
<p>TCP数据包需要设置端口，接收方（Google）的HTTP端口默认是80，发送方（本机）的端口是一个随机生成的1024-65535之间的整数，假定为51775。</p>
<p>TCP数据包的标头长度为20字节，加上嵌入HTTP的数据包，总长度变为4980字节。</p>
<h4 id="ip协议">IP协议</h4>
<p>然后，TCP数据包再嵌入IP数据包。IP数据包需要设置双方的IP地址，这是已知的，发送方是192.168.1.100（本机），接收方是172.194.72.105（Google）。</p>
<p>IP数据包的标头长度为20字节，加上嵌入的TCP数据包，总长度变为5000字节。</p>
<h4 id="以太网协议">以太网协议</h4>
<p>最后，IP数据包嵌入以太网数据包。以太网数据包需要设置双方的MAC地址，发送方为本机的网卡MAC地址，接收方为网关192.168.1.1的MAC地址（通过ARP协议得到）。</p>
<p>以太网数据包的数据部分，最大长度为1500字节，而现在的IP数据包长度为5000字节。因此，IP数据包必须分割成四个包。因为每个包都有自己的IP标头（20字节），所以四个包的IP数据包的长度分别为1500、1500、1500、560。</p>
<h4 id="服务器端响应">服务器端响应</h4>
<p>经过多个网关的转发，Google的服务器172.194.72.105，收到了这四个以太网数据包。</p>
<p>根据IP标头的序号，Google将四个包拼起来，取出完整的TCP数据包，然后读出里面的”HTTP请求”，接着做出”HTTP响应”，再用TCP协议发回来。</p>
<p>本机收到HTTP响应以后，就可以将网页显示出来，完成一次网络通信。</p>
<h4 id="socket">socket</h4>
<p>五层通讯流程：</p>
<p><img src="/images/d143b8c3-0b62-4cbf-9e89-9f8c644613fc.png" alt=""></p>
<p>但实际上从传输层开始以及以下，都是操作系统帮咱们完成的，下面的各种包头封装的过程，用咱们去一个一个做么？<strong>NO！</strong></p>
<p><img src="/images/23a994b7-a894-48e9-953c-c2b83a08da6e.png" alt=""></p>
<p>Socket又称为套接字，它是应用层与TCP/IP协议族通信的中间软件抽象层，它是一组接口。在设计模式中，Socket其实就是一个门面模式，它把复杂的TCP/IP协议族隐藏在Socket接口后面，对用户来说，一组简单的接口就是全部，让Socket去组织数据，以符合指定的协议。当我们使用不同的协议进行通信时就得使用不同的接口，还得处理不同协议的各种细节，这就增加了开发的难度，软件也不易于扩展(就像我们开发一套公司管理系统一样，报账、会议预定、请假等功能不需要单独写系统，而是一个系统上多个功能接口，不需要知道每个功能如何去实现的)。于是UNIX BSD就发明了socket这种东西，socket屏蔽了各个协议的通信细节，使得程序员无需关注协议本身，直接使用socket提供的接口来进行互联的不同主机间的进程的通信。这就好比操作系统给我们提供了使用底层硬件功能的系统调用，通过系统调用我们可以方便的使用磁盘（文件操作），使用内存，而无需自己去进行磁盘读写，内存管理。socket其实也是一样的东西，就是提供了tcp/ip协议的抽象，对外提供了一套接口，同过这个接口就可以统一、方便的使用tcp/ip协议的功能了。</p>
<p>其实站在你的角度上看，socket就是一个模块。我们通过调用模块中已经实现的方法建立两个进程之间的连接和通信。也有人将socket说成ip+port，因为ip是用来标识互联网中的一台主机的位置，而port是用来标识这台机器上的一个应用程序。 所以我们只要确立了ip和port就能找到一个应用程序，并且使用socket模块来与之通信。</p>
<h4 id="套接字发展史及分类">套接字发展史及分类</h4>
<p>套接字起源于 20 世纪 70 年代加利福尼亚大学伯克利分校版本的 Unix,即人们所说的 BSD Unix。 因此,有时人们也把套接字称为“伯克利套接字”或“BSD 套接字”。一开始,套接字被设计用在同 一台主机上多个应用程序之间的通讯。这也被称进程间通讯,或 IPC。套接字有两种（或者称为有两个种族）,分别是基于文件型的和基于网络型的。</p>
<p><em><strong>基于文件类型的套接字家族</strong></em></p>
<p>套接字家族的名字：AF_UNIX</p>
<p>unix一切皆文件，基于文件的套接字调用的就是底层的文件系统来取数据，两个套接字进程运行在同一机器，可以通过访问同一个文件系统间接完成通信</p>
<p><em><strong>基于网络类型的套接字家族</strong></em></p>
<p>套接字家族的名字：AF_INET</p>
<p>(还有AF_INET6被用于ipv6，还有一些其他的地址家族，不过，他们要么是只用于某个平台，要么就是已经被废弃，或者是很少被使用，或者是根本没有实现，所有地址家族中，AF_INET是使用最广泛的一个，python支持很多种地址家族，但是由于我们只关心网络编程，所以大部分时候我么只使用AF_INET)</p>
<h4 id="套接字的工作流程基于tcp和-udp两个协议">套接字的工作流程（基于TCP和 UDP两个协议）</h4>
<h5 id="tcp和udp对比">TCP和UDP对比</h5>
<p>TCP（Transmission Control Protocol）可靠的、面向连接的协议（eg:打电话）、传输效率低全双工通信（发送缓存&amp;接收缓存）、面向字节流。使用TCP的应用：Web浏览器；文件传输程序。</p>
<p>UDP（User Datagram Protocol）不可靠的、无连接的服务，传输效率高（发送前时延小），一对一、一对多、多对一、多对多、面向报文(数据包)，尽最大努力服务，无拥塞控制。使用UDP的应用：域名系统 (DNS)；视频流；IP语音(VoIP)。</p>
<h5 id="tcp协议下的socket">TCP协议下的socket</h5>
<p>个生活中的场景。你要打电话给一个朋友，先拨号，朋友听到电话铃声后提起电话，这时你和你的朋友就建立起了连接，就可以讲话了。等交流结束，挂断电话结束此次交谈。 生活中的场景就解释了这工作原理。</p>
<p><img src="/images/b92b90bc-d7eb-4302-a3ad-6447442453d2.png" alt=""></p>
<p>先从服务器端说起。服务器端先初始化Socket，然后与端口绑定(bind)，对端口进行监听(listen)，调用accept阻塞，等待客户端连接。在这时如果有个客户端初始化一个Socket，然后连接服务器(connect)，如果连接成功，这时客户端与服务器端的连接就建立了。客户端发送数据请求，服务器端接收请求并处理请求，然后把回应数据发送给客户端，客户端读取数据，最后关闭连接，一次交互结束 细说socket()模块函数用法</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">socket</span>
</span></span><span style="display:flex;"><span><span style="color:#111">socket</span><span style="color:#f92672">.</span><span style="color:#111">socket</span><span style="color:#111">(</span><span style="color:#111">socket_family</span><span style="color:#111">,</span><span style="color:#111">socket_type</span><span style="color:#111">,</span><span style="color:#111">protocal</span><span style="color:#f92672">=</span><span style="color:#ae81ff">0</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span> <span style="color:#111">socket_family</span> <span style="color:#111">可以是</span> <span style="color:#111">AF_UNIX</span> <span style="color:#111">或</span> <span style="color:#111">AF_INET</span><span style="color:#960050;background-color:#1e0010">。</span><span style="color:#111">socket_type</span> <span style="color:#111">可以是</span> <span style="color:#111">SOCK_STREAM</span> <span style="color:#111">或</span> <span style="color:#111">SOCK_DGRAM</span><span style="color:#960050;background-color:#1e0010">。</span><span style="color:#111">protocol</span> <span style="color:#111">一般不填</span><span style="color:#111">,</span><span style="color:#111">默认值为</span> <span style="color:#ae81ff">0</span><span style="color:#960050;background-color:#1e0010">。</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#111">获取tcp</span><span style="color:#f92672">/</span><span style="color:#111">ip套接字</span>
</span></span><span style="display:flex;"><span><span style="color:#111">tcpSock</span> <span style="color:#f92672">=</span> <span style="color:#111">socket</span><span style="color:#f92672">.</span><span style="color:#111">socket</span><span style="color:#111">(</span><span style="color:#111">socket</span><span style="color:#f92672">.</span><span style="color:#111">AF_INET</span><span style="color:#111">,</span> <span style="color:#111">socket</span><span style="color:#f92672">.</span><span style="color:#111">SOCK_STREAM</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">获取udp</span><span style="color:#f92672">/</span><span style="color:#111">ip套接字</span>
</span></span><span style="display:flex;"><span><span style="color:#111">udpSock</span> <span style="color:#f92672">=</span> <span style="color:#111">socket</span><span style="color:#f92672">.</span><span style="color:#111">socket</span><span style="color:#111">(</span><span style="color:#111">socket</span><span style="color:#f92672">.</span><span style="color:#111">AF_INET</span><span style="color:#111">,</span> <span style="color:#111">socket</span><span style="color:#f92672">.</span><span style="color:#111">SOCK_DGRAM</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">由于</span> <span style="color:#111">socket</span> <span style="color:#111">模块中有太多的属性</span><span style="color:#960050;background-color:#1e0010">。</span><span style="color:#111">我们在这里破例使用了</span><span style="color:#d88200">&#39;from module import *&#39;</span><span style="color:#111">语句</span><span style="color:#960050;background-color:#1e0010">。</span><span style="color:#111">使用</span> <span style="color:#d88200">&#39;from socket import *&#39;</span><span style="color:#111">,</span><span style="color:#111">我们就把</span> <span style="color:#111">socket</span> <span style="color:#111">模块里的所有属性都带到我们的命名空间里了</span><span style="color:#111">,</span><span style="color:#111">这样能</span> <span style="color:#111">大幅减短我们的代码</span><span style="color:#960050;background-color:#1e0010">。</span>
</span></span><span style="display:flex;"><span><span style="color:#111">例如tcpSock</span> <span style="color:#f92672">=</span> <span style="color:#111">socket</span><span style="color:#111">(</span><span style="color:#111">AF_INET</span><span style="color:#111">,</span> <span style="color:#111">SOCK_STREAM</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">服务端套接字函数</span>
</span></span><span style="display:flex;"><span><span style="color:#111">s</span><span style="color:#f92672">.</span><span style="color:#111">bind</span><span style="color:#111">()</span>    <span style="color:#111">绑定</span><span style="color:#111">(</span><span style="color:#111">主机</span><span style="color:#111">,</span><span style="color:#111">端口号</span><span style="color:#111">)</span><span style="color:#111">到套接字</span>
</span></span><span style="display:flex;"><span><span style="color:#111">s</span><span style="color:#f92672">.</span><span style="color:#111">listen</span><span style="color:#111">()</span>  <span style="color:#111">开始TCP监听</span>
</span></span><span style="display:flex;"><span><span style="color:#111">s</span><span style="color:#f92672">.</span><span style="color:#111">accept</span><span style="color:#111">()</span>  <span style="color:#111">被动接受TCP客户的连接</span><span style="color:#111">,(</span><span style="color:#111">阻塞式</span><span style="color:#111">)</span><span style="color:#111">等待连接的到来</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">客户端套接字函数</span>
</span></span><span style="display:flex;"><span><span style="color:#111">s</span><span style="color:#f92672">.</span><span style="color:#111">connect</span><span style="color:#111">()</span>     <span style="color:#111">主动初始化TCP服务器连接</span>
</span></span><span style="display:flex;"><span><span style="color:#111">s</span><span style="color:#f92672">.</span><span style="color:#111">connect_ex</span><span style="color:#111">()</span>  <span style="color:#111">connect</span><span style="color:#111">()</span><span style="color:#111">函数的扩展版本</span><span style="color:#111">,</span><span style="color:#111">出错时返回出错码</span><span style="color:#111">,</span><span style="color:#111">而不是抛出异常</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">公共用途的套接字函数</span>
</span></span><span style="display:flex;"><span><span style="color:#111">s</span><span style="color:#f92672">.</span><span style="color:#111">recv</span><span style="color:#111">()</span>            <span style="color:#111">接收TCP数据</span>
</span></span><span style="display:flex;"><span><span style="color:#111">s</span><span style="color:#f92672">.</span><span style="color:#111">send</span><span style="color:#111">()</span>            <span style="color:#111">发送TCP数据</span><span style="color:#111">(</span><span style="color:#111">send在待发送数据量大于己端缓存区剩余空间时</span><span style="color:#111">,</span><span style="color:#111">数据丢失</span><span style="color:#111">,</span><span style="color:#111">不会发完</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">s</span><span style="color:#f92672">.</span><span style="color:#111">sendall</span><span style="color:#111">()</span>         <span style="color:#111">发送完整的TCP数据</span><span style="color:#111">(</span><span style="color:#111">本质就是循环调用send</span><span style="color:#111">,</span><span style="color:#111">sendall在待发送数据量大于己端缓存区剩余空间时</span><span style="color:#111">,</span><span style="color:#111">数据不丢失</span><span style="color:#111">,</span><span style="color:#111">循环调用send直到发完</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">s</span><span style="color:#f92672">.</span><span style="color:#111">recvfrom</span><span style="color:#111">()</span>        <span style="color:#111">接收UDP数据</span>
</span></span><span style="display:flex;"><span><span style="color:#111">s</span><span style="color:#f92672">.</span><span style="color:#111">sendto</span><span style="color:#111">()</span>          <span style="color:#111">发送UDP数据</span>
</span></span><span style="display:flex;"><span><span style="color:#111">s</span><span style="color:#f92672">.</span><span style="color:#111">getpeername</span><span style="color:#111">()</span>     <span style="color:#111">连接到当前套接字的远端的地址</span>
</span></span><span style="display:flex;"><span><span style="color:#111">s</span><span style="color:#f92672">.</span><span style="color:#111">getsockname</span><span style="color:#111">()</span>     <span style="color:#111">当前套接字的地址</span>
</span></span><span style="display:flex;"><span><span style="color:#111">s</span><span style="color:#f92672">.</span><span style="color:#111">getsockopt</span><span style="color:#111">()</span>      <span style="color:#111">返回指定套接字的参数</span>
</span></span><span style="display:flex;"><span><span style="color:#111">s</span><span style="color:#f92672">.</span><span style="color:#111">setsockopt</span><span style="color:#111">()</span>      <span style="color:#111">设置指定套接字的参数</span>
</span></span><span style="display:flex;"><span><span style="color:#111">s</span><span style="color:#f92672">.</span><span style="color:#111">close</span><span style="color:#111">()</span>           <span style="color:#111">关闭套接字</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">面向锁的套接字方法</span>
</span></span><span style="display:flex;"><span><span style="color:#111">s</span><span style="color:#f92672">.</span><span style="color:#111">setblocking</span><span style="color:#111">()</span>     <span style="color:#111">设置套接字的阻塞与非阻塞模式</span>
</span></span><span style="display:flex;"><span><span style="color:#111">s</span><span style="color:#f92672">.</span><span style="color:#111">settimeout</span><span style="color:#111">()</span>      <span style="color:#111">设置阻塞套接字操作的超时时间</span>
</span></span><span style="display:flex;"><span><span style="color:#111">s</span><span style="color:#f92672">.</span><span style="color:#111">gettimeout</span><span style="color:#111">()</span>      <span style="color:#111">得到阻塞套接字操作的超时时间</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">面向文件的套接字的函数</span>
</span></span><span style="display:flex;"><span><span style="color:#111">s</span><span style="color:#f92672">.</span><span style="color:#111">fileno</span><span style="color:#111">()</span>          <span style="color:#111">套接字的文件描述符</span>
</span></span><span style="display:flex;"><span><span style="color:#111">s</span><span style="color:#f92672">.</span><span style="color:#111">makefile</span><span style="color:#111">()</span>        <span style="color:#111">创建一个与该套接字相关的文件</span>
</span></span></code></pre></div><p>第一版，单个客户端与服务端通信（low版）</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">socket</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">phone</span> <span style="color:#f92672">=</span> <span style="color:#111">socket</span><span style="color:#f92672">.</span><span style="color:#111">socket</span><span style="color:#111">(</span><span style="color:#111">socket</span><span style="color:#f92672">.</span><span style="color:#111">AF_INET</span><span style="color:#111">,</span><span style="color:#111">socket</span><span style="color:#f92672">.</span><span style="color:#111">SOCK_STREAM</span><span style="color:#111">)</span>  <span style="color:#75715e"># 买电话</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">phone</span><span style="color:#f92672">.</span><span style="color:#111">connect</span><span style="color:#111">((</span><span style="color:#d88200">&#39;127.0.0.1&#39;</span><span style="color:#111">,</span><span style="color:#ae81ff">8080</span><span style="color:#111">))</span>  <span style="color:#75715e"># 与客户端建立连接， 拨号</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">phone</span><span style="color:#f92672">.</span><span style="color:#111">send</span><span style="color:#111">(</span><span style="color:#d88200">&#39;hello&#39;</span><span style="color:#f92672">.</span><span style="color:#111">encode</span><span style="color:#111">(</span><span style="color:#d88200">&#39;utf-8&#39;</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">from_server_data</span> <span style="color:#f92672">=</span> <span style="color:#111">phone</span><span style="color:#f92672">.</span><span style="color:#111">recv</span><span style="color:#111">(</span><span style="color:#ae81ff">1024</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">print</span><span style="color:#111">(</span><span style="color:#111">from_server_data</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">phone</span><span style="color:#f92672">.</span><span style="color:#111">close</span><span style="color:#111">()</span>  <span style="color:#75715e"># 挂电话</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 网络通信与打电话（诺基亚）是一样的。</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">socket</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">phone</span> <span style="color:#f92672">=</span> <span style="color:#111">socket</span><span style="color:#f92672">.</span><span style="color:#111">socket</span><span style="color:#111">(</span><span style="color:#111">socket</span><span style="color:#f92672">.</span><span style="color:#111">AF_INET</span><span style="color:#111">,</span><span style="color:#111">socket</span><span style="color:#f92672">.</span><span style="color:#111">SOCK_STREAM</span><span style="color:#111">)</span>  <span style="color:#75715e"># 买电话</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">phone</span><span style="color:#f92672">.</span><span style="color:#111">bind</span><span style="color:#111">((</span><span style="color:#d88200">&#39;127.0.0.1&#39;</span><span style="color:#111">,</span><span style="color:#ae81ff">8080</span><span style="color:#111">))</span>  <span style="color:#75715e"># 0 ~ 65535  1024之前系统分配好的端口 绑定电话卡</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">phone</span><span style="color:#f92672">.</span><span style="color:#111">listen</span><span style="color:#111">(</span><span style="color:#ae81ff">5</span><span style="color:#111">)</span>  <span style="color:#75715e"># 同一时刻有5个请求，但是可以有N多个链接。 开机。</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">conn</span><span style="color:#111">,</span> <span style="color:#111">client_addr</span> <span style="color:#f92672">=</span> <span style="color:#111">phone</span><span style="color:#f92672">.</span><span style="color:#111">accept</span><span style="color:#111">()</span>  <span style="color:#75715e"># 接电话</span>
</span></span><span style="display:flex;"><span><span style="color:#111">print</span><span style="color:#111">(</span><span style="color:#111">conn</span><span style="color:#111">,</span> <span style="color:#111">client_addr</span><span style="color:#111">,</span> <span style="color:#111">sep</span><span style="color:#f92672">=</span><span style="color:#d88200">&#39;</span><span style="color:#8045ff">\n</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">from_client_data</span> <span style="color:#f92672">=</span> <span style="color:#111">conn</span><span style="color:#f92672">.</span><span style="color:#111">recv</span><span style="color:#111">(</span><span style="color:#ae81ff">1024</span><span style="color:#111">)</span>  <span style="color:#75715e"># 一次接收的最大限制  bytes</span>
</span></span><span style="display:flex;"><span><span style="color:#111">print</span><span style="color:#111">(</span><span style="color:#111">from_client_data</span><span style="color:#f92672">.</span><span style="color:#111">decode</span><span style="color:#111">(</span><span style="color:#d88200">&#39;utf-8&#39;</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">conn</span><span style="color:#f92672">.</span><span style="color:#111">send</span><span style="color:#111">(</span><span style="color:#111">from_client_data</span><span style="color:#f92672">.</span><span style="color:#111">upper</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">conn</span><span style="color:#f92672">.</span><span style="color:#111">close</span><span style="color:#111">()</span>  <span style="color:#75715e"># 挂电话</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">phone</span><span style="color:#f92672">.</span><span style="color:#111">close</span><span style="color:#111">()</span> <span style="color:#75715e"># 关机</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">服务端</span>
</span></span></code></pre></div><p>第二版，通信循环</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">socket</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">phone</span> <span style="color:#f92672">=</span> <span style="color:#111">socket</span><span style="color:#f92672">.</span><span style="color:#111">socket</span><span style="color:#111">(</span><span style="color:#111">socket</span><span style="color:#f92672">.</span><span style="color:#111">AF_INET</span><span style="color:#111">,</span><span style="color:#111">socket</span><span style="color:#f92672">.</span><span style="color:#111">SOCK_STREAM</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">phone</span><span style="color:#f92672">.</span><span style="color:#111">bind</span><span style="color:#111">((</span><span style="color:#d88200">&#39;127.0.0.1&#39;</span><span style="color:#111">,</span><span style="color:#ae81ff">8080</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">phone</span><span style="color:#f92672">.</span><span style="color:#111">listen</span><span style="color:#111">(</span><span style="color:#ae81ff">5</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">conn</span><span style="color:#111">,</span> <span style="color:#111">client_addr</span> <span style="color:#f92672">=</span> <span style="color:#111">phone</span><span style="color:#f92672">.</span><span style="color:#111">accept</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">print</span><span style="color:#111">(</span><span style="color:#111">conn</span><span style="color:#111">,</span> <span style="color:#111">client_addr</span><span style="color:#111">,</span> <span style="color:#111">sep</span><span style="color:#f92672">=</span><span style="color:#d88200">&#39;</span><span style="color:#8045ff">\n</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">while</span> <span style="color:#ae81ff">1</span><span style="color:#111">:</span>  <span style="color:#75715e"># 循环收发消息</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">try</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">from_client_data</span> <span style="color:#f92672">=</span> <span style="color:#111">conn</span><span style="color:#f92672">.</span><span style="color:#111">recv</span><span style="color:#111">(</span><span style="color:#ae81ff">1024</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">print</span><span style="color:#111">(</span><span style="color:#111">from_client_data</span><span style="color:#f92672">.</span><span style="color:#111">decode</span><span style="color:#111">(</span><span style="color:#d88200">&#39;utf-8&#39;</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>        <span style="color:#111">conn</span><span style="color:#f92672">.</span><span style="color:#111">send</span><span style="color:#111">(</span><span style="color:#111">from_client_data</span> <span style="color:#f92672">+</span> <span style="color:#d88200">b</span><span style="color:#d88200">&#39;SB&#39;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">except</span> <span style="color:#75af00">ConnectionResetError</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">break</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">conn</span><span style="color:#f92672">.</span><span style="color:#111">close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">phone</span><span style="color:#f92672">.</span><span style="color:#111">close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">socket</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">phone</span> <span style="color:#f92672">=</span> <span style="color:#111">socket</span><span style="color:#f92672">.</span><span style="color:#111">socket</span><span style="color:#111">(</span><span style="color:#111">socket</span><span style="color:#f92672">.</span><span style="color:#111">AF_INET</span><span style="color:#111">,</span><span style="color:#111">socket</span><span style="color:#f92672">.</span><span style="color:#111">SOCK_STREAM</span><span style="color:#111">)</span>  <span style="color:#75715e"># 买电话</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">phone</span><span style="color:#f92672">.</span><span style="color:#111">connect</span><span style="color:#111">((</span><span style="color:#d88200">&#39;127.0.0.1&#39;</span><span style="color:#111">,</span><span style="color:#ae81ff">8080</span><span style="color:#111">))</span>  <span style="color:#75715e"># 与客户端建立连接， 拨号</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">while</span> <span style="color:#ae81ff">1</span><span style="color:#111">:</span>  <span style="color:#75715e"># 循环收发消息</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">client_data</span> <span style="color:#f92672">=</span> <span style="color:#111">input</span><span style="color:#111">(</span><span style="color:#d88200">&#39;&gt;&gt;&gt;&#39;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">phone</span><span style="color:#f92672">.</span><span style="color:#111">send</span><span style="color:#111">(</span><span style="color:#111">client_data</span><span style="color:#f92672">.</span><span style="color:#111">encode</span><span style="color:#111">(</span><span style="color:#d88200">&#39;utf-8&#39;</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#111">from_server_data</span> <span style="color:#f92672">=</span> <span style="color:#111">phone</span><span style="color:#f92672">.</span><span style="color:#111">recv</span><span style="color:#111">(</span><span style="color:#ae81ff">1024</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#111">print</span><span style="color:#111">(</span><span style="color:#111">from_server_data</span><span style="color:#f92672">.</span><span style="color:#111">decode</span><span style="color:#111">(</span><span style="color:#d88200">&#39;utf-8&#39;</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">phone</span><span style="color:#f92672">.</span><span style="color:#111">close</span><span style="color:#111">()</span>  <span style="color:#75715e"># 挂电话</span>
</span></span></code></pre></div><p>第三版， 通信，连接循环</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">socket</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">phone</span> <span style="color:#f92672">=</span> <span style="color:#111">socket</span><span style="color:#f92672">.</span><span style="color:#111">socket</span><span style="color:#111">(</span><span style="color:#111">socket</span><span style="color:#f92672">.</span><span style="color:#111">AF_INET</span><span style="color:#111">,</span><span style="color:#111">socket</span><span style="color:#f92672">.</span><span style="color:#111">SOCK_STREAM</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">phone</span><span style="color:#f92672">.</span><span style="color:#111">bind</span><span style="color:#111">((</span><span style="color:#d88200">&#39;127.0.0.1&#39;</span><span style="color:#111">,</span><span style="color:#ae81ff">8080</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">phone</span><span style="color:#f92672">.</span><span style="color:#111">listen</span><span style="color:#111">(</span><span style="color:#ae81ff">5</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">while</span> <span style="color:#ae81ff">1</span> <span style="color:#111">:</span> <span style="color:#75715e"># 循环连接客户端</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">conn</span><span style="color:#111">,</span> <span style="color:#111">client_addr</span> <span style="color:#f92672">=</span> <span style="color:#111">phone</span><span style="color:#f92672">.</span><span style="color:#111">accept</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">print</span><span style="color:#111">(</span><span style="color:#111">client_addr</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">while</span> <span style="color:#ae81ff">1</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">try</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">from_client_data</span> <span style="color:#f92672">=</span> <span style="color:#111">conn</span><span style="color:#f92672">.</span><span style="color:#111">recv</span><span style="color:#111">(</span><span style="color:#ae81ff">1024</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">print</span><span style="color:#111">(</span><span style="color:#111">from_client_data</span><span style="color:#f92672">.</span><span style="color:#111">decode</span><span style="color:#111">(</span><span style="color:#d88200">&#39;utf-8&#39;</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>            <span style="color:#111">conn</span><span style="color:#f92672">.</span><span style="color:#111">send</span><span style="color:#111">(</span><span style="color:#111">from_client_data</span> <span style="color:#f92672">+</span> <span style="color:#d88200">b</span><span style="color:#d88200">&#39;SB&#39;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">except</span> <span style="color:#75af00">ConnectionResetError</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">break</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">conn</span><span style="color:#f92672">.</span><span style="color:#111">close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">phone</span><span style="color:#f92672">.</span><span style="color:#111">close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">socket</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">phone</span> <span style="color:#f92672">=</span> <span style="color:#111">socket</span><span style="color:#f92672">.</span><span style="color:#111">socket</span><span style="color:#111">(</span><span style="color:#111">socket</span><span style="color:#f92672">.</span><span style="color:#111">AF_INET</span><span style="color:#111">,</span><span style="color:#111">socket</span><span style="color:#f92672">.</span><span style="color:#111">SOCK_STREAM</span><span style="color:#111">)</span>  <span style="color:#75715e"># 买电话</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">phone</span><span style="color:#f92672">.</span><span style="color:#111">connect</span><span style="color:#111">((</span><span style="color:#d88200">&#39;127.0.0.1&#39;</span><span style="color:#111">,</span><span style="color:#ae81ff">8080</span><span style="color:#111">))</span>  <span style="color:#75715e"># 与客户端建立连接， 拨号</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">while</span> <span style="color:#ae81ff">1</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">client_data</span> <span style="color:#f92672">=</span> <span style="color:#111">input</span><span style="color:#111">(</span><span style="color:#d88200">&#39;&gt;&gt;&gt;&#39;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">phone</span><span style="color:#f92672">.</span><span style="color:#111">send</span><span style="color:#111">(</span><span style="color:#111">client_data</span><span style="color:#f92672">.</span><span style="color:#111">encode</span><span style="color:#111">(</span><span style="color:#d88200">&#39;utf-8&#39;</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#111">from_server_data</span> <span style="color:#f92672">=</span> <span style="color:#111">phone</span><span style="color:#f92672">.</span><span style="color:#111">recv</span><span style="color:#111">(</span><span style="color:#ae81ff">1024</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#111">print</span><span style="color:#111">(</span><span style="color:#111">from_server_data</span><span style="color:#f92672">.</span><span style="color:#111">decode</span><span style="color:#111">(</span><span style="color:#d88200">&#39;utf-8&#39;</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">phone</span><span style="color:#f92672">.</span><span style="color:#111">close</span><span style="color:#111">()</span>  <span style="color:#75715e"># 挂电话</span>
</span></span></code></pre></div><p><em><strong>详解recv的工作原理</strong></em></p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#d88200">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#d88200">源码解释：
</span></span></span><span style="display:flex;"><span><span style="color:#d88200">Receive up to buffersize bytes from the socket.
</span></span></span><span style="display:flex;"><span><span style="color:#d88200">接收来自socket缓冲区的字节数据，
</span></span></span><span style="display:flex;"><span><span style="color:#d88200">For the optional flags argument, see the Unix manual.
</span></span></span><span style="display:flex;"><span><span style="color:#d88200">对于这些设置的参数，可以查看Unix手册。
</span></span></span><span style="display:flex;"><span><span style="color:#d88200">When no data is available, block untilat least one byte is available or until the remote end is closed.
</span></span></span><span style="display:flex;"><span><span style="color:#d88200">当缓冲区没有数据可取时，recv会一直处于阻塞状态，直到缓冲区至少有一个字节数据可取，或者远程端关闭。
</span></span></span><span style="display:flex;"><span><span style="color:#d88200">When the remote end is closed and all data is read, return the empty string.
</span></span></span><span style="display:flex;"><span><span style="color:#d88200">关闭远程端并读取所有数据后，返回空字符串。
</span></span></span><span style="display:flex;"><span><span style="color:#d88200">&#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">----------</span><span style="color:#111">服务端</span><span style="color:#f92672">------------</span><span style="color:#960050;background-color:#1e0010">：</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 1，验证服务端缓冲区数据没有取完，又执行了recv执行，recv会继续取值。</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">socket</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">phone</span> <span style="color:#f92672">=</span><span style="color:#111">socket</span><span style="color:#f92672">.</span><span style="color:#111">socket</span><span style="color:#111">(</span><span style="color:#111">socket</span><span style="color:#f92672">.</span><span style="color:#111">AF_INET</span><span style="color:#111">,</span><span style="color:#111">socket</span><span style="color:#f92672">.</span><span style="color:#111">SOCK_STREAM</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">phone</span><span style="color:#f92672">.</span><span style="color:#111">bind</span><span style="color:#111">((</span><span style="color:#d88200">&#39;127.0.0.1&#39;</span><span style="color:#111">,</span><span style="color:#ae81ff">8080</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">phone</span><span style="color:#f92672">.</span><span style="color:#111">listen</span><span style="color:#111">(</span><span style="color:#ae81ff">5</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">conn</span><span style="color:#111">,</span> <span style="color:#111">client_addr</span> <span style="color:#f92672">=</span> <span style="color:#111">phone</span><span style="color:#f92672">.</span><span style="color:#111">accept</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">from_client_data1</span> <span style="color:#f92672">=</span> <span style="color:#111">conn</span><span style="color:#f92672">.</span><span style="color:#111">recv</span><span style="color:#111">(</span><span style="color:#ae81ff">2</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">print</span><span style="color:#111">(</span><span style="color:#111">from_client_data1</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">from_client_data2</span> <span style="color:#f92672">=</span> <span style="color:#111">conn</span><span style="color:#f92672">.</span><span style="color:#111">recv</span><span style="color:#111">(</span><span style="color:#ae81ff">2</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">print</span><span style="color:#111">(</span><span style="color:#111">from_client_data2</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">from_client_data3</span> <span style="color:#f92672">=</span> <span style="color:#111">conn</span><span style="color:#f92672">.</span><span style="color:#111">recv</span><span style="color:#111">(</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">print</span><span style="color:#111">(</span><span style="color:#111">from_client_data3</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">conn</span><span style="color:#f92672">.</span><span style="color:#111">close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">phone</span><span style="color:#f92672">.</span><span style="color:#111">close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 2，验证服务端缓冲区取完了，又执行了recv执行，此时客户端20秒内不关闭的前提下，recv处于阻塞状态。</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">socket</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">phone</span> <span style="color:#f92672">=</span><span style="color:#111">socket</span><span style="color:#f92672">.</span><span style="color:#111">socket</span><span style="color:#111">(</span><span style="color:#111">socket</span><span style="color:#f92672">.</span><span style="color:#111">AF_INET</span><span style="color:#111">,</span><span style="color:#111">socket</span><span style="color:#f92672">.</span><span style="color:#111">SOCK_STREAM</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">phone</span><span style="color:#f92672">.</span><span style="color:#111">bind</span><span style="color:#111">((</span><span style="color:#d88200">&#39;127.0.0.1&#39;</span><span style="color:#111">,</span><span style="color:#ae81ff">8080</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">phone</span><span style="color:#f92672">.</span><span style="color:#111">listen</span><span style="color:#111">(</span><span style="color:#ae81ff">5</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">conn</span><span style="color:#111">,</span> <span style="color:#111">client_addr</span> <span style="color:#f92672">=</span> <span style="color:#111">phone</span><span style="color:#f92672">.</span><span style="color:#111">accept</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">from_client_data</span> <span style="color:#f92672">=</span> <span style="color:#111">conn</span><span style="color:#f92672">.</span><span style="color:#111">recv</span><span style="color:#111">(</span><span style="color:#ae81ff">1024</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">print</span><span style="color:#111">(</span><span style="color:#111">from_client_data</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">print</span><span style="color:#111">(</span><span style="color:#ae81ff">111</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">conn</span><span style="color:#f92672">.</span><span style="color:#111">recv</span><span style="color:#111">(</span><span style="color:#ae81ff">1024</span><span style="color:#111">)</span> <span style="color:#75715e"># 此时程序阻塞20秒左右，因为缓冲区的数据取完了，并且20秒内，客户端没有关闭。</span>
</span></span><span style="display:flex;"><span><span style="color:#111">print</span><span style="color:#111">(</span><span style="color:#ae81ff">222</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">conn</span><span style="color:#f92672">.</span><span style="color:#111">close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">phone</span><span style="color:#f92672">.</span><span style="color:#111">close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 3 验证服务端缓冲区取完了，又执行了recv执行，此时客户端处于关闭状态，则recv会取到空字符串。</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">socket</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">phone</span> <span style="color:#f92672">=</span><span style="color:#111">socket</span><span style="color:#f92672">.</span><span style="color:#111">socket</span><span style="color:#111">(</span><span style="color:#111">socket</span><span style="color:#f92672">.</span><span style="color:#111">AF_INET</span><span style="color:#111">,</span><span style="color:#111">socket</span><span style="color:#f92672">.</span><span style="color:#111">SOCK_STREAM</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">phone</span><span style="color:#f92672">.</span><span style="color:#111">bind</span><span style="color:#111">((</span><span style="color:#d88200">&#39;127.0.0.1&#39;</span><span style="color:#111">,</span><span style="color:#ae81ff">8080</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">phone</span><span style="color:#f92672">.</span><span style="color:#111">listen</span><span style="color:#111">(</span><span style="color:#ae81ff">5</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">conn</span><span style="color:#111">,</span> <span style="color:#111">client_addr</span> <span style="color:#f92672">=</span> <span style="color:#111">phone</span><span style="color:#f92672">.</span><span style="color:#111">accept</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">from_client_data1</span> <span style="color:#f92672">=</span> <span style="color:#111">conn</span><span style="color:#f92672">.</span><span style="color:#111">recv</span><span style="color:#111">(</span><span style="color:#ae81ff">1024</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">print</span><span style="color:#111">(</span><span style="color:#111">from_client_data1</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">from_client_data2</span> <span style="color:#f92672">=</span> <span style="color:#111">conn</span><span style="color:#f92672">.</span><span style="color:#111">recv</span><span style="color:#111">(</span><span style="color:#ae81ff">1024</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">print</span><span style="color:#111">(</span><span style="color:#111">from_client_data2</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">from_client_data3</span> <span style="color:#f92672">=</span> <span style="color:#111">conn</span><span style="color:#f92672">.</span><span style="color:#111">recv</span><span style="color:#111">(</span><span style="color:#ae81ff">1024</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">print</span><span style="color:#111">(</span><span style="color:#111">from_client_data3</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">conn</span><span style="color:#f92672">.</span><span style="color:#111">close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">phone</span><span style="color:#f92672">.</span><span style="color:#111">close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">------------</span><span style="color:#111">客户端</span><span style="color:#f92672">------------</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 1，验证服务端缓冲区数据没有取完，又执行了recv执行，recv会继续取值。</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">socket</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">time</span>
</span></span><span style="display:flex;"><span><span style="color:#111">phone</span> <span style="color:#f92672">=</span> <span style="color:#111">socket</span><span style="color:#f92672">.</span><span style="color:#111">socket</span><span style="color:#111">(</span><span style="color:#111">socket</span><span style="color:#f92672">.</span><span style="color:#111">AF_INET</span><span style="color:#111">,</span><span style="color:#111">socket</span><span style="color:#f92672">.</span><span style="color:#111">SOCK_STREAM</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">phone</span><span style="color:#f92672">.</span><span style="color:#111">connect</span><span style="color:#111">((</span><span style="color:#d88200">&#39;127.0.0.1&#39;</span><span style="color:#111">,</span><span style="color:#ae81ff">8080</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span><span style="color:#111">phone</span><span style="color:#f92672">.</span><span style="color:#111">send</span><span style="color:#111">(</span><span style="color:#d88200">&#39;hello&#39;</span><span style="color:#f92672">.</span><span style="color:#111">encode</span><span style="color:#111">(</span><span style="color:#d88200">&#39;utf-8&#39;</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span><span style="color:#111">time</span><span style="color:#f92672">.</span><span style="color:#111">sleep</span><span style="color:#111">(</span><span style="color:#ae81ff">20</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">phone</span><span style="color:#f92672">.</span><span style="color:#111">close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 2，验证服务端缓冲区取完了，又执行了recv执行，此时客户端20秒内不关闭的前提下，recv处于阻塞状态。</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">socket</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">time</span>
</span></span><span style="display:flex;"><span><span style="color:#111">phone</span> <span style="color:#f92672">=</span> <span style="color:#111">socket</span><span style="color:#f92672">.</span><span style="color:#111">socket</span><span style="color:#111">(</span><span style="color:#111">socket</span><span style="color:#f92672">.</span><span style="color:#111">AF_INET</span><span style="color:#111">,</span><span style="color:#111">socket</span><span style="color:#f92672">.</span><span style="color:#111">SOCK_STREAM</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">phone</span><span style="color:#f92672">.</span><span style="color:#111">connect</span><span style="color:#111">((</span><span style="color:#d88200">&#39;127.0.0.1&#39;</span><span style="color:#111">,</span><span style="color:#ae81ff">8080</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span><span style="color:#111">phone</span><span style="color:#f92672">.</span><span style="color:#111">send</span><span style="color:#111">(</span><span style="color:#d88200">&#39;hello&#39;</span><span style="color:#f92672">.</span><span style="color:#111">encode</span><span style="color:#111">(</span><span style="color:#d88200">&#39;utf-8&#39;</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span><span style="color:#111">time</span><span style="color:#f92672">.</span><span style="color:#111">sleep</span><span style="color:#111">(</span><span style="color:#ae81ff">20</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">phone</span><span style="color:#f92672">.</span><span style="color:#111">close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 3，验证服务端缓冲区取完了，又执行了recv执行，此时客户端处于关闭状态，则recv会取到空字符串。</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">socket</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">time</span>
</span></span><span style="display:flex;"><span><span style="color:#111">phone</span> <span style="color:#f92672">=</span> <span style="color:#111">socket</span><span style="color:#f92672">.</span><span style="color:#111">socket</span><span style="color:#111">(</span><span style="color:#111">socket</span><span style="color:#f92672">.</span><span style="color:#111">AF_INET</span><span style="color:#111">,</span><span style="color:#111">socket</span><span style="color:#f92672">.</span><span style="color:#111">SOCK_STREAM</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">phone</span><span style="color:#f92672">.</span><span style="color:#111">connect</span><span style="color:#111">((</span><span style="color:#d88200">&#39;127.0.0.1&#39;</span><span style="color:#111">,</span><span style="color:#ae81ff">8080</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span><span style="color:#111">phone</span><span style="color:#f92672">.</span><span style="color:#111">send</span><span style="color:#111">(</span><span style="color:#d88200">&#39;hello&#39;</span><span style="color:#f92672">.</span><span style="color:#111">encode</span><span style="color:#111">(</span><span style="color:#d88200">&#39;utf-8&#39;</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span><span style="color:#111">phone</span><span style="color:#f92672">.</span><span style="color:#111">close</span><span style="color:#111">()</span>
</span></span></code></pre></div><p>远程执行命令的示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">socket</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">subprocess</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">phone</span> <span style="color:#f92672">=</span> <span style="color:#111">socket</span><span style="color:#f92672">.</span><span style="color:#111">socket</span><span style="color:#111">(</span><span style="color:#111">socket</span><span style="color:#f92672">.</span><span style="color:#111">AF_INET</span><span style="color:#111">,</span><span style="color:#111">socket</span><span style="color:#f92672">.</span><span style="color:#111">SOCK_STREAM</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">phone</span><span style="color:#f92672">.</span><span style="color:#111">bind</span><span style="color:#111">((</span><span style="color:#d88200">&#39;127.0.0.1&#39;</span><span style="color:#111">,</span><span style="color:#ae81ff">8080</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">phone</span><span style="color:#f92672">.</span><span style="color:#111">listen</span><span style="color:#111">(</span><span style="color:#ae81ff">5</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">while</span> <span style="color:#ae81ff">1</span> <span style="color:#111">:</span> <span style="color:#75715e"># 循环连接客户端</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">conn</span><span style="color:#111">,</span> <span style="color:#111">client_addr</span> <span style="color:#f92672">=</span> <span style="color:#111">phone</span><span style="color:#f92672">.</span><span style="color:#111">accept</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">print</span><span style="color:#111">(</span><span style="color:#111">client_addr</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">while</span> <span style="color:#ae81ff">1</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">try</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">cmd</span> <span style="color:#f92672">=</span> <span style="color:#111">conn</span><span style="color:#f92672">.</span><span style="color:#111">recv</span><span style="color:#111">(</span><span style="color:#ae81ff">1024</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">ret</span> <span style="color:#f92672">=</span> <span style="color:#111">subprocess</span><span style="color:#f92672">.</span><span style="color:#111">Popen</span><span style="color:#111">(</span><span style="color:#111">cmd</span><span style="color:#f92672">.</span><span style="color:#111">decode</span><span style="color:#111">(</span><span style="color:#d88200">&#39;utf-8&#39;</span><span style="color:#111">),</span><span style="color:#111">shell</span><span style="color:#f92672">=</span><span style="color:#00a8c8">True</span><span style="color:#111">,</span><span style="color:#111">stdout</span><span style="color:#f92672">=</span><span style="color:#111">subprocess</span><span style="color:#f92672">.</span><span style="color:#111">PIPE</span><span style="color:#111">,</span><span style="color:#111">stderr</span><span style="color:#f92672">=</span><span style="color:#111">subprocess</span><span style="color:#f92672">.</span><span style="color:#111">PIPE</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">correct_msg</span> <span style="color:#f92672">=</span> <span style="color:#111">ret</span><span style="color:#f92672">.</span><span style="color:#111">stdout</span><span style="color:#f92672">.</span><span style="color:#111">read</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">error_msg</span> <span style="color:#f92672">=</span> <span style="color:#111">ret</span><span style="color:#f92672">.</span><span style="color:#111">stderr</span><span style="color:#f92672">.</span><span style="color:#111">read</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">conn</span><span style="color:#f92672">.</span><span style="color:#111">send</span><span style="color:#111">(</span><span style="color:#111">correct_msg</span> <span style="color:#f92672">+</span> <span style="color:#111">error_msg</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">except</span> <span style="color:#75af00">ConnectionResetError</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">break</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">conn</span><span style="color:#f92672">.</span><span style="color:#111">close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">phone</span><span style="color:#f92672">.</span><span style="color:#111">close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">socket</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">phone</span> <span style="color:#f92672">=</span> <span style="color:#111">socket</span><span style="color:#f92672">.</span><span style="color:#111">socket</span><span style="color:#111">(</span><span style="color:#111">socket</span><span style="color:#f92672">.</span><span style="color:#111">AF_INET</span><span style="color:#111">,</span><span style="color:#111">socket</span><span style="color:#f92672">.</span><span style="color:#111">SOCK_STREAM</span><span style="color:#111">)</span>  <span style="color:#75715e"># 买电话</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">phone</span><span style="color:#f92672">.</span><span style="color:#111">connect</span><span style="color:#111">((</span><span style="color:#d88200">&#39;127.0.0.1&#39;</span><span style="color:#111">,</span><span style="color:#ae81ff">8080</span><span style="color:#111">))</span>  <span style="color:#75715e"># 与客户端建立连接， 拨号</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">while</span> <span style="color:#ae81ff">1</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">cmd</span> <span style="color:#f92672">=</span> <span style="color:#111">input</span><span style="color:#111">(</span><span style="color:#d88200">&#39;&gt;&gt;&gt;&#39;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">phone</span><span style="color:#f92672">.</span><span style="color:#111">send</span><span style="color:#111">(</span><span style="color:#111">cmd</span><span style="color:#f92672">.</span><span style="color:#111">encode</span><span style="color:#111">(</span><span style="color:#d88200">&#39;utf-8&#39;</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#111">from_server_data</span> <span style="color:#f92672">=</span> <span style="color:#111">phone</span><span style="color:#f92672">.</span><span style="color:#111">recv</span><span style="color:#111">(</span><span style="color:#ae81ff">1024</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#111">print</span><span style="color:#111">(</span><span style="color:#111">from_server_data</span><span style="color:#f92672">.</span><span style="color:#111">decode</span><span style="color:#111">(</span><span style="color:#d88200">&#39;gbk&#39;</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">phone</span><span style="color:#f92672">.</span><span style="color:#111">close</span><span style="color:#111">()</span>  <span style="color:#75715e"># 挂电话</span>
</span></span></code></pre></div><h5 id="远程执行命令">远程执行命令</h5>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">socket</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">subprocess</span>
</span></span><span style="display:flex;"><span><span style="color:#111">phone</span> <span style="color:#f92672">=</span> <span style="color:#111">socket</span><span style="color:#f92672">.</span><span style="color:#111">socket</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">phone</span><span style="color:#f92672">.</span><span style="color:#111">bind</span><span style="color:#111">((</span><span style="color:#d88200">&#34;127.0.0.1&#34;</span><span style="color:#111">,</span><span style="color:#ae81ff">8848</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span><span style="color:#111">phone</span><span style="color:#f92672">.</span><span style="color:#111">listen</span><span style="color:#111">(</span><span style="color:#ae81ff">2</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">while</span> <span style="color:#ae81ff">1</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">conn</span><span style="color:#111">,</span><span style="color:#111">addr</span> <span style="color:#f92672">=</span> <span style="color:#111">phone</span><span style="color:#f92672">.</span><span style="color:#111">accept</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">print</span><span style="color:#111">(</span><span style="color:#d88200">f</span><span style="color:#d88200">&#34;连接来了:</span><span style="color:#d88200">{</span><span style="color:#111">coon</span><span style="color:#111">,</span><span style="color:#111">addr</span><span style="color:#d88200">}</span><span style="color:#d88200">&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">while</span> <span style="color:#ae81ff">1</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">try</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">from_client_data</span> <span style="color:#f92672">=</span> <span style="color:#111">conn</span><span style="color:#f92672">.</span><span style="color:#111">recv</span><span style="color:#111">(</span><span style="color:#ae81ff">1024</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">if</span> <span style="color:#111">from_client_data</span><span style="color:#f92672">.</span><span style="color:#111">upper</span><span style="color:#111">()</span> <span style="color:#f92672">==</span> <span style="color:#d88200">b</span><span style="color:#d88200">&#34;Q&#34;</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#111">print</span><span style="color:#111">(</span><span style="color:#d88200">&#34;客户端正常退出聊天了&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#00a8c8">break</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">obj</span> <span style="color:#f92672">=</span> <span style="color:#111">subprocess</span><span style="color:#f92672">.</span><span style="color:#111">Pepen</span><span style="color:#111">(</span><span style="color:#111">from_client_data</span><span style="color:#f92672">.</span><span style="color:#111">decode</span><span style="color:#111">(</span><span style="color:#d88200">&#39;utf-8&#39;</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>                                   <span style="color:#111">shell</span><span style="color:#f92672">=</span><span style="color:#00a8c8">True</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>                                   <span style="color:#111">stdout</span><span style="color:#f92672">=</span><span style="color:#111">subprocess</span><span style="color:#f92672">.</span><span style="color:#111">PIPE</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>                                   <span style="color:#111">stderr</span><span style="color:#f92672">=</span><span style="color:#111">subprocess</span><span style="color:#f92672">.</span><span style="color:#111">PIPE</span><span style="color:#111">,)</span>
</span></span><span style="display:flex;"><span>    		<span style="color:#111">result</span> <span style="color:#f92672">=</span> <span style="color:#111">obj</span><span style="color:#f92672">.</span><span style="color:#111">stdout</span><span style="color:#f92672">.</span><span style="color:#111">read</span><span style="color:#111">()</span> <span style="color:#f92672">+</span> <span style="color:#111">obj</span><span style="color:#f92672">.</span><span style="color:#111">stderr</span><span style="color:#f92672">.</span><span style="color:#111">read</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>             <span style="color:#111">conn</span><span style="color:#f92672">.</span><span style="color:#111">send</span><span style="color:#111">(</span><span style="color:#111">result</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>         <span style="color:#00a8c8">except</span> <span style="color:#75af00">ConnectionResetError</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">print</span><span style="color:#111">(</span><span style="color:#d88200">&#39;客户端链接中断了&#39;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">break</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">conn</span><span style="color:#f92672">.</span><span style="color:#111">close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">phone</span><span style="color:#f92672">.</span><span style="color:#111">close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">socket</span>
</span></span><span style="display:flex;"><span><span style="color:#111">phone</span> <span style="color:#f92672">=</span> <span style="color:#111">socket</span><span style="color:#f92672">.</span><span style="color:#111">socket</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">phone</span><span style="color:#f92672">.</span><span style="color:#111">connect</span><span style="color:#111">((</span><span style="color:#d88200">&#34;127.0.0.1&#34;</span><span style="color:#111">,</span><span style="color:#ae81ff">8848</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">while</span> <span style="color:#ae81ff">1</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">to_server_data</span> <span style="color:#f92672">=</span> <span style="color:#111">input</span><span style="color:#111">(</span><span style="color:#d88200">&#34;&gt;&gt;&gt;&#34;</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">strip</span><span style="color:#111">()</span><span style="color:#f92672">.</span><span style="color:#111">encode</span><span style="color:#111">(</span><span style="color:#d88200">&#39;utf-8&#39;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#f92672">not</span> <span style="color:#111">to_server_data</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 服务端如果接受到了空的内容，服务端就会一直阻塞中，所以无论哪一端发送内容时，都不能为空发送</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">print</span><span style="color:#111">(</span><span style="color:#d88200">&#39;发送内容不能为空&#39;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">continue</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">phone</span><span style="color:#f92672">.</span><span style="color:#111">send</span><span style="color:#111">(</span><span style="color:#111">to_server_data</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#111">to_server_data</span><span style="color:#f92672">.</span><span style="color:#111">upper</span><span style="color:#111">()</span> <span style="color:#f92672">==</span> <span style="color:#d88200">b</span><span style="color:#d88200">&#39;Q&#39;</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">break</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">from_server_data</span> <span style="color:#f92672">=</span> <span style="color:#111">phone</span><span style="color:#f92672">.</span><span style="color:#111">recv</span><span style="color:#111">(</span><span style="color:#ae81ff">1024</span><span style="color:#111">)</span>  <span style="color:#75715e"># 最多接受1024字节</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">print</span><span style="color:#111">(</span><span style="color:#d88200">f</span><span style="color:#d88200">&#39;</span><span style="color:#d88200">{</span><span style="color:#111">from_server_data</span><span style="color:#f92672">.</span><span style="color:#111">decode</span><span style="color:#111">(</span><span style="color:#d88200">&#34;gbk&#34;</span><span style="color:#111">)</span><span style="color:#d88200">}</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">phone</span><span style="color:#f92672">.</span><span style="color:#111">close</span><span style="color:#111">()</span>
</span></span></code></pre></div><h3 id="粘包">粘包</h3>
<p><img src="/images/79ec95d0-52c8-4294-831d-710d95fdc6fc.png" alt=""></p>
<p>每个 socket 被创建后，都会分配两个缓冲区，输入缓冲区和输出缓冲区。</p>
<p>write()/send() 并不立即向网络中传输数据，而是先将数据写入缓冲区中，再由TCP协议将数据从缓冲区发送到目标机器。一旦将数据写入到缓冲区，函数就可以成功返回，不管它们有没有到达目标机器，也不管它们何时被发送到网络，这些都是TCP协议负责的事情。</p>
<p>TCP协议独立于 write()/send() 函数，数据有可能刚被写入缓冲区就发送到网络，也可能在缓冲区中不断积压，多次写入的数据被一次性发送到网络，这取决于当时的网络情况、当前线程是否空闲等诸多因素，不由程序员控制。</p>
<p>read()/recv() 函数也是如此，也从输入缓冲区中读取数据，而不是直接从网络中读取。</p>
<p>这些I/O缓冲区特性可整理如下：</p>
<p>1.I/O缓冲区在每个TCP套接字中单独存在； 2.I/O缓冲区在创建套接字时自动生成； 3.即使关闭套接字也会继续传送输出缓冲区中遗留的数据； 4.关闭套接字将丢失输入缓冲区中的数据。</p>
<p>输入输出缓冲区的默认大小一般都是 8K，可以通过 getsockopt() 函数获取：</p>
<ol>
<li>unsigned optVal;</li>
<li>int optLen = sizeof(int);</li>
<li>getsockopt(servSock, SOL_SOCKET, SO_SNDBUF,(char*)&amp;optVal, &amp;optLen);</li>
<li>printf(&ldquo;Buffer length: %d\n&rdquo;, optVal);</li>
</ol>
<p>socket缓冲区解释</p>
<p>socket缓存区的详细解释</p>
<h4 id="哪些情况会发生粘包">哪些情况会发生粘包</h4>
<ol>
<li>
<p>接收方没有及时接收缓冲区的包，造成多个包接收（客户端发送了一段数据，服务端只收了一小部分，服务端下次再收的时候还是从缓冲区拿上次遗留的数据，产生粘包）</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">socket</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">subprocess</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">phone</span> <span style="color:#f92672">=</span> <span style="color:#111">socket</span><span style="color:#f92672">.</span><span style="color:#111">socket</span><span style="color:#111">(</span><span style="color:#111">socket</span><span style="color:#f92672">.</span><span style="color:#111">AF_INET</span><span style="color:#111">,</span> <span style="color:#111">socket</span><span style="color:#f92672">.</span><span style="color:#111">SOCK_STREAM</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">phone</span><span style="color:#f92672">.</span><span style="color:#111">bind</span><span style="color:#111">((</span><span style="color:#d88200">&#39;127.0.0.1&#39;</span><span style="color:#111">,</span> <span style="color:#ae81ff">8080</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">phone</span><span style="color:#f92672">.</span><span style="color:#111">listen</span><span style="color:#111">(</span><span style="color:#ae81ff">5</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">while</span> <span style="color:#ae81ff">1</span><span style="color:#111">:</span>  <span style="color:#75715e"># 循环连接客户端</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">conn</span><span style="color:#111">,</span> <span style="color:#111">client_addr</span> <span style="color:#f92672">=</span> <span style="color:#111">phone</span><span style="color:#f92672">.</span><span style="color:#111">accept</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">print</span><span style="color:#111">(</span><span style="color:#111">client_addr</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">while</span> <span style="color:#ae81ff">1</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">try</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">cmd</span> <span style="color:#f92672">=</span> <span style="color:#111">conn</span><span style="color:#f92672">.</span><span style="color:#111">recv</span><span style="color:#111">(</span><span style="color:#ae81ff">1024</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">ret</span> <span style="color:#f92672">=</span> <span style="color:#111">subprocess</span><span style="color:#f92672">.</span><span style="color:#111">Popen</span><span style="color:#111">(</span><span style="color:#111">cmd</span><span style="color:#f92672">.</span><span style="color:#111">decode</span><span style="color:#111">(</span><span style="color:#d88200">&#39;utf-8&#39;</span><span style="color:#111">),</span> <span style="color:#111">shell</span><span style="color:#f92672">=</span><span style="color:#00a8c8">True</span><span style="color:#111">,</span> <span style="color:#111">stdout</span><span style="color:#f92672">=</span><span style="color:#111">subprocess</span><span style="color:#f92672">.</span><span style="color:#111">PIPE</span><span style="color:#111">,</span> <span style="color:#111">stderr</span><span style="color:#f92672">=</span><span style="color:#111">subprocess</span><span style="color:#f92672">.</span><span style="color:#111">PIPE</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">correct_msg</span> <span style="color:#f92672">=</span> <span style="color:#111">ret</span><span style="color:#f92672">.</span><span style="color:#111">stdout</span><span style="color:#f92672">.</span><span style="color:#111">read</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">error_msg</span> <span style="color:#f92672">=</span> <span style="color:#111">ret</span><span style="color:#f92672">.</span><span style="color:#111">stderr</span><span style="color:#f92672">.</span><span style="color:#111">read</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">conn</span><span style="color:#f92672">.</span><span style="color:#111">send</span><span style="color:#111">(</span><span style="color:#111">correct_msg</span> <span style="color:#f92672">+</span> <span style="color:#111">error_msg</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">except</span> <span style="color:#75af00">ConnectionResetError</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">break</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">conn</span><span style="color:#f92672">.</span><span style="color:#111">close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">phone</span><span style="color:#f92672">.</span><span style="color:#111">close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 服务端</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">socket</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">phone</span> <span style="color:#f92672">=</span> <span style="color:#111">socket</span><span style="color:#f92672">.</span><span style="color:#111">socket</span><span style="color:#111">(</span><span style="color:#111">socket</span><span style="color:#f92672">.</span><span style="color:#111">AF_INET</span><span style="color:#111">,</span><span style="color:#111">socket</span><span style="color:#f92672">.</span><span style="color:#111">SOCK_STREAM</span><span style="color:#111">)</span>  <span style="color:#75715e"># 买电话</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">phone</span><span style="color:#f92672">.</span><span style="color:#111">connect</span><span style="color:#111">((</span><span style="color:#d88200">&#39;127.0.0.1&#39;</span><span style="color:#111">,</span><span style="color:#ae81ff">8080</span><span style="color:#111">))</span>  <span style="color:#75715e"># 与客户端建立连接， 拨号</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">while</span> <span style="color:#ae81ff">1</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">cmd</span> <span style="color:#f92672">=</span> <span style="color:#111">input</span><span style="color:#111">(</span><span style="color:#d88200">&#39;&gt;&gt;&gt;&#39;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">phone</span><span style="color:#f92672">.</span><span style="color:#111">send</span><span style="color:#111">(</span><span style="color:#111">cmd</span><span style="color:#f92672">.</span><span style="color:#111">encode</span><span style="color:#111">(</span><span style="color:#d88200">&#39;utf-8&#39;</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">from_server_data</span> <span style="color:#f92672">=</span> <span style="color:#111">phone</span><span style="color:#f92672">.</span><span style="color:#111">recv</span><span style="color:#111">(</span><span style="color:#ae81ff">1024</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">print</span><span style="color:#111">(</span><span style="color:#111">from_server_data</span><span style="color:#f92672">.</span><span style="color:#111">decode</span><span style="color:#111">(</span><span style="color:#d88200">&#39;gbk&#39;</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">phone</span><span style="color:#f92672">.</span><span style="color:#111">close</span><span style="color:#111">()</span> 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 由于客户端发的命令获取的结果大小已经超过1024，那么下次在输入命令，会继续取上次残留到缓存区的数据。</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">客户端</span>
</span></span></code></pre></div></li>
<li>
<p>发送端需要等缓冲区满才发送出去，造成粘包（发送数据时间间隔很短，数据也很小，会合到一起，产生粘包）</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">socket</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">phone</span> <span style="color:#f92672">=</span> <span style="color:#111">socket</span><span style="color:#f92672">.</span><span style="color:#111">socket</span><span style="color:#111">(</span><span style="color:#111">socket</span><span style="color:#f92672">.</span><span style="color:#111">AF_INET</span><span style="color:#111">,</span> <span style="color:#111">socket</span><span style="color:#f92672">.</span><span style="color:#111">SOCK_STREAM</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">phone</span><span style="color:#f92672">.</span><span style="color:#111">bind</span><span style="color:#111">((</span><span style="color:#d88200">&#39;127.0.0.1&#39;</span><span style="color:#111">,</span> <span style="color:#ae81ff">8080</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">phone</span><span style="color:#f92672">.</span><span style="color:#111">listen</span><span style="color:#111">(</span><span style="color:#ae81ff">5</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">conn</span><span style="color:#111">,</span> <span style="color:#111">client_addr</span> <span style="color:#f92672">=</span> <span style="color:#111">phone</span><span style="color:#f92672">.</span><span style="color:#111">accept</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">frist_data</span> <span style="color:#f92672">=</span> <span style="color:#111">conn</span><span style="color:#f92672">.</span><span style="color:#111">recv</span><span style="color:#111">(</span><span style="color:#ae81ff">1024</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">print</span><span style="color:#111">(</span><span style="color:#d88200">&#39;1:&#39;</span><span style="color:#111">,</span><span style="color:#111">frist_data</span><span style="color:#f92672">.</span><span style="color:#111">decode</span><span style="color:#111">(</span><span style="color:#d88200">&#39;utf-8&#39;</span><span style="color:#111">))</span>  <span style="color:#75715e"># 1: helloworld</span>
</span></span><span style="display:flex;"><span><span style="color:#111">second_data</span> <span style="color:#f92672">=</span> <span style="color:#111">conn</span><span style="color:#f92672">.</span><span style="color:#111">recv</span><span style="color:#111">(</span><span style="color:#ae81ff">1024</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">print</span><span style="color:#111">(</span><span style="color:#d88200">&#39;2:&#39;</span><span style="color:#111">,</span><span style="color:#111">second_data</span><span style="color:#f92672">.</span><span style="color:#111">decode</span><span style="color:#111">(</span><span style="color:#d88200">&#39;utf-8&#39;</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">conn</span><span style="color:#f92672">.</span><span style="color:#111">close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">phone</span><span style="color:#f92672">.</span><span style="color:#111">close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 服务端</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">socket</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">phone</span> <span style="color:#f92672">=</span> <span style="color:#111">socket</span><span style="color:#f92672">.</span><span style="color:#111">socket</span><span style="color:#111">(</span><span style="color:#111">socket</span><span style="color:#f92672">.</span><span style="color:#111">AF_INET</span><span style="color:#111">,</span> <span style="color:#111">socket</span><span style="color:#f92672">.</span><span style="color:#111">SOCK_STREAM</span><span style="color:#111">)</span>  
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">phone</span><span style="color:#f92672">.</span><span style="color:#111">connect</span><span style="color:#111">((</span><span style="color:#d88200">&#39;127.0.0.1&#39;</span><span style="color:#111">,</span> <span style="color:#ae81ff">8080</span><span style="color:#111">))</span> 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">phone</span><span style="color:#f92672">.</span><span style="color:#111">send</span><span style="color:#111">(</span><span style="color:#d88200">b</span><span style="color:#d88200">&#39;hello&#39;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">phone</span><span style="color:#f92672">.</span><span style="color:#111">send</span><span style="color:#111">(</span><span style="color:#d88200">b</span><span style="color:#d88200">&#39;world&#39;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">phone</span><span style="color:#f92672">.</span><span style="color:#111">close</span><span style="color:#111">()</span>  
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 两次返送信息时间间隔太短，数据小，造成服务端一次收取</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 客户端</span>
</span></span></code></pre></div></li>
</ol>
<h4 id="粘包的解决方案">粘包的解决方案</h4>
<p><strong>先介绍一下struct模块：</strong></p>
<p>该模块可以把一个类型，如数字，转成固定长度的bytes</p>
<p><img src="https://uploadfiles.nowcoder.com/images/20200914/877190903_1600072166956_2662C697DDE960B32656C50BFB566938" alt="img"></p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">struct</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 将一个数字转化成等长度的bytes类型。</span>
</span></span><span style="display:flex;"><span><span style="color:#111">ret</span> <span style="color:#f92672">=</span> <span style="color:#111">struct</span><span style="color:#f92672">.</span><span style="color:#111">pack</span><span style="color:#111">(</span><span style="color:#d88200">&#39;i&#39;</span><span style="color:#111">,</span> <span style="color:#ae81ff">183346</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">print</span><span style="color:#111">(</span><span style="color:#111">ret</span><span style="color:#111">,</span> <span style="color:#111">type</span><span style="color:#111">(</span><span style="color:#111">ret</span><span style="color:#111">),</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#111">ret</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 通过unpack反解回来</span>
</span></span><span style="display:flex;"><span><span style="color:#111">ret1</span> <span style="color:#f92672">=</span> <span style="color:#111">struct</span><span style="color:#f92672">.</span><span style="color:#111">unpack</span><span style="color:#111">(</span><span style="color:#d88200">&#39;i&#39;</span><span style="color:#111">,</span><span style="color:#111">ret</span><span style="color:#111">)[</span><span style="color:#ae81ff">0</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span><span style="color:#111">print</span><span style="color:#111">(</span><span style="color:#111">ret1</span><span style="color:#111">,</span> <span style="color:#111">type</span><span style="color:#111">(</span><span style="color:#111">ret1</span><span style="color:#111">),</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#111">ret1</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 但是通过struct 处理不能处理太大</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">ret</span> <span style="color:#f92672">=</span> <span style="color:#111">struct</span><span style="color:#f92672">.</span><span style="color:#111">pack</span><span style="color:#111">(</span><span style="color:#d88200">&#39;l&#39;</span><span style="color:#111">,</span> <span style="color:#ae81ff">4323241232132324</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">print</span><span style="color:#111">(</span><span style="color:#111">ret</span><span style="color:#111">,</span> <span style="color:#111">type</span><span style="color:#111">(</span><span style="color:#111">ret</span><span style="color:#111">),</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#111">ret</span><span style="color:#111">))</span>  <span style="color:#75715e"># 报错</span>
</span></span></code></pre></div><ol>
<li>
<p>low版</p>
<ul>
<li>问题的根源在于，接收端不知道发送端将要传送的字节流的长度，所以解决粘包的方法就是围绕，如何让发送端在发送数据前，把自己将要发送的字节流总数按照固定字节发送给接收端后面跟上总数据，然后接收端先接收固定字节的总字节流，再来一个死循环接收完所有数据。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">socket</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">subprocess</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">struct</span>
</span></span><span style="display:flex;"><span><span style="color:#111">phone</span> <span style="color:#f92672">=</span> <span style="color:#111">socket</span><span style="color:#f92672">.</span><span style="color:#111">socket</span><span style="color:#111">(</span><span style="color:#111">socket</span><span style="color:#f92672">.</span><span style="color:#111">AF_INET</span><span style="color:#111">,</span> <span style="color:#111">socket</span><span style="color:#f92672">.</span><span style="color:#111">SOCK_STREAM</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">phone</span><span style="color:#f92672">.</span><span style="color:#111">bind</span><span style="color:#111">((</span><span style="color:#d88200">&#39;127.0.0.1&#39;</span><span style="color:#111">,</span> <span style="color:#ae81ff">8080</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">phone</span><span style="color:#f92672">.</span><span style="color:#111">listen</span><span style="color:#111">(</span><span style="color:#ae81ff">5</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">while</span> <span style="color:#ae81ff">1</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">conn</span><span style="color:#111">,</span> <span style="color:#111">client_addr</span> <span style="color:#f92672">=</span> <span style="color:#111">phone</span><span style="color:#f92672">.</span><span style="color:#111">accept</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">print</span><span style="color:#111">(</span><span style="color:#111">client_addr</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">while</span> <span style="color:#ae81ff">1</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">try</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">cmd</span> <span style="color:#f92672">=</span> <span style="color:#111">conn</span><span style="color:#f92672">.</span><span style="color:#111">recv</span><span style="color:#111">(</span><span style="color:#ae81ff">1024</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">ret</span> <span style="color:#f92672">=</span> <span style="color:#111">subprocess</span><span style="color:#f92672">.</span><span style="color:#111">Popen</span><span style="color:#111">(</span><span style="color:#111">cmd</span><span style="color:#f92672">.</span><span style="color:#111">decode</span><span style="color:#111">(</span><span style="color:#d88200">&#39;utf-8&#39;</span><span style="color:#111">),</span> <span style="color:#111">shell</span><span style="color:#f92672">=</span><span style="color:#00a8c8">True</span><span style="color:#111">,</span> <span style="color:#111">stdout</span><span style="color:#f92672">=</span><span style="color:#111">subprocess</span><span style="color:#f92672">.</span><span style="color:#111">PIPE</span><span style="color:#111">,</span> <span style="color:#111">stderr</span><span style="color:#f92672">=</span><span style="color:#111">subprocess</span><span style="color:#f92672">.</span><span style="color:#111">PIPE</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">correct_msg</span> <span style="color:#f92672">=</span> <span style="color:#111">ret</span><span style="color:#f92672">.</span><span style="color:#111">stdout</span><span style="color:#f92672">.</span><span style="color:#111">read</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">error_msg</span> <span style="color:#f92672">=</span> <span style="color:#111">ret</span><span style="color:#f92672">.</span><span style="color:#111">stderr</span><span style="color:#f92672">.</span><span style="color:#111">read</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># 1 制作固定报头</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">total_size</span> <span style="color:#f92672">=</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#111">correct_msg</span><span style="color:#111">)</span> <span style="color:#f92672">+</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#111">error_msg</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">header</span> <span style="color:#f92672">=</span> <span style="color:#111">struct</span><span style="color:#f92672">.</span><span style="color:#111">pack</span><span style="color:#111">(</span><span style="color:#d88200">&#39;i&#39;</span><span style="color:#111">,</span> <span style="color:#111">total_size</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># 2 发送报头</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">conn</span><span style="color:#f92672">.</span><span style="color:#111">send</span><span style="color:#111">(</span><span style="color:#111">header</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># 发送真实数据：</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">conn</span><span style="color:#f92672">.</span><span style="color:#111">send</span><span style="color:#111">(</span><span style="color:#111">correct_msg</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">conn</span><span style="color:#f92672">.</span><span style="color:#111">send</span><span style="color:#111">(</span><span style="color:#111">error_msg</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">except</span> <span style="color:#75af00">ConnectionResetError</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">break</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">conn</span><span style="color:#f92672">.</span><span style="color:#111">close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">phone</span><span style="color:#f92672">.</span><span style="color:#111">close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 但是low版本有问题：</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 1，报头不只有总数据大小，而是还应该有MD5数据，文件名等等一些数据。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 2，通过struct模块直接数据处理，不能处理太大。</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 服务端</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">socket</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">struct</span>
</span></span><span style="display:flex;"><span><span style="color:#111">phone</span> <span style="color:#f92672">=</span> <span style="color:#111">socket</span><span style="color:#f92672">.</span><span style="color:#111">socket</span><span style="color:#111">(</span><span style="color:#111">socket</span><span style="color:#f92672">.</span><span style="color:#111">AF_INET</span><span style="color:#111">,</span><span style="color:#111">socket</span><span style="color:#f92672">.</span><span style="color:#111">SOCK_STREAM</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">phone</span><span style="color:#f92672">.</span><span style="color:#111">connect</span><span style="color:#111">((</span><span style="color:#d88200">&#39;127.0.0.1&#39;</span><span style="color:#111">,</span><span style="color:#ae81ff">8080</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">while</span> <span style="color:#ae81ff">1</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">cmd</span> <span style="color:#f92672">=</span> <span style="color:#111">input</span><span style="color:#111">(</span><span style="color:#d88200">&#39;&gt;&gt;&gt;&#39;</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">strip</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#f92672">not</span> <span style="color:#111">cmd</span><span style="color:#111">:</span> <span style="color:#00a8c8">continue</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">phone</span><span style="color:#f92672">.</span><span style="color:#111">send</span><span style="color:#111">(</span><span style="color:#111">cmd</span><span style="color:#f92672">.</span><span style="color:#111">encode</span><span style="color:#111">(</span><span style="color:#d88200">&#39;utf-8&#39;</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 1，接收固定报头</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">header</span> <span style="color:#f92672">=</span> <span style="color:#111">phone</span><span style="color:#f92672">.</span><span style="color:#111">recv</span><span style="color:#111">(</span><span style="color:#ae81ff">4</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 2，解析报头</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">total_size</span> <span style="color:#f92672">=</span> <span style="color:#111">struct</span><span style="color:#f92672">.</span><span style="color:#111">unpack</span><span style="color:#111">(</span><span style="color:#d88200">&#39;i&#39;</span><span style="color:#111">,</span> <span style="color:#111">header</span><span style="color:#111">)[</span><span style="color:#ae81ff">0</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 3，根据报头信息，接收真实数据</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">recv_size</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">res</span> <span style="color:#f92672">=</span> <span style="color:#d88200">b</span><span style="color:#d88200">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">while</span> <span style="color:#111">recv_size</span> <span style="color:#f92672">&lt;</span> <span style="color:#111">total_size</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">recv_data</span> <span style="color:#f92672">=</span> <span style="color:#111">phone</span><span style="color:#f92672">.</span><span style="color:#111">recv</span><span style="color:#111">(</span><span style="color:#ae81ff">1024</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">res</span> <span style="color:#f92672">+=</span> <span style="color:#111">recv_data</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">recv_size</span> <span style="color:#f92672">+=</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#111">recv_data</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">print</span><span style="color:#111">(</span><span style="color:#111">res</span><span style="color:#f92672">.</span><span style="color:#111">decode</span><span style="color:#111">(</span><span style="color:#d88200">&#39;gbk&#39;</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">phone</span><span style="color:#f92672">.</span><span style="color:#111">close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 客户端</span>
</span></span></code></pre></div></li>
<li>
<p>可自定制报头版</p>
<ul>
<li>
<p>整个流程的大致解释： 我们可以把报头做成字典，字典里包含将要发送的真实数据的描述信息(大小啊之类的)，然后json序列化，然后用struck将序列化后的数据长度打包成4个字节。 我们在网络上传输的所有数据 都叫做数据包，数据包里的所有数据都叫做报文，报文里面不止有你的数据，还有ip地址、mac地址、端口号等等，其实所有的报文都有报头，这个报头是协议规定的，看一下</p>
<p>发送时： 先发报头长度 再编码报头内容然后发送 最后发真实内容</p>
<p>接收时： 先手报头长度，用struct取出来 根据取出的长度收取报头内容，然后解码，反序列化 从反序列化的结果中取出待取数据的描述信息，然后去取真实的数据内容</p>
<p>整体的流程解释</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">socket</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">subprocess</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">struct</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">json</span>
</span></span><span style="display:flex;"><span><span style="color:#111">phone</span> <span style="color:#f92672">=</span> <span style="color:#111">socket</span><span style="color:#f92672">.</span><span style="color:#111">socket</span><span style="color:#111">(</span><span style="color:#111">socket</span><span style="color:#f92672">.</span><span style="color:#111">AF_INET</span><span style="color:#111">,</span> <span style="color:#111">socket</span><span style="color:#f92672">.</span><span style="color:#111">SOCK_STREAM</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">phone</span><span style="color:#f92672">.</span><span style="color:#111">bind</span><span style="color:#111">((</span><span style="color:#d88200">&#39;127.0.0.1&#39;</span><span style="color:#111">,</span> <span style="color:#ae81ff">8080</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">phone</span><span style="color:#f92672">.</span><span style="color:#111">listen</span><span style="color:#111">(</span><span style="color:#ae81ff">5</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">while</span> <span style="color:#ae81ff">1</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">conn</span><span style="color:#111">,</span> <span style="color:#111">client_addr</span> <span style="color:#f92672">=</span> <span style="color:#111">phone</span><span style="color:#f92672">.</span><span style="color:#111">accept</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">print</span><span style="color:#111">(</span><span style="color:#111">client_addr</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">while</span> <span style="color:#ae81ff">1</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">try</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">cmd</span> <span style="color:#f92672">=</span> <span style="color:#111">conn</span><span style="color:#f92672">.</span><span style="color:#111">recv</span><span style="color:#111">(</span><span style="color:#ae81ff">1024</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">ret</span> <span style="color:#f92672">=</span> <span style="color:#111">subprocess</span><span style="color:#f92672">.</span><span style="color:#111">Popen</span><span style="color:#111">(</span><span style="color:#111">cmd</span><span style="color:#f92672">.</span><span style="color:#111">decode</span><span style="color:#111">(</span><span style="color:#d88200">&#39;utf-8&#39;</span><span style="color:#111">),</span> <span style="color:#111">shell</span><span style="color:#f92672">=</span><span style="color:#00a8c8">True</span><span style="color:#111">,</span> <span style="color:#111">stdout</span><span style="color:#f92672">=</span><span style="color:#111">subprocess</span><span style="color:#f92672">.</span><span style="color:#111">PIPE</span><span style="color:#111">,</span> <span style="color:#111">stderr</span><span style="color:#f92672">=</span><span style="color:#111">subprocess</span><span style="color:#f92672">.</span><span style="color:#111">PIPE</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">correct_msg</span> <span style="color:#f92672">=</span> <span style="color:#111">ret</span><span style="color:#f92672">.</span><span style="color:#111">stdout</span><span style="color:#f92672">.</span><span style="color:#111">read</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">error_msg</span> <span style="color:#f92672">=</span> <span style="color:#111">ret</span><span style="color:#f92672">.</span><span style="color:#111">stderr</span><span style="color:#f92672">.</span><span style="color:#111">read</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># 1 制作固定报头</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">total_size</span> <span style="color:#f92672">=</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#111">correct_msg</span><span style="color:#111">)</span> <span style="color:#f92672">+</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#111">error_msg</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">header_dict</span> <span style="color:#f92672">=</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#d88200">&#39;md5&#39;</span><span style="color:#111">:</span> <span style="color:#d88200">&#39;fdsaf2143254f&#39;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#d88200">&#39;file_name&#39;</span><span style="color:#111">:</span> <span style="color:#d88200">&#39;f1.txt&#39;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#d88200">&#39;total_size&#39;</span><span style="color:#111">:</span><span style="color:#111">total_size</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">header_dict_json</span> <span style="color:#f92672">=</span> <span style="color:#111">json</span><span style="color:#f92672">.</span><span style="color:#111">dumps</span><span style="color:#111">(</span><span style="color:#111">header_dict</span><span style="color:#111">)</span> <span style="color:#75715e"># str</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">bytes_headers</span> <span style="color:#f92672">=</span> <span style="color:#111">header_dict_json</span><span style="color:#f92672">.</span><span style="color:#111">encode</span><span style="color:#111">(</span><span style="color:#d88200">&#39;utf-8&#39;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">header_size</span> <span style="color:#f92672">=</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#111">bytes_headers</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">header</span> <span style="color:#f92672">=</span> <span style="color:#111">struct</span><span style="color:#f92672">.</span><span style="color:#111">pack</span><span style="color:#111">(</span><span style="color:#d88200">&#39;i&#39;</span><span style="color:#111">,</span> <span style="color:#111">header_size</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># 2 发送报头长度</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">conn</span><span style="color:#f92672">.</span><span style="color:#111">send</span><span style="color:#111">(</span><span style="color:#111">header</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># 3 发送报头</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">conn</span><span style="color:#f92672">.</span><span style="color:#111">send</span><span style="color:#111">(</span><span style="color:#111">bytes_headers</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># 4 发送真实数据：</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">conn</span><span style="color:#f92672">.</span><span style="color:#111">send</span><span style="color:#111">(</span><span style="color:#111">correct_msg</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">conn</span><span style="color:#f92672">.</span><span style="color:#111">send</span><span style="color:#111">(</span><span style="color:#111">error_msg</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">except</span> <span style="color:#75af00">ConnectionResetError</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">break</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">conn</span><span style="color:#f92672">.</span><span style="color:#111">close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">phone</span><span style="color:#f92672">.</span><span style="color:#111">close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 服务端</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">socket</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">struct</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">json</span>
</span></span><span style="display:flex;"><span><span style="color:#111">phone</span> <span style="color:#f92672">=</span> <span style="color:#111">socket</span><span style="color:#f92672">.</span><span style="color:#111">socket</span><span style="color:#111">(</span><span style="color:#111">socket</span><span style="color:#f92672">.</span><span style="color:#111">AF_INET</span><span style="color:#111">,</span><span style="color:#111">socket</span><span style="color:#f92672">.</span><span style="color:#111">SOCK_STREAM</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">phone</span><span style="color:#f92672">.</span><span style="color:#111">connect</span><span style="color:#111">((</span><span style="color:#d88200">&#39;127.0.0.1&#39;</span><span style="color:#111">,</span><span style="color:#ae81ff">8080</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">while</span> <span style="color:#ae81ff">1</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">cmd</span> <span style="color:#f92672">=</span> <span style="color:#111">input</span><span style="color:#111">(</span><span style="color:#d88200">&#39;&gt;&gt;&gt;&#39;</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">strip</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#f92672">not</span> <span style="color:#111">cmd</span><span style="color:#111">:</span> <span style="color:#00a8c8">continue</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">phone</span><span style="color:#f92672">.</span><span style="color:#111">send</span><span style="color:#111">(</span><span style="color:#111">cmd</span><span style="color:#f92672">.</span><span style="color:#111">encode</span><span style="color:#111">(</span><span style="color:#d88200">&#39;utf-8&#39;</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 1，接收固定报头</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">header_size</span> <span style="color:#f92672">=</span> <span style="color:#111">struct</span><span style="color:#f92672">.</span><span style="color:#111">unpack</span><span style="color:#111">(</span><span style="color:#d88200">&#39;i&#39;</span><span style="color:#111">,</span> <span style="color:#111">phone</span><span style="color:#f92672">.</span><span style="color:#111">recv</span><span style="color:#111">(</span><span style="color:#ae81ff">4</span><span style="color:#111">))[</span><span style="color:#ae81ff">0</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 2，解析报头长度</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">header_bytes</span> <span style="color:#f92672">=</span> <span style="color:#111">phone</span><span style="color:#f92672">.</span><span style="color:#111">recv</span><span style="color:#111">(</span><span style="color:#111">header_size</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">header_dict</span> <span style="color:#f92672">=</span> <span style="color:#111">json</span><span style="color:#f92672">.</span><span style="color:#111">loads</span><span style="color:#111">(</span><span style="color:#111">header_bytes</span><span style="color:#f92672">.</span><span style="color:#111">decode</span><span style="color:#111">(</span><span style="color:#d88200">&#39;utf-8&#39;</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 3,收取报头</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">total_size</span> <span style="color:#f92672">=</span> <span style="color:#111">header_dict</span><span style="color:#111">[</span><span style="color:#d88200">&#39;total_size&#39;</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 3，根据报头信息，接收真实数据</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">recv_size</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">res</span> <span style="color:#f92672">=</span> <span style="color:#d88200">b</span><span style="color:#d88200">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">while</span> <span style="color:#111">recv_size</span> <span style="color:#f92672">&lt;</span> <span style="color:#111">total_size</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">recv_data</span> <span style="color:#f92672">=</span> <span style="color:#111">phone</span><span style="color:#f92672">.</span><span style="color:#111">recv</span><span style="color:#111">(</span><span style="color:#ae81ff">1024</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">res</span> <span style="color:#f92672">+=</span> <span style="color:#111">recv_data</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">recv_size</span> <span style="color:#f92672">+=</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#111">recv_data</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">print</span><span style="color:#111">(</span><span style="color:#111">res</span><span style="color:#f92672">.</span><span style="color:#111">decode</span><span style="color:#111">(</span><span style="color:#d88200">&#39;gbk&#39;</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">phone</span><span style="color:#f92672">.</span><span style="color:#111">close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 客户端</span>
</span></span></code></pre></div></li>
</ol>
<h3 id="udp下的socket">udp下的socket</h3>
<ul>
<li>udp是无链接的，先启动哪一端都不会报错</li>
</ul>
<p><img src="/images/a34bf51d-12ff-42e7-92e2-eeca47d399a9.png" alt=""></p>
<p>UDP下的socket通讯流程</p>
<p>先从服务器端说起。服务器端先初始化Socket，然后与端口绑定(bind)，recvform接收消息，这个消息有两项，消息内容和对方客户端的地址，然后回复消息时也要带着你收到的这个客户端的地址，发送回去，最后关闭连接，一次交互结束</p>
<p>上代码感受一下，需要创建两个文件，文件名称随便起，为了方便看，我的两个文件名称为udp_server.py(服务端)和udp_client.py(客户端)，将下面的server端的代码拷贝到udp_server.py文件中，将下面cliet端的代码拷贝到udp_client.py的文件中，然后先运行udp_server.py文件中的代码，再运行udp_client.py文件中的代码，然后在pycharm下面的输出窗口看一下效果。</p>
<pre tabindex="0"><code>import socket
udp_sk = socket.socket(type=socket.SOCK_DGRAM)   #创建一个服务器的套接字
udp_sk.bind((&#39;127.0.0.1&#39;,9000))        #绑定服务器套接字
msg,addr = udp_sk.recvfrom(1024)
print(msg)
udp_sk.sendto(b&#39;hi&#39;,addr)                 # 对话(接收与发送)
udp_sk.close()                         # 关闭服务器套接字

# server端
import socket
ip_port=(&#39;127.0.0.1&#39;,9000)
udp_sk=socket.socket(type=socket.SOCK_DGRAM)
udp_sk.sendto(b&#39;hello&#39;,ip_port)
back_msg,addr=udp_sk.recvfrom(1024)
print(back_msg.decode(&#39;utf-8&#39;),addr)

# client端
</code></pre><ul>
<li>类似于qq聊天的代码示例：</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#_*_coding:utf-8_*_</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">socket</span>
</span></span><span style="display:flex;"><span><span style="color:#111">ip_port</span><span style="color:#f92672">=</span><span style="color:#111">(</span><span style="color:#d88200">&#39;127.0.0.1&#39;</span><span style="color:#111">,</span><span style="color:#ae81ff">8081</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">udp_server_sock</span><span style="color:#f92672">=</span><span style="color:#111">socket</span><span style="color:#f92672">.</span><span style="color:#111">socket</span><span style="color:#111">(</span><span style="color:#111">socket</span><span style="color:#f92672">.</span><span style="color:#111">AF_INET</span><span style="color:#111">,</span><span style="color:#111">socket</span><span style="color:#f92672">.</span><span style="color:#111">SOCK_DGRAM</span><span style="color:#111">)</span> <span style="color:#75715e">#DGRAM:datagram 数据报文的意思，象征着UDP协议的通信方式</span>
</span></span><span style="display:flex;"><span><span style="color:#111">udp_server_sock</span><span style="color:#f92672">.</span><span style="color:#111">bind</span><span style="color:#111">(</span><span style="color:#111">ip_port</span><span style="color:#111">)</span><span style="color:#75715e">#你对外提供服务的端口就是这一个，所有的客户端都是通过这个端口和你进行通信的</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">while</span> <span style="color:#00a8c8">True</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">qq_msg</span><span style="color:#111">,</span><span style="color:#111">addr</span><span style="color:#f92672">=</span><span style="color:#111">udp_server_sock</span><span style="color:#f92672">.</span><span style="color:#111">recvfrom</span><span style="color:#111">(</span><span style="color:#ae81ff">1024</span><span style="color:#111">)</span><span style="color:#75715e"># 阻塞状态，等待接收消息</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">print</span><span style="color:#111">(</span><span style="color:#d88200">&#39;来自[</span><span style="color:#d88200">%s</span><span style="color:#d88200">:</span><span style="color:#d88200">%s</span><span style="color:#d88200">]的一条消息:</span><span style="color:#8045ff">\033</span><span style="color:#d88200">[1;44m</span><span style="color:#d88200">%s</span><span style="color:#8045ff">\033</span><span style="color:#d88200">[0m&#39;</span> <span style="color:#f92672">%</span><span style="color:#111">(</span><span style="color:#111">addr</span><span style="color:#111">[</span><span style="color:#ae81ff">0</span><span style="color:#111">],</span><span style="color:#111">addr</span><span style="color:#111">[</span><span style="color:#ae81ff">1</span><span style="color:#111">],</span><span style="color:#111">qq_msg</span><span style="color:#f92672">.</span><span style="color:#111">decode</span><span style="color:#111">(</span><span style="color:#d88200">&#39;utf-8&#39;</span><span style="color:#111">)))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">back_msg</span><span style="color:#f92672">=</span><span style="color:#111">input</span><span style="color:#111">(</span><span style="color:#d88200">&#39;回复消息: &#39;</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">strip</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">udp_server_sock</span><span style="color:#f92672">.</span><span style="color:#111">sendto</span><span style="color:#111">(</span><span style="color:#111">back_msg</span><span style="color:#f92672">.</span><span style="color:#111">encode</span><span style="color:#111">(</span><span style="color:#d88200">&#39;utf-8&#39;</span><span style="color:#111">),</span><span style="color:#111">addr</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#server端</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">socket</span>
</span></span><span style="display:flex;"><span><span style="color:#111">BUFSIZE</span><span style="color:#f92672">=</span><span style="color:#ae81ff">1024</span>
</span></span><span style="display:flex;"><span><span style="color:#111">udp_client_socket</span><span style="color:#f92672">=</span><span style="color:#111">socket</span><span style="color:#f92672">.</span><span style="color:#111">socket</span><span style="color:#111">(</span><span style="color:#111">socket</span><span style="color:#f92672">.</span><span style="color:#111">AF_INET</span><span style="color:#111">,</span><span style="color:#111">socket</span><span style="color:#f92672">.</span><span style="color:#111">SOCK_DGRAM</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">qq_name_dic</span><span style="color:#f92672">=</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d88200">&#39;taibai&#39;</span><span style="color:#111">:(</span><span style="color:#d88200">&#39;127.0.0.1&#39;</span><span style="color:#111">,</span><span style="color:#ae81ff">8081</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d88200">&#39;Jedan&#39;</span><span style="color:#111">:(</span><span style="color:#d88200">&#39;127.0.0.1&#39;</span><span style="color:#111">,</span><span style="color:#ae81ff">8081</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d88200">&#39;Jack&#39;</span><span style="color:#111">:(</span><span style="color:#d88200">&#39;127.0.0.1&#39;</span><span style="color:#111">,</span><span style="color:#ae81ff">8081</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d88200">&#39;John&#39;</span><span style="color:#111">:(</span><span style="color:#d88200">&#39;127.0.0.1&#39;</span><span style="color:#111">,</span><span style="color:#ae81ff">8081</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">while</span> <span style="color:#00a8c8">True</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">qq_name</span><span style="color:#f92672">=</span><span style="color:#111">input</span><span style="color:#111">(</span><span style="color:#d88200">&#39;请选择聊天对象: &#39;</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">strip</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">while</span> <span style="color:#00a8c8">True</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">msg</span><span style="color:#f92672">=</span><span style="color:#111">input</span><span style="color:#111">(</span><span style="color:#d88200">&#39;请输入消息,回车发送,输入q结束和他的聊天: &#39;</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">strip</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#111">msg</span> <span style="color:#f92672">==</span> <span style="color:#d88200">&#39;q&#39;</span><span style="color:#111">:</span><span style="color:#00a8c8">break</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#f92672">not</span> <span style="color:#111">msg</span> <span style="color:#f92672">or</span> <span style="color:#f92672">not</span> <span style="color:#111">qq_name</span> <span style="color:#f92672">or</span> <span style="color:#111">qq_name</span> <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> <span style="color:#111">qq_name_dic</span><span style="color:#111">:</span><span style="color:#00a8c8">continue</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">udp_client_socket</span><span style="color:#f92672">.</span><span style="color:#111">sendto</span><span style="color:#111">(</span><span style="color:#111">msg</span><span style="color:#f92672">.</span><span style="color:#111">encode</span><span style="color:#111">(</span><span style="color:#d88200">&#39;utf-8&#39;</span><span style="color:#111">),</span><span style="color:#111">qq_name_dic</span><span style="color:#111">[</span><span style="color:#111">qq_name</span><span style="color:#111">])</span><span style="color:#75715e"># 必须带着自己的地址，这就是UDP不一样的地方，不需要建立连接，但是要带着自己的地址给服务端，否则服务端无法判断是谁给我发的消息，并且不知道该把消息回复到什么地方，因为我们之间没有建立连接通道</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">back_msg</span><span style="color:#111">,</span><span style="color:#111">addr</span><span style="color:#f92672">=</span><span style="color:#111">udp_client_socket</span><span style="color:#f92672">.</span><span style="color:#111">recvfrom</span><span style="color:#111">(</span><span style="color:#111">BUFSIZE</span><span style="color:#111">)</span><span style="color:#75715e"># 同样也是阻塞状态，等待接收消息</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">print</span><span style="color:#111">(</span><span style="color:#d88200">&#39;来自[</span><span style="color:#d88200">%s</span><span style="color:#d88200">:</span><span style="color:#d88200">%s</span><span style="color:#d88200">]的一条消息:</span><span style="color:#8045ff">\033</span><span style="color:#d88200">[1;44m</span><span style="color:#d88200">%s</span><span style="color:#8045ff">\033</span><span style="color:#d88200">[0m&#39;</span> <span style="color:#f92672">%</span><span style="color:#111">(</span><span style="color:#111">addr</span><span style="color:#111">[</span><span style="color:#ae81ff">0</span><span style="color:#111">],</span><span style="color:#111">addr</span><span style="color:#111">[</span><span style="color:#ae81ff">1</span><span style="color:#111">],</span><span style="color:#111">back_msg</span><span style="color:#f92672">.</span><span style="color:#111">decode</span><span style="color:#111">(</span><span style="color:#d88200">&#39;utf-8&#39;</span><span style="color:#111">)))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">udp_client_socket</span><span style="color:#f92672">.</span><span style="color:#111">close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># client端</span>
</span></span></code></pre></div>]]></content:encoded><category>network</category><category>network</category></item></channel></rss>