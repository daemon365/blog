<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/"><channel><title>Containerd-Shim on Daemon365</title><link>https://daemon365.dev/tags/containerd-shim/</link><description>Don't let yourself stop.</description><generator>Hugo -- gohugo.io</generator><language>zh-cn</language><lastBuildDate>Thu, 09 May 2024 20:56:00 +0800</lastBuildDate><atom:link href="https://daemon365.dev/tags/containerd-shim/index.xml" rel="self" type="application/rss+xml"/><item><title>docker containerd runc containerd-shim等组件的关系</title><link>https://daemon365.dev/post/cloud/the_relationship_between_docker_containerd_runc_containerd_shim_and_other_components/</link><pubDate>Thu, 09 May 2024 20:56:00 +0800</pubDate><guid>https://daemon365.dev/post/cloud/the_relationship_between_docker_containerd_runc_containerd_shim_and_other_components/</guid><description>&lt;h2 id="早期-kubelet-创建容器工作原理"&gt;早期 kubelet 创建容器工作原理&lt;/h2&gt;
&lt;p&gt;因为 docker 出生的比 k8s 早，所以 k8s 早期的容器运行时都是基于 docker 的，kubelet 通过 docker 的 api 创建容器。后来，k8s 官方不想绑死在 docker 这架马车上，就把容器运行时抽象出来，定义了一个接口，叫 CRI (&lt;a href="https://github.com/kubernetes/cri-api"&gt;container runtime interface&lt;/a&gt;)，容器运行时接口, 通过这个接口，kubelet 可以和任何容器运行时交互。但是，docker 并没有实现这个接口，k8s 也不想直接失去 docker 的用户，所以 k8s 官方在 kubelet 中实现了一个叫 docker-shim 的组件，这个组件简单来说就是把 cri 接口转换成 docker 的 api，这样 kubelet 就可以和 docker 交互了, 这个组件在 kuberbetes 1.24 版本中已经被移除了。至于实现了 cri 接口的容器运行时，比如 containerd，cri-o 等，kubelet 可以直接和它们交互。&lt;/p&gt;
&lt;p&gt;调用架构图如下：&lt;/p&gt;
&lt;p&gt;&lt;img src="https://daemon365.dev/images/481a4d67-401a-4e8e-af61-3534d23a7d69.png" alt=""&gt;&lt;/p&gt;
&lt;p&gt;目前 dockershim 组件已经删除，不能使用了，所以 k8s 1.24 版本之后，kubelet 只能和实现了 cri 接口的容器运行时交互，比如 containerd，cri-o 等。&lt;/p&gt;
&lt;p&gt;这里建议使用 containerd 因为 containerd 是 docker 官方出品的，而且 containerd 也是 docker 的核心组件，docker 的容器运行时就是基于 containerd 的，所以 containerd 的稳定性和可靠性都是有保障的。&lt;/p&gt;</description><content:encoded><![CDATA[<h2 id="早期-kubelet-创建容器工作原理">早期 kubelet 创建容器工作原理</h2>
<p>因为 docker 出生的比 k8s 早，所以 k8s 早期的容器运行时都是基于 docker 的，kubelet 通过 docker 的 api 创建容器。后来，k8s 官方不想绑死在 docker 这架马车上，就把容器运行时抽象出来，定义了一个接口，叫 CRI (<a href="https://github.com/kubernetes/cri-api">container runtime interface</a>)，容器运行时接口, 通过这个接口，kubelet 可以和任何容器运行时交互。但是，docker 并没有实现这个接口，k8s 也不想直接失去 docker 的用户，所以 k8s 官方在 kubelet 中实现了一个叫 docker-shim 的组件，这个组件简单来说就是把 cri 接口转换成 docker 的 api，这样 kubelet 就可以和 docker 交互了, 这个组件在 kuberbetes 1.24 版本中已经被移除了。至于实现了 cri 接口的容器运行时，比如 containerd，cri-o 等，kubelet 可以直接和它们交互。</p>
<p>调用架构图如下：</p>
<p><img src="/images/481a4d67-401a-4e8e-af61-3534d23a7d69.png" alt=""></p>
<p>目前 dockershim 组件已经删除，不能使用了，所以 k8s 1.24 版本之后，kubelet 只能和实现了 cri 接口的容器运行时交互，比如 containerd，cri-o 等。</p>
<p>这里建议使用 containerd 因为 containerd 是 docker 官方出品的，而且 containerd 也是 docker 的核心组件，docker 的容器运行时就是基于 containerd 的，所以 containerd 的稳定性和可靠性都是有保障的。</p>
<h2 id="docker-containerd-runc-的关系">docker containerd runc 的关系</h2>
<p>因为 podman 等新兴 container runtime 的崛起，docker 不想失去定义标准的机会，所以 docker 官方把 containerd 从 docker 中分离出来，独立成一个项目，实现了 cri 接口，这种 kubelet 就可以通过 cri 直接调用 containerd 了。然后，docker 官方又把 runc 从 containerd 中分离出来，独立成一个项目，定义了一个叫 OCI (<a href="https://opencontainers.org/">Open Container Initiative</a>) 的标准，这个标准定义了容器的格式和运行时，runc 就是这个标准的实现，目前实现  oci 的还有 crun youki keta 等。</p>
<p>因为 containerd 和 runc 脱胎于 docker，docker 又不能维护两份代码，所以 docker 就通过调用 containerd ，containerd 再 通过配置实现 oci 标准的 runc 来创建容器。 当然，你也可以手动配置其他实现了 oci 标准的容器运行时。</p>
<p>调用架构图如下：</p>
<p><img src="/images/d7b1939a-5608-43da-a883-42ad662e94c7.png" alt=""></p>
<p>在上图中可以看到 containerd 不是直接调用 runc 的，而是通过 containerd-shim 来调用 runc 的，这个是为什么？</p>
<h2 id="runc">runc</h2>
<p>runc 是一款设计精巧的命令行工具，专注于创建和运行符合 Open Container Initiative（OCI）规范的容器。执行 runc start 时，它首先通过 fork 创建一个子进程，在这个新进程中进行一系列容器运行的准备工作，包括准备文件系统、配置 namespaces 和 cgroups 。接着，通过 execve 系统调用，这个子进程变身为容器的首个进程——通常被称作“init”进程——并执行用户指定的首个命令（例如，bash）。</p>
<p>如果首个命令是一个shell（比如 bash），当执行一个shell命令（例如 ls）时，bash 会 fork 并执行相应的子进程。这个新的子进程执行 ls 命令并在完成任务后退出。此后，bash 可能继续接受新的命令，或在结束会话后终止。</p>
<p>当容器的“init”进程终止时，整个容器也会按照规定的生命周期走向结束。不同的命令和应用会在这个基本框架下有不同的具体行为，但总体流程大致一致。</p>
<p>如果这些容器的进的父进程是 containerd ，那么当 containerd 进程挂掉或者重启时，容器的进程也会挂掉，这样就不符合容器的定义了，所以 containerd 通过 containerd-shim 来调用 runc，这样当 containerd 挂掉时，容器的进程还是会继续运行的。</p>
<h2 id="containerd-shim">containerd-shim</h2>
<p>containerd-shim 是一个轻量级的代理进程，它的主要作用是：</p>
<ol>
<li>通过runC命令可以启动、执行容器、进程；</li>
<li>监控容器进程状态，当容器执行完成后，通过exit fifo文件报告容器进程结束状态；</li>
<li>当此容器SHIM的第一个实例进程被杀死后，reaper掉所有其子进程；</li>
</ol>
<p>当 containerd 通过 containerd-shim 来调用 runc 后, 会把 containerd-shim 的挂到 system （pid=1）的进程下，这样当 containerd 挂掉或者重启时，containerd-shim 还是会继续运行的，这样就保证了容器的进程不会挂掉。</p>
<p>验证，这里我随便启动了一下 docker 容器看下效果：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-BASH" data-lang="BASH"><span style="display:flex;"><span><span style="color:#75715e"># 启动的nginx 容器</span>
</span></span><span style="display:flex;"><span>root       <span style="color:#ae81ff">19455</span>   <span style="color:#ae81ff">19435</span>  <span style="color:#ae81ff">0</span> 22:20 ?        00:00:00 nginx: master process nginx -g daemon off<span style="color:#111">;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># nginx 进程的父进程是 containerd-shim</span>
</span></span><span style="display:flex;"><span>root       <span style="color:#ae81ff">19435</span>       <span style="color:#ae81ff">1</span>  <span style="color:#ae81ff">0</span> 22:20 ?        00:00:00 /usr/bin/containerd-shim-runc-v2 -namespace moby -id 0af95b326dfc8fee31bd28abb61e5d23a9cee98fada2b32c5ade852a0782f559 -address /run/containerd/containerd.sock
</span></span><span style="display:flex;"><span><span style="color:#75715e"># containerd-shim 的父进程是 systemd</span>
</span></span></code></pre></div>]]></content:encoded><category>cloud</category><category>docker</category><category>containerd</category><category>runc</category><category>containerd-shim</category><category>kubernetes</category><category>cri</category></item><item><title>容器启动流程（containerd 和 runc）</title><link>https://daemon365.dev/post/cloud/container_startup_process_containerd_and_runc/</link><pubDate>Thu, 07 Dec 2023 00:00:00 +0800</pubDate><guid>https://daemon365.dev/post/cloud/container_startup_process_containerd_and_runc/</guid><description>&lt;h2 id="启动流程"&gt;启动流程&lt;/h2&gt;
&lt;p&gt;containerd 作为一个 api 服务，提供了一系列的接口供外部调用，比如创建容器、删除容器、创建镜像、删除镜像等等。使用 docker 和 ctr 等工具，都是通过调用 containerd 的 api 来实现的。
kubelet 通过 cri 调用 containerd 和这些不一样，后续我会介绍到。&lt;/p&gt;
&lt;p&gt;containerd 创建容器流程如下：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;接收到 api 请求，通过调用 containerd-shim-runc-v2 调用 runc 创建容器，主要是做解压文件和准备环境的工作。&lt;/li&gt;
&lt;li&gt;接收到 api 请求，创建一个 task，task 是一个容器的抽象，包含了容器的所有信息，比如容器的 id、容器的状态、容器的配置等等。&lt;/li&gt;
&lt;li&gt;containerd 启动一个 containerd-shim-runc-v2 进程。&lt;/li&gt;
&lt;li&gt;containerd-shim-runc-v2 进程 在启动一个 containerd-shim-runc-v2 进程，然后第一个 containerd-shim-runc-v2 进程退出。&lt;/li&gt;
&lt;li&gt;containerd 通过 IPC 通信，让第二个 containerd-shim-runc-v2 启动容器。&lt;/li&gt;
&lt;li&gt;containerd-shim-runc-v2 进程通过调用 runc start 启动容器。&lt;/li&gt;
&lt;li&gt;runc 会调用 runc init 启动容器的 init 进程。&lt;/li&gt;
&lt;li&gt;runc init 进程会调用 &lt;code&gt;unix.Exec&lt;/code&gt; 的方式，替换自己的进程，启动容器的第一个进程。这个进程既是容器的启动命令，也是容器的 pid 1 进程。完成之后，runc create 进程退出。&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;这样 containerd-shim-runc-v2 的父进程就是 init 进程（1），而 init 进程的父进程是 containerd-shim-runc-v2 进程，这样就形成了一个进程树。&lt;/p&gt;</description><content:encoded><![CDATA[<h2 id="启动流程">启动流程</h2>
<p>containerd 作为一个 api 服务，提供了一系列的接口供外部调用，比如创建容器、删除容器、创建镜像、删除镜像等等。使用 docker 和 ctr 等工具，都是通过调用 containerd 的 api 来实现的。
kubelet 通过 cri 调用 containerd 和这些不一样，后续我会介绍到。</p>
<p>containerd 创建容器流程如下：</p>
<ol>
<li>接收到 api 请求，通过调用 containerd-shim-runc-v2 调用 runc 创建容器，主要是做解压文件和准备环境的工作。</li>
<li>接收到 api 请求，创建一个 task，task 是一个容器的抽象，包含了容器的所有信息，比如容器的 id、容器的状态、容器的配置等等。</li>
<li>containerd 启动一个 containerd-shim-runc-v2 进程。</li>
<li>containerd-shim-runc-v2 进程 在启动一个 containerd-shim-runc-v2 进程，然后第一个 containerd-shim-runc-v2 进程退出。</li>
<li>containerd 通过 IPC 通信，让第二个 containerd-shim-runc-v2 启动容器。</li>
<li>containerd-shim-runc-v2 进程通过调用 runc start 启动容器。</li>
<li>runc 会调用 runc init 启动容器的 init 进程。</li>
<li>runc init 进程会调用 <code>unix.Exec</code> 的方式，替换自己的进程，启动容器的第一个进程。这个进程既是容器的启动命令，也是容器的 pid 1 进程。完成之后，runc create 进程退出。</li>
</ol>
<p>这样 containerd-shim-runc-v2 的父进程就是 init 进程（1），而 init 进程的父进程是 containerd-shim-runc-v2 进程，这样就形成了一个进程树。</p>
<p>我通过 docker 启动一个容器，示例一下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>❯ docker run -d --rm -it docker.m.daocloud.io/ubuntu:22.10 sleep <span style="color:#ae81ff">3000</span>
</span></span><span style="display:flex;"><span>❯ ps -ef<span style="color:#111">|</span>grep <span style="color:#d88200">&#34;sleep 3000&#34;</span>
</span></span><span style="display:flex;"><span>root       <span style="color:#ae81ff">15042</span>   <span style="color:#ae81ff">15021</span>  <span style="color:#ae81ff">0</span> 22:02 pts/0    00:00:00 sleep <span style="color:#ae81ff">3000</span>
</span></span><span style="display:flex;"><span>❯ ps -ef<span style="color:#111">|</span>grep <span style="color:#d88200">&#34;15021&#34;</span>
</span></span><span style="display:flex;"><span>root       <span style="color:#ae81ff">15021</span>       <span style="color:#ae81ff">1</span>  <span style="color:#ae81ff">0</span> 22:02 ?        00:00:00 /usr/bin/containerd-shim-runc-v2 -namespace moby -id 4346ca602cd85d35b0a4a81762be6142bc6a2222f859f4af47563992efc3c59c -address /run/containerd/containerd.sock
</span></span><span style="display:flex;"><span>root       <span style="color:#ae81ff">15042</span>   <span style="color:#ae81ff">15021</span>  <span style="color:#ae81ff">0</span> 22:02 pts/0    00:00:00 sleep <span style="color:#ae81ff">3000</span>
</span></span></code></pre></div><p>可以看到我们的结论是正确的。</p>
<h3 id="疑问解答">疑问解答</h3>
<p><strong>1.为什么要创建两个 containerd-shim 不嫌麻烦吗？</strong></p>
<p>因为 第一个 containerd-shim 会在创建完第二个 containerd-shim 后退出，而作为第一个进程子进程的第二个 containerd-shim 会成为孤儿进程，这样就会被 init 进程接管，而和 containerd 本身脱离了关系。</p>
<p><strong>2.为什么要想法设法把 containerd-shim 挂在 init 进程下面，而不是 containerd？</strong></p>
<p>为了保证稳定性和独立性。这样做可以确保即使 containerd 崩溃或重启，由 containerd-shim 管理的容器进程仍然可以继续运行，不受影响。此外，这种设计还有助于更好地管理资源和防止资源泄露。</p>
<p><strong>3.为什么 runc start 进程退出了 runc init 进程（用户进程）没有变成 init 的子进程 而是containerd-shim的子进程？</strong></p>
<p>因为 containerd-shim 做了 unix 的 <code>PR_SET_CHILD_SUBREAPER</code> 调用, 这个系统调用大概作用为 当这个进程的子子孙孙进程变成孤儿进程的时候，这个进程会接管这个孤儿进程，而不是 init 进程接管。</p>
<h2 id="架构图">架构图</h2>
<p><img src="/images/1a309094-015a-4bcf-b371-134a5a275089.png" alt=""></p>
<h2 id="代码分析">代码分析</h2>
<h3 id="containerd-api-注册-代码分析">containerd api 注册 代码分析</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-GO" data-lang="GO"><span style="display:flex;"><span><span style="color:#00a8c8">var</span> <span style="color:#75af00">register</span> <span style="color:#111">=</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">sync</span><span style="color:#111">.</span><span style="color:#75af00">RWMutex</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span> <span style="color:#75af00">plugin</span><span style="color:#111">.</span><span style="color:#75af00">Registry</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Registry</span> <span style="color:#111">[]</span><span style="color:#f92672">*</span><span style="color:#75af00">Registration</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Registration</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Type of the plugin</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Type</span> <span style="color:#75af00">Type</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ID of the plugin</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ID</span> <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Config specific to the plugin</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Config</span> <span style="color:#00a8c8">interface</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Requires is a list of plugins that the registered plugin requires to be available</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Requires</span> <span style="color:#111">[]</span><span style="color:#75af00">Type</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// InitFn is called when initializing a plugin. The registration and</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// context are passed in. The init function may modify the registration to</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// add exports, capabilities and platform support declarations.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">InitFn</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">InitContext</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#00a8c8">interface</span><span style="color:#111">{},</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ConfigMigration allows a plugin to migrate configurations from an older</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// version to handle plugin renames or moving of features from one plugin</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// to another in a later version.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// The configuration map is keyed off the plugin name and the value</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// is the configuration for that objects, with the structure defined</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// for the plugin. No validation is done on the value before performing</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// the migration.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ConfigMigration</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">,</span> <span style="color:#00a8c8">int</span><span style="color:#111">,</span> <span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#00a8c8">string</span><span style="color:#111">]</span><span style="color:#00a8c8">interface</span><span style="color:#111">{})</span> <span style="color:#00a8c8">error</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>通过 init 把接口注册进去 比如 task api 注册</p>
<p>代码位置 ： <code>services/tasks/local.go</code></p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-GO" data-lang="GO"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">init</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">registry</span><span style="color:#111">.</span><span style="color:#75af00">Register</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">plugin</span><span style="color:#111">.</span><span style="color:#75af00">Registration</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">Type</span><span style="color:#111">:</span>     <span style="color:#75af00">plugins</span><span style="color:#111">.</span><span style="color:#75af00">ServicePlugin</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">ID</span><span style="color:#111">:</span>       <span style="color:#75af00">services</span><span style="color:#111">.</span><span style="color:#75af00">TasksService</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">Requires</span><span style="color:#111">:</span> <span style="color:#75af00">tasksServiceRequires</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">Config</span><span style="color:#111">:</span>   <span style="color:#f92672">&amp;</span><span style="color:#75af00">Config</span><span style="color:#111">{},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">InitFn</span><span style="color:#111">:</span>   <span style="color:#75af00">initFunc</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">timeout</span><span style="color:#111">.</span><span style="color:#75af00">Set</span><span style="color:#111">(</span><span style="color:#75af00">stateTimeout</span><span style="color:#111">,</span> <span style="color:#ae81ff">2</span><span style="color:#f92672">*</span><span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Second</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">initFunc</span><span style="color:#111">(</span><span style="color:#75af00">ic</span> <span style="color:#f92672">*</span><span style="color:#75af00">plugin</span><span style="color:#111">.</span><span style="color:#75af00">InitContext</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#00a8c8">interface</span><span style="color:#111">{},</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">config</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">ic</span><span style="color:#111">.</span><span style="color:#75af00">Config</span><span style="color:#111">.(</span><span style="color:#f92672">*</span><span style="color:#75af00">Config</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">v2r</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">ic</span><span style="color:#111">.</span><span style="color:#75af00">GetByID</span><span style="color:#111">(</span><span style="color:#75af00">plugins</span><span style="color:#111">.</span><span style="color:#75af00">RuntimePluginV2</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;task&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">m</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">ic</span><span style="color:#111">.</span><span style="color:#75af00">GetSingle</span><span style="color:#111">(</span><span style="color:#75af00">plugins</span><span style="color:#111">.</span><span style="color:#75af00">MetadataPlugin</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ep</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">ic</span><span style="color:#111">.</span><span style="color:#75af00">GetSingle</span><span style="color:#111">(</span><span style="color:#75af00">plugins</span><span style="color:#111">.</span><span style="color:#75af00">EventPlugin</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">monitor</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">ic</span><span style="color:#111">.</span><span style="color:#75af00">GetSingle</span><span style="color:#111">(</span><span style="color:#75af00">plugins</span><span style="color:#111">.</span><span style="color:#75af00">TaskMonitorPlugin</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">errors</span><span style="color:#111">.</span><span style="color:#75af00">Is</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#75af00">plugin</span><span style="color:#111">.</span><span style="color:#75af00">ErrPluginNotFound</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">monitor</span> <span style="color:#111">=</span> <span style="color:#75af00">runtime</span><span style="color:#111">.</span><span style="color:#75af00">NewNoopMonitor</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">db</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">m</span><span style="color:#111">.(</span><span style="color:#f92672">*</span><span style="color:#75af00">metadata</span><span style="color:#111">.</span><span style="color:#75af00">DB</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">l</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">local</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">containers</span><span style="color:#111">:</span> <span style="color:#75af00">metadata</span><span style="color:#111">.</span><span style="color:#75af00">NewContainerStore</span><span style="color:#111">(</span><span style="color:#75af00">db</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">store</span><span style="color:#111">:</span>      <span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">ContentStore</span><span style="color:#111">(),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">publisher</span><span style="color:#111">:</span>  <span style="color:#75af00">ep</span><span style="color:#111">.(</span><span style="color:#75af00">events</span><span style="color:#111">.</span><span style="color:#75af00">Publisher</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">monitor</span><span style="color:#111">:</span>    <span style="color:#75af00">monitor</span><span style="color:#111">.(</span><span style="color:#75af00">runtime</span><span style="color:#111">.</span><span style="color:#75af00">TaskMonitor</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">v2Runtime</span><span style="color:#111">:</span>  <span style="color:#75af00">v2r</span><span style="color:#111">.(</span><span style="color:#75af00">runtime</span><span style="color:#111">.</span><span style="color:#75af00">PlatformRuntime</span><span style="color:#111">),</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">v2Tasks</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">l</span><span style="color:#111">.</span><span style="color:#75af00">v2Runtime</span><span style="color:#111">.</span><span style="color:#75af00">Tasks</span><span style="color:#111">(</span><span style="color:#75af00">ic</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">,</span> <span style="color:#00a8c8">true</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">t</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">v2Tasks</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">l</span><span style="color:#111">.</span><span style="color:#75af00">monitor</span><span style="color:#111">.</span><span style="color:#75af00">Monitor</span><span style="color:#111">(</span><span style="color:#75af00">t</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">blockio</span><span style="color:#111">.</span><span style="color:#75af00">SetConfig</span><span style="color:#111">(</span><span style="color:#75af00">config</span><span style="color:#111">.</span><span style="color:#75af00">BlockIOConfigFile</span><span style="color:#111">);</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">G</span><span style="color:#111">(</span><span style="color:#75af00">ic</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">).</span><span style="color:#75af00">WithError</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">).</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;blockio initialization failed&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">rdt</span><span style="color:#111">.</span><span style="color:#75af00">SetConfig</span><span style="color:#111">(</span><span style="color:#75af00">config</span><span style="color:#111">.</span><span style="color:#75af00">RdtConfigFile</span><span style="color:#111">);</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">G</span><span style="color:#111">(</span><span style="color:#75af00">ic</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">).</span><span style="color:#75af00">WithError</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">).</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;RDT initialization failed&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">l</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>然后在 containerd 启动的时候 注册api</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-GO" data-lang="GO"><span style="display:flex;"><span><span style="color:#75af00">loaded</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">registry</span><span style="color:#111">.</span><span style="color:#75af00">Graph</span><span style="color:#111">(</span><span style="color:#75af00">filter</span><span style="color:#111">(</span><span style="color:#75af00">config</span><span style="color:#111">.</span><span style="color:#75af00">DisabledPlugins</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">p</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">loaded</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">result</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">Init</span><span style="color:#111">(</span><span style="color:#75af00">initContext</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">initialized</span><span style="color:#111">.</span><span style="color:#75af00">Add</span><span style="color:#111">(</span><span style="color:#75af00">result</span><span style="color:#111">);</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;could not add plugin result to plugin set: %w&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">instance</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">result</span><span style="color:#111">.</span><span style="color:#75af00">Instance</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">delete</span><span style="color:#111">(</span><span style="color:#75af00">required</span><span style="color:#111">,</span> <span style="color:#75af00">id</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// check for grpc services that should be registered with the server</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">src</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">instance</span><span style="color:#111">.(</span><span style="color:#75af00">grpcService</span><span style="color:#111">);</span> <span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">grpcServices</span> <span style="color:#111">=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">grpcServices</span><span style="color:#111">,</span> <span style="color:#75af00">src</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">src</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">instance</span><span style="color:#111">.(</span><span style="color:#75af00">ttrpcService</span><span style="color:#111">);</span> <span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">ttrpcServices</span> <span style="color:#111">=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">ttrpcServices</span><span style="color:#111">,</span> <span style="color:#75af00">src</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">service</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">instance</span><span style="color:#111">.(</span><span style="color:#75af00">tcpService</span><span style="color:#111">);</span> <span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">tcpServices</span> <span style="color:#111">=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">tcpServices</span><span style="color:#111">,</span> <span style="color:#75af00">service</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">plugins</span> <span style="color:#111">=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">s</span><span style="color:#111">.</span><span style="color:#75af00">plugins</span><span style="color:#111">,</span> <span style="color:#75af00">result</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// register services after all plugins have been initialized</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">service</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">grpcServices</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">service</span><span style="color:#111">.</span><span style="color:#75af00">Register</span><span style="color:#111">(</span><span style="color:#75af00">grpcServer</span><span style="color:#111">);</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">service</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">ttrpcServices</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">service</span><span style="color:#111">.</span><span style="color:#75af00">RegisterTTRPC</span><span style="color:#111">(</span><span style="color:#75af00">ttrpcServer</span><span style="color:#111">);</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">service</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">tcpServices</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">service</span><span style="color:#111">.</span><span style="color:#75af00">RegisterTCP</span><span style="color:#111">(</span><span style="color:#75af00">tcpServer</span><span style="color:#111">);</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="create-task">create task</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">l</span> <span style="color:#f92672">*</span><span style="color:#75af00">local</span><span style="color:#111">)</span> <span style="color:#75af00">Create</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">,</span> <span style="color:#75af00">r</span> <span style="color:#f92672">*</span><span style="color:#75af00">api</span><span style="color:#111">.</span><span style="color:#75af00">CreateTaskRequest</span><span style="color:#111">,</span> <span style="color:#75af00">_</span> <span style="color:#f92672">...</span><span style="color:#75af00">grpc</span><span style="color:#111">.</span><span style="color:#75af00">CallOption</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">api</span><span style="color:#111">.</span><span style="color:#75af00">CreateTaskResponse</span><span style="color:#111">,</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">rtime</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">l</span><span style="color:#111">.</span><span style="color:#75af00">v2Runtime</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">rtime</span><span style="color:#111">.</span><span style="color:#75af00">Get</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">ContainerID</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#111">!</span><span style="color:#75af00">errdefs</span><span style="color:#111">.</span><span style="color:#75af00">IsNotFound</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">errdefs</span><span style="color:#111">.</span><span style="color:#75af00">ToGRPC</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">errdefs</span><span style="color:#111">.</span><span style="color:#75af00">ToGRPC</span><span style="color:#111">(</span><span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;task %s: %w&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">ContainerID</span><span style="color:#111">,</span> <span style="color:#75af00">errdefs</span><span style="color:#111">.</span><span style="color:#75af00">ErrAlreadyExists</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">c</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">rtime</span><span style="color:#111">.</span><span style="color:#75af00">Create</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">ContainerID</span><span style="color:#111">,</span> <span style="color:#75af00">opts</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">m</span> <span style="color:#f92672">*</span><span style="color:#75af00">TaskManager</span><span style="color:#111">)</span> <span style="color:#75af00">Create</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">,</span> <span style="color:#75af00">taskID</span> <span style="color:#00a8c8">string</span><span style="color:#111">,</span> <span style="color:#75af00">opts</span> <span style="color:#75af00">runtime</span><span style="color:#111">.</span><span style="color:#75af00">CreateOpts</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#75af00">runtime</span><span style="color:#111">.</span><span style="color:#75af00">Task</span><span style="color:#111">,</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 启动第一个 containerd-shim-runc-v2 进程</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">shimTask</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">newShimTask</span><span style="color:#111">(</span><span style="color:#75af00">shim</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 给第二个 containerd-shim-runc-v2 进程传递参数</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">t</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">shimTask</span><span style="color:#111">.</span><span style="color:#75af00">Create</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">opts</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">t</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="cri-代码">cri 代码</h3>
<p>cri 和 task 和上述的是一样的， 通过 register 注册 api.</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">init</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">registry</span><span style="color:#111">.</span><span style="color:#75af00">Register</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">plugin</span><span style="color:#111">.</span><span style="color:#75af00">Registration</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">Type</span><span style="color:#111">:</span> <span style="color:#75af00">plugins</span><span style="color:#111">.</span><span style="color:#75af00">GRPCPlugin</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">ID</span><span style="color:#111">:</span>   <span style="color:#d88200">&#34;cri&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">Requires</span><span style="color:#111">:</span> <span style="color:#111">[]</span><span style="color:#75af00">plugin</span><span style="color:#111">.</span><span style="color:#75af00">Type</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">plugins</span><span style="color:#111">.</span><span style="color:#75af00">CRIImagePlugin</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">plugins</span><span style="color:#111">.</span><span style="color:#75af00">InternalPlugin</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">plugins</span><span style="color:#111">.</span><span style="color:#75af00">SandboxControllerPlugin</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">plugins</span><span style="color:#111">.</span><span style="color:#75af00">NRIApiPlugin</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">plugins</span><span style="color:#111">.</span><span style="color:#75af00">EventPlugin</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">plugins</span><span style="color:#111">.</span><span style="color:#75af00">ServicePlugin</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">plugins</span><span style="color:#111">.</span><span style="color:#75af00">LeasePlugin</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">plugins</span><span style="color:#111">.</span><span style="color:#75af00">SandboxStorePlugin</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">InitFn</span><span style="color:#111">:</span> <span style="color:#75af00">initCRIService</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>startContainer 接口</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-GO" data-lang="GO"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">in</span> <span style="color:#f92672">*</span><span style="color:#75af00">instrumentedService</span><span style="color:#111">)</span> <span style="color:#75af00">StartContainer</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">,</span> <span style="color:#75af00">r</span> <span style="color:#f92672">*</span><span style="color:#75af00">runtime</span><span style="color:#111">.</span><span style="color:#75af00">StartContainerRequest</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#75af00">_</span> <span style="color:#f92672">*</span><span style="color:#75af00">runtime</span><span style="color:#111">.</span><span style="color:#75af00">StartContainerResponse</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">in</span><span style="color:#111">.</span><span style="color:#75af00">checkInitialized</span><span style="color:#111">();</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">G</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">).</span><span style="color:#75af00">Infof</span><span style="color:#111">(</span><span style="color:#d88200">&#34;StartContainer for %q&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">GetContainerId</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">G</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">).</span><span style="color:#75af00">WithError</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">).</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;StartContainer for %q failed&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">GetContainerId</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">G</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">).</span><span style="color:#75af00">Infof</span><span style="color:#111">(</span><span style="color:#d88200">&#34;StartContainer for %q returns successfully&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">GetContainerId</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">res</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">in</span><span style="color:#111">.</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">StartContainer</span><span style="color:#111">(</span><span style="color:#75af00">ctrdutil</span><span style="color:#111">.</span><span style="color:#75af00">WithNamespace</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">),</span> <span style="color:#75af00">r</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">res</span><span style="color:#111">,</span> <span style="color:#75af00">errdefs</span><span style="color:#111">.</span><span style="color:#75af00">ToGRPC</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">criService</span><span style="color:#111">)</span> <span style="color:#75af00">StartContainer</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">,</span> <span style="color:#75af00">r</span> <span style="color:#f92672">*</span><span style="color:#75af00">runtime</span><span style="color:#111">.</span><span style="color:#75af00">StartContainerRequest</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#75af00">retRes</span> <span style="color:#f92672">*</span><span style="color:#75af00">runtime</span><span style="color:#111">.</span><span style="color:#75af00">StartContainerResponse</span><span style="color:#111">,</span> <span style="color:#75af00">retErr</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">task</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">container</span><span style="color:#111">.</span><span style="color:#75af00">NewTask</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">ioCreation</span><span style="color:#111">,</span> <span style="color:#75af00">taskOpts</span><span style="color:#f92672">...</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">container</span><span style="color:#111">)</span> <span style="color:#75af00">NewTask</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">,</span> <span style="color:#75af00">ioCreate</span> <span style="color:#75af00">cio</span><span style="color:#111">.</span><span style="color:#75af00">Creator</span><span style="color:#111">,</span> <span style="color:#75af00">opts</span> <span style="color:#f92672">...</span><span style="color:#75af00">NewTaskOpts</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#75af00">_</span> <span style="color:#75af00">Task</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 通过 unix socket 的方式调用上述的 create task 接口</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">response</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">client</span><span style="color:#111">.</span><span style="color:#75af00">TaskService</span><span style="color:#111">().</span><span style="color:#75af00">Create</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">request</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="containerd-shim">containerd-shim</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">run</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">,</span> <span style="color:#75af00">manager</span> <span style="color:#75af00">Manager</span><span style="color:#111">,</span> <span style="color:#75af00">config</span> <span style="color:#75af00">Config</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Handle explicit actions</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">switch</span> <span style="color:#75af00">action</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">case</span> <span style="color:#d88200">&#34;delete&#34;</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">case</span> <span style="color:#d88200">&#34;start&#34;</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 如果是 start 参数的话启动一个 containerd-shim-runc-v2 进程</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">opts</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">StartOpts</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">Address</span><span style="color:#111">:</span>      <span style="color:#75af00">addressFlag</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">TTRPCAddress</span><span style="color:#111">:</span> <span style="color:#75af00">ttrpcAddress</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">Debug</span><span style="color:#111">:</span>        <span style="color:#75af00">debugFlag</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">params</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">manager</span><span style="color:#111">.</span><span style="color:#75af00">Start</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">id</span><span style="color:#111">,</span> <span style="color:#75af00">opts</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">data</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">json</span><span style="color:#111">.</span><span style="color:#75af00">Marshal</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">params</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;failed to marshal bootstrap params to json: %w&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">Stdout</span><span style="color:#111">.</span><span style="color:#75af00">Write</span><span style="color:#111">(</span><span style="color:#75af00">data</span><span style="color:#111">);</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// manager.Start 中创建的 command 指定三个参数 Namespace 容器 id 和 containerd socket 文件的地址</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">newCommand</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">,</span> <span style="color:#75af00">id</span><span style="color:#111">,</span> <span style="color:#75af00">containerdAddress</span><span style="color:#111">,</span> <span style="color:#75af00">containerdTTRPCAddress</span> <span style="color:#00a8c8">string</span><span style="color:#111">,</span> <span style="color:#75af00">debug</span> <span style="color:#00a8c8">bool</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">exec</span><span style="color:#111">.</span><span style="color:#75af00">Cmd</span><span style="color:#111">,</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ns</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">namespaces</span><span style="color:#111">.</span><span style="color:#75af00">NamespaceRequired</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">self</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">Executable</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">cwd</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">Getwd</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">args</span> <span style="color:#f92672">:=</span> <span style="color:#111">[]</span><span style="color:#00a8c8">string</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#d88200">&#34;-namespace&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">ns</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#d88200">&#34;-id&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">id</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#d88200">&#34;-address&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">containerdAddress</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">debug</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">args</span> <span style="color:#111">=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">args</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;-debug&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">cmd</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">exec</span><span style="color:#111">.</span><span style="color:#75af00">Command</span><span style="color:#111">(</span><span style="color:#75af00">self</span><span style="color:#111">,</span> <span style="color:#75af00">args</span><span style="color:#f92672">...</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">cmd</span><span style="color:#111">.</span><span style="color:#75af00">Dir</span> <span style="color:#111">=</span> <span style="color:#75af00">cwd</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">cmd</span><span style="color:#111">.</span><span style="color:#75af00">Env</span> <span style="color:#111">=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">Environ</span><span style="color:#111">(),</span> <span style="color:#d88200">&#34;GOMAXPROCS=4&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">cmd</span><span style="color:#111">.</span><span style="color:#75af00">SysProcAttr</span> <span style="color:#111">=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">syscall</span><span style="color:#111">.</span><span style="color:#75af00">SysProcAttr</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">Setpgid</span><span style="color:#111">:</span> <span style="color:#00a8c8">true</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">cmd</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>第二个 containerd-shim 也会开启一些api服务 ，比如启动容器</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-GO" data-lang="GO"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">s</span> <span style="color:#f92672">*</span><span style="color:#75af00">service</span><span style="color:#111">)</span> <span style="color:#75af00">Start</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">,</span> <span style="color:#75af00">r</span> <span style="color:#f92672">*</span><span style="color:#75af00">taskAPI</span><span style="color:#111">.</span><span style="color:#75af00">StartRequest</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">taskAPI</span><span style="color:#111">.</span><span style="color:#75af00">StartResponse</span><span style="color:#111">,</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">p</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">container</span><span style="color:#111">.</span><span style="color:#75af00">Start</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span><span style="color:#111">,</span> <span style="color:#75af00">r</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">Container</span><span style="color:#111">)</span> <span style="color:#75af00">Start</span><span style="color:#111">(</span><span style="color:#75af00">ctx</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">,</span> <span style="color:#75af00">r</span> <span style="color:#f92672">*</span><span style="color:#75af00">task</span><span style="color:#111">.</span><span style="color:#75af00">StartRequest</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#75af00">process</span><span style="color:#111">.</span><span style="color:#75af00">Process</span><span style="color:#111">,</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">p</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">Start</span><span style="color:#111">(</span><span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">ExecID</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// command 及调用 runc 启动 runc create 的进程</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">r</span> <span style="color:#f92672">*</span><span style="color:#75af00">Runc</span><span style="color:#111">)</span> <span style="color:#75af00">Start</span><span style="color:#111">(</span><span style="color:#75af00">context</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">,</span> <span style="color:#75af00">id</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">runOrError</span><span style="color:#111">(</span><span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">command</span><span style="color:#111">(</span><span style="color:#75af00">context</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;start&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">id</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="runc">runc</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">r</span> <span style="color:#f92672">*</span><span style="color:#75af00">runner</span><span style="color:#111">)</span> <span style="color:#75af00">run</span><span style="color:#111">(</span><span style="color:#75af00">config</span> <span style="color:#f92672">*</span><span style="color:#75af00">specs</span><span style="color:#111">.</span><span style="color:#75af00">Process</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#00a8c8">int</span><span style="color:#111">,</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">switch</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">action</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">case</span> <span style="color:#75af00">CT_ACT_CREATE</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">container</span><span style="color:#111">.</span><span style="color:#75af00">Start</span><span style="color:#111">(</span><span style="color:#75af00">process</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">case</span> <span style="color:#75af00">CT_ACT_RESTORE</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">container</span><span style="color:#111">.</span><span style="color:#75af00">Restore</span><span style="color:#111">(</span><span style="color:#75af00">process</span><span style="color:#111">,</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">criuOpts</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">case</span> <span style="color:#75af00">CT_ACT_RUN</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">container</span><span style="color:#111">.</span><span style="color:#75af00">Run</span><span style="color:#111">(</span><span style="color:#75af00">process</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">default</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Unknown action&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">Container</span><span style="color:#111">)</span> <span style="color:#75af00">Start</span><span style="color:#111">(</span><span style="color:#75af00">process</span> <span style="color:#f92672">*</span><span style="color:#75af00">Process</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">Lock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">m</span><span style="color:#111">.</span><span style="color:#75af00">Unlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">config</span><span style="color:#111">.</span><span style="color:#75af00">Cgroups</span><span style="color:#111">.</span><span style="color:#75af00">Resources</span><span style="color:#111">.</span><span style="color:#75af00">SkipDevices</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">errors</span><span style="color:#111">.</span><span style="color:#75af00">New</span><span style="color:#111">(</span><span style="color:#d88200">&#34;can&#39;t start container with SkipDevices set&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">process</span><span style="color:#111">.</span><span style="color:#75af00">Init</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">createExecFifo</span><span style="color:#111">();</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">start</span><span style="color:#111">(</span><span style="color:#75af00">process</span><span style="color:#111">);</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">process</span><span style="color:#111">.</span><span style="color:#75af00">Init</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">deleteExecFifo</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 调用 runc init 进程 /proc/self/exe 是自己的二进制文件</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">Container</span><span style="color:#111">)</span> <span style="color:#75af00">newParentProcess</span><span style="color:#111">(</span><span style="color:#75af00">p</span> <span style="color:#f92672">*</span><span style="color:#75af00">Process</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#75af00">parentProcess</span><span style="color:#111">,</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">comm</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">newProcessComm</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Make sure we use a new safe copy of /proc/self/exe or the runc-dmz</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// binary each time this is called, to make sure that if a container</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// manages to overwrite the file it cannot affect other containers on the</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// system. For runc, this code will only ever be called once, but</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// libcontainer users might call this more than once.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">closeClonedExes</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">var</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">exePath</span> <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// only one of dmzExe or safeExe are used at a time</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">dmzExe</span><span style="color:#111">,</span> <span style="color:#75af00">safeExe</span> <span style="color:#f92672">*</span><span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">File</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">dmz</span><span style="color:#111">.</span><span style="color:#75af00">IsSelfExeCloned</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// /proc/self/exe is already a cloned binary -- no need to do anything</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">logrus</span><span style="color:#111">.</span><span style="color:#75af00">Debug</span><span style="color:#111">(</span><span style="color:#d88200">&#34;skipping binary cloning -- /proc/self/exe is already cloned!&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">exePath</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;/proc/self/exe&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span> 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">cmd</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">exec</span><span style="color:#111">.</span><span style="color:#75af00">Command</span><span style="color:#111">(</span><span style="color:#75af00">exePath</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;init&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">cmd</span><span style="color:#111">.</span><span style="color:#75af00">Args</span><span style="color:#111">[</span><span style="color:#ae81ff">0</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">Args</span><span style="color:#111">[</span><span style="color:#ae81ff">0</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">cmd</span><span style="color:#111">.</span><span style="color:#75af00">Stdin</span> <span style="color:#111">=</span> <span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">Stdin</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">cmd</span><span style="color:#111">.</span><span style="color:#75af00">Stdout</span> <span style="color:#111">=</span> <span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">Stdout</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">cmd</span><span style="color:#111">.</span><span style="color:#75af00">Stderr</span> <span style="color:#111">=</span> <span style="color:#75af00">p</span><span style="color:#111">.</span><span style="color:#75af00">Stderr</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">cmd</span><span style="color:#111">.</span><span style="color:#75af00">Dir</span> <span style="color:#111">=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">config</span><span style="color:#111">.</span><span style="color:#75af00">Rootfs</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">cmd</span><span style="color:#111">.</span><span style="color:#75af00">SysProcAttr</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">cmd</span><span style="color:#111">.</span><span style="color:#75af00">SysProcAttr</span> <span style="color:#111">=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">unix</span><span style="color:#111">.</span><span style="color:#75af00">SysProcAttr</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>runc init</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">init</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">Args</span><span style="color:#111">)</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">Args</span><span style="color:#111">[</span><span style="color:#ae81ff">1</span><span style="color:#111">]</span> <span style="color:#f92672">==</span> <span style="color:#d88200">&#34;init&#34;</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// This is the golang entry point for runc init, executed</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// before main() but after libcontainer/nsenter&#39;s nsexec().</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">libcontainer</span><span style="color:#111">.</span><span style="color:#75af00">Init</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// libcontainer.Init() 中调用的</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">startInitialization</span><span style="color:#111">()</span> <span style="color:#111">(</span><span style="color:#75af00">retErr</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#75af00">containerInit</span><span style="color:#111">(</span><span style="color:#75af00">it</span><span style="color:#111">,</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">config</span><span style="color:#111">,</span> <span style="color:#75af00">syncPipe</span><span style="color:#111">,</span> <span style="color:#75af00">consoleSocket</span><span style="color:#111">,</span> <span style="color:#75af00">pidfdSocket</span><span style="color:#111">,</span> <span style="color:#75af00">fifofd</span><span style="color:#111">,</span> <span style="color:#75af00">logFD</span><span style="color:#111">,</span> <span style="color:#75af00">dmzExe</span><span style="color:#111">,</span> <span style="color:#75af00">mountFds</span><span style="color:#111">{</span><span style="color:#75af00">sourceFds</span><span style="color:#111">:</span> <span style="color:#75af00">mountSrcFds</span><span style="color:#111">,</span> <span style="color:#75af00">idmapFds</span><span style="color:#111">:</span> <span style="color:#75af00">idmapFds</span><span style="color:#111">})</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// linuxSetnsInit 是 exec 的时候调用的 在启动的容器执行命令</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// initStandard 是启动容器</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">containerInit</span><span style="color:#111">(</span><span style="color:#75af00">t</span> <span style="color:#75af00">initType</span><span style="color:#111">,</span> <span style="color:#75af00">config</span> <span style="color:#f92672">*</span><span style="color:#75af00">initConfig</span><span style="color:#111">,</span> <span style="color:#75af00">pipe</span> <span style="color:#f92672">*</span><span style="color:#75af00">syncSocket</span><span style="color:#111">,</span> <span style="color:#75af00">consoleSocket</span><span style="color:#111">,</span> <span style="color:#75af00">pidfdSocket</span> <span style="color:#f92672">*</span><span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">File</span><span style="color:#111">,</span> <span style="color:#75af00">fifoFd</span><span style="color:#111">,</span> <span style="color:#75af00">logFd</span> <span style="color:#00a8c8">int</span><span style="color:#111">,</span> <span style="color:#75af00">dmzExe</span> <span style="color:#f92672">*</span><span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">File</span><span style="color:#111">,</span> <span style="color:#75af00">mountFds</span> <span style="color:#75af00">mountFds</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">populateProcessEnvironment</span><span style="color:#111">(</span><span style="color:#75af00">config</span><span style="color:#111">.</span><span style="color:#75af00">Env</span><span style="color:#111">);</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">switch</span> <span style="color:#75af00">t</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">case</span> <span style="color:#75af00">initSetns</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// mount and idmap fds must be nil in this case. We don&#39;t mount while doing runc exec.</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">mountFds</span><span style="color:#111">.</span><span style="color:#75af00">sourceFds</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#f92672">||</span> <span style="color:#75af00">mountFds</span><span style="color:#111">.</span><span style="color:#75af00">idmapFds</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#75af00">errors</span><span style="color:#111">.</span><span style="color:#75af00">New</span><span style="color:#111">(</span><span style="color:#d88200">&#34;mount and idmap fds must be nil; can&#39;t mount from exec&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">i</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">linuxSetnsInit</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">pipe</span><span style="color:#111">:</span>          <span style="color:#75af00">pipe</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">consoleSocket</span><span style="color:#111">:</span> <span style="color:#75af00">consoleSocket</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">pidfdSocket</span><span style="color:#111">:</span>   <span style="color:#75af00">pidfdSocket</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">config</span><span style="color:#111">:</span>        <span style="color:#75af00">config</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">logFd</span><span style="color:#111">:</span>         <span style="color:#75af00">logFd</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">dmzExe</span><span style="color:#111">:</span>        <span style="color:#75af00">dmzExe</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">i</span><span style="color:#111">.</span><span style="color:#75af00">Init</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">case</span> <span style="color:#75af00">initStandard</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">i</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">linuxStandardInit</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">pipe</span><span style="color:#111">:</span>          <span style="color:#75af00">pipe</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">consoleSocket</span><span style="color:#111">:</span> <span style="color:#75af00">consoleSocket</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">pidfdSocket</span><span style="color:#111">:</span>   <span style="color:#75af00">pidfdSocket</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">parentPid</span><span style="color:#111">:</span>     <span style="color:#75af00">unix</span><span style="color:#111">.</span><span style="color:#75af00">Getppid</span><span style="color:#111">(),</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">config</span><span style="color:#111">:</span>        <span style="color:#75af00">config</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">fifoFd</span><span style="color:#111">:</span>        <span style="color:#75af00">fifoFd</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">logFd</span><span style="color:#111">:</span>         <span style="color:#75af00">logFd</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">dmzExe</span><span style="color:#111">:</span>        <span style="color:#75af00">dmzExe</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">mountFds</span><span style="color:#111">:</span>      <span style="color:#75af00">mountFds</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">i</span><span style="color:#111">.</span><span style="color:#75af00">Init</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Errorf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;unknown init type %q&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">t</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">l</span> <span style="color:#f92672">*</span><span style="color:#75af00">linuxStandardInit</span><span style="color:#111">)</span> <span style="color:#75af00">Init</span><span style="color:#111">()</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#75af00">system</span><span style="color:#111">.</span><span style="color:#75af00">Exec</span><span style="color:#111">(</span><span style="color:#75af00">name</span><span style="color:#111">,</span> <span style="color:#75af00">l</span><span style="color:#111">.</span><span style="color:#75af00">config</span><span style="color:#111">.</span><span style="color:#75af00">Args</span><span style="color:#111">,</span> <span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">Environ</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 替换进程</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">Exec</span><span style="color:#111">(</span><span style="color:#75af00">cmd</span> <span style="color:#00a8c8">string</span><span style="color:#111">,</span> <span style="color:#75af00">args</span> <span style="color:#111">[]</span><span style="color:#00a8c8">string</span><span style="color:#111">,</span> <span style="color:#75af00">env</span> <span style="color:#111">[]</span><span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">unix</span><span style="color:#111">.</span><span style="color:#75af00">Exec</span><span style="color:#111">(</span><span style="color:#75af00">cmd</span><span style="color:#111">,</span> <span style="color:#75af00">args</span><span style="color:#111">,</span> <span style="color:#75af00">env</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#75af00">unix</span><span style="color:#111">.</span><span style="color:#75af00">EINTR</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">PathError</span><span style="color:#111">{</span><span style="color:#75af00">Op</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;exec&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">Path</span><span style="color:#111">:</span> <span style="color:#75af00">cmd</span><span style="color:#111">,</span> <span style="color:#75af00">Err</span><span style="color:#111">:</span> <span style="color:#75af00">err</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div>]]></content:encoded><category>cloud</category><category>docker</category><category>containerd</category><category>runc</category><category>containerd-shim</category><category>kubernetes</category><category>源码分析</category></item></channel></rss>