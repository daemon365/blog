<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/"><channel><title>Gin on Daemon365</title><link>https://daemon365.dev/tags/gin/</link><description>Don't let yourself stop.</description><generator>Hugo -- gohugo.io</generator><language>zh-cn</language><lastBuildDate>Mon, 23 Dec 2019 00:00:00 +0800</lastBuildDate><atom:link href="https://daemon365.dev/tags/gin/index.xml" rel="self" type="application/rss+xml"/><item><title>nethttp和gin 路由</title><link>https://daemon365.dev/post/go/nethttp_and_gin_routing/</link><pubDate>Mon, 23 Dec 2019 00:00:00 +0800</pubDate><guid>https://daemon365.dev/post/go/nethttp_and_gin_routing/</guid><description>&lt;h2 id="nethttp-路由注册"&gt;net/http 路由注册&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;test1&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;http&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;HandleFunc&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;/&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;func&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;w&lt;/span&gt; &lt;span style="color:#75af00"&gt;http&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;ResponseWriter&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;r&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;http&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Request&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Fprintf&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;w&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;Hello world!&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;})&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;http&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;ListenAndServe&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;:9001&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;!=&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;log&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Fatal&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;ListenAndServer:&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;在使用&lt;code&gt;ListenAndServe&lt;/code&gt;这个方法时，系统就会给我们指派一个路由器，&lt;code&gt;DefaultServeMux&lt;/code&gt;是系统默认使用的路由器，如果&lt;code&gt;ListenAndServe&lt;/code&gt;这个方法的第2个参数传入nil，系统就会默认使用&lt;code&gt;DefaultServeMux&lt;/code&gt;。当然，这里也可以传入自定义的路由器。&lt;/p&gt;
&lt;p&gt;先看&lt;code&gt;http.HandleFunc(&amp;quot;/&amp;quot;, ...)&lt;/code&gt;，从&lt;code&gt;HandleFunc&lt;/code&gt;方法点进去，如下：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;HandleFunc&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;pattern&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;string&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;handler&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;func&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;ResponseWriter&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;Request&lt;/span&gt;&lt;span style="color:#111"&gt;))&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;DefaultServeMux&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;HandleFunc&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;pattern&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;handler&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;在这里调用了&lt;code&gt;DefaultServeMux&lt;/code&gt;的&lt;code&gt;HandleFunc&lt;/code&gt;方法，这个方法有两个参数，&lt;code&gt;pattern&lt;/code&gt;是匹配的路由规则，&lt;code&gt;handler&lt;/code&gt;表示这个路由规则对应的处理方法，并且这个处理方法有两个参数。&lt;/p&gt;
&lt;p&gt;在我们书写的代码示例中，&lt;code&gt;pattern&lt;/code&gt;对应&lt;code&gt;/&lt;/code&gt;，&lt;code&gt;handler&lt;/code&gt;对应&lt;code&gt;sayHello&lt;/code&gt;，当我们在浏览器中输入&lt;code&gt;http://localhost:9001&lt;/code&gt;时，就会触发匿名函数。&lt;/p&gt;
&lt;p&gt;我们再顺着&lt;code&gt;DefaultServeMux&lt;/code&gt;的&lt;code&gt;HandleFunc&lt;/code&gt;方法继续点下去，如下：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;mux&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;ServeMux&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75af00"&gt;HandleFunc&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;pattern&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;string&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;handler&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;func&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;ResponseWriter&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;Request&lt;/span&gt;&lt;span style="color:#111"&gt;))&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;handler&lt;/span&gt; &lt;span style="color:#f92672"&gt;==&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;panic&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;http: nil handler&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;mux&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Handle&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;pattern&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;HandlerFunc&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;handler&lt;/span&gt;&lt;span style="color:#111"&gt;))&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;在这个方法中，路由器又调用了&lt;code&gt;Handle&lt;/code&gt;方法，注意这个&lt;code&gt;Handle&lt;/code&gt;方法的第2个参数，将之前传入的&lt;code&gt;handler&lt;/code&gt;这个响应方法强制转换成了&lt;code&gt;HandlerFunc&lt;/code&gt;类型。&lt;/p&gt;
&lt;p&gt;这个&lt;code&gt;HandlerFunc&lt;/code&gt;类型到底是个什么呢？如下：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;type&lt;/span&gt; &lt;span style="color:#75af00"&gt;HandlerFunc&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;func&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;ResponseWriter&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;Request&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;看来和我们定义的&amp;quot;/&amp;ldquo;的匿名函数的类型都差不多。但是！！！ 这个&lt;code&gt;HandlerFunc&lt;/code&gt;默认实现了&lt;code&gt;ServeHTTP&lt;/code&gt;接口！这样&lt;code&gt;HandlerFunc&lt;/code&gt;对象就有了&lt;code&gt;ServeHTTP&lt;/code&gt;方法！如下：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;// ServeHTTP calls f(w, r).&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;f&lt;/span&gt; &lt;span style="color:#75af00"&gt;HandlerFunc&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75af00"&gt;ServeHTTP&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;w&lt;/span&gt; &lt;span style="color:#75af00"&gt;ResponseWriter&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;r&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;Request&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;f&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;w&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;r&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;接下来，我们返回去继续看&lt;code&gt;mux&lt;/code&gt;的&lt;code&gt;Handle&lt;/code&gt;方法，也就是这段代码&lt;code&gt;mux.Handle(pattern, HandlerFunc(handler))&lt;/code&gt;。这段代码做了哪些事呢？源码如下&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;// Handle registers the handler for the given pattern.&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;// If a handler already exists for pattern, Handle panics.&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;mux&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;ServeMux&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#75af00"&gt;Handle&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;pattern&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;string&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;handler&lt;/span&gt; &lt;span style="color:#75af00"&gt;Handler&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;mux&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;mu&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Lock&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;defer&lt;/span&gt; &lt;span style="color:#75af00"&gt;mux&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;mu&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Unlock&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;pattern&lt;/span&gt; &lt;span style="color:#f92672"&gt;==&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;&amp;#34;&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;panic&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;http: invalid pattern&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;handler&lt;/span&gt; &lt;span style="color:#f92672"&gt;==&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;panic&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;http: nil handler&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;_&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;exist&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;mux&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;m&lt;/span&gt;&lt;span style="color:#111"&gt;[&lt;/span&gt;&lt;span style="color:#75af00"&gt;pattern&lt;/span&gt;&lt;span style="color:#111"&gt;];&lt;/span&gt; &lt;span style="color:#75af00"&gt;exist&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;panic&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;http: multiple registrations for &amp;#34;&lt;/span&gt; &lt;span style="color:#f92672"&gt;+&lt;/span&gt; &lt;span style="color:#75af00"&gt;pattern&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;mux&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;m&lt;/span&gt; &lt;span style="color:#f92672"&gt;==&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;mux&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;m&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#111"&gt;make&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;map&lt;/span&gt;&lt;span style="color:#111"&gt;[&lt;/span&gt;&lt;span style="color:#00a8c8"&gt;string&lt;/span&gt;&lt;span style="color:#111"&gt;]&lt;/span&gt;&lt;span style="color:#75af00"&gt;muxEntry&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;e&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;muxEntry&lt;/span&gt;&lt;span style="color:#111"&gt;{&lt;/span&gt;&lt;span style="color:#75af00"&gt;h&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#75af00"&gt;handler&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;pattern&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#75af00"&gt;pattern&lt;/span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;mux&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;m&lt;/span&gt;&lt;span style="color:#111"&gt;[&lt;/span&gt;&lt;span style="color:#75af00"&gt;pattern&lt;/span&gt;&lt;span style="color:#111"&gt;]&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#75af00"&gt;e&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;pattern&lt;/span&gt;&lt;span style="color:#111"&gt;[&lt;/span&gt;&lt;span style="color:#111"&gt;len&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;pattern&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;&lt;span style="color:#f92672"&gt;-&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;1&lt;/span&gt;&lt;span style="color:#111"&gt;]&lt;/span&gt; &lt;span style="color:#f92672"&gt;==&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#39;/&amp;#39;&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;mux&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;es&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#75af00"&gt;appendSorted&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;mux&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;es&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;e&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;pattern&lt;/span&gt;&lt;span style="color:#111"&gt;[&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;0&lt;/span&gt;&lt;span style="color:#111"&gt;]&lt;/span&gt; &lt;span style="color:#f92672"&gt;!=&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#39;/&amp;#39;&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;mux&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;hosts&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;true&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;主要就做了一件事，向&lt;code&gt;DefaultServeMux&lt;/code&gt;的&lt;code&gt;map[string]muxEntry&lt;/code&gt;中增加对应的路由规则和&lt;code&gt;handler&lt;/code&gt;。&lt;/p&gt;</description><content:encoded><![CDATA[<h2 id="nethttp-路由注册">net/http 路由注册</h2>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">test1</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">HandleFunc</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">w</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">ResponseWriter</span><span style="color:#111">,</span> <span style="color:#75af00">r</span> <span style="color:#f92672">*</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Request</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Fprintf</span><span style="color:#111">(</span><span style="color:#75af00">w</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Hello world!&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">ListenAndServe</span><span style="color:#111">(</span><span style="color:#d88200">&#34;:9001&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Fatal</span><span style="color:#111">(</span><span style="color:#d88200">&#34;ListenAndServer:&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>在使用<code>ListenAndServe</code>这个方法时，系统就会给我们指派一个路由器，<code>DefaultServeMux</code>是系统默认使用的路由器，如果<code>ListenAndServe</code>这个方法的第2个参数传入nil，系统就会默认使用<code>DefaultServeMux</code>。当然，这里也可以传入自定义的路由器。</p>
<p>先看<code>http.HandleFunc(&quot;/&quot;, ...)</code>，从<code>HandleFunc</code>方法点进去，如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">HandleFunc</span><span style="color:#111">(</span><span style="color:#75af00">pattern</span> <span style="color:#00a8c8">string</span><span style="color:#111">,</span> <span style="color:#75af00">handler</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">ResponseWriter</span><span style="color:#111">,</span> <span style="color:#f92672">*</span><span style="color:#75af00">Request</span><span style="color:#111">))</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">DefaultServeMux</span><span style="color:#111">.</span><span style="color:#75af00">HandleFunc</span><span style="color:#111">(</span><span style="color:#75af00">pattern</span><span style="color:#111">,</span> <span style="color:#75af00">handler</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>在这里调用了<code>DefaultServeMux</code>的<code>HandleFunc</code>方法，这个方法有两个参数，<code>pattern</code>是匹配的路由规则，<code>handler</code>表示这个路由规则对应的处理方法，并且这个处理方法有两个参数。</p>
<p>在我们书写的代码示例中，<code>pattern</code>对应<code>/</code>，<code>handler</code>对应<code>sayHello</code>，当我们在浏览器中输入<code>http://localhost:9001</code>时，就会触发匿名函数。</p>
<p>我们再顺着<code>DefaultServeMux</code>的<code>HandleFunc</code>方法继续点下去，如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">mux</span> <span style="color:#f92672">*</span><span style="color:#75af00">ServeMux</span><span style="color:#111">)</span> <span style="color:#75af00">HandleFunc</span><span style="color:#111">(</span><span style="color:#75af00">pattern</span> <span style="color:#00a8c8">string</span><span style="color:#111">,</span> <span style="color:#75af00">handler</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">ResponseWriter</span><span style="color:#111">,</span> <span style="color:#f92672">*</span><span style="color:#75af00">Request</span><span style="color:#111">))</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">handler</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#d88200">&#34;http: nil handler&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">Handle</span><span style="color:#111">(</span><span style="color:#75af00">pattern</span><span style="color:#111">,</span> <span style="color:#75af00">HandlerFunc</span><span style="color:#111">(</span><span style="color:#75af00">handler</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>在这个方法中，路由器又调用了<code>Handle</code>方法，注意这个<code>Handle</code>方法的第2个参数，将之前传入的<code>handler</code>这个响应方法强制转换成了<code>HandlerFunc</code>类型。</p>
<p>这个<code>HandlerFunc</code>类型到底是个什么呢？如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">HandlerFunc</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">ResponseWriter</span><span style="color:#111">,</span> <span style="color:#f92672">*</span><span style="color:#75af00">Request</span><span style="color:#111">)</span>
</span></span></code></pre></div><p>看来和我们定义的&quot;/&ldquo;的匿名函数的类型都差不多。但是！！！ 这个<code>HandlerFunc</code>默认实现了<code>ServeHTTP</code>接口！这样<code>HandlerFunc</code>对象就有了<code>ServeHTTP</code>方法！如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// ServeHTTP calls f(w, r).</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">f</span> <span style="color:#75af00">HandlerFunc</span><span style="color:#111">)</span> <span style="color:#75af00">ServeHTTP</span><span style="color:#111">(</span><span style="color:#75af00">w</span> <span style="color:#75af00">ResponseWriter</span><span style="color:#111">,</span> <span style="color:#75af00">r</span> <span style="color:#f92672">*</span><span style="color:#75af00">Request</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">f</span><span style="color:#111">(</span><span style="color:#75af00">w</span><span style="color:#111">,</span> <span style="color:#75af00">r</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>接下来，我们返回去继续看<code>mux</code>的<code>Handle</code>方法，也就是这段代码<code>mux.Handle(pattern, HandlerFunc(handler))</code>。这段代码做了哪些事呢？源码如下</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// Handle registers the handler for the given pattern.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// If a handler already exists for pattern, Handle panics.</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">mux</span> <span style="color:#f92672">*</span><span style="color:#75af00">ServeMux</span><span style="color:#111">)</span> <span style="color:#75af00">Handle</span><span style="color:#111">(</span><span style="color:#75af00">pattern</span> <span style="color:#00a8c8">string</span><span style="color:#111">,</span> <span style="color:#75af00">handler</span> <span style="color:#75af00">Handler</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">Lock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">defer</span> <span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">Unlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">pattern</span> <span style="color:#f92672">==</span> <span style="color:#d88200">&#34;&#34;</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#d88200">&#34;http: invalid pattern&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">handler</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#d88200">&#34;http: nil handler&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">exist</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">m</span><span style="color:#111">[</span><span style="color:#75af00">pattern</span><span style="color:#111">];</span> <span style="color:#75af00">exist</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#d88200">&#34;http: multiple registrations for &#34;</span> <span style="color:#f92672">+</span> <span style="color:#75af00">pattern</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">m</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">m</span> <span style="color:#111">=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#00a8c8">string</span><span style="color:#111">]</span><span style="color:#75af00">muxEntry</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">e</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">muxEntry</span><span style="color:#111">{</span><span style="color:#75af00">h</span><span style="color:#111">:</span> <span style="color:#75af00">handler</span><span style="color:#111">,</span> <span style="color:#75af00">pattern</span><span style="color:#111">:</span> <span style="color:#75af00">pattern</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">m</span><span style="color:#111">[</span><span style="color:#75af00">pattern</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#75af00">e</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">pattern</span><span style="color:#111">[</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">pattern</span><span style="color:#111">)</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#111">]</span> <span style="color:#f92672">==</span> <span style="color:#d88200">&#39;/&#39;</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">es</span> <span style="color:#111">=</span> <span style="color:#75af00">appendSorted</span><span style="color:#111">(</span><span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">es</span><span style="color:#111">,</span> <span style="color:#75af00">e</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">pattern</span><span style="color:#111">[</span><span style="color:#ae81ff">0</span><span style="color:#111">]</span> <span style="color:#f92672">!=</span> <span style="color:#d88200">&#39;/&#39;</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">hosts</span> <span style="color:#111">=</span> <span style="color:#00a8c8">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>主要就做了一件事，向<code>DefaultServeMux</code>的<code>map[string]muxEntry</code>中增加对应的路由规则和<code>handler</code>。</p>
<p><code>map[string]muxEntry</code>是个什么鬼？</p>
<ul>
<li><code>map</code>是一个字典对象，它保存的是<code>key-value</code>。</li>
<li><code>[string]</code>表示这个字典的<code>key</code>是<code>string</code>类型的，这个<code>key</code>值会保存我们的路由规则。</li>
<li><code>muxEntry</code>是一个实例对象，这个对象内保存了路由规则对应的处理方法。</li>
<li><code>mux.es</code> 为模糊匹配 有长倒短排序 比如有路由<code>/hello/</code> 访问<code>/hello/world</code> 时没有路由 会落到<code>/hello/</code>上</li>
</ul>
<p>找到相应代码，如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// 路由器</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">ServeMux</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">mu</span>    <span style="color:#75af00">sync</span><span style="color:#111">.</span><span style="color:#75af00">RWMutex</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">m</span>     <span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#00a8c8">string</span><span style="color:#111">]</span><span style="color:#75af00">muxEntry</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">es</span>    <span style="color:#111">[]</span><span style="color:#75af00">muxEntry</span> <span style="color:#75715e">// slice of entries sorted from longest to shortest.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">hosts</span> <span style="color:#00a8c8">bool</span>       <span style="color:#75715e">// whether any patterns contain hostnames</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">muxEntry</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">h</span>       <span style="color:#75af00">Handler</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">pattern</span> <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 路由响应方法</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Handler</span> <span style="color:#00a8c8">interface</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">ServeHTTP</span><span style="color:#111">(</span><span style="color:#75af00">ResponseWriter</span><span style="color:#111">,</span> <span style="color:#f92672">*</span><span style="color:#75af00">Request</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="nethttp-运行">net/http 运行</h2>
<p>第二部分主要就是研究这句代码<code>err := http.ListenAndServe(&quot;:9001&quot;,nil)</code>，也就是<code>ListenAndServe</code>这个方法。从这个方法点进去，如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">ListenAndServe</span><span style="color:#111">(</span><span style="color:#75af00">addr</span> <span style="color:#00a8c8">string</span><span style="color:#111">,</span> <span style="color:#75af00">handler</span> <span style="color:#75af00">Handler</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">server</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">Server</span><span style="color:#111">{</span><span style="color:#75af00">Addr</span><span style="color:#111">:</span> <span style="color:#75af00">addr</span><span style="color:#111">,</span> <span style="color:#75af00">Handler</span><span style="color:#111">:</span> <span style="color:#75af00">handler</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#75af00">server</span><span style="color:#111">.</span><span style="color:#75af00">ListenAndServe</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>在这个方法中，初始化了一个<code>server</code>对象，然后调用这个<code>server</code>对象的<code>ListenAndServe</code>方法，在这个方法中，如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">srv</span> <span style="color:#f92672">*</span><span style="color:#75af00">Server</span><span style="color:#111">)</span> <span style="color:#75af00">ListenAndServe</span><span style="color:#111">()</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">srv</span><span style="color:#111">.</span><span style="color:#75af00">shuttingDown</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">ErrServerClosed</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">addr</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">srv</span><span style="color:#111">.</span><span style="color:#75af00">Addr</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">addr</span> <span style="color:#f92672">==</span> <span style="color:#d88200">&#34;&#34;</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">addr</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;:http&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">ln</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">net</span><span style="color:#111">.</span><span style="color:#75af00">Listen</span><span style="color:#111">(</span><span style="color:#d88200">&#34;tcp&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">addr</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#75af00">srv</span><span style="color:#111">.</span><span style="color:#75af00">Serve</span><span style="color:#111">(</span><span style="color:#75af00">ln</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>在这个方法中，调用了<code>net.Listen(&quot;tcp&quot;, addr)</code>，也就是底层用TCP协议搭建了一个服务，然后监控我们设置的端口。</p>
<p>代码的最后，调用了<code>srv</code>的<code>Serve</code>方法，如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">srv</span> <span style="color:#f92672">*</span><span style="color:#75af00">Server</span><span style="color:#111">)</span> <span style="color:#75af00">Serve</span><span style="color:#111">(</span><span style="color:#75af00">l</span> <span style="color:#75af00">net</span><span style="color:#111">.</span><span style="color:#75af00">Listener</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">fn</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">testHookServerServe</span><span style="color:#111">;</span> <span style="color:#75af00">fn</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">fn</span><span style="color:#111">(</span><span style="color:#75af00">srv</span><span style="color:#111">,</span> <span style="color:#75af00">l</span><span style="color:#111">)</span> <span style="color:#75715e">// call hook with unwrapped listener</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">origListener</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">l</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">l</span> <span style="color:#111">=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">onceCloseListener</span><span style="color:#111">{</span><span style="color:#75af00">Listener</span><span style="color:#111">:</span> <span style="color:#75af00">l</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">defer</span> <span style="color:#75af00">l</span><span style="color:#111">.</span><span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">srv</span><span style="color:#111">.</span><span style="color:#75af00">setupHTTP2_Serve</span><span style="color:#111">();</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#111">!</span><span style="color:#75af00">srv</span><span style="color:#111">.</span><span style="color:#75af00">trackListener</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">l</span><span style="color:#111">,</span> <span style="color:#00a8c8">true</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">ErrServerClosed</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">defer</span> <span style="color:#75af00">srv</span><span style="color:#111">.</span><span style="color:#75af00">trackListener</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">l</span><span style="color:#111">,</span> <span style="color:#00a8c8">false</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">baseCtx</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">Background</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">srv</span><span style="color:#111">.</span><span style="color:#75af00">BaseContext</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">baseCtx</span> <span style="color:#111">=</span> <span style="color:#75af00">srv</span><span style="color:#111">.</span><span style="color:#75af00">BaseContext</span><span style="color:#111">(</span><span style="color:#75af00">origListener</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#75af00">baseCtx</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#d88200">&#34;BaseContext returned a nil context&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">var</span> <span style="color:#75af00">tempDelay</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Duration</span> <span style="color:#75715e">// how long to sleep on accept failure</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">ctx</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">WithValue</span><span style="color:#111">(</span><span style="color:#75af00">baseCtx</span><span style="color:#111">,</span> <span style="color:#75af00">ServerContextKey</span><span style="color:#111">,</span> <span style="color:#75af00">srv</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">for</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">rw</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">l</span><span style="color:#111">.</span><span style="color:#75af00">Accept</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">select</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#75af00">srv</span><span style="color:#111">.</span><span style="color:#75af00">getDoneChan</span><span style="color:#111">():</span>
</span></span><span style="display:flex;"><span>                <span style="color:#00a8c8">return</span> <span style="color:#75af00">ErrServerClosed</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">default</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">if</span> <span style="color:#75af00">ne</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">err</span><span style="color:#111">.(</span><span style="color:#75af00">net</span><span style="color:#111">.</span><span style="color:#75af00">Error</span><span style="color:#111">);</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">ne</span><span style="color:#111">.</span><span style="color:#75af00">Temporary</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#00a8c8">if</span> <span style="color:#75af00">tempDelay</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#75af00">tempDelay</span> <span style="color:#111">=</span> <span style="color:#ae81ff">5</span> <span style="color:#f92672">*</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Millisecond</span>
</span></span><span style="display:flex;"><span>                <span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#75af00">tempDelay</span> <span style="color:#f92672">*=</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>                <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#00a8c8">if</span> <span style="color:#75af00">max</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">*</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Second</span><span style="color:#111">;</span> <span style="color:#75af00">tempDelay</span> <span style="color:#111">&gt;</span> <span style="color:#75af00">max</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#75af00">tempDelay</span> <span style="color:#111">=</span> <span style="color:#75af00">max</span>
</span></span><span style="display:flex;"><span>                <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75af00">srv</span><span style="color:#111">.</span><span style="color:#75af00">logf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;http: Accept error: %v; retrying in %v&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">,</span> <span style="color:#75af00">tempDelay</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Sleep</span><span style="color:#111">(</span><span style="color:#75af00">tempDelay</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#00a8c8">continue</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">connCtx</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">ctx</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#75af00">cc</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">srv</span><span style="color:#111">.</span><span style="color:#75af00">ConnContext</span><span style="color:#111">;</span> <span style="color:#75af00">cc</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75af00">connCtx</span> <span style="color:#111">=</span> <span style="color:#75af00">cc</span><span style="color:#111">(</span><span style="color:#75af00">connCtx</span><span style="color:#111">,</span> <span style="color:#75af00">rw</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">if</span> <span style="color:#75af00">connCtx</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#d88200">&#34;ConnContext returned nil&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">tempDelay</span> <span style="color:#111">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">c</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">srv</span><span style="color:#111">.</span><span style="color:#75af00">newConn</span><span style="color:#111">(</span><span style="color:#75af00">rw</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">setState</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">rwc</span><span style="color:#111">,</span> <span style="color:#75af00">StateNew</span><span style="color:#111">,</span> <span style="color:#75af00">runHooks</span><span style="color:#111">)</span> <span style="color:#75715e">// before Serve can return</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">go</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">serve</span><span style="color:#111">(</span><span style="color:#75af00">connCtx</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>最后3段代码比较重要，也是Go语言支持高并发的体现，如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">c</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">srv</span><span style="color:#111">.</span><span style="color:#75af00">newConn</span><span style="color:#111">(</span><span style="color:#75af00">rw</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">setState</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">rwc</span><span style="color:#111">,</span> <span style="color:#75af00">StateNew</span><span style="color:#111">,</span> <span style="color:#75af00">runHooks</span><span style="color:#111">)</span> <span style="color:#75715e">// before Serve can return</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">go</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">serve</span><span style="color:#111">(</span><span style="color:#75af00">connCtx</span><span style="color:#111">)</span>
</span></span></code></pre></div><p>上面那一大坨代码，总体意思是进入方法后，首先开了一个<code>for</code>循环，在<code>for</code>循环内时刻Accept请求，请求来了之后，会为每个请求创建一个<code>Conn</code>，然后单独开启一个<code>goroutine</code>，把这个请求的数据当做参数扔给这个<code>Conn</code>去服务：<code>go c.serve()</code>。用户的每一次请求都是在一个新的<code>goroutine</code>去服务，每个请求间相互不影响。</p>
<p>在<code>conn</code>的<code>serve</code>方法中，有一句代码很重要，如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">serverHandler</span><span style="color:#111">{</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">server</span><span style="color:#111">}.</span><span style="color:#75af00">ServeHTTP</span><span style="color:#111">(</span><span style="color:#75af00">w</span><span style="color:#111">,</span> <span style="color:#75af00">w</span><span style="color:#111">.</span><span style="color:#75af00">req</span><span style="color:#111">)</span>
</span></span></code></pre></div><p>表示<code>serverHandler</code>也实现了<code>ServeHTTP</code>接口，<code>ServeHTTP</code>方法实现如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">sh</span> <span style="color:#75af00">serverHandler</span><span style="color:#111">)</span> <span style="color:#75af00">ServeHTTP</span><span style="color:#111">(</span><span style="color:#75af00">rw</span> <span style="color:#75af00">ResponseWriter</span><span style="color:#111">,</span> <span style="color:#75af00">req</span> <span style="color:#f92672">*</span><span style="color:#75af00">Request</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">handler</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">sh</span><span style="color:#111">.</span><span style="color:#75af00">srv</span><span style="color:#111">.</span><span style="color:#75af00">Handler</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">handler</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">handler</span> <span style="color:#111">=</span> <span style="color:#75af00">DefaultServeMux</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">req</span><span style="color:#111">.</span><span style="color:#75af00">RequestURI</span> <span style="color:#f92672">==</span> <span style="color:#d88200">&#34;*&#34;</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">req</span><span style="color:#111">.</span><span style="color:#75af00">Method</span> <span style="color:#f92672">==</span> <span style="color:#d88200">&#34;OPTIONS&#34;</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">handler</span> <span style="color:#111">=</span> <span style="color:#75af00">globalOptionsHandler</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">req</span><span style="color:#111">.</span><span style="color:#75af00">URL</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">strings</span><span style="color:#111">.</span><span style="color:#75af00">Contains</span><span style="color:#111">(</span><span style="color:#75af00">req</span><span style="color:#111">.</span><span style="color:#75af00">URL</span><span style="color:#111">.</span><span style="color:#75af00">RawQuery</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;;&#34;</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">var</span> <span style="color:#75af00">allowQuerySemicolonsInUse</span> <span style="color:#00a8c8">int32</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">req</span> <span style="color:#111">=</span> <span style="color:#75af00">req</span><span style="color:#111">.</span><span style="color:#75af00">WithContext</span><span style="color:#111">(</span><span style="color:#75af00">context</span><span style="color:#111">.</span><span style="color:#75af00">WithValue</span><span style="color:#111">(</span><span style="color:#75af00">req</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">(),</span> <span style="color:#75af00">silenceSemWarnContextKey</span><span style="color:#111">,</span> <span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75af00">atomic</span><span style="color:#111">.</span><span style="color:#75af00">StoreInt32</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">allowQuerySemicolonsInUse</span><span style="color:#111">,</span> <span style="color:#ae81ff">1</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}))</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">defer</span> <span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">if</span> <span style="color:#75af00">atomic</span><span style="color:#111">.</span><span style="color:#75af00">LoadInt32</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">allowQuerySemicolonsInUse</span><span style="color:#111">)</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75af00">sh</span><span style="color:#111">.</span><span style="color:#75af00">srv</span><span style="color:#111">.</span><span style="color:#75af00">logf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;http: URL query contains semicolon, which is no longer a supported separator; parts of the query may be stripped when parsed; see golang.org/issue/25192&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">handler</span><span style="color:#111">.</span><span style="color:#75af00">ServeHTTP</span><span style="color:#111">(</span><span style="color:#75af00">rw</span><span style="color:#111">,</span> <span style="color:#75af00">req</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>在这里如果<code>handler</code>为空（这个<code>handler</code>就可以理解为是我们自定义的路由器），就会使用系统默认的<code>DefaultServeMux</code>，代码的最后调用了<code>DefaultServeMux</code>的<code>ServeHTTP()</code></p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">mux</span> <span style="color:#f92672">*</span><span style="color:#75af00">ServeMux</span><span style="color:#111">)</span> <span style="color:#75af00">ServeHTTP</span><span style="color:#111">(</span><span style="color:#75af00">w</span> <span style="color:#75af00">ResponseWriter</span><span style="color:#111">,</span> <span style="color:#75af00">r</span> <span style="color:#f92672">*</span><span style="color:#75af00">Request</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">RequestURI</span> <span style="color:#f92672">==</span> <span style="color:#d88200">&#34;*&#34;</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">ProtoAtLeast</span><span style="color:#111">(</span><span style="color:#ae81ff">1</span><span style="color:#111">,</span> <span style="color:#ae81ff">1</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75af00">w</span><span style="color:#111">.</span><span style="color:#75af00">Header</span><span style="color:#111">().</span><span style="color:#75af00">Set</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Connection&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;close&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">w</span><span style="color:#111">.</span><span style="color:#75af00">WriteHeader</span><span style="color:#111">(</span><span style="color:#75af00">StatusBadRequest</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">h</span><span style="color:#111">,</span> <span style="color:#75af00">_</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">Handler</span><span style="color:#111">(</span><span style="color:#75af00">r</span><span style="color:#111">)</span>  <span style="color:#75715e">//这里返回的h是Handler接口对象</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">ServeHTTP</span><span style="color:#111">(</span><span style="color:#75af00">w</span><span style="color:#111">,</span> <span style="color:#75af00">r</span><span style="color:#111">)</span>  <span style="color:#75715e">//调用Handler接口对象的ServeHTTP方法实际上就调用了我们定义的sayHello方法</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">mux</span> <span style="color:#f92672">*</span><span style="color:#75af00">ServeMux</span><span style="color:#111">)</span> <span style="color:#75af00">Handler</span><span style="color:#111">(</span><span style="color:#75af00">r</span> <span style="color:#f92672">*</span><span style="color:#75af00">Request</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#75af00">h</span> <span style="color:#75af00">Handler</span><span style="color:#111">,</span> <span style="color:#75af00">pattern</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// CONNECT requests are not canonicalized.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">Method</span> <span style="color:#f92672">==</span> <span style="color:#d88200">&#34;CONNECT&#34;</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// If r.URL.Path is /tree and its handler is not registered,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// the /tree -&gt; /tree/ redirect applies to CONNECT requests</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// but the path canonicalization does not.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#75af00">u</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">redirectToPathSlash</span><span style="color:#111">(</span><span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">URL</span><span style="color:#111">.</span><span style="color:#75af00">Host</span><span style="color:#111">,</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">URL</span><span style="color:#111">.</span><span style="color:#75af00">Path</span><span style="color:#111">,</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">URL</span><span style="color:#111">);</span> <span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">return</span> <span style="color:#75af00">RedirectHandler</span><span style="color:#111">(</span><span style="color:#75af00">u</span><span style="color:#111">.</span><span style="color:#75af00">String</span><span style="color:#111">(),</span> <span style="color:#75af00">StatusMovedPermanently</span><span style="color:#111">),</span> <span style="color:#75af00">u</span><span style="color:#111">.</span><span style="color:#75af00">Path</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">handler</span><span style="color:#111">(</span><span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">Host</span><span style="color:#111">,</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">URL</span><span style="color:#111">.</span><span style="color:#75af00">Path</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// All other requests have any port stripped and path cleaned</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// before passing to mux.handler.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">host</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">stripHostPort</span><span style="color:#111">(</span><span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">Host</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">path</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">cleanPath</span><span style="color:#111">(</span><span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">URL</span><span style="color:#111">.</span><span style="color:#75af00">Path</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// If the given path is /tree and its handler is not registered,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// redirect for /tree/.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">u</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">redirectToPathSlash</span><span style="color:#111">(</span><span style="color:#75af00">host</span><span style="color:#111">,</span> <span style="color:#75af00">path</span><span style="color:#111">,</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">URL</span><span style="color:#111">);</span> <span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">RedirectHandler</span><span style="color:#111">(</span><span style="color:#75af00">u</span><span style="color:#111">.</span><span style="color:#75af00">String</span><span style="color:#111">(),</span> <span style="color:#75af00">StatusMovedPermanently</span><span style="color:#111">),</span> <span style="color:#75af00">u</span><span style="color:#111">.</span><span style="color:#75af00">Path</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">path</span> <span style="color:#f92672">!=</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">URL</span><span style="color:#111">.</span><span style="color:#75af00">Path</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">pattern</span> <span style="color:#111">=</span> <span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">handler</span><span style="color:#111">(</span><span style="color:#75af00">host</span><span style="color:#111">,</span> <span style="color:#75af00">path</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">u</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">url</span><span style="color:#111">.</span><span style="color:#75af00">URL</span><span style="color:#111">{</span><span style="color:#75af00">Path</span><span style="color:#111">:</span> <span style="color:#75af00">path</span><span style="color:#111">,</span> <span style="color:#75af00">RawQuery</span><span style="color:#111">:</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">URL</span><span style="color:#111">.</span><span style="color:#75af00">RawQuery</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">RedirectHandler</span><span style="color:#111">(</span><span style="color:#75af00">u</span><span style="color:#111">.</span><span style="color:#75af00">String</span><span style="color:#111">(),</span> <span style="color:#75af00">StatusMovedPermanently</span><span style="color:#111">),</span> <span style="color:#75af00">pattern</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">handler</span><span style="color:#111">(</span><span style="color:#75af00">host</span><span style="color:#111">,</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">URL</span><span style="color:#111">.</span><span style="color:#75af00">Path</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">mux</span> <span style="color:#f92672">*</span><span style="color:#75af00">ServeMux</span><span style="color:#111">)</span> <span style="color:#75af00">handler</span><span style="color:#111">(</span><span style="color:#75af00">host</span><span style="color:#111">,</span> <span style="color:#75af00">path</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#75af00">h</span> <span style="color:#75af00">Handler</span><span style="color:#111">,</span> <span style="color:#75af00">pattern</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">RLock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">defer</span> <span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">mu</span><span style="color:#111">.</span><span style="color:#75af00">RUnlock</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Host-specific pattern takes precedence over generic ones</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">hosts</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">h</span><span style="color:#111">,</span> <span style="color:#75af00">pattern</span> <span style="color:#111">=</span> <span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">match</span><span style="color:#111">(</span><span style="color:#75af00">host</span> <span style="color:#f92672">+</span> <span style="color:#75af00">path</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">h</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">h</span><span style="color:#111">,</span> <span style="color:#75af00">pattern</span> <span style="color:#111">=</span> <span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">match</span><span style="color:#111">(</span><span style="color:#75af00">path</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">h</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">h</span><span style="color:#111">,</span> <span style="color:#75af00">pattern</span> <span style="color:#111">=</span> <span style="color:#75af00">NotFoundHandler</span><span style="color:#111">(),</span> <span style="color:#d88200">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">mux</span> <span style="color:#f92672">*</span><span style="color:#75af00">ServeMux</span><span style="color:#111">)</span> <span style="color:#75af00">match</span><span style="color:#111">(</span><span style="color:#75af00">path</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#111">(</span><span style="color:#75af00">h</span> <span style="color:#75af00">Handler</span><span style="color:#111">,</span> <span style="color:#75af00">pattern</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Check for exact match first.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">v</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">m</span><span style="color:#111">[</span><span style="color:#75af00">path</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#75af00">v</span><span style="color:#111">.</span><span style="color:#75af00">h</span><span style="color:#111">,</span> <span style="color:#75af00">v</span><span style="color:#111">.</span><span style="color:#75af00">pattern</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Check for longest valid match.  mux.es contains all patterns</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// that end in / sorted from longest to shortest.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">e</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">es</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#75af00">strings</span><span style="color:#111">.</span><span style="color:#75af00">HasPrefix</span><span style="color:#111">(</span><span style="color:#75af00">path</span><span style="color:#111">,</span> <span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">pattern</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">return</span> <span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">h</span><span style="color:#111">,</span> <span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">pattern</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>它会根据用户请求的<code>URL</code>到路由器里面存储的<code>map</code>中匹配，匹配成功就会返回存储的<code>handler</code>，调用这个<code>handler</code>的<code>ServeHTTP()</code>就可以执行到相应的处理方法了，这个处理方法实际上就是我们刚开始定义的<code>sayHello()</code>，只不过这个<code>sayHello()</code>被<code>HandlerFunc</code>又包了一层，因为<code>HandlerFunc</code>实现了<code>ServeHTTP</code>接口，所以在调用<code>HandlerFunc</code>对象的<code>ServeHTTP()</code>时，实际上在<code>ServeHTTP ()</code>的内部调用了我们的<code>sayHello()</code>。</p>
<h2 id="总结">总结</h2>
<ol>
<li>调用<code>http.ListenAndServe(&quot;:9090&quot;,nil)</code></li>
<li>实例化<code>server</code></li>
<li>调用<code>server</code>的<code>ListenAndServe()</code></li>
<li>调用<code>server</code>的<code>Serve</code>方法，开启<code>for</code>循环，在循环中Accept请求</li>
<li>对每一个请求实例化一个<code>Conn</code>，并且开启一个<code>goroutine</code>为这个请求进行服务<code>go c.serve()</code></li>
<li>读取每个请求的内容<code>c.readRequest()</code></li>
<li>调用<code>serverHandler</code>的<code>ServeHTTP()</code>，如果<code>handler</code>为空，就把<code>handler</code>设置为系统默认的路由器<code>DefaultServeMux</code></li>
<li>调用<code>handler</code>的<code>ServeHTTP()</code> =&gt;实际上是调用了<code>DefaultServeMux</code>的<code>ServeHTTP()</code></li>
<li>在<code>ServeHTTP()</code>中会调用路由对应处理<code>handler</code></li>
<li>在路由对应处理<code>handler</code>中会执行<code>sayHello()</code></li>
</ol>
<p>有一个需要注意的点： <code>DefaultServeMux</code>和路由对应的处理方法<code>handler</code>都实现了<code>ServeHTTP</code>接口，他们俩都有<code>ServeHTTP</code>方法，但是方法要达到的目的不同，在<code>DefaultServeMux</code>的<code>ServeHttp()</code>里会执行路由对应的处理<code>handler</code>的<code>ServeHttp()</code>。</p>
<h2 id="自定义个简单的路由">自定义个简单的路由</h2>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">mux</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d88200">&#34;net/http&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d88200">&#34;strings&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">muxEntry</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">h</span> <span style="color:#75af00">TesthandleFunc</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">TesthandleFunc</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">ResponseWriter</span><span style="color:#111">,</span> <span style="color:#f92672">*</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Request</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">TestHandler</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">routes</span> <span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#00a8c8">string</span><span style="color:#111">]</span><span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#00a8c8">string</span><span style="color:#111">]</span><span style="color:#75af00">muxEntry</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">h</span> <span style="color:#f92672">*</span><span style="color:#75af00">TestHandler</span><span style="color:#111">)</span> <span style="color:#75af00">ServeHTTP</span><span style="color:#111">(</span><span style="color:#75af00">w</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">ResponseWriter</span><span style="color:#111">,</span> <span style="color:#75af00">r</span> <span style="color:#f92672">*</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Request</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">method</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">strings</span><span style="color:#111">.</span><span style="color:#75af00">ToUpper</span><span style="color:#111">(</span><span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">Method</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">path</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">URL</span><span style="color:#111">.</span><span style="color:#75af00">Path</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">route</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">routes</span><span style="color:#111">[</span><span style="color:#75af00">method</span><span style="color:#111">];</span> <span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#75af00">entry</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">route</span><span style="color:#111">[</span><span style="color:#75af00">path</span><span style="color:#111">];</span> <span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75af00">entry</span><span style="color:#111">.</span><span style="color:#75af00">h</span><span style="color:#111">(</span><span style="color:#75af00">w</span><span style="color:#111">,</span> <span style="color:#75af00">r</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">w</span><span style="color:#111">.</span><span style="color:#75af00">WriteHeader</span><span style="color:#111">(</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">StatusNotFound</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">Newhandler</span><span style="color:#111">()</span> <span style="color:#f92672">*</span><span style="color:#75af00">TestHandler</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">TestHandler</span><span style="color:#111">{</span><span style="color:#75af00">routes</span><span style="color:#111">:</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#00a8c8">string</span><span style="color:#111">]</span><span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#00a8c8">string</span><span style="color:#111">]</span><span style="color:#75af00">muxEntry</span><span style="color:#111">)}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">h</span> <span style="color:#f92672">*</span><span style="color:#75af00">TestHandler</span><span style="color:#111">)</span> <span style="color:#75af00">Handle</span><span style="color:#111">(</span><span style="color:#75af00">method</span><span style="color:#111">,</span> <span style="color:#75af00">path</span> <span style="color:#00a8c8">string</span><span style="color:#111">,</span> <span style="color:#75af00">handler</span> <span style="color:#75af00">TesthandleFunc</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">method</span> <span style="color:#111">=</span> <span style="color:#75af00">strings</span><span style="color:#111">.</span><span style="color:#75af00">ToUpper</span><span style="color:#111">(</span><span style="color:#75af00">method</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">routes</span><span style="color:#111">[</span><span style="color:#75af00">method</span><span style="color:#111">];</span> <span style="color:#111">!</span><span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">routes</span><span style="color:#111">[</span><span style="color:#75af00">method</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#00a8c8">string</span><span style="color:#111">]</span><span style="color:#75af00">muxEntry</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">routes</span><span style="color:#111">[</span><span style="color:#75af00">method</span><span style="color:#111">][</span><span style="color:#75af00">path</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#75af00">muxEntry</span><span style="color:#111">{</span><span style="color:#75af00">handler</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d88200">&#34;net/http&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d88200">&#34;study/mux&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">handler</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">mux</span><span style="color:#111">.</span><span style="color:#75af00">Newhandler</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">handler</span><span style="color:#111">.</span><span style="color:#75af00">Handle</span><span style="color:#111">(</span><span style="color:#d88200">&#34;GET&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;/hello&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">rw</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">ResponseWriter</span><span style="color:#111">,</span> <span style="color:#75af00">r</span> <span style="color:#f92672">*</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Request</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">rw</span><span style="color:#111">.</span><span style="color:#75af00">Write</span><span style="color:#111">([]</span><span style="color:#111">byte</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Hello World&#34;</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">handler</span><span style="color:#111">.</span><span style="color:#75af00">Handle</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Post&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;/hello/world&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">rw</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">ResponseWriter</span><span style="color:#111">,</span> <span style="color:#75af00">r</span> <span style="color:#f92672">*</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Request</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Fprintln</span><span style="color:#111">(</span><span style="color:#75af00">rw</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;你好&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">ListenAndServe</span><span style="color:#111">(</span><span style="color:#d88200">&#34;:9002&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">handler</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>自定义context</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">router</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d88200">&#34;encoding/json&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d88200">&#34;net/http&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d88200">&#34;strings&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Context</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">w</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">ResponseWriter</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">r</span> <span style="color:#f92672">*</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Request</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#75af00">Json</span><span style="color:#111">(</span><span style="color:#75af00">code</span> <span style="color:#00a8c8">int</span><span style="color:#111">,</span> <span style="color:#75af00">v</span> <span style="color:#00a8c8">interface</span><span style="color:#111">{})</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">w</span><span style="color:#111">.</span><span style="color:#75af00">Header</span><span style="color:#111">().</span><span style="color:#75af00">Set</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Content-Type&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;application/json&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">w</span><span style="color:#111">.</span><span style="color:#75af00">WriteHeader</span><span style="color:#111">(</span><span style="color:#75af00">code</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">s</span><span style="color:#111">,</span> <span style="color:#75af00">_</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">json</span><span style="color:#111">.</span><span style="color:#75af00">Marshal</span><span style="color:#111">(</span><span style="color:#75af00">v</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">w</span><span style="color:#111">.</span><span style="color:#75af00">Write</span><span style="color:#111">(</span><span style="color:#75af00">s</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Routerfunc</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">Context</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">RouterHandler</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">routes</span> <span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#00a8c8">string</span><span style="color:#111">]</span><span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#00a8c8">string</span><span style="color:#111">]</span><span style="color:#75af00">Routerfunc</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">NewRouterHandler</span><span style="color:#111">()</span> <span style="color:#f92672">*</span><span style="color:#75af00">RouterHandler</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">RouterHandler</span><span style="color:#111">{</span><span style="color:#75af00">routes</span><span style="color:#111">:</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#00a8c8">string</span><span style="color:#111">]</span><span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#00a8c8">string</span><span style="color:#111">]</span><span style="color:#75af00">Routerfunc</span><span style="color:#111">)}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">h</span> <span style="color:#f92672">*</span><span style="color:#75af00">RouterHandler</span><span style="color:#111">)</span> <span style="color:#75af00">ServeHTTP</span><span style="color:#111">(</span><span style="color:#75af00">w</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">ResponseWriter</span><span style="color:#111">,</span> <span style="color:#75af00">r</span> <span style="color:#f92672">*</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Request</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">method</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">strings</span><span style="color:#111">.</span><span style="color:#75af00">ToUpper</span><span style="color:#111">(</span><span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">Method</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">path</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">URL</span><span style="color:#111">.</span><span style="color:#75af00">Path</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">c</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">Context</span><span style="color:#111">{</span><span style="color:#75af00">w</span><span style="color:#111">:</span> <span style="color:#75af00">w</span><span style="color:#111">,</span> <span style="color:#75af00">r</span><span style="color:#111">:</span> <span style="color:#75af00">r</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">route</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">routes</span><span style="color:#111">[</span><span style="color:#75af00">method</span><span style="color:#111">];</span> <span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#75af00">h</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">route</span><span style="color:#111">[</span><span style="color:#75af00">path</span><span style="color:#111">];</span> <span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75af00">h</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">w</span><span style="color:#111">.</span><span style="color:#75af00">WriteHeader</span><span style="color:#111">(</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">StatusNotFound</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">h</span> <span style="color:#f92672">*</span><span style="color:#75af00">RouterHandler</span><span style="color:#111">)</span> <span style="color:#75af00">Handle</span><span style="color:#111">(</span><span style="color:#75af00">method</span><span style="color:#111">,</span> <span style="color:#75af00">path</span> <span style="color:#00a8c8">string</span><span style="color:#111">,</span> <span style="color:#75af00">handler</span> <span style="color:#75af00">Routerfunc</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">method</span> <span style="color:#111">=</span> <span style="color:#75af00">strings</span><span style="color:#111">.</span><span style="color:#75af00">ToUpper</span><span style="color:#111">(</span><span style="color:#75af00">method</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">ok</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">routes</span><span style="color:#111">[</span><span style="color:#75af00">method</span><span style="color:#111">];</span> <span style="color:#111">!</span><span style="color:#75af00">ok</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">routes</span><span style="color:#111">[</span><span style="color:#75af00">method</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#111">make</span><span style="color:#111">(</span><span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#00a8c8">string</span><span style="color:#111">]</span><span style="color:#75af00">Routerfunc</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">h</span><span style="color:#111">.</span><span style="color:#75af00">routes</span><span style="color:#111">[</span><span style="color:#75af00">method</span><span style="color:#111">][</span><span style="color:#75af00">path</span><span style="color:#111">]</span> <span style="color:#111">=</span> <span style="color:#75af00">handler</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">r</span> <span style="color:#f92672">*</span><span style="color:#75af00">RouterHandler</span><span style="color:#111">)</span> <span style="color:#75af00">Run</span><span style="color:#111">(</span><span style="color:#75af00">addr</span> <span style="color:#00a8c8">string</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">ListenAndServe</span><span style="color:#111">(</span><span style="color:#75af00">addr</span><span style="color:#111">,</span> <span style="color:#75af00">r</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="gin">Gin</h2>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Engine</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">RouterGroup</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">pool</span>     <span style="color:#75af00">sync</span><span style="color:#111">.</span><span style="color:#75af00">Pool</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">trees</span>    <span style="color:#75af00">methodTrees</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span><span style="color:#75715e">// trie</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">RouterGroup</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">basePath</span> <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">engine</span>   <span style="color:#f92672">*</span><span style="color:#75af00">Engine</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">engine</span> <span style="color:#f92672">*</span><span style="color:#75af00">Engine</span><span style="color:#111">)</span> <span style="color:#75af00">ServeHTTP</span><span style="color:#111">(</span><span style="color:#75af00">w</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">ResponseWriter</span><span style="color:#111">,</span> <span style="color:#75af00">req</span> <span style="color:#f92672">*</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Request</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">c</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">engine</span><span style="color:#111">.</span><span style="color:#75af00">pool</span><span style="color:#111">.</span><span style="color:#75af00">Get</span><span style="color:#111">().(</span><span style="color:#f92672">*</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#75715e">// 从pool 拿出一个context</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">writermem</span><span style="color:#111">.</span><span style="color:#75af00">reset</span><span style="color:#111">(</span><span style="color:#75af00">w</span><span style="color:#111">)</span> <span style="color:#75715e">// 记录http.ResponseWriter 及 *http.Request</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">Request</span> <span style="color:#111">=</span> <span style="color:#75af00">req</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">reset</span><span style="color:#111">()</span> <span style="color:#75715e">// 重置上一个留下的值</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">engine</span><span style="color:#111">.</span><span style="color:#75af00">handleHTTPRequest</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">engine</span><span style="color:#111">.</span><span style="color:#75af00">pool</span><span style="color:#111">.</span><span style="color:#75af00">Put</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">)</span> <span style="color:#75715e">// 把用完的context放回池子</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// get: /bac</span>
</span></span></code></pre></div><p><img src="/images/6c261f0b5937d728d3763beaf08f85eea6999091.png#id=UR4F8&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;status=done&amp;style=none&amp;title=" alt=""></p>
<p>添加路由</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">group</span> <span style="color:#f92672">*</span><span style="color:#75af00">RouterGroup</span><span style="color:#111">)</span> <span style="color:#75af00">handle</span><span style="color:#111">(</span><span style="color:#75af00">httpMethod</span><span style="color:#111">,</span> <span style="color:#75af00">relativePath</span> <span style="color:#00a8c8">string</span><span style="color:#111">,</span> <span style="color:#75af00">handlers</span> <span style="color:#75af00">HandlersChain</span><span style="color:#111">)</span> <span style="color:#75af00">IRoutes</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">absolutePath</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">group</span><span style="color:#111">.</span><span style="color:#75af00">calculateAbsolutePath</span><span style="color:#111">(</span><span style="color:#75af00">relativePath</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">handlers</span> <span style="color:#111">=</span> <span style="color:#75af00">group</span><span style="color:#111">.</span><span style="color:#75af00">combineHandlers</span><span style="color:#111">(</span><span style="color:#75af00">handlers</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">group</span><span style="color:#111">.</span><span style="color:#75af00">engine</span><span style="color:#111">.</span><span style="color:#75af00">addRoute</span><span style="color:#111">(</span><span style="color:#75af00">httpMethod</span><span style="color:#111">,</span> <span style="color:#75af00">absolutePath</span><span style="color:#111">,</span> <span style="color:#75af00">handlers</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#75af00">group</span><span style="color:#111">.</span><span style="color:#75af00">returnObj</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>Context</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Context</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">Request</span>   <span style="color:#f92672">*</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">Request</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">Writer</span>    <span style="color:#75af00">ResponseWriter</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">Params</span>   <span style="color:#75af00">Params</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">handlers</span> <span style="color:#75af00">HandlersChain</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">index</span>    <span style="color:#00a8c8">int8</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">fullPath</span> <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">engine</span>       <span style="color:#f92672">*</span><span style="color:#75af00">Engine</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">params</span>       <span style="color:#f92672">*</span><span style="color:#75af00">Params</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">skippedNodes</span> <span style="color:#f92672">*</span><span style="color:#111">[]</span><span style="color:#75af00">skippedNode</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// This mutex protect Keys map</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">mu</span> <span style="color:#75af00">sync</span><span style="color:#111">.</span><span style="color:#75af00">RWMutex</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Keys is a key/value pair exclusively for the context of each request.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">Keys</span> <span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#00a8c8">string</span><span style="color:#111">]</span><span style="color:#00a8c8">interface</span><span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Errors is a list of errors attached to all the handlers/middlewares who used this context.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">Errors</span> <span style="color:#75af00">errorMsgs</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Accepted defines a list of manually accepted formats for content negotiation.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">Accepted</span> <span style="color:#111">[]</span><span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// queryCache use url.ParseQuery cached the param query result from c.Request.URL.Query()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">queryCache</span> <span style="color:#75af00">url</span><span style="color:#111">.</span><span style="color:#75af00">Values</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// formCache use url.ParseQuery cached PostForm contains the parsed form data from POST, PATCH,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// or PUT body parameters.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">formCache</span> <span style="color:#75af00">url</span><span style="color:#111">.</span><span style="color:#75af00">Values</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// SameSite allows a server to define a cookie attribute making it impossible for</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// the browser to send this cookie along with cross-site requests.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">sameSite</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">SameSite</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#75af00">Next</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">index</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">for</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">index</span> <span style="color:#111">&lt;</span> <span style="color:#111">int8</span><span style="color:#111">(</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">handlers</span><span style="color:#111">))</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">handlers</span><span style="color:#111">[</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">index</span><span style="color:#111">](</span><span style="color:#75af00">c</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">index</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">engine</span> <span style="color:#f92672">*</span><span style="color:#75af00">Engine</span><span style="color:#111">)</span> <span style="color:#75af00">handleHTTPRequest</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">httpMethod</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">Request</span><span style="color:#111">.</span><span style="color:#75af00">Method</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">rPath</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">Request</span><span style="color:#111">.</span><span style="color:#75af00">URL</span><span style="color:#111">.</span><span style="color:#75af00">Path</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">unescape</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">engine</span><span style="color:#111">.</span><span style="color:#75af00">UseRawPath</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">Request</span><span style="color:#111">.</span><span style="color:#75af00">URL</span><span style="color:#111">.</span><span style="color:#75af00">RawPath</span><span style="color:#111">)</span> <span style="color:#111">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">rPath</span> <span style="color:#111">=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">Request</span><span style="color:#111">.</span><span style="color:#75af00">URL</span><span style="color:#111">.</span><span style="color:#75af00">RawPath</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">unescape</span> <span style="color:#111">=</span> <span style="color:#75af00">engine</span><span style="color:#111">.</span><span style="color:#75af00">UnescapePathValues</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">engine</span><span style="color:#111">.</span><span style="color:#75af00">RemoveExtraSlash</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">rPath</span> <span style="color:#111">=</span> <span style="color:#75af00">cleanPath</span><span style="color:#111">(</span><span style="color:#75af00">rPath</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Find root of the tree for the given HTTP method</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">t</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">engine</span><span style="color:#111">.</span><span style="color:#75af00">trees</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">for</span> <span style="color:#75af00">i</span><span style="color:#111">,</span> <span style="color:#75af00">tl</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">t</span><span style="color:#111">);</span> <span style="color:#75af00">i</span> <span style="color:#111">&lt;</span> <span style="color:#75af00">tl</span><span style="color:#111">;</span> <span style="color:#75af00">i</span><span style="color:#f92672">++</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#75af00">t</span><span style="color:#111">[</span><span style="color:#75af00">i</span><span style="color:#111">].</span><span style="color:#75af00">method</span> <span style="color:#f92672">!=</span> <span style="color:#75af00">httpMethod</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">continue</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">root</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">t</span><span style="color:#111">[</span><span style="color:#75af00">i</span><span style="color:#111">].</span><span style="color:#75af00">root</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Find route in tree</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75af00">value</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">root</span><span style="color:#111">.</span><span style="color:#75af00">getValue</span><span style="color:#111">(</span><span style="color:#75af00">rPath</span><span style="color:#111">,</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">params</span><span style="color:#111">,</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">skippedNodes</span><span style="color:#111">,</span> <span style="color:#75af00">unescape</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#75af00">value</span><span style="color:#111">.</span><span style="color:#75af00">params</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">Params</span> <span style="color:#111">=</span> <span style="color:#f92672">*</span><span style="color:#75af00">value</span><span style="color:#111">.</span><span style="color:#75af00">params</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#75af00">value</span><span style="color:#111">.</span><span style="color:#75af00">handlers</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">handlers</span> <span style="color:#111">=</span> <span style="color:#75af00">value</span><span style="color:#111">.</span><span style="color:#75af00">handlers</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">fullPath</span> <span style="color:#111">=</span> <span style="color:#75af00">value</span><span style="color:#111">.</span><span style="color:#75af00">fullPath</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">Next</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">writermem</span><span style="color:#111">.</span><span style="color:#75af00">WriteHeaderNow</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#75af00">httpMethod</span> <span style="color:#f92672">!=</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">MethodConnect</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">rPath</span> <span style="color:#f92672">!=</span> <span style="color:#d88200">&#34;/&#34;</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">if</span> <span style="color:#75af00">value</span><span style="color:#111">.</span><span style="color:#75af00">tsr</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">engine</span><span style="color:#111">.</span><span style="color:#75af00">RedirectTrailingSlash</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75af00">redirectTrailingSlash</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">if</span> <span style="color:#75af00">engine</span><span style="color:#111">.</span><span style="color:#75af00">RedirectFixedPath</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#75af00">redirectFixedPath</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">,</span> <span style="color:#75af00">root</span><span style="color:#111">,</span> <span style="color:#75af00">engine</span><span style="color:#111">.</span><span style="color:#75af00">RedirectFixedPath</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">break</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">if</span> <span style="color:#75af00">engine</span><span style="color:#111">.</span><span style="color:#75af00">HandleMethodNotAllowed</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">tree</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">engine</span><span style="color:#111">.</span><span style="color:#75af00">trees</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">if</span> <span style="color:#75af00">tree</span><span style="color:#111">.</span><span style="color:#75af00">method</span> <span style="color:#f92672">==</span> <span style="color:#75af00">httpMethod</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#00a8c8">continue</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">if</span> <span style="color:#75af00">value</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">tree</span><span style="color:#111">.</span><span style="color:#75af00">root</span><span style="color:#111">.</span><span style="color:#75af00">getValue</span><span style="color:#111">(</span><span style="color:#75af00">rPath</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span><span style="color:#111">,</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">skippedNodes</span><span style="color:#111">,</span> <span style="color:#75af00">unescape</span><span style="color:#111">);</span> <span style="color:#75af00">value</span><span style="color:#111">.</span><span style="color:#75af00">handlers</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">handlers</span> <span style="color:#111">=</span> <span style="color:#75af00">engine</span><span style="color:#111">.</span><span style="color:#75af00">allNoMethod</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75af00">serveError</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">,</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">StatusMethodNotAllowed</span><span style="color:#111">,</span> <span style="color:#75af00">default405Body</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">handlers</span> <span style="color:#111">=</span> <span style="color:#75af00">engine</span><span style="color:#111">.</span><span style="color:#75af00">allNoRoute</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">serveError</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">,</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">StatusNotFound</span><span style="color:#111">,</span> <span style="color:#75af00">default404Body</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div>]]></content:encoded><category>go</category><category>go</category><category>gin</category></item><item><title>Gin框架介绍及使用</title><link>https://daemon365.dev/post/go/introduction_and_use_of_gin_framework/</link><pubDate>Sun, 30 Jun 2019 00:00:00 +0800</pubDate><guid>https://daemon365.dev/post/go/introduction_and_use_of_gin_framework/</guid><description>&lt;h2 id="gin框架介绍"&gt;Gin框架介绍&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;基于&lt;a href="https://github.com/julienschmidt/httprouter"&gt;httprouter&lt;/a&gt;开发的Web框架。&lt;/li&gt;
&lt;li&gt;&lt;a href="https://gin-gonic.com/zh-cn/docs/"&gt;中文文档&lt;/a&gt;，齐全。&lt;/li&gt;
&lt;li&gt;简单易用的轻量级框架。&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="gin框架安装"&gt;Gin框架安装&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;go get -u github.com/gin-gonic/gin
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;strong&gt;实例:&lt;/strong&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;package&lt;/span&gt; &lt;span style="color:#75af00"&gt;main&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;import&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;fmt&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;github.com/gin-gonic/gin&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;main&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;r&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;gin&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Default&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// 创建一个默认的路由引擎&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// 也可以用gin.New() gin.Default()多用了日志和panic的recover中间件&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;r&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;GET&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;/helloworld&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;func&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;c&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;gin&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Context&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;c&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;JSON&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;200&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;gin&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;H&lt;/span&gt;&lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// c.JSON：返回JSON格式的数据&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;msg&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;:&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;Hello world!&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;})&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;})&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;r&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Run&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;127.0.0.1:8001&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// 启动HTTP服务，默认在127.0.0.1:8001启动服务&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;!=&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Println&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;run gin field&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;img src="https://daemon365.dev/images/a78c08f7-e35f-41f2-bc49-9388ef405408.png" alt=""&gt;&lt;/p&gt;
&lt;h2 id="restful-api"&gt;RESTful API&lt;/h2&gt;
&lt;p&gt;REST与技术无关，代表的是一种软件架构风格，REST是Representational State Transfer的简称，中文翻译为“表征状态转移”或“表现层状态转化”。&lt;/p&gt;
&lt;p&gt;简单来说，REST的含义就是客户端与Web服务器之间进行交互的时候，使用HTTP协议中的4个请求方法代表不同的动作。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;GET用来获取资源&lt;/li&gt;
&lt;li&gt;POST用来新建资源&lt;/li&gt;
&lt;li&gt;PUT用来更新资源&lt;/li&gt;
&lt;li&gt;DELETE用来删除资源。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;只要API程序遵循了REST风格，那就可以称其为RESTful API。目前在前后端分离的架构中，前后端基本都是通过RESTful API来进行交互。&lt;/p&gt;
&lt;p&gt;例如，我们现在要编写一个管理书籍的系统，我们可以查询对一本书进行查询、创建、更新和删除等操作，我们在编写程序的时候就要设计客户端浏览器与我们Web服务端交互的方式和路径。按照经验我们通常会设计成如下模式：&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;请求方法&lt;/th&gt;
&lt;th&gt;URL&lt;/th&gt;
&lt;th&gt;含义&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;GET&lt;/td&gt;
&lt;td&gt;/book&lt;/td&gt;
&lt;td&gt;查询书籍信息&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;POST&lt;/td&gt;
&lt;td&gt;/create_book&lt;/td&gt;
&lt;td&gt;创建书籍记录&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;POST&lt;/td&gt;
&lt;td&gt;/update_book&lt;/td&gt;
&lt;td&gt;更新书籍信息&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;POST&lt;/td&gt;
&lt;td&gt;/delete_book&lt;/td&gt;
&lt;td&gt;删除书籍信息&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;同样的需求我们按照RESTful API设计如下：&lt;/p&gt;</description><content:encoded><![CDATA[<h2 id="gin框架介绍">Gin框架介绍</h2>
<ul>
<li>基于<a href="https://github.com/julienschmidt/httprouter">httprouter</a>开发的Web框架。</li>
<li><a href="https://gin-gonic.com/zh-cn/docs/">中文文档</a>，齐全。</li>
<li>简单易用的轻量级框架。</li>
</ul>
<h2 id="gin框架安装">Gin框架安装</h2>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>go get -u github.com/gin-gonic/gin
</span></span></code></pre></div><p><strong>实例:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;github.com/gin-gonic/gin&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Default</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 创建一个默认的路由引擎</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 也可以用gin.New() gin.Default()多用了日志和panic的recover中间件</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">GET</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/helloworld&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">JSON</span><span style="color:#111">(</span><span style="color:#ae81ff">200</span><span style="color:#111">,</span> <span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">H</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// c.JSON：返回JSON格式的数据</span>
</span></span><span style="display:flex;"><span>			<span style="color:#d88200">&#34;msg&#34;</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;Hello world!&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">Run</span><span style="color:#111">(</span><span style="color:#d88200">&#34;127.0.0.1:8001&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 启动HTTP服务，默认在127.0.0.1:8001启动服务</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;run gin field&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p><img src="/images/a78c08f7-e35f-41f2-bc49-9388ef405408.png" alt=""></p>
<h2 id="restful-api">RESTful API</h2>
<p>REST与技术无关，代表的是一种软件架构风格，REST是Representational State Transfer的简称，中文翻译为“表征状态转移”或“表现层状态转化”。</p>
<p>简单来说，REST的含义就是客户端与Web服务器之间进行交互的时候，使用HTTP协议中的4个请求方法代表不同的动作。</p>
<ul>
<li>GET用来获取资源</li>
<li>POST用来新建资源</li>
<li>PUT用来更新资源</li>
<li>DELETE用来删除资源。</li>
</ul>
<p>只要API程序遵循了REST风格，那就可以称其为RESTful API。目前在前后端分离的架构中，前后端基本都是通过RESTful API来进行交互。</p>
<p>例如，我们现在要编写一个管理书籍的系统，我们可以查询对一本书进行查询、创建、更新和删除等操作，我们在编写程序的时候就要设计客户端浏览器与我们Web服务端交互的方式和路径。按照经验我们通常会设计成如下模式：</p>
<table>
  <thead>
      <tr>
          <th>请求方法</th>
          <th>URL</th>
          <th>含义</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>GET</td>
          <td>/book</td>
          <td>查询书籍信息</td>
      </tr>
      <tr>
          <td>POST</td>
          <td>/create_book</td>
          <td>创建书籍记录</td>
      </tr>
      <tr>
          <td>POST</td>
          <td>/update_book</td>
          <td>更新书籍信息</td>
      </tr>
      <tr>
          <td>POST</td>
          <td>/delete_book</td>
          <td>删除书籍信息</td>
      </tr>
  </tbody>
</table>
<p>同样的需求我们按照RESTful API设计如下：</p>
<table>
  <thead>
      <tr>
          <th>请求方法</th>
          <th>URL</th>
          <th>含义</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>GET</td>
          <td>/book</td>
          <td>查询书籍信息</td>
      </tr>
      <tr>
          <td>POST</td>
          <td>/book</td>
          <td>创建书籍记录</td>
      </tr>
      <tr>
          <td>PUT</td>
          <td>/book</td>
          <td>更新书籍信息</td>
      </tr>
      <tr>
          <td>DELETE</td>
          <td>/book</td>
          <td>删除书籍信息</td>
      </tr>
  </tbody>
</table>
<p>Gin框架支持开发RESTful API的开发。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Default</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">GET</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/book&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">JSON</span><span style="color:#111">(</span><span style="color:#ae81ff">200</span><span style="color:#111">,</span> <span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">H</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#d88200">&#34;message&#34;</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;GET&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">POST</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/book&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">JSON</span><span style="color:#111">(</span><span style="color:#ae81ff">200</span><span style="color:#111">,</span> <span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">H</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#d88200">&#34;message&#34;</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;POST&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">PUT</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/book&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">JSON</span><span style="color:#111">(</span><span style="color:#ae81ff">200</span><span style="color:#111">,</span> <span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">H</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#d88200">&#34;message&#34;</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;PUT&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">DELETE</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/book&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">JSON</span><span style="color:#111">(</span><span style="color:#ae81ff">200</span><span style="color:#111">,</span> <span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">H</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#d88200">&#34;message&#34;</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;DELETE&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>开发RESTful API的时候我们通常使用<a href="https://www.getpostman.com/">Postman</a>来作为客户端的测试工具。</p>
<h2 id="gin渲染">Gin渲染</h2>
<h3 id="html渲染">HTML渲染</h3>
<p>我们首先定义一个存放模板文件的templates文件夹，然后在其内部按照业务分别定义一个posts文件夹和一个users文件夹。posts/index.html文件的内容如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#111">{{</span><span style="color:#75af00">define</span> <span style="color:#d88200">&#34;posts/index.html&#34;</span><span style="color:#111">}}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">posts</span><span style="color:#f92672">/</span><span style="color:#75af00">index</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">{{.</span><span style="color:#75af00">title</span><span style="color:#111">}}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">{{</span><span style="color:#75af00">end</span><span style="color:#111">}}</span>
</span></span></code></pre></div><p>users/index.html文件的内容如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#111">{{</span><span style="color:#75af00">define</span> <span style="color:#d88200">&#34;users/index.html&#34;</span><span style="color:#111">}}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">users</span><span style="color:#f92672">/</span><span style="color:#75af00">index</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">{{.</span><span style="color:#75af00">title</span><span style="color:#111">}}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">{{</span><span style="color:#75af00">end</span><span style="color:#111">}}</span>
</span></span></code></pre></div><p>Gin框架中使用LoadHTMLGlob()或者LoadHTMLFiles()方法进行HTML模板渲染。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Default</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">LoadHTMLGlob</span><span style="color:#111">(</span><span style="color:#d88200">&#34;templates/**/*&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//r.LoadHTMLFiles(&#34;templates/posts/index.html&#34;, &#34;templates/users/index.html&#34;)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">GET</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/posts/index&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">HTML</span><span style="color:#111">(</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">StatusOK</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;posts/index.html&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">H</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#d88200">&#34;title&#34;</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;posts/index&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">GET</span><span style="color:#111">(</span><span style="color:#d88200">&#34;users/index&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">HTML</span><span style="color:#111">(</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">StatusOK</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;users/index.html&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">H</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#d88200">&#34;title&#34;</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;users/index&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">Run</span><span style="color:#111">(</span><span style="color:#d88200">&#34;:8080&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="静态文件处理">静态文件处理</h3>
<p>当我们渲染的HTML文件中引用了静态文件时，我们只需要按照以下方式在渲染页面前调用gin.Static方法即可。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Default</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">Static</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/static&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;./static&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">LoadHTMLGlob</span><span style="color:#111">(</span><span style="color:#d88200">&#34;templates/**/*&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">Run</span><span style="color:#111">(</span><span style="color:#d88200">&#34;:8080&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="补充文件路径处理">补充文件路径处理</h3>
<p>关于模板文件和静态文件的路径，我们需要根据公司/项目的要求进行设置。可以使用下面的函数获取当前执行程序的路径。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">getCurrentPath</span><span style="color:#111">()</span> <span style="color:#00a8c8">string</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">ex</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">os</span><span style="color:#111">.</span><span style="color:#75af00">Executable</span><span style="color:#111">();</span> <span style="color:#75af00">err</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">filepath</span><span style="color:#111">.</span><span style="color:#75af00">Dir</span><span style="color:#111">(</span><span style="color:#75af00">ex</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#d88200">&#34;./&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="json渲染">JSON渲染</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Default</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// gin.H 是map[string]interface{}的缩写</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">GET</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/someJSON&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 方式一：自己拼接JSON</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">JSON</span><span style="color:#111">(</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">StatusOK</span><span style="color:#111">,</span> <span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">H</span><span style="color:#111">{</span><span style="color:#d88200">&#34;message&#34;</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;Hello world!&#34;</span><span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">GET</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/moreJSON&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 方法二：使用结构体</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">var</span> <span style="color:#75af00">msg</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">Name</span>    <span style="color:#00a8c8">string</span> <span style="color:#d88200">`json:&#34;user&#34;`</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">Message</span> <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">Age</span>     <span style="color:#00a8c8">int</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">msg</span><span style="color:#111">.</span><span style="color:#75af00">Name</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;zhy&#34;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">msg</span><span style="color:#111">.</span><span style="color:#75af00">Message</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;Hello world!&#34;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">msg</span><span style="color:#111">.</span><span style="color:#75af00">Age</span> <span style="color:#111">=</span> <span style="color:#ae81ff">18</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">JSON</span><span style="color:#111">(</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">StatusOK</span><span style="color:#111">,</span> <span style="color:#75af00">msg</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">Run</span><span style="color:#111">(</span><span style="color:#d88200">&#34;:8080&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="xml渲染">XML渲染</h3>
<p>注意需要使用具名的结构体类型。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Default</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// gin.H 是map[string]interface{}的缩写</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">GET</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/someXML&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 方式一：自己拼接JSON</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">XML</span><span style="color:#111">(</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">StatusOK</span><span style="color:#111">,</span> <span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">H</span><span style="color:#111">{</span><span style="color:#d88200">&#34;message&#34;</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;Hello world!&#34;</span><span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">GET</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/moreXML&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 方法二：使用结构体</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">type</span> <span style="color:#75af00">MessageRecord</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">Name</span>    <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">Message</span> <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">Age</span>     <span style="color:#00a8c8">int</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">var</span> <span style="color:#75af00">msg</span> <span style="color:#75af00">MessageRecord</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">msg</span><span style="color:#111">.</span><span style="color:#75af00">Name</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;小王子&#34;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">msg</span><span style="color:#111">.</span><span style="color:#75af00">Message</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;Hello world!&#34;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">msg</span><span style="color:#111">.</span><span style="color:#75af00">Age</span> <span style="color:#111">=</span> <span style="color:#ae81ff">18</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">XML</span><span style="color:#111">(</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">StatusOK</span><span style="color:#111">,</span> <span style="color:#75af00">msg</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">Run</span><span style="color:#111">(</span><span style="color:#d88200">&#34;:8080&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="ymal渲染">YMAL渲染</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">GET</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/someYAML&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">YAML</span><span style="color:#111">(</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">StatusOK</span><span style="color:#111">,</span> <span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">H</span><span style="color:#111">{</span><span style="color:#d88200">&#34;message&#34;</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;ok&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;status&#34;</span><span style="color:#111">:</span> <span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">StatusOK</span><span style="color:#111">})</span>
</span></span><span style="display:flex;"><span><span style="color:#111">})</span>
</span></span></code></pre></div><h3 id="protobuf渲染">protobuf渲染</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-protobuf" data-lang="protobuf"><span style="display:flex;"><span><span style="color:#75715e">// protobuf文件
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#111">syntax</span> <span style="color:#f92672">=</span> <span style="color:#d88200">&#34;proto3&#34;</span><span style="color:#111">;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#f92672">package</span> <span style="color:#111">models</span><span style="color:#111">;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#00a8c8">message</span> <span style="color:#75af00">hello</span> <span style="color:#111">{</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    <span style="color:#00a8c8">string</span> <span style="color:#111">content</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span><span style="color:#111">;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#111">}</span><span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;net/http&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;test/models&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;github.com/gin-gonic/gin&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Default</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">GET</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/hello&#34;</span><span style="color:#111">,</span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span>  <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">res</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">models</span><span style="color:#111">.</span><span style="color:#75af00">Hello</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">Content</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;你好&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">ProtoBuf</span><span style="color:#111">(</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">StatusOK</span><span style="color:#111">,</span><span style="color:#75af00">res</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">_</span> <span style="color:#111">=</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">Run</span><span style="color:#111">(</span><span style="color:#d88200">&#34;127.0.0.1:8001&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="获取参数">获取参数</h2>
<h3 id="获取querystring参数">获取querystring参数</h3>
<p>querystring指的是URL中?后面携带的参数，例如：/user?username=赵海宇&amp;address=地球一角。</p>
<ol>
<li>c.DefaultQuery有默认值 如果没有传去默认值</li>
<li>c.Query没有默认值 如果没传 为空</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;net/http&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;github.com/gin-gonic/gin&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Default</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">GET</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/user&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">username</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">DefaultQuery</span><span style="color:#111">(</span><span style="color:#d88200">&#34;username&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;zhy&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">address</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">Query</span><span style="color:#111">(</span><span style="color:#d88200">&#34;address&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">JSON</span><span style="color:#111">(</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">StatusOK</span><span style="color:#111">,</span> <span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">H</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#d88200">&#34;username&#34;</span><span style="color:#111">:</span> <span style="color:#75af00">username</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#d88200">&#34;address&#34;</span><span style="color:#111">:</span>  <span style="color:#75af00">address</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">_</span> <span style="color:#111">=</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">Run</span><span style="color:#111">(</span><span style="color:#d88200">&#34;127.0.0.1:8001&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="获取form参数">获取form参数</h3>
<p>请求的数据通过form表单来提交，例如向/user发送一个POST请求，获取请求数据的方式如下：c.PostForm</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;net/http&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;github.com/gin-gonic/gin&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Default</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">POST</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/user&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">username</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">PostForm</span><span style="color:#111">(</span><span style="color:#d88200">&#34;username&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">address</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">PostForm</span><span style="color:#111">(</span><span style="color:#d88200">&#34;address&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">JSON</span><span style="color:#111">(</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">StatusOK</span><span style="color:#111">,</span> <span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">H</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#d88200">&#34;username&#34;</span><span style="color:#111">:</span> <span style="color:#75af00">username</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#d88200">&#34;address&#34;</span><span style="color:#111">:</span>  <span style="color:#75af00">address</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">_</span> <span style="color:#111">=</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">Run</span><span style="color:#111">(</span><span style="color:#d88200">&#34;127.0.0.1:8001&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="获取path参数">获取path参数</h3>
<p>请求的参数通过URL路径传递，例如：/user/zhaohaiyu/地球一角/路由:/user/:username/:address方法:c.Param</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;net/http&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;github.com/gin-gonic/gin&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Default</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">GET</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/user/:username/:address&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">username</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">Param</span><span style="color:#111">(</span><span style="color:#d88200">&#34;username&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">address</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">Param</span><span style="color:#111">(</span><span style="color:#d88200">&#34;address&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">JSON</span><span style="color:#111">(</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">StatusOK</span><span style="color:#111">,</span> <span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">H</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#d88200">&#34;username&#34;</span><span style="color:#111">:</span> <span style="color:#75af00">username</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#d88200">&#34;address&#34;</span><span style="color:#111">:</span>  <span style="color:#75af00">address</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">_</span> <span style="color:#111">=</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">Run</span><span style="color:#111">(</span><span style="color:#d88200">&#34;127.0.0.1:8001&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="参数绑定">参数绑定</h3>
<p>为了能够更方便的获取请求相关参数，提高开发效率，我们可以基于请求的content-type识别请求数据类型并利用反射机制自动提取请求中querystring、form表单、JSON、XML等参数到结构体中。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;net/http&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;github.com/gin-gonic/gin&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Binding from JSON</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Login</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">User</span>     <span style="color:#00a8c8">string</span> <span style="color:#d88200">`form:&#34;user&#34; json:&#34;user&#34; binding:&#34;required&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Password</span> <span style="color:#00a8c8">string</span> <span style="color:#d88200">`form:&#34;password&#34; json:&#34;password&#34; binding:&#34;required&#34;`</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Default</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 绑定JSON的示例 ({&#34;user&#34;: &#34;root&#34;, &#34;password&#34;: &#34;123&#34;})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">POST</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/loginJSON&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">var</span> <span style="color:#75af00">login</span> <span style="color:#75af00">Login</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">ShouldBindJSON</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">login</span><span style="color:#111">);</span> <span style="color:#75af00">err</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;login info:%#v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">login</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">JSON</span><span style="color:#111">(</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">StatusOK</span><span style="color:#111">,</span> <span style="color:#75af00">login</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">JSON</span><span style="color:#111">(</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">StatusBadRequest</span><span style="color:#111">,</span> <span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">H</span><span style="color:#111">{</span><span style="color:#d88200">&#34;error&#34;</span><span style="color:#111">:</span> <span style="color:#75af00">err</span><span style="color:#111">.</span><span style="color:#75af00">Error</span><span style="color:#111">()})</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 绑定form表单示例 (user=root&amp;password=123)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">POST</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/loginForm&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">var</span> <span style="color:#75af00">login</span> <span style="color:#75af00">Login</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// ShouldBind()会根据请求的Content-Type自行选择绑定器</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">ShouldBind</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">login</span><span style="color:#111">);</span> <span style="color:#75af00">err</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">JSON</span><span style="color:#111">(</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">StatusOK</span><span style="color:#111">,</span> <span style="color:#75af00">login</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">JSON</span><span style="color:#111">(</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">StatusBadRequest</span><span style="color:#111">,</span> <span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">H</span><span style="color:#111">{</span><span style="color:#d88200">&#34;error&#34;</span><span style="color:#111">:</span> <span style="color:#75af00">err</span><span style="color:#111">.</span><span style="color:#75af00">Error</span><span style="color:#111">()})</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 绑定querystring示例 (user=root&amp;password=123)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">GET</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/loginForm&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">var</span> <span style="color:#75af00">login</span> <span style="color:#75af00">Login</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// ShouldBind()会根据请求的Content-Type自行选择绑定器</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">ShouldBind</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">login</span><span style="color:#111">);</span> <span style="color:#75af00">err</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">JSON</span><span style="color:#111">(</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">StatusOK</span><span style="color:#111">,</span> <span style="color:#75af00">login</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">JSON</span><span style="color:#111">(</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">StatusBadRequest</span><span style="color:#111">,</span> <span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">H</span><span style="color:#111">{</span><span style="color:#d88200">&#34;error&#34;</span><span style="color:#111">:</span> <span style="color:#75af00">err</span><span style="color:#111">.</span><span style="color:#75af00">Error</span><span style="color:#111">()})</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">_</span> <span style="color:#111">=</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">Run</span><span style="color:#111">(</span><span style="color:#d88200">&#34;127.0.0.1:8001&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="文件上传">文件上传</h2>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">router</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Default</span><span style="color:#111">()</span> <span style="color:#75715e">// 处理multipart forms提交文件时默认的内存限制是32 MiB</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 可以通过下面的方式修改</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// router.MaxMultipartMemory = 8 &lt;&lt; 20 // 8 MiB</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">router</span><span style="color:#111">.</span><span style="color:#75af00">POST</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/upload&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 单个文件</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">file</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">FormFile</span><span style="color:#111">(</span><span style="color:#d88200">&#34;file&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">JSON</span><span style="color:#111">(</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">StatusInternalServerError</span><span style="color:#111">,</span> <span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">H</span><span style="color:#111">{</span><span style="color:#d88200">&#34;message&#34;</span><span style="color:#111">:</span> <span style="color:#75af00">err</span><span style="color:#111">.</span><span style="color:#75af00">Error</span><span style="color:#111">()})</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">file</span><span style="color:#111">.</span><span style="color:#75af00">Filename</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">dst</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Sprintf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;C:/tmp/%s&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">file</span><span style="color:#111">.</span><span style="color:#75af00">Filename</span><span style="color:#111">)</span> <span style="color:#75715e">// 上传文件到指定的目录</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">SaveUploadedFile</span><span style="color:#111">(</span><span style="color:#75af00">file</span><span style="color:#111">,</span> <span style="color:#75af00">dst</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">JSON</span><span style="color:#111">(</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">StatusOK</span><span style="color:#111">,</span> <span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">H</span><span style="color:#111">{</span><span style="color:#d88200">&#34;message&#34;</span><span style="color:#111">:</span> <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Sprintf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;&#39;%s&#39; uploaded!&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">file</span><span style="color:#111">.</span><span style="color:#75af00">Filename</span><span style="color:#111">)})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">router</span><span style="color:#111">.</span><span style="color:#75af00">Run</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="多个文件上传">多个文件上传</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">router</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Default</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 处理multipart forms提交文件时默认的内存限制是32 MiB</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 可以通过下面的方式修改</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// router.MaxMultipartMemory = 8 &lt;&lt; 20  // 8 MiB</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">router</span><span style="color:#111">.</span><span style="color:#75af00">POST</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/upload&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Multipart form</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">form</span><span style="color:#111">,</span> <span style="color:#75af00">_</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">MultipartForm</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">files</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">form</span><span style="color:#111">.</span><span style="color:#75af00">File</span><span style="color:#111">[</span><span style="color:#d88200">&#34;file&#34;</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">for</span> <span style="color:#75af00">index</span><span style="color:#111">,</span> <span style="color:#75af00">file</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">files</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">file</span><span style="color:#111">.</span><span style="color:#75af00">Filename</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">dst</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Sprintf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;C:/tmp/%s_%d&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">file</span><span style="color:#111">.</span><span style="color:#75af00">Filename</span><span style="color:#111">,</span> <span style="color:#75af00">index</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 上传文件到指定的目录</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">SaveUploadedFile</span><span style="color:#111">(</span><span style="color:#75af00">file</span><span style="color:#111">,</span> <span style="color:#75af00">dst</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">JSON</span><span style="color:#111">(</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">StatusOK</span><span style="color:#111">,</span> <span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">H</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#d88200">&#34;message&#34;</span><span style="color:#111">:</span> <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Sprintf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;%d files uploaded!&#34;</span><span style="color:#111">,</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">files</span><span style="color:#111">)),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">router</span><span style="color:#111">.</span><span style="color:#75af00">Run</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="gin中间件">Gin中间件</h2>
<p>Gin框架允许开发者在处理请求的过程中，加入用户自己的钩子（Hook）函数。这个钩子函数就叫中间件，中间件适合处理一些公共的业务逻辑，比如登录校验、日志打印、耗时统计等。</p>
<p>Gin中的中间件必须是一个gin.HandlerFunc类型。例如我们像下面的代码一样定义一个中间件。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// StatCost 是一个统计耗时请求耗时的中间件</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">StatCost</span><span style="color:#111">()</span> <span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">HandlerFunc</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">start</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">Now</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">Set</span><span style="color:#111">(</span><span style="color:#d88200">&#34;name&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;小王子&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 执行其他中间件</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">Next</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 计算耗时</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">cost</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">time</span><span style="color:#111">.</span><span style="color:#75af00">S</span><span style="color:#f92672">***</span><span style="color:#75af00">art</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">cost</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>然后注册中间件的时候，可以在全局注册。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 新建一个没有任何默认中间件的路由</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">New</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 注册一个全局中间件</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">Use</span><span style="color:#111">(</span><span style="color:#75af00">StatCost</span><span style="color:#111">())</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">GET</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/test&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">name</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">MustGet</span><span style="color:#111">(</span><span style="color:#d88200">&#34;name&#34;</span><span style="color:#111">).(</span><span style="color:#00a8c8">string</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">name</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">JSON</span><span style="color:#111">(</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">StatusOK</span><span style="color:#111">,</span> <span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">H</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#d88200">&#34;message&#34;</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;Hello world!&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">Run</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>也可以给某个路由单独注册中间件。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// 给/test2路由单独注册中间件（可注册多个）</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">GET</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/test2&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">StatCost</span><span style="color:#111">(),</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">name</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">MustGet</span><span style="color:#111">(</span><span style="color:#d88200">&#34;name&#34;</span><span style="color:#111">).(</span><span style="color:#00a8c8">string</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">log</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">name</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">JSON</span><span style="color:#111">(</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">StatusOK</span><span style="color:#111">,</span> <span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">H</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#d88200">&#34;message&#34;</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;Hello world!&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span></code></pre></div><h3 id="重定向">重定向</h3>
<h4 id="http重定向">HTTP重定向</h4>
<p>HTTP 重定向很容易。 内部、外部重定向均支持。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">GET</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/test&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">Redirect</span><span style="color:#111">(</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">StatusMovedPermanently</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;http://www.google.com/&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">})</span>
</span></span></code></pre></div><h4 id="路由重定向">路由重定向</h4>
<p>路由重定向，使用HandleContext：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">GET</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/test&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 指定重定向的URL</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">Request</span><span style="color:#111">.</span><span style="color:#75af00">URL</span><span style="color:#111">.</span><span style="color:#75af00">Path</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;/test2&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">HandleContext</span><span style="color:#111">(</span><span style="color:#75af00">c</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">})</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">GET</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/test2&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">JSON</span><span style="color:#111">(</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">StatusOK</span><span style="color:#111">,</span> <span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">H</span><span style="color:#111">{</span><span style="color:#d88200">&#34;hello&#34;</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;world&#34;</span><span style="color:#111">})</span>
</span></span><span style="display:flex;"><span><span style="color:#111">})</span>
</span></span></code></pre></div><h2 id="gin路由">Gin路由</h2>
<h3 id="普通路由">普通路由</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">GET</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/index&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#111">{</span><span style="color:#f92672">...</span><span style="color:#111">})</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">GET</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/login&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#111">{</span><span style="color:#f92672">...</span><span style="color:#111">})</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">POST</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/login&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#111">{</span><span style="color:#f92672">...</span><span style="color:#111">})</span>
</span></span></code></pre></div><p>此外，还有一个可以匹配所有请求方法的Any方法如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">Any</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/test&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#111">{</span><span style="color:#f92672">...</span><span style="color:#111">})</span>
</span></span></code></pre></div><p>为没有配置处理函数的路由添加处理程序。默认情况下它返回404代码。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">NoRoute</span><span style="color:#111">(</span><span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">HTML</span><span style="color:#111">(</span><span style="color:#75af00">http</span><span style="color:#111">.</span><span style="color:#75af00">StatusNotFound</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;views/404.html&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">nil</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span></code></pre></div><h3 id="路由组">路由组</h3>
<p>我们可以将拥有共同URL前缀的路由划分为一个路由组。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Default</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">userGroup</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">Group</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/user&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">userGroup</span><span style="color:#111">.</span><span style="color:#75af00">GET</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/index&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#111">{</span><span style="color:#f92672">...</span><span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">userGroup</span><span style="color:#111">.</span><span style="color:#75af00">GET</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/login&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#111">{</span><span style="color:#f92672">...</span><span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">userGroup</span><span style="color:#111">.</span><span style="color:#75af00">POST</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/login&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#111">{</span><span style="color:#f92672">...</span><span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">shopGroup</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">Group</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/shop&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">shopGroup</span><span style="color:#111">.</span><span style="color:#75af00">GET</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/index&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#111">{</span><span style="color:#f92672">...</span><span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">shopGroup</span><span style="color:#111">.</span><span style="color:#75af00">GET</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/cart&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#111">{</span><span style="color:#f92672">...</span><span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">shopGroup</span><span style="color:#111">.</span><span style="color:#75af00">POST</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/checkout&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#111">{</span><span style="color:#f92672">...</span><span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">Run</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>通常我们将路由分组用在划分业务逻辑或划分API版本时。</p>
<h3 id="路由分文件">路由分文件</h3>
<ol>
<li>在route中初始化route和切片路由组</li>
<li>在各个文件写路由</li>
<li>在main中把路由函数放入函数路由组</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// route中go</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">route</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#d88200">&#34;github.com/gin-gonic/gin&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Option</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#f92672">*</span><span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Engine</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">var</span> <span style="color:#75af00">options</span> <span style="color:#111">=</span> <span style="color:#111">[]</span><span style="color:#75af00">Option</span><span style="color:#111">{}</span> <span style="color:#75715e">// 路由函数组</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 注册app的路由配置</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">Include</span><span style="color:#111">(</span><span style="color:#75af00">opts</span> <span style="color:#f92672">...</span><span style="color:#75af00">Option</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">options</span> <span style="color:#111">=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">options</span><span style="color:#111">,</span> <span style="color:#75af00">opts</span><span style="color:#f92672">...</span><span style="color:#111">)</span> <span style="color:#75715e">// 路由函数组添加函数</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 初始化</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">Init</span><span style="color:#111">()</span> <span style="color:#f92672">*</span><span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Engine</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">New</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">function</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">options</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">function</span><span style="color:#111">(</span><span style="color:#75af00">r</span><span style="color:#111">)</span> <span style="color:#75715e">// 执行路由函数组中所有函数</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">r</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// shop中的文件</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">shop</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#d88200">&#34;github.com/gin-gonic/gin&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">Routers</span><span style="color:#111">(</span><span style="color:#75af00">e</span> <span style="color:#f92672">*</span><span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Engine</span><span style="color:#111">)</span> <span style="color:#111">{</span><span style="color:#75715e">// 路由函数</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">GET</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/post&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">String</span><span style="color:#111">(</span><span style="color:#ae81ff">200</span><span style="color:#111">,</span><span style="color:#d88200">&#34;psot shop&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">e</span><span style="color:#111">.</span><span style="color:#75af00">GET</span><span style="color:#111">(</span><span style="color:#d88200">&#34;/comment&#34;</span><span style="color:#111">,</span> <span style="color:#00a8c8">func</span><span style="color:#111">(</span><span style="color:#75af00">c</span> <span style="color:#f92672">*</span><span style="color:#75af00">gin</span><span style="color:#111">.</span><span style="color:#75af00">Context</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">c</span><span style="color:#111">.</span><span style="color:#75af00">String</span><span style="color:#111">(</span><span style="color:#ae81ff">200</span><span style="color:#111">,</span><span style="color:#d88200">&#34;comment shop&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// main.go</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#75af00">main</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;test/demo1/route&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#d88200">&#34;test/demo1/shop&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">route</span><span style="color:#111">.</span><span style="color:#75af00">Include</span><span style="color:#111">(</span><span style="color:#75af00">shop</span><span style="color:#111">.</span><span style="color:#75af00">Routers</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 初始化路由</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">r</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">route</span><span style="color:#111">.</span><span style="color:#75af00">Init</span><span style="color:#111">()</span> 
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">_</span> <span style="color:#111">=</span> <span style="color:#75af00">r</span><span style="color:#111">.</span><span style="color:#75af00">Run</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="路由原理">路由原理</h3>
<p>Gin框架中的路由使用的是<a href="https://github.com/julienschmidt/httprouter">httprouter</a>这个库。</p>
<p>其基本原理就是构造一个路由地址的前缀树。</p>
<h2 id="参考文章">参考文章</h2>
<ul>
<li><a href="https://www.liwenzhou.com/posts/Go/Gin_framework/">https://www.liwenzhou.com/posts/Go/Gin_framework/</a></li>
</ul>
]]></content:encoded><category>go</category><category>go</category><category>gin</category></item></channel></rss>