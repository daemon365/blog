<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/"><channel><title>Sqlx on Daemon365</title><link>https://daemon365.dev/tags/sqlx/</link><description>Don't let yourself stop.</description><generator>Hugo -- gohugo.io</generator><language>zh-cn</language><lastBuildDate>Mon, 13 Jan 2020 00:00:00 +0800</lastBuildDate><atom:link href="https://daemon365.dev/tags/sqlx/index.xml" rel="self" type="application/rss+xml"/><item><title>golang sqlx</title><link>https://daemon365.dev/post/go/golang_sqlx/</link><pubDate>Mon, 13 Jan 2020 00:00:00 +0800</pubDate><guid>https://daemon365.dev/post/go/golang_sqlx/</guid><description>&lt;p&gt;在项目中我们通常可能会使用&lt;code&gt;database/sql&lt;/code&gt;连接MySQL数据库。本文借助使用&lt;code&gt;sqlx&lt;/code&gt;实现批量插入数据的例子，介绍了&lt;code&gt;sqlx&lt;/code&gt;中可能被你忽视了的&lt;code&gt;sqlx.In&lt;/code&gt;和&lt;code&gt;DB.NamedExec&lt;/code&gt;方法。&lt;/p&gt;
&lt;h2 id="sqlx介绍"&gt;sqlx介绍&lt;/h2&gt;
&lt;p&gt;在项目中我们通常可能会使用&lt;code&gt;database/sql&lt;/code&gt;连接MySQL数据库。&lt;code&gt;sqlx&lt;/code&gt;可以认为是Go语言内置&lt;code&gt;database/sql&lt;/code&gt;的超集，它在优秀的内置&lt;code&gt;database/sql&lt;/code&gt;基础上提供了一组扩展。这些扩展中除了大家常用来查询的&lt;code&gt;Get(dest interface{}, ...) error&lt;/code&gt;和&lt;code&gt;Select(dest interface{}, ...) error&lt;/code&gt;外还有很多其他强大的功能。&lt;/p&gt;
&lt;h2 id="安装sqlx"&gt;安装sqlx&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;go&lt;/span&gt; &lt;span style="color:#75af00"&gt;get&lt;/span&gt; &lt;span style="color:#75af00"&gt;github&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;com&lt;/span&gt;&lt;span style="color:#f92672"&gt;/&lt;/span&gt;&lt;span style="color:#75af00"&gt;jmoiron&lt;/span&gt;&lt;span style="color:#f92672"&gt;/&lt;/span&gt;&lt;span style="color:#75af00"&gt;sqlx&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id="基本使用"&gt;基本使用&lt;/h2&gt;
&lt;h3 id="连接数据库"&gt;连接数据库&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;var&lt;/span&gt; &lt;span style="color:#75af00"&gt;db&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt;&lt;span style="color:#75af00"&gt;sqlx&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;DB&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;initDB&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;error&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;dsn&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;user:password@tcp(127.0.0.1:3306)/sql_test?charset=utf8mb4&amp;amp;parseTime=True&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;// 也可以使用MustConnect连接不成功就panic&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;db&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#111"&gt;=&lt;/span&gt; &lt;span style="color:#75af00"&gt;sqlx&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Connect&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;mysql&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;dsn&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;!=&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Printf&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;connect DB failed, err:%v\n&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;db&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;SetMaxOpenConns&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;20&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;db&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;SetMaxIdleConns&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;10&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id="查询"&gt;查询&lt;/h3&gt;
&lt;p&gt;查询单行数据示例代码如下：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;// 查询单条数据示例&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;queryRowDemo&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;sqlStr&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;select id, name, age from user where id=?&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;var&lt;/span&gt; &lt;span style="color:#75af00"&gt;u&lt;/span&gt; &lt;span style="color:#75af00"&gt;user&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;db&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Get&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#f92672"&gt;&amp;amp;&lt;/span&gt;&lt;span style="color:#75af00"&gt;u&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;sqlStr&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;1&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;!=&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Printf&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;get failed, err:%v\n&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Printf&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;id:%d name:%s age:%d\n&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;u&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;ID&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;u&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Name&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;u&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Age&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;查询多行数据示例代码如下：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-go" data-lang="go"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;// 查询多条数据示例&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#00a8c8"&gt;func&lt;/span&gt; &lt;span style="color:#75af00"&gt;queryMultiRowDemo&lt;/span&gt;&lt;span style="color:#111"&gt;()&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;sqlStr&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#d88200"&gt;&amp;#34;select id, name, age from user where id &amp;gt; ?&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;var&lt;/span&gt; &lt;span style="color:#75af00"&gt;users&lt;/span&gt; &lt;span style="color:#111"&gt;[]&lt;/span&gt;&lt;span style="color:#75af00"&gt;user&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;:=&lt;/span&gt; &lt;span style="color:#75af00"&gt;db&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Select&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#f92672"&gt;&amp;amp;&lt;/span&gt;&lt;span style="color:#75af00"&gt;users&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;sqlStr&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;0&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;if&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt; &lt;span style="color:#f92672"&gt;!=&lt;/span&gt; &lt;span style="color:#00a8c8"&gt;nil&lt;/span&gt; &lt;span style="color:#111"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Printf&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;query failed, err:%v\n&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;err&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#00a8c8"&gt;return&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75af00"&gt;fmt&lt;/span&gt;&lt;span style="color:#111"&gt;.&lt;/span&gt;&lt;span style="color:#75af00"&gt;Printf&lt;/span&gt;&lt;span style="color:#111"&gt;(&lt;/span&gt;&lt;span style="color:#d88200"&gt;&amp;#34;users:%#v\n&amp;#34;&lt;/span&gt;&lt;span style="color:#111"&gt;,&lt;/span&gt; &lt;span style="color:#75af00"&gt;users&lt;/span&gt;&lt;span style="color:#111"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#111"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id="插入更新和删除"&gt;插入、更新和删除&lt;/h3&gt;
&lt;p&gt;sqlx中的exec方法与原生sql中的exec使用基本一致：&lt;/p&gt;</description><content:encoded><![CDATA[<p>在项目中我们通常可能会使用<code>database/sql</code>连接MySQL数据库。本文借助使用<code>sqlx</code>实现批量插入数据的例子，介绍了<code>sqlx</code>中可能被你忽视了的<code>sqlx.In</code>和<code>DB.NamedExec</code>方法。</p>
<h2 id="sqlx介绍">sqlx介绍</h2>
<p>在项目中我们通常可能会使用<code>database/sql</code>连接MySQL数据库。<code>sqlx</code>可以认为是Go语言内置<code>database/sql</code>的超集，它在优秀的内置<code>database/sql</code>基础上提供了一组扩展。这些扩展中除了大家常用来查询的<code>Get(dest interface{}, ...) error</code>和<code>Select(dest interface{}, ...) error</code>外还有很多其他强大的功能。</p>
<h2 id="安装sqlx">安装sqlx</h2>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">go</span> <span style="color:#75af00">get</span> <span style="color:#75af00">github</span><span style="color:#111">.</span><span style="color:#75af00">com</span><span style="color:#f92672">/</span><span style="color:#75af00">jmoiron</span><span style="color:#f92672">/</span><span style="color:#75af00">sqlx</span>
</span></span></code></pre></div><h2 id="基本使用">基本使用</h2>
<h3 id="连接数据库">连接数据库</h3>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">var</span> <span style="color:#75af00">db</span> <span style="color:#f92672">*</span><span style="color:#75af00">sqlx</span><span style="color:#111">.</span><span style="color:#75af00">DB</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">initDB</span><span style="color:#111">()</span> <span style="color:#111">(</span><span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">dsn</span> <span style="color:#f92672">:=</span> <span style="color:#d88200">&#34;user:password@tcp(127.0.0.1:3306)/sql_test?charset=utf8mb4&amp;parseTime=True&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 也可以使用MustConnect连接不成功就panic</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">db</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">sqlx</span><span style="color:#111">.</span><span style="color:#75af00">Connect</span><span style="color:#111">(</span><span style="color:#d88200">&#34;mysql&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">dsn</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;connect DB failed, err:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">SetMaxOpenConns</span><span style="color:#111">(</span><span style="color:#ae81ff">20</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">SetMaxIdleConns</span><span style="color:#111">(</span><span style="color:#ae81ff">10</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="查询">查询</h3>
<p>查询单行数据示例代码如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// 查询单条数据示例</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">queryRowDemo</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">sqlStr</span> <span style="color:#f92672">:=</span> <span style="color:#d88200">&#34;select id, name, age from user where id=?&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">var</span> <span style="color:#75af00">u</span> <span style="color:#75af00">user</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">Get</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">u</span><span style="color:#111">,</span> <span style="color:#75af00">sqlStr</span><span style="color:#111">,</span> <span style="color:#ae81ff">1</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;get failed, err:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;id:%d name:%s age:%d\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">u</span><span style="color:#111">.</span><span style="color:#75af00">ID</span><span style="color:#111">,</span> <span style="color:#75af00">u</span><span style="color:#111">.</span><span style="color:#75af00">Name</span><span style="color:#111">,</span> <span style="color:#75af00">u</span><span style="color:#111">.</span><span style="color:#75af00">Age</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>查询多行数据示例代码如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// 查询多条数据示例</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">queryMultiRowDemo</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">sqlStr</span> <span style="color:#f92672">:=</span> <span style="color:#d88200">&#34;select id, name, age from user where id &gt; ?&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">var</span> <span style="color:#75af00">users</span> <span style="color:#111">[]</span><span style="color:#75af00">user</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">Select</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">users</span><span style="color:#111">,</span> <span style="color:#75af00">sqlStr</span><span style="color:#111">,</span> <span style="color:#ae81ff">0</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;query failed, err:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;users:%#v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">users</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="插入更新和删除">插入、更新和删除</h3>
<p>sqlx中的exec方法与原生sql中的exec使用基本一致：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// 插入数据</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">insertRowDemo</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">sqlStr</span> <span style="color:#f92672">:=</span> <span style="color:#d88200">&#34;insert into user(name, age) values (?,?)&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ret</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">Exec</span><span style="color:#111">(</span><span style="color:#75af00">sqlStr</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;沙河小王子&#34;</span><span style="color:#111">,</span> <span style="color:#ae81ff">19</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;insert failed, err:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">theID</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">ret</span><span style="color:#111">.</span><span style="color:#75af00">LastInsertId</span><span style="color:#111">()</span> <span style="color:#75715e">// 新插入数据的id</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;get lastinsert ID failed, err:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;insert success, the id is %d.\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">theID</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 更新数据</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">updateRowDemo</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">sqlStr</span> <span style="color:#f92672">:=</span> <span style="color:#d88200">&#34;update user set age=? where id = ?&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ret</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">Exec</span><span style="color:#111">(</span><span style="color:#75af00">sqlStr</span><span style="color:#111">,</span> <span style="color:#ae81ff">39</span><span style="color:#111">,</span> <span style="color:#ae81ff">6</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;update failed, err:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">n</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">ret</span><span style="color:#111">.</span><span style="color:#75af00">RowsAffected</span><span style="color:#111">()</span> <span style="color:#75715e">// 操作影响的行数</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;get RowsAffected failed, err:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;update success, affected rows:%d\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">n</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 删除数据</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">deleteRowDemo</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">sqlStr</span> <span style="color:#f92672">:=</span> <span style="color:#d88200">&#34;delete from user where id = ?&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">ret</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">Exec</span><span style="color:#111">(</span><span style="color:#75af00">sqlStr</span><span style="color:#111">,</span> <span style="color:#ae81ff">6</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;delete failed, err:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">n</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">ret</span><span style="color:#111">.</span><span style="color:#75af00">RowsAffected</span><span style="color:#111">()</span> <span style="color:#75715e">// 操作影响的行数</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;get RowsAffected failed, err:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;delete success, affected rows:%d\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">n</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="namedexec">NamedExec</h3>
<p><code>DB.NamedExec</code>方法用来绑定SQL语句与结构体或map中的同名字段。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">insertUserDemo</span><span style="color:#111">()(</span><span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span><span style="color:#111">){</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">sqlStr</span> <span style="color:#f92672">:=</span> <span style="color:#d88200">&#34;INSERT INTO user (name,age) VALUES (:name,:age)&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">NamedExec</span><span style="color:#111">(</span><span style="color:#75af00">sqlStr</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#00a8c8">string</span><span style="color:#111">]</span><span style="color:#00a8c8">interface</span><span style="color:#111">{}{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#d88200">&#34;name&#34;</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;七米&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#d88200">&#34;age&#34;</span><span style="color:#111">:</span> <span style="color:#ae81ff">28</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="namedquery">NamedQuery</h3>
<p>与<code>DB.NamedExec</code>同理，这里是支持查询。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">namedQuery</span><span style="color:#111">(){</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">sqlStr</span> <span style="color:#f92672">:=</span> <span style="color:#d88200">&#34;SELECT * FROM user WHERE name=:name&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 使用map做命名查询</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">rows</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">NamedQuery</span><span style="color:#111">(</span><span style="color:#75af00">sqlStr</span><span style="color:#111">,</span> <span style="color:#00a8c8">map</span><span style="color:#111">[</span><span style="color:#00a8c8">string</span><span style="color:#111">]</span><span style="color:#00a8c8">interface</span><span style="color:#111">{}{</span><span style="color:#d88200">&#34;name&#34;</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;七米&#34;</span><span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;db.NamedQuery failed, err:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">rows</span><span style="color:#111">.</span><span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">rows</span><span style="color:#111">.</span><span style="color:#75af00">Next</span><span style="color:#111">(){</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">var</span> <span style="color:#75af00">u</span> <span style="color:#75af00">user</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">rows</span><span style="color:#111">.</span><span style="color:#75af00">StructScan</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">u</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;scan failed, err:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">continue</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;user:%#v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">u</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">u</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">user</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">Name</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;七米&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 使用结构体命名查询，根据结构体字段的 db tag进行映射</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">rows</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">NamedQuery</span><span style="color:#111">(</span><span style="color:#75af00">sqlStr</span><span style="color:#111">,</span> <span style="color:#75af00">u</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;db.NamedQuery failed, err:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">rows</span><span style="color:#111">.</span><span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">rows</span><span style="color:#111">.</span><span style="color:#75af00">Next</span><span style="color:#111">(){</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">var</span> <span style="color:#75af00">u</span> <span style="color:#75af00">user</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">rows</span><span style="color:#111">.</span><span style="color:#75af00">StructScan</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">u</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;scan failed, err:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#00a8c8">continue</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;user:%#v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">u</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="事务操作">事务操作</h3>
<p>对于事务操作，我们可以使用<code>sqlx</code>中提供的<code>db.Beginx()</code>和<code>tx.Exec()</code>方法。示例代码如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">transactionDemo2</span><span style="color:#111">()(</span><span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">tx</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">Beginx</span><span style="color:#111">()</span> <span style="color:#75715e">// 开启事务</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;begin trans failed, err:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#00a8c8">func</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">if</span> <span style="color:#75af00">p</span> <span style="color:#f92672">:=</span> <span style="color:#111">recover</span><span style="color:#111">();</span> <span style="color:#75af00">p</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">Rollback</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#75af00">p</span><span style="color:#111">)</span> <span style="color:#75715e">// re-throw panic after Rollback</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;rollback&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">Rollback</span><span style="color:#111">()</span> <span style="color:#75715e">// err is non-nil; don&#39;t change it</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">Commit</span><span style="color:#111">()</span> <span style="color:#75715e">// err is nil; if Commit returns error update err</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#d88200">&#34;commit&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">sqlStr1</span> <span style="color:#f92672">:=</span> <span style="color:#d88200">&#34;Update user set age=20 where id=?&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">rs</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">Exec</span><span style="color:#111">(</span><span style="color:#75af00">sqlStr1</span><span style="color:#111">,</span> <span style="color:#ae81ff">1</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span><span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">n</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">rs</span><span style="color:#111">.</span><span style="color:#75af00">RowsAffected</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">n</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">1</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">errors</span><span style="color:#111">.</span><span style="color:#75af00">New</span><span style="color:#111">(</span><span style="color:#d88200">&#34;exec sqlStr1 failed&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">sqlStr2</span> <span style="color:#f92672">:=</span> <span style="color:#d88200">&#34;Update user set age=50 where i=?&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">rs</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">tx</span><span style="color:#111">.</span><span style="color:#75af00">Exec</span><span style="color:#111">(</span><span style="color:#75af00">sqlStr2</span><span style="color:#111">,</span> <span style="color:#ae81ff">5</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span><span style="color:#f92672">!=</span><span style="color:#00a8c8">nil</span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">n</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">rs</span><span style="color:#111">.</span><span style="color:#75af00">RowsAffected</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">n</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">1</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span> <span style="color:#75af00">errors</span><span style="color:#111">.</span><span style="color:#75af00">New</span><span style="color:#111">(</span><span style="color:#d88200">&#34;exec sqlStr1 failed&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h2 id="sqlxin">sqlx.In</h2>
<p><code>sqlx.In</code>是<code>sqlx</code>提供的一个非常方便的函数。</p>
<h3 id="sqlxin的批量插入示例">sqlx.In的批量插入示例</h3>
<h4 id="表结构">表结构</h4>
<p>为了方便演示插入数据操作，这里创建一个<code>user</code>表，表结构如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#00a8c8">CREATE</span> <span style="color:#00a8c8">TABLE</span> <span style="color:#f92672">`</span><span style="color:#00a8c8">user</span><span style="color:#f92672">`</span> <span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">`</span><span style="color:#111">id</span><span style="color:#f92672">`</span> <span style="color:#111">BIGINT</span><span style="color:#111">(</span><span style="color:#ae81ff">20</span><span style="color:#111">)</span> <span style="color:#00a8c8">NOT</span> <span style="color:#00a8c8">NULL</span> <span style="color:#111">AUTO_INCREMENT</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">`</span><span style="color:#111">name</span><span style="color:#f92672">`</span> <span style="color:#111">VARCHAR</span><span style="color:#111">(</span><span style="color:#ae81ff">20</span><span style="color:#111">)</span> <span style="color:#00a8c8">DEFAULT</span> <span style="color:#d88200">&#39;&#39;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">`</span><span style="color:#111">age</span><span style="color:#f92672">`</span> <span style="color:#111">INT</span><span style="color:#111">(</span><span style="color:#ae81ff">11</span><span style="color:#111">)</span> <span style="color:#00a8c8">DEFAULT</span> <span style="color:#d88200">&#39;0&#39;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">PRIMARY</span> <span style="color:#00a8c8">KEY</span><span style="color:#111">(</span><span style="color:#f92672">`</span><span style="color:#111">id</span><span style="color:#f92672">`</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">)</span><span style="color:#111">ENGINE</span><span style="color:#f92672">=</span><span style="color:#111">InnoDB</span> <span style="color:#111">AUTO_INCREMENT</span><span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> <span style="color:#00a8c8">DEFAULT</span> <span style="color:#111">CHARSET</span><span style="color:#f92672">=</span><span style="color:#111">utf8mb4</span><span style="color:#111">;</span>
</span></span></code></pre></div><h4 id="结构体">结构体</h4>
<p>定义一个<code>user</code>结构体，字段通过tag与数据库中user表的列一致。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">User</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Name</span> <span style="color:#00a8c8">string</span> <span style="color:#d88200">`db:&#34;name&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">Age</span>  <span style="color:#00a8c8">int</span>    <span style="color:#d88200">`db:&#34;age&#34;`</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h4 id="bindvars绑定变量">bindvars（绑定变量）</h4>
<p>查询占位符<code>?</code>在内部称为<strong>bindvars（查询占位符）</strong>,它非常重要。你应该始终使用它们向数据库发送值，因为它们可以防止SQL注入攻击。<code>database/sql</code>不尝试对查询文本进行任何验证；它与编码的参数一起按原样发送到服务器。除非驱动程序实现一个特殊的接口，否则在执行之前，查询是在服务器上准备的。因此<code>bindvars</code>是特定于数据库的:</p>
<ul>
<li>MySQL中使用<code>?</code></li>
<li>PostgreSQL使用枚举的<code>$1</code>、<code>$2</code>等bindvar语法</li>
<li>SQLite中<code>?</code>和<code>$1</code>的语法都支持</li>
<li>Oracle中使用<code>:name</code>的语法</li>
</ul>
<p><code>bindvars</code>的一个常见误解是，它们用来在sql语句中插入值。它们其实仅用于参数化，不允许更改SQL语句的结构。例如，使用<code>bindvars</code>尝试参数化列或表名将不起作用：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// ？不能用来插入表名（做SQL语句中表名的占位符）</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">Query</span><span style="color:#111">(</span><span style="color:#d88200">&#34;SELECT * FROM ?&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;mytable&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#75715e">// ？也不能用来插入列名（做SQL语句中列名的占位符）</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">db</span><span style="color:#111">.</span><span style="color:#75af00">Query</span><span style="color:#111">(</span><span style="color:#d88200">&#34;SELECT ?, ? FROM people&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;name&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;location&#34;</span><span style="color:#111">)</span>
</span></span></code></pre></div><h4 id="自己拼接语句实现批量插入">自己拼接语句实现批量插入</h4>
<p>比较笨，但是很好理解。就是有多少个User就拼接多少个<code>(?, ?)</code>。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// BatchInsertUsers 自行构造批量插入的语句</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">BatchInsertUsers</span><span style="color:#111">(</span><span style="color:#75af00">users</span> <span style="color:#111">[]</span><span style="color:#f92672">*</span><span style="color:#75af00">User</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 存放 (?, ?) 的slice</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">valueStrings</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">([]</span><span style="color:#00a8c8">string</span><span style="color:#111">,</span> <span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">users</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 存放values的slice</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">valueArgs</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">([]</span><span style="color:#00a8c8">interface</span><span style="color:#111">{},</span> <span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">users</span><span style="color:#111">)</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">2</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 遍历users准备相关数据</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">u</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">users</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 此处占位符要与插入值的个数对应</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">valueStrings</span> <span style="color:#111">=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">valueStrings</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;(?, ?)&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">valueArgs</span> <span style="color:#111">=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">valueArgs</span><span style="color:#111">,</span> <span style="color:#75af00">u</span><span style="color:#111">.</span><span style="color:#75af00">Name</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">valueArgs</span> <span style="color:#111">=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">valueArgs</span><span style="color:#111">,</span> <span style="color:#75af00">u</span><span style="color:#111">.</span><span style="color:#75af00">Age</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 自行拼接要执行的具体语句</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">stmt</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Sprintf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;INSERT INTO user (name, age) VALUES %s&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">strings</span><span style="color:#111">.</span><span style="color:#75af00">Join</span><span style="color:#111">(</span><span style="color:#75af00">valueStrings</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;,&#34;</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">DB</span><span style="color:#111">.</span><span style="color:#75af00">Exec</span><span style="color:#111">(</span><span style="color:#75af00">stmt</span><span style="color:#111">,</span> <span style="color:#75af00">valueArgs</span><span style="color:#f92672">...</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h4 id="使用sqlxin实现批量插入">使用sqlx.In实现批量插入</h4>
<p>前提是需要我们的结构体实现<code>driver.Valuer</code>接口：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#111">(</span><span style="color:#75af00">u</span> <span style="color:#75af00">User</span><span style="color:#111">)</span> <span style="color:#75af00">Value</span><span style="color:#111">()</span> <span style="color:#111">(</span><span style="color:#75af00">driver</span><span style="color:#111">.</span><span style="color:#75af00">Value</span><span style="color:#111">,</span> <span style="color:#00a8c8">error</span><span style="color:#111">)</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#111">[]</span><span style="color:#00a8c8">interface</span><span style="color:#111">{}{</span><span style="color:#75af00">u</span><span style="color:#111">.</span><span style="color:#75af00">Name</span><span style="color:#111">,</span> <span style="color:#75af00">u</span><span style="color:#111">.</span><span style="color:#75af00">Age</span><span style="color:#111">},</span> <span style="color:#00a8c8">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>使用<code>sqlx.In</code>实现批量插入代码如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// BatchInsertUsers2 使用sqlx.In帮我们拼接语句和参数, 注意传入的参数是[]interface{}</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">BatchInsertUsers2</span><span style="color:#111">(</span><span style="color:#75af00">users</span> <span style="color:#111">[]</span><span style="color:#00a8c8">interface</span><span style="color:#111">{})</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">query</span><span style="color:#111">,</span> <span style="color:#75af00">args</span><span style="color:#111">,</span> <span style="color:#75af00">_</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">sqlx</span><span style="color:#111">.</span><span style="color:#75af00">In</span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#d88200">&#34;INSERT INTO user (name, age) VALUES (?), (?), (?)&#34;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">users</span><span style="color:#f92672">...</span><span style="color:#111">,</span> <span style="color:#75715e">// 如果arg实现了 driver.Valuer, sqlx.In 会通过调用 Value()来展开它</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">query</span><span style="color:#111">)</span> <span style="color:#75715e">// 查看生成的querystring</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Println</span><span style="color:#111">(</span><span style="color:#75af00">args</span><span style="color:#111">)</span>  <span style="color:#75715e">// 查看生成的args</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">DB</span><span style="color:#111">.</span><span style="color:#75af00">Exec</span><span style="color:#111">(</span><span style="color:#75af00">query</span><span style="color:#111">,</span> <span style="color:#75af00">args</span><span style="color:#f92672">...</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h4 id="使用namedexec实现批量插入">使用NamedExec实现批量插入</h4>
<p><strong>注意</strong> ：该功能需1.3.1版本以上，并且1.3.1版本目前还有点问题，sql语句最后不能有空格和<code>;</code>，详见<a href="https://github.com/jmoiron/sqlx/issues/690">issues/690</a>。</p>
<p>使用<code>NamedExec</code>实现批量插入的代码如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// BatchInsertUsers3 使用NamedExec实现批量插入</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">BatchInsertUsers3</span><span style="color:#111">(</span><span style="color:#75af00">users</span> <span style="color:#111">[]</span><span style="color:#f92672">*</span><span style="color:#75af00">User</span><span style="color:#111">)</span> <span style="color:#00a8c8">error</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">DB</span><span style="color:#111">.</span><span style="color:#75af00">NamedExec</span><span style="color:#111">(</span><span style="color:#d88200">&#34;INSERT INTO user (name, age) VALUES (:name, :age)&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">users</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span> <span style="color:#75af00">err</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>把上面三种方法综合起来试一下：</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">main</span><span style="color:#111">()</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">initDB</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#111">panic</span><span style="color:#111">(</span><span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">defer</span> <span style="color:#75af00">DB</span><span style="color:#111">.</span><span style="color:#75af00">Close</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">u1</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">User</span><span style="color:#111">{</span><span style="color:#75af00">Name</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;七米&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">Age</span><span style="color:#111">:</span> <span style="color:#ae81ff">18</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">u2</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">User</span><span style="color:#111">{</span><span style="color:#75af00">Name</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;q1mi&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">Age</span><span style="color:#111">:</span> <span style="color:#ae81ff">28</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">u3</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">User</span><span style="color:#111">{</span><span style="color:#75af00">Name</span><span style="color:#111">:</span> <span style="color:#d88200">&#34;小王子&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">Age</span><span style="color:#111">:</span> <span style="color:#ae81ff">38</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 方法1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">users</span> <span style="color:#f92672">:=</span> <span style="color:#111">[]</span><span style="color:#f92672">*</span><span style="color:#75af00">User</span><span style="color:#111">{</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">u1</span><span style="color:#111">,</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">u2</span><span style="color:#111">,</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">u3</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">BatchInsertUsers</span><span style="color:#111">(</span><span style="color:#75af00">users</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;BatchInsertUsers failed, err:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 方法2</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">users2</span> <span style="color:#f92672">:=</span> <span style="color:#111">[]</span><span style="color:#00a8c8">interface</span><span style="color:#111">{}{</span><span style="color:#75af00">u1</span><span style="color:#111">,</span> <span style="color:#75af00">u2</span><span style="color:#111">,</span> <span style="color:#75af00">u3</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">BatchInsertUsers2</span><span style="color:#111">(</span><span style="color:#75af00">users2</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;BatchInsertUsers2 failed, err:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 方法3</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">users3</span> <span style="color:#f92672">:=</span> <span style="color:#111">[]</span><span style="color:#f92672">*</span><span style="color:#75af00">User</span><span style="color:#111">{</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">u1</span><span style="color:#111">,</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">u2</span><span style="color:#111">,</span> <span style="color:#f92672">&amp;</span><span style="color:#75af00">u3</span><span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">BatchInsertUsers3</span><span style="color:#111">(</span><span style="color:#75af00">users3</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Printf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;BatchInsertUsers3 failed, err:%v\n&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">err</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h3 id="sqlxin的查询示例">sqlx.In的查询示例</h3>
<p>关于<code>sqlx.In</code>这里再补充一个用法，在<code>sqlx</code>查询语句中实现In查询和FIND_IN_SET函数。即实现<code>SELECT * FROM user WHERE id in (3, 2, 1);</code>和<code>SELECT * FROM user WHERE id in (3, 2, 1) ORDER BY FIND_IN_SET(id, '3,2,1');</code>。</p>
<h4 id="in查询">in查询</h4>
<p>查询id在给定id集合中的数据。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// QueryByIDs 根据给定ID查询</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">QueryByIDs</span><span style="color:#111">(</span><span style="color:#75af00">ids</span> <span style="color:#111">[]</span><span style="color:#00a8c8">int</span><span style="color:#111">)(</span><span style="color:#75af00">users</span> <span style="color:#111">[]</span><span style="color:#75af00">User</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span><span style="color:#111">){</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 动态填充id</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">query</span><span style="color:#111">,</span> <span style="color:#75af00">args</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">sqlx</span><span style="color:#111">.</span><span style="color:#75af00">In</span><span style="color:#111">(</span><span style="color:#d88200">&#34;SELECT name, age FROM user WHERE id IN (?)&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">ids</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// sqlx.In 返回带 `?` bindvar的查询语句, 我们使用Rebind()重新绑定它</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">query</span> <span style="color:#111">=</span> <span style="color:#75af00">DB</span><span style="color:#111">.</span><span style="color:#75af00">Rebind</span><span style="color:#111">(</span><span style="color:#75af00">query</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">DB</span><span style="color:#111">.</span><span style="color:#75af00">Select</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">users</span><span style="color:#111">,</span> <span style="color:#75af00">query</span><span style="color:#111">,</span> <span style="color:#75af00">args</span><span style="color:#f92672">...</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><h4 id="in查询和find_in_set函数">in查询和FIND_IN_SET函数</h4>
<p>查询id在给定id集合的数据并维持给定id集合的顺序。</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// QueryAndOrderByIDs 按照指定id查询并维护顺序</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">func</span> <span style="color:#75af00">QueryAndOrderByIDs</span><span style="color:#111">(</span><span style="color:#75af00">ids</span> <span style="color:#111">[]</span><span style="color:#00a8c8">int</span><span style="color:#111">)(</span><span style="color:#75af00">users</span> <span style="color:#111">[]</span><span style="color:#75af00">User</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#00a8c8">error</span><span style="color:#111">){</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 动态填充id</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">strIDs</span> <span style="color:#f92672">:=</span> <span style="color:#111">make</span><span style="color:#111">([]</span><span style="color:#00a8c8">string</span><span style="color:#111">,</span> <span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#75af00">ids</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">for</span> <span style="color:#75af00">_</span><span style="color:#111">,</span> <span style="color:#75af00">id</span> <span style="color:#f92672">:=</span> <span style="color:#00a8c8">range</span> <span style="color:#75af00">ids</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75af00">strIDs</span> <span style="color:#111">=</span> <span style="color:#111">append</span><span style="color:#111">(</span><span style="color:#75af00">strIDs</span><span style="color:#111">,</span> <span style="color:#75af00">fmt</span><span style="color:#111">.</span><span style="color:#75af00">Sprintf</span><span style="color:#111">(</span><span style="color:#d88200">&#34;%d&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">id</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">query</span><span style="color:#111">,</span> <span style="color:#75af00">args</span><span style="color:#111">,</span> <span style="color:#75af00">err</span> <span style="color:#f92672">:=</span> <span style="color:#75af00">sqlx</span><span style="color:#111">.</span><span style="color:#75af00">In</span><span style="color:#111">(</span><span style="color:#d88200">&#34;SELECT name, age FROM user WHERE id IN (?) ORDER BY FIND_IN_SET(id, ?)&#34;</span><span style="color:#111">,</span> <span style="color:#75af00">ids</span><span style="color:#111">,</span> <span style="color:#75af00">strings</span><span style="color:#111">.</span><span style="color:#75af00">Join</span><span style="color:#111">(</span><span style="color:#75af00">strIDs</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;,&#34;</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">if</span> <span style="color:#75af00">err</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">nil</span> <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// sqlx.In 返回带 `?` bindvar的查询语句, 我们使用Rebind()重新绑定它</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">query</span> <span style="color:#111">=</span> <span style="color:#75af00">DB</span><span style="color:#111">.</span><span style="color:#75af00">Rebind</span><span style="color:#111">(</span><span style="color:#75af00">query</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75af00">err</span> <span style="color:#111">=</span> <span style="color:#75af00">DB</span><span style="color:#111">.</span><span style="color:#75af00">Select</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#75af00">users</span><span style="color:#111">,</span> <span style="color:#75af00">query</span><span style="color:#111">,</span> <span style="color:#75af00">args</span><span style="color:#f92672">...</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#00a8c8">return</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>当然，在这个例子里面你也可以先使用<code>IN</code>查询，然后通过代码按给定的ids对查询结果进行排序。</p>
<h2 id="文章转自">文章转自</h2>
<ul>
<li><a href="https://www.liwenzhou.com/posts/Go/sqlx/">https://www.liwenzhou.com/posts/Go/sqlx/</a></li>
</ul>
]]></content:encoded><category>go</category><category>golang</category><category>sqlx</category></item></channel></rss>