<!doctype html><html lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>RabbitMQ消息队列 - Daemon365</title><link rel=icon href=/imgs/favicon.ico><link rel=manifest href=/manifest.json><meta name=theme-color content="#007aff"><meta name=mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="default"><meta name=apple-mobile-web-app-title content="Daemon365"><meta name=description content="消息队列
本篇文章主要介绍了 RabbitMQ 这种消息队列，从消息队列的概念、应用场景、安装方式到它的核心概念、五种工作模式。在安装的时候推荐使用 Docker 方式进行安装。重点需要理解的就是消息队列的应用场景、核心概念和 RabbitMQ 的五种工作模式，其中用的比较多的就是发布订阅模式、主题模式。
队 …"><meta name=keywords content="RabbitMQ"><meta name=author content="daemon365"><meta property="og:type" content="article"><meta property="og:url" content="https://daemon365.dev/post/database/rabbitmq_message_queue/"><meta property="og:title" content="RabbitMQ消息队列 - Daemon365"><meta property="og:description" content="消息队列
本篇文章主要介绍了 RabbitMQ 这种消息队列，从消息队列的概念、应用场景、安装方式到它的核心概念、五种工作模式。在安装的时候推荐使用 Docker 方式进行安装。重点需要理解的就是消息队列的应用场景、核心概念和 RabbitMQ 的五种工作模式，其中用的比较多的就是发布订阅模式、主题模式。
队 …"><meta property="og:image" content="https://daemon365.dev/imgs/avatar.svg"><meta property="og:locale" content="en"><meta property="og:site_name" content="Daemon365"><meta property="article:published_time" content="2023-05-20T00:00:00+08:00"><meta property="article:modified_time" content="2023-05-20T00:00:00+08:00"><meta property="article:author" content="daemon365"><meta property="article:section" content="database"><meta property="article:tag" content="RabbitMQ"><meta name=twitter:card content="summary_large_image"><meta name=twitter:url content="https://daemon365.dev/post/database/rabbitmq_message_queue/"><meta name=twitter:title content="RabbitMQ消息队列 - Daemon365"><meta name=twitter:description content="消息队列
本篇文章主要介绍了 RabbitMQ 这种消息队列，从消息队列的概念、应用场景、安装方式到它的核心概念、五种工作模式。在安装的时候推荐使用 Docker 方式进行安装。重点需要理解的就是消息队列的应用场景、核心概念和 RabbitMQ 的五种工作模式，其中用的比较多的就是发布订阅模式、主题模式。
队 …"><meta name=twitter:image content="https://daemon365.dev/imgs/avatar.svg"><link rel=canonical href=https://daemon365.dev/post/database/rabbitmq_message_queue/><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"RabbitMQ消息队列","description":"\u003ch2 id=\u0022消息队列\u0022\u003e消息队列\u003c\/h2\u003e\n\u003cp\u003e本篇文章主要介绍了 RabbitMQ 这种消息队列，从消息队列的概念、应用场景、安装方式到它的核心概念、五种工作模式。在安装的时候推荐使用 Docker 方式进行安装。重点需要理解的就是消息队列的应用场景、核心概念和 RabbitMQ 的五种工作模式，其中用的比较多的就是发布订阅模式、主题模式。\u003c\/p\u003e\n\u003cp\u003e队 …\u003c\/p\u003e","datePublished":"2023-05-20T00:00:00\u002b08:00","dateModified":"2023-05-20T00:00:00\u002b08:00","author":{"@type":"Person","name":"daemon365"},"publisher":{"@type":"Organization","name":"Daemon365","logo":{"@type":"ImageObject","url":"https:\/\/daemon365.dev\/imgs\/favicon.ico"}},"mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/daemon365.dev\/post\/database\/rabbitmq_message_queue\/"},"inLanguage":"en"}</script><meta name=robots content="index, follow"><meta name=googlebot content="index, follow"><link rel=stylesheet href=/css/components/variables.css><link rel=stylesheet href=/css/components/base.css><link rel=stylesheet href=/css/components/layout.css><link rel=stylesheet href=/css/main.css><link rel=stylesheet href=/css/components/search.css><link rel=stylesheet href=/css/components/toc.css><link rel=stylesheet href=/css/components/image-preview.css><link rel=stylesheet href=/css/components/reading-progress.css><style>:root{font-family:-apple-system,BlinkMacSystemFont,segoe ui,Roboto,helvetica neue,Arial,sans-serif}</style></head><body><div class=reading-progress-bar></div><header class=site-header><div class=container><div class=header-content><div class=site-branding><a href=/ class=site-logo><span class=site-title>Daemon365</span></a></div><nav class=site-nav><ul class=nav-menu><li><a href=/><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
Home</a></li><li><a href=/about><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
About</a></li><li><a href=/archives><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
Archives</a></li><li><a href=/categories><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg>
Categories</a></li><li><a href=/tags><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>
Tags</a></li><li><button class=search-trigger aria-label=Search>
<svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
Search</button></li></ul></nav></div></div></header><main class=main-content><div class=post-container><div class=container><article class=post-content><header class=post-header><h1 class=post-title>RabbitMQ消息队列</h1><div class=post-meta><time datetime=2023-05-20><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
2023-05-20
</time><a href=/categories/database class=category-link><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg>
database
</a><span class=reading-time><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
13 min read
</span><span class=word-count><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
2668 words</span></div><div class=post-tags><a href=/tags/rabbitmq class=tag><svg class="icon" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>
RabbitMQ</a></div></header><div class=post-body><h2 id=消息队列>消息队列</h2><p>本篇文章主要介绍了 RabbitMQ 这种消息队列，从消息队列的概念、应用场景、安装方式到它的核心概念、五种工作模式。在安装的时候推荐使用 Docker 方式进行安装。重点需要理解的就是消息队列的应用场景、核心概念和 RabbitMQ 的五种工作模式，其中用的比较多的就是发布订阅模式、主题模式。</p><p>队列 (Queue) 是一种常见的数据结构，其最大的特性就是先进先出(Firist In First Out)，作为最基础的数据结构，队列应用很广泛，比如我们熟知的 Redis 基础数据类型 List，其底层数据结构就是队列。</p><p>消息队列 (Messaeg Queue) 是一种使用队列 (Queue) 作为底层存储数据结构，可用于解决不同进程与应用之间通讯的分布式消息容器，也称为消息中间件。</p><p>目前使用得比较多的消息队列有 ActiveMQ，RabbitMQ，Kafka，RocketMQ 等。本文主要讲述的是 RabbitMQ，RabbitMQ 是用 Erlang 语言开发的一个实现了 AMQP 协议的消息队列服务器，相比其他同类型的消息队列，最大的特点在保证可观的单机吞吐量的同时，延时方面非常出色。</p><p>RabbitMQ 支持多种客户端，比如：GO、Python、Ruby、.NET、Java、JMS、C、PHP、ActionScript、XMPP、STOMP 等。</p><blockquote><p>AMQP，即 Advanced Message Queuing Protocol，高级消息队列协议，是应用层协议的一个开放标准，为面向消息的中间件设计，它是一种应用程序之间的通信方法，消息队列在分布式系统开发中应用非常广泛。这里是 AMQP 官网 <a href=https://amqp.org/>amqp.org</a></p></blockquote><p>消息队列使用广泛，其应用场景有很多，下面我们列举比较常见的四个场景：</p><h3 id=1消息通讯>1、消息通讯</h3><p>消息队列最主要功能收发消息，其内部有高效的通讯机制，因此非常适合用于消息通讯。</p><p>我们可以基于消息队列开发点对点聊天系统，也可以开发广播系统，用于将消息广播给大量接收者。</p><h3 id=2异步处理>2、异步处理</h3><p>一般我们写的程序都是顺序执行 (同步执行)，比如一个用户注册函数，其执行顺序如下：</p><ul><li>1、写入用户注册数据。</li><li>2、发送注册邮件。</li><li>3、发送注册成功的短信通知。</li><li>4、更新统计数据。</li></ul><p>按照上面的执行顺序，要全部执行完毕，才能返回成功，但其实在第 1 步执行成功后，其他的步骤完全可以异步执行，我们可以将后面的逻辑发给消息队列，再由其他程序异步执行。使用消息队列进行异步处理，可以更快地返回结果，加快服务器的响应速度，提升了服务器的性能。</p><h3 id=3服务解耦>3、服务解耦</h3><p>在我们的系统中，应用与应用之间的通讯是很常见的，一般我们应用之间直接调用，比如说应用 A 调用应用 B 的接口，这时候应用之间的关系是强耦合的。</p><p>如果应用 B 处于不可用的状态，那么应用 A 也会受影响。</p><p>在应用 A 与应用 B 之间引入消息队列进行服务解耦，如果应用 B 挂掉，也不会影响应用 A 的使用。</p><h3 id=4流量削峰>4、流量削峰</h3><p>对于高并发的系统来说，在访问高峰时，突发的流量就像洪水般向应用系统涌过来，尤其是一些高并发写操作，随时会导致数据库服务器瘫痪，无法继续提供服务。</p><p>而引入消息队列则可以减少突发流量对应用系统的冲击。消息队列就像水库一样，拦蓄上游的洪水，削减进入下游河道的洪峰流量，从而达到减免洪水灾害的目的。而在旱季水流量小的时候又可以把水放出来灌溉庄稼。</p><p>这方面最常见的例子就是秒杀系统，一般秒杀活动瞬间流量很高，如果流量全部涌向秒杀系统，会压垮秒杀系统，通过引入消息队列，可以有效缓冲突发流量，达到削峰填谷的作用。</p><h2 id=安装>安装</h2><p>Docker 安装方式如下：</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>docker run -d --name rabbitmq -p 5672:5672 -p 15672:15672 rabbitmq:3-management
</span></span></code></pre></div><p>RabbitMQ 有属于自己的一套核心概念，对这些概念的理解很重要，只有理解了这些核心概念，才有可能建立对 RabbitMQ 的全面理解：</p><h2 id=rabbitmq核心概念>RabbitMQ核心概念</h2><h3 id=broker>Broker</h3><p>Broker 概念比较简单，我们可以把 Broker 理解为一个 RabitMQ Server。</p><h3 id=producer-与-consumer>Producer 与 Consumer</h3><p>生产者与消费者相对于 RabbitMQ 服务器来说，都是 RabbitMQ 服务器的客户端。</p><ul><li>生产者 (Producer)：连到 RabbitMQ 服务器，将消息发送到 RabbitMQ 服务器的队列，是消息的发送方。</li><li>消费者 (Consumer)：连接到 RabbitMQ 则是为了消费队列中的消息，是消息的接收方。</li></ul><p>生产者与消费者一般由我们的应用程序充当。</p><h3 id=connection>Connection</h3><p>Connection 是 RabbitMQ 内部对象之一，用于管理每个到 RabbitMQ 的 TCP 网络连接。</p><h3 id=channel>Channel</h3><p>Channel 是我们与 RabbitMQ 打交道的最重要的一个接口，我们大部分的业务操作是在 Channel 这个接口中完成的，包括定义 Queue、定义 Exchange、绑定 Queue 与 Exchange、发布消息等。</p><h3 id=exchnage>Exchnage</h3><p>消息交换机，作用是接收来自生产者的消息，并根据路由键转发消息到所绑定的队列。</p><p>生产者发送上的消息，就是先通过 Exchnage 按照绑定 (binding) 规则转发到队列的。</p><p>交换机类型 (Exchange Type) 有四种：fanout、direct、topic，headers，其中 headers 并不常用。</p><ul><li>fanout：这种类型不处理路由键 (RoutingKey)，很像子网广播，每台子网内的主机都获得了一份复制的消息，发布 / 订阅模式就是指使用 fanout 交换机类型，fanout 类型交换机转发消息是最快的。</li><li>direct：模式处理路由键，需要路由键完全匹配的队列才能收到消息，路由模式使用的是 direct 类型的交换机。</li><li>topic：将路由键和某模式进行匹配。主题模式使用的是 topic 类型的交换机。</li></ul><blockquote><p>路由模式，发布订阅模式，主题模式，这些工作模式我们下面会讲。</p></blockquote><p><img src=/images/4ec0abac-6b64-4401-b5a0-d538e4121932.png alt></p><h3 id=queue>Queue</h3><p>Queue 即队列，RabbitMQ 内部用于存储消息的对象，是真正用存储消息的结构，在生产端，生产者的消息最终发送到指定队列，而消费者也是通过订阅某个队列，达到获取消息的目的。</p><h3 id=binding>Binding</h3><p>Binding 是一种操作，其作用是建立消息从 Exchange 转发到 Queue 的规则，在进行 Exchange 与 Queue 的绑定时，需要指定一个 BindingKey，Binding 操作一般用于 RabbitMQ 的路由工作模式和主题工作模式。</p><blockquote><p>BindingKey 的概念，下面在讲 RabbitMQ 的工作模式会详细讲解。</p></blockquote><h3 id=virtual-host>Virtual Host</h3><p>Virutal host 也叫虚拟主机，一个 VirtualHost 下面有一组不同 Exchnage 与 Queue，不同的 Virtual host 的 Exchnage 与 Queue 之间互相不影响。应用隔离与权限划分，Virtual host 是 RabbitMQ 中最小颗粒的权限单位划分。</p><p>如果要类比的话，我们可以把 Virtual host 比作 MySQL 中的数据库，通常我们在使用 MySQL 时，会为不同的项目指定不同的数据库，同样的，在使用 RabbitMQ 时，我们可以为不同的应用程序指定不同的 Virtual host。</p><p><img src=/images/4ee9330b-d0fc-4dc9-bc74-e05fb06d40c7.png alt></p><p>请参考：<a href=https://www.rabbitmq.com/getstarted.html>www.rabbitmq.com/getstarted.…</a></p><h2 id=简单-simple-模式>简单 (simple) 模式</h2><p>simple 模式，是 RabbitMQ 几种模式中最简单的一种模式，其结构如下图所示：</p><p><img src=/images/6f7e393f-d4c7-406b-a1c2-221319cadf7f.png alt></p><p>从上面的示意图，我们可以看出<code>simple</code>模式有以下几个特征：</p><ul><li>只有一个生产者、一个消费者和一个队列。</li><li>生产者和消费者在发送和接收消息时，只需要指定队列名，而不需要指定发送到哪个 Exchange，RabbitMQ 服务器会自动使用 Virtual host 的默认的 Exchange，默认 Exchange 的 type 为 direct。</li></ul><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#75af00>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 引入amqo包</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>(</span>
</span></span><span style=display:flex><span>	<span style=color:#d88200>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#d88200>&#34;github.com/streadway/amqp&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#d88200>&#34;log&#34;</span>
</span></span><span style=display:flex><span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>const</span> <span style=color:#111>(</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>LOGIN</span> <span style=color:#00a8c8>string</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;zhaohaiyu&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>PASSWORD</span> <span style=color:#00a8c8>string</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;zhy.1996&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>HOST</span> <span style=color:#00a8c8>string</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;127.0.0.1&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>PORT</span> <span style=color:#00a8c8>string</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;5672&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>VIRTUALHOST</span> <span style=color:#00a8c8>string</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;/&#34;</span>
</span></span><span style=display:flex><span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>Pushlish</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 创建链接</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>url</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Sprintf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;amqp://%s:%s@%s:%s%s&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>LOGIN</span><span style=color:#111>,</span> <span style=color:#75af00>PASSWORD</span><span style=color:#111>,</span> <span style=color:#75af00>HOST</span><span style=color:#111>,</span> <span style=color:#75af00>PORT</span><span style=color:#111>,</span> <span style=color:#75af00>VIRTUALHOST</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>conn</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>amqp</span><span style=color:#111>.</span><span style=color:#75af00>Dial</span><span style=color:#111>(</span><span style=color:#75af00>url</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>failOnError</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;Failed to connect to RabbitMQ&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>defer</span> <span style=color:#75af00>conn</span><span style=color:#111>.</span><span style=color:#75af00>Close</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 打开一个通道</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>ch</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>conn</span><span style=color:#111>.</span><span style=color:#75af00>Channel</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>failOnError</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;Failed to open a channel&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>defer</span> <span style=color:#75af00>ch</span><span style=color:#111>.</span><span style=color:#75af00>Close</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 生成一个交换机（交换机不存在的情况下）</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>err</span> <span style=color:#111>=</span> <span style=color:#75af00>ch</span><span style=color:#111>.</span><span style=color:#75af00>ExchangeDeclare</span><span style=color:#111>(</span><span style=color:#d88200>&#34;test&#34;</span><span style=color:#111>,</span><span style=color:#d88200>&#34;direct&#34;</span><span style=color:#111>,</span> <span style=color:#00a8c8>true</span><span style=color:#111>,</span><span style=color:#00a8c8>false</span><span style=color:#111>,</span><span style=color:#00a8c8>false</span><span style=color:#111>,</span> <span style=color:#00a8c8>false</span><span style=color:#111>,</span> <span style=color:#00a8c8>nil</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>failOnError</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;Failed to declare an exchange&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 生成一个队列队列（队列不存在的情况下）</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>_</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#111>=</span> <span style=color:#75af00>ch</span><span style=color:#111>.</span><span style=color:#75af00>QueueDeclare</span><span style=color:#111>(</span><span style=color:#d88200>&#34;test1&#34;</span><span style=color:#111>,</span> <span style=color:#00a8c8>true</span><span style=color:#111>,</span> <span style=color:#00a8c8>false</span><span style=color:#111>,</span> <span style=color:#00a8c8>false</span><span style=color:#111>,</span> <span style=color:#00a8c8>false</span><span style=color:#111>,</span> <span style=color:#00a8c8>nil</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>failOnError</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;Failed to declare an queue&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>//列队与交换机绑定</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>err</span> <span style=color:#111>=</span> <span style=color:#75af00>ch</span><span style=color:#111>.</span><span style=color:#75af00>QueueBind</span><span style=color:#111>(</span><span style=color:#d88200>&#34;test1&#34;</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;zhaohaiyu&#34;</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;test&#34;</span><span style=color:#111>,</span> <span style=color:#00a8c8>false</span><span style=color:#111>,</span> <span style=color:#00a8c8>nil</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>failOnError</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;Bind queue to exchange failure&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>//指定交换机发布消息</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>err</span> <span style=color:#111>=</span> <span style=color:#75af00>ch</span><span style=color:#111>.</span><span style=color:#75af00>Publish</span><span style=color:#111>(</span><span style=color:#d88200>&#34;test&#34;</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;zhaohaiyu&#34;</span><span style=color:#111>,</span> <span style=color:#00a8c8>false</span><span style=color:#111>,</span> <span style=color:#00a8c8>false</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>amqp</span><span style=color:#111>.</span><span style=color:#75af00>Publishing</span><span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>ContentType</span><span style=color:#111>:</span> <span style=color:#d88200>&#34;text/plain&#34;</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>Body</span><span style=color:#111>:</span>        <span style=color:#111>[]</span><span style=color:#111>byte</span><span style=color:#111>(</span><span style=color:#d88200>&#34;生产者测试1&#34;</span><span style=color:#111>),</span>
</span></span><span style=display:flex><span>		<span style=color:#111>})</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>failOnError</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;Message publish failure&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>Get</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 创建链接</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>url</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Sprintf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;amqp://%s:%s@%s:%s%s&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>LOGIN</span><span style=color:#111>,</span> <span style=color:#75af00>PASSWORD</span><span style=color:#111>,</span> <span style=color:#75af00>HOST</span><span style=color:#111>,</span> <span style=color:#75af00>PORT</span><span style=color:#111>,</span> <span style=color:#75af00>VIRTUALHOST</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>conn</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>amqp</span><span style=color:#111>.</span><span style=color:#75af00>Dial</span><span style=color:#111>(</span><span style=color:#75af00>url</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>failOnError</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;Failed to connect to RabbitMQ&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>defer</span> <span style=color:#75af00>conn</span><span style=color:#111>.</span><span style=color:#75af00>Close</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 打开一个通道</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>ch</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>conn</span><span style=color:#111>.</span><span style=color:#75af00>Channel</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>failOnError</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;Failed to open a channel&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>defer</span> <span style=color:#75af00>ch</span><span style=color:#111>.</span><span style=color:#75af00>Close</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 指定队列获取消息</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>msg</span><span style=color:#111>,</span> <span style=color:#75af00>ok</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>ch</span><span style=color:#111>.</span><span style=color:#75af00>Get</span><span style=color:#111>(</span><span style=color:#d88200>&#34;test1&#34;</span><span style=color:#111>,</span> <span style=color:#00a8c8>true</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>failOnError</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;Message empty&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Println</span><span style=color:#111>(</span><span style=color:#111>string</span><span style=color:#111>(</span><span style=color:#75af00>msg</span><span style=color:#111>.</span><span style=color:#75af00>Body</span><span style=color:#111>),</span> <span style=color:#75af00>ok</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>failOnError</span><span style=color:#111>(</span><span style=color:#75af00>err</span> <span style=color:#00a8c8>error</span><span style=color:#111>,</span> <span style=color:#75af00>msg</span> <span style=color:#00a8c8>string</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>log</span><span style=color:#111>.</span><span style=color:#75af00>Fatalf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;%s: %s&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>msg</span><span style=color:#111>,</span> <span style=color:#75af00>err</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>main</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>Pushlish</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>Get</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e>结果：产者测试1 true
</span></span></span><span style=display:flex><span><span style=color:#75715e>*/</span>
</span></span></code></pre></div><h2 id=工作-work-模式>工作 (work) 模式</h2><p>在 simple 模式下只有一个生产者和消费者，当生产者生产消息的速度大于消费者的消费速度时，我们可以添加一个或多个消费者来加快消费速度，这种在 simple 模式下增加消费者的模式，称为 work 模式，如下图所示：</p><p><img src=/images/21606601-f4d0-4f45-a1e6-f5416d66f646.png alt></p><p>work 模式有以下两个特征：</p><ul><li>可以有多个消费者，但一条消息只能被一个消费者获取。</li><li>发送到队列中的消息，由服务器平均分配给不同消费者进行消费</li></ul><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#75af00>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 引入amqo包</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>(</span>
</span></span><span style=display:flex><span>	<span style=color:#d88200>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#d88200>&#34;github.com/streadway/amqp&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#d88200>&#34;log&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#d88200>&#34;time&#34;</span>
</span></span><span style=display:flex><span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>const</span> <span style=color:#111>(</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>LOGIN</span> <span style=color:#00a8c8>string</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;zhaohaiyu&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>PASSWORD</span> <span style=color:#00a8c8>string</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;zhy.1996&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>HOST</span> <span style=color:#00a8c8>string</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;127.0.0.1&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>PORT</span> <span style=color:#00a8c8>string</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;5672&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>VIRTUALHOST</span> <span style=color:#00a8c8>string</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;/&#34;</span>
</span></span><span style=display:flex><span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>Pushlish</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 创建链接</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>url</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Sprintf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;amqp://%s:%s@%s:%s%s&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>LOGIN</span><span style=color:#111>,</span> <span style=color:#75af00>PASSWORD</span><span style=color:#111>,</span> <span style=color:#75af00>HOST</span><span style=color:#111>,</span> <span style=color:#75af00>PORT</span><span style=color:#111>,</span> <span style=color:#75af00>VIRTUALHOST</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>conn</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>amqp</span><span style=color:#111>.</span><span style=color:#75af00>Dial</span><span style=color:#111>(</span><span style=color:#75af00>url</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>failOnError</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;Failed to connect to RabbitMQ&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>defer</span> <span style=color:#75af00>conn</span><span style=color:#111>.</span><span style=color:#75af00>Close</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 打开一个通道</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>ch</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>conn</span><span style=color:#111>.</span><span style=color:#75af00>Channel</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>failOnError</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;Failed to open a channel&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>defer</span> <span style=color:#75af00>ch</span><span style=color:#111>.</span><span style=color:#75af00>Close</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 生成一个交换机（交换机不存在的情况下）</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>err</span> <span style=color:#111>=</span> <span style=color:#75af00>ch</span><span style=color:#111>.</span><span style=color:#75af00>ExchangeDeclare</span><span style=color:#111>(</span><span style=color:#d88200>&#34;test&#34;</span><span style=color:#111>,</span><span style=color:#d88200>&#34;direct&#34;</span><span style=color:#111>,</span> <span style=color:#00a8c8>true</span><span style=color:#111>,</span><span style=color:#00a8c8>false</span><span style=color:#111>,</span><span style=color:#00a8c8>false</span><span style=color:#111>,</span> <span style=color:#00a8c8>false</span><span style=color:#111>,</span> <span style=color:#00a8c8>nil</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>failOnError</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;Failed to declare an exchange&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 生成一个队列队列（队列不存在的情况下）</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>_</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#111>=</span> <span style=color:#75af00>ch</span><span style=color:#111>.</span><span style=color:#75af00>QueueDeclare</span><span style=color:#111>(</span><span style=color:#d88200>&#34;test1&#34;</span><span style=color:#111>,</span> <span style=color:#00a8c8>true</span><span style=color:#111>,</span> <span style=color:#00a8c8>false</span><span style=color:#111>,</span> <span style=color:#00a8c8>false</span><span style=color:#111>,</span> <span style=color:#00a8c8>false</span><span style=color:#111>,</span> <span style=color:#00a8c8>nil</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>failOnError</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;Failed to declare an queue&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>//列队与交换机绑定</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>err</span> <span style=color:#111>=</span> <span style=color:#75af00>ch</span><span style=color:#111>.</span><span style=color:#75af00>QueueBind</span><span style=color:#111>(</span><span style=color:#d88200>&#34;test1&#34;</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;zhaohaiyu&#34;</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;test&#34;</span><span style=color:#111>,</span> <span style=color:#00a8c8>false</span><span style=color:#111>,</span> <span style=color:#00a8c8>nil</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>failOnError</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;Bind queue to exchange failure&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>//指定交换机发布消息</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>for</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>time</span><span style=color:#111>.</span><span style=color:#75af00>Sleep</span><span style=color:#111>(</span><span style=color:#75af00>time</span><span style=color:#111>.</span><span style=color:#75af00>Second</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>err</span> <span style=color:#111>=</span> <span style=color:#75af00>ch</span><span style=color:#111>.</span><span style=color:#75af00>Publish</span><span style=color:#111>(</span><span style=color:#d88200>&#34;test&#34;</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;zhaohaiyu&#34;</span><span style=color:#111>,</span> <span style=color:#00a8c8>false</span><span style=color:#111>,</span> <span style=color:#00a8c8>false</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>amqp</span><span style=color:#111>.</span><span style=color:#75af00>Publishing</span><span style=color:#111>{</span>
</span></span><span style=display:flex><span>				<span style=color:#75af00>ContentType</span><span style=color:#111>:</span> <span style=color:#d88200>&#34;text/plain&#34;</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>				<span style=color:#75af00>Body</span><span style=color:#111>:</span>        <span style=color:#111>[]</span><span style=color:#111>byte</span><span style=color:#111>(</span><span style=color:#d88200>&#34;生产者测试1&#34;</span><span style=color:#111>),</span>
</span></span><span style=display:flex><span>			<span style=color:#111>})</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>failOnError</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;Message publish failure&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>Get1</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 创建链接</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>url</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Sprintf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;amqp://%s:%s@%s:%s%s&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>LOGIN</span><span style=color:#111>,</span> <span style=color:#75af00>PASSWORD</span><span style=color:#111>,</span> <span style=color:#75af00>HOST</span><span style=color:#111>,</span> <span style=color:#75af00>PORT</span><span style=color:#111>,</span> <span style=color:#75af00>VIRTUALHOST</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>conn</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>amqp</span><span style=color:#111>.</span><span style=color:#75af00>Dial</span><span style=color:#111>(</span><span style=color:#75af00>url</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>failOnError</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;Failed to connect to RabbitMQ&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>defer</span> <span style=color:#75af00>conn</span><span style=color:#111>.</span><span style=color:#75af00>Close</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 打开一个通道</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>ch</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>conn</span><span style=color:#111>.</span><span style=color:#75af00>Channel</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>failOnError</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;Failed to open a channel&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>defer</span> <span style=color:#75af00>ch</span><span style=color:#111>.</span><span style=color:#75af00>Close</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 指定队列获取消息</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>for</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>time</span><span style=color:#111>.</span><span style=color:#75af00>Sleep</span><span style=color:#111>(</span><span style=color:#75af00>time</span><span style=color:#111>.</span><span style=color:#75af00>Second</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>msg</span><span style=color:#111>,</span> <span style=color:#75af00>ok</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>ch</span><span style=color:#111>.</span><span style=color:#75af00>Get</span><span style=color:#111>(</span><span style=color:#d88200>&#34;test1&#34;</span><span style=color:#111>,</span> <span style=color:#00a8c8>true</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>failOnError</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;Message empty&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Println</span><span style=color:#111>(</span><span style=color:#d88200>&#34;Get1&#34;</span><span style=color:#111>,</span> <span style=color:#111>string</span><span style=color:#111>(</span><span style=color:#75af00>msg</span><span style=color:#111>.</span><span style=color:#75af00>Body</span><span style=color:#111>),</span> <span style=color:#75af00>ok</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>Get2</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 创建链接</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>url</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Sprintf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;amqp://%s:%s@%s:%s%s&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>LOGIN</span><span style=color:#111>,</span> <span style=color:#75af00>PASSWORD</span><span style=color:#111>,</span> <span style=color:#75af00>HOST</span><span style=color:#111>,</span> <span style=color:#75af00>PORT</span><span style=color:#111>,</span> <span style=color:#75af00>VIRTUALHOST</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>conn</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>amqp</span><span style=color:#111>.</span><span style=color:#75af00>Dial</span><span style=color:#111>(</span><span style=color:#75af00>url</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>failOnError</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;Failed to connect to RabbitMQ&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>defer</span> <span style=color:#75af00>conn</span><span style=color:#111>.</span><span style=color:#75af00>Close</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 打开一个通道</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>ch</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>conn</span><span style=color:#111>.</span><span style=color:#75af00>Channel</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>failOnError</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;Failed to open a channel&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>defer</span> <span style=color:#75af00>ch</span><span style=color:#111>.</span><span style=color:#75af00>Close</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 指定队列获取消息</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>for</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>time</span><span style=color:#111>.</span><span style=color:#75af00>Sleep</span><span style=color:#111>(</span><span style=color:#75af00>time</span><span style=color:#111>.</span><span style=color:#75af00>Second</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>msg</span><span style=color:#111>,</span> <span style=color:#75af00>ok</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>ch</span><span style=color:#111>.</span><span style=color:#75af00>Get</span><span style=color:#111>(</span><span style=color:#d88200>&#34;test1&#34;</span><span style=color:#111>,</span> <span style=color:#00a8c8>true</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>failOnError</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;Message empty&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Println</span><span style=color:#111>(</span><span style=color:#d88200>&#34;Get2&#34;</span><span style=color:#111>,</span> <span style=color:#111>string</span><span style=color:#111>(</span><span style=color:#75af00>msg</span><span style=color:#111>.</span><span style=color:#75af00>Body</span><span style=color:#111>),</span> <span style=color:#75af00>ok</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>failOnError</span><span style=color:#111>(</span><span style=color:#75af00>err</span> <span style=color:#00a8c8>error</span><span style=color:#111>,</span> <span style=color:#75af00>msg</span> <span style=color:#00a8c8>string</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>log</span><span style=color:#111>.</span><span style=color:#75af00>Fatalf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;%s: %s&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>msg</span><span style=color:#111>,</span> <span style=color:#75af00>err</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>main</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>go</span> <span style=color:#75af00>Pushlish</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>go</span> <span style=color:#75af00>Get1</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>go</span> <span style=color:#75af00>Get2</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>time</span><span style=color:#111>.</span><span style=color:#75af00>Sleep</span><span style=color:#111>(</span><span style=color:#75af00>time</span><span style=color:#111>.</span><span style=color:#75af00>Second</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>20</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e>结果：Get1  false
</span></span></span><span style=display:flex><span><span style=color:#75715e>Get2 生产者测试1 true
</span></span></span><span style=display:flex><span><span style=color:#75715e>Get2  false
</span></span></span><span style=display:flex><span><span style=color:#75715e>Get1 生产者测试1 true
</span></span></span><span style=display:flex><span><span style=color:#75715e>Get1  false
</span></span></span><span style=display:flex><span><span style=color:#75715e>Get2 生产者测试1 true
</span></span></span><span style=display:flex><span><span style=color:#75715e>Get2  false
</span></span></span><span style=display:flex><span><span style=color:#75715e>Get1 生产者测试1 true
</span></span></span><span style=display:flex><span><span style=color:#75715e>Get1 生产者测试1 true
</span></span></span><span style=display:flex><span><span style=color:#75715e>Get2  false
</span></span></span><span style=display:flex><span><span style=color:#75715e>Get2  false
</span></span></span><span style=display:flex><span><span style=color:#75715e>Get1 生产者测试1 true
</span></span></span><span style=display:flex><span><span style=color:#75715e>Get2  false
</span></span></span><span style=display:flex><span><span style=color:#75715e>Get1 生产者测试1 true
</span></span></span><span style=display:flex><span><span style=color:#75715e>Get2  false
</span></span></span><span style=display:flex><span><span style=color:#75715e>Get1 生产者测试1 true
</span></span></span><span style=display:flex><span><span style=color:#75715e>Get1 生产者测试1 true
</span></span></span><span style=display:flex><span><span style=color:#75715e>Get2  false
</span></span></span><span style=display:flex><span><span style=color:#75715e>Get2  false
</span></span></span><span style=display:flex><span><span style=color:#75715e>Get1 生产者测试1 true
</span></span></span><span style=display:flex><span><span style=color:#75715e>Get1 生产者测试1 true
</span></span></span><span style=display:flex><span><span style=color:#75715e>Get2  false
</span></span></span><span style=display:flex><span><span style=color:#75715e>Get1 生产者测试1 true
</span></span></span><span style=display:flex><span><span style=color:#75715e>Get2  false
</span></span></span><span style=display:flex><span><span style=color:#75715e>Get2  false
</span></span></span><span style=display:flex><span><span style=color:#75715e>Get1 生产者测试1 true
</span></span></span><span style=display:flex><span><span style=color:#75715e>Get2  false
</span></span></span><span style=display:flex><span><span style=color:#75715e>Get1 生产者测试1 true
</span></span></span><span style=display:flex><span><span style=color:#75715e>Get1 生产者测试1 true
</span></span></span><span style=display:flex><span><span style=color:#75715e>Get2  false
</span></span></span><span style=display:flex><span><span style=color:#75715e>Get1 生产者测试1 true
</span></span></span><span style=display:flex><span><span style=color:#75715e>Get2  false
</span></span></span><span style=display:flex><span><span style=color:#75715e>Get2 生产者测试1 true
</span></span></span><span style=display:flex><span><span style=color:#75715e>Get1  false
</span></span></span><span style=display:flex><span><span style=color:#75715e>Get2  false
</span></span></span><span style=display:flex><span><span style=color:#75715e>Get1 生产者测试1 true
</span></span></span><span style=display:flex><span><span style=color:#75715e>Get1 生产者测试1 true
</span></span></span><span style=display:flex><span><span style=color:#75715e>Get2  false
</span></span></span><span style=display:flex><span><span style=color:#75715e>*/</span>
</span></span></code></pre></div><h2 id=发布--订阅-pubsub-模式>发布 / 订阅 (pub/sub) 模式</h2><p>work 模式可以将消息转到多个消费者，但每条消息只能由一个消费者获取，如果我们想一条消息可以同时给多个消费者消费呢？</p><p>这时候就需要发布 / 订阅模式，其示意图如下所示：</p><p><img src=/images/86400d5c-7cc7-4170-ac4a-4aea2aa15fa8.png alt></p><p>从上面的示意图我们可以看出来，在发布 / 订阅模式下，需要指定发送到哪个 Exchange 中，上面图中的 X 表示 Exchange。</p><ul><li>发布 / 订阅模式中，Echange 的 type 为 fanout。</li><li>生产者发送消息时，不需要指定具体的队列名，Exchange 会将收到的消息转发到所绑定的队列。</li><li>消息被 Exchange 转到多个队列，一条消息可以被多个消费者获取。</li></ul><p>在上图中，oneQueue 中的消息要么被 CustomerA 获取，要么被 CustomerB 获取。也就是同一条消息，要么是 CustomerA + CustomerC 消费、要么是 CustomerB + CustomerC 消费。</p><p>生产者：</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#75af00>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>(</span>
</span></span><span style=display:flex><span>	<span style=color:#d88200>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#d88200>&#34;github.com/streadway/amqp&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#d88200>&#34;log&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#d88200>&#34;os&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#d88200>&#34;strings&#34;</span>
</span></span><span style=display:flex><span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>const</span> <span style=color:#111>(</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>LOGIN</span> <span style=color:#00a8c8>string</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;zhaohaiyu&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>PASSWORD</span> <span style=color:#00a8c8>string</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;zhy.1996&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>HOST</span> <span style=color:#00a8c8>string</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;127.0.0.1&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>PORT</span> <span style=color:#00a8c8>string</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;5672&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>VIRTUALHOST</span> <span style=color:#00a8c8>string</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;/&#34;</span>
</span></span><span style=display:flex><span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>//url := fmt.Sprintf()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>failOnError</span><span style=color:#111>(</span><span style=color:#75af00>err</span> <span style=color:#00a8c8>error</span><span style=color:#111>,</span> <span style=color:#75af00>msg</span> <span style=color:#00a8c8>string</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>log</span><span style=color:#111>.</span><span style=color:#75af00>Fatalf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;%s: %s&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>msg</span><span style=color:#111>,</span> <span style=color:#75af00>err</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>main</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>conn</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>amqp</span><span style=color:#111>.</span><span style=color:#75af00>Dial</span><span style=color:#111>(</span><span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Sprintf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;amqp://%s:%s@%s:%s%s&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>LOGIN</span><span style=color:#111>,</span> <span style=color:#75af00>PASSWORD</span><span style=color:#111>,</span> <span style=color:#75af00>HOST</span><span style=color:#111>,</span> <span style=color:#75af00>PORT</span><span style=color:#111>,</span> <span style=color:#75af00>VIRTUALHOST</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>failOnError</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;Failed to connect to RabbitMQ&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>defer</span> <span style=color:#75af00>conn</span><span style=color:#111>.</span><span style=color:#75af00>Close</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>ch</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>conn</span><span style=color:#111>.</span><span style=color:#75af00>Channel</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>failOnError</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;Failed to open a channel&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>defer</span> <span style=color:#75af00>ch</span><span style=color:#111>.</span><span style=color:#75af00>Close</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>err</span> <span style=color:#111>=</span> <span style=color:#75af00>ch</span><span style=color:#111>.</span><span style=color:#75af00>ExchangeDeclare</span><span style=color:#111>(</span>
</span></span><span style=display:flex><span>		<span style=color:#d88200>&#34;logs&#34;</span><span style=color:#111>,</span>   <span style=color:#75715e>// name</span>
</span></span><span style=display:flex><span>		<span style=color:#d88200>&#34;fanout&#34;</span><span style=color:#111>,</span> <span style=color:#75715e>// type</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>true</span><span style=color:#111>,</span>     <span style=color:#75715e>// durable</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>false</span><span style=color:#111>,</span>    <span style=color:#75715e>// auto-deleted</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>false</span><span style=color:#111>,</span>    <span style=color:#75715e>// internal</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>false</span><span style=color:#111>,</span>    <span style=color:#75715e>// no-wait</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>nil</span><span style=color:#111>,</span>      <span style=color:#75715e>// arguments</span>
</span></span><span style=display:flex><span>	<span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>failOnError</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;Failed to declare an exchange&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>body</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>bodyFrom</span><span style=color:#111>(</span><span style=color:#75af00>os</span><span style=color:#111>.</span><span style=color:#75af00>Args</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>err</span> <span style=color:#111>=</span> <span style=color:#75af00>ch</span><span style=color:#111>.</span><span style=color:#75af00>Publish</span><span style=color:#111>(</span>
</span></span><span style=display:flex><span>		<span style=color:#d88200>&#34;logs&#34;</span><span style=color:#111>,</span> <span style=color:#75715e>// exchange</span>
</span></span><span style=display:flex><span>		<span style=color:#d88200>&#34;&#34;</span><span style=color:#111>,</span>     <span style=color:#75715e>// routing key</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>false</span><span style=color:#111>,</span>  <span style=color:#75715e>// mandatory</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>false</span><span style=color:#111>,</span>  <span style=color:#75715e>// immediate</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>amqp</span><span style=color:#111>.</span><span style=color:#75af00>Publishing</span><span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>ContentType</span><span style=color:#111>:</span> <span style=color:#d88200>&#34;text/plain&#34;</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>Body</span><span style=color:#111>:</span>        <span style=color:#111>[]</span><span style=color:#111>byte</span><span style=color:#111>(</span><span style=color:#75af00>body</span><span style=color:#111>),</span>
</span></span><span style=display:flex><span>		<span style=color:#111>})</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>failOnError</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;Failed to publish a message&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>log</span><span style=color:#111>.</span><span style=color:#75af00>Printf</span><span style=color:#111>(</span><span style=color:#d88200>&#34; [x] Sent %s&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>body</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>bodyFrom</span><span style=color:#111>(</span><span style=color:#75af00>args</span> <span style=color:#111>[]</span><span style=color:#00a8c8>string</span><span style=color:#111>)</span> <span style=color:#00a8c8>string</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>var</span> <span style=color:#75af00>s</span> <span style=color:#00a8c8>string</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#75af00>args</span><span style=color:#111>)</span> <span style=color:#111>&lt;</span> <span style=color:#ae81ff>2</span><span style=color:#111>)</span> <span style=color:#f92672>||</span> <span style=color:#75af00>os</span><span style=color:#111>.</span><span style=color:#75af00>Args</span><span style=color:#111>[</span><span style=color:#ae81ff>1</span><span style=color:#111>]</span> <span style=color:#f92672>==</span> <span style=color:#d88200>&#34;&#34;</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>s</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;hello&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span> <span style=color:#00a8c8>else</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>s</span> <span style=color:#111>=</span> <span style=color:#75af00>strings</span><span style=color:#111>.</span><span style=color:#75af00>Join</span><span style=color:#111>(</span><span style=color:#75af00>args</span><span style=color:#111>[</span><span style=color:#ae81ff>1</span><span style=color:#111>:],</span> <span style=color:#d88200>&#34; &#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>return</span> <span style=color:#75af00>s</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><p>不同的 Exchange 之间互不影响，相同 Exchange，相同队列的情况下，消息均等消费：</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#75af00>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>(</span>
</span></span><span style=display:flex><span>	<span style=color:#d88200>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#d88200>&#34;github.com/streadway/amqp&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#d88200>&#34;log&#34;</span>
</span></span><span style=display:flex><span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>const</span> <span style=color:#111>(</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>LOGIN</span> <span style=color:#00a8c8>string</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;zhaohaiyu&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>PASSWORD</span> <span style=color:#00a8c8>string</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;zhy.1996&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>HOST</span> <span style=color:#00a8c8>string</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;127.0.0.1&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>PORT</span> <span style=color:#00a8c8>string</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;5672&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>VIRTUALHOST</span> <span style=color:#00a8c8>string</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;/&#34;</span>
</span></span><span style=display:flex><span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>failOnError</span><span style=color:#111>(</span><span style=color:#75af00>err</span> <span style=color:#00a8c8>error</span><span style=color:#111>,</span> <span style=color:#75af00>msg</span> <span style=color:#00a8c8>string</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>log</span><span style=color:#111>.</span><span style=color:#75af00>Fatalf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;%s: %s&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>msg</span><span style=color:#111>,</span> <span style=color:#75af00>err</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>main</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>conn</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>amqp</span><span style=color:#111>.</span><span style=color:#75af00>Dial</span><span style=color:#111>(</span><span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Sprintf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;amqp://%s:%s@%s:%s%s&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>LOGIN</span><span style=color:#111>,</span> <span style=color:#75af00>PASSWORD</span><span style=color:#111>,</span> <span style=color:#75af00>HOST</span><span style=color:#111>,</span> <span style=color:#75af00>PORT</span><span style=color:#111>,</span> <span style=color:#75af00>VIRTUALHOST</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>failOnError</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;Failed to connect to RabbitMQ&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>defer</span> <span style=color:#75af00>conn</span><span style=color:#111>.</span><span style=color:#75af00>Close</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>ch</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>conn</span><span style=color:#111>.</span><span style=color:#75af00>Channel</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>failOnError</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;Failed to open a channel&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>defer</span> <span style=color:#75af00>ch</span><span style=color:#111>.</span><span style=color:#75af00>Close</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>err</span> <span style=color:#111>=</span> <span style=color:#75af00>ch</span><span style=color:#111>.</span><span style=color:#75af00>ExchangeDeclare</span><span style=color:#111>(</span>
</span></span><span style=display:flex><span>		<span style=color:#d88200>&#34;logs&#34;</span><span style=color:#111>,</span>   <span style=color:#75715e>// name</span>
</span></span><span style=display:flex><span>		<span style=color:#d88200>&#34;fanout&#34;</span><span style=color:#111>,</span> <span style=color:#75715e>// type</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>true</span><span style=color:#111>,</span>     <span style=color:#75715e>// durable</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>false</span><span style=color:#111>,</span>    <span style=color:#75715e>// auto-deleted</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>false</span><span style=color:#111>,</span>    <span style=color:#75715e>// internal</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>false</span><span style=color:#111>,</span>    <span style=color:#75715e>// no-wait</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>nil</span><span style=color:#111>,</span>      <span style=color:#75715e>// arguments</span>
</span></span><span style=display:flex><span>	<span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>failOnError</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;Failed to declare an exchange&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>q</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>ch</span><span style=color:#111>.</span><span style=color:#75af00>QueueDeclare</span><span style=color:#111>(</span>
</span></span><span style=display:flex><span>		<span style=color:#d88200>&#34;&#34;</span><span style=color:#111>,</span>    <span style=color:#75715e>// name</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>false</span><span style=color:#111>,</span> <span style=color:#75715e>// durable</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>false</span><span style=color:#111>,</span> <span style=color:#75715e>// delete when unused</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>true</span><span style=color:#111>,</span>  <span style=color:#75715e>// exclusive</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>false</span><span style=color:#111>,</span> <span style=color:#75715e>// no-wait</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>nil</span><span style=color:#111>,</span>   <span style=color:#75715e>// arguments</span>
</span></span><span style=display:flex><span>	<span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>failOnError</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;Failed to declare a queue&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>err</span> <span style=color:#111>=</span> <span style=color:#75af00>ch</span><span style=color:#111>.</span><span style=color:#75af00>QueueBind</span><span style=color:#111>(</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>q</span><span style=color:#111>.</span><span style=color:#75af00>Name</span><span style=color:#111>,</span> <span style=color:#75715e>// queue name</span>
</span></span><span style=display:flex><span>		<span style=color:#d88200>&#34;&#34;</span><span style=color:#111>,</span>     <span style=color:#75715e>// routing key</span>
</span></span><span style=display:flex><span>		<span style=color:#d88200>&#34;logs&#34;</span><span style=color:#111>,</span> <span style=color:#75715e>// exchange</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>false</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>nil</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>	<span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>failOnError</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;Failed to bind a queue&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>msgs</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>ch</span><span style=color:#111>.</span><span style=color:#75af00>Consume</span><span style=color:#111>(</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>q</span><span style=color:#111>.</span><span style=color:#75af00>Name</span><span style=color:#111>,</span> <span style=color:#75715e>// queue</span>
</span></span><span style=display:flex><span>		<span style=color:#d88200>&#34;&#34;</span><span style=color:#111>,</span>     <span style=color:#75715e>// consumer</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>true</span><span style=color:#111>,</span>   <span style=color:#75715e>// auto-ack</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>false</span><span style=color:#111>,</span>  <span style=color:#75715e>// exclusive</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>false</span><span style=color:#111>,</span>  <span style=color:#75715e>// no-local</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>false</span><span style=color:#111>,</span>  <span style=color:#75715e>// no-wait</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>nil</span><span style=color:#111>,</span>    <span style=color:#75715e>// args</span>
</span></span><span style=display:flex><span>	<span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>failOnError</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;Failed to register a consumer&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>forever</span> <span style=color:#f92672>:=</span> <span style=color:#111>make</span><span style=color:#111>(</span><span style=color:#00a8c8>chan</span> <span style=color:#00a8c8>bool</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>go</span> <span style=color:#00a8c8>func</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>for</span> <span style=color:#75af00>d</span> <span style=color:#f92672>:=</span> <span style=color:#00a8c8>range</span> <span style=color:#75af00>msgs</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>log</span><span style=color:#111>.</span><span style=color:#75af00>Printf</span><span style=color:#111>(</span><span style=color:#d88200>&#34; [x] %s&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>d</span><span style=color:#111>.</span><span style=color:#75af00>Body</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>log</span><span style=color:#111>.</span><span style=color:#75af00>Printf</span><span style=color:#111>(</span><span style=color:#d88200>&#34; [*] Waiting for logs. To exit press CTRL+C&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;-</span><span style=color:#75af00>forever</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><p>相同 Exchange，不同队列的情况下，一条消息可以被多个消费者获取。</p><h2 id=路由-routing-模式>路由 (routing) 模式</h2><p>前面几种模式，消息的目标队列无法由生产者指定，而在路由模式下，消息的目标队列，可以由生产者指定，其示意图如下所示：</p><p><img src=/images/3e912744-2919-4a56-b42a-87b67d02d096.png alt></p><ul><li>路由模式下<code>Exchange</code>的 type 为<code>direct</code>。</li><li>消息的目标队列可以由生产者按照<code>routingKey</code>规则指定。</li><li>消费者通过<code>BindingKey</code>绑定自己所关心的队列。</li><li>一条消息队可以被多个消息者获取。</li><li>只有<code>RoutingKey</code>与<code>BidingKey</code>相匹配的队列才会收到消息。</li></ul><blockquote><p><code>RoutingKey</code>用于生产者指定<code>Exchange</code>最终将消息路由到哪个队列，<code>BindingKey</code>用于消费者绑定到某个队列。</p></blockquote><p>生产者：</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#75af00>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>(</span>
</span></span><span style=display:flex><span>	<span style=color:#d88200>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#d88200>&#34;log&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#d88200>&#34;os&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#d88200>&#34;strings&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#d88200>&#34;github.com/streadway/amqp&#34;</span>
</span></span><span style=display:flex><span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>const</span> <span style=color:#111>(</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>LOGIN</span> <span style=color:#00a8c8>string</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;zhaohaiyu&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>PASSWORD</span> <span style=color:#00a8c8>string</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;zhy.1996&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>HOST</span> <span style=color:#00a8c8>string</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;127.0.0.1&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>PORT</span> <span style=color:#00a8c8>string</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;5672&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>VIRTUALHOST</span> <span style=color:#00a8c8>string</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;/&#34;</span>
</span></span><span style=display:flex><span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>failOnError</span><span style=color:#111>(</span><span style=color:#75af00>err</span> <span style=color:#00a8c8>error</span><span style=color:#111>,</span> <span style=color:#75af00>msg</span> <span style=color:#00a8c8>string</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>log</span><span style=color:#111>.</span><span style=color:#75af00>Fatalf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;%s: %s&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>msg</span><span style=color:#111>,</span> <span style=color:#75af00>err</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>main</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>conn</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>amqp</span><span style=color:#111>.</span><span style=color:#75af00>Dial</span><span style=color:#111>(</span><span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Sprintf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;amqp://%s:%s@%s:%s%s&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>LOGIN</span><span style=color:#111>,</span> <span style=color:#75af00>PASSWORD</span><span style=color:#111>,</span> <span style=color:#75af00>HOST</span><span style=color:#111>,</span> <span style=color:#75af00>PORT</span><span style=color:#111>,</span> <span style=color:#75af00>VIRTUALHOST</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>failOnError</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;Failed to connect to RabbitMQ&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>defer</span> <span style=color:#75af00>conn</span><span style=color:#111>.</span><span style=color:#75af00>Close</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>ch</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>conn</span><span style=color:#111>.</span><span style=color:#75af00>Channel</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>failOnError</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;Failed to open a channel&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>defer</span> <span style=color:#75af00>ch</span><span style=color:#111>.</span><span style=color:#75af00>Close</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>err</span> <span style=color:#111>=</span> <span style=color:#75af00>ch</span><span style=color:#111>.</span><span style=color:#75af00>ExchangeDeclare</span><span style=color:#111>(</span>
</span></span><span style=display:flex><span>		<span style=color:#d88200>&#34;logs_direct&#34;</span><span style=color:#111>,</span> <span style=color:#75715e>// name</span>
</span></span><span style=display:flex><span>		<span style=color:#d88200>&#34;direct&#34;</span><span style=color:#111>,</span>      <span style=color:#75715e>// type</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>true</span><span style=color:#111>,</span>          <span style=color:#75715e>// durable</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>false</span><span style=color:#111>,</span>         <span style=color:#75715e>// auto-deleted</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>false</span><span style=color:#111>,</span>         <span style=color:#75715e>// internal</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>false</span><span style=color:#111>,</span>         <span style=color:#75715e>// no-wait</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>nil</span><span style=color:#111>,</span>           <span style=color:#75715e>// arguments</span>
</span></span><span style=display:flex><span>	<span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>failOnError</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;Failed to declare an exchange&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>body</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>bodyFrom</span><span style=color:#111>(</span><span style=color:#75af00>os</span><span style=color:#111>.</span><span style=color:#75af00>Args</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>err</span> <span style=color:#111>=</span> <span style=color:#75af00>ch</span><span style=color:#111>.</span><span style=color:#75af00>Publish</span><span style=color:#111>(</span>
</span></span><span style=display:flex><span>		<span style=color:#d88200>&#34;logs_direct&#34;</span><span style=color:#111>,</span>         <span style=color:#75715e>// exchange</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>severityFrom</span><span style=color:#111>(</span><span style=color:#75af00>os</span><span style=color:#111>.</span><span style=color:#75af00>Args</span><span style=color:#111>),</span> <span style=color:#75715e>// routing key</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>false</span><span style=color:#111>,</span> <span style=color:#75715e>// mandatory</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>false</span><span style=color:#111>,</span> <span style=color:#75715e>// immediate</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>amqp</span><span style=color:#111>.</span><span style=color:#75af00>Publishing</span><span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>ContentType</span><span style=color:#111>:</span> <span style=color:#d88200>&#34;text/plain&#34;</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>Body</span><span style=color:#111>:</span>        <span style=color:#111>[]</span><span style=color:#111>byte</span><span style=color:#111>(</span><span style=color:#75af00>body</span><span style=color:#111>),</span>
</span></span><span style=display:flex><span>		<span style=color:#111>})</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>failOnError</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;Failed to publish a message&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>log</span><span style=color:#111>.</span><span style=color:#75af00>Printf</span><span style=color:#111>(</span><span style=color:#d88200>&#34; [x] Sent %s&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>body</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>bodyFrom</span><span style=color:#111>(</span><span style=color:#75af00>args</span> <span style=color:#111>[]</span><span style=color:#00a8c8>string</span><span style=color:#111>)</span> <span style=color:#00a8c8>string</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>var</span> <span style=color:#75af00>s</span> <span style=color:#00a8c8>string</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#75af00>args</span><span style=color:#111>)</span> <span style=color:#111>&lt;</span> <span style=color:#ae81ff>3</span><span style=color:#111>)</span> <span style=color:#f92672>||</span> <span style=color:#75af00>os</span><span style=color:#111>.</span><span style=color:#75af00>Args</span><span style=color:#111>[</span><span style=color:#ae81ff>2</span><span style=color:#111>]</span> <span style=color:#f92672>==</span> <span style=color:#d88200>&#34;&#34;</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>s</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;hello&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span> <span style=color:#00a8c8>else</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>s</span> <span style=color:#111>=</span> <span style=color:#75af00>strings</span><span style=color:#111>.</span><span style=color:#75af00>Join</span><span style=color:#111>(</span><span style=color:#75af00>args</span><span style=color:#111>[</span><span style=color:#ae81ff>2</span><span style=color:#111>:],</span> <span style=color:#d88200>&#34; &#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>return</span> <span style=color:#75af00>s</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>severityFrom</span><span style=color:#111>(</span><span style=color:#75af00>args</span> <span style=color:#111>[]</span><span style=color:#00a8c8>string</span><span style=color:#111>)</span> <span style=color:#00a8c8>string</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>var</span> <span style=color:#75af00>s</span> <span style=color:#00a8c8>string</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#75af00>args</span><span style=color:#111>)</span> <span style=color:#111>&lt;</span> <span style=color:#ae81ff>2</span><span style=color:#111>)</span> <span style=color:#f92672>||</span> <span style=color:#75af00>os</span><span style=color:#111>.</span><span style=color:#75af00>Args</span><span style=color:#111>[</span><span style=color:#ae81ff>1</span><span style=color:#111>]</span> <span style=color:#f92672>==</span> <span style=color:#d88200>&#34;&#34;</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>s</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;info&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span> <span style=color:#00a8c8>else</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>s</span> <span style=color:#111>=</span> <span style=color:#75af00>os</span><span style=color:#111>.</span><span style=color:#75af00>Args</span><span style=color:#111>[</span><span style=color:#ae81ff>1</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>return</span> <span style=color:#75af00>s</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><p>消费者：</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#75af00>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>(</span>
</span></span><span style=display:flex><span>	<span style=color:#d88200>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#d88200>&#34;log&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#d88200>&#34;os&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#d88200>&#34;github.com/streadway/amqp&#34;</span>
</span></span><span style=display:flex><span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>const</span> <span style=color:#111>(</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>LOGIN</span> <span style=color:#00a8c8>string</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;zhaohaiyu&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>PASSWORD</span> <span style=color:#00a8c8>string</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;zhy.1996&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>HOST</span> <span style=color:#00a8c8>string</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;127.0.0.1&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>PORT</span> <span style=color:#00a8c8>string</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;5672&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>VIRTUALHOST</span> <span style=color:#00a8c8>string</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;/&#34;</span>
</span></span><span style=display:flex><span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>failOnError</span><span style=color:#111>(</span><span style=color:#75af00>err</span> <span style=color:#00a8c8>error</span><span style=color:#111>,</span> <span style=color:#75af00>msg</span> <span style=color:#00a8c8>string</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>log</span><span style=color:#111>.</span><span style=color:#75af00>Fatalf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;%s: %s&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>msg</span><span style=color:#111>,</span> <span style=color:#75af00>err</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>main</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>conn</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>amqp</span><span style=color:#111>.</span><span style=color:#75af00>Dial</span><span style=color:#111>(</span><span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Sprintf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;amqp://%s:%s@%s:%s%s&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>LOGIN</span><span style=color:#111>,</span> <span style=color:#75af00>PASSWORD</span><span style=color:#111>,</span> <span style=color:#75af00>HOST</span><span style=color:#111>,</span> <span style=color:#75af00>PORT</span><span style=color:#111>,</span> <span style=color:#75af00>VIRTUALHOST</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>failOnError</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;Failed to connect to RabbitMQ&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>defer</span> <span style=color:#75af00>conn</span><span style=color:#111>.</span><span style=color:#75af00>Close</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>ch</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>conn</span><span style=color:#111>.</span><span style=color:#75af00>Channel</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>failOnError</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;Failed to open a channel&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>defer</span> <span style=color:#75af00>ch</span><span style=color:#111>.</span><span style=color:#75af00>Close</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>err</span> <span style=color:#111>=</span> <span style=color:#75af00>ch</span><span style=color:#111>.</span><span style=color:#75af00>ExchangeDeclare</span><span style=color:#111>(</span>
</span></span><span style=display:flex><span>		<span style=color:#d88200>&#34;logs_direct&#34;</span><span style=color:#111>,</span> <span style=color:#75715e>// name</span>
</span></span><span style=display:flex><span>		<span style=color:#d88200>&#34;direct&#34;</span><span style=color:#111>,</span>      <span style=color:#75715e>// type</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>true</span><span style=color:#111>,</span>          <span style=color:#75715e>// durable</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>false</span><span style=color:#111>,</span>         <span style=color:#75715e>// auto-deleted</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>false</span><span style=color:#111>,</span>         <span style=color:#75715e>// internal</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>false</span><span style=color:#111>,</span>         <span style=color:#75715e>// no-wait</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>nil</span><span style=color:#111>,</span>           <span style=color:#75715e>// arguments</span>
</span></span><span style=display:flex><span>	<span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>failOnError</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;Failed to declare an exchange&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>q</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>ch</span><span style=color:#111>.</span><span style=color:#75af00>QueueDeclare</span><span style=color:#111>(</span>
</span></span><span style=display:flex><span>		<span style=color:#d88200>&#34;&#34;</span><span style=color:#111>,</span>    <span style=color:#75715e>// name</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>false</span><span style=color:#111>,</span> <span style=color:#75715e>// durable</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>false</span><span style=color:#111>,</span> <span style=color:#75715e>// delete when unused</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>true</span><span style=color:#111>,</span>  <span style=color:#75715e>// exclusive</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>false</span><span style=color:#111>,</span> <span style=color:#75715e>// no-wait</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>nil</span><span style=color:#111>,</span>   <span style=color:#75715e>// arguments</span>
</span></span><span style=display:flex><span>	<span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>failOnError</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;Failed to declare a queue&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#75af00>os</span><span style=color:#111>.</span><span style=color:#75af00>Args</span><span style=color:#111>)</span> <span style=color:#111>&lt;</span> <span style=color:#ae81ff>2</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>log</span><span style=color:#111>.</span><span style=color:#75af00>Printf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;Usage: %s [info] [warning] [error]&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>os</span><span style=color:#111>.</span><span style=color:#75af00>Args</span><span style=color:#111>[</span><span style=color:#ae81ff>0</span><span style=color:#111>])</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>os</span><span style=color:#111>.</span><span style=color:#75af00>Exit</span><span style=color:#111>(</span><span style=color:#ae81ff>0</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>for</span> <span style=color:#75af00>_</span><span style=color:#111>,</span> <span style=color:#75af00>s</span> <span style=color:#f92672>:=</span> <span style=color:#00a8c8>range</span> <span style=color:#75af00>os</span><span style=color:#111>.</span><span style=color:#75af00>Args</span><span style=color:#111>[</span><span style=color:#ae81ff>1</span><span style=color:#111>:]</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>log</span><span style=color:#111>.</span><span style=color:#75af00>Printf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;Binding queue %s to exchange %s with routing key %s&#34;</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>q</span><span style=color:#111>.</span><span style=color:#75af00>Name</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;logs_direct&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>s</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>err</span> <span style=color:#111>=</span> <span style=color:#75af00>ch</span><span style=color:#111>.</span><span style=color:#75af00>QueueBind</span><span style=color:#111>(</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>q</span><span style=color:#111>.</span><span style=color:#75af00>Name</span><span style=color:#111>,</span>        <span style=color:#75715e>// queue name</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>s</span><span style=color:#111>,</span>             <span style=color:#75715e>// routing key</span>
</span></span><span style=display:flex><span>			<span style=color:#d88200>&#34;logs_direct&#34;</span><span style=color:#111>,</span> <span style=color:#75715e>// exchange</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>false</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>nil</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>failOnError</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;Failed to bind a queue&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>msgs</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>ch</span><span style=color:#111>.</span><span style=color:#75af00>Consume</span><span style=color:#111>(</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>q</span><span style=color:#111>.</span><span style=color:#75af00>Name</span><span style=color:#111>,</span> <span style=color:#75715e>// queue</span>
</span></span><span style=display:flex><span>		<span style=color:#d88200>&#34;&#34;</span><span style=color:#111>,</span>     <span style=color:#75715e>// consumer</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>true</span><span style=color:#111>,</span>   <span style=color:#75715e>// auto ack</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>false</span><span style=color:#111>,</span>  <span style=color:#75715e>// exclusive</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>false</span><span style=color:#111>,</span>  <span style=color:#75715e>// no local</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>false</span><span style=color:#111>,</span>  <span style=color:#75715e>// no wait</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>nil</span><span style=color:#111>,</span>    <span style=color:#75715e>// args</span>
</span></span><span style=display:flex><span>	<span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>failOnError</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;Failed to register a consumer&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>forever</span> <span style=color:#f92672>:=</span> <span style=color:#111>make</span><span style=color:#111>(</span><span style=color:#00a8c8>chan</span> <span style=color:#00a8c8>bool</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>go</span> <span style=color:#00a8c8>func</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>for</span> <span style=color:#75af00>d</span> <span style=color:#f92672>:=</span> <span style=color:#00a8c8>range</span> <span style=color:#75af00>msgs</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>log</span><span style=color:#111>.</span><span style=color:#75af00>Printf</span><span style=color:#111>(</span><span style=color:#d88200>&#34; [x] %s&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>d</span><span style=color:#111>.</span><span style=color:#75af00>Body</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>log</span><span style=color:#111>.</span><span style=color:#75af00>Printf</span><span style=color:#111>(</span><span style=color:#d88200>&#34; [*] Waiting for logs. To exit press CTRL+C&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;-</span><span style=color:#75af00>forever</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><h2 id=主题-topic-模式>主题 (Topic) 模式</h2><p>主题模式是在路由模式的基础上，将路由键和某模式进行匹配。其中<code>#</code>表示匹配多个词，<code>*</code>表示匹配一个词，消费者可以通过某种模式的 BindKey 来达到订阅某个主题消息的目的，如示意图如下所示：</p><p><img src=/images/f7433c1b-3743-405a-8107-47f918379334.png alt></p><ul><li>主题模式 Exchange 的 type 取值为 topic。</li><li>一条消息可以被多个消费者获取。</li></ul><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#75af00>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>(</span>
</span></span><span style=display:flex><span>	<span style=color:#d88200>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#d88200>&#34;github.com/streadway/amqp&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#d88200>&#34;log&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#d88200>&#34;time&#34;</span>
</span></span><span style=display:flex><span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>const</span> <span style=color:#111>(</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>LOGIN</span>       <span style=color:#00a8c8>string</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;zhaohaiyu&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>PASSWORD</span>    <span style=color:#00a8c8>string</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;zhy.1996&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>HOST</span>        <span style=color:#00a8c8>string</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;127.0.0.1&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>PORT</span>        <span style=color:#00a8c8>string</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;5672&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>VIRTUALHOST</span> <span style=color:#00a8c8>string</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;/&#34;</span>
</span></span><span style=display:flex><span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>publish</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>url</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Sprintf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;amqp://%s:%s@%s:%s%s&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>LOGIN</span><span style=color:#111>,</span> <span style=color:#75af00>PASSWORD</span><span style=color:#111>,</span> <span style=color:#75af00>HOST</span><span style=color:#111>,</span> <span style=color:#75af00>PORT</span><span style=color:#111>,</span> <span style=color:#75af00>VIRTUALHOST</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>conn</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>amqp</span><span style=color:#111>.</span><span style=color:#75af00>Dial</span><span style=color:#111>(</span><span style=color:#75af00>url</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>failOnError</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;Failed to connect to RabbitMQ&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>defer</span> <span style=color:#75af00>conn</span><span style=color:#111>.</span><span style=color:#75af00>Close</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>ch</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>conn</span><span style=color:#111>.</span><span style=color:#75af00>Channel</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>failOnError</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;Failed to open a channel&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>defer</span> <span style=color:#75af00>ch</span><span style=color:#111>.</span><span style=color:#75af00>Close</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>err</span> <span style=color:#111>=</span> <span style=color:#75af00>ch</span><span style=color:#111>.</span><span style=color:#75af00>ExchangeDeclare</span><span style=color:#111>(</span><span style=color:#d88200>&#34;testTopic&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>amqp</span><span style=color:#111>.</span><span style=color:#75af00>ExchangeTopic</span><span style=color:#111>,</span> <span style=color:#00a8c8>true</span><span style=color:#111>,</span> <span style=color:#00a8c8>false</span><span style=color:#111>,</span> <span style=color:#00a8c8>false</span><span style=color:#111>,</span> <span style=color:#00a8c8>false</span><span style=color:#111>,</span> <span style=color:#00a8c8>nil</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>failOnError</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;Failed to declare an exchange&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>for</span> <span style=color:#75af00>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span><span style=color:#111>;</span> <span style=color:#75af00>i</span> <span style=color:#111>&lt;</span> <span style=color:#ae81ff>10</span><span style=color:#111>;</span> <span style=color:#75af00>i</span><span style=color:#f92672>++</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>err</span> <span style=color:#111>=</span> <span style=color:#75af00>ch</span><span style=color:#111>.</span><span style=color:#75af00>Publish</span><span style=color:#111>(</span><span style=color:#d88200>&#34;testTopic&#34;</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;yuemoxi&#34;</span><span style=color:#111>,</span> <span style=color:#00a8c8>false</span><span style=color:#111>,</span> <span style=color:#00a8c8>false</span><span style=color:#111>,</span> <span style=color:#75af00>amqp</span><span style=color:#111>.</span><span style=color:#75af00>Publishing</span><span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>ContentType</span><span style=color:#111>:</span> <span style=color:#d88200>&#34;text/plain&#34;</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>Body</span><span style=color:#111>:</span>        <span style=color:#111>[]</span><span style=color:#111>byte</span><span style=color:#111>(</span><span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Sprintf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;time:%v&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>time</span><span style=color:#111>.</span><span style=color:#75af00>Now</span><span style=color:#111>())),</span>
</span></span><span style=display:flex><span>		<span style=color:#111>})</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>==</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Println</span><span style=color:#111>(</span><span style=color:#d88200>&#34;发布成功!&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>time</span><span style=color:#111>.</span><span style=color:#75af00>Sleep</span><span style=color:#111>(</span><span style=color:#75af00>time</span><span style=color:#111>.</span><span style=color:#75af00>Second</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>get1</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>url</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Sprintf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;amqp://%s:%s@%s:%s%s&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>LOGIN</span><span style=color:#111>,</span> <span style=color:#75af00>PASSWORD</span><span style=color:#111>,</span> <span style=color:#75af00>HOST</span><span style=color:#111>,</span> <span style=color:#75af00>PORT</span><span style=color:#111>,</span> <span style=color:#75af00>VIRTUALHOST</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>conn</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>amqp</span><span style=color:#111>.</span><span style=color:#75af00>Dial</span><span style=color:#111>(</span><span style=color:#75af00>url</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>failOnError</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;Failed to connect to RabbitMQ&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>defer</span> <span style=color:#75af00>conn</span><span style=color:#111>.</span><span style=color:#75af00>Close</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>ch</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>conn</span><span style=color:#111>.</span><span style=color:#75af00>Channel</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>failOnError</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;Failed to open a channel&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>defer</span> <span style=color:#75af00>ch</span><span style=color:#111>.</span><span style=color:#75af00>Close</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>err</span> <span style=color:#111>=</span> <span style=color:#75af00>ch</span><span style=color:#111>.</span><span style=color:#75af00>ExchangeDeclare</span><span style=color:#111>(</span><span style=color:#d88200>&#34;testTopic&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>amqp</span><span style=color:#111>.</span><span style=color:#75af00>ExchangeTopic</span><span style=color:#111>,</span> <span style=color:#00a8c8>true</span><span style=color:#111>,</span> <span style=color:#00a8c8>false</span><span style=color:#111>,</span> <span style=color:#00a8c8>false</span><span style=color:#111>,</span> <span style=color:#00a8c8>false</span><span style=color:#111>,</span> <span style=color:#00a8c8>nil</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>failOnError</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;Failed to declare an exchange&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>q</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>ch</span><span style=color:#111>.</span><span style=color:#75af00>QueueDeclare</span><span style=color:#111>(</span><span style=color:#d88200>&#34;testTopic_get1&#34;</span><span style=color:#111>,</span> <span style=color:#00a8c8>false</span><span style=color:#111>,</span> <span style=color:#00a8c8>false</span><span style=color:#111>,</span> <span style=color:#00a8c8>false</span><span style=color:#111>,</span> <span style=color:#00a8c8>false</span><span style=color:#111>,</span> <span style=color:#00a8c8>nil</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>failOnError</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;Failed to declare a queue&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>err</span> <span style=color:#111>=</span> <span style=color:#75af00>ch</span><span style=color:#111>.</span><span style=color:#75af00>QueueBind</span><span style=color:#111>(</span><span style=color:#75af00>q</span><span style=color:#111>.</span><span style=color:#75af00>Name</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;yuemox*&#34;</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;testTopic&#34;</span><span style=color:#111>,</span> <span style=color:#00a8c8>false</span><span style=color:#111>,</span> <span style=color:#00a8c8>nil</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>failOnError</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;Failed to bind a queue&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>msgs</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>ch</span><span style=color:#111>.</span><span style=color:#75af00>Consume</span><span style=color:#111>(</span><span style=color:#75af00>q</span><span style=color:#111>.</span><span style=color:#75af00>Name</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;get1&#34;</span><span style=color:#111>,</span> <span style=color:#00a8c8>true</span><span style=color:#111>,</span> <span style=color:#00a8c8>false</span><span style=color:#111>,</span> <span style=color:#00a8c8>false</span><span style=color:#111>,</span> <span style=color:#00a8c8>false</span><span style=color:#111>,</span> <span style=color:#00a8c8>nil</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>failOnError</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;Failed to register a consumer&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>for</span> <span style=color:#75af00>msg</span> <span style=color:#f92672>:=</span> <span style=color:#00a8c8>range</span> <span style=color:#75af00>msgs</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>log</span><span style=color:#111>.</span><span style=color:#75af00>Printf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;get1: %s&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>msg</span><span style=color:#111>.</span><span style=color:#75af00>Body</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>time</span><span style=color:#111>.</span><span style=color:#75af00>Sleep</span><span style=color:#111>(</span><span style=color:#75af00>time</span><span style=color:#111>.</span><span style=color:#75af00>Millisecond</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>500</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>get2</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>url</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Sprintf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;amqp://%s:%s@%s:%s%s&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>LOGIN</span><span style=color:#111>,</span> <span style=color:#75af00>PASSWORD</span><span style=color:#111>,</span> <span style=color:#75af00>HOST</span><span style=color:#111>,</span> <span style=color:#75af00>PORT</span><span style=color:#111>,</span> <span style=color:#75af00>VIRTUALHOST</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>conn</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>amqp</span><span style=color:#111>.</span><span style=color:#75af00>Dial</span><span style=color:#111>(</span><span style=color:#75af00>url</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>failOnError</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;Failed to connect to RabbitMQ&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>defer</span> <span style=color:#75af00>conn</span><span style=color:#111>.</span><span style=color:#75af00>Close</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>ch</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>conn</span><span style=color:#111>.</span><span style=color:#75af00>Channel</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>failOnError</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;Failed to open a channel&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>defer</span> <span style=color:#75af00>ch</span><span style=color:#111>.</span><span style=color:#75af00>Close</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>err</span> <span style=color:#111>=</span> <span style=color:#75af00>ch</span><span style=color:#111>.</span><span style=color:#75af00>ExchangeDeclare</span><span style=color:#111>(</span><span style=color:#d88200>&#34;testTopic&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>amqp</span><span style=color:#111>.</span><span style=color:#75af00>ExchangeTopic</span><span style=color:#111>,</span> <span style=color:#00a8c8>true</span><span style=color:#111>,</span> <span style=color:#00a8c8>false</span><span style=color:#111>,</span> <span style=color:#00a8c8>false</span><span style=color:#111>,</span> <span style=color:#00a8c8>false</span><span style=color:#111>,</span> <span style=color:#00a8c8>nil</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>failOnError</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;Failed to declare an exchange&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>q</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>ch</span><span style=color:#111>.</span><span style=color:#75af00>QueueDeclare</span><span style=color:#111>(</span><span style=color:#d88200>&#34;testTopic_get2&#34;</span><span style=color:#111>,</span> <span style=color:#00a8c8>false</span><span style=color:#111>,</span> <span style=color:#00a8c8>false</span><span style=color:#111>,</span> <span style=color:#00a8c8>false</span><span style=color:#111>,</span> <span style=color:#00a8c8>false</span><span style=color:#111>,</span> <span style=color:#00a8c8>nil</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>failOnError</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;Failed to declare a queue&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>err</span> <span style=color:#111>=</span> <span style=color:#75af00>ch</span><span style=color:#111>.</span><span style=color:#75af00>QueueBind</span><span style=color:#111>(</span><span style=color:#75af00>q</span><span style=color:#111>.</span><span style=color:#75af00>Name</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;#&#34;</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;testTopic&#34;</span><span style=color:#111>,</span> <span style=color:#00a8c8>false</span><span style=color:#111>,</span> <span style=color:#00a8c8>nil</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>failOnError</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;Failed to bind a queue&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>msgs</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>ch</span><span style=color:#111>.</span><span style=color:#75af00>Consume</span><span style=color:#111>(</span><span style=color:#75af00>q</span><span style=color:#111>.</span><span style=color:#75af00>Name</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;get2&#34;</span><span style=color:#111>,</span> <span style=color:#00a8c8>true</span><span style=color:#111>,</span> <span style=color:#00a8c8>false</span><span style=color:#111>,</span> <span style=color:#00a8c8>false</span><span style=color:#111>,</span> <span style=color:#00a8c8>false</span><span style=color:#111>,</span> <span style=color:#00a8c8>nil</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>failOnError</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;Failed to register a consumer&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>for</span> <span style=color:#75af00>msg</span> <span style=color:#f92672>:=</span> <span style=color:#00a8c8>range</span> <span style=color:#75af00>msgs</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>log</span><span style=color:#111>.</span><span style=color:#75af00>Printf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;get2: %s&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>msg</span><span style=color:#111>.</span><span style=color:#75af00>Body</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>time</span><span style=color:#111>.</span><span style=color:#75af00>Sleep</span><span style=color:#111>(</span><span style=color:#75af00>time</span><span style=color:#111>.</span><span style=color:#75af00>Millisecond</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>500</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>failOnError</span><span style=color:#111>(</span><span style=color:#75af00>err</span> <span style=color:#00a8c8>error</span><span style=color:#111>,</span> <span style=color:#75af00>msg</span> <span style=color:#00a8c8>string</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>log</span><span style=color:#111>.</span><span style=color:#75af00>Fatalf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;%s: %s&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>msg</span><span style=color:#111>,</span> <span style=color:#75af00>err</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>main</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>go</span> <span style=color:#75af00>publish</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>go</span> <span style=color:#75af00>get1</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>go</span> <span style=color:#75af00>get2</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>time</span><span style=color:#111>.</span><span style=color:#75af00>Sleep</span><span style=color:#111>(</span><span style=color:#75af00>time</span><span style=color:#111>.</span><span style=color:#75af00>Second</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>20</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e>结果：
</span></span></span><span style=display:flex><span><span style=color:#75715e>发布成功!
</span></span></span><span style=display:flex><span><span style=color:#75715e>2021/08/31 22:45:09 get1: time:2021-08-31 22:45:09.017664 +0800 CST m=+0.012626409
</span></span></span><span style=display:flex><span><span style=color:#75715e>发布成功!
</span></span></span><span style=display:flex><span><span style=color:#75715e>2021/08/31 22:45:10 get2: time:2021-08-31 22:45:10.022005 +0800 CST m=+1.016996649
</span></span></span><span style=display:flex><span><span style=color:#75715e>2021/08/31 22:45:10 get1: time:2021-08-31 22:45:10.022005 +0800 CST m=+1.016996649
</span></span></span><span style=display:flex><span><span style=color:#75715e>发布成功!
</span></span></span><span style=display:flex><span><span style=color:#75715e>2021/08/31 22:45:11 get2: time:2021-08-31 22:45:11.023542 +0800 CST m=+2.018558384
</span></span></span><span style=display:flex><span><span style=color:#75715e>2021/08/31 22:45:11 get1: time:2021-08-31 22:45:11.023542 +0800 CST m=+2.018558384
</span></span></span><span style=display:flex><span><span style=color:#75715e>发布成功!
</span></span></span><span style=display:flex><span><span style=color:#75715e>2021/08/31 22:45:12 get1: time:2021-08-31 22:45:12.028649 +0800 CST m=+3.023687209
</span></span></span><span style=display:flex><span><span style=color:#75715e>2021/08/31 22:45:12 get2: time:2021-08-31 22:45:12.028649 +0800 CST m=+3.023687209
</span></span></span><span style=display:flex><span><span style=color:#75715e>发布成功!
</span></span></span><span style=display:flex><span><span style=color:#75715e>2021/08/31 22:45:13 get2: time:2021-08-31 22:45:13.033497 +0800 CST m=+4.028553608
</span></span></span><span style=display:flex><span><span style=color:#75715e>2021/08/31 22:45:13 get1: time:2021-08-31 22:45:13.033497 +0800 CST m=+4.028553608
</span></span></span><span style=display:flex><span><span style=color:#75715e>发布成功!
</span></span></span><span style=display:flex><span><span style=color:#75715e>2021/08/31 22:45:14 get1: time:2021-08-31 22:45:14.03647 +0800 CST m=+5.031571881
</span></span></span><span style=display:flex><span><span style=color:#75715e>2021/08/31 22:45:14 get2: time:2021-08-31 22:45:14.03647 +0800 CST m=+5.031571881
</span></span></span><span style=display:flex><span><span style=color:#75715e>发布成功!
</span></span></span><span style=display:flex><span><span style=color:#75715e>2021/08/31 22:45:15 get2: time:2021-08-31 22:45:15.036783 +0800 CST m=+6.031867631
</span></span></span><span style=display:flex><span><span style=color:#75715e>2021/08/31 22:45:15 get1: time:2021-08-31 22:45:15.036783 +0800 CST m=+6.031867631
</span></span></span><span style=display:flex><span><span style=color:#75715e>发布成功!
</span></span></span><span style=display:flex><span><span style=color:#75715e>2021/08/31 22:45:16 get2: time:2021-08-31 22:45:16.041189 +0800 CST m=+7.036283180
</span></span></span><span style=display:flex><span><span style=color:#75715e>2021/08/31 22:45:16 get1: time:2021-08-31 22:45:16.041189 +0800 CST m=+7.036283180
</span></span></span><span style=display:flex><span><span style=color:#75715e>发布成功!
</span></span></span><span style=display:flex><span><span style=color:#75715e>2021/08/31 22:45:17 get1: time:2021-08-31 22:45:17.043382 +0800 CST m=+8.038484117
</span></span></span><span style=display:flex><span><span style=color:#75715e>2021/08/31 22:45:17 get2: time:2021-08-31 22:45:17.043382 +0800 CST m=+8.038484117
</span></span></span><span style=display:flex><span><span style=color:#75715e>发布成功!
</span></span></span><span style=display:flex><span><span style=color:#75715e>2021/08/31 22:45:18 get1: time:2021-08-31 22:45:18.04643 +0800 CST m=+9.041536815
</span></span></span><span style=display:flex><span><span style=color:#75715e>2021/08/31 22:45:18 get2: time:2021-08-31 22:45:18.04643 +0800 CST m=+9.041536815
</span></span></span><span style=display:flex><span><span style=color:#75715e>*/</span>
</span></span></code></pre></div><h2 id=延迟队列>延迟队列</h2><h3 id=什么是延迟队列>什么是延迟队列</h3><p><code>延时队列</code>，首先，它是一种队列，队列意味着内部的元素是<code>有序</code>的，元素出队和入队是有方向性的，元素从一端进入，从另一端取出。</p><p>其次，<code>延时队列</code>，最重要的特性就体现在它的<code>延时</code>属性上，跟普通的队列不一样的是，<code>普通队列中的元素总是等着希望被早点取出处理，而延时队列中的元素则是希望被在指定时间得到取出和处理</code>，所以延时队列中的元素是都是带时间属性的，通常来说是需要被处理的消息或者任务。</p><p>简单来说，延时队列就是用来存放需要在指定时间被处理的元素的队列。</p><h3 id=使用场景>使用场景</h3><ol><li>订单在十分钟之内未支付则自动取消。</li><li>新创建的店铺，如果在十天内都没有上传过商品，则自动发送消息提醒。</li><li>账单在一周内未支付，则自动结算。</li><li>用户注册成功后，如果三天内没有登陆则进行短信提醒。</li><li>用户发起退款，如果三天内没有得到处理则通知相关运营人员。</li><li>预定会议后，需要在预定的时间点前十分钟通知各个与会人员参加会议。</li></ol><h3 id=rabbitmq中的ttl>rabbitMQ中的TTL</h3><p>在介绍延时队列之前，还需要先介绍一下RabbitMQ中的一个高级特性——<code>TTL（Time To Live）</code>。</p><p><code>TTL</code>是什么呢？<code>TTL</code>是RabbitMQ中一个消息或者队列的属性，表明<code>一条消息或者该队列中的所有消息的最大存活时间</code>，单位是毫秒。换句话说，如果一条消息设置了TTL属性或者进入了设置TTL属性的队列，那么这条消息如果在TTL设置的时间内没有被消费，则会成为“死信”。如果同时配置了队列的TTL和消息的TTL，那么较小的那个值将会被使用。</p><h3 id=如何利用rabbitmq实现延迟队列>如何利用rabbitMQ实现延迟队列</h3><p>想想看，<code>延时队列</code>，不就是想要消息延迟多久被处理吗，TTL则刚好能让消息在延迟多久之后成为死信，另一方面，成为死信的消息都会被投递到死信队列里，这样只需要消费者一直消费死信队列里的消息就万事大吉了，因为里面的消息都是希望被立即处理的消息。</p><p>从下图可以大致看出消息的流向：</p><p><img src=/images/47f80fb8-4a5d-4f84-bd2c-21fac99107a0.png alt></p><p>生产者生产一条延时消息，根据需要延时时间的不同，利用不同的routingkey将消息路由到不同的延时队列，每个队列都设置了不同的TTL属性，并绑定在同一个死信交换机中，消息过期后，根据routingkey的不同，又会被路由到不同的死信队列中，消费者只需要监听对应的死信队列进行处理即可。</p><p><strong>go实现</strong></p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#75af00>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>(</span>
</span></span><span style=display:flex><span>	<span style=color:#d88200>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#d88200>&#34;github.com/streadway/amqp&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#d88200>&#34;log&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#d88200>&#34;time&#34;</span>
</span></span><span style=display:flex><span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>const</span> <span style=color:#111>(</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>LOGIN</span>       <span style=color:#00a8c8>string</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;zhaohaiyu&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>PASSWORD</span>    <span style=color:#00a8c8>string</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;zhy.1996&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>HOST</span>        <span style=color:#00a8c8>string</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;127.0.0.1&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>PORT</span>        <span style=color:#00a8c8>string</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;5672&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>VIRTUALHOST</span> <span style=color:#00a8c8>string</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;/&#34;</span>
</span></span><span style=display:flex><span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>publish</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>url</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Sprintf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;amqp://%s:%s@%s:%s%s&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>LOGIN</span><span style=color:#111>,</span> <span style=color:#75af00>PASSWORD</span><span style=color:#111>,</span> <span style=color:#75af00>HOST</span><span style=color:#111>,</span> <span style=color:#75af00>PORT</span><span style=color:#111>,</span> <span style=color:#75af00>VIRTUALHOST</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>conn</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>amqp</span><span style=color:#111>.</span><span style=color:#75af00>Dial</span><span style=color:#111>(</span><span style=color:#75af00>url</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>failOnError</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;Failed to connect to RabbitMQ&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>defer</span> <span style=color:#75af00>conn</span><span style=color:#111>.</span><span style=color:#75af00>Close</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>ch</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>conn</span><span style=color:#111>.</span><span style=color:#75af00>Channel</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>failOnError</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;Failed to open a channel&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>defer</span> <span style=color:#75af00>ch</span><span style=color:#111>.</span><span style=color:#75af00>Close</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>err</span> <span style=color:#111>=</span> <span style=color:#75af00>ch</span><span style=color:#111>.</span><span style=color:#75af00>ExchangeDeclare</span><span style=color:#111>(</span><span style=color:#d88200>&#34;testTopic&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>amqp</span><span style=color:#111>.</span><span style=color:#75af00>ExchangeTopic</span><span style=color:#111>,</span> <span style=color:#00a8c8>true</span><span style=color:#111>,</span> <span style=color:#00a8c8>false</span><span style=color:#111>,</span> <span style=color:#00a8c8>false</span><span style=color:#111>,</span> <span style=color:#00a8c8>false</span><span style=color:#111>,</span> <span style=color:#00a8c8>nil</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>failOnError</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;Failed to declare an exchange&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>for</span> <span style=color:#75af00>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span><span style=color:#111>;</span> <span style=color:#75af00>i</span> <span style=color:#111>&lt;</span> <span style=color:#ae81ff>10</span><span style=color:#111>;</span> <span style=color:#75af00>i</span><span style=color:#f92672>++</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>err</span> <span style=color:#111>=</span> <span style=color:#75af00>ch</span><span style=color:#111>.</span><span style=color:#75af00>Publish</span><span style=color:#111>(</span><span style=color:#d88200>&#34;testTopic&#34;</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;yuemoxi&#34;</span><span style=color:#111>,</span> <span style=color:#00a8c8>false</span><span style=color:#111>,</span> <span style=color:#00a8c8>false</span><span style=color:#111>,</span> <span style=color:#75af00>amqp</span><span style=color:#111>.</span><span style=color:#75af00>Publishing</span><span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>ContentType</span><span style=color:#111>:</span> <span style=color:#d88200>&#34;text/plain&#34;</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>Body</span><span style=color:#111>:</span>        <span style=color:#111>[]</span><span style=color:#111>byte</span><span style=color:#111>(</span><span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Sprintf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;time:%v&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>time</span><span style=color:#111>.</span><span style=color:#75af00>Now</span><span style=color:#111>())),</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>Expiration</span><span style=color:#111>:</span>  <span style=color:#d88200>&#34;600000&#34;</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>		<span style=color:#111>})</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>==</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Println</span><span style=color:#111>(</span><span style=color:#d88200>&#34;发布成功!&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>time</span><span style=color:#111>.</span><span style=color:#75af00>Sleep</span><span style=color:#111>(</span><span style=color:#75af00>time</span><span style=color:#111>.</span><span style=color:#75af00>Second</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>get2</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>url</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Sprintf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;amqp://%s:%s@%s:%s%s&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>LOGIN</span><span style=color:#111>,</span> <span style=color:#75af00>PASSWORD</span><span style=color:#111>,</span> <span style=color:#75af00>HOST</span><span style=color:#111>,</span> <span style=color:#75af00>PORT</span><span style=color:#111>,</span> <span style=color:#75af00>VIRTUALHOST</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>conn</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>amqp</span><span style=color:#111>.</span><span style=color:#75af00>Dial</span><span style=color:#111>(</span><span style=color:#75af00>url</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>failOnError</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;Failed to connect to RabbitMQ&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>defer</span> <span style=color:#75af00>conn</span><span style=color:#111>.</span><span style=color:#75af00>Close</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>ch</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>conn</span><span style=color:#111>.</span><span style=color:#75af00>Channel</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>failOnError</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;Failed to open a channel&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>defer</span> <span style=color:#75af00>ch</span><span style=color:#111>.</span><span style=color:#75af00>Close</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>err</span> <span style=color:#111>=</span> <span style=color:#75af00>ch</span><span style=color:#111>.</span><span style=color:#75af00>ExchangeDeclare</span><span style=color:#111>(</span><span style=color:#d88200>&#34;testTopic&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>amqp</span><span style=color:#111>.</span><span style=color:#75af00>ExchangeTopic</span><span style=color:#111>,</span> <span style=color:#00a8c8>true</span><span style=color:#111>,</span> <span style=color:#00a8c8>false</span><span style=color:#111>,</span> <span style=color:#00a8c8>false</span><span style=color:#111>,</span> <span style=color:#00a8c8>false</span><span style=color:#111>,</span> <span style=color:#00a8c8>nil</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>failOnError</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;Failed to declare an exchange&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>q</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>ch</span><span style=color:#111>.</span><span style=color:#75af00>QueueDeclare</span><span style=color:#111>(</span><span style=color:#d88200>&#34;testTopic_get2&#34;</span><span style=color:#111>,</span> <span style=color:#00a8c8>false</span><span style=color:#111>,</span> <span style=color:#00a8c8>false</span><span style=color:#111>,</span> <span style=color:#00a8c8>false</span><span style=color:#111>,</span> <span style=color:#00a8c8>false</span><span style=color:#111>,</span> <span style=color:#00a8c8>nil</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>failOnError</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;Failed to declare a queue&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>//声明延时队列队列，该队列中消息如果过期，就将消息发送到交换器上，交换器就分发消息到普通队列</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>q1</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>ch</span><span style=color:#111>.</span><span style=color:#75af00>QueueDeclare</span><span style=color:#111>(</span>
</span></span><span style=display:flex><span>		<span style=color:#d88200>&#34;test_delay&#34;</span><span style=color:#111>,</span> <span style=color:#75715e>//队列名</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>true</span><span style=color:#111>,</span>         <span style=color:#75715e>//持久化</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>false</span><span style=color:#111>,</span>        <span style=color:#75715e>//不用时是否自动删除</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>true</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>false</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>amqp</span><span style=color:#111>.</span><span style=color:#75af00>Table</span><span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>//当消息过期时把消息发送到logs这个交换器</span>
</span></span><span style=display:flex><span>			<span style=color:#d88200>&#34;x-dead-letter-exchange&#34;</span><span style=color:#111>:</span>    <span style=color:#d88200>&#34;ttlTopic&#34;</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>			<span style=color:#d88200>&#34;x-dead-letter-routing-key&#34;</span><span style=color:#111>:</span> <span style=color:#d88200>&#34;ttlKey&#34;</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>		<span style=color:#111>},</span>
</span></span><span style=display:flex><span>	<span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>failOnError</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;Failed to bind a queue&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#75af00>err</span> <span style=color:#111>=</span> <span style=color:#75af00>ch</span><span style=color:#111>.</span><span style=color:#75af00>QueueBind</span><span style=color:#111>(</span><span style=color:#75af00>q</span><span style=color:#111>.</span><span style=color:#75af00>Name</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;#&#34;</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;testTopic&#34;</span><span style=color:#111>,</span> <span style=color:#00a8c8>false</span><span style=color:#111>,</span> <span style=color:#00a8c8>nil</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>failOnError</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;Failed to bind a queue&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>err</span> <span style=color:#111>=</span> <span style=color:#75af00>ch</span><span style=color:#111>.</span><span style=color:#75af00>QueueBind</span><span style=color:#111>(</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>q1</span><span style=color:#111>.</span><span style=color:#75af00>Name</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>		<span style=color:#d88200>&#34;ttlKey&#34;</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>		<span style=color:#d88200>&#34;ttlTopic&#34;</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>false</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>nil</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>	<span style=color:#111>)</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#75af00>msgs</span><span style=color:#111>,</span> <span style=color:#75af00>err</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>ch</span><span style=color:#111>.</span><span style=color:#75af00>Consume</span><span style=color:#111>(</span><span style=color:#75af00>q</span><span style=color:#111>.</span><span style=color:#75af00>Name</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;get2&#34;</span><span style=color:#111>,</span> <span style=color:#00a8c8>true</span><span style=color:#111>,</span> <span style=color:#00a8c8>false</span><span style=color:#111>,</span> <span style=color:#00a8c8>false</span><span style=color:#111>,</span> <span style=color:#00a8c8>false</span><span style=color:#111>,</span> <span style=color:#00a8c8>nil</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>failOnError</span><span style=color:#111>(</span><span style=color:#75af00>err</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;Failed to register a consumer&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>for</span> <span style=color:#75af00>msg</span> <span style=color:#f92672>:=</span> <span style=color:#00a8c8>range</span> <span style=color:#75af00>msgs</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>log</span><span style=color:#111>.</span><span style=color:#75af00>Printf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;get2: %s&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>msg</span><span style=color:#111>.</span><span style=color:#75af00>Body</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>time</span><span style=color:#111>.</span><span style=color:#75af00>Sleep</span><span style=color:#111>(</span><span style=color:#75af00>time</span><span style=color:#111>.</span><span style=color:#75af00>Millisecond</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>500</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>failOnError</span><span style=color:#111>(</span><span style=color:#75af00>err</span> <span style=color:#00a8c8>error</span><span style=color:#111>,</span> <span style=color:#75af00>msg</span> <span style=color:#00a8c8>string</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>err</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>log</span><span style=color:#111>.</span><span style=color:#75af00>Fatalf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;%s: %s&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>msg</span><span style=color:#111>,</span> <span style=color:#75af00>err</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>main</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>go</span> <span style=color:#75af00>publish</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>go</span> <span style=color:#75af00>get2</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>time</span><span style=color:#111>.</span><span style=color:#75af00>Sleep</span><span style=color:#111>(</span><span style=color:#75af00>time</span><span style=color:#111>.</span><span style=color:#75af00>Second</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>20</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><h2 id=参考文章>参考文章</h2><ul><li><a href=https://juejin.cn/post/6916148736414466061>https://juejin.cn/post/6916148736414466061</a></li><li><a href=https://www.rabbitmq.com/getstarted.html>rabbitmq官网</a></li><li><a href=https://www.cnblogs.com/mfrank/p/11260355.html>https://www.cnblogs.com/mfrank/p/11260355.html</a></li></ul></div><footer class=post-footer><div class=post-license><p><strong>Article Title:</strong> RabbitMQ消息队列</p><p><strong>Author:</strong> daemon365</p><p><strong>Permalink:</strong> <a href=https://daemon365.dev/post/database/rabbitmq_message_queue/>https://daemon365.dev/post/database/rabbitmq_message_queue/</a></p><p><strong>License:</strong> This article is licensed under
<a href=https://creativecommons.org/licenses/by-nc-sa/4.0/ target=_blank rel=noopener>BY-NC-SA</a>. Please cite the source when reposting.</p></div><nav class=post-navigation><a href=/post/network/http_and_https/ class=nav-prev><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg><div><span class=nav-label>Previous</span>
<span class=nav-title>http和https</span></div></a><a href=/post/cloud/container_basics___namespace__cgroup_and_unionfs/ class=nav-next><div><span class=nav-label>Next</span>
<span class=nav-title>容器基础-- namespace,Cgroup 和 UnionFS</span></div><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg></a></nav><div class=post-comments><script src=https://utteranc.es/client.js repo=daemon365/blog issue-term=pathname label=comments theme=preferred-color-scheme crossorigin=anonymous async></script></div></footer></article></div></div><div class=toc-float-button id=tocButton><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5.0 016.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5.0 014 19.5v-15A2.5 2.5.0 016.5 2z"/></svg></div><div class=toc-panel id=tocPanel><div class=toc-panel-header><h3 class=toc-panel-title>Table of Contents</h3><button class=toc-panel-close id=tocClose>
<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div><nav class=toc-panel-nav id=TableOfContents><nav id=TableOfContents><ul><li><a href=#消息队列>消息队列</a><ul><li><a href=#1消息通讯>1、消息通讯</a></li><li><a href=#2异步处理>2、异步处理</a></li><li><a href=#3服务解耦>3、服务解耦</a></li><li><a href=#4流量削峰>4、流量削峰</a></li></ul></li><li><a href=#安装>安装</a></li><li><a href=#rabbitmq核心概念>RabbitMQ核心概念</a><ul><li><a href=#broker>Broker</a></li><li><a href=#producer-与-consumer>Producer 与 Consumer</a></li><li><a href=#connection>Connection</a></li><li><a href=#channel>Channel</a></li><li><a href=#exchnage>Exchnage</a></li><li><a href=#queue>Queue</a></li><li><a href=#binding>Binding</a></li><li><a href=#virtual-host>Virtual Host</a></li></ul></li><li><a href=#简单-simple-模式>简单 (simple) 模式</a></li><li><a href=#工作-work-模式>工作 (work) 模式</a></li><li><a href=#发布--订阅-pubsub-模式>发布 / 订阅 (pub/sub) 模式</a></li><li><a href=#路由-routing-模式>路由 (routing) 模式</a></li><li><a href=#主题-topic-模式>主题 (Topic) 模式</a></li><li><a href=#延迟队列>延迟队列</a><ul><li><a href=#什么是延迟队列>什么是延迟队列</a></li><li><a href=#使用场景>使用场景</a></li><li><a href=#rabbitmq中的ttl>rabbitMQ中的TTL</a></li><li><a href=#如何利用rabbitmq实现延迟队列>如何利用rabbitMQ实现延迟队列</a></li></ul></li><li><a href=#参考文章>参考文章</a></li></ul></nav></nav></div></main><footer class=site-footer><div class=container><div class=footer-content><div class=footer-info><p class=copyright>© 2025 daemon365</p><p class=powered-by>Powered by <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> & <a href=https://github.com/daemon365/hugo-theme-daemon target=_blank rel=noopener>Daemon</a></p></div><div class=social-links><a href=https://github.com/daemon365 target=_blank rel=noopener aria-label=GitHub><svg class="icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0C5.374.0.0 5.373.0 12c0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931.0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176.0.0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221.0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576C20.566 21.797 24 17.3 24 12c0-6.627-5.373-12-12-12z"/></svg>
</a><a href=mailto:daemon365@foxmail.com aria-label=Email><svg class="icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></a></div></div></div></footer><div class=search-modal id=searchModal><div class=search-modal-backdrop></div><div class=search-modal-content><div class=search-modal-header><input type=text class=search-input id=searchInput placeholder="Search articles..." autofocus>
<button class=search-close aria-label="Close search">
<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div><div class=search-results id=searchResults><p class=search-hint>Enter 2 or more characters to start searching</p></div></div></div><script src=/js/components/search.js></script><script src=/js/components/toc.js></script><script src=/js/components/scroll-effects.js></script><script src=/js/components/code-copy.js></script><script src=/js/components/lazy-loading.js></script><script src=/js/components/image-preview.js></script><script src=/js/components/back-to-top.js></script><script src=/js/main-new.js></script><script>"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("/sw.js").then(e=>{console.log("Service Worker registered:",e.scope)}).catch(e=>{console.log("Service Worker registration failed:",e)})})</script></body></html>