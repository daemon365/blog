<!doctype html><html lang=zh-CN data-theme=light><head><meta charset=UTF-8><meta name=viewport content="width=device-width"><meta name=theme-color content="#222" media="(prefers-color-scheme: light)"><meta name=generator content="Hugo 0.139.3"><link rel="shortcut icon" type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/png sizes=16x16 href=/imgs/icons/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/imgs/icons/favicon.ico><link rel=apple-touch-icon sizes=180x180 href=/imgs/icons/favicon.ico><meta itemprop=name content="RabbitMQ消息队列"><meta itemprop=description content="Don't let yourself stop."><meta name=description content="Don't let yourself stop."><meta itemprop=datePublished zgotmplz><meta itemprop=dateModified zgotmplz><meta itemprop=image content="https://daemon365.dev/imgs/daemon365.png"><meta itemprop=keywords content="RabbitMQ"><meta property="og:type" content="article"><meta property="og:title" content="RabbitMQ消息队列"><meta property="og:description" content="Don't let yourself stop."><meta property="og:image" content="/imgs/daemon365.png"><meta property="og:image:width" content="312"><meta property="og:image:height" content="312"><meta property="og:image:type" content="image/jpeg/png/svg/jpg"><meta property="og:url" content="https://daemon365.dev/post/database/rabbitmq_message_queue/"><meta property="og:site_name" content="Daemon"><meta property="og:locale" content="zh-CN"><meta property="article:author" content="daemon365"><meta property="article:published_time" content="2023-05-20 00:00:00 +0800 +0800"><meta property="article:modified_time" content="2023-05-20 00:00:00 +0800 +0800"><link type=text/css rel=stylesheet href=https://daemon365.dev/3rd/font-awesome/6.6.0/css/all.min.css><link type=text/css rel=stylesheet href=https://daemon365.dev/3rd/animate.css/4.1.1/animate.min.css><link type=text/css rel=stylesheet href=https://daemon365.dev/3rd/viewerjs/1.11.6/viewer.min.css><link rel=stylesheet href=/css/main.min.5ec1f63635756d664e619fe2d87a11c7394f519beff240c124743433c9861792.css><style type=text/css>.post-footer,.flinks-list-footer hr:after{content:"~ 我可是有底线的哟 ~"}</style><script type=text/javascript>(function(){localDB={set:function(e,t,n){if(n===0)return;const s=new Date,o=n*864e5,i={value:t,expiry:s.getTime()+o};localStorage.setItem(e,JSON.stringify(i))},get:function(e){const t=localStorage.getItem(e);if(!t)return void 0;const n=JSON.parse(t),s=new Date;return s.getTime()>n.expiry?(localStorage.removeItem(e),void 0):n.value}},theme={active:function(){const e=localDB.get("theme");if(e==null)return;theme.toggle(e),window.matchMedia("(prefers-color-scheme: dark)").addListener(function(e){theme.toggle(e.matches?"dark":"light")})},toggle:function(e){document.documentElement.setAttribute("data-theme",e),localDB.set("theme",e,2);const t=document.querySelector("iframe.giscus-frame");if(t){const n={setConfig:{theme:e}};t.contentWindow.postMessage({giscus:n},"https://giscus.app")}}},theme.active()})(window)</script><script class=next-config data-name=page type=application/json>{"comments":true,"isHome":false,"isPage":true,"path":"rabbitmq_message_queue","permalink":"https://daemon365.dev/post/database/rabbitmq_message_queue/","title":"RabbitMQ消息队列","waline":{"js":[{"alias":"@waline/client","alias_name":"waline","file":"dist/pageview.js","name":"pageview","version":"2.15.8"},{"alias":"@waline/client","alias_name":"waline","file":"dist/comment.js","name":"comment","version":"2.15.8"}]}}</script><script type=text/javascript>document.addEventListener("DOMContentLoaded",()=>{var e=document.createElement("script");e.charset="UTF-8",e.id="LA_COLLECT",e.src="https://sdk.51.la/js-sdk-pro.min.js",e.async="true",e.onload=function(){LA.init({id:"JmAHxEAUVgyS8B1c",ck:"JmAHxEAUVgyS8B1c",autoTrack:!0})},document.head.appendChild(e)})</script><script type=text/javascript>document.addEventListener("DOMContentLoaded",()=>{var e=document.createElement("script");e.charset="UTF-8",e.src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js",e.async=!1,e.defer=!0,document.head.appendChild(e),e.onload=function(){NexT.utils.fmtBusuanzi()}})</script><title>RabbitMQ消息队列 - Daemon</title><noscript><link rel=stylesheet href=/css/noscript.css></noscript></head><body itemscope itemtype=http://schema.org/WebPage><div class=headband></div><main class=main><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-brand-container><div class=site-nav-toggle><div class=toggle aria-label role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div></div><div class=site-meta><a href=/ class=brand rel=start><i class=logo-line></i><h1 class=site-title>Daemon</h1><i class=logo-line></i></a><p class=site-subtitle itemprop=description>Don't let yourself stop.</p></div><div class=site-nav-right><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class=site-nav><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href=/ class=hvr-icon-pulse rel=section><i class="fa fa-home hvr-icon"></i>Home</a></li><li class="menu-item menu-item-about"><a href=/about/ class=hvr-icon-pulse rel=section><i class="fa fa-user hvr-icon"></i>About</a></li><li class="menu-item menu-item-archives"><a href=/archives/ class=hvr-icon-pulse rel=section><i class="fa fa-archive hvr-icon"></i>Archives</a></li><li class="menu-item menu-item-commonweal"><a href=/404.html class=hvr-icon-pulse rel=section><i class="fa fa-heartbeat hvr-icon"></i>Commonweal</a></li><li class="menu-item menu-item-search"><a role=button class="popup-trigger hvr-icon-pulse"><i class="fa fa-search fa-fw hvr-icon"></i>搜索</a></li></ul></nav><div class=search-pop-overlay><div class="popup search-popup"><div class=search-header><span class=search-icon><i class="fa fa-search"></i></span><div class=search-input-container><input autocomplete=off autocapitalize=off maxlength=80 placeholder=搜索... spellcheck=false type=search class=search-input></div><span class=popup-btn-close role=button><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class=search-result-icon><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></div><div class="toggle sidebar-toggle" role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div><aside class=sidebar><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class=sidebar-nav><li class=sidebar-nav-toc>文章目录</li><li class=sidebar-nav-overview>站点概览</li></ul><div class=sidebar-panel-container><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><nav id=TableOfContents><ul><li><a href=#消息队列>消息队列</a><ul><li><a href=#1消息通讯>1、消息通讯</a></li><li><a href=#2异步处理>2、异步处理</a></li><li><a href=#3服务解耦>3、服务解耦</a></li><li><a href=#4流量削峰>4、流量削峰</a></li></ul></li><li><a href=#安装>安装</a></li><li><a href=#rabbitmq核心概念>RabbitMQ核心概念</a><ul><li><a href=#broker>Broker</a></li><li><a href=#producer-与-consumer>Producer 与 Consumer</a></li><li><a href=#connection>Connection</a></li><li><a href=#channel>Channel</a></li><li><a href=#exchnage>Exchnage</a></li><li><a href=#queue>Queue</a></li><li><a href=#binding>Binding</a></li><li><a href=#virtual-host>Virtual Host</a></li></ul></li><li><a href=#简单-simple-模式>简单 (simple) 模式</a></li><li><a href=#工作-work-模式>工作 (work) 模式</a></li><li><a href=#发布--订阅-pubsub-模式>发布 / 订阅 (pub/sub) 模式</a></li><li><a href=#路由-routing-模式>路由 (routing) 模式</a></li><li><a href=#主题-topic-模式>主题 (Topic) 模式</a></li><li><a href=#延迟队列>延迟队列</a><ul><li><a href=#什么是延迟队列>什么是延迟队列</a></li><li><a href=#使用场景>使用场景</a></li><li><a href=#rabbitmq中的ttl>rabbitMQ中的TTL</a></li><li><a href=#如何利用rabbitmq实现延迟队列>如何利用rabbitMQ实现延迟队列</a></li></ul></li><li><a href=#参考文章>参考文章</a></li></ul></nav></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image alt=daemon365 src=/imgs/img-lazy-loading.gif data-src=/imgs/daemon365.png><p class=site-author-name itemprop=name>daemon365</p><div class=site-description itemprop=description>Don't let yourself stop.</div></div><div class="site-state-wrap site-overview-item animated"><nav class=site-state><div class="site-state-item site-state-posts"><a href=/archives/><span class=site-state-item-count>94</span>
<span class=site-state-item-name>日志</span></a></div><div class="site-state-item site-state-categories"><a href=/categories/><span class=site-state-item-count>7</span>
<span class=site-state-item-name>分类</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/><span class=site-state-item-count>52</span>
<span class=site-state-item-name>标签</span></a></div></nav></div><div class="links-of-social site-overview-item animated"><span class=links-of-social-item><a href=https://github.com/daemon365 title="Github → https://github.com/daemon365" rel=noopener target=_blank><i class="fab fa-github fa-fw"></i>
Github</a></span></div><div class="cc-license animated" itemprop=license><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh class=cc-opacity rel=noopener target=_blank title=共享知识><img src=/imgs/img-lazy-loading.gif data-src=/imgs/cc/big/by_nc_sa.svg alt=共享知识></a></div><div class="links-of-blogroll site-overview-item animated"><div class=links-of-blogroll-title><i class="fa fa-globe fa-fw"></i>
友情链接</div><ul class=links-of-blogroll-list><li class=links-of-blogroll-item><a href=https://go-kratos.dev title=https://go-kratos.dev target=_blank>kratos</a></li></ul></div></div></div></div></aside><div class=sidebar-dimmer></div></header><div class=tool-buttons><div id=goto-comments class="button goto-comments" title=直达评论><i class="fas fa-comments"></i></div><div id=toggle-theme class=button title=深浅模式切换><i class="fas fa-adjust"></i></div><div class=back-to-top role=button title=返回顶部><i class="fa fa-arrow-up"></i>
<span>0%</span></div></div><div class=reading-progress-bar></div><script type=text/javascript src=//sidecar.gitter.im/dist/sidecar.v1.js async></script><script type=text/javascript>((window.gitter={}).chat={}).options={room:"hugo-next/community"}</script><noscript><div class=noscript-warning>Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class=post-block><article itemscope itemtype=http://schema.org/Article class=post-content lang><link itemprop=mainEntityOfPage href=https://daemon365.dev/post/database/rabbitmq_message_queue/><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content="/imgs/daemon365.png"><meta itemprop=name content="daemon365"></span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="daemon365"><meta itemprop=description content="Don't let yourself stop."></span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork><meta itemprop=name content="RabbitMQ消息队列"><meta itemprop=description content="消息队列

本篇文章主要介绍了 RabbitMQ 这种消息队列，从消息队列的概念、应用场景、安装方式到它的核心概念、五种工作模式。在安装的时候推荐使用 Docker 方式进行安装。重点需要理解的就是消息队列的应用场景、核心概念和 RabbitMQ 的五种工作模式，其中用的比较多的就是发布订阅模式、主题模式。"></span><header class=post-header><h1 class=post-title itemprop="name headline">RabbitMQ消息队列</h1><div class=post-meta-container><div class=post-meta-items><span class=post-meta-item><span class=post-meta-item-icon><i class="fas fa-solid fa-calendar"></i>
</span><span class=post-meta-item-text title=发表于>发表于：
</span><time title="创建时间：2023-05-20 00:00:00 +0800 +0800" itemprop="dateCreated datePublished" datetime="2023-05-20 00:00:00 +0800 +0800">2023-05-20
</time></span><span class=post-meta-item><span class=post-meta-item-icon><i class="fas fa-solid fa-folder-open"></i>
</span><span class=post-meta-item-text title=分类于>分类于：
</span><span itemprop=about itemscope itemtype=http://schema.org/Thing><a href=/categories/database itemprop=url rel=index><span itemprop=name>database</span></a></span></span></div><div class=post-meta-items><span class=post-meta-item title=字数><span class=post-meta-item-icon><i class="fas fa-solid fa-file-word"></i>
</span><span class=post-meta-item-text>字数：</span>
<span>7212</span>
</span><span class=post-meta-item title=阅读><span class=post-meta-item-icon><i class="fas fa-solid fa-clock"></i>
</span><span class=post-meta-item-text>阅读：&ap;</span>
<span>15分钟</span>
</span><span class=post-meta-item title=浏览><span class=post-meta-item-icon><i class="fas fa-solid fa-eye"></i>
</span><span class=post-meta-item-text>浏览：
</span><span id=busuanzi_value_page_pv data-path=/post/database/rabbitmq_message_queue/><i class="fa fa-sync fa-spin"></i></span></span></div></div></header><div class=post-body itemprop=articleBody><h2 id=消息队列>消息队列
<a class=header-anchor href=#%e6%b6%88%e6%81%af%e9%98%9f%e5%88%97></a></h2><p>本篇文章主要介绍了 RabbitMQ 这种消息队列，从消息队列的概念、应用场景、安装方式到它的核心概念、五种工作模式。在安装的时候推荐使用 Docker 方式进行安装。重点需要理解的就是消息队列的应用场景、核心概念和 RabbitMQ 的五种工作模式，其中用的比较多的就是发布订阅模式、主题模式。</p><p>队列 (Queue) 是一种常见的数据结构，其最大的特性就是先进先出(Firist In First Out)，作为最基础的数据结构，队列应用很广泛，比如我们熟知的 Redis 基础数据类型 List，其底层数据结构就是队列。</p><p>消息队列 (Messaeg Queue) 是一种使用队列 (Queue) 作为底层存储数据结构，可用于解决不同进程与应用之间通讯的分布式消息容器，也称为消息中间件。</p><p>目前使用得比较多的消息队列有 ActiveMQ，RabbitMQ，Kafka，RocketMQ 等。本文主要讲述的是 RabbitMQ，RabbitMQ 是用 Erlang 语言开发的一个实现了 AMQP 协议的消息队列服务器，相比其他同类型的消息队列，最大的特点在保证可观的单机吞吐量的同时，延时方面非常出色。</p><p>RabbitMQ 支持多种客户端，比如：GO、Python、Ruby、.NET、Java、JMS、C、PHP、ActionScript、XMPP、STOMP 等。</p><blockquote><p>AMQP，即 Advanced Message Queuing Protocol，高级消息队列协议，是应用层协议的一个开放标准，为面向消息的中间件设计，它是一种应用程序之间的通信方法，消息队列在分布式系统开发中应用非常广泛。这里是 AMQP 官网
<a href=https://amqp.org/ title=amqp.org rel="noopener external nofollow noreferrer" target=_blank class=exturl>amqp.org
<i class="fa fa-external-link-alt"></i></a></p></blockquote><p>消息队列使用广泛，其应用场景有很多，下面我们列举比较常见的四个场景：</p><h3 id=1消息通讯>1、消息通讯
<a class=header-anchor href=#1%e6%b6%88%e6%81%af%e9%80%9a%e8%ae%af></a></h3><p>消息队列最主要功能收发消息，其内部有高效的通讯机制，因此非常适合用于消息通讯。</p><p>我们可以基于消息队列开发点对点聊天系统，也可以开发广播系统，用于将消息广播给大量接收者。</p><h3 id=2异步处理>2、异步处理
<a class=header-anchor href=#2%e5%bc%82%e6%ad%a5%e5%a4%84%e7%90%86></a></h3><p>一般我们写的程序都是顺序执行 (同步执行)，比如一个用户注册函数，其执行顺序如下：</p><ul><li>1、写入用户注册数据。</li><li>2、发送注册邮件。</li><li>3、发送注册成功的短信通知。</li><li>4、更新统计数据。</li></ul><p>按照上面的执行顺序，要全部执行完毕，才能返回成功，但其实在第 1 步执行成功后，其他的步骤完全可以异步执行，我们可以将后面的逻辑发给消息队列，再由其他程序异步执行。使用消息队列进行异步处理，可以更快地返回结果，加快服务器的响应速度，提升了服务器的性能。</p><h3 id=3服务解耦>3、服务解耦
<a class=header-anchor href=#3%e6%9c%8d%e5%8a%a1%e8%a7%a3%e8%80%a6></a></h3><p>在我们的系统中，应用与应用之间的通讯是很常见的，一般我们应用之间直接调用，比如说应用 A 调用应用 B 的接口，这时候应用之间的关系是强耦合的。</p><p>如果应用 B 处于不可用的状态，那么应用 A 也会受影响。</p><p>在应用 A 与应用 B 之间引入消息队列进行服务解耦，如果应用 B 挂掉，也不会影响应用 A 的使用。</p><h3 id=4流量削峰>4、流量削峰
<a class=header-anchor href=#4%e6%b5%81%e9%87%8f%e5%89%8a%e5%b3%b0></a></h3><p>对于高并发的系统来说，在访问高峰时，突发的流量就像洪水般向应用系统涌过来，尤其是一些高并发写操作，随时会导致数据库服务器瘫痪，无法继续提供服务。</p><p>而引入消息队列则可以减少突发流量对应用系统的冲击。消息队列就像水库一样，拦蓄上游的洪水，削减进入下游河道的洪峰流量，从而达到减免洪水灾害的目的。而在旱季水流量小的时候又可以把水放出来灌溉庄稼。</p><p>这方面最常见的例子就是秒杀系统，一般秒杀活动瞬间流量很高，如果流量全部涌向秒杀系统，会压垮秒杀系统，通过引入消息队列，可以有效缓冲突发流量，达到削峰填谷的作用。</p><h2 id=安装>安装
<a class=header-anchor href=#%e5%ae%89%e8%a3%85></a></h2><p>Docker 安装方式如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>docker run -d --name rabbitmq -p 5672:5672 -p 15672:15672 rabbitmq:3-management
</span></span></code></pre></div><p>RabbitMQ 有属于自己的一套核心概念，对这些概念的理解很重要，只有理解了这些核心概念，才有可能建立对 RabbitMQ 的全面理解：</p><h2 id=rabbitmq核心概念>RabbitMQ核心概念
<a class=header-anchor href=#rabbitmq%e6%a0%b8%e5%bf%83%e6%a6%82%e5%bf%b5></a></h2><h3 id=broker>Broker
<a class=header-anchor href=#broker></a></h3><p>Broker 概念比较简单，我们可以把 Broker 理解为一个 RabitMQ Server。</p><h3 id=producer-与-consumer>Producer 与 Consumer
<a class=header-anchor href=#producer-%e4%b8%8e-consumer></a></h3><p>生产者与消费者相对于 RabbitMQ 服务器来说，都是 RabbitMQ 服务器的客户端。</p><ul><li>生产者 (Producer)：连到 RabbitMQ 服务器，将消息发送到 RabbitMQ 服务器的队列，是消息的发送方。</li><li>消费者 (Consumer)：连接到 RabbitMQ 则是为了消费队列中的消息，是消息的接收方。</li></ul><p>生产者与消费者一般由我们的应用程序充当。</p><h3 id=connection>Connection
<a class=header-anchor href=#connection></a></h3><p>Connection 是 RabbitMQ 内部对象之一，用于管理每个到 RabbitMQ 的 TCP 网络连接。</p><h3 id=channel>Channel
<a class=header-anchor href=#channel></a></h3><p>Channel 是我们与 RabbitMQ 打交道的最重要的一个接口，我们大部分的业务操作是在 Channel 这个接口中完成的，包括定义 Queue、定义 Exchange、绑定 Queue 与 Exchange、发布消息等。</p><h3 id=exchnage>Exchnage
<a class=header-anchor href=#exchnage></a></h3><p>消息交换机，作用是接收来自生产者的消息，并根据路由键转发消息到所绑定的队列。</p><p>生产者发送上的消息，就是先通过 Exchnage 按照绑定 (binding) 规则转发到队列的。</p><p>交换机类型 (Exchange Type) 有四种：fanout、direct、topic，headers，其中 headers 并不常用。</p><ul><li>fanout：这种类型不处理路由键 (RoutingKey)，很像子网广播，每台子网内的主机都获得了一份复制的消息，发布 / 订阅模式就是指使用 fanout 交换机类型，fanout 类型交换机转发消息是最快的。</li><li>direct：模式处理路由键，需要路由键完全匹配的队列才能收到消息，路由模式使用的是 direct 类型的交换机。</li><li>topic：将路由键和某模式进行匹配。主题模式使用的是 topic 类型的交换机。</li></ul><blockquote><p>路由模式，发布订阅模式，主题模式，这些工作模式我们下面会讲。</p></blockquote><p><img src=/imgs/img-lazy-loading.gif data-src=/images/4ec0abac-6b64-4401-b5a0-d538e4121932.png alt></p><h3 id=queue>Queue
<a class=header-anchor href=#queue></a></h3><p>Queue 即队列，RabbitMQ 内部用于存储消息的对象，是真正用存储消息的结构，在生产端，生产者的消息最终发送到指定队列，而消费者也是通过订阅某个队列，达到获取消息的目的。</p><h3 id=binding>Binding
<a class=header-anchor href=#binding></a></h3><p>Binding 是一种操作，其作用是建立消息从 Exchange 转发到 Queue 的规则，在进行 Exchange 与 Queue 的绑定时，需要指定一个 BindingKey，Binding 操作一般用于 RabbitMQ 的路由工作模式和主题工作模式。</p><blockquote><p>BindingKey 的概念，下面在讲 RabbitMQ 的工作模式会详细讲解。</p></blockquote><h3 id=virtual-host>Virtual Host
<a class=header-anchor href=#virtual-host></a></h3><p>Virutal host 也叫虚拟主机，一个 VirtualHost 下面有一组不同 Exchnage 与 Queue，不同的 Virtual host 的 Exchnage 与 Queue 之间互相不影响。应用隔离与权限划分，Virtual host 是 RabbitMQ 中最小颗粒的权限单位划分。</p><p>如果要类比的话，我们可以把 Virtual host 比作 MySQL 中的数据库，通常我们在使用 MySQL 时，会为不同的项目指定不同的数据库，同样的，在使用 RabbitMQ 时，我们可以为不同的应用程序指定不同的 Virtual host。</p><p><img src=/imgs/img-lazy-loading.gif data-src=/images/4ee9330b-d0fc-4dc9-bc74-e05fb06d40c7.png alt></p><p>请参考：
<a href=https://www.rabbitmq.com/getstarted.html title=www.rabbitmq.com/getstarted.… rel="noopener external nofollow noreferrer" target=_blank class=exturl>www.rabbitmq.com/getstarted.…
<i class="fa fa-external-link-alt"></i></a></p><h2 id=简单-simple-模式>简单 (simple) 模式
<a class=header-anchor href=#%e7%ae%80%e5%8d%95-simple-%e6%a8%a1%e5%bc%8f></a></h2><p>simple 模式，是 RabbitMQ 几种模式中最简单的一种模式，其结构如下图所示：</p><p><img src=/imgs/img-lazy-loading.gif data-src=/images/6f7e393f-d4c7-406b-a1c2-221319cadf7f.png alt></p><p>从上面的示意图，我们可以看出<code>simple</code>模式有以下几个特征：</p><ul><li>只有一个生产者、一个消费者和一个队列。</li><li>生产者和消费者在发送和接收消息时，只需要指定队列名，而不需要指定发送到哪个 Exchange，RabbitMQ 服务器会自动使用 Virtual host 的默认的 Exchange，默认 Exchange 的 type 为 direct。</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 引入amqo包
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;github.com/streadway/amqp&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;log&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> (
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>LOGIN</span> <span style=color:#66d9ef>string</span> = <span style=color:#e6db74>&#34;zhaohaiyu&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>PASSWORD</span> <span style=color:#66d9ef>string</span> = <span style=color:#e6db74>&#34;zhy.1996&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>HOST</span> <span style=color:#66d9ef>string</span> = <span style=color:#e6db74>&#34;127.0.0.1&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>PORT</span> <span style=color:#66d9ef>string</span> = <span style=color:#e6db74>&#34;5672&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>VIRTUALHOST</span> <span style=color:#66d9ef>string</span> = <span style=color:#e6db74>&#34;/&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Pushlish</span>() {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 创建链接
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>url</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;amqp://%s:%s@%s:%s%s&#34;</span>, <span style=color:#a6e22e>LOGIN</span>, <span style=color:#a6e22e>PASSWORD</span>, <span style=color:#a6e22e>HOST</span>, <span style=color:#a6e22e>PORT</span>, <span style=color:#a6e22e>VIRTUALHOST</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>conn</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>amqp</span>.<span style=color:#a6e22e>Dial</span>(<span style=color:#a6e22e>url</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>failOnError</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;Failed to connect to RabbitMQ&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>conn</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 打开一个通道
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>ch</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>conn</span>.<span style=color:#a6e22e>Channel</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>failOnError</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;Failed to open a channel&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>ch</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 生成一个交换机（交换机不存在的情况下）
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>ch</span>.<span style=color:#a6e22e>ExchangeDeclare</span>(<span style=color:#e6db74>&#34;test&#34;</span>,<span style=color:#e6db74>&#34;direct&#34;</span>, <span style=color:#66d9ef>true</span>,<span style=color:#66d9ef>false</span>,<span style=color:#66d9ef>false</span>, <span style=color:#66d9ef>false</span>, <span style=color:#66d9ef>nil</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>failOnError</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;Failed to declare an exchange&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 生成一个队列队列（队列不存在的情况下）
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>ch</span>.<span style=color:#a6e22e>QueueDeclare</span>(<span style=color:#e6db74>&#34;test1&#34;</span>, <span style=color:#66d9ef>true</span>, <span style=color:#66d9ef>false</span>, <span style=color:#66d9ef>false</span>, <span style=color:#66d9ef>false</span>, <span style=color:#66d9ef>nil</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>failOnError</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;Failed to declare an queue&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>//列队与交换机绑定
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>ch</span>.<span style=color:#a6e22e>QueueBind</span>(<span style=color:#e6db74>&#34;test1&#34;</span>, <span style=color:#e6db74>&#34;zhaohaiyu&#34;</span>, <span style=color:#e6db74>&#34;test&#34;</span>, <span style=color:#66d9ef>false</span>, <span style=color:#66d9ef>nil</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>failOnError</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;Bind queue to exchange failure&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>//指定交换机发布消息
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>ch</span>.<span style=color:#a6e22e>Publish</span>(<span style=color:#e6db74>&#34;test&#34;</span>, <span style=color:#e6db74>&#34;zhaohaiyu&#34;</span>, <span style=color:#66d9ef>false</span>, <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>amqp</span>.<span style=color:#a6e22e>Publishing</span>{
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>ContentType</span>: <span style=color:#e6db74>&#34;text/plain&#34;</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>Body</span>:        []byte(<span style=color:#e6db74>&#34;生产者测试1&#34;</span>),
</span></span><span style=display:flex><span>		})
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>failOnError</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;Message publish failure&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Get</span>() {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 创建链接
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>url</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;amqp://%s:%s@%s:%s%s&#34;</span>, <span style=color:#a6e22e>LOGIN</span>, <span style=color:#a6e22e>PASSWORD</span>, <span style=color:#a6e22e>HOST</span>, <span style=color:#a6e22e>PORT</span>, <span style=color:#a6e22e>VIRTUALHOST</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>conn</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>amqp</span>.<span style=color:#a6e22e>Dial</span>(<span style=color:#a6e22e>url</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>failOnError</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;Failed to connect to RabbitMQ&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>conn</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 打开一个通道
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>ch</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>conn</span>.<span style=color:#a6e22e>Channel</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>failOnError</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;Failed to open a channel&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>ch</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 指定队列获取消息
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>ok</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ch</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#e6db74>&#34;test1&#34;</span>, <span style=color:#66d9ef>true</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>failOnError</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;Message empty&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(string(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>Body</span>), <span style=color:#a6e22e>ok</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>failOnError</span>(<span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>, <span style=color:#a6e22e>msg</span> <span style=color:#66d9ef>string</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatalf</span>(<span style=color:#e6db74>&#34;%s: %s&#34;</span>, <span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Pushlish</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Get</span>()
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e>结果：产者测试1 true
</span></span></span><span style=display:flex><span><span style=color:#75715e>*/</span>
</span></span></code></pre></div><h2 id=工作-work-模式>工作 (work) 模式
<a class=header-anchor href=#%e5%b7%a5%e4%bd%9c-work-%e6%a8%a1%e5%bc%8f></a></h2><p>在 simple 模式下只有一个生产者和消费者，当生产者生产消息的速度大于消费者的消费速度时，我们可以添加一个或多个消费者来加快消费速度，这种在 simple 模式下增加消费者的模式，称为 work 模式，如下图所示：</p><p><img src=/imgs/img-lazy-loading.gif data-src=/images/21606601-f4d0-4f45-a1e6-f5416d66f646.png alt></p><p>work 模式有以下两个特征：</p><ul><li>可以有多个消费者，但一条消息只能被一个消费者获取。</li><li>发送到队列中的消息，由服务器平均分配给不同消费者进行消费</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 引入amqo包
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;github.com/streadway/amqp&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;log&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;time&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> (
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>LOGIN</span> <span style=color:#66d9ef>string</span> = <span style=color:#e6db74>&#34;zhaohaiyu&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>PASSWORD</span> <span style=color:#66d9ef>string</span> = <span style=color:#e6db74>&#34;zhy.1996&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>HOST</span> <span style=color:#66d9ef>string</span> = <span style=color:#e6db74>&#34;127.0.0.1&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>PORT</span> <span style=color:#66d9ef>string</span> = <span style=color:#e6db74>&#34;5672&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>VIRTUALHOST</span> <span style=color:#66d9ef>string</span> = <span style=color:#e6db74>&#34;/&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Pushlish</span>() {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 创建链接
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>url</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;amqp://%s:%s@%s:%s%s&#34;</span>, <span style=color:#a6e22e>LOGIN</span>, <span style=color:#a6e22e>PASSWORD</span>, <span style=color:#a6e22e>HOST</span>, <span style=color:#a6e22e>PORT</span>, <span style=color:#a6e22e>VIRTUALHOST</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>conn</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>amqp</span>.<span style=color:#a6e22e>Dial</span>(<span style=color:#a6e22e>url</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>failOnError</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;Failed to connect to RabbitMQ&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>conn</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 打开一个通道
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>ch</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>conn</span>.<span style=color:#a6e22e>Channel</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>failOnError</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;Failed to open a channel&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>ch</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 生成一个交换机（交换机不存在的情况下）
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>ch</span>.<span style=color:#a6e22e>ExchangeDeclare</span>(<span style=color:#e6db74>&#34;test&#34;</span>,<span style=color:#e6db74>&#34;direct&#34;</span>, <span style=color:#66d9ef>true</span>,<span style=color:#66d9ef>false</span>,<span style=color:#66d9ef>false</span>, <span style=color:#66d9ef>false</span>, <span style=color:#66d9ef>nil</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>failOnError</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;Failed to declare an exchange&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 生成一个队列队列（队列不存在的情况下）
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>ch</span>.<span style=color:#a6e22e>QueueDeclare</span>(<span style=color:#e6db74>&#34;test1&#34;</span>, <span style=color:#66d9ef>true</span>, <span style=color:#66d9ef>false</span>, <span style=color:#66d9ef>false</span>, <span style=color:#66d9ef>false</span>, <span style=color:#66d9ef>nil</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>failOnError</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;Failed to declare an queue&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>//列队与交换机绑定
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>ch</span>.<span style=color:#a6e22e>QueueBind</span>(<span style=color:#e6db74>&#34;test1&#34;</span>, <span style=color:#e6db74>&#34;zhaohaiyu&#34;</span>, <span style=color:#e6db74>&#34;test&#34;</span>, <span style=color:#66d9ef>false</span>, <span style=color:#66d9ef>nil</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>failOnError</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;Bind queue to exchange failure&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>//指定交换机发布消息
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>ch</span>.<span style=color:#a6e22e>Publish</span>(<span style=color:#e6db74>&#34;test&#34;</span>, <span style=color:#e6db74>&#34;zhaohaiyu&#34;</span>, <span style=color:#66d9ef>false</span>, <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>amqp</span>.<span style=color:#a6e22e>Publishing</span>{
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>ContentType</span>: <span style=color:#e6db74>&#34;text/plain&#34;</span>,
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>Body</span>:        []byte(<span style=color:#e6db74>&#34;生产者测试1&#34;</span>),
</span></span><span style=display:flex><span>			})
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>failOnError</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;Message publish failure&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Get1</span>() {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 创建链接
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>url</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;amqp://%s:%s@%s:%s%s&#34;</span>, <span style=color:#a6e22e>LOGIN</span>, <span style=color:#a6e22e>PASSWORD</span>, <span style=color:#a6e22e>HOST</span>, <span style=color:#a6e22e>PORT</span>, <span style=color:#a6e22e>VIRTUALHOST</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>conn</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>amqp</span>.<span style=color:#a6e22e>Dial</span>(<span style=color:#a6e22e>url</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>failOnError</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;Failed to connect to RabbitMQ&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>conn</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 打开一个通道
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>ch</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>conn</span>.<span style=color:#a6e22e>Channel</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>failOnError</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;Failed to open a channel&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>ch</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 指定队列获取消息
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>ok</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ch</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#e6db74>&#34;test1&#34;</span>, <span style=color:#66d9ef>true</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>failOnError</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;Message empty&#34;</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Get1&#34;</span>, string(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>Body</span>), <span style=color:#a6e22e>ok</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Get2</span>() {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 创建链接
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>url</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;amqp://%s:%s@%s:%s%s&#34;</span>, <span style=color:#a6e22e>LOGIN</span>, <span style=color:#a6e22e>PASSWORD</span>, <span style=color:#a6e22e>HOST</span>, <span style=color:#a6e22e>PORT</span>, <span style=color:#a6e22e>VIRTUALHOST</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>conn</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>amqp</span>.<span style=color:#a6e22e>Dial</span>(<span style=color:#a6e22e>url</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>failOnError</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;Failed to connect to RabbitMQ&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>conn</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 打开一个通道
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>ch</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>conn</span>.<span style=color:#a6e22e>Channel</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>failOnError</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;Failed to open a channel&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>ch</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 指定队列获取消息
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>ok</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ch</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#e6db74>&#34;test1&#34;</span>, <span style=color:#66d9ef>true</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>failOnError</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;Message empty&#34;</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Get2&#34;</span>, string(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>Body</span>), <span style=color:#a6e22e>ok</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>failOnError</span>(<span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>, <span style=color:#a6e22e>msg</span> <span style=color:#66d9ef>string</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatalf</span>(<span style=color:#e6db74>&#34;%s: %s&#34;</span>, <span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>go</span> <span style=color:#a6e22e>Pushlish</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>go</span> <span style=color:#a6e22e>Get1</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>go</span> <span style=color:#a6e22e>Get2</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>20</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e>结果：Get1  false
</span></span></span><span style=display:flex><span><span style=color:#75715e>Get2 生产者测试1 true
</span></span></span><span style=display:flex><span><span style=color:#75715e>Get2  false
</span></span></span><span style=display:flex><span><span style=color:#75715e>Get1 生产者测试1 true
</span></span></span><span style=display:flex><span><span style=color:#75715e>Get1  false
</span></span></span><span style=display:flex><span><span style=color:#75715e>Get2 生产者测试1 true
</span></span></span><span style=display:flex><span><span style=color:#75715e>Get2  false
</span></span></span><span style=display:flex><span><span style=color:#75715e>Get1 生产者测试1 true
</span></span></span><span style=display:flex><span><span style=color:#75715e>Get1 生产者测试1 true
</span></span></span><span style=display:flex><span><span style=color:#75715e>Get2  false
</span></span></span><span style=display:flex><span><span style=color:#75715e>Get2  false
</span></span></span><span style=display:flex><span><span style=color:#75715e>Get1 生产者测试1 true
</span></span></span><span style=display:flex><span><span style=color:#75715e>Get2  false
</span></span></span><span style=display:flex><span><span style=color:#75715e>Get1 生产者测试1 true
</span></span></span><span style=display:flex><span><span style=color:#75715e>Get2  false
</span></span></span><span style=display:flex><span><span style=color:#75715e>Get1 生产者测试1 true
</span></span></span><span style=display:flex><span><span style=color:#75715e>Get1 生产者测试1 true
</span></span></span><span style=display:flex><span><span style=color:#75715e>Get2  false
</span></span></span><span style=display:flex><span><span style=color:#75715e>Get2  false
</span></span></span><span style=display:flex><span><span style=color:#75715e>Get1 生产者测试1 true
</span></span></span><span style=display:flex><span><span style=color:#75715e>Get1 生产者测试1 true
</span></span></span><span style=display:flex><span><span style=color:#75715e>Get2  false
</span></span></span><span style=display:flex><span><span style=color:#75715e>Get1 生产者测试1 true
</span></span></span><span style=display:flex><span><span style=color:#75715e>Get2  false
</span></span></span><span style=display:flex><span><span style=color:#75715e>Get2  false
</span></span></span><span style=display:flex><span><span style=color:#75715e>Get1 生产者测试1 true
</span></span></span><span style=display:flex><span><span style=color:#75715e>Get2  false
</span></span></span><span style=display:flex><span><span style=color:#75715e>Get1 生产者测试1 true
</span></span></span><span style=display:flex><span><span style=color:#75715e>Get1 生产者测试1 true
</span></span></span><span style=display:flex><span><span style=color:#75715e>Get2  false
</span></span></span><span style=display:flex><span><span style=color:#75715e>Get1 生产者测试1 true
</span></span></span><span style=display:flex><span><span style=color:#75715e>Get2  false
</span></span></span><span style=display:flex><span><span style=color:#75715e>Get2 生产者测试1 true
</span></span></span><span style=display:flex><span><span style=color:#75715e>Get1  false
</span></span></span><span style=display:flex><span><span style=color:#75715e>Get2  false
</span></span></span><span style=display:flex><span><span style=color:#75715e>Get1 生产者测试1 true
</span></span></span><span style=display:flex><span><span style=color:#75715e>Get1 生产者测试1 true
</span></span></span><span style=display:flex><span><span style=color:#75715e>Get2  false
</span></span></span><span style=display:flex><span><span style=color:#75715e>*/</span>
</span></span></code></pre></div><h2 id=发布--订阅-pubsub-模式>发布 / 订阅 (pub/sub) 模式
<a class=header-anchor href=#%e5%8f%91%e5%b8%83--%e8%ae%a2%e9%98%85-pubsub-%e6%a8%a1%e5%bc%8f></a></h2><p>work 模式可以将消息转到多个消费者，但每条消息只能由一个消费者获取，如果我们想一条消息可以同时给多个消费者消费呢？</p><p>这时候就需要发布 / 订阅模式，其示意图如下所示：</p><p><img src=/imgs/img-lazy-loading.gif data-src=/images/86400d5c-7cc7-4170-ac4a-4aea2aa15fa8.png alt></p><p>从上面的示意图我们可以看出来，在发布 / 订阅模式下，需要指定发送到哪个 Exchange 中，上面图中的 X 表示 Exchange。</p><ul><li>发布 / 订阅模式中，Echange 的 type 为 fanout。</li><li>生产者发送消息时，不需要指定具体的队列名，Exchange 会将收到的消息转发到所绑定的队列。</li><li>消息被 Exchange 转到多个队列，一条消息可以被多个消费者获取。</li></ul><p>在上图中，oneQueue 中的消息要么被 CustomerA 获取，要么被 CustomerB 获取。也就是同一条消息，要么是 CustomerA + CustomerC 消费、要么是 CustomerB + CustomerC 消费。</p><p>生产者：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;github.com/streadway/amqp&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;log&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;os&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;strings&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> (
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>LOGIN</span> <span style=color:#66d9ef>string</span> = <span style=color:#e6db74>&#34;zhaohaiyu&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>PASSWORD</span> <span style=color:#66d9ef>string</span> = <span style=color:#e6db74>&#34;zhy.1996&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>HOST</span> <span style=color:#66d9ef>string</span> = <span style=color:#e6db74>&#34;127.0.0.1&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>PORT</span> <span style=color:#66d9ef>string</span> = <span style=color:#e6db74>&#34;5672&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>VIRTUALHOST</span> <span style=color:#66d9ef>string</span> = <span style=color:#e6db74>&#34;/&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>//url := fmt.Sprintf()
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>failOnError</span>(<span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>, <span style=color:#a6e22e>msg</span> <span style=color:#66d9ef>string</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatalf</span>(<span style=color:#e6db74>&#34;%s: %s&#34;</span>, <span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>conn</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>amqp</span>.<span style=color:#a6e22e>Dial</span>(<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;amqp://%s:%s@%s:%s%s&#34;</span>, <span style=color:#a6e22e>LOGIN</span>, <span style=color:#a6e22e>PASSWORD</span>, <span style=color:#a6e22e>HOST</span>, <span style=color:#a6e22e>PORT</span>, <span style=color:#a6e22e>VIRTUALHOST</span>))
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>failOnError</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;Failed to connect to RabbitMQ&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>conn</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ch</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>conn</span>.<span style=color:#a6e22e>Channel</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>failOnError</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;Failed to open a channel&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>ch</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>ch</span>.<span style=color:#a6e22e>ExchangeDeclare</span>(
</span></span><span style=display:flex><span>		<span style=color:#e6db74>&#34;logs&#34;</span>,   <span style=color:#75715e>// name
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#e6db74>&#34;fanout&#34;</span>, <span style=color:#75715e>// type
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>true</span>,     <span style=color:#75715e>// durable
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>false</span>,    <span style=color:#75715e>// auto-deleted
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>false</span>,    <span style=color:#75715e>// internal
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>false</span>,    <span style=color:#75715e>// no-wait
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>nil</span>,      <span style=color:#75715e>// arguments
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>failOnError</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;Failed to declare an exchange&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>body</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>bodyFrom</span>(<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Args</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>ch</span>.<span style=color:#a6e22e>Publish</span>(
</span></span><span style=display:flex><span>		<span style=color:#e6db74>&#34;logs&#34;</span>, <span style=color:#75715e>// exchange
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#e6db74>&#34;&#34;</span>,     <span style=color:#75715e>// routing key
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>false</span>,  <span style=color:#75715e>// mandatory
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>false</span>,  <span style=color:#75715e>// immediate
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>amqp</span>.<span style=color:#a6e22e>Publishing</span>{
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>ContentType</span>: <span style=color:#e6db74>&#34;text/plain&#34;</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>Body</span>:        []byte(<span style=color:#a6e22e>body</span>),
</span></span><span style=display:flex><span>		})
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>failOnError</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;Failed to publish a message&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34; [x] Sent %s&#34;</span>, <span style=color:#a6e22e>body</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>bodyFrom</span>(<span style=color:#a6e22e>args</span> []<span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>string</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>s</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (len(<span style=color:#a6e22e>args</span>) &lt; <span style=color:#ae81ff>2</span>) <span style=color:#f92672>||</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Args</span>[<span style=color:#ae81ff>1</span>] <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;&#34;</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>s</span> = <span style=color:#e6db74>&#34;hello&#34;</span>
</span></span><span style=display:flex><span>	} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>s</span> = <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>Join</span>(<span style=color:#a6e22e>args</span>[<span style=color:#ae81ff>1</span>:], <span style=color:#e6db74>&#34; &#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>s</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>不同的 Exchange 之间互不影响，相同 Exchange，相同队列的情况下，消息均等消费：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;github.com/streadway/amqp&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;log&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> (
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>LOGIN</span> <span style=color:#66d9ef>string</span> = <span style=color:#e6db74>&#34;zhaohaiyu&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>PASSWORD</span> <span style=color:#66d9ef>string</span> = <span style=color:#e6db74>&#34;zhy.1996&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>HOST</span> <span style=color:#66d9ef>string</span> = <span style=color:#e6db74>&#34;127.0.0.1&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>PORT</span> <span style=color:#66d9ef>string</span> = <span style=color:#e6db74>&#34;5672&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>VIRTUALHOST</span> <span style=color:#66d9ef>string</span> = <span style=color:#e6db74>&#34;/&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>failOnError</span>(<span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>, <span style=color:#a6e22e>msg</span> <span style=color:#66d9ef>string</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatalf</span>(<span style=color:#e6db74>&#34;%s: %s&#34;</span>, <span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>conn</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>amqp</span>.<span style=color:#a6e22e>Dial</span>(<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;amqp://%s:%s@%s:%s%s&#34;</span>, <span style=color:#a6e22e>LOGIN</span>, <span style=color:#a6e22e>PASSWORD</span>, <span style=color:#a6e22e>HOST</span>, <span style=color:#a6e22e>PORT</span>, <span style=color:#a6e22e>VIRTUALHOST</span>))
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>failOnError</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;Failed to connect to RabbitMQ&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>conn</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ch</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>conn</span>.<span style=color:#a6e22e>Channel</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>failOnError</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;Failed to open a channel&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>ch</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>ch</span>.<span style=color:#a6e22e>ExchangeDeclare</span>(
</span></span><span style=display:flex><span>		<span style=color:#e6db74>&#34;logs&#34;</span>,   <span style=color:#75715e>// name
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#e6db74>&#34;fanout&#34;</span>, <span style=color:#75715e>// type
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>true</span>,     <span style=color:#75715e>// durable
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>false</span>,    <span style=color:#75715e>// auto-deleted
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>false</span>,    <span style=color:#75715e>// internal
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>false</span>,    <span style=color:#75715e>// no-wait
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>nil</span>,      <span style=color:#75715e>// arguments
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>failOnError</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;Failed to declare an exchange&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>q</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ch</span>.<span style=color:#a6e22e>QueueDeclare</span>(
</span></span><span style=display:flex><span>		<span style=color:#e6db74>&#34;&#34;</span>,    <span style=color:#75715e>// name
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>false</span>, <span style=color:#75715e>// durable
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>false</span>, <span style=color:#75715e>// delete when unused
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>true</span>,  <span style=color:#75715e>// exclusive
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>false</span>, <span style=color:#75715e>// no-wait
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>nil</span>,   <span style=color:#75715e>// arguments
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>failOnError</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;Failed to declare a queue&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>ch</span>.<span style=color:#a6e22e>QueueBind</span>(
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>q</span>.<span style=color:#a6e22e>Name</span>, <span style=color:#75715e>// queue name
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#e6db74>&#34;&#34;</span>,     <span style=color:#75715e>// routing key
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#e6db74>&#34;logs&#34;</span>, <span style=color:#75715e>// exchange
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>nil</span>,
</span></span><span style=display:flex><span>	)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>failOnError</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;Failed to bind a queue&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>msgs</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ch</span>.<span style=color:#a6e22e>Consume</span>(
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>q</span>.<span style=color:#a6e22e>Name</span>, <span style=color:#75715e>// queue
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#e6db74>&#34;&#34;</span>,     <span style=color:#75715e>// consumer
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>true</span>,   <span style=color:#75715e>// auto-ack
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>false</span>,  <span style=color:#75715e>// exclusive
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>false</span>,  <span style=color:#75715e>// no-local
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>false</span>,  <span style=color:#75715e>// no-wait
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>nil</span>,    <span style=color:#75715e>// args
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>failOnError</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;Failed to register a consumer&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>forever</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>bool</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>d</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>msgs</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34; [x] %s&#34;</span>, <span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>Body</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34; [*] Waiting for logs. To exit press CTRL+C&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>forever</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>相同 Exchange，不同队列的情况下，一条消息可以被多个消费者获取。</p><h2 id=路由-routing-模式>路由 (routing) 模式
<a class=header-anchor href=#%e8%b7%af%e7%94%b1-routing-%e6%a8%a1%e5%bc%8f></a></h2><p>前面几种模式，消息的目标队列无法由生产者指定，而在路由模式下，消息的目标队列，可以由生产者指定，其示意图如下所示：</p><p><img src=/imgs/img-lazy-loading.gif data-src=/images/3e912744-2919-4a56-b42a-87b67d02d096.png alt></p><ul><li>路由模式下<code>Exchange</code>的 type 为<code>direct</code>。</li><li>消息的目标队列可以由生产者按照<code>routingKey</code>规则指定。</li><li>消费者通过<code>BindingKey</code>绑定自己所关心的队列。</li><li>一条消息队可以被多个消息者获取。</li><li>只有<code>RoutingKey</code>与<code>BidingKey</code>相匹配的队列才会收到消息。</li></ul><blockquote><p><code>RoutingKey</code>用于生产者指定<code>Exchange</code>最终将消息路由到哪个队列，<code>BindingKey</code>用于消费者绑定到某个队列。</p></blockquote><p>生产者：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;log&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;os&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;strings&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;github.com/streadway/amqp&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> (
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>LOGIN</span> <span style=color:#66d9ef>string</span> = <span style=color:#e6db74>&#34;zhaohaiyu&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>PASSWORD</span> <span style=color:#66d9ef>string</span> = <span style=color:#e6db74>&#34;zhy.1996&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>HOST</span> <span style=color:#66d9ef>string</span> = <span style=color:#e6db74>&#34;127.0.0.1&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>PORT</span> <span style=color:#66d9ef>string</span> = <span style=color:#e6db74>&#34;5672&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>VIRTUALHOST</span> <span style=color:#66d9ef>string</span> = <span style=color:#e6db74>&#34;/&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>failOnError</span>(<span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>, <span style=color:#a6e22e>msg</span> <span style=color:#66d9ef>string</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatalf</span>(<span style=color:#e6db74>&#34;%s: %s&#34;</span>, <span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>conn</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>amqp</span>.<span style=color:#a6e22e>Dial</span>(<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;amqp://%s:%s@%s:%s%s&#34;</span>, <span style=color:#a6e22e>LOGIN</span>, <span style=color:#a6e22e>PASSWORD</span>, <span style=color:#a6e22e>HOST</span>, <span style=color:#a6e22e>PORT</span>, <span style=color:#a6e22e>VIRTUALHOST</span>))
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>failOnError</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;Failed to connect to RabbitMQ&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>conn</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ch</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>conn</span>.<span style=color:#a6e22e>Channel</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>failOnError</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;Failed to open a channel&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>ch</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>ch</span>.<span style=color:#a6e22e>ExchangeDeclare</span>(
</span></span><span style=display:flex><span>		<span style=color:#e6db74>&#34;logs_direct&#34;</span>, <span style=color:#75715e>// name
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#e6db74>&#34;direct&#34;</span>,      <span style=color:#75715e>// type
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>true</span>,          <span style=color:#75715e>// durable
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>false</span>,         <span style=color:#75715e>// auto-deleted
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>false</span>,         <span style=color:#75715e>// internal
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>false</span>,         <span style=color:#75715e>// no-wait
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>nil</span>,           <span style=color:#75715e>// arguments
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>failOnError</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;Failed to declare an exchange&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>body</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>bodyFrom</span>(<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Args</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>ch</span>.<span style=color:#a6e22e>Publish</span>(
</span></span><span style=display:flex><span>		<span style=color:#e6db74>&#34;logs_direct&#34;</span>,         <span style=color:#75715e>// exchange
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>severityFrom</span>(<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Args</span>), <span style=color:#75715e>// routing key
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>false</span>, <span style=color:#75715e>// mandatory
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>false</span>, <span style=color:#75715e>// immediate
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>amqp</span>.<span style=color:#a6e22e>Publishing</span>{
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>ContentType</span>: <span style=color:#e6db74>&#34;text/plain&#34;</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>Body</span>:        []byte(<span style=color:#a6e22e>body</span>),
</span></span><span style=display:flex><span>		})
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>failOnError</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;Failed to publish a message&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34; [x] Sent %s&#34;</span>, <span style=color:#a6e22e>body</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>bodyFrom</span>(<span style=color:#a6e22e>args</span> []<span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>string</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>s</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (len(<span style=color:#a6e22e>args</span>) &lt; <span style=color:#ae81ff>3</span>) <span style=color:#f92672>||</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Args</span>[<span style=color:#ae81ff>2</span>] <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;&#34;</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>s</span> = <span style=color:#e6db74>&#34;hello&#34;</span>
</span></span><span style=display:flex><span>	} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>s</span> = <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>Join</span>(<span style=color:#a6e22e>args</span>[<span style=color:#ae81ff>2</span>:], <span style=color:#e6db74>&#34; &#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>s</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>severityFrom</span>(<span style=color:#a6e22e>args</span> []<span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>string</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>s</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (len(<span style=color:#a6e22e>args</span>) &lt; <span style=color:#ae81ff>2</span>) <span style=color:#f92672>||</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Args</span>[<span style=color:#ae81ff>1</span>] <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;&#34;</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>s</span> = <span style=color:#e6db74>&#34;info&#34;</span>
</span></span><span style=display:flex><span>	} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>s</span> = <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Args</span>[<span style=color:#ae81ff>1</span>]
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>s</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>消费者：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;log&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;os&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;github.com/streadway/amqp&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> (
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>LOGIN</span> <span style=color:#66d9ef>string</span> = <span style=color:#e6db74>&#34;zhaohaiyu&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>PASSWORD</span> <span style=color:#66d9ef>string</span> = <span style=color:#e6db74>&#34;zhy.1996&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>HOST</span> <span style=color:#66d9ef>string</span> = <span style=color:#e6db74>&#34;127.0.0.1&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>PORT</span> <span style=color:#66d9ef>string</span> = <span style=color:#e6db74>&#34;5672&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>VIRTUALHOST</span> <span style=color:#66d9ef>string</span> = <span style=color:#e6db74>&#34;/&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>failOnError</span>(<span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>, <span style=color:#a6e22e>msg</span> <span style=color:#66d9ef>string</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatalf</span>(<span style=color:#e6db74>&#34;%s: %s&#34;</span>, <span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>conn</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>amqp</span>.<span style=color:#a6e22e>Dial</span>(<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;amqp://%s:%s@%s:%s%s&#34;</span>, <span style=color:#a6e22e>LOGIN</span>, <span style=color:#a6e22e>PASSWORD</span>, <span style=color:#a6e22e>HOST</span>, <span style=color:#a6e22e>PORT</span>, <span style=color:#a6e22e>VIRTUALHOST</span>))
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>failOnError</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;Failed to connect to RabbitMQ&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>conn</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ch</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>conn</span>.<span style=color:#a6e22e>Channel</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>failOnError</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;Failed to open a channel&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>ch</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>ch</span>.<span style=color:#a6e22e>ExchangeDeclare</span>(
</span></span><span style=display:flex><span>		<span style=color:#e6db74>&#34;logs_direct&#34;</span>, <span style=color:#75715e>// name
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#e6db74>&#34;direct&#34;</span>,      <span style=color:#75715e>// type
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>true</span>,          <span style=color:#75715e>// durable
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>false</span>,         <span style=color:#75715e>// auto-deleted
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>false</span>,         <span style=color:#75715e>// internal
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>false</span>,         <span style=color:#75715e>// no-wait
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>nil</span>,           <span style=color:#75715e>// arguments
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>failOnError</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;Failed to declare an exchange&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>q</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ch</span>.<span style=color:#a6e22e>QueueDeclare</span>(
</span></span><span style=display:flex><span>		<span style=color:#e6db74>&#34;&#34;</span>,    <span style=color:#75715e>// name
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>false</span>, <span style=color:#75715e>// durable
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>false</span>, <span style=color:#75715e>// delete when unused
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>true</span>,  <span style=color:#75715e>// exclusive
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>false</span>, <span style=color:#75715e>// no-wait
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>nil</span>,   <span style=color:#75715e>// arguments
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>failOnError</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;Failed to declare a queue&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Args</span>) &lt; <span style=color:#ae81ff>2</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;Usage: %s [info] [warning] [error]&#34;</span>, <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Args</span>[<span style=color:#ae81ff>0</span>])
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Exit</span>(<span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>s</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Args</span>[<span style=color:#ae81ff>1</span>:] {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;Binding queue %s to exchange %s with routing key %s&#34;</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>q</span>.<span style=color:#a6e22e>Name</span>, <span style=color:#e6db74>&#34;logs_direct&#34;</span>, <span style=color:#a6e22e>s</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>ch</span>.<span style=color:#a6e22e>QueueBind</span>(
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>q</span>.<span style=color:#a6e22e>Name</span>,        <span style=color:#75715e>// queue name
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#a6e22e>s</span>,             <span style=color:#75715e>// routing key
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#e6db74>&#34;logs_direct&#34;</span>, <span style=color:#75715e>// exchange
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>nil</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>failOnError</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;Failed to bind a queue&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>msgs</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ch</span>.<span style=color:#a6e22e>Consume</span>(
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>q</span>.<span style=color:#a6e22e>Name</span>, <span style=color:#75715e>// queue
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#e6db74>&#34;&#34;</span>,     <span style=color:#75715e>// consumer
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>true</span>,   <span style=color:#75715e>// auto ack
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>false</span>,  <span style=color:#75715e>// exclusive
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>false</span>,  <span style=color:#75715e>// no local
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>false</span>,  <span style=color:#75715e>// no wait
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>nil</span>,    <span style=color:#75715e>// args
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>failOnError</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;Failed to register a consumer&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>forever</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>bool</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>d</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>msgs</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34; [x] %s&#34;</span>, <span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>Body</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34; [*] Waiting for logs. To exit press CTRL+C&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>forever</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=主题-topic-模式>主题 (Topic) 模式
<a class=header-anchor href=#%e4%b8%bb%e9%a2%98-topic-%e6%a8%a1%e5%bc%8f></a></h2><p>主题模式是在路由模式的基础上，将路由键和某模式进行匹配。其中<code>#</code>表示匹配多个词，<code>*</code>表示匹配一个词，消费者可以通过某种模式的 BindKey 来达到订阅某个主题消息的目的，如示意图如下所示：</p><p><img src=/imgs/img-lazy-loading.gif data-src=/images/f7433c1b-3743-405a-8107-47f918379334.png alt></p><ul><li>主题模式 Exchange 的 type 取值为 topic。</li><li>一条消息可以被多个消费者获取。</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;github.com/streadway/amqp&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;log&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;time&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> (
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>LOGIN</span>       <span style=color:#66d9ef>string</span> = <span style=color:#e6db74>&#34;zhaohaiyu&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>PASSWORD</span>    <span style=color:#66d9ef>string</span> = <span style=color:#e6db74>&#34;zhy.1996&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>HOST</span>        <span style=color:#66d9ef>string</span> = <span style=color:#e6db74>&#34;127.0.0.1&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>PORT</span>        <span style=color:#66d9ef>string</span> = <span style=color:#e6db74>&#34;5672&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>VIRTUALHOST</span> <span style=color:#66d9ef>string</span> = <span style=color:#e6db74>&#34;/&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>publish</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>url</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;amqp://%s:%s@%s:%s%s&#34;</span>, <span style=color:#a6e22e>LOGIN</span>, <span style=color:#a6e22e>PASSWORD</span>, <span style=color:#a6e22e>HOST</span>, <span style=color:#a6e22e>PORT</span>, <span style=color:#a6e22e>VIRTUALHOST</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>conn</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>amqp</span>.<span style=color:#a6e22e>Dial</span>(<span style=color:#a6e22e>url</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>failOnError</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;Failed to connect to RabbitMQ&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>conn</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ch</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>conn</span>.<span style=color:#a6e22e>Channel</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>failOnError</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;Failed to open a channel&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>ch</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>ch</span>.<span style=color:#a6e22e>ExchangeDeclare</span>(<span style=color:#e6db74>&#34;testTopic&#34;</span>, <span style=color:#a6e22e>amqp</span>.<span style=color:#a6e22e>ExchangeTopic</span>, <span style=color:#66d9ef>true</span>, <span style=color:#66d9ef>false</span>, <span style=color:#66d9ef>false</span>, <span style=color:#66d9ef>false</span>, <span style=color:#66d9ef>nil</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>failOnError</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;Failed to declare an exchange&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> &lt; <span style=color:#ae81ff>10</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>ch</span>.<span style=color:#a6e22e>Publish</span>(<span style=color:#e6db74>&#34;testTopic&#34;</span>, <span style=color:#e6db74>&#34;yuemoxi&#34;</span>, <span style=color:#66d9ef>false</span>, <span style=color:#66d9ef>false</span>, <span style=color:#a6e22e>amqp</span>.<span style=color:#a6e22e>Publishing</span>{
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>ContentType</span>: <span style=color:#e6db74>&#34;text/plain&#34;</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>Body</span>:        []byte(<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;time:%v&#34;</span>, <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>())),
</span></span><span style=display:flex><span>		})
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;发布成功!&#34;</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>get1</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>url</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;amqp://%s:%s@%s:%s%s&#34;</span>, <span style=color:#a6e22e>LOGIN</span>, <span style=color:#a6e22e>PASSWORD</span>, <span style=color:#a6e22e>HOST</span>, <span style=color:#a6e22e>PORT</span>, <span style=color:#a6e22e>VIRTUALHOST</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>conn</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>amqp</span>.<span style=color:#a6e22e>Dial</span>(<span style=color:#a6e22e>url</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>failOnError</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;Failed to connect to RabbitMQ&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>conn</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ch</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>conn</span>.<span style=color:#a6e22e>Channel</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>failOnError</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;Failed to open a channel&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>ch</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>ch</span>.<span style=color:#a6e22e>ExchangeDeclare</span>(<span style=color:#e6db74>&#34;testTopic&#34;</span>, <span style=color:#a6e22e>amqp</span>.<span style=color:#a6e22e>ExchangeTopic</span>, <span style=color:#66d9ef>true</span>, <span style=color:#66d9ef>false</span>, <span style=color:#66d9ef>false</span>, <span style=color:#66d9ef>false</span>, <span style=color:#66d9ef>nil</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>failOnError</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;Failed to declare an exchange&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>q</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ch</span>.<span style=color:#a6e22e>QueueDeclare</span>(<span style=color:#e6db74>&#34;testTopic_get1&#34;</span>, <span style=color:#66d9ef>false</span>, <span style=color:#66d9ef>false</span>, <span style=color:#66d9ef>false</span>, <span style=color:#66d9ef>false</span>, <span style=color:#66d9ef>nil</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>failOnError</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;Failed to declare a queue&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>ch</span>.<span style=color:#a6e22e>QueueBind</span>(<span style=color:#a6e22e>q</span>.<span style=color:#a6e22e>Name</span>, <span style=color:#e6db74>&#34;yuemox*&#34;</span>, <span style=color:#e6db74>&#34;testTopic&#34;</span>, <span style=color:#66d9ef>false</span>, <span style=color:#66d9ef>nil</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>failOnError</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;Failed to bind a queue&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>msgs</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ch</span>.<span style=color:#a6e22e>Consume</span>(<span style=color:#a6e22e>q</span>.<span style=color:#a6e22e>Name</span>, <span style=color:#e6db74>&#34;get1&#34;</span>, <span style=color:#66d9ef>true</span>, <span style=color:#66d9ef>false</span>, <span style=color:#66d9ef>false</span>, <span style=color:#66d9ef>false</span>, <span style=color:#66d9ef>nil</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>failOnError</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;Failed to register a consumer&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>msg</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>msgs</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;get1: %s&#34;</span>, <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>Body</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Millisecond</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>500</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>get2</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>url</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;amqp://%s:%s@%s:%s%s&#34;</span>, <span style=color:#a6e22e>LOGIN</span>, <span style=color:#a6e22e>PASSWORD</span>, <span style=color:#a6e22e>HOST</span>, <span style=color:#a6e22e>PORT</span>, <span style=color:#a6e22e>VIRTUALHOST</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>conn</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>amqp</span>.<span style=color:#a6e22e>Dial</span>(<span style=color:#a6e22e>url</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>failOnError</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;Failed to connect to RabbitMQ&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>conn</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ch</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>conn</span>.<span style=color:#a6e22e>Channel</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>failOnError</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;Failed to open a channel&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>ch</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>ch</span>.<span style=color:#a6e22e>ExchangeDeclare</span>(<span style=color:#e6db74>&#34;testTopic&#34;</span>, <span style=color:#a6e22e>amqp</span>.<span style=color:#a6e22e>ExchangeTopic</span>, <span style=color:#66d9ef>true</span>, <span style=color:#66d9ef>false</span>, <span style=color:#66d9ef>false</span>, <span style=color:#66d9ef>false</span>, <span style=color:#66d9ef>nil</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>failOnError</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;Failed to declare an exchange&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>q</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ch</span>.<span style=color:#a6e22e>QueueDeclare</span>(<span style=color:#e6db74>&#34;testTopic_get2&#34;</span>, <span style=color:#66d9ef>false</span>, <span style=color:#66d9ef>false</span>, <span style=color:#66d9ef>false</span>, <span style=color:#66d9ef>false</span>, <span style=color:#66d9ef>nil</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>failOnError</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;Failed to declare a queue&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>ch</span>.<span style=color:#a6e22e>QueueBind</span>(<span style=color:#a6e22e>q</span>.<span style=color:#a6e22e>Name</span>, <span style=color:#e6db74>&#34;#&#34;</span>, <span style=color:#e6db74>&#34;testTopic&#34;</span>, <span style=color:#66d9ef>false</span>, <span style=color:#66d9ef>nil</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>failOnError</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;Failed to bind a queue&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>msgs</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ch</span>.<span style=color:#a6e22e>Consume</span>(<span style=color:#a6e22e>q</span>.<span style=color:#a6e22e>Name</span>, <span style=color:#e6db74>&#34;get2&#34;</span>, <span style=color:#66d9ef>true</span>, <span style=color:#66d9ef>false</span>, <span style=color:#66d9ef>false</span>, <span style=color:#66d9ef>false</span>, <span style=color:#66d9ef>nil</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>failOnError</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;Failed to register a consumer&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>msg</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>msgs</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;get2: %s&#34;</span>, <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>Body</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Millisecond</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>500</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>failOnError</span>(<span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>, <span style=color:#a6e22e>msg</span> <span style=color:#66d9ef>string</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatalf</span>(<span style=color:#e6db74>&#34;%s: %s&#34;</span>, <span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>go</span> <span style=color:#a6e22e>publish</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>go</span> <span style=color:#a6e22e>get1</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>go</span> <span style=color:#a6e22e>get2</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>20</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e>结果：
</span></span></span><span style=display:flex><span><span style=color:#75715e>发布成功!
</span></span></span><span style=display:flex><span><span style=color:#75715e>2021/08/31 22:45:09 get1: time:2021-08-31 22:45:09.017664 +0800 CST m=+0.012626409
</span></span></span><span style=display:flex><span><span style=color:#75715e>发布成功!
</span></span></span><span style=display:flex><span><span style=color:#75715e>2021/08/31 22:45:10 get2: time:2021-08-31 22:45:10.022005 +0800 CST m=+1.016996649
</span></span></span><span style=display:flex><span><span style=color:#75715e>2021/08/31 22:45:10 get1: time:2021-08-31 22:45:10.022005 +0800 CST m=+1.016996649
</span></span></span><span style=display:flex><span><span style=color:#75715e>发布成功!
</span></span></span><span style=display:flex><span><span style=color:#75715e>2021/08/31 22:45:11 get2: time:2021-08-31 22:45:11.023542 +0800 CST m=+2.018558384
</span></span></span><span style=display:flex><span><span style=color:#75715e>2021/08/31 22:45:11 get1: time:2021-08-31 22:45:11.023542 +0800 CST m=+2.018558384
</span></span></span><span style=display:flex><span><span style=color:#75715e>发布成功!
</span></span></span><span style=display:flex><span><span style=color:#75715e>2021/08/31 22:45:12 get1: time:2021-08-31 22:45:12.028649 +0800 CST m=+3.023687209
</span></span></span><span style=display:flex><span><span style=color:#75715e>2021/08/31 22:45:12 get2: time:2021-08-31 22:45:12.028649 +0800 CST m=+3.023687209
</span></span></span><span style=display:flex><span><span style=color:#75715e>发布成功!
</span></span></span><span style=display:flex><span><span style=color:#75715e>2021/08/31 22:45:13 get2: time:2021-08-31 22:45:13.033497 +0800 CST m=+4.028553608
</span></span></span><span style=display:flex><span><span style=color:#75715e>2021/08/31 22:45:13 get1: time:2021-08-31 22:45:13.033497 +0800 CST m=+4.028553608
</span></span></span><span style=display:flex><span><span style=color:#75715e>发布成功!
</span></span></span><span style=display:flex><span><span style=color:#75715e>2021/08/31 22:45:14 get1: time:2021-08-31 22:45:14.03647 +0800 CST m=+5.031571881
</span></span></span><span style=display:flex><span><span style=color:#75715e>2021/08/31 22:45:14 get2: time:2021-08-31 22:45:14.03647 +0800 CST m=+5.031571881
</span></span></span><span style=display:flex><span><span style=color:#75715e>发布成功!
</span></span></span><span style=display:flex><span><span style=color:#75715e>2021/08/31 22:45:15 get2: time:2021-08-31 22:45:15.036783 +0800 CST m=+6.031867631
</span></span></span><span style=display:flex><span><span style=color:#75715e>2021/08/31 22:45:15 get1: time:2021-08-31 22:45:15.036783 +0800 CST m=+6.031867631
</span></span></span><span style=display:flex><span><span style=color:#75715e>发布成功!
</span></span></span><span style=display:flex><span><span style=color:#75715e>2021/08/31 22:45:16 get2: time:2021-08-31 22:45:16.041189 +0800 CST m=+7.036283180
</span></span></span><span style=display:flex><span><span style=color:#75715e>2021/08/31 22:45:16 get1: time:2021-08-31 22:45:16.041189 +0800 CST m=+7.036283180
</span></span></span><span style=display:flex><span><span style=color:#75715e>发布成功!
</span></span></span><span style=display:flex><span><span style=color:#75715e>2021/08/31 22:45:17 get1: time:2021-08-31 22:45:17.043382 +0800 CST m=+8.038484117
</span></span></span><span style=display:flex><span><span style=color:#75715e>2021/08/31 22:45:17 get2: time:2021-08-31 22:45:17.043382 +0800 CST m=+8.038484117
</span></span></span><span style=display:flex><span><span style=color:#75715e>发布成功!
</span></span></span><span style=display:flex><span><span style=color:#75715e>2021/08/31 22:45:18 get1: time:2021-08-31 22:45:18.04643 +0800 CST m=+9.041536815
</span></span></span><span style=display:flex><span><span style=color:#75715e>2021/08/31 22:45:18 get2: time:2021-08-31 22:45:18.04643 +0800 CST m=+9.041536815
</span></span></span><span style=display:flex><span><span style=color:#75715e>*/</span>
</span></span></code></pre></div><h2 id=延迟队列>延迟队列
<a class=header-anchor href=#%e5%bb%b6%e8%bf%9f%e9%98%9f%e5%88%97></a></h2><h3 id=什么是延迟队列>什么是延迟队列
<a class=header-anchor href=#%e4%bb%80%e4%b9%88%e6%98%af%e5%bb%b6%e8%bf%9f%e9%98%9f%e5%88%97></a></h3><p><code>延时队列</code>，首先，它是一种队列，队列意味着内部的元素是<code>有序</code>的，元素出队和入队是有方向性的，元素从一端进入，从另一端取出。</p><p>其次，<code>延时队列</code>，最重要的特性就体现在它的<code>延时</code>属性上，跟普通的队列不一样的是，<code>普通队列中的元素总是等着希望被早点取出处理，而延时队列中的元素则是希望被在指定时间得到取出和处理</code>，所以延时队列中的元素是都是带时间属性的，通常来说是需要被处理的消息或者任务。</p><p>简单来说，延时队列就是用来存放需要在指定时间被处理的元素的队列。</p><h3 id=使用场景>使用场景
<a class=header-anchor href=#%e4%bd%bf%e7%94%a8%e5%9c%ba%e6%99%af></a></h3><ol><li>订单在十分钟之内未支付则自动取消。</li><li>新创建的店铺，如果在十天内都没有上传过商品，则自动发送消息提醒。</li><li>账单在一周内未支付，则自动结算。</li><li>用户注册成功后，如果三天内没有登陆则进行短信提醒。</li><li>用户发起退款，如果三天内没有得到处理则通知相关运营人员。</li><li>预定会议后，需要在预定的时间点前十分钟通知各个与会人员参加会议。</li></ol><h3 id=rabbitmq中的ttl>rabbitMQ中的TTL
<a class=header-anchor href=#rabbitmq%e4%b8%ad%e7%9a%84ttl></a></h3><p>在介绍延时队列之前，还需要先介绍一下RabbitMQ中的一个高级特性——<code>TTL（Time To Live）</code>。</p><p><code>TTL</code>是什么呢？<code>TTL</code>是RabbitMQ中一个消息或者队列的属性，表明<code>一条消息或者该队列中的所有消息的最大存活时间</code>，单位是毫秒。换句话说，如果一条消息设置了TTL属性或者进入了设置TTL属性的队列，那么这条消息如果在TTL设置的时间内没有被消费，则会成为“死信”。如果同时配置了队列的TTL和消息的TTL，那么较小的那个值将会被使用。</p><h3 id=如何利用rabbitmq实现延迟队列>如何利用rabbitMQ实现延迟队列
<a class=header-anchor href=#%e5%a6%82%e4%bd%95%e5%88%a9%e7%94%a8rabbitmq%e5%ae%9e%e7%8e%b0%e5%bb%b6%e8%bf%9f%e9%98%9f%e5%88%97></a></h3><p>想想看，<code>延时队列</code>，不就是想要消息延迟多久被处理吗，TTL则刚好能让消息在延迟多久之后成为死信，另一方面，成为死信的消息都会被投递到死信队列里，这样只需要消费者一直消费死信队列里的消息就万事大吉了，因为里面的消息都是希望被立即处理的消息。</p><p>从下图可以大致看出消息的流向：</p><p><img src=/imgs/img-lazy-loading.gif data-src=/images/47f80fb8-4a5d-4f84-bd2c-21fac99107a0.png alt></p><p>生产者生产一条延时消息，根据需要延时时间的不同，利用不同的routingkey将消息路由到不同的延时队列，每个队列都设置了不同的TTL属性，并绑定在同一个死信交换机中，消息过期后，根据routingkey的不同，又会被路由到不同的死信队列中，消费者只需要监听对应的死信队列进行处理即可。</p><p><strong>go实现</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;github.com/streadway/amqp&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;log&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;time&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> (
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>LOGIN</span>       <span style=color:#66d9ef>string</span> = <span style=color:#e6db74>&#34;zhaohaiyu&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>PASSWORD</span>    <span style=color:#66d9ef>string</span> = <span style=color:#e6db74>&#34;zhy.1996&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>HOST</span>        <span style=color:#66d9ef>string</span> = <span style=color:#e6db74>&#34;127.0.0.1&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>PORT</span>        <span style=color:#66d9ef>string</span> = <span style=color:#e6db74>&#34;5672&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>VIRTUALHOST</span> <span style=color:#66d9ef>string</span> = <span style=color:#e6db74>&#34;/&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>publish</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>url</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;amqp://%s:%s@%s:%s%s&#34;</span>, <span style=color:#a6e22e>LOGIN</span>, <span style=color:#a6e22e>PASSWORD</span>, <span style=color:#a6e22e>HOST</span>, <span style=color:#a6e22e>PORT</span>, <span style=color:#a6e22e>VIRTUALHOST</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>conn</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>amqp</span>.<span style=color:#a6e22e>Dial</span>(<span style=color:#a6e22e>url</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>failOnError</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;Failed to connect to RabbitMQ&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>conn</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ch</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>conn</span>.<span style=color:#a6e22e>Channel</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>failOnError</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;Failed to open a channel&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>ch</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>ch</span>.<span style=color:#a6e22e>ExchangeDeclare</span>(<span style=color:#e6db74>&#34;testTopic&#34;</span>, <span style=color:#a6e22e>amqp</span>.<span style=color:#a6e22e>ExchangeTopic</span>, <span style=color:#66d9ef>true</span>, <span style=color:#66d9ef>false</span>, <span style=color:#66d9ef>false</span>, <span style=color:#66d9ef>false</span>, <span style=color:#66d9ef>nil</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>failOnError</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;Failed to declare an exchange&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> &lt; <span style=color:#ae81ff>10</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>ch</span>.<span style=color:#a6e22e>Publish</span>(<span style=color:#e6db74>&#34;testTopic&#34;</span>, <span style=color:#e6db74>&#34;yuemoxi&#34;</span>, <span style=color:#66d9ef>false</span>, <span style=color:#66d9ef>false</span>, <span style=color:#a6e22e>amqp</span>.<span style=color:#a6e22e>Publishing</span>{
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>ContentType</span>: <span style=color:#e6db74>&#34;text/plain&#34;</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>Body</span>:        []byte(<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;time:%v&#34;</span>, <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>())),
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>Expiration</span>:  <span style=color:#e6db74>&#34;600000&#34;</span>,
</span></span><span style=display:flex><span>		})
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;发布成功!&#34;</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>get2</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>url</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;amqp://%s:%s@%s:%s%s&#34;</span>, <span style=color:#a6e22e>LOGIN</span>, <span style=color:#a6e22e>PASSWORD</span>, <span style=color:#a6e22e>HOST</span>, <span style=color:#a6e22e>PORT</span>, <span style=color:#a6e22e>VIRTUALHOST</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>conn</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>amqp</span>.<span style=color:#a6e22e>Dial</span>(<span style=color:#a6e22e>url</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>failOnError</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;Failed to connect to RabbitMQ&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>conn</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ch</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>conn</span>.<span style=color:#a6e22e>Channel</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>failOnError</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;Failed to open a channel&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>ch</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>ch</span>.<span style=color:#a6e22e>ExchangeDeclare</span>(<span style=color:#e6db74>&#34;testTopic&#34;</span>, <span style=color:#a6e22e>amqp</span>.<span style=color:#a6e22e>ExchangeTopic</span>, <span style=color:#66d9ef>true</span>, <span style=color:#66d9ef>false</span>, <span style=color:#66d9ef>false</span>, <span style=color:#66d9ef>false</span>, <span style=color:#66d9ef>nil</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>failOnError</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;Failed to declare an exchange&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>q</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ch</span>.<span style=color:#a6e22e>QueueDeclare</span>(<span style=color:#e6db74>&#34;testTopic_get2&#34;</span>, <span style=color:#66d9ef>false</span>, <span style=color:#66d9ef>false</span>, <span style=color:#66d9ef>false</span>, <span style=color:#66d9ef>false</span>, <span style=color:#66d9ef>nil</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>failOnError</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;Failed to declare a queue&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>//声明延时队列队列，该队列中消息如果过期，就将消息发送到交换器上，交换器就分发消息到普通队列
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>q1</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ch</span>.<span style=color:#a6e22e>QueueDeclare</span>(
</span></span><span style=display:flex><span>		<span style=color:#e6db74>&#34;test_delay&#34;</span>, <span style=color:#75715e>//队列名
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>true</span>,         <span style=color:#75715e>//持久化
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>false</span>,        <span style=color:#75715e>//不用时是否自动删除
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>amqp</span>.<span style=color:#a6e22e>Table</span>{
</span></span><span style=display:flex><span>			<span style=color:#75715e>//当消息过期时把消息发送到logs这个交换器
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#e6db74>&#34;x-dead-letter-exchange&#34;</span>:    <span style=color:#e6db74>&#34;ttlTopic&#34;</span>,
</span></span><span style=display:flex><span>			<span style=color:#e6db74>&#34;x-dead-letter-routing-key&#34;</span>: <span style=color:#e6db74>&#34;ttlKey&#34;</span>,
</span></span><span style=display:flex><span>		},
</span></span><span style=display:flex><span>	)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>failOnError</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;Failed to bind a queue&#34;</span>)
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>ch</span>.<span style=color:#a6e22e>QueueBind</span>(<span style=color:#a6e22e>q</span>.<span style=color:#a6e22e>Name</span>, <span style=color:#e6db74>&#34;#&#34;</span>, <span style=color:#e6db74>&#34;testTopic&#34;</span>, <span style=color:#66d9ef>false</span>, <span style=color:#66d9ef>nil</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>failOnError</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;Failed to bind a queue&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>ch</span>.<span style=color:#a6e22e>QueueBind</span>(
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>q1</span>.<span style=color:#a6e22e>Name</span>,
</span></span><span style=display:flex><span>		<span style=color:#e6db74>&#34;ttlKey&#34;</span>,
</span></span><span style=display:flex><span>		<span style=color:#e6db74>&#34;ttlTopic&#34;</span>,
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>nil</span>,
</span></span><span style=display:flex><span>	)
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>msgs</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ch</span>.<span style=color:#a6e22e>Consume</span>(<span style=color:#a6e22e>q</span>.<span style=color:#a6e22e>Name</span>, <span style=color:#e6db74>&#34;get2&#34;</span>, <span style=color:#66d9ef>true</span>, <span style=color:#66d9ef>false</span>, <span style=color:#66d9ef>false</span>, <span style=color:#66d9ef>false</span>, <span style=color:#66d9ef>nil</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>failOnError</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;Failed to register a consumer&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>msg</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>msgs</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;get2: %s&#34;</span>, <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>Body</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Millisecond</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>500</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>failOnError</span>(<span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>, <span style=color:#a6e22e>msg</span> <span style=color:#66d9ef>string</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatalf</span>(<span style=color:#e6db74>&#34;%s: %s&#34;</span>, <span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>go</span> <span style=color:#a6e22e>publish</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>go</span> <span style=color:#a6e22e>get2</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>20</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=参考文章>参考文章
<a class=header-anchor href=#%e5%8f%82%e8%80%83%e6%96%87%e7%ab%a0></a></h2><ul><li><a href=https://juejin.cn/post/6916148736414466061 title=https://juejin.cn/post/6916148736414466061 rel="noopener external nofollow noreferrer" target=_blank class=exturl>https://juejin.cn/post/6916148736414466061
<i class="fa fa-external-link-alt"></i></a></li><li><a href=https://www.rabbitmq.com/getstarted.html title=rabbitmq官网 rel="noopener external nofollow noreferrer" target=_blank class=exturl>rabbitmq官网
<i class="fa fa-external-link-alt"></i></a></li><li><a href=https://www.cnblogs.com/mfrank/p/11260355.html title=https://www.cnblogs.com/mfrank/p/11260355.html rel="noopener external nofollow noreferrer" target=_blank class=exturl>https://www.cnblogs.com/mfrank/p/11260355.html
<i class="fa fa-external-link-alt"></i></a></li></ul></div><footer class=post-footer><div class=post-tags><a href=/tags/rabbitmq>RabbitMQ</a></div><div class=addthis_inline_share_toolbox style=text-align:center></div><hr><div class=post-copyright><img src=/imgs/cc/cc.svg width=75 height=75 align=right alt=共享知识><ul><li class=post-copyright-title><strong>文章标题：</strong>
RabbitMQ消息队列</li><li class=post-copyright-author><strong>本文作者： </strong>daemon365</li><li class=post-copyright-link><strong>本文链接：</strong>
<a id=post-cr-link href=https://daemon365.dev/post/database/rabbitmq_message_queue/ title=RabbitMQ消息队列>https://daemon365.dev/post/database/rabbitmq_message_queue/</a></li><li class=post-copyright-license><strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <i class="fab fa-fw fa-creative-commons"></i><a target=_blank href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div class=post-nav><div class="post-nav-next post-nav-item"><a href=/post/cloud/container_basics___namespace__cgroup_and_unionfs/ rel=next title="容器基础-- namespace,Cgroup 和 UnionFS"><i class="fa fa-chevron-left"></i> 容器基础-- namespace,Cgroup 和 UnionFS</a></div><div class="post-nav-prev post-nav-item"><a href=/post/network/http_and_https/ rel=prev title=http和https>http和https
<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div id=comments class=post-comments><div class=comment-head><div class=comment-headline><i class="fas fa-comments fa-fw"></i>
<span>评论交流</span></div></div><div class=comment-wrap><div><div class=comment-loading><i class="fa fa-sync fa-spin"></i></div><div class=utterances-container></div></div></div></div></div></main><footer class=footer><div class=footer-inner><div class=copyright>&copy;
<span itemprop=copyrightYear>2019 - 2024
</span><span class=with-love><i class="fa fa-heart"></i>
</span><span class=author itemprop=copyrightHolder>daemon365</span></div><div class=powered-by>由 <a href=https://gohugo.io title=0.139.3 target=_blank>Hugo</a> & <a href=https://github.com/hugo-next/hugo-theme-next title=4.6.3 target=_blank>Hugo NexT.Gemini</a> 强力驱动</div></div></footer><script type=text/javascript src=https://daemon365.dev/3rd/animejs/3.2.2/anime.min.js crossorigin=anonymous defer></script><script type=text/javascript src=https://daemon365.dev/3rd/viewerjs/1.11.6/viewer.min.js crossorigin=anonymous defer></script><script class=next-config data-name=main type=application/json>{"bookmark":{"color":"#222","enable":false,"save":"manual"},"copybtn":true,"darkmode":false,"hostname":"https://daemon365.dev/","i18n":{"ds_day":" 天前","ds_days":" 天 ","ds_hour":" 小时前","ds_hours":" 小时 ","ds_just":"刚刚","ds_min":" 分钟前","ds_mins":" 分钟","ds_month":" 个月前","ds_years":" 年 ","empty":"没有找到任何搜索结果：${query}","hits":"找到 ${hits} 个搜索结果","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","placeholder":"搜索..."},"lang":"zh-CN","lawidget":{"id":"JmAHxEAUVgyS8B1c","js":"https://v6-widget.51.la/v6/laId/quote.js?theme=0\u0026col=true\u0026f=12\u0026display=0,0,0,1,0,1,1,1"},"lazyload":false,"localSearch":{"enable":true,"limit":1e3,"path":"/searchindexes.xml","preload":false,"topnperarticle":-1,"trigger":"auto","unescape":false},"motion":{"async":false,"enable":false,"transition":{"collheader":"fadeInLeft","postblock":"fadeIn","postbody":"fadeInDown","postheader":"fadeInDown","sidebar":"fadeInUp"}},"postmeta":{"comments":{"enable":false,"plugin":"waline"},"views":{"enable":true,"plugin":"busuanzi"}},"root":"/","scheme":"Gemini","sidebar":{"display":"post","offset":12,"padding":18,"position":"left","width":256},"utterances":{"cfg":{"issueterm":"pathname","label":"comments","repo":"daemon365/blog","theme":"preferred-color-scheme"},"js":"https://utteranc.es/client.js"},"vendor":{"plugins":"local","router":{"name":"local","type":"modern","url":"https://daemon365.dev/3rd"}},"version":"4.6.3"}</script><script type=text/javascript src=/js/main.min.412b2d7d9cead6dbf9b4df1d9dcc9b5b7818e8e434f664050b4498e888bb3009.js defer></script></body></html>