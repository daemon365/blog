<!doctype html><html lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Go 垃圾回收原理 - Daemon365</title><link rel=icon href=/imgs/favicon.ico><link rel=manifest href=/manifest.json><meta name=theme-color content="#007aff"><meta name=mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="default"><meta name=apple-mobile-web-app-title content="Daemon365"><meta name=description content="*** Go 代码基于 v1.23.0 ***
介绍

golang GC 垃圾回收机制

触发条件

用户调用 runtime.GC 主动触发
Go 程序检测到距上次 GC 内存分配增长超过一定比例时（默认 100%）触发
定时触发 （默认 2 min）

定时触发
代码在 …"><meta name=keywords content="go"><meta name=author content="daemon365"><meta property="og:type" content="article"><meta property="og:url" content="https://daemon365.dev/post/go/go_gc_code/"><meta property="og:title" content="Go 垃圾回收原理 - Daemon365"><meta property="og:description" content="*** Go 代码基于 v1.23.0 ***
介绍

golang GC 垃圾回收机制

触发条件

用户调用 runtime.GC 主动触发
Go 程序检测到距上次 GC 内存分配增长超过一定比例时（默认 100%）触发
定时触发 （默认 2 min）

定时触发
代码在 …"><meta property="og:image" content="https://daemon365.dev/imgs/avatar.svg"><meta property="og:locale" content="en"><meta property="og:site_name" content="Daemon365"><meta property="article:published_time" content="2024-12-17T11:06:10+08:00"><meta property="article:modified_time" content="2024-12-17T11:06:10+08:00"><meta property="article:author" content="daemon365"><meta property="article:section" content="go"><meta property="article:tag" content="go"><meta name=twitter:card content="summary_large_image"><meta name=twitter:url content="https://daemon365.dev/post/go/go_gc_code/"><meta name=twitter:title content="Go 垃圾回收原理 - Daemon365"><meta name=twitter:description content="*** Go 代码基于 v1.23.0 ***
介绍

golang GC 垃圾回收机制

触发条件

用户调用 runtime.GC 主动触发
Go 程序检测到距上次 GC 内存分配增长超过一定比例时（默认 100%）触发
定时触发 （默认 2 min）

定时触发
代码在 …"><meta name=twitter:image content="https://daemon365.dev/imgs/avatar.svg"><link rel=canonical href=https://daemon365.dev/post/go/go_gc_code/><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Go 垃圾回收原理","description":"\u003cp\u003e*** Go 代码基于 v1.23.0 ***\u003c\/p\u003e\n\u003ch2 id=\u0022介绍\u0022\u003e介绍\u003c\/h2\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\u0022https:\/\/daemon365.dev\/post\/go\/golang_gc_garbage_collection_mechanism\/\u0022\u003egolang GC 垃圾回收机制\u003c\/a\u003e\u003c\/li\u003e\n\u003c\/ul\u003e\n\u003ch2 id=\u0022触发条件\u0022\u003e触发条件\u003c\/h2\u003e\n\u003col\u003e\n\u003cli\u003e用户调用 \u003ccode\u003eruntime.GC\u003c\/code\u003e 主动触发\u003c\/li\u003e\n\u003cli\u003eGo 程序检测到距上次 GC 内存分配增长超过一定比例时（默认 100%）触发\u003c\/li\u003e\n\u003cli\u003e定时触发 （默认 2 min）\u003c\/li\u003e\n\u003c\/ol\u003e\n\u003ch2 id=\u0022定时触发\u0022\u003e定时触发\u003c\/h2\u003e\n\u003cp\u003e代码在 …\u003c\/p\u003e","datePublished":"2024-12-17T11:06:10\u002b08:00","dateModified":"2024-12-17T11:06:10\u002b08:00","author":{"@type":"Person","name":"daemon365"},"publisher":{"@type":"Organization","name":"Daemon365","logo":{"@type":"ImageObject","url":"https:\/\/daemon365.dev\/imgs\/favicon.ico"}},"mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/daemon365.dev\/post\/go\/go_gc_code\/"},"inLanguage":"en"}</script><meta name=robots content="index, follow"><meta name=googlebot content="index, follow"><link rel=stylesheet href=/css/components/variables.css><link rel=stylesheet href=/css/components/base.css><link rel=stylesheet href=/css/components/layout.css><link rel=stylesheet href=/css/main.css><link rel=stylesheet href=/css/components/search.css><link rel=stylesheet href=/css/components/toc.css><link rel=stylesheet href=/css/components/image-preview.css><link rel=stylesheet href=/css/components/reading-progress.css><style>:root{font-family:-apple-system,BlinkMacSystemFont,segoe ui,Roboto,helvetica neue,Arial,sans-serif}</style></head><body><div class=reading-progress-bar></div><header class=site-header><div class=container><div class=header-content><div class=site-branding><a href=/ class=site-logo><span class=site-title>Daemon365</span></a></div><nav class=site-nav><ul class=nav-menu><li><a href=/><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
首页</a></li><li><a href=/about><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
关于</a></li><li><a href=/archives><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
归档</a></li><li><a href=/categories><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg>
分类</a></li><li><a href=/tags><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>
标签</a></li><li><button class=search-trigger aria-label=Search>
<svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
搜索</button></li></ul></nav></div></div></header><main class=main-content><div class=post-container><div class=container><article class=post-content><header class=post-header><h1 class=post-title>Go 垃圾回收原理</h1><div class=post-meta><time datetime=2024-12-17><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
2024-12-17
</time><a href=/categories/go class=category-link><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg>
go
</a><span class=reading-time><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
13 min read
</span><span class=word-count><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
2751 words</span></div><div class=post-tags><a href=/tags/go class=tag><svg class="icon" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>
go</a></div></header><div class=post-body><p>*** Go 代码基于 v1.23.0 ***</p><h2 id=介绍>介绍</h2><ul><li><a href=https://daemon365.dev/post/go/golang_gc_garbage_collection_mechanism/>golang GC 垃圾回收机制</a></li></ul><h2 id=触发条件>触发条件</h2><ol><li>用户调用 <code>runtime.GC</code> 主动触发</li><li>Go 程序检测到距上次 GC 内存分配增长超过一定比例时（默认 100%）触发</li><li>定时触发 （默认 2 min）</li></ol><h2 id=定时触发>定时触发</h2><p>代码在 <code>src/runtime/proc.go</code> 中</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>init</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>go</span> <span style=color:#75af00>forcegchelper</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>forcegchelper</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>forcegc</span><span style=color:#111>.</span><span style=color:#75af00>g</span> <span style=color:#111>=</span> <span style=color:#75af00>getg</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>lockInit</span><span style=color:#111>(</span><span style=color:#f92672>&amp;</span><span style=color:#75af00>forcegc</span><span style=color:#111>.</span><span style=color:#75af00>lock</span><span style=color:#111>,</span> <span style=color:#75af00>lockRankForcegc</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>for</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>lock</span><span style=color:#111>(</span><span style=color:#f92672>&amp;</span><span style=color:#75af00>forcegc</span><span style=color:#111>.</span><span style=color:#75af00>lock</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>forcegc</span><span style=color:#111>.</span><span style=color:#75af00>idle</span><span style=color:#111>.</span><span style=color:#75af00>Load</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>throw</span><span style=color:#111>(</span><span style=color:#d88200>&#34;forcegc: phase error&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>forcegc</span><span style=color:#111>.</span><span style=color:#75af00>idle</span><span style=color:#111>.</span><span style=color:#75af00>Store</span><span style=color:#111>(</span><span style=color:#00a8c8>true</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 阻塞住 goroutine 当有人解开时 开启 gc</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>goparkunlock</span><span style=color:#111>(</span><span style=color:#f92672>&amp;</span><span style=color:#75af00>forcegc</span><span style=color:#111>.</span><span style=color:#75af00>lock</span><span style=color:#111>,</span> <span style=color:#75af00>waitReasonForceGCIdle</span><span style=color:#111>,</span> <span style=color:#75af00>traceBlockSystemGoroutine</span><span style=color:#111>,</span> <span style=color:#ae81ff>1</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// this goroutine is explicitly resumed by sysmon</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>debug</span><span style=color:#111>.</span><span style=color:#75af00>gctrace</span> <span style=color:#111>&gt;</span> <span style=color:#ae81ff>0</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#111>println</span><span style=color:#111>(</span><span style=color:#d88200>&#34;GC forced&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// goroutine 被唤醒了，调用 gcStart 开启 gc</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>gcStart</span><span style=color:#111>(</span><span style=color:#75af00>gcTrigger</span><span style=color:#111>{</span><span style=color:#75af00>kind</span><span style=color:#111>:</span> <span style=color:#75af00>gcTriggerTime</span><span style=color:#111>,</span> <span style=color:#75af00>now</span><span style=color:#111>:</span> <span style=color:#75af00>nanotime</span><span style=color:#111>()})</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><p>那么唤醒 goroutine 的逻辑代码在哪里呢？在 <code>sysmon</code> 物理线程中</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>sysmon</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ......</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>for</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// ......</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 使用 test 方法判断是否需要触发 gc</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>if</span> <span style=color:#75af00>t</span> <span style=color:#f92672>:=</span> <span style=color:#111>(</span><span style=color:#75af00>gcTrigger</span><span style=color:#111>{</span><span style=color:#75af00>kind</span><span style=color:#111>:</span> <span style=color:#75af00>gcTriggerTime</span><span style=color:#111>,</span> <span style=color:#75af00>now</span><span style=color:#111>:</span> <span style=color:#75af00>now</span><span style=color:#111>});</span> <span style=color:#75af00>t</span><span style=color:#111>.</span><span style=color:#75af00>test</span><span style=color:#111>()</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#75af00>forcegc</span><span style=color:#111>.</span><span style=color:#75af00>idle</span><span style=color:#111>.</span><span style=color:#75af00>Load</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>lock</span><span style=color:#111>(</span><span style=color:#f92672>&amp;</span><span style=color:#75af00>forcegc</span><span style=color:#111>.</span><span style=color:#75af00>lock</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>forcegc</span><span style=color:#111>.</span><span style=color:#75af00>idle</span><span style=color:#111>.</span><span style=color:#75af00>Store</span><span style=color:#111>(</span><span style=color:#00a8c8>false</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 需要 gc 时，把 g 放入 list 中 并使用 injectglist 执行唤醒操作</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>var</span> <span style=color:#75af00>list</span> <span style=color:#75af00>gList</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>list</span><span style=color:#111>.</span><span style=color:#75af00>push</span><span style=color:#111>(</span><span style=color:#75af00>forcegc</span><span style=color:#111>.</span><span style=color:#75af00>g</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>injectglist</span><span style=color:#111>(</span><span style=color:#f92672>&amp;</span><span style=color:#75af00>list</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>unlock</span><span style=color:#111>(</span><span style=color:#f92672>&amp;</span><span style=color:#75af00>forcegc</span><span style=color:#111>.</span><span style=color:#75af00>lock</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// ......</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>injectglist</span><span style=color:#111>(</span><span style=color:#75af00>glist</span> <span style=color:#f92672>*</span><span style=color:#75af00>gList</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ......</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 启动指定数量的空闲M</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>startIdle</span> <span style=color:#f92672>:=</span> <span style=color:#00a8c8>func</span><span style=color:#111>(</span><span style=color:#75af00>n</span> <span style=color:#00a8c8>int</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>for</span> <span style=color:#75af00>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span><span style=color:#111>;</span> <span style=color:#75af00>i</span> <span style=color:#111>&lt;</span> <span style=color:#75af00>n</span><span style=color:#111>;</span> <span style=color:#75af00>i</span><span style=color:#f92672>++</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>mp</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>acquirem</span><span style=color:#111>()</span> <span style=color:#75715e>// See comment in startm.</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>lock</span><span style=color:#111>(</span><span style=color:#f92672>&amp;</span><span style=color:#75af00>sched</span><span style=color:#111>.</span><span style=color:#75af00>lock</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>pp</span><span style=color:#111>,</span> <span style=color:#75af00>_</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>pidlegetSpinning</span><span style=color:#111>(</span><span style=color:#ae81ff>0</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>if</span> <span style=color:#75af00>pp</span> <span style=color:#f92672>==</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>				<span style=color:#75af00>unlock</span><span style=color:#111>(</span><span style=color:#f92672>&amp;</span><span style=color:#75af00>sched</span><span style=color:#111>.</span><span style=color:#75af00>lock</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>				<span style=color:#75af00>releasem</span><span style=color:#111>(</span><span style=color:#75af00>mp</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>				<span style=color:#00a8c8>break</span>
</span></span><span style=display:flex><span>			<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>startm</span><span style=color:#111>(</span><span style=color:#75af00>pp</span><span style=color:#111>,</span> <span style=color:#00a8c8>false</span><span style=color:#111>,</span> <span style=color:#00a8c8>true</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>unlock</span><span style=color:#111>(</span><span style=color:#f92672>&amp;</span><span style=color:#75af00>sched</span><span style=color:#111>.</span><span style=color:#75af00>lock</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>releasem</span><span style=color:#111>(</span><span style=color:#75af00>mp</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>pp</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>getg</span><span style=color:#111>().</span><span style=color:#75af00>m</span><span style=color:#111>.</span><span style=color:#75af00>p</span><span style=color:#111>.</span><span style=color:#75af00>ptr</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>pp</span> <span style=color:#f92672>==</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 没有 P 的情况下，直接把 glist 放入全局队列 并启动一些空闲M</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>lock</span><span style=color:#111>(</span><span style=color:#f92672>&amp;</span><span style=color:#75af00>sched</span><span style=color:#111>.</span><span style=color:#75af00>lock</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>globrunqputbatch</span><span style=color:#111>(</span><span style=color:#f92672>&amp;</span><span style=color:#75af00>q</span><span style=color:#111>,</span> <span style=color:#111>int32</span><span style=color:#111>(</span><span style=color:#75af00>qsize</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>unlock</span><span style=color:#111>(</span><span style=color:#f92672>&amp;</span><span style=color:#75af00>sched</span><span style=color:#111>.</span><span style=color:#75af00>lock</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>startIdle</span><span style=color:#111>(</span><span style=color:#75af00>qsize</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>return</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 逐个将G放入全局队列，并启动相应的M</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>npidle</span> <span style=color:#f92672>:=</span> <span style=color:#111>int</span><span style=color:#111>(</span><span style=color:#75af00>sched</span><span style=color:#111>.</span><span style=color:#75af00>npidle</span><span style=color:#111>.</span><span style=color:#75af00>Load</span><span style=color:#111>())</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>var</span> <span style=color:#111>(</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>globq</span> <span style=color:#75af00>gQueue</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>n</span>     <span style=color:#00a8c8>int</span>
</span></span><span style=display:flex><span>	<span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>for</span> <span style=color:#75af00>n</span> <span style=color:#111>=</span> <span style=color:#ae81ff>0</span><span style=color:#111>;</span> <span style=color:#75af00>n</span> <span style=color:#111>&lt;</span> <span style=color:#75af00>npidle</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#111>!</span><span style=color:#75af00>q</span><span style=color:#111>.</span><span style=color:#75af00>empty</span><span style=color:#111>();</span> <span style=color:#75af00>n</span><span style=color:#f92672>++</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>g</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>q</span><span style=color:#111>.</span><span style=color:#75af00>pop</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>globq</span><span style=color:#111>.</span><span style=color:#75af00>pushBack</span><span style=color:#111>(</span><span style=color:#75af00>g</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>n</span> <span style=color:#111>&gt;</span> <span style=color:#ae81ff>0</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>lock</span><span style=color:#111>(</span><span style=color:#f92672>&amp;</span><span style=color:#75af00>sched</span><span style=color:#111>.</span><span style=color:#75af00>lock</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>globrunqputbatch</span><span style=color:#111>(</span><span style=color:#f92672>&amp;</span><span style=color:#75af00>globq</span><span style=color:#111>,</span> <span style=color:#111>int32</span><span style=color:#111>(</span><span style=color:#75af00>n</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>unlock</span><span style=color:#111>(</span><span style=color:#f92672>&amp;</span><span style=color:#75af00>sched</span><span style=color:#111>.</span><span style=color:#75af00>lock</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>startIdle</span><span style=color:#111>(</span><span style=color:#75af00>n</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>qsize</span> <span style=color:#f92672>-=</span> <span style=color:#75af00>n</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 将剩余的G放入当前P的本地队列。</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#111>!</span><span style=color:#75af00>q</span><span style=color:#111>.</span><span style=color:#75af00>empty</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>runqputbatch</span><span style=color:#111>(</span><span style=color:#75af00>pp</span><span style=color:#111>,</span> <span style=color:#f92672>&amp;</span><span style=color:#75af00>q</span><span style=color:#111>,</span> <span style=color:#75af00>qsize</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 唤醒一个P，以防在添加G到队列后有P变为空闲状态。</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>wakep</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><h3 id=test>test</h3><ul><li>根据 gcTrigger 的类型检测是否应该触发垃圾收集。</li></ul><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>type</span> <span style=color:#75af00>gcTrigger</span> <span style=color:#00a8c8>struct</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>kind</span> <span style=color:#75af00>gcTriggerKind</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>now</span>  <span style=color:#00a8c8>int64</span>  <span style=color:#75715e>// gcTriggerTime: current time</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>n</span>    <span style=color:#00a8c8>uint32</span> <span style=color:#75715e>// gcTriggerCycle: cycle number to start</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>type</span> <span style=color:#75af00>gcTriggerKind</span> <span style=color:#00a8c8>int</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>const</span> <span style=color:#111>(</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>gcTriggerHeap</span> <span style=color:#75af00>gcTriggerKind</span> <span style=color:#111>=</span> <span style=color:#00a8c8>iota</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>gcTriggerTime</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>gcTriggerCycle</span>
</span></span><span style=display:flex><span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>t</span> <span style=color:#75af00>gcTrigger</span><span style=color:#111>)</span> <span style=color:#75af00>test</span><span style=color:#111>()</span> <span style=color:#00a8c8>bool</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 检查是否禁用了 GC，程序是否处于 panic 状态，或 GC 阶段是否不是关闭状态。 </span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#111>!</span><span style=color:#75af00>memstats</span><span style=color:#111>.</span><span style=color:#75af00>enablegc</span> <span style=color:#f92672>||</span> <span style=color:#75af00>panicking</span><span style=color:#111>.</span><span style=color:#75af00>Load</span><span style=color:#111>()</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>||</span> <span style=color:#75af00>gcphase</span> <span style=color:#f92672>!=</span> <span style=color:#75af00>_GCoff</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>return</span> <span style=color:#00a8c8>false</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>switch</span> <span style=color:#75af00>t</span><span style=color:#111>.</span><span style=color:#75af00>kind</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>case</span> <span style=color:#75af00>gcTriggerHeap</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// heap 内存的方式触发</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>trigger</span><span style=color:#111>,</span> <span style=color:#75af00>_</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>gcController</span><span style=color:#111>.</span><span style=color:#75af00>trigger</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>return</span> <span style=color:#75af00>gcController</span><span style=color:#111>.</span><span style=color:#75af00>heapLive</span><span style=color:#111>.</span><span style=color:#75af00>Load</span><span style=color:#111>()</span> <span style=color:#f92672>&gt;=</span> <span style=color:#75af00>trigger</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>case</span> <span style=color:#75af00>gcTriggerTime</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 定时触发</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>gcController</span><span style=color:#111>.</span><span style=color:#75af00>gcPercent</span><span style=color:#111>.</span><span style=color:#75af00>Load</span><span style=color:#111>()</span> <span style=color:#111>&lt;</span> <span style=color:#ae81ff>0</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>return</span> <span style=color:#00a8c8>false</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 如果现在的时间减去上次 gc 的时间大于 forcegcperiod （2min） 就触发</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>lastgc</span> <span style=color:#f92672>:=</span> <span style=color:#111>int64</span><span style=color:#111>(</span><span style=color:#75af00>atomic</span><span style=color:#111>.</span><span style=color:#75af00>Load64</span><span style=color:#111>(</span><span style=color:#f92672>&amp;</span><span style=color:#75af00>memstats</span><span style=color:#111>.</span><span style=color:#75af00>last_gc_nanotime</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>return</span> <span style=color:#75af00>lastgc</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#75af00>t</span><span style=color:#111>.</span><span style=color:#75af00>now</span><span style=color:#f92672>-</span><span style=color:#75af00>lastgc</span> <span style=color:#111>&gt;</span> <span style=color:#75af00>forcegcperiod</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>case</span> <span style=color:#75af00>gcTriggerCycle</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 上次是否执行完毕</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>return</span> <span style=color:#111>int32</span><span style=color:#111>(</span><span style=color:#75af00>t</span><span style=color:#111>.</span><span style=color:#75af00>n</span><span style=color:#f92672>-</span><span style=color:#75af00>work</span><span style=color:#111>.</span><span style=color:#75af00>cycles</span><span style=color:#111>.</span><span style=color:#75af00>Load</span><span style=color:#111>())</span> <span style=color:#111>&gt;</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>return</span> <span style=color:#00a8c8>true</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><h2 id=heap-增长触发>Heap 增长触发</h2><p><code>mallocgc</code> 不但 malloc 了内存，还会检查是否需要触发 gc</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>mallocgc</span><span style=color:#111>(</span><span style=color:#75af00>size</span> <span style=color:#00a8c8>uintptr</span><span style=color:#111>,</span> <span style=color:#75af00>typ</span> <span style=color:#f92672>*</span><span style=color:#75af00>_type</span><span style=color:#111>,</span> <span style=color:#75af00>needzero</span> <span style=color:#00a8c8>bool</span><span style=color:#111>)</span> <span style=color:#75af00>unsafe</span><span style=color:#111>.</span><span style=color:#75af00>Pointer</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>assistG</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>deductAssistCredit</span><span style=color:#111>(</span><span style=color:#75af00>size</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>shouldhelpgc</span> <span style=color:#f92672>:=</span> <span style=color:#00a8c8>false</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ......</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#75af00>size</span> <span style=color:#f92672>&lt;=</span> <span style=color:#75af00>maxSmallSize</span><span style=color:#f92672>-</span><span style=color:#75af00>mallocHeaderSize</span>  <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// ......</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 如果 mcache 中满了 要向上申请了 shouldhelpgc = true 后续判断</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>v</span><span style=color:#111>,</span> <span style=color:#75af00>span</span><span style=color:#111>,</span> <span style=color:#75af00>shouldhelpgc</span> <span style=color:#111>=</span> <span style=color:#75af00>c</span><span style=color:#111>.</span><span style=color:#75af00>nextFree</span><span style=color:#111>(</span><span style=color:#75af00>tinySpanClass</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// ......</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span> <span style=color:#00a8c8>else</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 大于 32k </span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>shouldhelpgc</span> <span style=color:#111>=</span> <span style=color:#00a8c8>true</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// ......</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 如果开启了 GC 新对象都标黑</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#75af00>gcphase</span> <span style=color:#f92672>!=</span> <span style=color:#75af00>_GCoff</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>gcmarknewobject</span><span style=color:#111>(</span><span style=color:#75af00>span</span><span style=color:#111>,</span> <span style=color:#111>uintptr</span><span style=color:#111>(</span><span style=color:#75af00>x</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// test() 看下需不需要 gc</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#75af00>shouldhelpgc</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>t</span> <span style=color:#f92672>:=</span> <span style=color:#111>(</span><span style=color:#75af00>gcTrigger</span><span style=color:#111>{</span><span style=color:#75af00>kind</span><span style=color:#111>:</span> <span style=color:#75af00>gcTriggerHeap</span><span style=color:#111>});</span> <span style=color:#75af00>t</span><span style=color:#111>.</span><span style=color:#75af00>test</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>gcStart</span><span style=color:#111>(</span><span style=color:#75af00>t</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>gcmarknewobject</span><span style=color:#111>(</span><span style=color:#75af00>span</span> <span style=color:#f92672>*</span><span style=color:#75af00>mspan</span><span style=color:#111>,</span> <span style=color:#75af00>obj</span> <span style=color:#00a8c8>uintptr</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>span</span><span style=color:#111>.</span><span style=color:#75af00>markBitsForIndex</span><span style=color:#111>(</span><span style=color:#75af00>objIndex</span><span style=color:#111>).</span><span style=color:#75af00>setMarked</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><h2 id=主动触发>主动触发</h2><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>GC</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ......</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>gcStart</span><span style=color:#111>(</span><span style=color:#75af00>gcTrigger</span><span style=color:#111>{</span><span style=color:#75af00>kind</span><span style=color:#111>:</span> <span style=color:#75af00>gcTriggerCycle</span><span style=color:#111>,</span> <span style=color:#75af00>n</span><span style=color:#111>:</span> <span style=color:#75af00>n</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span><span style=color:#111>})</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ......</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><h2 id=gcstart>gcStart</h2><p>gcStart 为 gc 的标记主流程</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>gcStart</span><span style=color:#111>(</span><span style=color:#75af00>trigger</span> <span style=color:#75af00>gcTrigger</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ......</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 再次检查一下是不是能 GC 如果上次没清扫完，给清扫完</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>for</span> <span style=color:#75af00>trigger</span><span style=color:#111>.</span><span style=color:#75af00>test</span><span style=color:#111>()</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#75af00>sweepone</span><span style=color:#111>()</span> <span style=color:#f92672>!=</span> <span style=color:#111>^</span><span style=color:#111>uintptr</span><span style=color:#111>(</span><span style=color:#ae81ff>0</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 上锁</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>semacquire</span><span style=color:#111>(</span><span style=color:#f92672>&amp;</span><span style=color:#75af00>work</span><span style=color:#111>.</span><span style=color:#75af00>startSema</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 加锁了 再次检查一下</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#111>!</span><span style=color:#75af00>trigger</span><span style=color:#111>.</span><span style=color:#75af00>test</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>semrelease</span><span style=color:#111>(</span><span style=color:#f92672>&amp;</span><span style=color:#75af00>work</span><span style=color:#111>.</span><span style=color:#75af00>startSema</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>return</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ......</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 启动 GC 标记工作线程。</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>gcBgMarkStartWorkers</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 重置标记</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>systemstack</span><span style=color:#111>(</span><span style=color:#75af00>gcResetMarkState</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ......</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Stop The World</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>systemstack</span><span style=color:#111>(</span><span style=color:#00a8c8>func</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>stw</span> <span style=color:#111>=</span> <span style=color:#75af00>stopTheWorldWithSema</span><span style=color:#111>(</span><span style=color:#75af00>stwGCSweepTerm</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>})</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 在开始并发扫描之前完成清扫 </span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>systemstack</span><span style=color:#111>(</span><span style=color:#00a8c8>func</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>finishsweep_m</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#111>})</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ......</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 使用多少个核心 GC</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>gcController</span><span style=color:#111>.</span><span style=color:#75af00>startCycle</span><span style=color:#111>(</span><span style=color:#75af00>now</span><span style=color:#111>,</span> <span style=color:#111>int</span><span style=color:#111>(</span><span style=color:#75af00>gomaxprocs</span><span style=color:#111>),</span> <span style=color:#75af00>trigger</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ......</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 进入并发标记阶段并启用写屏障。</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>setGCPhase</span><span style=color:#111>(</span><span style=color:#75af00>_GCmark</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 标记所有活跃的 tinyalloc 块。</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>gcMarkTinyAllocs</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 开始标记</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>systemstack</span><span style=color:#111>(</span><span style=color:#00a8c8>func</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// start the world </span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>now</span> <span style=color:#111>=</span> <span style=color:#75af00>startTheWorldWithSema</span><span style=color:#111>(</span><span style=color:#ae81ff>0</span><span style=color:#111>,</span> <span style=color:#75af00>stw</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>work</span><span style=color:#111>.</span><span style=color:#75af00>pauseNS</span> <span style=color:#f92672>+=</span> <span style=color:#75af00>now</span> <span style=color:#f92672>-</span> <span style=color:#75af00>stw</span><span style=color:#111>.</span><span style=color:#75af00>startedStopping</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>work</span><span style=color:#111>.</span><span style=color:#75af00>tMark</span> <span style=color:#111>=</span> <span style=color:#75af00>now</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 释放 CPU 限制器</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>gcCPULimiter</span><span style=color:#111>.</span><span style=color:#75af00>finishGCTransition</span><span style=color:#111>(</span><span style=color:#75af00>now</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>})</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 在 STW 模式下，在 Gosched() 之前释放 world sema，</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 因为我们稍后需要再次获取它，但在这个 goroutine 变为可运行之前，我们可能会自我死锁。</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>semrelease</span><span style=color:#111>(</span><span style=color:#f92672>&amp;</span><span style=color:#75af00>worldsema</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>releasem</span><span style=color:#111>(</span><span style=color:#75af00>mp</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	 <span style=color:#75715e>// 确保在 STW 模式下阻塞，而不是返回到用户代码。</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>mode</span> <span style=color:#f92672>!=</span> <span style=color:#75af00>gcBackgroundMode</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>Gosched</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 释放开始信号量</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>semrelease</span><span style=color:#111>(</span><span style=color:#f92672>&amp;</span><span style=color:#75af00>work</span><span style=color:#111>.</span><span style=color:#75af00>startSema</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><h3 id=gcbgmarkstartworkers>gcBgMarkStartWorkers</h3><p>gcBgMarkStartWorkers 启动 P 个数个 goroutine 去做并发标记</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>gcBgMarkStartWorkers</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ......</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>for</span> <span style=color:#75af00>gcBgMarkWorkerCount</span> <span style=color:#111>&lt;</span> <span style=color:#75af00>gomaxprocs</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>go</span> <span style=color:#75af00>gcBgMarkWorker</span><span style=color:#111>(</span><span style=color:#75af00>ready</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>releasem</span><span style=color:#111>(</span><span style=color:#75af00>mp</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#f92672>&lt;-</span><span style=color:#75af00>ready</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#75af00>incnwait</span> <span style=color:#f92672>==</span> <span style=color:#75af00>work</span><span style=color:#111>.</span><span style=color:#75af00>nproc</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#111>!</span><span style=color:#75af00>gcMarkWorkAvailable</span><span style=color:#111>(</span><span style=color:#00a8c8>nil</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>releasem</span><span style=color:#111>(</span><span style=color:#75af00>node</span><span style=color:#111>.</span><span style=color:#75af00>m</span><span style=color:#111>.</span><span style=color:#75af00>ptr</span><span style=color:#111>())</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>node</span><span style=color:#111>.</span><span style=color:#75af00>m</span><span style=color:#111>.</span><span style=color:#75af00>set</span><span style=color:#111>(</span><span style=color:#00a8c8>nil</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>gcMarkDone</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>gcBgMarkWorker</span><span style=color:#111>(</span><span style=color:#75af00>ready</span> <span style=color:#00a8c8>chan</span> <span style=color:#00a8c8>struct</span><span style=color:#111>{})</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>gp</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>getg</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 把 node 组装成 node</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>node</span> <span style=color:#f92672>:=</span> <span style=color:#111>new</span><span style=color:#111>(</span><span style=color:#75af00>gcBgMarkWorkerNode</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>node</span><span style=color:#111>.</span><span style=color:#75af00>gp</span><span style=color:#111>.</span><span style=color:#75af00>set</span><span style=color:#111>(</span><span style=color:#75af00>gp</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>node</span><span style=color:#111>.</span><span style=color:#75af00>m</span><span style=color:#111>.</span><span style=color:#75af00>set</span><span style=color:#111>(</span><span style=color:#75af00>acquirem</span><span style=color:#111>())</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>ready</span> <span style=color:#f92672>&lt;-</span> <span style=color:#00a8c8>struct</span><span style=color:#111>{}{}</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>for</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 阻塞当前 g 并把 node 传入 gcBgMarkWorkerPool</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>gopark</span><span style=color:#111>(</span><span style=color:#00a8c8>func</span><span style=color:#111>(</span><span style=color:#75af00>g</span> <span style=color:#f92672>*</span><span style=color:#75af00>g</span><span style=color:#111>,</span> <span style=color:#75af00>nodep</span> <span style=color:#75af00>unsafe</span><span style=color:#111>.</span><span style=color:#75af00>Pointer</span><span style=color:#111>)</span> <span style=color:#00a8c8>bool</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>node</span> <span style=color:#f92672>:=</span> <span style=color:#111>(</span><span style=color:#f92672>*</span><span style=color:#75af00>gcBgMarkWorkerNode</span><span style=color:#111>)(</span><span style=color:#75af00>nodep</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>if</span> <span style=color:#75af00>mp</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>node</span><span style=color:#111>.</span><span style=color:#75af00>m</span><span style=color:#111>.</span><span style=color:#75af00>ptr</span><span style=color:#111>();</span> <span style=color:#75af00>mp</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>				<span style=color:#75af00>releasem</span><span style=color:#111>(</span><span style=color:#75af00>mp</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>			<span style=color:#111>}</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>gcBgMarkWorkerPool</span><span style=color:#111>.</span><span style=color:#75af00>push</span><span style=color:#111>(</span><span style=color:#f92672>&amp;</span><span style=color:#75af00>node</span><span style=color:#111>.</span><span style=color:#75af00>node</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>return</span> <span style=color:#00a8c8>true</span>
</span></span><span style=display:flex><span>		<span style=color:#111>},</span> <span style=color:#75af00>unsafe</span><span style=color:#111>.</span><span style=color:#75af00>Pointer</span><span style=color:#111>(</span><span style=color:#75af00>node</span><span style=color:#111>),</span> <span style=color:#75af00>waitReasonGCWorkerIdle</span><span style=color:#111>,</span> <span style=color:#75af00>traceBlockSystemGoroutine</span><span style=color:#111>,</span> <span style=color:#ae81ff>0</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// ......</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 设置 gc goroutine 使用资源的方式</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>systemstack</span><span style=color:#111>(</span><span style=color:#00a8c8>func</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>casGToWaitingForGC</span><span style=color:#111>(</span><span style=color:#75af00>gp</span><span style=color:#111>,</span> <span style=color:#75af00>_Grunning</span><span style=color:#111>,</span> <span style=color:#75af00>waitReasonGCWorkerActive</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// gcDrain(......)</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// .....</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>casgstatus</span><span style=color:#111>(</span><span style=color:#75af00>gp</span><span style=color:#111>,</span> <span style=color:#75af00>_Gwaiting</span><span style=color:#111>,</span> <span style=color:#75af00>_Grunning</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#111>})</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// ......</span>
</span></span><span style=display:flex><span>		
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><h3 id=stoptheworldwithsema>stopTheWorldWithSema</h3><p>停止所有用户的 goroutine 做一些事情</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>stopTheWorldWithSema</span><span style=color:#111>(</span><span style=color:#75af00>reason</span> <span style=color:#75af00>stwReason</span><span style=color:#111>)</span> <span style=color:#75af00>worldStop</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 加锁 并抢占所有的 goroutine</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>lock</span><span style=color:#111>(</span><span style=color:#f92672>&amp;</span><span style=color:#75af00>sched</span><span style=color:#111>.</span><span style=color:#75af00>lock</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>preemptall</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 将所有 P 设置为 _Pgcstop 状态 （当前 运行中 和空闲）</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>gp</span><span style=color:#111>.</span><span style=color:#75af00>m</span><span style=color:#111>.</span><span style=color:#75af00>p</span><span style=color:#111>.</span><span style=color:#75af00>ptr</span><span style=color:#111>().</span><span style=color:#75af00>status</span> <span style=color:#111>=</span> <span style=color:#75af00>_Pgcstop</span> 
</span></span><span style=display:flex><span>	<span style=color:#75af00>gp</span><span style=color:#111>.</span><span style=color:#75af00>m</span><span style=color:#111>.</span><span style=color:#75af00>p</span><span style=color:#111>.</span><span style=color:#75af00>ptr</span><span style=color:#111>().</span><span style=color:#75af00>gcStopTime</span> <span style=color:#111>=</span> <span style=color:#75af00>start</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>sched</span><span style=color:#111>.</span><span style=color:#75af00>stopwait</span><span style=color:#f92672>--</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>trace</span> <span style=color:#111>=</span> <span style=color:#75af00>traceAcquire</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>for</span> <span style=color:#75af00>_</span><span style=color:#111>,</span> <span style=color:#75af00>pp</span> <span style=color:#f92672>:=</span> <span style=color:#00a8c8>range</span> <span style=color:#75af00>allp</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>s</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>pp</span><span style=color:#111>.</span><span style=color:#75af00>status</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>s</span> <span style=color:#f92672>==</span> <span style=color:#75af00>_Psyscall</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#75af00>atomic</span><span style=color:#111>.</span><span style=color:#75af00>Cas</span><span style=color:#111>(</span><span style=color:#f92672>&amp;</span><span style=color:#75af00>pp</span><span style=color:#111>.</span><span style=color:#75af00>status</span><span style=color:#111>,</span> <span style=color:#75af00>s</span><span style=color:#111>,</span> <span style=color:#75af00>_Pgcstop</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>if</span> <span style=color:#75af00>trace</span><span style=color:#111>.</span><span style=color:#75af00>ok</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>				<span style=color:#75af00>trace</span><span style=color:#111>.</span><span style=color:#75af00>ProcSteal</span><span style=color:#111>(</span><span style=color:#75af00>pp</span><span style=color:#111>,</span> <span style=color:#00a8c8>false</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>			<span style=color:#111>}</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>pp</span><span style=color:#111>.</span><span style=color:#75af00>syscalltick</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>pp</span><span style=color:#111>.</span><span style=color:#75af00>gcStopTime</span> <span style=color:#111>=</span> <span style=color:#75af00>nanotime</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>sched</span><span style=color:#111>.</span><span style=color:#75af00>stopwait</span><span style=color:#f92672>--</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>trace</span><span style=color:#111>.</span><span style=color:#75af00>ok</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>traceRelease</span><span style=color:#111>(</span><span style=color:#75af00>trace</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>now</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>nanotime</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>for</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>pp</span><span style=color:#111>,</span> <span style=color:#75af00>_</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>pidleget</span><span style=color:#111>(</span><span style=color:#75af00>now</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>pp</span> <span style=color:#f92672>==</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>break</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>pp</span><span style=color:#111>.</span><span style=color:#75af00>status</span> <span style=color:#111>=</span> <span style=color:#75af00>_Pgcstop</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>pp</span><span style=color:#111>.</span><span style=color:#75af00>gcStopTime</span> <span style=color:#111>=</span> <span style=color:#75af00>nanotime</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>sched</span><span style=color:#111>.</span><span style=color:#75af00>stopwait</span><span style=color:#f92672>--</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>wait</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>sched</span><span style=color:#111>.</span><span style=color:#75af00>stopwait</span> <span style=color:#111>&gt;</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>unlock</span><span style=color:#111>(</span><span style=color:#f92672>&amp;</span><span style=color:#75af00>sched</span><span style=color:#111>.</span><span style=color:#75af00>lock</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 当前 P 不能被抢占 等待完成</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>wait</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>for</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>if</span> <span style=color:#75af00>notetsleep</span><span style=color:#111>(</span><span style=color:#f92672>&amp;</span><span style=color:#75af00>sched</span><span style=color:#111>.</span><span style=color:#75af00>stopnote</span><span style=color:#111>,</span> <span style=color:#ae81ff>100</span><span style=color:#f92672>*</span><span style=color:#ae81ff>1000</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>				<span style=color:#75af00>noteclear</span><span style=color:#111>(</span><span style=color:#f92672>&amp;</span><span style=color:#75af00>sched</span><span style=color:#111>.</span><span style=color:#75af00>stopnote</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>				<span style=color:#00a8c8>break</span>
</span></span><span style=display:flex><span>			<span style=color:#111>}</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>preemptall</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ......</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>worldStopped</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>return</span> <span style=color:#75af00>worldStop</span><span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>reason</span><span style=color:#111>:</span>           <span style=color:#75af00>reason</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>startedStopping</span><span style=color:#111>:</span>  <span style=color:#75af00>start</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>finishedStopping</span><span style=color:#111>:</span> <span style=color:#75af00>finish</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>stoppingCPUTime</span><span style=color:#111>:</span>  <span style=color:#75af00>stoppingCPUTime</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><h3 id=startcycle>startCycle</h3><p>设置可以使用多少个核心进行 GC</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>c</span> <span style=color:#f92672>*</span><span style=color:#75af00>gcControllerState</span><span style=color:#111>)</span> <span style=color:#75af00>startCycle</span><span style=color:#111>(</span><span style=color:#75af00>markStartTime</span> <span style=color:#00a8c8>int64</span><span style=color:#111>,</span> <span style=color:#75af00>procs</span> <span style=color:#00a8c8>int</span><span style=color:#111>,</span> <span style=color:#75af00>trigger</span> <span style=color:#75af00>gcTrigger</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// P * 25% 然后取整</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>totalUtilizationGoal</span> <span style=color:#f92672>:=</span> <span style=color:#111>float64</span><span style=color:#111>(</span><span style=color:#75af00>procs</span><span style=color:#111>)</span> <span style=color:#f92672>*</span> <span style=color:#75af00>gcBackgroundUtilization</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>dedicatedMarkWorkersNeeded</span> <span style=color:#f92672>:=</span> <span style=color:#111>int64</span><span style=color:#111>(</span><span style=color:#75af00>totalUtilizationGoal</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>0.5</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>utilError</span> <span style=color:#f92672>:=</span> <span style=color:#111>float64</span><span style=color:#111>(</span><span style=color:#75af00>dedicatedMarkWorkersNeeded</span><span style=color:#111>)</span><span style=color:#f92672>/</span><span style=color:#75af00>totalUtilizationGoal</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>const</span> <span style=color:#75af00>maxUtilError</span> <span style=color:#111>=</span> <span style=color:#ae81ff>0.3</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 如果不能整除 算出时间片</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>utilError</span> <span style=color:#111>&lt;</span> <span style=color:#f92672>-</span><span style=color:#75af00>maxUtilError</span> <span style=color:#f92672>||</span> <span style=color:#75af00>utilError</span> <span style=color:#111>&gt;</span> <span style=color:#75af00>maxUtilError</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#111>float64</span><span style=color:#111>(</span><span style=color:#75af00>dedicatedMarkWorkersNeeded</span><span style=color:#111>)</span> <span style=color:#111>&gt;</span> <span style=color:#75af00>totalUtilizationGoal</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>dedicatedMarkWorkersNeeded</span><span style=color:#f92672>--</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>c</span><span style=color:#111>.</span><span style=color:#75af00>fractionalUtilizationGoal</span> <span style=color:#111>=</span> <span style=color:#111>(</span><span style=color:#75af00>totalUtilizationGoal</span> <span style=color:#f92672>-</span> <span style=color:#111>float64</span><span style=color:#111>(</span><span style=color:#75af00>dedicatedMarkWorkersNeeded</span><span style=color:#111>))</span> <span style=color:#f92672>/</span> <span style=color:#111>float64</span><span style=color:#111>(</span><span style=color:#75af00>procs</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span> <span style=color:#00a8c8>else</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>c</span><span style=color:#111>.</span><span style=color:#75af00>fractionalUtilizationGoal</span> <span style=color:#111>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>debug</span><span style=color:#111>.</span><span style=color:#75af00>gcstoptheworld</span> <span style=color:#111>&gt;</span> <span style=color:#ae81ff>0</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>dedicatedMarkWorkersNeeded</span> <span style=color:#111>=</span> <span style=color:#111>int64</span><span style=color:#111>(</span><span style=color:#75af00>procs</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>c</span><span style=color:#111>.</span><span style=color:#75af00>fractionalUtilizationGoal</span> <span style=color:#111>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><h3 id=setgcphase>setGCPhase</h3><p>开启混合写屏障</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>setGCPhase</span><span style=color:#111>(</span><span style=color:#75af00>x</span> <span style=color:#00a8c8>uint32</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>atomic</span><span style=color:#111>.</span><span style=color:#75af00>Store</span><span style=color:#111>(</span><span style=color:#f92672>&amp;</span><span style=color:#75af00>gcphase</span><span style=color:#111>,</span> <span style=color:#75af00>x</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>writeBarrier</span><span style=color:#111>.</span><span style=color:#75af00>enabled</span> <span style=color:#111>=</span> <span style=color:#75af00>gcphase</span> <span style=color:#f92672>==</span> <span style=color:#75af00>_GCmark</span> <span style=color:#f92672>||</span> <span style=color:#75af00>gcphase</span> <span style=color:#f92672>==</span> <span style=color:#75af00>_GCmarktermination</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><pre tabindex=0><code class=language-assembly data-lang=assembly>TEXT gcWriteBarrier&lt;&gt;(SB),NOSPLIT,$112
// ...
CALL	runtime·wbBufFlush(SB)
// ...
</code></pre><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>wbBufFlush</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 如果当前 M（操作系统线程）正在终止过程中</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>getg</span><span style=color:#111>().</span><span style=color:#75af00>m</span><span style=color:#111>.</span><span style=color:#75af00>dying</span> <span style=color:#111>&gt;</span> <span style=color:#ae81ff>0</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>getg</span><span style=color:#111>().</span><span style=color:#75af00>m</span><span style=color:#111>.</span><span style=color:#75af00>p</span><span style=color:#111>.</span><span style=color:#75af00>ptr</span><span style=color:#111>().</span><span style=color:#75af00>wbBuf</span><span style=color:#111>.</span><span style=color:#75af00>discard</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>return</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>systemstack</span><span style=color:#111>(</span><span style=color:#00a8c8>func</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>wbBufFlush1</span><span style=color:#111>(</span><span style=color:#75af00>getg</span><span style=color:#111>().</span><span style=color:#75af00>m</span><span style=color:#111>.</span><span style=color:#75af00>p</span><span style=color:#111>.</span><span style=color:#75af00>ptr</span><span style=color:#111>())</span>
</span></span><span style=display:flex><span>	<span style=color:#111>})</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>wbBufFlush1</span><span style=color:#111>(</span><span style=color:#75af00>pp</span> <span style=color:#f92672>*</span><span style=color:#75af00>p</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 获取缓冲区中的所有指针</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>start</span> <span style=color:#f92672>:=</span> <span style=color:#111>uintptr</span><span style=color:#111>(</span><span style=color:#75af00>unsafe</span><span style=color:#111>.</span><span style=color:#75af00>Pointer</span><span style=color:#111>(</span><span style=color:#f92672>&amp;</span><span style=color:#75af00>pp</span><span style=color:#111>.</span><span style=color:#75af00>wbBuf</span><span style=color:#111>.</span><span style=color:#75af00>buf</span><span style=color:#111>[</span><span style=color:#ae81ff>0</span><span style=color:#111>]))</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>n</span> <span style=color:#f92672>:=</span> <span style=color:#111>(</span><span style=color:#75af00>pp</span><span style=color:#111>.</span><span style=color:#75af00>wbBuf</span><span style=color:#111>.</span><span style=color:#75af00>next</span> <span style=color:#f92672>-</span> <span style=color:#75af00>start</span><span style=color:#111>)</span> <span style=color:#f92672>/</span> <span style=color:#75af00>unsafe</span><span style=color:#111>.</span><span style=color:#75af00>Sizeof</span><span style=color:#111>(</span><span style=color:#75af00>pp</span><span style=color:#111>.</span><span style=color:#75af00>wbBuf</span><span style=color:#111>.</span><span style=color:#75af00>buf</span><span style=color:#111>[</span><span style=color:#ae81ff>0</span><span style=color:#111>])</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>ptrs</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>pp</span><span style=color:#111>.</span><span style=color:#75af00>wbBuf</span><span style=color:#111>.</span><span style=color:#75af00>buf</span><span style=color:#111>[:</span><span style=color:#75af00>n</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Poison the buffer to make extra sure nothing is enqueued</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// while we&#39;re processing the buffer.</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>pp</span><span style=color:#111>.</span><span style=color:#75af00>wbBuf</span><span style=color:#111>.</span><span style=color:#75af00>next</span> <span style=color:#111>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>useCheckmark</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// Slow path for checkmark mode.</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>for</span> <span style=color:#75af00>_</span><span style=color:#111>,</span> <span style=color:#75af00>ptr</span> <span style=color:#f92672>:=</span> <span style=color:#00a8c8>range</span> <span style=color:#75af00>ptrs</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>shade</span><span style=color:#111>(</span><span style=color:#75af00>ptr</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>pp</span><span style=color:#111>.</span><span style=color:#75af00>wbBuf</span><span style=color:#111>.</span><span style=color:#75af00>reset</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>return</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 标记缓冲区中的所有指针，并且只记录被置灰的指针。</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 使用缓冲区本身临时记录被置灰的指针。</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>gcw</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#75af00>pp</span><span style=color:#111>.</span><span style=color:#75af00>gcw</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>pos</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>for</span> <span style=color:#75af00>_</span><span style=color:#111>,</span> <span style=color:#75af00>ptr</span> <span style=color:#f92672>:=</span> <span style=color:#00a8c8>range</span> <span style=color:#75af00>ptrs</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>ptr</span> <span style=color:#111>&lt;</span> <span style=color:#75af00>minLegalPointer</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>continue</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>obj</span><span style=color:#111>,</span> <span style=color:#75af00>span</span><span style=color:#111>,</span> <span style=color:#75af00>objIndex</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>findObject</span><span style=color:#111>(</span><span style=color:#75af00>ptr</span><span style=color:#111>,</span> <span style=color:#ae81ff>0</span><span style=color:#111>,</span> <span style=color:#ae81ff>0</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>obj</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>continue</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>mbits</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>span</span><span style=color:#111>.</span><span style=color:#75af00>markBitsForIndex</span><span style=color:#111>(</span><span style=color:#75af00>objIndex</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>mbits</span><span style=color:#111>.</span><span style=color:#75af00>isMarked</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>continue</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>mbits</span><span style=color:#111>.</span><span style=color:#75af00>setMarked</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>arena</span><span style=color:#111>,</span> <span style=color:#75af00>pageIdx</span><span style=color:#111>,</span> <span style=color:#75af00>pageMask</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>pageIndexOf</span><span style=color:#111>(</span><span style=color:#75af00>span</span><span style=color:#111>.</span><span style=color:#75af00>base</span><span style=color:#111>())</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>arena</span><span style=color:#111>.</span><span style=color:#75af00>pageMarks</span><span style=color:#111>[</span><span style=color:#75af00>pageIdx</span><span style=color:#111>]</span><span style=color:#f92672>&amp;</span><span style=color:#75af00>pageMask</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>atomic</span><span style=color:#111>.</span><span style=color:#75af00>Or8</span><span style=color:#111>(</span><span style=color:#f92672>&amp;</span><span style=color:#75af00>arena</span><span style=color:#111>.</span><span style=color:#75af00>pageMarks</span><span style=color:#111>[</span><span style=color:#75af00>pageIdx</span><span style=color:#111>],</span> <span style=color:#75af00>pageMask</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>span</span><span style=color:#111>.</span><span style=color:#75af00>spanclass</span><span style=color:#111>.</span><span style=color:#75af00>noscan</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>gcw</span><span style=color:#111>.</span><span style=color:#75af00>bytesMarked</span> <span style=color:#f92672>+=</span> <span style=color:#111>uint64</span><span style=color:#111>(</span><span style=color:#75af00>span</span><span style=color:#111>.</span><span style=color:#75af00>elemsize</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>continue</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>ptrs</span><span style=color:#111>[</span><span style=color:#75af00>pos</span><span style=color:#111>]</span> <span style=color:#111>=</span> <span style=color:#75af00>obj</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>pos</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 将被置灰的指针批量放入 gcw 中</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>gcw</span><span style=color:#111>.</span><span style=color:#75af00>putBatch</span><span style=color:#111>(</span><span style=color:#75af00>ptrs</span><span style=color:#111>[:</span><span style=color:#75af00>pos</span><span style=color:#111>])</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>pp</span><span style=color:#111>.</span><span style=color:#75af00>wbBuf</span><span style=color:#111>.</span><span style=color:#75af00>reset</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><h3 id=gcmarktinyallocs>gcMarkTinyAllocs</h3><p>把所有的 tinyalloc 标记为灰色</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>gcMarkTinyAllocs</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>assertWorldStopped</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>for</span> <span style=color:#75af00>_</span><span style=color:#111>,</span> <span style=color:#75af00>p</span> <span style=color:#f92672>:=</span> <span style=color:#00a8c8>range</span> <span style=color:#75af00>allp</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>c</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>p</span><span style=color:#111>.</span><span style=color:#75af00>mcache</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>c</span> <span style=color:#f92672>==</span> <span style=color:#00a8c8>nil</span> <span style=color:#f92672>||</span> <span style=color:#75af00>c</span><span style=color:#111>.</span><span style=color:#75af00>tiny</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>continue</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>_</span><span style=color:#111>,</span> <span style=color:#75af00>span</span><span style=color:#111>,</span> <span style=color:#75af00>objIndex</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>findObject</span><span style=color:#111>(</span><span style=color:#75af00>c</span><span style=color:#111>.</span><span style=color:#75af00>tiny</span><span style=color:#111>,</span> <span style=color:#ae81ff>0</span><span style=color:#111>,</span> <span style=color:#ae81ff>0</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>gcw</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#75af00>p</span><span style=color:#111>.</span><span style=color:#75af00>gcw</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>greyobject</span><span style=color:#111>(</span><span style=color:#75af00>c</span><span style=color:#111>.</span><span style=color:#75af00>tiny</span><span style=color:#111>,</span> <span style=color:#ae81ff>0</span><span style=color:#111>,</span> <span style=color:#ae81ff>0</span><span style=color:#111>,</span> <span style=color:#75af00>span</span><span style=color:#111>,</span> <span style=color:#75af00>gcw</span><span style=color:#111>,</span> <span style=color:#75af00>objIndex</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><h3 id=starttheworldwithsema>startTheWorldWithSema</h3><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>startTheWorldWithSema</span><span style=color:#111>(</span><span style=color:#75af00>now</span> <span style=color:#00a8c8>int64</span><span style=color:#111>,</span> <span style=color:#75af00>w</span> <span style=color:#75af00>worldStop</span><span style=color:#111>)</span> <span style=color:#00a8c8>int64</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ......</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>worldStarted</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 唤醒所有的 P</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>for</span> <span style=color:#75af00>p1</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>p</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>p1</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>p1</span> <span style=color:#111>=</span> <span style=color:#75af00>p1</span><span style=color:#111>.</span><span style=color:#75af00>link</span><span style=color:#111>.</span><span style=color:#75af00>ptr</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>p</span><span style=color:#111>.</span><span style=color:#75af00>m</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>mp</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>p</span><span style=color:#111>.</span><span style=color:#75af00>m</span><span style=color:#111>.</span><span style=color:#75af00>ptr</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>p</span><span style=color:#111>.</span><span style=color:#75af00>m</span> <span style=color:#111>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>if</span> <span style=color:#75af00>mp</span><span style=color:#111>.</span><span style=color:#75af00>nextp</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>				<span style=color:#75af00>throw</span><span style=color:#111>(</span><span style=color:#d88200>&#34;startTheWorld: inconsistent mp-&gt;nextp&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>			<span style=color:#111>}</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>mp</span><span style=color:#111>.</span><span style=color:#75af00>nextp</span><span style=color:#111>.</span><span style=color:#75af00>set</span><span style=color:#111>(</span><span style=color:#75af00>p</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>notewakeup</span><span style=color:#111>(</span><span style=color:#f92672>&amp;</span><span style=color:#75af00>mp</span><span style=color:#111>.</span><span style=color:#75af00>park</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span> <span style=color:#00a8c8>else</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>newm</span><span style=color:#111>(</span><span style=color:#00a8c8>nil</span><span style=color:#111>,</span> <span style=color:#75af00>p</span><span style=color:#111>,</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ......</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>return</span> <span style=color:#75af00>now</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><h2 id=worker-标记>worker 标记</h2><p>在 goroutine 调度中会执行 <code>findRunnableGCWorker</code> goroutine 这个就是启动标记 worker 的函数</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>c</span> <span style=color:#f92672>*</span><span style=color:#75af00>gcControllerState</span><span style=color:#111>)</span> <span style=color:#75af00>findRunnableGCWorker</span><span style=color:#111>(</span><span style=color:#75af00>pp</span> <span style=color:#f92672>*</span><span style=color:#75af00>p</span><span style=color:#111>,</span> <span style=color:#75af00>now</span> <span style=color:#00a8c8>int64</span><span style=color:#111>)</span> <span style=color:#111>(</span><span style=color:#f92672>*</span><span style=color:#75af00>g</span><span style=color:#111>,</span> <span style=color:#00a8c8>int64</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ......</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 从 gcBgMarkWorkerPool 拿出 node </span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>node</span> <span style=color:#f92672>:=</span> <span style=color:#111>(</span><span style=color:#f92672>*</span><span style=color:#75af00>gcBgMarkWorkerNode</span><span style=color:#111>)(</span><span style=color:#75af00>gcBgMarkWorkerPool</span><span style=color:#111>.</span><span style=color:#75af00>pop</span><span style=color:#111>())</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 开启</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>casgstatus</span><span style=color:#111>(</span><span style=color:#75af00>gp</span><span style=color:#111>,</span> <span style=color:#75af00>_Gwaiting</span><span style=color:#111>,</span> <span style=color:#75af00>_Grunnable</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>return</span> <span style=color:#75af00>gp</span><span style=color:#111>,</span> <span style=color:#75af00>now</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><h2 id=gcdrain>gcDrain</h2><p>gcDrain 是标记的主流程</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>gcDrain</span><span style=color:#111>(</span><span style=color:#75af00>gcw</span> <span style=color:#f92672>*</span><span style=color:#75af00>gcWork</span><span style=color:#111>,</span> <span style=color:#75af00>flags</span> <span style=color:#75af00>gcDrainFlags</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ......</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 标记根对象</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>work</span><span style=color:#111>.</span><span style=color:#75af00>markrootNext</span> <span style=color:#111>&lt;</span> <span style=color:#75af00>work</span><span style=color:#111>.</span><span style=color:#75af00>markrootJobs</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>for</span> <span style=color:#111>!(</span><span style=color:#75af00>gp</span><span style=color:#111>.</span><span style=color:#75af00>preempt</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#111>(</span><span style=color:#75af00>preemptible</span> <span style=color:#f92672>||</span> <span style=color:#75af00>sched</span><span style=color:#111>.</span><span style=color:#75af00>gcwaiting</span><span style=color:#111>.</span><span style=color:#75af00>Load</span><span style=color:#111>()</span> <span style=color:#f92672>||</span> <span style=color:#75af00>pp</span><span style=color:#111>.</span><span style=color:#75af00>runSafePointFn</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span><span style=color:#111>))</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>job</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>atomic</span><span style=color:#111>.</span><span style=color:#75af00>Xadd</span><span style=color:#111>(</span><span style=color:#f92672>&amp;</span><span style=color:#75af00>work</span><span style=color:#111>.</span><span style=color:#75af00>markrootNext</span><span style=color:#111>,</span> <span style=color:#f92672>+</span><span style=color:#ae81ff>1</span><span style=color:#111>)</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>if</span> <span style=color:#75af00>job</span> <span style=color:#f92672>&gt;=</span> <span style=color:#75af00>work</span><span style=color:#111>.</span><span style=color:#75af00>markrootJobs</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>				<span style=color:#00a8c8>break</span>
</span></span><span style=display:flex><span>			<span style=color:#111>}</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>markroot</span><span style=color:#111>(</span><span style=color:#75af00>gcw</span><span style=color:#111>,</span> <span style=color:#75af00>job</span><span style=color:#111>,</span> <span style=color:#75af00>flushBgCredit</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>if</span> <span style=color:#75af00>check</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#75af00>check</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>				<span style=color:#00a8c8>goto</span> <span style=color:#75af00>done</span>
</span></span><span style=display:flex><span>			<span style=color:#111>}</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>for</span> <span style=color:#111>!(</span><span style=color:#75af00>gp</span><span style=color:#111>.</span><span style=color:#75af00>preempt</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#111>(</span><span style=color:#75af00>preemptible</span> <span style=color:#f92672>||</span> <span style=color:#75af00>sched</span><span style=color:#111>.</span><span style=color:#75af00>gcwaiting</span><span style=color:#111>.</span><span style=color:#75af00>Load</span><span style=color:#111>()</span> <span style=color:#f92672>||</span> <span style=color:#75af00>pp</span><span style=color:#111>.</span><span style=color:#75af00>runSafePointFn</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span><span style=color:#111>))</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>work</span><span style=color:#111>.</span><span style=color:#75af00>full</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>gcw</span><span style=color:#111>.</span><span style=color:#75af00>balance</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 尝试从本地队列中获取对象</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>b</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>gcw</span><span style=color:#111>.</span><span style=color:#75af00>tryGetFast</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>b</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 如果没有从全局队列中获取 加锁</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>b</span> <span style=color:#111>=</span> <span style=color:#75af00>gcw</span><span style=color:#111>.</span><span style=color:#75af00>tryGet</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>if</span> <span style=color:#75af00>b</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>				<span style=color:#75715e>// 刷新写屏障缓存</span>
</span></span><span style=display:flex><span>				<span style=color:#75af00>wbBufFlush</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>				<span style=color:#75af00>b</span> <span style=color:#111>=</span> <span style=color:#75af00>gcw</span><span style=color:#111>.</span><span style=color:#75af00>tryGet</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>			<span style=color:#111>}</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>b</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>break</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 清扫对象</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>scanobject</span><span style=color:#111>(</span><span style=color:#75af00>b</span><span style=color:#111>,</span> <span style=color:#75af00>gcw</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// ......</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75af00>done</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 记录积分</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>gcw</span><span style=color:#111>.</span><span style=color:#75af00>heapScanWork</span> <span style=color:#111>&gt;</span> <span style=color:#ae81ff>0</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>gcController</span><span style=color:#111>.</span><span style=color:#75af00>heapScanWork</span><span style=color:#111>.</span><span style=color:#75af00>Add</span><span style=color:#111>(</span><span style=color:#75af00>gcw</span><span style=color:#111>.</span><span style=color:#75af00>heapScanWork</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>flushBgCredit</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>gcFlushBgCredit</span><span style=color:#111>(</span><span style=color:#75af00>gcw</span><span style=color:#111>.</span><span style=color:#75af00>heapScanWork</span> <span style=color:#f92672>-</span> <span style=color:#75af00>initScanWork</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>gcw</span><span style=color:#111>.</span><span style=color:#75af00>heapScanWork</span> <span style=color:#111>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><h3 id=scanobject>scanobject</h3><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>scanobject</span><span style=color:#111>(</span><span style=color:#75af00>b</span> <span style=color:#00a8c8>uintptr</span><span style=color:#111>,</span> <span style=color:#75af00>gcw</span> <span style=color:#f92672>*</span><span style=color:#75af00>gcWork</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>var</span> <span style=color:#75af00>tp</span> <span style=color:#75af00>typePointers</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>n</span> <span style=color:#111>&gt;</span> <span style=color:#75af00>maxObletBytes</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 大对象分块</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>b</span> <span style=color:#f92672>==</span> <span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>base</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>for</span> <span style=color:#75af00>oblet</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>b</span> <span style=color:#f92672>+</span> <span style=color:#75af00>maxObletBytes</span><span style=color:#111>;</span> <span style=color:#75af00>oblet</span> <span style=color:#111>&lt;</span> <span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>base</span><span style=color:#111>()</span><span style=color:#f92672>+</span><span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>elemsize</span><span style=color:#111>;</span> <span style=color:#75af00>oblet</span> <span style=color:#f92672>+=</span> <span style=color:#75af00>maxObletBytes</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>				<span style=color:#00a8c8>if</span> <span style=color:#111>!</span><span style=color:#75af00>gcw</span><span style=color:#111>.</span><span style=color:#75af00>putFast</span><span style=color:#111>(</span><span style=color:#75af00>oblet</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>					<span style=color:#75af00>gcw</span><span style=color:#111>.</span><span style=color:#75af00>put</span><span style=color:#111>(</span><span style=color:#75af00>oblet</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>				<span style=color:#111>}</span>
</span></span><span style=display:flex><span>			<span style=color:#111>}</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>n</span> <span style=color:#111>=</span> <span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>base</span><span style=color:#111>()</span> <span style=color:#f92672>+</span> <span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>elemsize</span> <span style=color:#f92672>-</span> <span style=color:#75af00>b</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>n</span> <span style=color:#111>=</span> <span style=color:#111>min</span><span style=color:#111>(</span><span style=color:#75af00>n</span><span style=color:#111>,</span> <span style=color:#75af00>maxObletBytes</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>tp</span> <span style=color:#111>=</span> <span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>typePointersOfUnchecked</span><span style=color:#111>(</span><span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>base</span><span style=color:#111>())</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>tp</span> <span style=color:#111>=</span> <span style=color:#75af00>tp</span><span style=color:#111>.</span><span style=color:#75af00>fastForward</span><span style=color:#111>(</span><span style=color:#75af00>b</span><span style=color:#f92672>-</span><span style=color:#75af00>tp</span><span style=color:#111>.</span><span style=color:#75af00>addr</span><span style=color:#111>,</span> <span style=color:#75af00>b</span><span style=color:#f92672>+</span><span style=color:#75af00>n</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span> <span style=color:#00a8c8>else</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>tp</span> <span style=color:#111>=</span> <span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>typePointersOfUnchecked</span><span style=color:#111>(</span><span style=color:#75af00>b</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>var</span> <span style=color:#75af00>scanSize</span> <span style=color:#00a8c8>uintptr</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>for</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>var</span> <span style=color:#75af00>addr</span> <span style=color:#00a8c8>uintptr</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>tp</span><span style=color:#111>,</span> <span style=color:#75af00>addr</span> <span style=color:#111>=</span> <span style=color:#75af00>tp</span><span style=color:#111>.</span><span style=color:#75af00>nextFast</span><span style=color:#111>();</span> <span style=color:#75af00>addr</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>if</span> <span style=color:#75af00>tp</span><span style=color:#111>,</span> <span style=color:#75af00>addr</span> <span style=color:#111>=</span> <span style=color:#75af00>tp</span><span style=color:#111>.</span><span style=color:#75af00>next</span><span style=color:#111>(</span><span style=color:#75af00>b</span> <span style=color:#f92672>+</span> <span style=color:#75af00>n</span><span style=color:#111>);</span> <span style=color:#75af00>addr</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>				<span style=color:#00a8c8>break</span>
</span></span><span style=display:flex><span>			<span style=color:#111>}</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>scanSize</span> <span style=color:#111>=</span> <span style=color:#75af00>addr</span> <span style=color:#f92672>-</span> <span style=color:#75af00>b</span> <span style=color:#f92672>+</span> <span style=color:#75af00>goarch</span><span style=color:#111>.</span><span style=color:#75af00>PtrSize</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>obj</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>*</span><span style=color:#111>(</span><span style=color:#f92672>*</span><span style=color:#00a8c8>uintptr</span><span style=color:#111>)(</span><span style=color:#75af00>unsafe</span><span style=color:#111>.</span><span style=color:#75af00>Pointer</span><span style=color:#111>(</span><span style=color:#75af00>addr</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>obj</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#75af00>obj</span><span style=color:#f92672>-</span><span style=color:#75af00>b</span> <span style=color:#f92672>&gt;=</span> <span style=color:#75af00>n</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>if</span> <span style=color:#75af00>obj</span><span style=color:#111>,</span> <span style=color:#75af00>span</span><span style=color:#111>,</span> <span style=color:#75af00>objIndex</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>findObject</span><span style=color:#111>(</span><span style=color:#75af00>obj</span><span style=color:#111>,</span> <span style=color:#75af00>b</span><span style=color:#111>,</span> <span style=color:#75af00>addr</span><span style=color:#f92672>-</span><span style=color:#75af00>b</span><span style=color:#111>);</span> <span style=color:#75af00>obj</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// 设置为灰色</span>
</span></span><span style=display:flex><span>				<span style=color:#75af00>greyobject</span><span style=color:#111>(</span><span style=color:#75af00>obj</span><span style=color:#111>,</span> <span style=color:#75af00>b</span><span style=color:#111>,</span> <span style=color:#75af00>addr</span><span style=color:#f92672>-</span><span style=color:#75af00>b</span><span style=color:#111>,</span> <span style=color:#75af00>span</span><span style=color:#111>,</span> <span style=color:#75af00>gcw</span><span style=color:#111>,</span> <span style=color:#75af00>objIndex</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>			<span style=color:#111>}</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><p><strong>greyobject</strong></p><p>gcmarkBits 是一个 bitmaps 代表了一个对象是不是可用（gc 过程中）</p><ol><li>如果 Bit = 1 对象不在 gcw 中 黑色</li><li>如果 Bit = 0 对象不在 gcw 中 白色</li><li>如果对象在 gcw 中 灰色</li></ol><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>greyobject</span><span style=color:#111>(</span><span style=color:#75af00>obj</span><span style=color:#111>,</span> <span style=color:#75af00>base</span><span style=color:#111>,</span> <span style=color:#75af00>off</span> <span style=color:#00a8c8>uintptr</span><span style=color:#111>,</span> <span style=color:#75af00>span</span> <span style=color:#f92672>*</span><span style=color:#75af00>mspan</span><span style=color:#111>,</span> <span style=color:#75af00>gcw</span> <span style=color:#f92672>*</span><span style=color:#75af00>gcWork</span><span style=color:#111>,</span> <span style=color:#75af00>objIndex</span> <span style=color:#00a8c8>uintptr</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>mbits</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>span</span><span style=color:#111>.</span><span style=color:#75af00>markBitsForIndex</span><span style=color:#111>(</span><span style=color:#75af00>objIndex</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>useCheckmark</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span> <span style=color:#00a8c8>else</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>mbits</span><span style=color:#111>.</span><span style=color:#75af00>setMarked</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 把对象放入 gcw 中</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>sys</span><span style=color:#111>.</span><span style=color:#75af00>Prefetch</span><span style=color:#111>(</span><span style=color:#75af00>obj</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#111>!</span><span style=color:#75af00>gcw</span><span style=color:#111>.</span><span style=color:#75af00>putFast</span><span style=color:#111>(</span><span style=color:#75af00>obj</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>gcw</span><span style=color:#111>.</span><span style=color:#75af00>put</span><span style=color:#111>(</span><span style=color:#75af00>obj</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>s</span> <span style=color:#f92672>*</span><span style=color:#75af00>mspan</span><span style=color:#111>)</span> <span style=color:#75af00>markBitsForIndex</span><span style=color:#111>(</span><span style=color:#75af00>objIndex</span> <span style=color:#00a8c8>uintptr</span><span style=color:#111>)</span> <span style=color:#75af00>markBits</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>bytep</span><span style=color:#111>,</span> <span style=color:#75af00>mask</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>gcmarkBits</span><span style=color:#111>.</span><span style=color:#75af00>bitp</span><span style=color:#111>(</span><span style=color:#75af00>objIndex</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>return</span> <span style=color:#75af00>markBits</span><span style=color:#111>{</span><span style=color:#75af00>bytep</span><span style=color:#111>,</span> <span style=color:#75af00>mask</span><span style=color:#111>,</span> <span style=color:#75af00>objIndex</span><span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>m</span> <span style=color:#75af00>markBits</span><span style=color:#111>)</span> <span style=color:#75af00>setMarked</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>atomic</span><span style=color:#111>.</span><span style=color:#75af00>Or8</span><span style=color:#111>(</span><span style=color:#75af00>m</span><span style=color:#111>.</span><span style=color:#75af00>bytep</span><span style=color:#111>,</span> <span style=color:#75af00>m</span><span style=color:#111>.</span><span style=color:#75af00>mask</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><h2 id=用户-goroutine-清扫>用户 goroutine 清扫</h2><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>deductAssistCredit</span><span style=color:#111>(</span><span style=color:#75af00>size</span> <span style=color:#00a8c8>uintptr</span><span style=color:#111>)</span> <span style=color:#f92672>*</span><span style=color:#75af00>g</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>var</span> <span style=color:#75af00>assistG</span> <span style=color:#f92672>*</span><span style=color:#75af00>g</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>gcBlackenEnabled</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>assistG</span> <span style=color:#111>=</span> <span style=color:#75af00>getg</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>assistG</span><span style=color:#111>.</span><span style=color:#75af00>m</span><span style=color:#111>.</span><span style=color:#75af00>curg</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>assistG</span> <span style=color:#111>=</span> <span style=color:#75af00>assistG</span><span style=color:#111>.</span><span style=color:#75af00>m</span><span style=color:#111>.</span><span style=color:#75af00>curg</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>assistG</span><span style=color:#111>.</span><span style=color:#75af00>gcAssistBytes</span> <span style=color:#f92672>-=</span> <span style=color:#111>int64</span><span style=color:#111>(</span><span style=color:#75af00>size</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 每个 G 都有自己的积分 当积分小于 0 启动 gc</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>assistG</span><span style=color:#111>.</span><span style=color:#75af00>gcAssistBytes</span> <span style=color:#111>&lt;</span> <span style=color:#ae81ff>0</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>gcAssistAlloc</span><span style=color:#111>(</span><span style=color:#75af00>assistG</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>return</span> <span style=color:#75af00>assistG</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>gcAssistAlloc</span><span style=color:#111>(</span><span style=color:#75af00>gp</span> <span style=color:#f92672>*</span><span style=color:#75af00>g</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ......</span>
</span></span><span style=display:flex><span><span style=color:#75af00>retry</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 处理下 assistG 的积分 需不需要启动 gc</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Perform assist work</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>systemstack</span><span style=color:#111>(</span><span style=color:#00a8c8>func</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>gcAssistAlloc1</span><span style=color:#111>(</span><span style=color:#75af00>gp</span><span style=color:#111>,</span> <span style=color:#75af00>scanWork</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>})</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ......</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>gcAssistAlloc1</span><span style=color:#111>(</span><span style=color:#75af00>gp</span> <span style=color:#f92672>*</span><span style=color:#75af00>g</span><span style=color:#111>,</span> <span style=color:#75af00>scanWork</span> <span style=color:#00a8c8>int64</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ......</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>gcw</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#75af00>getg</span><span style=color:#111>().</span><span style=color:#75af00>m</span><span style=color:#111>.</span><span style=color:#75af00>p</span><span style=color:#111>.</span><span style=color:#75af00>ptr</span><span style=color:#111>().</span><span style=color:#75af00>gcw</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>workDone</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>gcDrainN</span><span style=color:#111>(</span><span style=color:#75af00>gcw</span><span style=color:#111>,</span> <span style=color:#75af00>scanWork</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>casgstatus</span><span style=color:#111>(</span><span style=color:#75af00>gp</span><span style=color:#111>,</span> <span style=color:#75af00>_Gwaiting</span><span style=color:#111>,</span> <span style=color:#75af00>_Grunning</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ......</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><h2 id=终止标记-gcmarkdone>终止标记 gcMarkDone</h2><p>在 gcBgMarkStartWorkers 中执行 gcMarkDone 终止</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>gcMarkDone</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75af00>top</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 清除写屏障的缓存和处理gcw</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>gcMarkDoneFlushed</span> <span style=color:#111>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>forEachP</span><span style=color:#111>(</span><span style=color:#75af00>waitReasonGCMarkTermination</span><span style=color:#111>,</span> <span style=color:#00a8c8>func</span><span style=color:#111>(</span><span style=color:#75af00>pp</span> <span style=color:#f92672>*</span><span style=color:#75af00>p</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>wbBufFlush1</span><span style=color:#111>(</span><span style=color:#75af00>pp</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>pp</span><span style=color:#111>.</span><span style=color:#75af00>gcw</span><span style=color:#111>.</span><span style=color:#75af00>dispose</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>pp</span><span style=color:#111>.</span><span style=color:#75af00>gcw</span><span style=color:#111>.</span><span style=color:#75af00>flushedWork</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>atomic</span><span style=color:#111>.</span><span style=color:#75af00>Xadd</span><span style=color:#111>(</span><span style=color:#f92672>&amp;</span><span style=color:#75af00>gcMarkDoneFlushed</span><span style=color:#111>,</span> <span style=color:#ae81ff>1</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>pp</span><span style=color:#111>.</span><span style=color:#75af00>gcw</span><span style=color:#111>.</span><span style=color:#75af00>flushedWork</span> <span style=color:#111>=</span> <span style=color:#00a8c8>false</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#111>})</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>gcMarkDoneFlushed</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 还有没处理的 跳回去再处理一次</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>semrelease</span><span style=color:#111>(</span><span style=color:#f92672>&amp;</span><span style=color:#75af00>worldsema</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>goto</span> <span style=color:#75af00>top</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Stop The World</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>systemstack</span><span style=color:#111>(</span><span style=color:#00a8c8>func</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>stw</span> <span style=color:#111>=</span> <span style=color:#75af00>stopTheWorldWithSema</span><span style=color:#111>(</span><span style=color:#75af00>stwGCMarkTerm</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>})</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 清楚写屏障中的缓存 如果还有没处理的 跳回去再处理一次</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>restart</span> <span style=color:#f92672>:=</span> <span style=color:#00a8c8>false</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>systemstack</span><span style=color:#111>(</span><span style=color:#00a8c8>func</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>for</span> <span style=color:#75af00>_</span><span style=color:#111>,</span> <span style=color:#75af00>p</span> <span style=color:#f92672>:=</span> <span style=color:#00a8c8>range</span> <span style=color:#75af00>allp</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>wbBufFlush1</span><span style=color:#111>(</span><span style=color:#75af00>p</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>if</span> <span style=color:#111>!</span><span style=color:#75af00>p</span><span style=color:#111>.</span><span style=color:#75af00>gcw</span><span style=color:#111>.</span><span style=color:#75af00>empty</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>				<span style=color:#75af00>restart</span> <span style=color:#111>=</span> <span style=color:#00a8c8>true</span>
</span></span><span style=display:flex><span>				<span style=color:#00a8c8>break</span>
</span></span><span style=display:flex><span>			<span style=color:#111>}</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#111>})</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>restart</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>getg</span><span style=color:#111>().</span><span style=color:#75af00>m</span><span style=color:#111>.</span><span style=color:#75af00>preemptoff</span> <span style=color:#111>=</span> <span style=color:#d88200>&#34;&#34;</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>systemstack</span><span style=color:#111>(</span><span style=color:#00a8c8>func</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>work</span><span style=color:#111>.</span><span style=color:#75af00>cpuStats</span><span style=color:#111>.</span><span style=color:#75af00>accumulateGCPauseTime</span><span style=color:#111>(</span><span style=color:#75af00>nanotime</span><span style=color:#111>()</span><span style=color:#f92672>-</span><span style=color:#75af00>stw</span><span style=color:#111>.</span><span style=color:#75af00>finishedStopping</span><span style=color:#111>,</span> <span style=color:#75af00>work</span><span style=color:#111>.</span><span style=color:#75af00>maxprocs</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>now</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>startTheWorldWithSema</span><span style=color:#111>(</span><span style=color:#ae81ff>0</span><span style=color:#111>,</span> <span style=color:#75af00>stw</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>work</span><span style=color:#111>.</span><span style=color:#75af00>pauseNS</span> <span style=color:#f92672>+=</span> <span style=color:#75af00>now</span> <span style=color:#f92672>-</span> <span style=color:#75af00>stw</span><span style=color:#111>.</span><span style=color:#75af00>startedStopping</span>
</span></span><span style=display:flex><span>		<span style=color:#111>})</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>semrelease</span><span style=color:#111>(</span><span style=color:#f92672>&amp;</span><span style=color:#75af00>worldsema</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>goto</span> <span style=color:#75af00>top</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 终止标记</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>gcMarkTermination</span><span style=color:#111>(</span><span style=color:#75af00>stw</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><h3 id=gcmarktermination>gcMarkTermination</h3><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>gcMarkTermination</span><span style=color:#111>(</span><span style=color:#75af00>stw</span> <span style=color:#75af00>worldStop</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 设置 gc 终止阶段</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>setGCPhase</span><span style=color:#111>(</span><span style=color:#75af00>_GCmarktermination</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 修改 gc goroutine 状态</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>casGToWaitingForGC</span><span style=color:#111>(</span><span style=color:#75af00>curgp</span><span style=color:#111>,</span> <span style=color:#75af00>_Grunning</span><span style=color:#111>,</span> <span style=color:#75af00>waitReasonGarbageCollection</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 在 g0 栈上运行 gc。这样做是为了保证我们当前运行的 g 栈不再变化，</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 这有助于减少根集大小（g0 栈不会被扫描，我们也不需要扫描 gc 的内部状态）。</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 我们还需要切换到 g0 以便可能的栈缩减。 </span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>systemstack</span><span style=color:#111>(</span><span style=color:#00a8c8>func</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>gcMark</span><span style=color:#111>(</span><span style=color:#75af00>startTime</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>})</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>var</span> <span style=color:#75af00>stwSwept</span> <span style=color:#00a8c8>bool</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>systemstack</span><span style=color:#111>(</span><span style=color:#00a8c8>func</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>work</span><span style=color:#111>.</span><span style=color:#75af00>heap2</span> <span style=color:#111>=</span> <span style=color:#75af00>work</span><span style=color:#111>.</span><span style=color:#75af00>bytesMarked</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>debug</span><span style=color:#111>.</span><span style=color:#75af00>gccheckmark</span> <span style=color:#111>&gt;</span> <span style=color:#ae81ff>0</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// Run a full non-parallel, stop-the-world</span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// mark using checkmark bits, to check that we</span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// didn&#39;t forget to mark anything during the</span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// concurrent mark process.</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>startCheckmarks</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>gcResetMarkState</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>gcw</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#75af00>getg</span><span style=color:#111>().</span><span style=color:#75af00>m</span><span style=color:#111>.</span><span style=color:#75af00>p</span><span style=color:#111>.</span><span style=color:#75af00>ptr</span><span style=color:#111>().</span><span style=color:#75af00>gcw</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>gcDrain</span><span style=color:#111>(</span><span style=color:#75af00>gcw</span><span style=color:#111>,</span> <span style=color:#ae81ff>0</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>wbBufFlush1</span><span style=color:#111>(</span><span style=color:#75af00>getg</span><span style=color:#111>().</span><span style=color:#75af00>m</span><span style=color:#111>.</span><span style=color:#75af00>p</span><span style=color:#111>.</span><span style=color:#75af00>ptr</span><span style=color:#111>())</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>gcw</span><span style=color:#111>.</span><span style=color:#75af00>dispose</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>endCheckmarks</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 标记完成，我们可以关闭写屏障。</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>setGCPhase</span><span style=color:#111>(</span><span style=color:#75af00>_GCoff</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 开启清扫</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>stwSwept</span> <span style=color:#111>=</span> <span style=color:#75af00>gcSweep</span><span style=color:#111>(</span><span style=color:#75af00>work</span><span style=color:#111>.</span><span style=color:#75af00>mode</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>})</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>casgstatus</span><span style=color:#111>(</span><span style=color:#75af00>curgp</span><span style=color:#111>,</span> <span style=color:#75af00>_Gwaiting</span><span style=color:#111>,</span> <span style=color:#75af00>_Grunning</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ......</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>systemstack</span><span style=color:#111>(</span><span style=color:#00a8c8>func</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Start The World</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>startTheWorldWithSema</span><span style=color:#111>(</span><span style=color:#75af00>now</span><span style=color:#111>,</span> <span style=color:#75af00>stw</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>})</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 确保所有 mcaches 被清空。每个 P 在分配前将清空自己的 mcache，但空闲的 P 可能不会。</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 由于这对于扫描所有 spans 是必需的，我们需要确保在开始下一个 GC 周期前，所有 mcaches 都已被清空。</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>forEachP</span><span style=color:#111>(</span><span style=color:#75af00>waitReasonFlushProcCaches</span><span style=color:#111>,</span> <span style=color:#00a8c8>func</span><span style=color:#111>(</span><span style=color:#75af00>pp</span> <span style=color:#f92672>*</span><span style=color:#75af00>p</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>pp</span><span style=color:#111>.</span><span style=color:#75af00>mcache</span><span style=color:#111>.</span><span style=color:#75af00>prepareForSweep</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>pp</span><span style=color:#111>.</span><span style=color:#75af00>status</span> <span style=color:#f92672>==</span> <span style=color:#75af00>_Pidle</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>systemstack</span><span style=color:#111>(</span><span style=color:#00a8c8>func</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>				<span style=color:#75af00>lock</span><span style=color:#111>(</span><span style=color:#f92672>&amp;</span><span style=color:#75af00>mheap_</span><span style=color:#111>.</span><span style=color:#75af00>lock</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>				<span style=color:#75af00>pp</span><span style=color:#111>.</span><span style=color:#75af00>pcache</span><span style=color:#111>.</span><span style=color:#75af00>flush</span><span style=color:#111>(</span><span style=color:#f92672>&amp;</span><span style=color:#75af00>mheap_</span><span style=color:#111>.</span><span style=color:#75af00>pages</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>				<span style=color:#75af00>unlock</span><span style=color:#111>(</span><span style=color:#f92672>&amp;</span><span style=color:#75af00>mheap_</span><span style=color:#111>.</span><span style=color:#75af00>lock</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>			<span style=color:#111>})</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>pp</span><span style=color:#111>.</span><span style=color:#75af00>pinnerCache</span> <span style=color:#111>=</span> <span style=color:#00a8c8>nil</span>
</span></span><span style=display:flex><span>	<span style=color:#111>})</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>sl</span><span style=color:#111>.</span><span style=color:#75af00>valid</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// Now that we&#39;ve swept stale spans in mcaches, they don&#39;t</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// count against unswept spans.</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e>		// Note: this sweepLocker may not be valid if sweeping had</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// already completed during the STW. See the corresponding</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// begin() call that produced sl.</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>sweep</span><span style=color:#111>.</span><span style=color:#75af00>active</span><span style=color:#111>.</span><span style=color:#75af00>end</span><span style=color:#111>(</span><span style=color:#75af00>sl</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><h2 id=清扫>清扫</h2><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>gcSweep</span><span style=color:#111>(</span><span style=color:#75af00>mode</span> <span style=color:#75af00>gcMode</span><span style=color:#111>)</span> <span style=color:#00a8c8>bool</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ......</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 并发清扫</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>lock</span><span style=color:#111>(</span><span style=color:#f92672>&amp;</span><span style=color:#75af00>sweep</span><span style=color:#111>.</span><span style=color:#75af00>lock</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>sweep</span><span style=color:#111>.</span><span style=color:#75af00>parked</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>sweep</span><span style=color:#111>.</span><span style=color:#75af00>parked</span> <span style=color:#111>=</span> <span style=color:#00a8c8>false</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>ready</span><span style=color:#111>(</span><span style=color:#75af00>sweep</span><span style=color:#111>.</span><span style=color:#75af00>g</span><span style=color:#111>,</span> <span style=color:#ae81ff>0</span><span style=color:#111>,</span> <span style=color:#00a8c8>true</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>unlock</span><span style=color:#111>(</span><span style=color:#f92672>&amp;</span><span style=color:#75af00>sweep</span><span style=color:#111>.</span><span style=color:#75af00>lock</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>return</span> <span style=color:#00a8c8>false</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><p>sweep.g 的创建</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>var</span> <span style=color:#75af00>sweep</span> <span style=color:#75af00>sweepdata</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>type</span> <span style=color:#75af00>sweepdata</span> <span style=color:#00a8c8>struct</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>g</span>      <span style=color:#f92672>*</span><span style=color:#75af00>g</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 在 runtime main 中调用了gcenable()</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>gcenable</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>c</span> <span style=color:#f92672>:=</span> <span style=color:#111>make</span><span style=color:#111>(</span><span style=color:#00a8c8>chan</span> <span style=color:#00a8c8>int</span><span style=color:#111>,</span> <span style=color:#ae81ff>2</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>go</span> <span style=color:#75af00>bgsweep</span><span style=color:#111>(</span><span style=color:#75af00>c</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>go</span> <span style=color:#75af00>bgscavenge</span><span style=color:#111>(</span><span style=color:#75af00>c</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;-</span><span style=color:#75af00>c</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;-</span><span style=color:#75af00>c</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>memstats</span><span style=color:#111>.</span><span style=color:#75af00>enablegc</span> <span style=color:#111>=</span> <span style=color:#00a8c8>true</span> 
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><h3 id=bgscavenge>bgscavenge</h3><p>从 OS 申请到 _heap 上的内存 不用了 还回去一些</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>bgscavenge</span><span style=color:#111>(</span><span style=color:#75af00>c</span> <span style=color:#00a8c8>chan</span> <span style=color:#00a8c8>int</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>scavenger</span><span style=color:#111>.</span><span style=color:#75af00>init</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>c</span> <span style=color:#f92672>&lt;-</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 等待</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>scavenger</span><span style=color:#111>.</span><span style=color:#75af00>park</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>for</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 执行一次清理 (scavenge) 操作，返回释放的内存量和本次操作的耗时</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>released</span><span style=color:#111>,</span> <span style=color:#75af00>workTime</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>scavenger</span><span style=color:#111>.</span><span style=color:#75af00>run</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 没有释放内存，休眠</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>released</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>scavenger</span><span style=color:#111>.</span><span style=color:#75af00>park</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>continue</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 如果释放了内存，将释放的内存量和耗时记录到统计信息中</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>mheap_</span><span style=color:#111>.</span><span style=color:#75af00>pages</span><span style=color:#111>.</span><span style=color:#75af00>scav</span><span style=color:#111>.</span><span style=color:#75af00>releasedBg</span><span style=color:#111>.</span><span style=color:#75af00>Add</span><span style=color:#111>(</span><span style=color:#75af00>released</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>scavenger</span><span style=color:#111>.</span><span style=color:#75af00>sleep</span><span style=color:#111>(</span><span style=color:#75af00>workTime</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><h4 id=scavengerrun>scavenger.run</h4><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>s</span> <span style=color:#f92672>*</span><span style=color:#75af00>scavengerState</span><span style=color:#111>)</span> <span style=color:#75af00>run</span><span style=color:#111>()</span> <span style=color:#111>(</span><span style=color:#75af00>released</span> <span style=color:#00a8c8>uintptr</span><span style=color:#111>,</span> <span style=color:#75af00>worked</span> <span style=color:#00a8c8>float64</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>for</span> <span style=color:#75af00>worked</span> <span style=color:#111>&lt;</span> <span style=color:#75af00>minScavWorkTime</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 如果需要停止，就停止</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>shouldStop</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>break</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>const</span> <span style=color:#75af00>scavengeQuantum</span> <span style=color:#111>=</span> <span style=color:#ae81ff>64</span> <span style=color:#f92672>&lt;&lt;</span> <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>r</span><span style=color:#111>,</span> <span style=color:#75af00>duration</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>scavenge</span><span style=color:#111>(</span><span style=color:#75af00>scavengeQuantum</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>const</span> <span style=color:#75af00>approxWorkedNSPerPhysicalPage</span> <span style=color:#111>=</span> <span style=color:#ae81ff>10e3</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>duration</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>worked</span> <span style=color:#f92672>+=</span> <span style=color:#75af00>approxWorkedNSPerPhysicalPage</span> <span style=color:#f92672>*</span> <span style=color:#111>float64</span><span style=color:#111>(</span><span style=color:#75af00>r</span><span style=color:#f92672>/</span><span style=color:#75af00>physPageSize</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span> <span style=color:#00a8c8>else</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>worked</span> <span style=color:#f92672>+=</span> <span style=color:#111>float64</span><span style=color:#111>(</span><span style=color:#75af00>duration</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>released</span> <span style=color:#f92672>+=</span> <span style=color:#75af00>r</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>return</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><h4 id=sscavenge>s.scavenge</h4><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>if</span> <span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>scavenge</span> <span style=color:#f92672>==</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>scavenge</span> <span style=color:#111>=</span> <span style=color:#00a8c8>func</span><span style=color:#111>(</span><span style=color:#75af00>n</span> <span style=color:#00a8c8>uintptr</span><span style=color:#111>)</span> <span style=color:#111>(</span><span style=color:#00a8c8>uintptr</span><span style=color:#111>,</span> <span style=color:#00a8c8>int64</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>start</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>nanotime</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>r</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>mheap_</span><span style=color:#111>.</span><span style=color:#75af00>pages</span><span style=color:#111>.</span><span style=color:#75af00>scavenge</span><span style=color:#111>(</span><span style=color:#75af00>n</span><span style=color:#111>,</span> <span style=color:#00a8c8>nil</span><span style=color:#111>,</span> <span style=color:#00a8c8>false</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>end</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>nanotime</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>if</span> <span style=color:#75af00>start</span> <span style=color:#f92672>&gt;=</span> <span style=color:#75af00>end</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>				<span style=color:#00a8c8>return</span> <span style=color:#75af00>r</span><span style=color:#111>,</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>			<span style=color:#111>}</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>scavenge</span><span style=color:#111>.</span><span style=color:#75af00>backgroundTime</span><span style=color:#111>.</span><span style=color:#75af00>Add</span><span style=color:#111>(</span><span style=color:#75af00>end</span> <span style=color:#f92672>-</span> <span style=color:#75af00>start</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>return</span> <span style=color:#75af00>r</span><span style=color:#111>,</span> <span style=color:#75af00>end</span> <span style=color:#f92672>-</span> <span style=color:#75af00>start</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>p</span> <span style=color:#f92672>*</span><span style=color:#75af00>pageAlloc</span><span style=color:#111>)</span> <span style=color:#75af00>scavenge</span><span style=color:#111>(</span><span style=color:#75af00>nbytes</span> <span style=color:#00a8c8>uintptr</span><span style=color:#111>,</span> <span style=color:#75af00>shouldStop</span> <span style=color:#00a8c8>func</span><span style=color:#111>()</span> <span style=color:#00a8c8>bool</span><span style=color:#111>,</span> <span style=color:#75af00>force</span> <span style=color:#00a8c8>bool</span><span style=color:#111>)</span> <span style=color:#00a8c8>uintptr</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>released</span> <span style=color:#f92672>:=</span> <span style=color:#111>uintptr</span><span style=color:#111>(</span><span style=color:#ae81ff>0</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>for</span> <span style=color:#75af00>released</span> <span style=color:#111>&lt;</span> <span style=color:#75af00>nbytes</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>ci</span><span style=color:#111>,</span> <span style=color:#75af00>pageIdx</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>p</span><span style=color:#111>.</span><span style=color:#75af00>scav</span><span style=color:#111>.</span><span style=color:#75af00>index</span><span style=color:#111>.</span><span style=color:#75af00>find</span><span style=color:#111>(</span><span style=color:#75af00>force</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>ci</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>break</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>systemstack</span><span style=color:#111>(</span><span style=color:#00a8c8>func</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>released</span> <span style=color:#f92672>+=</span> <span style=color:#75af00>p</span><span style=color:#111>.</span><span style=color:#75af00>scavengeOne</span><span style=color:#111>(</span><span style=color:#75af00>ci</span><span style=color:#111>,</span> <span style=color:#75af00>pageIdx</span><span style=color:#111>,</span> <span style=color:#75af00>nbytes</span><span style=color:#f92672>-</span><span style=color:#75af00>released</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#111>})</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>shouldStop</span> <span style=color:#f92672>!=</span> <span style=color:#00a8c8>nil</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#75af00>shouldStop</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>break</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>return</span> <span style=color:#75af00>released</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><h4 id=scavengeone>scavengeOne</h4><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>p</span> <span style=color:#f92672>*</span><span style=color:#75af00>pageAlloc</span><span style=color:#111>)</span> <span style=color:#75af00>scavengeOne</span><span style=color:#111>(</span><span style=color:#75af00>ci</span> <span style=color:#75af00>chunkIdx</span><span style=color:#111>,</span> <span style=color:#75af00>searchIdx</span> <span style=color:#00a8c8>uint</span><span style=color:#111>,</span> <span style=color:#75af00>max</span> <span style=color:#00a8c8>uintptr</span><span style=color:#111>)</span> <span style=color:#00a8c8>uintptr</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>maxPages</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>max</span> <span style=color:#f92672>/</span> <span style=color:#75af00>pageSize</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>max</span><span style=color:#f92672>%</span><span style=color:#75af00>pageSize</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>maxPages</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>minPages</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>physPageSize</span> <span style=color:#f92672>/</span> <span style=color:#75af00>pageSize</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>minPages</span> <span style=color:#111>&lt;</span> <span style=color:#ae81ff>1</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>minPages</span> <span style=color:#111>=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>lock</span><span style=color:#111>(</span><span style=color:#75af00>p</span><span style=color:#111>.</span><span style=color:#75af00>mheapLock</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>p</span><span style=color:#111>.</span><span style=color:#75af00>summary</span><span style=color:#111>[</span><span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#75af00>p</span><span style=color:#111>.</span><span style=color:#75af00>summary</span><span style=color:#111>)</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#111>][</span><span style=color:#75af00>ci</span><span style=color:#111>].</span><span style=color:#111>max</span><span style=color:#111>()</span> <span style=color:#f92672>&gt;=</span> <span style=color:#111>uint</span><span style=color:#111>(</span><span style=color:#75af00>minPages</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 找到回收的开始地址 和页数</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>base</span><span style=color:#111>,</span> <span style=color:#75af00>npages</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>p</span><span style=color:#111>.</span><span style=color:#75af00>chunkOf</span><span style=color:#111>(</span><span style=color:#75af00>ci</span><span style=color:#111>).</span><span style=color:#75af00>findScavengeCandidate</span><span style=color:#111>(</span><span style=color:#75af00>searchIdx</span><span style=color:#111>,</span> <span style=color:#75af00>minPages</span><span style=color:#111>,</span> <span style=color:#75af00>maxPages</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// If we found something, scavenge it and return!</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>npages</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// ......</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>unlock</span><span style=color:#111>(</span><span style=color:#75af00>p</span><span style=color:#111>.</span><span style=color:#75af00>mheapLock</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>if</span> <span style=color:#111>!</span><span style=color:#75af00>p</span><span style=color:#111>.</span><span style=color:#75af00>test</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>				<span style=color:#75715e>// 系统调用</span>
</span></span><span style=display:flex><span>				<span style=color:#75af00>sysUnused</span><span style=color:#111>(</span><span style=color:#75af00>unsafe</span><span style=color:#111>.</span><span style=color:#75af00>Pointer</span><span style=color:#111>(</span><span style=color:#75af00>addr</span><span style=color:#111>),</span> <span style=color:#111>uintptr</span><span style=color:#111>(</span><span style=color:#75af00>npages</span><span style=color:#111>)</span><span style=color:#f92672>*</span><span style=color:#75af00>pageSize</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>				<span style=color:#75715e>// ......</span>
</span></span><span style=display:flex><span>			<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// 更新统计信息</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>lock</span><span style=color:#111>(</span><span style=color:#75af00>p</span><span style=color:#111>.</span><span style=color:#75af00>mheapLock</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>if</span> <span style=color:#75af00>b</span> <span style=color:#f92672>:=</span> <span style=color:#111>(</span><span style=color:#75af00>offAddr</span><span style=color:#111>{</span><span style=color:#75af00>addr</span><span style=color:#111>});</span> <span style=color:#75af00>b</span><span style=color:#111>.</span><span style=color:#75af00>lessThan</span><span style=color:#111>(</span><span style=color:#75af00>p</span><span style=color:#111>.</span><span style=color:#75af00>searchAddr</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>				<span style=color:#75af00>p</span><span style=color:#111>.</span><span style=color:#75af00>searchAddr</span> <span style=color:#111>=</span> <span style=color:#75af00>b</span>
</span></span><span style=display:flex><span>			<span style=color:#111>}</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>p</span><span style=color:#111>.</span><span style=color:#75af00>chunkOf</span><span style=color:#111>(</span><span style=color:#75af00>ci</span><span style=color:#111>).</span><span style=color:#75af00>free</span><span style=color:#111>(</span><span style=color:#75af00>base</span><span style=color:#111>,</span> <span style=color:#75af00>npages</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>p</span><span style=color:#111>.</span><span style=color:#75af00>update</span><span style=color:#111>(</span><span style=color:#75af00>addr</span><span style=color:#111>,</span> <span style=color:#111>uintptr</span><span style=color:#111>(</span><span style=color:#75af00>npages</span><span style=color:#111>),</span> <span style=color:#00a8c8>true</span><span style=color:#111>,</span> <span style=color:#00a8c8>false</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// Mark the range as scavenged.</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>p</span><span style=color:#111>.</span><span style=color:#75af00>chunkOf</span><span style=color:#111>(</span><span style=color:#75af00>ci</span><span style=color:#111>).</span><span style=color:#75af00>scavenged</span><span style=color:#111>.</span><span style=color:#75af00>setRange</span><span style=color:#111>(</span><span style=color:#75af00>base</span><span style=color:#111>,</span> <span style=color:#75af00>npages</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>unlock</span><span style=color:#111>(</span><span style=color:#75af00>p</span><span style=color:#111>.</span><span style=color:#75af00>mheapLock</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>return</span> <span style=color:#111>uintptr</span><span style=color:#111>(</span><span style=color:#75af00>npages</span><span style=color:#111>)</span> <span style=color:#f92672>*</span> <span style=color:#75af00>pageSize</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>p</span><span style=color:#111>.</span><span style=color:#75af00>scav</span><span style=color:#111>.</span><span style=color:#75af00>index</span><span style=color:#111>.</span><span style=color:#75af00>setEmpty</span><span style=color:#111>(</span><span style=color:#75af00>ci</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>unlock</span><span style=color:#111>(</span><span style=color:#75af00>p</span><span style=color:#111>.</span><span style=color:#75af00>mheapLock</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>return</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><h3 id=bgsweep>bgsweep</h3><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>bgsweep</span><span style=color:#111>(</span><span style=color:#75af00>c</span> <span style=color:#00a8c8>chan</span> <span style=color:#00a8c8>int</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>sweep</span><span style=color:#111>.</span><span style=color:#75af00>g</span> <span style=color:#111>=</span> <span style=color:#75af00>getg</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>lockInit</span><span style=color:#111>(</span><span style=color:#f92672>&amp;</span><span style=color:#75af00>sweep</span><span style=color:#111>.</span><span style=color:#75af00>lock</span><span style=color:#111>,</span> <span style=color:#75af00>lockRankSweep</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>lock</span><span style=color:#111>(</span><span style=color:#f92672>&amp;</span><span style=color:#75af00>sweep</span><span style=color:#111>.</span><span style=color:#75af00>lock</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>sweep</span><span style=color:#111>.</span><span style=color:#75af00>parked</span> <span style=color:#111>=</span> <span style=color:#00a8c8>true</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>c</span> <span style=color:#f92672>&lt;-</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 休眠 等待gc 完成 唤醒它</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>goparkunlock</span><span style=color:#111>(</span><span style=color:#f92672>&amp;</span><span style=color:#75af00>sweep</span><span style=color:#111>.</span><span style=color:#75af00>lock</span><span style=color:#111>,</span> <span style=color:#75af00>waitReasonGCSweepWait</span><span style=color:#111>,</span> <span style=color:#75af00>traceBlockGCSweep</span><span style=color:#111>,</span> <span style=color:#ae81ff>1</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>for</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 执行一次清扫操作</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>for</span> <span style=color:#75af00>sweepone</span><span style=color:#111>()</span> <span style=color:#f92672>!=</span> <span style=color:#111>^</span><span style=color:#111>uintptr</span><span style=color:#111>(</span><span style=color:#ae81ff>0</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>nSwept</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// 每清扫一定数量对象，就尝试让出 CPU</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>if</span> <span style=color:#75af00>nSwept</span><span style=color:#f92672>%</span><span style=color:#75af00>sweepBatchSize</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>				<span style=color:#75af00>goschedIfBusy</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>			<span style=color:#111>}</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 释放一些写缓冲区</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>for</span> <span style=color:#75af00>freeSomeWbufs</span><span style=color:#111>(</span><span style=color:#00a8c8>true</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>goschedIfBusy</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>lock</span><span style=color:#111>(</span><span style=color:#f92672>&amp;</span><span style=color:#75af00>sweep</span><span style=color:#111>.</span><span style=color:#75af00>lock</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 检查是否完成了所有扫描任务。</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#111>!</span><span style=color:#75af00>isSweepDone</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>unlock</span><span style=color:#111>(</span><span style=color:#f92672>&amp;</span><span style=color:#75af00>sweep</span><span style=color:#111>.</span><span style=color:#75af00>lock</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>continue</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>sweep</span><span style=color:#111>.</span><span style=color:#75af00>parked</span> <span style=color:#111>=</span> <span style=color:#00a8c8>true</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 休眠 等待下一次 gc 标记完成唤醒它</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>goparkunlock</span><span style=color:#111>(</span><span style=color:#f92672>&amp;</span><span style=color:#75af00>sweep</span><span style=color:#111>.</span><span style=color:#75af00>lock</span><span style=color:#111>,</span> <span style=color:#75af00>waitReasonGCSweepWait</span><span style=color:#111>,</span> <span style=color:#75af00>traceBlockGCSweep</span><span style=color:#111>,</span> <span style=color:#ae81ff>1</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><h4 id=sweepone>sweepone</h4><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>sweepone</span><span style=color:#111>()</span> <span style=color:#00a8c8>uintptr</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>gp</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>getg</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>gp</span><span style=color:#111>.</span><span style=color:#75af00>m</span><span style=color:#111>.</span><span style=color:#75af00>locks</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>sl</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>sweep</span><span style=color:#111>.</span><span style=color:#75af00>active</span><span style=color:#111>.</span><span style=color:#75af00>begin</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#111>!</span><span style=color:#75af00>sl</span><span style=color:#111>.</span><span style=color:#75af00>valid</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>gp</span><span style=color:#111>.</span><span style=color:#75af00>m</span><span style=color:#111>.</span><span style=color:#75af00>locks</span><span style=color:#f92672>--</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>return</span> <span style=color:#111>^</span><span style=color:#111>uintptr</span><span style=color:#111>(</span><span style=color:#ae81ff>0</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Find a span to sweep.</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>npages</span> <span style=color:#f92672>:=</span> <span style=color:#111>^</span><span style=color:#111>uintptr</span><span style=color:#111>(</span><span style=color:#ae81ff>0</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>var</span> <span style=color:#75af00>noMoreWork</span> <span style=color:#00a8c8>bool</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>for</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 查找 span</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>s</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>mheap_</span><span style=color:#111>.</span><span style=color:#75af00>nextSpanForSweep</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>s</span> <span style=color:#f92672>==</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>noMoreWork</span> <span style=color:#111>=</span> <span style=color:#75af00>sweep</span><span style=color:#111>.</span><span style=color:#75af00>active</span><span style=color:#111>.</span><span style=color:#75af00>markDrained</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>break</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 试着清扫</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>s</span><span style=color:#111>,</span> <span style=color:#75af00>ok</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>sl</span><span style=color:#111>.</span><span style=color:#75af00>tryAcquire</span><span style=color:#111>(</span><span style=color:#75af00>s</span><span style=color:#111>);</span> <span style=color:#75af00>ok</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// Sweep the span we found.</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>npages</span> <span style=color:#111>=</span> <span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>npages</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>if</span> <span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>sweep</span><span style=color:#111>(</span><span style=color:#00a8c8>false</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>				<span style=color:#75af00>mheap_</span><span style=color:#111>.</span><span style=color:#75af00>reclaimCredit</span><span style=color:#111>.</span><span style=color:#75af00>Add</span><span style=color:#111>(</span><span style=color:#75af00>npages</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>			<span style=color:#111>}</span> <span style=color:#00a8c8>else</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>				<span style=color:#75af00>npages</span> <span style=color:#111>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>			<span style=color:#111>}</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>break</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>sweep</span><span style=color:#111>.</span><span style=color:#75af00>active</span><span style=color:#111>.</span><span style=color:#75af00>end</span><span style=color:#111>(</span><span style=color:#75af00>sl</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ......</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>gp</span><span style=color:#111>.</span><span style=color:#75af00>m</span><span style=color:#111>.</span><span style=color:#75af00>locks</span><span style=color:#f92672>--</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>return</span> <span style=color:#75af00>npages</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><p>sweep 主要逻辑是把 刚刚标记过的 gcmarkBits 复制给 allocBits</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>sl</span> <span style=color:#f92672>*</span><span style=color:#75af00>sweepLocked</span><span style=color:#111>)</span> <span style=color:#75af00>sweep</span><span style=color:#111>(</span><span style=color:#75af00>preserve</span> <span style=color:#00a8c8>bool</span><span style=color:#111>)</span> <span style=color:#00a8c8>bool</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ......</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>allocBits</span> <span style=color:#111>=</span> <span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>gcmarkBits</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>gcmarkBits</span> <span style=color:#111>=</span> <span style=color:#75af00>newMarkBits</span><span style=color:#111>(</span><span style=color:#111>uintptr</span><span style=color:#111>(</span><span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>nelems</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ......</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><h4 id=分配内存>分配内存</h4><p>如果我们的 span 标记之后 还没来得及清扫，修改了 allocBits 值，然后再清扫会出问题。go 是怎么解决的呢？</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// 拿 span 的时候会检查 如果没清扫就先清扫一下 再使用内存</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>c</span> <span style=color:#f92672>*</span><span style=color:#75af00>mcentral</span><span style=color:#111>)</span> <span style=color:#75af00>cacheSpan</span><span style=color:#111>()</span> <span style=color:#f92672>*</span><span style=color:#75af00>mspan</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ......</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>s</span><span style=color:#111>,</span> <span style=color:#75af00>ok</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>sl</span><span style=color:#111>.</span><span style=color:#75af00>tryAcquire</span><span style=color:#111>(</span><span style=color:#75af00>s</span><span style=color:#111>);</span> <span style=color:#75af00>ok</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// We got ownership of the span, so let&#39;s sweep it.</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>sweep</span><span style=color:#111>(</span><span style=color:#00a8c8>true</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ......</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>h</span> <span style=color:#f92672>*</span><span style=color:#75af00>mheap</span><span style=color:#111>)</span> <span style=color:#75af00>alloc</span><span style=color:#111>(</span><span style=color:#75af00>npages</span> <span style=color:#00a8c8>uintptr</span><span style=color:#111>,</span> <span style=color:#75af00>spanclass</span> <span style=color:#75af00>spanClass</span><span style=color:#111>)</span> <span style=color:#f92672>*</span><span style=color:#75af00>mspan</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>var</span> <span style=color:#75af00>s</span> <span style=color:#f92672>*</span><span style=color:#75af00>mspan</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>systemstack</span><span style=color:#111>(</span><span style=color:#00a8c8>func</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#111>!</span><span style=color:#75af00>isSweepDone</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75af00>h</span><span style=color:#111>.</span><span style=color:#75af00>reclaim</span><span style=color:#111>(</span><span style=color:#75af00>npages</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>s</span> <span style=color:#111>=</span> <span style=color:#75af00>h</span><span style=color:#111>.</span><span style=color:#75af00>allocSpan</span><span style=color:#111>(</span><span style=color:#75af00>npages</span><span style=color:#111>,</span> <span style=color:#75af00>spanAllocHeap</span><span style=color:#111>,</span> <span style=color:#75af00>spanclass</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>})</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>return</span> <span style=color:#75af00>s</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>h</span> <span style=color:#f92672>*</span><span style=color:#75af00>mheap</span><span style=color:#111>)</span> <span style=color:#75af00>reclaim</span><span style=color:#111>(</span><span style=color:#75af00>npage</span> <span style=color:#00a8c8>uintptr</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ......</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>nfound</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>h</span><span style=color:#111>.</span><span style=color:#75af00>reclaimChunk</span><span style=color:#111>(</span><span style=color:#75af00>arenas</span><span style=color:#111>,</span> <span style=color:#75af00>idx</span><span style=color:#111>,</span> <span style=color:#75af00>pagesPerReclaimerChunk</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ......</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>h</span> <span style=color:#f92672>*</span><span style=color:#75af00>mheap</span><span style=color:#111>)</span> <span style=color:#75af00>reclaimChunk</span><span style=color:#111>(</span><span style=color:#75af00>arenas</span> <span style=color:#111>[]</span><span style=color:#f92672>*</span><span style=color:#75af00>pageAlloc</span><span style=color:#111>,</span> <span style=color:#75af00>idx</span><span style=color:#111>,</span> <span style=color:#75af00>npages</span> <span style=color:#00a8c8>uintptr</span><span style=color:#111>)</span> <span style=color:#00a8c8>uintptr</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ......</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>s</span><span style=color:#111>.</span><span style=color:#75af00>sweep</span><span style=color:#111>(</span><span style=color:#00a8c8>false</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ......</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div></div><footer class=post-footer><div class=post-license><p><strong>Article Title:</strong> Go 垃圾回收原理</p><p><strong>Author:</strong> daemon365</p><p><strong>Permalink:</strong> <a href=https://daemon365.dev/post/go/go_gc_code/>https://daemon365.dev/post/go/go_gc_code/</a></p><p><strong>License:</strong> This article is licensed under
<a href=https://creativecommons.org/licenses/by-nc-sa/4.0/ target=_blank rel=noopener>BY-NC-SA</a>. Please cite the source when reposting.</p></div><nav class=post-navigation><a href=/post/go/go_memory_code/ class=nav-prev><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg><div><span class=nav-label>Previous</span>
<span class=nav-title>go 内存管理</span></div></a><a href=/post/go/go_channel_code/ class=nav-next><div><span class=nav-label>Next</span>
<span class=nav-title>Go channel 原理</span></div><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg></a></nav><div class=post-comments><script src=https://utteranc.es/client.js repo=daemon365/blog issue-term=pathname label=comments theme=preferred-color-scheme crossorigin=anonymous async></script></div></footer></article></div></div><div class=toc-float-button id=tocButton><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5.0 016.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5.0 014 19.5v-15A2.5 2.5.0 016.5 2z"/></svg></div><div class=toc-panel id=tocPanel><div class=toc-panel-header><h3 class=toc-panel-title>Table of Contents</h3><button class=toc-panel-close id=tocClose>
<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div><nav class=toc-panel-nav id=TableOfContents><nav id=TableOfContents><ul><li><a href=#介绍>介绍</a></li><li><a href=#触发条件>触发条件</a></li><li><a href=#定时触发>定时触发</a><ul><li><a href=#test>test</a></li></ul></li><li><a href=#heap-增长触发>Heap 增长触发</a></li><li><a href=#主动触发>主动触发</a></li><li><a href=#gcstart>gcStart</a><ul><li><a href=#gcbgmarkstartworkers>gcBgMarkStartWorkers</a></li><li><a href=#stoptheworldwithsema>stopTheWorldWithSema</a></li><li><a href=#startcycle>startCycle</a></li><li><a href=#setgcphase>setGCPhase</a></li><li><a href=#gcmarktinyallocs>gcMarkTinyAllocs</a></li><li><a href=#starttheworldwithsema>startTheWorldWithSema</a></li></ul></li><li><a href=#worker-标记>worker 标记</a></li><li><a href=#gcdrain>gcDrain</a><ul><li><a href=#scanobject>scanobject</a></li></ul></li><li><a href=#用户-goroutine-清扫>用户 goroutine 清扫</a></li><li><a href=#终止标记-gcmarkdone>终止标记 gcMarkDone</a><ul><li><a href=#gcmarktermination>gcMarkTermination</a></li></ul></li><li><a href=#清扫>清扫</a><ul><li><a href=#bgscavenge>bgscavenge</a><ul><li><a href=#scavengerrun>scavenger.run</a></li><li><a href=#sscavenge>s.scavenge</a></li><li><a href=#scavengeone>scavengeOne</a></li></ul></li><li><a href=#bgsweep>bgsweep</a><ul><li><a href=#sweepone>sweepone</a></li><li><a href=#分配内存>分配内存</a></li></ul></li></ul></li></ul></nav></nav></div></main><footer class=site-footer><div class=container><div class=footer-content><div class=footer-info><p class=copyright>© 2026 daemon365</p><p class=powered-by>由 <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> 和 <a href=https://github.com/daemon365/hugo-theme-daemon target=_blank rel=noopener>Daemon</a> 驱动</p></div><div class=social-links><a href=https://github.com/daemon365 target=_blank rel=noopener aria-label=GitHub><svg class="icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0C5.374.0.0 5.373.0 12c0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931.0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176.0.0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221.0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576C20.566 21.797 24 17.3 24 12c0-6.627-5.373-12-12-12z"/></svg>
</a><a href=mailto:daemon365@foxmail.com aria-label=Email><svg class="icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></a></div></div></div></footer><div class=search-modal id=searchModal><div class=search-modal-backdrop></div><div class=search-modal-content><div class=search-modal-header><input type=text class=search-input id=searchInput placeholder=搜索文章... autofocus>
<button class=search-close aria-label="Close search">
<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div><div class=search-results id=searchResults><p class=search-hint>输入 2 个或更多字符开始搜索</p></div></div></div><script src=/js/components/search.js></script><script src=/js/components/toc.js></script><script src=/js/components/scroll-effects.js></script><script src=/js/components/code-copy.js></script><script src=/js/components/lazy-loading.js></script><script src=/js/components/image-preview.js></script><script src=/js/components/back-to-top.js></script><script src=/js/main-new.js></script><script>"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("/sw.js").then(e=>{console.log("Service Worker registered:",e.scope)}).catch(e=>{console.log("Service Worker registration failed:",e)})})</script></body></html>