<!doctype html><html lang=zh-CN data-theme=light><head><meta charset=UTF-8><meta name=viewport content="width=device-width"><meta name=theme-color content="#222" media="(prefers-color-scheme: light)"><meta name=generator content="Hugo 0.140.1"><link rel="shortcut icon" type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/png sizes=16x16 href=/imgs/icons/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/imgs/icons/favicon.ico><link rel=apple-touch-icon sizes=180x180 href=/imgs/icons/favicon.ico><meta itemprop=name content="Go 垃圾回收原理"><meta itemprop=description content="Don't let yourself stop."><meta name=description content="Don't let yourself stop."><meta itemprop=datePublished zgotmplz><meta itemprop=dateModified zgotmplz><meta itemprop=image content="https://daemon365.dev/imgs/daemon365.png"><meta itemprop=keywords content="go"><meta property="og:type" content="article"><meta property="og:title" content="Go 垃圾回收原理"><meta property="og:description" content="Don't let yourself stop."><meta property="og:image" content="/imgs/daemon365.png"><meta property="og:image:width" content="312"><meta property="og:image:height" content="312"><meta property="og:image:type" content="image/jpeg/png/svg/jpg"><meta property="og:url" content="https://daemon365.dev/post/go/go_gc_code/"><meta property="og:site_name" content="Daemon"><meta property="og:locale" content="zh-CN"><meta property="article:author" content="daemon365"><meta property="article:published_time" content="2024-12-17 11:06:10 +0800 +0800"><meta property="article:modified_time" content="2024-12-17 11:06:10 +0800 +0800"><link type=text/css rel=stylesheet href=https://daemon365.dev/3rd/font-awesome/6.6.0/css/all.min.css><link type=text/css rel=stylesheet href=https://daemon365.dev/3rd/animate.css/4.1.1/animate.min.css><link type=text/css rel=stylesheet href=https://daemon365.dev/3rd/viewerjs/1.11.6/viewer.min.css><link rel=stylesheet href=/css/main.min.5ec1f63635756d664e619fe2d87a11c7394f519beff240c124743433c9861792.css><script type=text/javascript>(function(){localDB={set:function(e,t,n){if(n===0)return;const s=new Date,o=n*864e5,i={value:t,expiry:s.getTime()+o};localStorage.setItem(e,JSON.stringify(i))},get:function(e){const t=localStorage.getItem(e);if(!t)return void 0;const n=JSON.parse(t),s=new Date;return s.getTime()>n.expiry?(localStorage.removeItem(e),void 0):n.value}},theme={active:function(){const e=localDB.get("theme");if(e==null)return;theme.toggle(e),window.matchMedia("(prefers-color-scheme: dark)").addListener(function(e){theme.toggle(e.matches?"dark":"light")})},toggle:function(e){document.documentElement.setAttribute("data-theme",e),localDB.set("theme",e,2);const t=document.querySelector("iframe.giscus-frame");if(t){const n={setConfig:{theme:e}};t.contentWindow.postMessage({giscus:n},"https://giscus.app")}}},theme.active()})(window)</script><script class=next-config data-name=page type=application/json>{"comments":true,"isHome":false,"isPage":true,"path":"go_gc_code","permalink":"https://daemon365.dev/post/go/go_gc_code/","title":"Go 垃圾回收原理","waline":{"js":[{"alias":"@waline/client","alias_name":"waline","file":"dist/pageview.js","name":"pageview","version":"2.15.8"},{"alias":"@waline/client","alias_name":"waline","file":"dist/comment.js","name":"comment","version":"2.15.8"}]}}</script><script type=text/javascript>document.addEventListener("DOMContentLoaded",()=>{var e=document.createElement("script");e.charset="UTF-8",e.id="LA_COLLECT",e.src="https://sdk.51.la/js-sdk-pro.min.js",e.async="true",e.onload=function(){LA.init({id:"JmAHxEAUVgyS8B1c",ck:"JmAHxEAUVgyS8B1c",autoTrack:!0})},document.head.appendChild(e)})</script><script type=text/javascript>document.addEventListener("DOMContentLoaded",()=>{var e=document.createElement("script");e.charset="UTF-8",e.src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js",e.async=!1,e.defer=!0,document.head.appendChild(e),e.onload=function(){NexT.utils.fmtBusuanzi()}})</script><title>Go 垃圾回收原理 - Daemon</title><noscript><link rel=stylesheet href=/css/noscript.css></noscript></head><body itemscope itemtype=http://schema.org/WebPage><div class=headband></div><main class=main><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-brand-container><div class=site-nav-toggle><div class=toggle aria-label role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div></div><div class=site-meta><a href=/ class=brand rel=start><i class=logo-line></i><h1 class=site-title>Daemon</h1><i class=logo-line></i></a><p class=site-subtitle itemprop=description>Don't let yourself stop.</p></div><div class=site-nav-right><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class=site-nav><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href=/ class=hvr-icon-pulse rel=section><i class="fa fa-home hvr-icon"></i>Home</a></li><li class="menu-item menu-item-about"><a href=/about/ class=hvr-icon-pulse rel=section><i class="fa fa-user hvr-icon"></i>About</a></li><li class="menu-item menu-item-archives"><a href=/archives/ class=hvr-icon-pulse rel=section><i class="fa fa-archive hvr-icon"></i>Archives</a></li><li class="menu-item menu-item-commonweal"><a href=/404.html class=hvr-icon-pulse rel=section><i class="fa fa-heartbeat hvr-icon"></i>Commonweal</a></li><li class="menu-item menu-item-search"><a role=button class="popup-trigger hvr-icon-pulse"><i class="fa fa-search fa-fw hvr-icon"></i>搜索</a></li></ul></nav><div class=search-pop-overlay><div class="popup search-popup"><div class=search-header><span class=search-icon><i class="fa fa-search"></i></span><div class=search-input-container><input autocomplete=off autocapitalize=off maxlength=80 placeholder=搜索... spellcheck=false type=search class=search-input></div><span class=popup-btn-close role=button><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class=search-result-icon><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></div><div class="toggle sidebar-toggle" role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div><aside class=sidebar><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class=sidebar-nav><li class=sidebar-nav-toc>文章目录</li><li class=sidebar-nav-overview>站点概览</li></ul><div class=sidebar-panel-container><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><nav id=TableOfContents><ul><li><a href=#介绍>介绍</a></li><li><a href=#触发条件>触发条件</a></li><li><a href=#定时触发>定时触发</a><ul><li><a href=#test>test</a></li></ul></li><li><a href=#heap-增长触发>Heap 增长触发</a></li><li><a href=#主动触发>主动触发</a></li><li><a href=#gcstart>gcStart</a><ul><li><a href=#gcbgmarkstartworkers>gcBgMarkStartWorkers</a></li><li><a href=#stoptheworldwithsema>stopTheWorldWithSema</a></li><li><a href=#startcycle>startCycle</a></li><li><a href=#setgcphase>setGCPhase</a></li><li><a href=#gcmarktinyallocs>gcMarkTinyAllocs</a></li><li><a href=#starttheworldwithsema>startTheWorldWithSema</a></li></ul></li><li><a href=#worker-标记>worker 标记</a></li><li><a href=#gcdrain>gcDrain</a><ul><li><a href=#scanobject>scanobject</a></li></ul></li><li><a href=#用户-goroutine-清扫>用户 goroutine 清扫</a></li><li><a href=#终止标记-gcmarkdone>终止标记 gcMarkDone</a><ul><li><a href=#gcmarktermination>gcMarkTermination</a></li></ul></li><li><a href=#清扫>清扫</a><ul><li><a href=#bgscavenge>bgscavenge</a><ul><li><a href=#scavengerrun>scavenger.run</a></li><li><a href=#sscavenge>s.scavenge</a></li><li><a href=#scavengeone>scavengeOne</a></li></ul></li><li><a href=#bgsweep>bgsweep</a><ul><li><a href=#sweepone>sweepone</a></li><li><a href=#分配内存>分配内存</a></li></ul></li></ul></li></ul></nav></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image alt=daemon365 src=/imgs/img-lazy-loading.gif data-src=/imgs/daemon365.png><p class=site-author-name itemprop=name>daemon365</p><div class=site-description itemprop=description>Don't let yourself stop.</div></div><div class="site-state-wrap site-overview-item animated"><nav class=site-state><div class="site-state-item site-state-posts"><a href=/archives/><span class=site-state-item-count>97</span>
<span class=site-state-item-name>日志</span></a></div><div class="site-state-item site-state-categories"><a href=/categories/><span class=site-state-item-count>7</span>
<span class=site-state-item-name>分类</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/><span class=site-state-item-count>52</span>
<span class=site-state-item-name>标签</span></a></div></nav></div><div class="links-of-social site-overview-item animated"><span class=links-of-social-item><a href=https://github.com/daemon365 title="Github → https://github.com/daemon365" rel=noopener target=_blank><i class="fab fa-github fa-fw"></i>
Github</a></span></div><div class="cc-license animated" itemprop=license><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh class=cc-opacity rel=noopener target=_blank title=共享知识><img src=/imgs/img-lazy-loading.gif data-src=/imgs/cc/big/by_nc_sa.svg alt=共享知识></a></div><div class="links-of-blogroll site-overview-item animated"><div class=links-of-blogroll-title><i class="fa fa-globe fa-fw"></i>
友情链接</div><ul class=links-of-blogroll-list><li class=links-of-blogroll-item><a href=https://go-kratos.dev title=https://go-kratos.dev target=_blank>kratos</a></li></ul></div></div></div></div></aside><div class=sidebar-dimmer></div></header><div class=tool-buttons><div id=goto-comments class="button goto-comments" title=直达评论><i class="fas fa-comments"></i></div><div id=toggle-theme class=button title=深浅模式切换><i class="fas fa-adjust"></i></div><div class=back-to-top role=button title=返回顶部><i class="fa fa-arrow-up"></i>
<span>0%</span></div></div><div class=reading-progress-bar></div><script type=text/javascript src=//sidecar.gitter.im/dist/sidecar.v1.js async></script><script type=text/javascript>((window.gitter={}).chat={}).options={room:"hugo-next/community"}</script><noscript><div class=noscript-warning>Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class=post-block><article itemscope itemtype=http://schema.org/Article class=post-content lang><link itemprop=mainEntityOfPage href=https://daemon365.dev/post/go/go_gc_code/><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content="/imgs/daemon365.png"><meta itemprop=name content="daemon365"></span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="daemon365"><meta itemprop=description content="Don't let yourself stop."></span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork><meta itemprop=name content="Go 垃圾回收原理"><meta itemprop=description content="*** Go 代码基于 v1.23.0 ***
介绍




    golang GC 垃圾回收机制
    
    
    


触发条件


用户调用 runtime.GC 主动触发
Go 程序检测到距上次 GC 内存分配增长超过一定比例时（默认 100%）触发
定时触发 （默认 2 min）

定时触发

代码在 src/runtime/proc.go 中"></span><header class=post-header><h1 class=post-title itemprop="name headline">Go 垃圾回收原理</h1><div class=post-meta-container><div class=post-meta-items><span class=post-meta-item><span class=post-meta-item-icon><i class="fas fa-solid fa-calendar"></i>
</span><span class=post-meta-item-text title=发表于>发表于：
</span><time title="创建时间：2024-12-17 11:06:10 +0800 +0800" itemprop="dateCreated datePublished" datetime="2024-12-17 11:06:10 +0800 +0800">2024-12-17
</time></span><span class=post-meta-item><span class=post-meta-item-icon><i class="fas fa-solid fa-folder-open"></i>
</span><span class=post-meta-item-text title=分类于>分类于：
</span><span itemprop=about itemscope itemtype=http://schema.org/Thing><a href=/categories/go itemprop=url rel=index><span itemprop=name>go</span></a></span></span></div><div class=post-meta-items><span class=post-meta-item title=字数><span class=post-meta-item-icon><i class="fas fa-solid fa-file-word"></i>
</span><span class=post-meta-item-text>字数：</span>
<span>4025</span>
</span><span class=post-meta-item title=阅读><span class=post-meta-item-icon><i class="fas fa-solid fa-clock"></i>
</span><span class=post-meta-item-text>阅读：&ap;</span>
<span>9分钟</span>
</span><span class=post-meta-item title=浏览><span class=post-meta-item-icon><i class="fas fa-solid fa-eye"></i>
</span><span class=post-meta-item-text>浏览：
</span><span id=busuanzi_value_page_pv data-path=/post/go/go_gc_code/><i class="fa fa-sync fa-spin"></i></span></span></div></div></header><div class=post-body itemprop=articleBody><p>*** Go 代码基于 v1.23.0 ***</p><h2 id=介绍>介绍
<a class=header-anchor href=#%e4%bb%8b%e7%bb%8d></a></h2><ul><li><a href=https://daemon365.dev/post/go/golang_gc_garbage_collection_mechanism/ title="golang GC 垃圾回收机制" rel="noopener external nofollow noreferrer" target=_blank class=exturl>golang GC 垃圾回收机制
<i class="fa fa-external-link-alt"></i></a></li></ul><h2 id=触发条件>触发条件
<a class=header-anchor href=#%e8%a7%a6%e5%8f%91%e6%9d%a1%e4%bb%b6></a></h2><ol><li>用户调用 <code>runtime.GC</code> 主动触发</li><li>Go 程序检测到距上次 GC 内存分配增长超过一定比例时（默认 100%）触发</li><li>定时触发 （默认 2 min）</li></ol><h2 id=定时触发>定时触发
<a class=header-anchor href=#%e5%ae%9a%e6%97%b6%e8%a7%a6%e5%8f%91></a></h2><p>代码在 <code>src/runtime/proc.go</code> 中</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>init</span>() {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>go</span> <span style=color:#a6e22e>forcegchelper</span>()
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>forcegchelper</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>forcegc</span>.<span style=color:#a6e22e>g</span> = <span style=color:#a6e22e>getg</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>lockInit</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>forcegc</span>.<span style=color:#a6e22e>lock</span>, <span style=color:#a6e22e>lockRankForcegc</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>lock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>forcegc</span>.<span style=color:#a6e22e>lock</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>forcegc</span>.<span style=color:#a6e22e>idle</span>.<span style=color:#a6e22e>Load</span>() {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>throw</span>(<span style=color:#e6db74>&#34;forcegc: phase error&#34;</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>forcegc</span>.<span style=color:#a6e22e>idle</span>.<span style=color:#a6e22e>Store</span>(<span style=color:#66d9ef>true</span>)
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 阻塞住 goroutine 当有人解开时 开启 gc
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>goparkunlock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>forcegc</span>.<span style=color:#a6e22e>lock</span>, <span style=color:#a6e22e>waitReasonForceGCIdle</span>, <span style=color:#a6e22e>traceBlockSystemGoroutine</span>, <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>		<span style=color:#75715e>// this goroutine is explicitly resumed by sysmon
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>debug</span>.<span style=color:#a6e22e>gctrace</span> &gt; <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>			println(<span style=color:#e6db74>&#34;GC forced&#34;</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#75715e>// goroutine 被唤醒了，调用 gcStart 开启 gc
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>gcStart</span>(<span style=color:#a6e22e>gcTrigger</span>{<span style=color:#a6e22e>kind</span>: <span style=color:#a6e22e>gcTriggerTime</span>, <span style=color:#a6e22e>now</span>: <span style=color:#a6e22e>nanotime</span>()})
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>那么唤醒 goroutine 的逻辑代码在哪里呢？在 <code>sysmon</code> 物理线程中</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>sysmon</span>() {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ......
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// ......
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 使用 test 方法判断是否需要触发 gc
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>t</span> <span style=color:#f92672>:=</span> (<span style=color:#a6e22e>gcTrigger</span>{<span style=color:#a6e22e>kind</span>: <span style=color:#a6e22e>gcTriggerTime</span>, <span style=color:#a6e22e>now</span>: <span style=color:#a6e22e>now</span>}); <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>test</span>() <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>forcegc</span>.<span style=color:#a6e22e>idle</span>.<span style=color:#a6e22e>Load</span>() {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>lock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>forcegc</span>.<span style=color:#a6e22e>lock</span>)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>forcegc</span>.<span style=color:#a6e22e>idle</span>.<span style=color:#a6e22e>Store</span>(<span style=color:#66d9ef>false</span>)
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 需要 gc 时，把 g 放入 list 中 并使用 injectglist 执行唤醒操作
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>list</span> <span style=color:#a6e22e>gList</span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>list</span>.<span style=color:#a6e22e>push</span>(<span style=color:#a6e22e>forcegc</span>.<span style=color:#a6e22e>g</span>)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>injectglist</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>list</span>)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>unlock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>forcegc</span>.<span style=color:#a6e22e>lock</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>        <span style=color:#75715e>// ......
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>injectglist</span>(<span style=color:#a6e22e>glist</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>gList</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ......
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 启动指定数量的空闲M
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>startIdle</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>n</span> <span style=color:#66d9ef>int</span>) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> &lt; <span style=color:#a6e22e>n</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>mp</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>acquirem</span>() <span style=color:#75715e>// See comment in startm.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#a6e22e>lock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>sched</span>.<span style=color:#a6e22e>lock</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>pp</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>pidlegetSpinning</span>(<span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>pp</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>unlock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>sched</span>.<span style=color:#a6e22e>lock</span>)
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>releasem</span>(<span style=color:#a6e22e>mp</span>)
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>startm</span>(<span style=color:#a6e22e>pp</span>, <span style=color:#66d9ef>false</span>, <span style=color:#66d9ef>true</span>)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>unlock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>sched</span>.<span style=color:#a6e22e>lock</span>)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>releasem</span>(<span style=color:#a6e22e>mp</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>pp</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>getg</span>().<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>ptr</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>pp</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 没有 P 的情况下，直接把 glist 放入全局队列 并启动一些空闲M
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>lock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>sched</span>.<span style=color:#a6e22e>lock</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>globrunqputbatch</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>q</span>, int32(<span style=color:#a6e22e>qsize</span>))
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>unlock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>sched</span>.<span style=color:#a6e22e>lock</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>startIdle</span>(<span style=color:#a6e22e>qsize</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 逐个将G放入全局队列，并启动相应的M
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>npidle</span> <span style=color:#f92672>:=</span> int(<span style=color:#a6e22e>sched</span>.<span style=color:#a6e22e>npidle</span>.<span style=color:#a6e22e>Load</span>())
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> (
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>globq</span> <span style=color:#a6e22e>gQueue</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>n</span>     <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>	)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>n</span> = <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>n</span> &lt; <span style=color:#a6e22e>npidle</span> <span style=color:#f92672>&amp;&amp;</span> !<span style=color:#a6e22e>q</span>.<span style=color:#a6e22e>empty</span>(); <span style=color:#a6e22e>n</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>g</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>q</span>.<span style=color:#a6e22e>pop</span>()
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>globq</span>.<span style=color:#a6e22e>pushBack</span>(<span style=color:#a6e22e>g</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>n</span> &gt; <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>lock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>sched</span>.<span style=color:#a6e22e>lock</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>globrunqputbatch</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>globq</span>, int32(<span style=color:#a6e22e>n</span>))
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>unlock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>sched</span>.<span style=color:#a6e22e>lock</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>startIdle</span>(<span style=color:#a6e22e>n</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>qsize</span> <span style=color:#f92672>-=</span> <span style=color:#a6e22e>n</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 将剩余的G放入当前P的本地队列。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>q</span>.<span style=color:#a6e22e>empty</span>() {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>runqputbatch</span>(<span style=color:#a6e22e>pp</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>q</span>, <span style=color:#a6e22e>qsize</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 唤醒一个P，以防在添加G到队列后有P变为空闲状态。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>wakep</span>()
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=test>test
<a class=header-anchor href=#test></a></h3><ul><li>根据 gcTrigger 的类型检测是否应该触发垃圾收集。</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>gcTrigger</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>kind</span> <span style=color:#a6e22e>gcTriggerKind</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>now</span>  <span style=color:#66d9ef>int64</span>  <span style=color:#75715e>// gcTriggerTime: current time
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>n</span>    <span style=color:#66d9ef>uint32</span> <span style=color:#75715e>// gcTriggerCycle: cycle number to start
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>gcTriggerKind</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> (
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>gcTriggerHeap</span> <span style=color:#a6e22e>gcTriggerKind</span> = <span style=color:#66d9ef>iota</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>gcTriggerTime</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>gcTriggerCycle</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>t</span> <span style=color:#a6e22e>gcTrigger</span>) <span style=color:#a6e22e>test</span>() <span style=color:#66d9ef>bool</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 检查是否禁用了 GC，程序是否处于 panic 状态，或 GC 阶段是否不是关闭状态。 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>memstats</span>.<span style=color:#a6e22e>enablegc</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>panicking</span>.<span style=color:#a6e22e>Load</span>() <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>gcphase</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>_GCoff</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>kind</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>gcTriggerHeap</span>:
</span></span><span style=display:flex><span>        <span style=color:#75715e>// heap 内存的方式触发
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>trigger</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>gcController</span>.<span style=color:#a6e22e>trigger</span>()
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>gcController</span>.<span style=color:#a6e22e>heapLive</span>.<span style=color:#a6e22e>Load</span>() <span style=color:#f92672>&gt;=</span> <span style=color:#a6e22e>trigger</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>gcTriggerTime</span>:
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 定时触发
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>gcController</span>.<span style=color:#a6e22e>gcPercent</span>.<span style=color:#a6e22e>Load</span>() &lt; <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 如果现在的时间减去上次 gc 的时间大于 forcegcperiod （2min） 就触发
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>lastgc</span> <span style=color:#f92672>:=</span> int64(<span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>Load64</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>memstats</span>.<span style=color:#a6e22e>last_gc_nanotime</span>))
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>lastgc</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>now</span><span style=color:#f92672>-</span><span style=color:#a6e22e>lastgc</span> &gt; <span style=color:#a6e22e>forcegcperiod</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>gcTriggerCycle</span>:
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 上次是否执行完毕
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>return</span> int32(<span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>n</span><span style=color:#f92672>-</span><span style=color:#a6e22e>work</span>.<span style=color:#a6e22e>cycles</span>.<span style=color:#a6e22e>Load</span>()) &gt; <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=heap-增长触发>Heap 增长触发
<a class=header-anchor href=#heap-%e5%a2%9e%e9%95%bf%e8%a7%a6%e5%8f%91></a></h2><p><code>mallocgc</code> 不但 malloc 了内存，还会检查是否需要触发 gc</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>mallocgc</span>(<span style=color:#a6e22e>size</span> <span style=color:#66d9ef>uintptr</span>, <span style=color:#a6e22e>typ</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>_type</span>, <span style=color:#a6e22e>needzero</span> <span style=color:#66d9ef>bool</span>) <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>assistG</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>deductAssistCredit</span>(<span style=color:#a6e22e>size</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>shouldhelpgc</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ......
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>size</span> <span style=color:#f92672>&lt;=</span> <span style=color:#a6e22e>maxSmallSize</span><span style=color:#f92672>-</span><span style=color:#a6e22e>mallocHeaderSize</span>  {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// ......
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// 如果 mcache 中满了 要向上申请了 shouldhelpgc = true 后续判断
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>v</span>, <span style=color:#a6e22e>span</span>, <span style=color:#a6e22e>shouldhelpgc</span> = <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>nextFree</span>(<span style=color:#a6e22e>tinySpanClass</span>)
</span></span><span style=display:flex><span>        <span style=color:#75715e>// ......
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 大于 32k 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>shouldhelpgc</span> = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// ......
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 如果开启了 GC 新对象都标黑
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>gcphase</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>_GCoff</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>gcmarknewobject</span>(<span style=color:#a6e22e>span</span>, uintptr(<span style=color:#a6e22e>x</span>))
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// test() 看下需不需要 gc
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>shouldhelpgc</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>t</span> <span style=color:#f92672>:=</span> (<span style=color:#a6e22e>gcTrigger</span>{<span style=color:#a6e22e>kind</span>: <span style=color:#a6e22e>gcTriggerHeap</span>}); <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>test</span>() {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>gcStart</span>(<span style=color:#a6e22e>t</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>gcmarknewobject</span>(<span style=color:#a6e22e>span</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>mspan</span>, <span style=color:#a6e22e>obj</span> <span style=color:#66d9ef>uintptr</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>span</span>.<span style=color:#a6e22e>markBitsForIndex</span>(<span style=color:#a6e22e>objIndex</span>).<span style=color:#a6e22e>setMarked</span>()
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=主动触发>主动触发
<a class=header-anchor href=#%e4%b8%bb%e5%8a%a8%e8%a7%a6%e5%8f%91></a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>GC</span>() {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ......
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>gcStart</span>(<span style=color:#a6e22e>gcTrigger</span>{<span style=color:#a6e22e>kind</span>: <span style=color:#a6e22e>gcTriggerCycle</span>, <span style=color:#a6e22e>n</span>: <span style=color:#a6e22e>n</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>})
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ......
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><h2 id=gcstart>gcStart
<a class=header-anchor href=#gcstart></a></h2><p>gcStart 为 gc 的标记主流程</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>gcStart</span>(<span style=color:#a6e22e>trigger</span> <span style=color:#a6e22e>gcTrigger</span>) {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ......
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 再次检查一下是不是能 GC 如果上次没清扫完，给清扫完
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>trigger</span>.<span style=color:#a6e22e>test</span>() <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>sweepone</span>() <span style=color:#f92672>!=</span> ^uintptr(<span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 上锁
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>semacquire</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>work</span>.<span style=color:#a6e22e>startSema</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 加锁了 再次检查一下
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>trigger</span>.<span style=color:#a6e22e>test</span>() {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>semrelease</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>work</span>.<span style=color:#a6e22e>startSema</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ......
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 启动 GC 标记工作线程。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>gcBgMarkStartWorkers</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 重置标记
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>systemstack</span>(<span style=color:#a6e22e>gcResetMarkState</span>)
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ......
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// Stop The World
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>systemstack</span>(<span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>stw</span> = <span style=color:#a6e22e>stopTheWorldWithSema</span>(<span style=color:#a6e22e>stwGCSweepTerm</span>)
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 在开始并发扫描之前完成清扫 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>systemstack</span>(<span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>finishsweep_m</span>()
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ......
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 使用多少个核心 GC
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>gcController</span>.<span style=color:#a6e22e>startCycle</span>(<span style=color:#a6e22e>now</span>, int(<span style=color:#a6e22e>gomaxprocs</span>), <span style=color:#a6e22e>trigger</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ......
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 进入并发标记阶段并启用写屏障。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>setGCPhase</span>(<span style=color:#a6e22e>_GCmark</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 标记所有活跃的 tinyalloc 块。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>gcMarkTinyAllocs</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 开始标记
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>systemstack</span>(<span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// start the world 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>now</span> = <span style=color:#a6e22e>startTheWorldWithSema</span>(<span style=color:#ae81ff>0</span>, <span style=color:#a6e22e>stw</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>work</span>.<span style=color:#a6e22e>pauseNS</span> <span style=color:#f92672>+=</span> <span style=color:#a6e22e>now</span> <span style=color:#f92672>-</span> <span style=color:#a6e22e>stw</span>.<span style=color:#a6e22e>startedStopping</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>work</span>.<span style=color:#a6e22e>tMark</span> = <span style=color:#a6e22e>now</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 释放 CPU 限制器
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>gcCPULimiter</span>.<span style=color:#a6e22e>finishGCTransition</span>(<span style=color:#a6e22e>now</span>)
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 在 STW 模式下，在 Gosched() 之前释放 world sema，
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// 因为我们稍后需要再次获取它，但在这个 goroutine 变为可运行之前，我们可能会自我死锁。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>semrelease</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>worldsema</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>releasem</span>(<span style=color:#a6e22e>mp</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	 <span style=color:#75715e>// 确保在 STW 模式下阻塞，而不是返回到用户代码。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>mode</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>gcBackgroundMode</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Gosched</span>()
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 释放开始信号量
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>semrelease</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>work</span>.<span style=color:#a6e22e>startSema</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=gcbgmarkstartworkers>gcBgMarkStartWorkers
<a class=header-anchor href=#gcbgmarkstartworkers></a></h3><p>gcBgMarkStartWorkers 启动 P 个数个 goroutine 去做并发标记</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>gcBgMarkStartWorkers</span>() {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ......
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>gcBgMarkWorkerCount</span> &lt; <span style=color:#a6e22e>gomaxprocs</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>go</span> <span style=color:#a6e22e>gcBgMarkWorker</span>(<span style=color:#a6e22e>ready</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>releasem</span>(<span style=color:#a6e22e>mp</span>)
</span></span><span style=display:flex><span>		<span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>ready</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>incnwait</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>work</span>.<span style=color:#a6e22e>nproc</span> <span style=color:#f92672>&amp;&amp;</span> !<span style=color:#a6e22e>gcMarkWorkAvailable</span>(<span style=color:#66d9ef>nil</span>) {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>releasem</span>(<span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>ptr</span>())
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>set</span>(<span style=color:#66d9ef>nil</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>gcMarkDone</span>()
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>gcBgMarkWorker</span>(<span style=color:#a6e22e>ready</span> <span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>struct</span>{}) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>gp</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>getg</span>()
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 把 node 组装成 node
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>node</span> <span style=color:#f92672>:=</span> new(<span style=color:#a6e22e>gcBgMarkWorkerNode</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>gp</span>.<span style=color:#a6e22e>set</span>(<span style=color:#a6e22e>gp</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>set</span>(<span style=color:#a6e22e>acquirem</span>())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ready</span> <span style=color:#f92672>&lt;-</span> <span style=color:#66d9ef>struct</span>{}{}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 阻塞当前 g 并把 node 传入 gcBgMarkWorkerPool
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>gopark</span>(<span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>g</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>g</span>, <span style=color:#a6e22e>nodep</span> <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>) <span style=color:#66d9ef>bool</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>node</span> <span style=color:#f92672>:=</span> (<span style=color:#f92672>*</span><span style=color:#a6e22e>gcBgMarkWorkerNode</span>)(<span style=color:#a6e22e>nodep</span>)
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>mp</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>ptr</span>(); <span style=color:#a6e22e>mp</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>releasem</span>(<span style=color:#a6e22e>mp</span>)
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>gcBgMarkWorkerPool</span>.<span style=color:#a6e22e>push</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>node</span>)
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>		}, <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#a6e22e>node</span>), <span style=color:#a6e22e>waitReasonGCWorkerIdle</span>, <span style=color:#a6e22e>traceBlockSystemGoroutine</span>, <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// ......
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 设置 gc goroutine 使用资源的方式
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>systemstack</span>(<span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>casGToWaitingForGC</span>(<span style=color:#a6e22e>gp</span>, <span style=color:#a6e22e>_Grunning</span>, <span style=color:#a6e22e>waitReasonGCWorkerActive</span>)
</span></span><span style=display:flex><span>			<span style=color:#75715e>// gcDrain(......)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#75715e>// .....
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#a6e22e>casgstatus</span>(<span style=color:#a6e22e>gp</span>, <span style=color:#a6e22e>_Gwaiting</span>, <span style=color:#a6e22e>_Grunning</span>)
</span></span><span style=display:flex><span>		})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// ......
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=stoptheworldwithsema>stopTheWorldWithSema
<a class=header-anchor href=#stoptheworldwithsema></a></h3><p>停止所有用户的 goroutine 做一些事情</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>stopTheWorldWithSema</span>(<span style=color:#a6e22e>reason</span> <span style=color:#a6e22e>stwReason</span>) <span style=color:#a6e22e>worldStop</span> {
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 加锁 并抢占所有的 goroutine
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>lock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>sched</span>.<span style=color:#a6e22e>lock</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>preemptall</span>()
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 将所有 P 设置为 _Pgcstop 状态 （当前 运行中 和空闲）
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>gp</span>.<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>ptr</span>().<span style=color:#a6e22e>status</span> = <span style=color:#a6e22e>_Pgcstop</span> 
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>gp</span>.<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>ptr</span>().<span style=color:#a6e22e>gcStopTime</span> = <span style=color:#a6e22e>start</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>sched</span>.<span style=color:#a6e22e>stopwait</span><span style=color:#f92672>--</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>trace</span> = <span style=color:#a6e22e>traceAcquire</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>pp</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>allp</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>s</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>pp</span>.<span style=color:#a6e22e>status</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>s</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>_Psyscall</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>Cas</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>pp</span>.<span style=color:#a6e22e>status</span>, <span style=color:#a6e22e>s</span>, <span style=color:#a6e22e>_Pgcstop</span>) {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>trace</span>.<span style=color:#a6e22e>ok</span>() {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>trace</span>.<span style=color:#a6e22e>ProcSteal</span>(<span style=color:#a6e22e>pp</span>, <span style=color:#66d9ef>false</span>)
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>pp</span>.<span style=color:#a6e22e>syscalltick</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>pp</span>.<span style=color:#a6e22e>gcStopTime</span> = <span style=color:#a6e22e>nanotime</span>()
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>sched</span>.<span style=color:#a6e22e>stopwait</span><span style=color:#f92672>--</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>trace</span>.<span style=color:#a6e22e>ok</span>() {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>traceRelease</span>(<span style=color:#a6e22e>trace</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>now</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>nanotime</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>pp</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>pidleget</span>(<span style=color:#a6e22e>now</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>pp</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>pp</span>.<span style=color:#a6e22e>status</span> = <span style=color:#a6e22e>_Pgcstop</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>pp</span>.<span style=color:#a6e22e>gcStopTime</span> = <span style=color:#a6e22e>nanotime</span>()
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>sched</span>.<span style=color:#a6e22e>stopwait</span><span style=color:#f92672>--</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>wait</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sched</span>.<span style=color:#a6e22e>stopwait</span> &gt; <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>unlock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>sched</span>.<span style=color:#a6e22e>lock</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 当前 P 不能被抢占 等待完成
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>wait</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>notetsleep</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>sched</span>.<span style=color:#a6e22e>stopnote</span>, <span style=color:#ae81ff>100</span><span style=color:#f92672>*</span><span style=color:#ae81ff>1000</span>) {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>noteclear</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>sched</span>.<span style=color:#a6e22e>stopnote</span>)
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>preemptall</span>()
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ......
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>worldStopped</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>worldStop</span>{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>reason</span>:           <span style=color:#a6e22e>reason</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>startedStopping</span>:  <span style=color:#a6e22e>start</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>finishedStopping</span>: <span style=color:#a6e22e>finish</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>stoppingCPUTime</span>:  <span style=color:#a6e22e>stoppingCPUTime</span>,
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=startcycle>startCycle
<a class=header-anchor href=#startcycle></a></h3><p>设置可以使用多少个核心进行 GC</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>gcControllerState</span>) <span style=color:#a6e22e>startCycle</span>(<span style=color:#a6e22e>markStartTime</span> <span style=color:#66d9ef>int64</span>, <span style=color:#a6e22e>procs</span> <span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>trigger</span> <span style=color:#a6e22e>gcTrigger</span>) {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// P * 25% 然后取整
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>totalUtilizationGoal</span> <span style=color:#f92672>:=</span> float64(<span style=color:#a6e22e>procs</span>) <span style=color:#f92672>*</span> <span style=color:#a6e22e>gcBackgroundUtilization</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>dedicatedMarkWorkersNeeded</span> <span style=color:#f92672>:=</span> int64(<span style=color:#a6e22e>totalUtilizationGoal</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>0.5</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>utilError</span> <span style=color:#f92672>:=</span> float64(<span style=color:#a6e22e>dedicatedMarkWorkersNeeded</span>)<span style=color:#f92672>/</span><span style=color:#a6e22e>totalUtilizationGoal</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>maxUtilError</span> = <span style=color:#ae81ff>0.3</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 如果不能整除 算出时间片
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>utilError</span> &lt; <span style=color:#f92672>-</span><span style=color:#a6e22e>maxUtilError</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>utilError</span> &gt; <span style=color:#a6e22e>maxUtilError</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> float64(<span style=color:#a6e22e>dedicatedMarkWorkersNeeded</span>) &gt; <span style=color:#a6e22e>totalUtilizationGoal</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>dedicatedMarkWorkersNeeded</span><span style=color:#f92672>--</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>fractionalUtilizationGoal</span> = (<span style=color:#a6e22e>totalUtilizationGoal</span> <span style=color:#f92672>-</span> float64(<span style=color:#a6e22e>dedicatedMarkWorkersNeeded</span>)) <span style=color:#f92672>/</span> float64(<span style=color:#a6e22e>procs</span>)
</span></span><span style=display:flex><span>	} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>fractionalUtilizationGoal</span> = <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>debug</span>.<span style=color:#a6e22e>gcstoptheworld</span> &gt; <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>dedicatedMarkWorkersNeeded</span> = int64(<span style=color:#a6e22e>procs</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>fractionalUtilizationGoal</span> = <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=setgcphase>setGCPhase
<a class=header-anchor href=#setgcphase></a></h3><p>开启混合写屏障</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>setGCPhase</span>(<span style=color:#a6e22e>x</span> <span style=color:#66d9ef>uint32</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>Store</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>gcphase</span>, <span style=color:#a6e22e>x</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>writeBarrier</span>.<span style=color:#a6e22e>enabled</span> = <span style=color:#a6e22e>gcphase</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>_GCmark</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>gcphase</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>_GCmarktermination</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>TEXT gcWriteBarrier&lt;&gt;(SB),NOSPLIT,$112
</span></span><span style=display:flex><span>// ...
</span></span><span style=display:flex><span>CALL	runtime·wbBufFlush(SB)
</span></span><span style=display:flex><span>// ...
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>wbBufFlush</span>() {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 如果当前 M（操作系统线程）正在终止过程中
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>getg</span>().<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>dying</span> &gt; <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>getg</span>().<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>ptr</span>().<span style=color:#a6e22e>wbBuf</span>.<span style=color:#a6e22e>discard</span>()
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>systemstack</span>(<span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>wbBufFlush1</span>(<span style=color:#a6e22e>getg</span>().<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>ptr</span>())
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>wbBufFlush1</span>(<span style=color:#a6e22e>pp</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>p</span>) {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 获取缓冲区中的所有指针
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>start</span> <span style=color:#f92672>:=</span> uintptr(<span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>pp</span>.<span style=color:#a6e22e>wbBuf</span>.<span style=color:#a6e22e>buf</span>[<span style=color:#ae81ff>0</span>]))
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>n</span> <span style=color:#f92672>:=</span> (<span style=color:#a6e22e>pp</span>.<span style=color:#a6e22e>wbBuf</span>.<span style=color:#a6e22e>next</span> <span style=color:#f92672>-</span> <span style=color:#a6e22e>start</span>) <span style=color:#f92672>/</span> <span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Sizeof</span>(<span style=color:#a6e22e>pp</span>.<span style=color:#a6e22e>wbBuf</span>.<span style=color:#a6e22e>buf</span>[<span style=color:#ae81ff>0</span>])
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ptrs</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>pp</span>.<span style=color:#a6e22e>wbBuf</span>.<span style=color:#a6e22e>buf</span>[:<span style=color:#a6e22e>n</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Poison the buffer to make extra sure nothing is enqueued
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// while we&#39;re processing the buffer.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>pp</span>.<span style=color:#a6e22e>wbBuf</span>.<span style=color:#a6e22e>next</span> = <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>useCheckmark</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// Slow path for checkmark mode.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>ptr</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>ptrs</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>shade</span>(<span style=color:#a6e22e>ptr</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>pp</span>.<span style=color:#a6e22e>wbBuf</span>.<span style=color:#a6e22e>reset</span>()
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 标记缓冲区中的所有指针，并且只记录被置灰的指针。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// 使用缓冲区本身临时记录被置灰的指针。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>gcw</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>pp</span>.<span style=color:#a6e22e>gcw</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>pos</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>ptr</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>ptrs</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ptr</span> &lt; <span style=color:#a6e22e>minLegalPointer</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>obj</span>, <span style=color:#a6e22e>span</span>, <span style=color:#a6e22e>objIndex</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>findObject</span>(<span style=color:#a6e22e>ptr</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>obj</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>mbits</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>span</span>.<span style=color:#a6e22e>markBitsForIndex</span>(<span style=color:#a6e22e>objIndex</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>mbits</span>.<span style=color:#a6e22e>isMarked</span>() {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>mbits</span>.<span style=color:#a6e22e>setMarked</span>()
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>arena</span>, <span style=color:#a6e22e>pageIdx</span>, <span style=color:#a6e22e>pageMask</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>pageIndexOf</span>(<span style=color:#a6e22e>span</span>.<span style=color:#a6e22e>base</span>())
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>arena</span>.<span style=color:#a6e22e>pageMarks</span>[<span style=color:#a6e22e>pageIdx</span>]<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>pageMask</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>Or8</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>arena</span>.<span style=color:#a6e22e>pageMarks</span>[<span style=color:#a6e22e>pageIdx</span>], <span style=color:#a6e22e>pageMask</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>span</span>.<span style=color:#a6e22e>spanclass</span>.<span style=color:#a6e22e>noscan</span>() {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>gcw</span>.<span style=color:#a6e22e>bytesMarked</span> <span style=color:#f92672>+=</span> uint64(<span style=color:#a6e22e>span</span>.<span style=color:#a6e22e>elemsize</span>)
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>ptrs</span>[<span style=color:#a6e22e>pos</span>] = <span style=color:#a6e22e>obj</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>pos</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 将被置灰的指针批量放入 gcw 中
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>gcw</span>.<span style=color:#a6e22e>putBatch</span>(<span style=color:#a6e22e>ptrs</span>[:<span style=color:#a6e22e>pos</span>])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>pp</span>.<span style=color:#a6e22e>wbBuf</span>.<span style=color:#a6e22e>reset</span>()
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=gcmarktinyallocs>gcMarkTinyAllocs
<a class=header-anchor href=#gcmarktinyallocs></a></h3><p>把所有的 tinyalloc 标记为灰色</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>gcMarkTinyAllocs</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>assertWorldStopped</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>p</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>allp</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>c</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>mcache</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>c</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>tiny</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>span</span>, <span style=color:#a6e22e>objIndex</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>findObject</span>(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>tiny</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>gcw</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>gcw</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>greyobject</span>(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>tiny</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#a6e22e>span</span>, <span style=color:#a6e22e>gcw</span>, <span style=color:#a6e22e>objIndex</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=starttheworldwithsema>startTheWorldWithSema
<a class=header-anchor href=#starttheworldwithsema></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>startTheWorldWithSema</span>(<span style=color:#a6e22e>now</span> <span style=color:#66d9ef>int64</span>, <span style=color:#a6e22e>w</span> <span style=color:#a6e22e>worldStop</span>) <span style=color:#66d9ef>int64</span> {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ......
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>worldStarted</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 唤醒所有的 P
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>p1</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>p</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>p1</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>p1</span> = <span style=color:#a6e22e>p1</span>.<span style=color:#a6e22e>link</span>.<span style=color:#a6e22e>ptr</span>()
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>m</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>mp</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>ptr</span>()
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>m</span> = <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>mp</span>.<span style=color:#a6e22e>nextp</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>throw</span>(<span style=color:#e6db74>&#34;startTheWorld: inconsistent mp-&gt;nextp&#34;</span>)
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>mp</span>.<span style=color:#a6e22e>nextp</span>.<span style=color:#a6e22e>set</span>(<span style=color:#a6e22e>p</span>)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>notewakeup</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>mp</span>.<span style=color:#a6e22e>park</span>)
</span></span><span style=display:flex><span>		} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>newm</span>(<span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>p</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ......
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>now</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=worker-标记>worker 标记
<a class=header-anchor href=#worker-%e6%a0%87%e8%ae%b0></a></h2><p>在 goroutine 调度中会执行 <code>findRunnableGCWorker</code> goroutine 这个就是启动标记 worker 的函数</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>gcControllerState</span>) <span style=color:#a6e22e>findRunnableGCWorker</span>(<span style=color:#a6e22e>pp</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>p</span>, <span style=color:#a6e22e>now</span> <span style=color:#66d9ef>int64</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>g</span>, <span style=color:#66d9ef>int64</span>) {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ......
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 从 gcBgMarkWorkerPool 拿出 node 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>node</span> <span style=color:#f92672>:=</span> (<span style=color:#f92672>*</span><span style=color:#a6e22e>gcBgMarkWorkerNode</span>)(<span style=color:#a6e22e>gcBgMarkWorkerPool</span>.<span style=color:#a6e22e>pop</span>())
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 开启
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>casgstatus</span>(<span style=color:#a6e22e>gp</span>, <span style=color:#a6e22e>_Gwaiting</span>, <span style=color:#a6e22e>_Grunnable</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>gp</span>, <span style=color:#a6e22e>now</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=gcdrain>gcDrain
<a class=header-anchor href=#gcdrain></a></h2><p>gcDrain 是标记的主流程</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>gcDrain</span>(<span style=color:#a6e22e>gcw</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>gcWork</span>, <span style=color:#a6e22e>flags</span> <span style=color:#a6e22e>gcDrainFlags</span>) {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ......
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 标记根对象
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>work</span>.<span style=color:#a6e22e>markrootNext</span> &lt; <span style=color:#a6e22e>work</span>.<span style=color:#a6e22e>markrootJobs</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>for</span> !(<span style=color:#a6e22e>gp</span>.<span style=color:#a6e22e>preempt</span> <span style=color:#f92672>&amp;&amp;</span> (<span style=color:#a6e22e>preemptible</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>sched</span>.<span style=color:#a6e22e>gcwaiting</span>.<span style=color:#a6e22e>Load</span>() <span style=color:#f92672>||</span> <span style=color:#a6e22e>pp</span>.<span style=color:#a6e22e>runSafePointFn</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span>)) {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>job</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>Xadd</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>work</span>.<span style=color:#a6e22e>markrootNext</span>, <span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>) <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>job</span> <span style=color:#f92672>&gt;=</span> <span style=color:#a6e22e>work</span>.<span style=color:#a6e22e>markrootJobs</span> {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>markroot</span>(<span style=color:#a6e22e>gcw</span>, <span style=color:#a6e22e>job</span>, <span style=color:#a6e22e>flushBgCredit</span>)
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>check</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>check</span>() {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>goto</span> <span style=color:#a6e22e>done</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> !(<span style=color:#a6e22e>gp</span>.<span style=color:#a6e22e>preempt</span> <span style=color:#f92672>&amp;&amp;</span> (<span style=color:#a6e22e>preemptible</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>sched</span>.<span style=color:#a6e22e>gcwaiting</span>.<span style=color:#a6e22e>Load</span>() <span style=color:#f92672>||</span> <span style=color:#a6e22e>pp</span>.<span style=color:#a6e22e>runSafePointFn</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span>)) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>work</span>.<span style=color:#a6e22e>full</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>gcw</span>.<span style=color:#a6e22e>balance</span>()
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 尝试从本地队列中获取对象
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>b</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>gcw</span>.<span style=color:#a6e22e>tryGetFast</span>()
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>b</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 如果没有从全局队列中获取 加锁
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#a6e22e>b</span> = <span style=color:#a6e22e>gcw</span>.<span style=color:#a6e22e>tryGet</span>()
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>b</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>				<span style=color:#75715e>// 刷新写屏障缓存
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>				<span style=color:#a6e22e>wbBufFlush</span>()
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>b</span> = <span style=color:#a6e22e>gcw</span>.<span style=color:#a6e22e>tryGet</span>()
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>b</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 清扫对象
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>scanobject</span>(<span style=color:#a6e22e>b</span>, <span style=color:#a6e22e>gcw</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// ......
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>done</span>:
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 记录积分
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>gcw</span>.<span style=color:#a6e22e>heapScanWork</span> &gt; <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>gcController</span>.<span style=color:#a6e22e>heapScanWork</span>.<span style=color:#a6e22e>Add</span>(<span style=color:#a6e22e>gcw</span>.<span style=color:#a6e22e>heapScanWork</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>flushBgCredit</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>gcFlushBgCredit</span>(<span style=color:#a6e22e>gcw</span>.<span style=color:#a6e22e>heapScanWork</span> <span style=color:#f92672>-</span> <span style=color:#a6e22e>initScanWork</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>gcw</span>.<span style=color:#a6e22e>heapScanWork</span> = <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=scanobject>scanobject
<a class=header-anchor href=#scanobject></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>scanobject</span>(<span style=color:#a6e22e>b</span> <span style=color:#66d9ef>uintptr</span>, <span style=color:#a6e22e>gcw</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>gcWork</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>tp</span> <span style=color:#a6e22e>typePointers</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>n</span> &gt; <span style=color:#a6e22e>maxObletBytes</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 大对象分块
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>b</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>base</span>() {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>oblet</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>b</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>maxObletBytes</span>; <span style=color:#a6e22e>oblet</span> &lt; <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>base</span>()<span style=color:#f92672>+</span><span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>elemsize</span>; <span style=color:#a6e22e>oblet</span> <span style=color:#f92672>+=</span> <span style=color:#a6e22e>maxObletBytes</span> {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>gcw</span>.<span style=color:#a6e22e>putFast</span>(<span style=color:#a6e22e>oblet</span>) {
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>gcw</span>.<span style=color:#a6e22e>put</span>(<span style=color:#a6e22e>oblet</span>)
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>n</span> = <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>base</span>() <span style=color:#f92672>+</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>elemsize</span> <span style=color:#f92672>-</span> <span style=color:#a6e22e>b</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>n</span> = min(<span style=color:#a6e22e>n</span>, <span style=color:#a6e22e>maxObletBytes</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>tp</span> = <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>typePointersOfUnchecked</span>(<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>base</span>())
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>tp</span> = <span style=color:#a6e22e>tp</span>.<span style=color:#a6e22e>fastForward</span>(<span style=color:#a6e22e>b</span><span style=color:#f92672>-</span><span style=color:#a6e22e>tp</span>.<span style=color:#a6e22e>addr</span>, <span style=color:#a6e22e>b</span><span style=color:#f92672>+</span><span style=color:#a6e22e>n</span>)
</span></span><span style=display:flex><span>	} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>tp</span> = <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>typePointersOfUnchecked</span>(<span style=color:#a6e22e>b</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>scanSize</span> <span style=color:#66d9ef>uintptr</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>addr</span> <span style=color:#66d9ef>uintptr</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>tp</span>, <span style=color:#a6e22e>addr</span> = <span style=color:#a6e22e>tp</span>.<span style=color:#a6e22e>nextFast</span>(); <span style=color:#a6e22e>addr</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>tp</span>, <span style=color:#a6e22e>addr</span> = <span style=color:#a6e22e>tp</span>.<span style=color:#a6e22e>next</span>(<span style=color:#a6e22e>b</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>n</span>); <span style=color:#a6e22e>addr</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>scanSize</span> = <span style=color:#a6e22e>addr</span> <span style=color:#f92672>-</span> <span style=color:#a6e22e>b</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>goarch</span>.<span style=color:#a6e22e>PtrSize</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>obj</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>*</span>(<span style=color:#f92672>*</span><span style=color:#66d9ef>uintptr</span>)(<span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#a6e22e>addr</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>obj</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>obj</span><span style=color:#f92672>-</span><span style=color:#a6e22e>b</span> <span style=color:#f92672>&gt;=</span> <span style=color:#a6e22e>n</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>obj</span>, <span style=color:#a6e22e>span</span>, <span style=color:#a6e22e>objIndex</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>findObject</span>(<span style=color:#a6e22e>obj</span>, <span style=color:#a6e22e>b</span>, <span style=color:#a6e22e>addr</span><span style=color:#f92672>-</span><span style=color:#a6e22e>b</span>); <span style=color:#a6e22e>obj</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>                <span style=color:#75715e>// 设置为灰色
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>				<span style=color:#a6e22e>greyobject</span>(<span style=color:#a6e22e>obj</span>, <span style=color:#a6e22e>b</span>, <span style=color:#a6e22e>addr</span><span style=color:#f92672>-</span><span style=color:#a6e22e>b</span>, <span style=color:#a6e22e>span</span>, <span style=color:#a6e22e>gcw</span>, <span style=color:#a6e22e>objIndex</span>)
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><strong>greyobject</strong></p><p>gcmarkBits 是一个 bitmaps 代表了一个对象是不是可用（gc 过程中）</p><ol><li>如果 Bit = 1 对象不在 gcw 中 黑色</li><li>如果 Bit = 0 对象不在 gcw 中 白色</li><li>如果对象在 gcw 中 灰色</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>greyobject</span>(<span style=color:#a6e22e>obj</span>, <span style=color:#a6e22e>base</span>, <span style=color:#a6e22e>off</span> <span style=color:#66d9ef>uintptr</span>, <span style=color:#a6e22e>span</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>mspan</span>, <span style=color:#a6e22e>gcw</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>gcWork</span>, <span style=color:#a6e22e>objIndex</span> <span style=color:#66d9ef>uintptr</span>) {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>mbits</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>span</span>.<span style=color:#a6e22e>markBitsForIndex</span>(<span style=color:#a6e22e>objIndex</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>useCheckmark</span> {
</span></span><span style=display:flex><span>	} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>mbits</span>.<span style=color:#a6e22e>setMarked</span>()
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 把对象放入 gcw 中
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>sys</span>.<span style=color:#a6e22e>Prefetch</span>(<span style=color:#a6e22e>obj</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>gcw</span>.<span style=color:#a6e22e>putFast</span>(<span style=color:#a6e22e>obj</span>) {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>gcw</span>.<span style=color:#a6e22e>put</span>(<span style=color:#a6e22e>obj</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>s</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>mspan</span>) <span style=color:#a6e22e>markBitsForIndex</span>(<span style=color:#a6e22e>objIndex</span> <span style=color:#66d9ef>uintptr</span>) <span style=color:#a6e22e>markBits</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>bytep</span>, <span style=color:#a6e22e>mask</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>gcmarkBits</span>.<span style=color:#a6e22e>bitp</span>(<span style=color:#a6e22e>objIndex</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>markBits</span>{<span style=color:#a6e22e>bytep</span>, <span style=color:#a6e22e>mask</span>, <span style=color:#a6e22e>objIndex</span>}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>m</span> <span style=color:#a6e22e>markBits</span>) <span style=color:#a6e22e>setMarked</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>Or8</span>(<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>bytep</span>, <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>mask</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=用户-goroutine-清扫>用户 goroutine 清扫
<a class=header-anchor href=#%e7%94%a8%e6%88%b7-goroutine-%e6%b8%85%e6%89%ab></a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>deductAssistCredit</span>(<span style=color:#a6e22e>size</span> <span style=color:#66d9ef>uintptr</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>g</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>assistG</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>g</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>gcBlackenEnabled</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>assistG</span> = <span style=color:#a6e22e>getg</span>()
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>assistG</span>.<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>curg</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>assistG</span> = <span style=color:#a6e22e>assistG</span>.<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>curg</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>assistG</span>.<span style=color:#a6e22e>gcAssistBytes</span> <span style=color:#f92672>-=</span> int64(<span style=color:#a6e22e>size</span>)
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 每个 G 都有自己的积分 当积分小于 0 启动 gc
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>assistG</span>.<span style=color:#a6e22e>gcAssistBytes</span> &lt; <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>gcAssistAlloc</span>(<span style=color:#a6e22e>assistG</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>assistG</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>gcAssistAlloc</span>(<span style=color:#a6e22e>gp</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>g</span>) {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ......
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>retry</span>:
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 处理下 assistG 的积分 需不需要启动 gc
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Perform assist work
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>systemstack</span>(<span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>gcAssistAlloc1</span>(<span style=color:#a6e22e>gp</span>, <span style=color:#a6e22e>scanWork</span>)
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ......
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>gcAssistAlloc1</span>(<span style=color:#a6e22e>gp</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>g</span>, <span style=color:#a6e22e>scanWork</span> <span style=color:#66d9ef>int64</span>) {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ......
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>gcw</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>getg</span>().<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>ptr</span>().<span style=color:#a6e22e>gcw</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>workDone</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>gcDrainN</span>(<span style=color:#a6e22e>gcw</span>, <span style=color:#a6e22e>scanWork</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>casgstatus</span>(<span style=color:#a6e22e>gp</span>, <span style=color:#a6e22e>_Gwaiting</span>, <span style=color:#a6e22e>_Grunning</span>)
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ......
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><h2 id=终止标记-gcmarkdone>终止标记 gcMarkDone
<a class=header-anchor href=#%e7%bb%88%e6%ad%a2%e6%a0%87%e8%ae%b0-gcmarkdone></a></h2><p>在 gcBgMarkStartWorkers 中执行 gcMarkDone 终止</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>gcMarkDone</span>() {
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>top</span>:
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 清除写屏障的缓存和处理gcw
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>gcMarkDoneFlushed</span> = <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>forEachP</span>(<span style=color:#a6e22e>waitReasonGCMarkTermination</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>pp</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>p</span>) {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>wbBufFlush1</span>(<span style=color:#a6e22e>pp</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>pp</span>.<span style=color:#a6e22e>gcw</span>.<span style=color:#a6e22e>dispose</span>()
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>pp</span>.<span style=color:#a6e22e>gcw</span>.<span style=color:#a6e22e>flushedWork</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>Xadd</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>gcMarkDoneFlushed</span>, <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>pp</span>.<span style=color:#a6e22e>gcw</span>.<span style=color:#a6e22e>flushedWork</span> = <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>gcMarkDoneFlushed</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 还有没处理的 跳回去再处理一次
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>semrelease</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>worldsema</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>goto</span> <span style=color:#a6e22e>top</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Stop The World
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>systemstack</span>(<span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>stw</span> = <span style=color:#a6e22e>stopTheWorldWithSema</span>(<span style=color:#a6e22e>stwGCMarkTerm</span>)
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 清楚写屏障中的缓存 如果还有没处理的 跳回去再处理一次
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>restart</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>systemstack</span>(<span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>p</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>allp</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>wbBufFlush1</span>(<span style=color:#a6e22e>p</span>)
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>gcw</span>.<span style=color:#a6e22e>empty</span>() {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>restart</span> = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>restart</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>getg</span>().<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>preemptoff</span> = <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>systemstack</span>(<span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>work</span>.<span style=color:#a6e22e>cpuStats</span>.<span style=color:#a6e22e>accumulateGCPauseTime</span>(<span style=color:#a6e22e>nanotime</span>()<span style=color:#f92672>-</span><span style=color:#a6e22e>stw</span>.<span style=color:#a6e22e>finishedStopping</span>, <span style=color:#a6e22e>work</span>.<span style=color:#a6e22e>maxprocs</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>now</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>startTheWorldWithSema</span>(<span style=color:#ae81ff>0</span>, <span style=color:#a6e22e>stw</span>)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>work</span>.<span style=color:#a6e22e>pauseNS</span> <span style=color:#f92672>+=</span> <span style=color:#a6e22e>now</span> <span style=color:#f92672>-</span> <span style=color:#a6e22e>stw</span>.<span style=color:#a6e22e>startedStopping</span>
</span></span><span style=display:flex><span>		})
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>semrelease</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>worldsema</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>goto</span> <span style=color:#a6e22e>top</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 终止标记
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>gcMarkTermination</span>(<span style=color:#a6e22e>stw</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=gcmarktermination>gcMarkTermination
<a class=header-anchor href=#gcmarktermination></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>gcMarkTermination</span>(<span style=color:#a6e22e>stw</span> <span style=color:#a6e22e>worldStop</span>) {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 设置 gc 终止阶段
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>setGCPhase</span>(<span style=color:#a6e22e>_GCmarktermination</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 修改 gc goroutine 状态
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>casGToWaitingForGC</span>(<span style=color:#a6e22e>curgp</span>, <span style=color:#a6e22e>_Grunning</span>, <span style=color:#a6e22e>waitReasonGarbageCollection</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 在 g0 栈上运行 gc。这样做是为了保证我们当前运行的 g 栈不再变化，
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// 这有助于减少根集大小（g0 栈不会被扫描，我们也不需要扫描 gc 的内部状态）。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// 我们还需要切换到 g0 以便可能的栈缩减。 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>systemstack</span>(<span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>gcMark</span>(<span style=color:#a6e22e>startTime</span>)
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>stwSwept</span> <span style=color:#66d9ef>bool</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>systemstack</span>(<span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>work</span>.<span style=color:#a6e22e>heap2</span> = <span style=color:#a6e22e>work</span>.<span style=color:#a6e22e>bytesMarked</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>debug</span>.<span style=color:#a6e22e>gccheckmark</span> &gt; <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>			<span style=color:#75715e>// Run a full non-parallel, stop-the-world
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#75715e>// mark using checkmark bits, to check that we
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#75715e>// didn&#39;t forget to mark anything during the
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#75715e>// concurrent mark process.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#a6e22e>startCheckmarks</span>()
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>gcResetMarkState</span>()
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>gcw</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>getg</span>().<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>ptr</span>().<span style=color:#a6e22e>gcw</span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>gcDrain</span>(<span style=color:#a6e22e>gcw</span>, <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>wbBufFlush1</span>(<span style=color:#a6e22e>getg</span>().<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>ptr</span>())
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>gcw</span>.<span style=color:#a6e22e>dispose</span>()
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>endCheckmarks</span>()
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 标记完成，我们可以关闭写屏障。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>setGCPhase</span>(<span style=color:#a6e22e>_GCoff</span>)
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 开启清扫
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>stwSwept</span> = <span style=color:#a6e22e>gcSweep</span>(<span style=color:#a6e22e>work</span>.<span style=color:#a6e22e>mode</span>)
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>casgstatus</span>(<span style=color:#a6e22e>curgp</span>, <span style=color:#a6e22e>_Gwaiting</span>, <span style=color:#a6e22e>_Grunning</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ......
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>systemstack</span>(<span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Start The World
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>startTheWorldWithSema</span>(<span style=color:#a6e22e>now</span>, <span style=color:#a6e22e>stw</span>)
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 确保所有 mcaches 被清空。每个 P 在分配前将清空自己的 mcache，但空闲的 P 可能不会。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// 由于这对于扫描所有 spans 是必需的，我们需要确保在开始下一个 GC 周期前，所有 mcaches 都已被清空。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>forEachP</span>(<span style=color:#a6e22e>waitReasonFlushProcCaches</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>pp</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>p</span>) {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>pp</span>.<span style=color:#a6e22e>mcache</span>.<span style=color:#a6e22e>prepareForSweep</span>()
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>pp</span>.<span style=color:#a6e22e>status</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>_Pidle</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>systemstack</span>(<span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>lock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>mheap_</span>.<span style=color:#a6e22e>lock</span>)
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>pp</span>.<span style=color:#a6e22e>pcache</span>.<span style=color:#a6e22e>flush</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>mheap_</span>.<span style=color:#a6e22e>pages</span>)
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>unlock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>mheap_</span>.<span style=color:#a6e22e>lock</span>)
</span></span><span style=display:flex><span>			})
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>pp</span>.<span style=color:#a6e22e>pinnerCache</span> = <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>sl</span>.<span style=color:#a6e22e>valid</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// Now that we&#39;ve swept stale spans in mcaches, they don&#39;t
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// count against unswept spans.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// Note: this sweepLocker may not be valid if sweeping had
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// already completed during the STW. See the corresponding
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// begin() call that produced sl.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>sweep</span>.<span style=color:#a6e22e>active</span>.<span style=color:#a6e22e>end</span>(<span style=color:#a6e22e>sl</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=清扫>清扫
<a class=header-anchor href=#%e6%b8%85%e6%89%ab></a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>gcSweep</span>(<span style=color:#a6e22e>mode</span> <span style=color:#a6e22e>gcMode</span>) <span style=color:#66d9ef>bool</span> {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ......
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 并发清扫
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>lock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>sweep</span>.<span style=color:#a6e22e>lock</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>sweep</span>.<span style=color:#a6e22e>parked</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>sweep</span>.<span style=color:#a6e22e>parked</span> = <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>ready</span>(<span style=color:#a6e22e>sweep</span>.<span style=color:#a6e22e>g</span>, <span style=color:#ae81ff>0</span>, <span style=color:#66d9ef>true</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>unlock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>sweep</span>.<span style=color:#a6e22e>lock</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>sweep.g 的创建</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>sweep</span> <span style=color:#a6e22e>sweepdata</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>sweepdata</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>g</span>      <span style=color:#f92672>*</span><span style=color:#a6e22e>g</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 在 runtime main 中调用了gcenable()
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>gcenable</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>c</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>int</span>, <span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>go</span> <span style=color:#a6e22e>bgsweep</span>(<span style=color:#a6e22e>c</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>go</span> <span style=color:#a6e22e>bgscavenge</span>(<span style=color:#a6e22e>c</span>)
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>c</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>c</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>memstats</span>.<span style=color:#a6e22e>enablegc</span> = <span style=color:#66d9ef>true</span> 
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=bgscavenge>bgscavenge
<a class=header-anchor href=#bgscavenge></a></h3><p>从 OS 申请到 _heap 上的内存 不用了 还回去一些</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>bgscavenge</span>(<span style=color:#a6e22e>c</span> <span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>int</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>scavenger</span>.<span style=color:#a6e22e>init</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>c</span> <span style=color:#f92672>&lt;-</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 等待
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>scavenger</span>.<span style=color:#a6e22e>park</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 执行一次清理 (scavenge) 操作，返回释放的内存量和本次操作的耗时
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>released</span>, <span style=color:#a6e22e>workTime</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>scavenger</span>.<span style=color:#a6e22e>run</span>()
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 没有释放内存，休眠
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>released</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>scavenger</span>.<span style=color:#a6e22e>park</span>()
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 如果释放了内存，将释放的内存量和耗时记录到统计信息中
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>mheap_</span>.<span style=color:#a6e22e>pages</span>.<span style=color:#a6e22e>scav</span>.<span style=color:#a6e22e>releasedBg</span>.<span style=color:#a6e22e>Add</span>(<span style=color:#a6e22e>released</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>scavenger</span>.<span style=color:#a6e22e>sleep</span>(<span style=color:#a6e22e>workTime</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=scavengerrun>scavenger.run
<a class=header-anchor href=#scavengerrun></a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>s</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>scavengerState</span>) <span style=color:#a6e22e>run</span>() (<span style=color:#a6e22e>released</span> <span style=color:#66d9ef>uintptr</span>, <span style=color:#a6e22e>worked</span> <span style=color:#66d9ef>float64</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>worked</span> &lt; <span style=color:#a6e22e>minScavWorkTime</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 如果需要停止，就停止
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>shouldStop</span>() {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>scavengeQuantum</span> = <span style=color:#ae81ff>64</span> <span style=color:#f92672>&lt;&lt;</span> <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>r</span>, <span style=color:#a6e22e>duration</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>scavenge</span>(<span style=color:#a6e22e>scavengeQuantum</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>approxWorkedNSPerPhysicalPage</span> = <span style=color:#ae81ff>10e3</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>duration</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>worked</span> <span style=color:#f92672>+=</span> <span style=color:#a6e22e>approxWorkedNSPerPhysicalPage</span> <span style=color:#f92672>*</span> float64(<span style=color:#a6e22e>r</span><span style=color:#f92672>/</span><span style=color:#a6e22e>physPageSize</span>)
</span></span><span style=display:flex><span>		} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>worked</span> <span style=color:#f92672>+=</span> float64(<span style=color:#a6e22e>duration</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>released</span> <span style=color:#f92672>+=</span> <span style=color:#a6e22e>r</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=sscavenge>s.scavenge
<a class=header-anchor href=#sscavenge></a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>scavenge</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>scavenge</span> = <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>n</span> <span style=color:#66d9ef>uintptr</span>) (<span style=color:#66d9ef>uintptr</span>, <span style=color:#66d9ef>int64</span>) {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>start</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>nanotime</span>()
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>r</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>mheap_</span>.<span style=color:#a6e22e>pages</span>.<span style=color:#a6e22e>scavenge</span>(<span style=color:#a6e22e>n</span>, <span style=color:#66d9ef>nil</span>, <span style=color:#66d9ef>false</span>)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>end</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>nanotime</span>()
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>start</span> <span style=color:#f92672>&gt;=</span> <span style=color:#a6e22e>end</span> {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>r</span>, <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>scavenge</span>.<span style=color:#a6e22e>backgroundTime</span>.<span style=color:#a6e22e>Add</span>(<span style=color:#a6e22e>end</span> <span style=color:#f92672>-</span> <span style=color:#a6e22e>start</span>)
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>r</span>, <span style=color:#a6e22e>end</span> <span style=color:#f92672>-</span> <span style=color:#a6e22e>start</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>p</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>pageAlloc</span>) <span style=color:#a6e22e>scavenge</span>(<span style=color:#a6e22e>nbytes</span> <span style=color:#66d9ef>uintptr</span>, <span style=color:#a6e22e>shouldStop</span> <span style=color:#66d9ef>func</span>() <span style=color:#66d9ef>bool</span>, <span style=color:#a6e22e>force</span> <span style=color:#66d9ef>bool</span>) <span style=color:#66d9ef>uintptr</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>released</span> <span style=color:#f92672>:=</span> uintptr(<span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>released</span> &lt; <span style=color:#a6e22e>nbytes</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>ci</span>, <span style=color:#a6e22e>pageIdx</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>scav</span>.<span style=color:#a6e22e>index</span>.<span style=color:#a6e22e>find</span>(<span style=color:#a6e22e>force</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ci</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>systemstack</span>(<span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>released</span> <span style=color:#f92672>+=</span> <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>scavengeOne</span>(<span style=color:#a6e22e>ci</span>, <span style=color:#a6e22e>pageIdx</span>, <span style=color:#a6e22e>nbytes</span><span style=color:#f92672>-</span><span style=color:#a6e22e>released</span>)
</span></span><span style=display:flex><span>		})
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>shouldStop</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>shouldStop</span>() {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>released</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=scavengeone>scavengeOne
<a class=header-anchor href=#scavengeone></a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>p</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>pageAlloc</span>) <span style=color:#a6e22e>scavengeOne</span>(<span style=color:#a6e22e>ci</span> <span style=color:#a6e22e>chunkIdx</span>, <span style=color:#a6e22e>searchIdx</span> <span style=color:#66d9ef>uint</span>, <span style=color:#a6e22e>max</span> <span style=color:#66d9ef>uintptr</span>) <span style=color:#66d9ef>uintptr</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>maxPages</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>max</span> <span style=color:#f92672>/</span> <span style=color:#a6e22e>pageSize</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>max</span><span style=color:#f92672>%</span><span style=color:#a6e22e>pageSize</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>maxPages</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>minPages</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>physPageSize</span> <span style=color:#f92672>/</span> <span style=color:#a6e22e>pageSize</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>minPages</span> &lt; <span style=color:#ae81ff>1</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>minPages</span> = <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>lock</span>(<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>mheapLock</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>summary</span>[len(<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>summary</span>)<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>][<span style=color:#a6e22e>ci</span>].max() <span style=color:#f92672>&gt;=</span> uint(<span style=color:#a6e22e>minPages</span>) {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 找到回收的开始地址 和页数
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>base</span>, <span style=color:#a6e22e>npages</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>chunkOf</span>(<span style=color:#a6e22e>ci</span>).<span style=color:#a6e22e>findScavengeCandidate</span>(<span style=color:#a6e22e>searchIdx</span>, <span style=color:#a6e22e>minPages</span>, <span style=color:#a6e22e>maxPages</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// If we found something, scavenge it and return!
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>npages</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>			<span style=color:#75715e>// ......
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#a6e22e>unlock</span>(<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>mheapLock</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>test</span> {
</span></span><span style=display:flex><span>				<span style=color:#75715e>// 系统调用
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>				<span style=color:#a6e22e>sysUnused</span>(<span style=color:#a6e22e>unsafe</span>.<span style=color:#a6e22e>Pointer</span>(<span style=color:#a6e22e>addr</span>), uintptr(<span style=color:#a6e22e>npages</span>)<span style=color:#f92672>*</span><span style=color:#a6e22e>pageSize</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>				<span style=color:#75715e>// ......
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// 更新统计信息
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#a6e22e>lock</span>(<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>mheapLock</span>)
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>b</span> <span style=color:#f92672>:=</span> (<span style=color:#a6e22e>offAddr</span>{<span style=color:#a6e22e>addr</span>}); <span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>lessThan</span>(<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>searchAddr</span>) {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>searchAddr</span> = <span style=color:#a6e22e>b</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>chunkOf</span>(<span style=color:#a6e22e>ci</span>).<span style=color:#a6e22e>free</span>(<span style=color:#a6e22e>base</span>, <span style=color:#a6e22e>npages</span>)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>update</span>(<span style=color:#a6e22e>addr</span>, uintptr(<span style=color:#a6e22e>npages</span>), <span style=color:#66d9ef>true</span>, <span style=color:#66d9ef>false</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// Mark the range as scavenged.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>chunkOf</span>(<span style=color:#a6e22e>ci</span>).<span style=color:#a6e22e>scavenged</span>.<span style=color:#a6e22e>setRange</span>(<span style=color:#a6e22e>base</span>, <span style=color:#a6e22e>npages</span>)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>unlock</span>(<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>mheapLock</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> uintptr(<span style=color:#a6e22e>npages</span>) <span style=color:#f92672>*</span> <span style=color:#a6e22e>pageSize</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>scav</span>.<span style=color:#a6e22e>index</span>.<span style=color:#a6e22e>setEmpty</span>(<span style=color:#a6e22e>ci</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>unlock</span>(<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>mheapLock</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=bgsweep>bgsweep
<a class=header-anchor href=#bgsweep></a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>bgsweep</span>(<span style=color:#a6e22e>c</span> <span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>int</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>sweep</span>.<span style=color:#a6e22e>g</span> = <span style=color:#a6e22e>getg</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>lockInit</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>sweep</span>.<span style=color:#a6e22e>lock</span>, <span style=color:#a6e22e>lockRankSweep</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>lock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>sweep</span>.<span style=color:#a6e22e>lock</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>sweep</span>.<span style=color:#a6e22e>parked</span> = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>c</span> <span style=color:#f92672>&lt;-</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 休眠 等待gc 完成 唤醒它
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>goparkunlock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>sweep</span>.<span style=color:#a6e22e>lock</span>, <span style=color:#a6e22e>waitReasonGCSweepWait</span>, <span style=color:#a6e22e>traceBlockGCSweep</span>, <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 执行一次清扫操作
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>sweepone</span>() <span style=color:#f92672>!=</span> ^uintptr(<span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>nSwept</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// 每清扫一定数量对象，就尝试让出 CPU
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>nSwept</span><span style=color:#f92672>%</span><span style=color:#a6e22e>sweepBatchSize</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>goschedIfBusy</span>()
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 释放一些写缓冲区
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>freeSomeWbufs</span>(<span style=color:#66d9ef>true</span>) {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>goschedIfBusy</span>()
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>lock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>sweep</span>.<span style=color:#a6e22e>lock</span>)
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 检查是否完成了所有扫描任务。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>isSweepDone</span>() {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>unlock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>sweep</span>.<span style=color:#a6e22e>lock</span>)
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>sweep</span>.<span style=color:#a6e22e>parked</span> = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 休眠 等待下一次 gc 标记完成唤醒它
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>goparkunlock</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>sweep</span>.<span style=color:#a6e22e>lock</span>, <span style=color:#a6e22e>waitReasonGCSweepWait</span>, <span style=color:#a6e22e>traceBlockGCSweep</span>, <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=sweepone>sweepone
<a class=header-anchor href=#sweepone></a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>sweepone</span>() <span style=color:#66d9ef>uintptr</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>gp</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>getg</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>gp</span>.<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>locks</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>sl</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sweep</span>.<span style=color:#a6e22e>active</span>.<span style=color:#a6e22e>begin</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>sl</span>.<span style=color:#a6e22e>valid</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>gp</span>.<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>locks</span><span style=color:#f92672>--</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> ^uintptr(<span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Find a span to sweep.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>npages</span> <span style=color:#f92672>:=</span> ^uintptr(<span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>noMoreWork</span> <span style=color:#66d9ef>bool</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 查找 span
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>s</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>mheap_</span>.<span style=color:#a6e22e>nextSpanForSweep</span>()
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>s</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>noMoreWork</span> = <span style=color:#a6e22e>sweep</span>.<span style=color:#a6e22e>active</span>.<span style=color:#a6e22e>markDrained</span>()
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 试着清扫
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>s</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sl</span>.<span style=color:#a6e22e>tryAcquire</span>(<span style=color:#a6e22e>s</span>); <span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>			<span style=color:#75715e>// Sweep the span we found.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#a6e22e>npages</span> = <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>npages</span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>sweep</span>(<span style=color:#66d9ef>false</span>) {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>mheap_</span>.<span style=color:#a6e22e>reclaimCredit</span>.<span style=color:#a6e22e>Add</span>(<span style=color:#a6e22e>npages</span>)
</span></span><span style=display:flex><span>			} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>npages</span> = <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>sweep</span>.<span style=color:#a6e22e>active</span>.<span style=color:#a6e22e>end</span>(<span style=color:#a6e22e>sl</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ......
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>gp</span>.<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>locks</span><span style=color:#f92672>--</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>npages</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>sweep 主要逻辑是把 刚刚标记过的 gcmarkBits 复制给 allocBits</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>sl</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>sweepLocked</span>) <span style=color:#a6e22e>sweep</span>(<span style=color:#a6e22e>preserve</span> <span style=color:#66d9ef>bool</span>) <span style=color:#66d9ef>bool</span> {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ......
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>allocBits</span> = <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>gcmarkBits</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>gcmarkBits</span> = <span style=color:#a6e22e>newMarkBits</span>(uintptr(<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>nelems</span>))
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ......
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><h4 id=分配内存>分配内存
<a class=header-anchor href=#%e5%88%86%e9%85%8d%e5%86%85%e5%ad%98></a></h4><p>如果我们的 span 标记之后 还没来得及清扫，修改了 allocBits 值，然后再清扫会出问题。go 是怎么解决的呢？</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// 拿 span 的时候会检查 如果没清扫就先清扫一下 再使用内存
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>mcentral</span>) <span style=color:#a6e22e>cacheSpan</span>() <span style=color:#f92672>*</span><span style=color:#a6e22e>mspan</span> {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ......
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>s</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sl</span>.<span style=color:#a6e22e>tryAcquire</span>(<span style=color:#a6e22e>s</span>); <span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// We got ownership of the span, so let&#39;s sweep it.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>sweep</span>(<span style=color:#66d9ef>true</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ......
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>h</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>mheap</span>) <span style=color:#a6e22e>alloc</span>(<span style=color:#a6e22e>npages</span> <span style=color:#66d9ef>uintptr</span>, <span style=color:#a6e22e>spanclass</span> <span style=color:#a6e22e>spanClass</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>mspan</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>s</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>mspan</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>systemstack</span>(<span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>isSweepDone</span>() {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>h</span>.<span style=color:#a6e22e>reclaim</span>(<span style=color:#a6e22e>npages</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>s</span> = <span style=color:#a6e22e>h</span>.<span style=color:#a6e22e>allocSpan</span>(<span style=color:#a6e22e>npages</span>, <span style=color:#a6e22e>spanAllocHeap</span>, <span style=color:#a6e22e>spanclass</span>)
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>s</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>h</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>mheap</span>) <span style=color:#a6e22e>reclaim</span>(<span style=color:#a6e22e>npage</span> <span style=color:#66d9ef>uintptr</span>) {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ......
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>nfound</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>h</span>.<span style=color:#a6e22e>reclaimChunk</span>(<span style=color:#a6e22e>arenas</span>, <span style=color:#a6e22e>idx</span>, <span style=color:#a6e22e>pagesPerReclaimerChunk</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ......
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>h</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>mheap</span>) <span style=color:#a6e22e>reclaimChunk</span>(<span style=color:#a6e22e>arenas</span> []<span style=color:#f92672>*</span><span style=color:#a6e22e>pageAlloc</span>, <span style=color:#a6e22e>idx</span>, <span style=color:#a6e22e>npages</span> <span style=color:#66d9ef>uintptr</span>) <span style=color:#66d9ef>uintptr</span> {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ......
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>sweep</span>(<span style=color:#66d9ef>false</span>) {
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ......
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div></div><footer class=post-footer><div class=post-tags><a href=/tags/go>go</a></div><div class=addthis_inline_share_toolbox style=text-align:center></div><hr><div class=post-copyright><img src=/imgs/cc/cc.svg width=75 height=75 align=right alt=共享知识><ul><li class=post-copyright-title><strong>文章标题：</strong>
Go 垃圾回收原理</li><li class=post-copyright-author><strong>本文作者： </strong>daemon365</li><li class=post-copyright-link><strong>本文链接：</strong>
<a id=post-cr-link href=https://daemon365.dev/post/go/go_gc_code/ title="Go 垃圾回收原理">https://daemon365.dev/post/go/go_gc_code/</a></li><li class=post-copyright-license><strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <i class="fab fa-fw fa-creative-commons"></i><a target=_blank href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div class=post-nav><div class="post-nav-next post-nav-item"><a href=/post/go/go_channel_code/ rel=next title="Go channel 原理"><i class="fa fa-chevron-left"></i> Go channel 原理</a></div><div class="post-nav-prev post-nav-item"><a href=/post/go/go_memory_code/ rel=prev title="go 内存管理">go 内存管理
<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div id=comments class=post-comments><div class=comment-head><div class=comment-headline><i class="fas fa-comments fa-fw"></i>
<span>评论交流</span></div></div><div class=comment-wrap><div><div class=comment-loading><i class="fa fa-sync fa-spin"></i></div><div class=utterances-container></div></div></div></div></div></main><footer class=footer><div class=footer-inner><div class=copyright>&copy;
<span itemprop=copyrightYear>2019 - 2024
</span><span class=with-love><i class="fa fa-heart"></i>
</span><span class=author itemprop=copyrightHolder>daemon365</span></div><div class=powered-by>由 <a href=https://gohugo.io title=0.140.1 target=_blank>Hugo</a> & <a href=https://github.com/hugo-next/hugo-theme-next title=4.6.3 target=_blank>Hugo NexT.Gemini</a> 强力驱动</div></div></footer><script type=text/javascript src=https://daemon365.dev/3rd/animejs/3.2.2/anime.min.js crossorigin=anonymous defer></script><script type=text/javascript src=https://daemon365.dev/3rd/viewerjs/1.11.6/viewer.min.js crossorigin=anonymous defer></script><script class=next-config data-name=main type=application/json>{"bookmark":{"color":"#222","enable":false,"save":"manual"},"copybtn":true,"darkmode":false,"hostname":"https://daemon365.dev/","i18n":{"ds_day":" 天前","ds_days":" 天 ","ds_hour":" 小时前","ds_hours":" 小时 ","ds_just":"刚刚","ds_min":" 分钟前","ds_mins":" 分钟","ds_month":" 个月前","ds_years":" 年 ","empty":"没有找到任何搜索结果：${query}","hits":"找到 ${hits} 个搜索结果","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","placeholder":"搜索..."},"lang":"zh-CN","lawidget":{"id":"JmAHxEAUVgyS8B1c","js":"https://v6-widget.51.la/v6/laId/quote.js?theme=0\u0026col=true\u0026f=12\u0026display=0,0,0,1,0,1,1,1"},"lazyload":false,"localSearch":{"enable":true,"limit":1e3,"path":"/searchindexes.xml","preload":false,"topnperarticle":-1,"trigger":"auto","unescape":false},"motion":{"async":false,"enable":false,"transition":{"collheader":"fadeInLeft","postblock":"fadeIn","postbody":"fadeInDown","postheader":"fadeInDown","sidebar":"fadeInUp"}},"postmeta":{"comments":{"enable":false,"plugin":"waline"},"views":{"enable":true,"plugin":"busuanzi"}},"root":"/","scheme":"Gemini","sidebar":{"display":"post","offset":12,"padding":18,"position":"left","width":256},"utterances":{"cfg":{"issueterm":"pathname","label":"comments","repo":"daemon365/blog","theme":"preferred-color-scheme"},"js":"https://utteranc.es/client.js"},"vendor":{"plugins":"local","router":{"name":"local","type":"modern","url":"https://daemon365.dev/3rd"}},"version":"4.6.3"}</script><script type=text/javascript src=/js/main.min.412b2d7d9cead6dbf9b4df1d9dcc9b5b7818e8e434f664050b4498e888bb3009.js defer></script></body></html>