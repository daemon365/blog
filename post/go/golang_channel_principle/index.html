<!doctype html><html lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>golang channel原理 - Daemon365</title><link rel=icon href=/imgs/favicon.ico><link rel=manifest href=/manifest.json><meta name=theme-color content="#007aff"><meta name=mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="default"><meta name=apple-mobile-web-app-title content="Daemon365"><meta name=description content="channel介绍
channel一个类型管道，通过它可以在goroutine之间发送和接收消息。它是Golang在语言层面提供的goroutine间的通信方式。
众所周知，Go依赖于称为CSP（Communicating Sequential Processes）的并发模型，通过Channel实现这种同步模 …"><meta name=keywords content="go,源码分析"><meta name=author content="daemon365"><meta property="og:type" content="article"><meta property="og:url" content="https://daemon365.dev/post/go/golang_channel_principle/"><meta property="og:title" content="golang channel原理 - Daemon365"><meta property="og:description" content="channel介绍
channel一个类型管道，通过它可以在goroutine之间发送和接收消息。它是Golang在语言层面提供的goroutine间的通信方式。
众所周知，Go依赖于称为CSP（Communicating Sequential Processes）的并发模型，通过Channel实现这种同步模 …"><meta property="og:image" content="https://daemon365.dev/imgs/avatar.svg"><meta property="og:locale" content="en"><meta property="og:site_name" content="Daemon365"><meta property="article:published_time" content="2021-02-21T00:00:00+08:00"><meta property="article:modified_time" content="2021-02-21T00:00:00+08:00"><meta property="article:author" content="daemon365"><meta property="article:section" content="go"><meta property="article:tag" content="go"><meta property="article:tag" content="源码分析"><meta name=twitter:card content="summary_large_image"><meta name=twitter:url content="https://daemon365.dev/post/go/golang_channel_principle/"><meta name=twitter:title content="golang channel原理 - Daemon365"><meta name=twitter:description content="channel介绍
channel一个类型管道，通过它可以在goroutine之间发送和接收消息。它是Golang在语言层面提供的goroutine间的通信方式。
众所周知，Go依赖于称为CSP（Communicating Sequential Processes）的并发模型，通过Channel实现这种同步模 …"><meta name=twitter:image content="https://daemon365.dev/imgs/avatar.svg"><link rel=canonical href=https://daemon365.dev/post/go/golang_channel_principle/><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"golang channel原理","description":"\u003ch2 id=\u0022channel介绍\u0022\u003echannel介绍\u003c\/h2\u003e\n\u003cp\u003echannel一个类型管道，通过它可以在goroutine之间发送和接收消息。它是Golang在语言层面提供的goroutine间的通信方式。\u003c\/p\u003e\n\u003cp\u003e众所周知，Go依赖于称为CSP（Communicating Sequential Processes）的并发模型，通过Channel实现这种同步模 …\u003c\/p\u003e","datePublished":"2021-02-21T00:00:00\u002b08:00","dateModified":"2021-02-21T00:00:00\u002b08:00","author":{"@type":"Person","name":"daemon365"},"publisher":{"@type":"Organization","name":"Daemon365","logo":{"@type":"ImageObject","url":"https:\/\/daemon365.dev\/imgs\/favicon.ico"}},"mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/daemon365.dev\/post\/go\/golang_channel_principle\/"},"inLanguage":"en"}</script><meta name=robots content="index, follow"><meta name=googlebot content="index, follow"><link rel=stylesheet href=/css/components/variables.css><link rel=stylesheet href=/css/components/base.css><link rel=stylesheet href=/css/components/layout.css><link rel=stylesheet href=/css/main.css><link rel=stylesheet href=/css/components/search.css><link rel=stylesheet href=/css/components/toc.css><link rel=stylesheet href=/css/components/image-preview.css><link rel=stylesheet href=/css/components/reading-progress.css><style>:root{font-family:-apple-system,BlinkMacSystemFont,segoe ui,Roboto,helvetica neue,Arial,sans-serif}</style></head><body><div class=reading-progress-bar></div><header class=site-header><div class=container><div class=header-content><div class=site-branding><a href=/ class=site-logo><span class=site-title>Daemon365</span></a></div><nav class=site-nav><ul class=nav-menu><li><a href=/><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
Home</a></li><li><a href=/about><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
About</a></li><li><a href=/archives><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
Archives</a></li><li><a href=/categories><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg>
Categories</a></li><li><a href=/tags><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>
Tags</a></li><li><button class=search-trigger aria-label=Search>
<svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
Search</button></li></ul></nav></div></div></header><main class=main-content><div class=post-container><div class=container><article class=post-content><header class=post-header><h1 class=post-title>golang channel原理</h1><div class=post-meta><time datetime=2021-02-21><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
2021-02-21
</time><a href=/categories/go class=category-link><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg>
go
</a><span class=reading-time><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
4 min read
</span><span class=word-count><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
755 words</span></div><div class=post-tags><a href=/tags/go class=tag><svg class="icon" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>
go
</a><a href=/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90 class=tag><svg class="icon" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>
源码分析</a></div></header><div class=post-body><h2 id=channel介绍>channel介绍</h2><p>channel一个类型管道，通过它可以在goroutine之间发送和接收消息。它是Golang在语言层面提供的goroutine间的通信方式。</p><p>众所周知，Go依赖于称为CSP（Communicating Sequential Processes）的并发模型，通过Channel实现这种同步模式。Go并发的核心哲学是不要通过共享内存进行通信; 相反，通过沟通分享记忆。</p><p>下面以简单的示例来演示Go如何通过channel来实现通信。</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#75af00>main</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>(</span>
</span></span><span style=display:flex><span>    <span style=color:#d88200>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#d88200>&#34;time&#34;</span>
</span></span><span style=display:flex><span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>goRoutineA</span><span style=color:#111>(</span><span style=color:#75af00>a</span> <span style=color:#f92672>&lt;-</span><span style=color:#00a8c8>chan</span> <span style=color:#00a8c8>int</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>val</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&lt;-</span><span style=color:#75af00>a</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Println</span><span style=color:#111>(</span><span style=color:#d88200>&#34;goRoutineA received the data&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>val</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>goRoutineB</span><span style=color:#111>(</span><span style=color:#75af00>b</span> <span style=color:#00a8c8>chan</span> <span style=color:#00a8c8>int</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>val</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&lt;-</span><span style=color:#75af00>b</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Println</span><span style=color:#111>(</span><span style=color:#d88200>&#34;goRoutineB  received the data&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>val</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>main</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>ch</span> <span style=color:#f92672>:=</span> <span style=color:#111>make</span><span style=color:#111>(</span><span style=color:#00a8c8>chan</span> <span style=color:#00a8c8>int</span><span style=color:#111>,</span> <span style=color:#ae81ff>3</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>go</span> <span style=color:#75af00>goRoutineA</span><span style=color:#111>(</span><span style=color:#75af00>ch</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>go</span> <span style=color:#75af00>goRoutineB</span><span style=color:#111>(</span><span style=color:#75af00>ch</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>ch</span> <span style=color:#f92672>&lt;-</span> <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>time</span><span style=color:#111>.</span><span style=color:#75af00>Sleep</span><span style=color:#111>(</span><span style=color:#75af00>time</span><span style=color:#111>.</span><span style=color:#75af00>Second</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>1</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><p>结果为：<code>goRoutineA received the data 3</code></p><p>上面只是个简单的例子，只输出goRoutineA ，没有执行goRoutineB，说明channel仅允许被一个goroutine读写。</p><p>go并发知识：<a href=https://www.cnblogs.com/yuemoxi/p/15161276.html>链接</a></p><p>说道channel这里不得不提通道的结构hchan。</p><h2 id=hchan>hchan</h2><p>源代码在src/runtime/chan.go</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>type</span> <span style=color:#75af00>hchan</span> <span style=color:#00a8c8>struct</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>   <span style=color:#75af00>qcount</span>   <span style=color:#00a8c8>uint</span>           <span style=color:#75715e>// total data in the queue</span>
</span></span><span style=display:flex><span>   <span style=color:#75af00>dataqsiz</span> <span style=color:#00a8c8>uint</span>           <span style=color:#75715e>// size of the circular queue</span>
</span></span><span style=display:flex><span>   <span style=color:#75af00>buf</span>      <span style=color:#75af00>unsafe</span><span style=color:#111>.</span><span style=color:#75af00>Pointer</span> <span style=color:#75715e>// points to an array of dataqsiz elements</span>
</span></span><span style=display:flex><span>   <span style=color:#75af00>elemsize</span> <span style=color:#00a8c8>uint16</span>
</span></span><span style=display:flex><span>   <span style=color:#75af00>closed</span>   <span style=color:#00a8c8>uint32</span>
</span></span><span style=display:flex><span>   <span style=color:#75af00>elemtype</span> <span style=color:#f92672>*</span><span style=color:#75af00>_type</span> <span style=color:#75715e>// element type</span>
</span></span><span style=display:flex><span>   <span style=color:#75af00>sendx</span>    <span style=color:#00a8c8>uint</span>   <span style=color:#75715e>// send index</span>
</span></span><span style=display:flex><span>   <span style=color:#75af00>recvx</span>    <span style=color:#00a8c8>uint</span>   <span style=color:#75715e>// receive index</span>
</span></span><span style=display:flex><span>   <span style=color:#75af00>recvq</span>    <span style=color:#75af00>waitq</span>  <span style=color:#75715e>// list of recv waiters</span>
</span></span><span style=display:flex><span>   <span style=color:#75af00>sendq</span>    <span style=color:#75af00>waitq</span>  <span style=color:#75715e>// list of send waiters</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#75715e>// lock protects all fields in hchan, as well as several</span>
</span></span><span style=display:flex><span>   <span style=color:#75715e>// fields in sudogs blocked on this channel.</span>
</span></span><span style=display:flex><span>   <span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e>   // Do not change another G&#39;s status while holding this lock</span>
</span></span><span style=display:flex><span>   <span style=color:#75715e>// (in particular, do not ready a G), as this can deadlock</span>
</span></span><span style=display:flex><span>   <span style=color:#75715e>// with stack shrinking.</span>
</span></span><span style=display:flex><span>   <span style=color:#75af00>lock</span> <span style=color:#75af00>mutex</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>type</span> <span style=color:#75af00>waitq</span> <span style=color:#00a8c8>struct</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>first</span> <span style=color:#f92672>*</span><span style=color:#75af00>sudog</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>last</span>  <span style=color:#f92672>*</span><span style=color:#75af00>sudog</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><p>说明：</p><ul><li><strong>qcount</strong> uint // 当前队列中剩余元素个数</li><li><strong>dataqsiz</strong> uint // 环形队列长度，即缓冲区的大小，即make（chan T，N），N.</li><li><strong>buf</strong> unsafe.Pointer // 环形队列指针</li><li><strong>elemsize</strong> uint16 // 每个元素的大小</li><li><strong>closed</strong> uint32 // 表示当前通道是否处于关闭状态。创建通道后，该字段设置为0，即通道打开; 通过调用close将其设置为1，通道关闭。</li><li><strong>elemtype</strong> *_type // 元素类型，用于数据传递过程中的赋值；</li><li><strong>sendx</strong> uint和<strong>recvx</strong> uint是环形缓冲区的状态字段，它指示缓冲区的当前索引 - 支持数组，它可以从中发送数据和接收数据。</li><li><strong>recvq</strong> waitq // 等待读消息的goroutine队列</li><li><strong>sendq</strong> waitq // 等待写消息的goroutine队列</li><li><strong>lock</strong> mutex // 互斥锁，为每个读写操作锁定通道，因为发送和接收必须是互斥操作。</li></ul><p>这里<strong>sudog代表goroutine。</strong></p><h2 id=make-chan>make chan</h2><p>make函数在创建channel的时候会在该进程的heap区申请一块内存，创建一个hchan结构体，返回执行该内存的指针，所以获取的的ch变量本身就是一个指针，在函数之间传递的时候是同一个channel。</p><p>hchan结构体使<strong>用一个环形队列</strong>来保存groutine之间传递的数据(如果是缓存channel的话)，使用<strong>两个list</strong>保存像该chan发送和从该chan接收数据的goroutine，还有一个mutex来保证操作这些结构的安全。</p><p>创建channel 有两种，一种是带缓冲的channel，一种是不带缓冲的channel</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// 带缓冲</span>
</span></span><span style=display:flex><span><span style=color:#75af00>ch</span> <span style=color:#f92672>:=</span> <span style=color:#111>make</span><span style=color:#111>(</span><span style=color:#00a8c8>chan</span> <span style=color:#75af00>Task</span><span style=color:#111>,</span> <span style=color:#ae81ff>3</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 不带缓冲</span>
</span></span><span style=display:flex><span><span style=color:#75af00>ch</span> <span style=color:#f92672>:=</span> <span style=color:#111>make</span><span style=color:#111>(</span><span style=color:#00a8c8>chan</span> <span style=color:#00a8c8>int</span><span style=color:#111>)</span>
</span></span></code></pre></div><p>这里我们先讨论带缓冲</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75af00>ch</span> <span style=color:#f92672>:=</span> <span style=color:#111>make</span><span style=color:#111>(</span><span style=color:#00a8c8>chan</span> <span style=color:#00a8c8>int</span><span style=color:#111>,</span> <span style=color:#ae81ff>3</span><span style=color:#111>)</span>
</span></span></code></pre></div><p>创建通道后的缓冲通道结构</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75af00>hchan</span> <span style=color:#00a8c8>struct</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>qcount</span> <span style=color:#00a8c8>uint</span> <span style=color:#111>:</span> <span style=color:#ae81ff>0</span> 
</span></span><span style=display:flex><span>    <span style=color:#75af00>dataqsiz</span> <span style=color:#00a8c8>uint</span> <span style=color:#111>:</span> <span style=color:#ae81ff>3</span> 
</span></span><span style=display:flex><span>    <span style=color:#75af00>buf</span> <span style=color:#75af00>unsafe</span><span style=color:#111>.</span><span style=color:#75af00>Pointer</span> <span style=color:#111>:</span> <span style=color:#ae81ff>0xc00007e0e0</span> 
</span></span><span style=display:flex><span>    <span style=color:#75af00>elemsize</span> <span style=color:#00a8c8>uint16</span> <span style=color:#111>:</span> <span style=color:#ae81ff>8</span> 
</span></span><span style=display:flex><span>    <span style=color:#75af00>closed</span> <span style=color:#00a8c8>uint32</span> <span style=color:#111>:</span> <span style=color:#ae81ff>0</span> 
</span></span><span style=display:flex><span>    <span style=color:#75af00>elemtype</span> <span style=color:#f92672>*</span><span style=color:#75af00>runtime</span><span style=color:#111>.</span><span style=color:#75af00>_type</span> <span style=color:#111>:</span> <span style=color:#f92672>&amp;</span><span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>size</span><span style=color:#111>:</span><span style=color:#ae81ff>8</span> 
</span></span><span style=display:flex><span>        <span style=color:#75af00>ptrdata</span><span style=color:#111>:</span><span style=color:#ae81ff>0</span> 
</span></span><span style=display:flex><span>        <span style=color:#75af00>hash</span><span style=color:#111>:</span><span style=color:#ae81ff>4149441018</span> 
</span></span><span style=display:flex><span>        <span style=color:#75af00>tflag</span><span style=color:#111>:</span><span style=color:#ae81ff>7</span> 
</span></span><span style=display:flex><span>        <span style=color:#75af00>align</span><span style=color:#111>:</span><span style=color:#ae81ff>8</span> 
</span></span><span style=display:flex><span>        <span style=color:#75af00>fieldalign</span><span style=color:#111>:</span><span style=color:#ae81ff>8</span> 
</span></span><span style=display:flex><span>        <span style=color:#75af00>kind</span><span style=color:#111>:</span><span style=color:#ae81ff>130</span> 
</span></span><span style=display:flex><span>        <span style=color:#75af00>alg</span><span style=color:#111>:</span><span style=color:#ae81ff>0x55cdf0</span> 
</span></span><span style=display:flex><span>        <span style=color:#75af00>gcdata</span><span style=color:#111>:</span><span style=color:#ae81ff>0x4d61b4</span> 
</span></span><span style=display:flex><span>        <span style=color:#75af00>str</span><span style=color:#111>:</span><span style=color:#ae81ff>1055</span> 
</span></span><span style=display:flex><span>        <span style=color:#75af00>ptrToThis</span><span style=color:#111>:</span><span style=color:#ae81ff>45152</span>
</span></span><span style=display:flex><span>        <span style=color:#111>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>sendx</span> <span style=color:#00a8c8>uint</span> <span style=color:#111>:</span> <span style=color:#ae81ff>0</span> 
</span></span><span style=display:flex><span>    <span style=color:#75af00>recvx</span> <span style=color:#00a8c8>uint</span> <span style=color:#111>:</span> <span style=color:#ae81ff>0</span> 
</span></span><span style=display:flex><span>    <span style=color:#75af00>recvq</span> <span style=color:#75af00>runtime</span><span style=color:#111>.</span><span style=color:#75af00>waitq</span> <span style=color:#111>:</span> 
</span></span><span style=display:flex><span>        <span style=color:#111>{</span><span style=color:#75af00>first</span><span style=color:#111>:&lt;</span><span style=color:#00a8c8>nil</span><span style=color:#111>&gt;</span> <span style=color:#75af00>last</span><span style=color:#111>:&lt;</span><span style=color:#00a8c8>nil</span><span style=color:#111>&gt;}</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>sendq</span> <span style=color:#75af00>runtime</span><span style=color:#111>.</span><span style=color:#75af00>waitq</span> <span style=color:#111>:</span> 
</span></span><span style=display:flex><span>        <span style=color:#111>{</span><span style=color:#75af00>first</span><span style=color:#111>:&lt;</span><span style=color:#00a8c8>nil</span><span style=color:#111>&gt;</span> <span style=color:#75af00>last</span><span style=color:#111>:&lt;</span><span style=color:#00a8c8>nil</span><span style=color:#111>&gt;}</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>lock</span> <span style=color:#75af00>runtime</span><span style=color:#111>.</span><span style=color:#75af00>mutex</span> <span style=color:#111>:</span> 
</span></span><span style=display:flex><span>        <span style=color:#111>{</span><span style=color:#75af00>key</span><span style=color:#111>:</span><span style=color:#ae81ff>0</span><span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><p>源代码</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>makechan</span><span style=color:#111>(</span><span style=color:#75af00>t</span> <span style=color:#f92672>*</span><span style=color:#75af00>chantype</span><span style=color:#111>,</span> <span style=color:#75af00>size</span> <span style=color:#00a8c8>int</span><span style=color:#111>)</span> <span style=color:#f92672>*</span><span style=color:#75af00>hchan</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#75af00>elem</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>t</span><span style=color:#111>.</span><span style=color:#75af00>elem</span>
</span></span><span style=display:flex><span>   <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><p>如果我们创建一个带buffer的channel，底层的数据模型如下图：</p><p><img src=/images/44becf0e-3cef-4a92-ad1b-74b0d3be075d.png alt></p><h2 id=发送和接受数据>发送和接受数据</h2><p>向channel发送和从channel接收数据主要涉及hchan里的四个成员变量，借用Kavya ppt里的图示，来分析发送和接收的过程。</p><p><img src=/images/1c0e0400-0356-483d-9144-1ed65764ec37.png alt></p><h3 id=向channel写入数据>向channel写入数据</h3><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75af00>ch</span> <span style=color:#f92672>&lt;-</span> <span style=color:#ae81ff>3</span>
</span></span></code></pre></div><p>底层hchan数据流程如图</p><p><img src=/images/dbd15c57-37a3-4d27-b110-d78695a1ed23.png alt>
<img src=/images/aeb25cf7-f059-4086-a8e7-26efb72aa85e.png alt></p><p>发送操作概要</p><p>1、锁定整个通道结构。</p><p>2、确定写入。尝试<code>recvq</code>从等待队列中等待goroutine，然后将元素直接写入goroutine。</p><p>3、如果recvq为Empty，则确定缓冲区是否可用。如果可用，从当前goroutine复制数据到缓冲区。</p><p>4、如果缓冲区已满，<strong>则要</strong>写入的元素将保存在当前正在执行的goroutine的结构中，并且当前goroutine将在<strong>sendq中</strong>排队并从运行时挂起。</p><p>5、写入完成释放锁。</p><p>这里我们要注意几个属性buf、sendx、lock的变化。</p><p>流程图</p><p><img src=/images/45ec829d-b33d-49df-8be8-a2adb1f6c2f2.png alt></p><h3 id=从channel读取操作>从channel读取操作</h3><p>几乎和写入操作相同</p><p>代码</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>goRoutineA</span><span style=color:#111>(</span><span style=color:#75af00>a</span> <span style=color:#f92672>&lt;-</span><span style=color:#00a8c8>chan</span> <span style=color:#00a8c8>int</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>   <span style=color:#75af00>val</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&lt;-</span><span style=color:#75af00>a</span>
</span></span><span style=display:flex><span>   <span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Println</span><span style=color:#111>(</span><span style=color:#d88200>&#34;goRoutineA received the data&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>val</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><p>底层hchan数据流程如图</p><p><img src=/images/35c33001-5ed0-43b5-88bb-78d533a3174d.png alt>
<img src=/images/0386fc04-eeb6-4fb8-bcca-dec41f787ddd.png alt></p><p>这里我们要注意几个属性buf、sendx、recvx、lock的变化。</p><p>读取操作概要</p><ol><li>先获取channel全局锁</li><li>尝试sendq从等待队列中获取等待的goroutine，</li><li>如有等待的goroutine，没有缓冲区，取出goroutine并读取数据，然后唤醒这个goroutine，结束读取释放锁。</li><li>如有等待的goroutine，且有缓冲区（此时缓冲区已满），从缓冲区队首取出数据，再从sendq取出一个goroutine，将goroutine中的数据存入buf队尾，结束读取释放锁。</li><li>如没有等待的goroutine，且缓冲区有数据，直接读取缓冲区数据，结束读取释放锁。</li><li>如没有等待的goroutine，且没有缓冲区或缓冲区为空，将当前的goroutine加入<strong>recvq</strong>排队，进入睡眠，等待被写goroutine唤醒。结束读取释放锁。</li></ol><p>流程图</p><p><img src=/images/3f234e37-388e-4070-ae49-5e3b22f59382.png alt></p><h2 id=recvq和sendq-结构>recvq和sendq 结构</h2><p>recvq和sendq基本上是链表，看起来基本如下</p><p><img src=/images/d46ef751-eb47-4517-bdf7-a9e0b42a169e.png alt></p><h2 id=goroutine-pauseresume>Goroutine Pause/Resume</h2><p>goroutine是Golang实现的用户空间的轻量级的线程，有runtime调度器调度，与操作系统的thread有多对一的关系，相关的数据结构如下图:</p><p><img src=/images/982fea32-4940-4297-bf63-b608f4e04e44.png alt></p><p>其中M是操作系统的线程，G是用户启动的goroutine，P是与调度相关的context，每个M都拥有一个P，P维护了一个能够运行的goutine队列，用于该线程执行。</p><p>当G1向buf已经满了的ch发送数据的时候，当runtine检测到对应的hchan的buf已经满了，会通知调度器，调度器会将G1的状态设置为waiting, 移除与线程M的联系，然后从P的runqueue中选择一个goroutine在线程M中执行，此时G1就是阻塞状态，但是不是操作系统的线程阻塞，所以这个时候只用消耗少量的资源。</p><p>那么G1设置为waiting状态后去哪了？怎们去resume呢？我们再回到hchan结构体，注意到hchan有个sendq的成员，其类型是waitq，查看源码如下：</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>type</span> <span style=color:#75af00>hchan</span> <span style=color:#00a8c8>struct</span> <span style=color:#111>{</span> 
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span> 
</span></span><span style=display:flex><span>    <span style=color:#75af00>recvq</span> <span style=color:#75af00>waitq</span> <span style=color:#75715e>// list of recv waiters </span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>sendq</span> <span style=color:#75af00>waitq</span> <span style=color:#75715e>// list of send waiters </span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span> 
</span></span><span style=display:flex><span><span style=color:#111>}</span> 
</span></span><span style=display:flex><span><span style=color:#75715e>// 
</span></span></span><span style=display:flex><span><span style=color:#75715e>type waitq struct { </span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>first</span> <span style=color:#f92672>*</span><span style=color:#75af00>sudog</span> 
</span></span><span style=display:flex><span>    <span style=color:#75af00>last</span> <span style=color:#f92672>*</span><span style=color:#75af00>sudog</span> 
</span></span><span style=display:flex><span><span style=color:#111>}</span> 
</span></span></code></pre></div><p>实际上，当G1变为waiting状态后，会创建一个代表自己的sudog的结构，然后放到sendq这个list中，sudog结构中保存了channel相关的变量的指针(如果该Goroutine是sender，那么保存的是待发送数据的变量的地址，如果是receiver则为接收数据的变量的地址，之所以是地址，前面我们提到在传输数据的时候使用的是copy的方式)</p><p><img src=/images/f8569a70-a969-44db-bd7f-e777dcaa597e.png alt></p><p>当G2从ch中接收一个数据时，会通知调度器，设置G1的状态为runnable，然后将加入P的runqueue里，等待线程执行.</p><p><img src=/images/770ea2fb-2a34-4061-b34b-a1e600e62be8.png alt></p><h2 id=wait-empty-channel>wait empty channel</h2><p>前面我们是假设G1先运行，如果G2先运行会怎么样呢？如果G2先运行，那么G2会从一个empty的channel里取数据，这个时候G2就会阻塞，和前面介绍的G1阻塞一样，G2也会创建一个sudog结构体，保存接收数据的变量的地址，但是该sudog结构体是放到了recvq列表里，当G1向ch发送数据的时候，<strong>runtime并没有对hchan结构体题的buf进行加锁，而是直接将G1里的发送到ch的数据copy到了G2 sudog里对应的elem指向的内存地址！</strong></p><p><img src=/images/daa8420b-64fe-4672-8de1-e68160550fe7.png alt></p><h2 id=select>select</h2><p>select就是用来监听和channel有关的IO操作，当 IO 操作发生时，触发相应的动作。</p><p>一个简单的示例如下</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#75af00>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>(</span>
</span></span><span style=display:flex><span>   <span style=color:#d88200>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>   <span style=color:#d88200>&#34;time&#34;</span>
</span></span><span style=display:flex><span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>goRoutineD</span><span style=color:#111>(</span><span style=color:#75af00>ch</span> <span style=color:#00a8c8>chan</span> <span style=color:#00a8c8>int</span><span style=color:#111>,</span> <span style=color:#75af00>i</span> <span style=color:#00a8c8>int</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>   <span style=color:#75af00>time</span><span style=color:#111>.</span><span style=color:#75af00>Sleep</span><span style=color:#111>(</span><span style=color:#75af00>time</span><span style=color:#111>.</span><span style=color:#75af00>Second</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>3</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>   <span style=color:#75af00>ch</span> <span style=color:#f92672>&lt;-</span> <span style=color:#75af00>i</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>goRoutineE</span><span style=color:#111>(</span><span style=color:#75af00>chs</span> <span style=color:#00a8c8>chan</span> <span style=color:#00a8c8>string</span><span style=color:#111>,</span> <span style=color:#75af00>i</span> <span style=color:#00a8c8>string</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>   <span style=color:#75af00>time</span><span style=color:#111>.</span><span style=color:#75af00>Sleep</span><span style=color:#111>(</span><span style=color:#75af00>time</span><span style=color:#111>.</span><span style=color:#75af00>Second</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>3</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>   <span style=color:#75af00>chs</span> <span style=color:#f92672>&lt;-</span> <span style=color:#75af00>i</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>main</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>   <span style=color:#75af00>ch</span> <span style=color:#f92672>:=</span> <span style=color:#111>make</span><span style=color:#111>(</span><span style=color:#00a8c8>chan</span> <span style=color:#00a8c8>int</span><span style=color:#111>,</span> <span style=color:#ae81ff>5</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>   <span style=color:#75af00>chs</span> <span style=color:#f92672>:=</span> <span style=color:#111>make</span><span style=color:#111>(</span><span style=color:#00a8c8>chan</span> <span style=color:#00a8c8>string</span><span style=color:#111>,</span> <span style=color:#ae81ff>5</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#00a8c8>go</span> <span style=color:#75af00>goRoutineD</span><span style=color:#111>(</span><span style=color:#75af00>ch</span><span style=color:#111>,</span> <span style=color:#ae81ff>5</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>   <span style=color:#00a8c8>go</span> <span style=color:#75af00>goRoutineE</span><span style=color:#111>(</span><span style=color:#75af00>chs</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;ok&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>select</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>case</span> <span style=color:#75af00>msg</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&lt;-</span><span style=color:#75af00>ch</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Println</span><span style=color:#111>(</span><span style=color:#d88200>&#34; received the data &#34;</span><span style=color:#111>,</span> <span style=color:#75af00>msg</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>case</span> <span style=color:#75af00>msgs</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&lt;-</span><span style=color:#75af00>chs</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Println</span><span style=color:#111>(</span><span style=color:#d88200>&#34; received the data &#34;</span><span style=color:#111>,</span> <span style=color:#75af00>msgs</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>default</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Println</span><span style=color:#111>(</span><span style=color:#d88200>&#34;no data received &#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>time</span><span style=color:#111>.</span><span style=color:#75af00>Sleep</span><span style=color:#111>(</span><span style=color:#75af00>time</span><span style=color:#111>.</span><span style=color:#75af00>Second</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>1</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><p>运行程序，因为当前时间没有到3s，所以select 选择defult</p><p><code>no data received</code></p><p>修改程序，我们注释掉default，并多执行几次结果为</p><pre tabindex=0><code>received the data 5

received the data ok

received the data ok

received the data ok
</code></pre><p>select语句会阻塞，直到监测到一个可以执行的IO操作为止，而这里goRoutineD和goRoutineE睡眠时间是相同的，都是3s，从输出可看出，从channel中读出数据的顺序是随机的。</p><p>再修改代码，goRoutineD睡眠时间改成4s</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>goRoutineD</span><span style=color:#111>(</span><span style=color:#75af00>ch</span> <span style=color:#00a8c8>chan</span> <span style=color:#00a8c8>int</span><span style=color:#111>,</span> <span style=color:#75af00>i</span> <span style=color:#00a8c8>int</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>   <span style=color:#75af00>time</span><span style=color:#111>.</span><span style=color:#75af00>Sleep</span><span style=color:#111>(</span><span style=color:#75af00>time</span><span style=color:#111>.</span><span style=color:#75af00>Second</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>4</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>   <span style=color:#75af00>ch</span> <span style=color:#f92672>&lt;-</span> <span style=color:#75af00>i</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><p>此时会先执行goRoutineE，select 选择case msgs := &lt;-chs。</p><h2 id=range>range</h2><p>可以持续从channel读取数据，一直到channel被关闭，当channel中没有数据时会阻塞当前goroutine，与读channel时阻塞处理机制一样。</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#75af00>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>(</span>
</span></span><span style=display:flex><span>   <span style=color:#d88200>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>   <span style=color:#d88200>&#34;time&#34;</span>
</span></span><span style=display:flex><span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>goRoutineD</span><span style=color:#111>(</span><span style=color:#75af00>ch</span> <span style=color:#00a8c8>chan</span> <span style=color:#00a8c8>int</span><span style=color:#111>,</span> <span style=color:#75af00>i</span> <span style=color:#00a8c8>int</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>   <span style=color:#00a8c8>for</span>   <span style=color:#75af00>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>1</span><span style=color:#111>;</span> <span style=color:#75af00>i</span> <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>5</span><span style=color:#111>;</span> <span style=color:#75af00>i</span><span style=color:#f92672>++</span><span style=color:#111>{</span>
</span></span><span style=display:flex><span>      <span style=color:#75af00>ch</span> <span style=color:#f92672>&lt;-</span> <span style=color:#75af00>i</span>
</span></span><span style=display:flex><span>   <span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>chanRange</span><span style=color:#111>(</span><span style=color:#75af00>chanName</span> <span style=color:#00a8c8>chan</span> <span style=color:#00a8c8>int</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>   <span style=color:#00a8c8>for</span> <span style=color:#75af00>e</span> <span style=color:#f92672>:=</span> <span style=color:#00a8c8>range</span> <span style=color:#75af00>chanName</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>      <span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Printf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;Get element from chan: %d\n&#34;</span><span style=color:#111>,</span> <span style=color:#75af00>e</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>      <span style=color:#00a8c8>if</span> <span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#75af00>chanName</span><span style=color:#111>)</span> <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span> <span style=color:#111>{</span> <span style=color:#75715e>// 如果现有数据量为0，跳出循环</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>break</span>
</span></span><span style=display:flex><span>      <span style=color:#111>}</span>
</span></span><span style=display:flex><span>   <span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>main</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>   <span style=color:#75af00>ch</span> <span style=color:#f92672>:=</span> <span style=color:#111>make</span><span style=color:#111>(</span><span style=color:#00a8c8>chan</span> <span style=color:#00a8c8>int</span><span style=color:#111>,</span> <span style=color:#ae81ff>5</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>   <span style=color:#00a8c8>go</span> <span style=color:#75af00>goRoutineD</span><span style=color:#111>(</span><span style=color:#75af00>ch</span><span style=color:#111>,</span> <span style=color:#ae81ff>5</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>   <span style=color:#75af00>chanRange</span><span style=color:#111>(</span><span style=color:#75af00>ch</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><p>结果：</p><pre tabindex=0><code>Get element from chan: 1
Get element from chan: 2
Get element from chan: 3
Get element from chan: 4
Get element from chan: 5
</code></pre><h2 id=死锁deadlock>死锁（deadlock）</h2><p>指两个或两个以上的协程的执行过程中，由于竞争资源或由于彼此通信而造成的一种阻塞的现象。</p><p>在非缓冲信道若发生只流入不流出，或只流出不流入，就会发生死锁。</p><p>下面是一些死锁的例子</p><p>1、</p><pre tabindex=0><code>package main

func main() {
   ch := make(chan int)
   ch &lt;- 3
}
</code></pre><p>上面情况，向非缓冲通道写数据会发生阻塞，导致死锁。解决办法创建缓冲区 ch := make(chan int，3)</p><p>2、</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#75af00>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>(</span>
</span></span><span style=display:flex><span>   <span style=color:#d88200>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>main</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>   <span style=color:#75af00>ch</span> <span style=color:#f92672>:=</span> <span style=color:#111>make</span><span style=color:#111>(</span><span style=color:#00a8c8>chan</span> <span style=color:#00a8c8>int</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>   <span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Println</span><span style=color:#111>(</span><span style=color:#f92672>&lt;-</span><span style=color:#75af00>ch</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><p>向非缓冲通道读取数据会发生阻塞，导致死锁。 解决办法开启缓冲区，先向channel写入数据。</p><p>3、</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#75af00>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>main</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>   <span style=color:#75af00>ch</span> <span style=color:#f92672>:=</span> <span style=color:#111>make</span><span style=color:#111>(</span><span style=color:#00a8c8>chan</span> <span style=color:#00a8c8>int</span><span style=color:#111>,</span> <span style=color:#ae81ff>3</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>   <span style=color:#75af00>ch</span> <span style=color:#f92672>&lt;-</span> <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>   <span style=color:#75af00>ch</span> <span style=color:#f92672>&lt;-</span> <span style=color:#ae81ff>4</span>
</span></span><span style=display:flex><span>   <span style=color:#75af00>ch</span> <span style=color:#f92672>&lt;-</span> <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span>   <span style=color:#75af00>ch</span> <span style=color:#f92672>&lt;-</span> <span style=color:#ae81ff>6</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><p>写入数据超过缓冲区数量也会发生死锁。解决办法将写入数据取走。</p><p>死锁的情况有很多这里不再赘述。
还有一种情况，向关闭的channel写入数据，不会产生死锁，产生panic。</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#75af00>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>main</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>ch</span> <span style=color:#f92672>:=</span> <span style=color:#111>make</span><span style=color:#111>(</span><span style=color:#00a8c8>chan</span> <span style=color:#00a8c8>int</span><span style=color:#111>,</span> <span style=color:#ae81ff>3</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>ch</span> <span style=color:#f92672>&lt;-</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#111>close</span><span style=color:#111>(</span><span style=color:#75af00>ch</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#75af00>ch</span> <span style=color:#f92672>&lt;-</span> <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><p>解决办法别向关闭的channel写入数据。</p><h2 id=参考文章>参考文章</h2><ul><li><a href=https://segmentfault.com/a/1190000019172554>Go channel 实现原理分析</a></li><li><a href=https://zhuanlan.zhihu.com/p/27917262>深入理解Golang Channel</a></li></ul></div><footer class=post-footer><div class=post-license><p><strong>Article Title:</strong> golang channel原理</p><p><strong>Author:</strong> daemon365</p><p><strong>Permalink:</strong> <a href=https://daemon365.dev/post/go/golang_channel_principle/>https://daemon365.dev/post/go/golang_channel_principle/</a></p><p><strong>License:</strong> This article is licensed under
<a href=https://creativecommons.org/licenses/by-nc-sa/4.0/ target=_blank rel=noopener>BY-NC-SA</a>. Please cite the source when reposting.</p></div><nav class=post-navigation><a href=/post/go/golang_gc_garbage_collection_mechanism/ class=nav-prev><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg><div><span class=nav-label>Previous</span>
<span class=nav-title>golang GC 垃圾回收机制</span></div></a><a href=/post/go/zap_high_performance_log/ class=nav-next><div><span class=nav-label>Next</span>
<span class=nav-title>zap高性能日志</span></div><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg></a></nav><div class=post-comments><script src=https://utteranc.es/client.js repo=daemon365/blog issue-term=pathname label=comments theme=preferred-color-scheme crossorigin=anonymous async></script></div></footer></article></div></div><div class=toc-float-button id=tocButton><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5.0 016.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5.0 014 19.5v-15A2.5 2.5.0 016.5 2z"/></svg></div><div class=toc-panel id=tocPanel><div class=toc-panel-header><h3 class=toc-panel-title>Table of Contents</h3><button class=toc-panel-close id=tocClose>
<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div><nav class=toc-panel-nav id=TableOfContents><nav id=TableOfContents><ul><li><a href=#channel介绍>channel介绍</a></li><li><a href=#hchan>hchan</a></li><li><a href=#make-chan>make chan</a></li><li><a href=#发送和接受数据>发送和接受数据</a><ul><li><a href=#向channel写入数据>向channel写入数据</a></li><li><a href=#从channel读取操作>从channel读取操作</a></li></ul></li><li><a href=#recvq和sendq-结构>recvq和sendq 结构</a></li><li><a href=#goroutine-pauseresume>Goroutine Pause/Resume</a></li><li><a href=#wait-empty-channel>wait empty channel</a></li><li><a href=#select>select</a></li><li><a href=#range>range</a></li><li><a href=#死锁deadlock>死锁（deadlock）</a></li><li><a href=#参考文章>参考文章</a></li></ul></nav></nav></div></main><footer class=site-footer><div class=container><div class=footer-content><div class=footer-info><p class=copyright>© 2025 daemon365</p><p class=powered-by>Powered by <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> & <a href=https://github.com/daemon365/hugo-theme-daemon target=_blank rel=noopener>Daemon</a></p></div><div class=social-links><a href=https://github.com/daemon365 target=_blank rel=noopener aria-label=GitHub><svg class="icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0C5.374.0.0 5.373.0 12c0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931.0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176.0.0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221.0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576C20.566 21.797 24 17.3 24 12c0-6.627-5.373-12-12-12z"/></svg>
</a><a href=mailto:daemon365@foxmail.com aria-label=Email><svg class="icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></a></div></div></div></footer><div class=search-modal id=searchModal><div class=search-modal-backdrop></div><div class=search-modal-content><div class=search-modal-header><input type=text class=search-input id=searchInput placeholder="Search articles..." autofocus>
<button class=search-close aria-label="Close search">
<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div><div class=search-results id=searchResults><p class=search-hint>Enter 2 or more characters to start searching</p></div></div></div><script src=/js/components/search.js></script><script src=/js/components/toc.js></script><script src=/js/components/scroll-effects.js></script><script src=/js/components/code-copy.js></script><script src=/js/components/lazy-loading.js></script><script src=/js/components/image-preview.js></script><script src=/js/components/back-to-top.js></script><script src=/js/main-new.js></script><script>"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("/sw.js").then(e=>{console.log("Service Worker registered:",e.scope)}).catch(e=>{console.log("Service Worker registration failed:",e)})})</script></body></html>