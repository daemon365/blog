<!doctype html><html lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>golang context包 - Daemon365</title><link rel=icon href=/imgs/favicon.ico><link rel=manifest href=/manifest.json><meta name=theme-color content="#007aff"><meta name=mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="default"><meta name=apple-mobile-web-app-title content="Daemon365"><meta name=description content="go context标准库
context包在Go1.7版本时加入到标准库中。其设计目标是给Golang提供一个标准接口来给其他任务发送取消信号和传递数据。其具体作用为：


可以通过context发送取消信号。


可以指定截止时间（Deadline)，context在截止时间到期后自动发送取消信号。 …"><meta name=keywords content="go"><meta name=author content="daemon365"><meta property="og:type" content="article"><meta property="og:url" content="https://daemon365.dev/post/go/golang_context_package/"><meta property="og:title" content="golang context包 - Daemon365"><meta property="og:description" content="go context标准库
context包在Go1.7版本时加入到标准库中。其设计目标是给Golang提供一个标准接口来给其他任务发送取消信号和传递数据。其具体作用为：


可以通过context发送取消信号。


可以指定截止时间（Deadline)，context在截止时间到期后自动发送取消信号。 …"><meta property="og:image" content="https://daemon365.dev/imgs/avatar.svg"><meta property="og:locale" content="en"><meta property="og:site_name" content="Daemon365"><meta property="article:published_time" content="2019-06-28T00:00:00+08:00"><meta property="article:modified_time" content="2019-06-28T00:00:00+08:00"><meta property="article:author" content="daemon365"><meta property="article:section" content="go"><meta property="article:tag" content="go"><meta name=twitter:card content="summary_large_image"><meta name=twitter:url content="https://daemon365.dev/post/go/golang_context_package/"><meta name=twitter:title content="golang context包 - Daemon365"><meta name=twitter:description content="go context标准库
context包在Go1.7版本时加入到标准库中。其设计目标是给Golang提供一个标准接口来给其他任务发送取消信号和传递数据。其具体作用为：


可以通过context发送取消信号。


可以指定截止时间（Deadline)，context在截止时间到期后自动发送取消信号。 …"><meta name=twitter:image content="https://daemon365.dev/imgs/avatar.svg"><link rel=canonical href=https://daemon365.dev/post/go/golang_context_package/><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"golang context包","description":"\u003ch2 id=\u0022go-context标准库\u0022\u003ego context标准库\u003c\/h2\u003e\n\u003cp\u003econtext包在Go1.7版本时加入到标准库中。其设计目标是给Golang提供一个标准接口来给其他任务发送取消信号和传递数据。其具体作用为：\u003c\/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003e可以通过context发送取消信号。\u003c\/p\u003e\n\u003c\/li\u003e\n\u003cli\u003e\n\u003cp\u003e可以指定截止时间（Deadline)，context在截止时间到期后自动发送取消信号。 …\u003c\/p\u003e\u003c\/li\u003e\u003c\/ul\u003e","datePublished":"2019-06-28T00:00:00\u002b08:00","dateModified":"2019-06-28T00:00:00\u002b08:00","author":{"@type":"Person","name":"daemon365"},"publisher":{"@type":"Organization","name":"Daemon365","logo":{"@type":"ImageObject","url":"https:\/\/daemon365.dev\/imgs\/favicon.ico"}},"mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/daemon365.dev\/post\/go\/golang_context_package\/"},"inLanguage":"en"}</script><meta name=robots content="index, follow"><meta name=googlebot content="index, follow"><link rel=stylesheet href=/css/components/variables.css><link rel=stylesheet href=/css/components/base.css><link rel=stylesheet href=/css/components/layout.css><link rel=stylesheet href=/css/main.css><link rel=stylesheet href=/css/components/search.css><link rel=stylesheet href=/css/components/toc.css><link rel=stylesheet href=/css/components/image-preview.css><link rel=stylesheet href=/css/components/reading-progress.css><style>:root{font-family:-apple-system,BlinkMacSystemFont,segoe ui,Roboto,helvetica neue,Arial,sans-serif}</style></head><body><div class=reading-progress-bar></div><header class=site-header><div class=container><div class=header-content><div class=site-branding><a href=/ class=site-logo><span class=site-title>Daemon365</span></a></div><nav class=site-nav><ul class=nav-menu><li><a href=/><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
首页</a></li><li><a href=/about><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
关于</a></li><li><a href=/archives><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
归档</a></li><li><a href=/categories><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg>
分类</a></li><li><a href=/tags><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>
标签</a></li><li><button class=search-trigger aria-label=Search>
<svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
搜索</button></li></ul></nav></div></div></header><main class=main-content><div class=post-container><div class=container><article class=post-content><header class=post-header><h1 class=post-title>golang context包</h1><div class=post-meta><time datetime=2019-06-28><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
2019-06-28
</time><a href=/categories/go class=category-link><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg>
go
</a><span class=reading-time><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
6 min read
</span><span class=word-count><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
1195 words</span></div><div class=post-tags><a href=/tags/go class=tag><svg class="icon" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>
go</a></div></header><div class=post-body><h2 id=go-context标准库>go context标准库</h2><p>context包在Go1.7版本时加入到标准库中。其设计目标是给Golang提供一个标准接口来给其他任务发送取消信号和传递数据。其具体作用为：</p><ul><li><p>可以通过context发送取消信号。</p></li><li><p>可以指定截止时间（Deadline)，context在截止时间到期后自动发送取消信号。</p></li><li><p>可以通过context传输一些数据。</p></li></ul><p><strong>context在Golang中最主要的用途是控制协程任务的取消</strong>，但是context除了协程以外也可以用在线程控制等非协程的情况。</p><h2 id=基本概念>基本概念</h2><p>context的核心是其定义的Context接口类型。围绕着Context接口类型存在两种角色：</p><ul><li><p>父任务：创建Context，将Context对象传递给子任务，并且根据需要发送取消信号来结束子任务。</p></li><li><p>子任务：使用Context类型对象，当收到父任务发来的取消信号，结束当前任务并退出。</p></li></ul><p>接下来我们从这两个角色的视角分别看一下Context对象。</p><h2 id=context接口>context接口</h2><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#00a8c8>type</span> <span style=color:#75af00>Context</span> <span style=color:#00a8c8>interface</span> <span style=color:#111>{</span>  <span style=color:#75af00>Deadline</span><span style=color:#111>()</span> <span style=color:#111>(</span><span style=color:#75af00>deadline</span> <span style=color:#75af00>time</span><span style=color:#111>.</span><span style=color:#75af00>Time</span><span style=color:#111>,</span> <span style=color:#75af00>ok</span> <span style=color:#00a8c8>bool</span><span style=color:#111>)</span>  <span style=color:#75af00>Done</span><span style=color:#111>()</span> <span style=color:#00a8c8>chan</span> <span style=color:#00a8c8>struct</span><span style=color:#111>{}</span>  <span style=color:#75af00>Err</span><span style=color:#111>()</span> <span style=color:#00a8c8>error</span>  <span style=color:#75af00>Value</span><span style=color:#111>(</span><span style=color:#75af00>key</span> <span style=color:#00a8c8>interface</span><span style=color:#111>{})</span> <span style=color:#00a8c8>interface</span><span style=color:#111>{}</span> <span style=color:#111>}</span>
</span></span></code></pre></div><ul><li><p>Deadline方法需要返回当前Context被取消的时间，也就是完成工作的截止时间（deadline）；</p></li><li><p>Done方法需要返回一个Channel，这个Channel会在当前工作完成或者上下文被取消之后关闭，多次调用Done方***返回同一个Channel；</p></li><li><p>Err方***返回当前Context结束的原因，它只会在Done返回的Channel被关闭时才会返回非空的值；</p><ul><li><p>如果当前Context被取消就会返回Canceled错误；</p></li><li><p>如果当前Context超时就会返回DeadlineExceeded错误；</p></li></ul></li><li><p>Value方***从Context中返回键对应的值，对于同一个上下文来说，多次调用Value 并传入相同的Key会返回相同的结果，该方法仅用于传递跨API和进程间跟请求域的数据；</p></li></ul><h2 id=background和todo>Background()和TODO()</h2><p>Go内置两个函数：Background()和TODO()，这两个函数分别返回一个实现了Context接口的background和todo。我们代码中最开始都是以这两个内置的上下文对象作为最顶层的partent context，衍生出更多的子上下文对象。</p><ul><li><p>Background()主要用于main函数、初始化以及测试代码中，作为Context这个树结构的最顶层的Context，也就是根Context。</p></li><li><p>TODO()，它目前还不知道具体的使用场景，如果我们不知道该使用什么Context的时候，可以使用这个。</p></li><li><p>background和todo本质上都是emptyCtx结构体类型，是一个不可取消，没有设置截止时间，没有携带任何值的Context。</p></li></ul><h2 id=with函数>With函数</h2><ul><li><p>WithCancel函数，传递一个父Context作为参数，返回子Context，以及一个取消函数用来取消Context</p></li><li><p>WithDeadline函数，和WithCancel差不多，它会多传递一个截止时间参数，意味着到了这个时间点，会自动取消Context，当然我们也可以不等到这个时候，可以提前通过取消函数进行取消</p></li><li><p>WithTimeout和WithDeadline基本上一样，这个表示是超时自动取消，是多少时间后自动取消Context的意思</p></li><li><p>WithValue函数和取消Context无关，它是为了生成一个绑定了一个键值对数据的Context，这个绑定的数据可以通过Context.Value方法访问到</p></li></ul><h2 id=context使用原则>Context使用原则</h2><ul><li><p>不要把Context放在结构体中，要以参数的方式进行传递</p></li><li><p>以Context作为参数的函数方法，应该把Context作为第一个参数，放在第一位]</p></li><li><p>给一个函数方法传递Context的时候，不要传递nil，如果不知道传递什么，就使用context.TODO</p></li><li><p>Context的Value相关方法应该传递必须的数据，不要什么数据都使用这个传递</p></li></ul><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#75af00>main</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>(</span>  
</span></span><span style=display:flex><span>    <span style=color:#d88200>&#34;context&#34;</span>  
</span></span><span style=display:flex><span>    <span style=color:#d88200>&#34;fmt&#34;</span>  
</span></span><span style=display:flex><span>    <span style=color:#d88200>&#34;time&#34;</span> 
</span></span><span style=display:flex><span><span style=color:#111>)</span>   
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>main</span><span style=color:#111>()</span> <span style=color:#111>{</span>  
</span></span><span style=display:flex><span>    <span style=color:#75af00>server1</span><span style=color:#111>()</span>  
</span></span><span style=display:flex><span>    <span style=color:#75af00>time</span><span style=color:#111>.</span><span style=color:#75af00>Sleep</span><span style=color:#111>(</span><span style=color:#75af00>time</span><span style=color:#111>.</span><span style=color:#75af00>Second</span><span style=color:#111>)</span> 
</span></span><span style=display:flex><span><span style=color:#111>}</span>   
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>server1</span><span style=color:#111>()</span> <span style=color:#111>{</span>  
</span></span><span style=display:flex><span>		<span style=color:#75af00>ctx</span><span style=color:#111>,</span> <span style=color:#75af00>cancel</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>context</span><span style=color:#111>.</span><span style=color:#75af00>WithTimeout</span><span style=color:#111>(</span><span style=color:#75af00>context</span><span style=color:#111>.</span><span style=color:#75af00>Background</span><span style=color:#111>(),</span><span style=color:#75af00>time</span><span style=color:#111>.</span><span style=color:#75af00>Millisecond</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>30</span> <span style=color:#111>)</span><span style=color:#75715e>// 30毫秒后过期  </span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>defer</span> <span style=color:#75af00>cancel</span><span style=color:#111>()</span>  
</span></span><span style=display:flex><span>		<span style=color:#75af00>ctx</span> <span style=color:#111>=</span> <span style=color:#75af00>context</span><span style=color:#111>.</span><span style=color:#75af00>WithValue</span><span style=color:#111>(</span><span style=color:#75af00>ctx</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;name&#34;</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;zhaohaiyu&#34;</span><span style=color:#111>)</span>  
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>for</span> <span style=color:#75af00>i</span><span style=color:#f92672>:=</span><span style=color:#ae81ff>0</span><span style=color:#111>;</span><span style=color:#75af00>i</span><span style=color:#111>&lt;</span><span style=color:#ae81ff>100</span><span style=color:#111>;</span><span style=color:#75af00>i</span><span style=color:#f92672>++</span><span style=color:#111>{</span>   
</span></span><span style=display:flex><span>      <span style=color:#75af00>time</span><span style=color:#111>.</span><span style=color:#75af00>Sleep</span><span style=color:#111>(</span><span style=color:#75af00>time</span><span style=color:#111>.</span><span style=color:#75af00>Millisecond</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>10</span><span style=color:#111>)</span>   
</span></span><span style=display:flex><span>      <span style=color:#00a8c8>go</span> <span style=color:#75af00>server2</span><span style=color:#111>(</span><span style=color:#75af00>ctx</span><span style=color:#111>)</span>  
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>  
</span></span><span style=display:flex><span><span style=color:#111>}</span>  
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>server2</span><span style=color:#111>(</span><span style=color:#75af00>ctx</span> <span style=color:#75af00>context</span><span style=color:#111>.</span><span style=color:#75af00>Context</span><span style=color:#111>)</span> <span style=color:#111>{</span>  
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>select</span> <span style=color:#111>{</span>  
</span></span><span style=display:flex><span>				<span style=color:#00a8c8>case</span> <span style=color:#75af00>ctx</span><span style=color:#111>.</span><span style=color:#75af00>Done</span><span style=color:#111>():</span>   
</span></span><span style=display:flex><span>						<span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Println</span><span style=color:#111>(</span><span style=color:#d88200>&#34;打断执行&#34;</span><span style=color:#111>)</span>   
</span></span><span style=display:flex><span>				<span style=color:#00a8c8>return</span>  <span style=color:#00a8c8>default</span><span style=color:#111>:</span>   
</span></span><span style=display:flex><span>						<span style=color:#75af00>name</span><span style=color:#111>,</span><span style=color:#75af00>ok</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>ctx</span><span style=color:#111>.</span><span style=color:#75af00>Value</span><span style=color:#111>(</span><span style=color:#d88200>&#34;name&#34;</span><span style=color:#111>).(</span><span style=color:#00a8c8>string</span><span style=color:#111>)</span>   
</span></span><span style=display:flex><span>						<span style=color:#00a8c8>if</span> <span style=color:#111>!</span><span style=color:#75af00>ok</span><span style=color:#111>{</span>    
</span></span><span style=display:flex><span>								<span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Println</span><span style=color:#111>(</span><span style=color:#d88200>&#34;没有取到&#34;</span><span style=color:#111>)</span>    
</span></span><span style=display:flex><span>								<span style=color:#00a8c8>return</span>   
</span></span><span style=display:flex><span>						<span style=color:#111>}</span>   
</span></span><span style=display:flex><span>				<span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Println</span><span style=color:#111>(</span><span style=color:#d88200>&#34;name=&#34;</span><span style=color:#111>,</span><span style=color:#75af00>name</span><span style=color:#111>)</span>  
</span></span><span style=display:flex><span>				<span style=color:#111>}</span> 
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><h2 id=请求作用域上下文>请求作用域上下文</h2><p>在 Go 服务中，每个传入的请求都在其自己的goroutine 中处理。请求处理程序通常启动额外的 goroutine 来访问其他后端，如数据库和 RPC服务。处理请求的 goroutine 通常需要访问特定于请求(request-specific context)的值，例如最终用户的身份、授权令牌和请求的截止日期(deadline)。当一个请求被取消或超时时，处理该请求的所有 goroutine 都应该快速退出(fail fast)，这样系统就可以回收它们正在使用的任何资源。
Go 1.7 引入一个 context 包，它使得跨 API 边界的请求范围元数据、取消信号和截止日期很容易传递给处理请求所涉及的所有 goroutine(显示传递)。</p><p><strong>其他语言: Thread Local Storage(TLS)，XXXContext</strong></p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>type</span> <span style=color:#75af00>Context</span> <span style=color:#00a8c8>interface</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Deadline returns the time when work done on behalf of this context</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// should be canceled. Deadline returns ok==false when no deadline is</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// set. Successive calls to Deadline return the same results.</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>Deadline</span><span style=color:#111>()</span> <span style=color:#111>(</span><span style=color:#75af00>deadline</span> <span style=color:#75af00>time</span><span style=color:#111>.</span><span style=color:#75af00>Time</span><span style=color:#111>,</span> <span style=color:#75af00>ok</span> <span style=color:#00a8c8>bool</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Done returns a channel that&#39;s closed when work done on behalf of this</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// context should be canceled. Done may return nil if this context can</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// never be canceled. Successive calls to Done return the same value.</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// The close of the Done channel may happen asynchronously,</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// after the cancel function returns.</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e>	// WithCancel arranges for Done to be closed when cancel is called;</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// WithDeadline arranges for Done to be closed when the deadline</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// expires; WithTimeout arranges for Done to be closed when the timeout</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// elapses.</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e>	// Done is provided for use in select statements:</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e>	//  // Stream generates values with DoSomething and sends them to out</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>//  // until DoSomething returns an error or ctx.Done is closed.</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>//  func Stream(ctx context.Context, out chan&lt;- Value) error {</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>//  	for {</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>//  		v, err := DoSomething(ctx)</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>//  		if err != nil {</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>//  			return err</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>//  		}</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>//  		select {</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>//  		case &lt;-ctx.Done():</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>//  			return ctx.Err()</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>//  		case out &lt;- v:</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>//  		}</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>//  	}</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>//  }</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e>	// See https://blog.golang.org/pipelines for more examples of how to use</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// a Done channel for cancellation.</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>Done</span><span style=color:#111>()</span> <span style=color:#f92672>&lt;-</span><span style=color:#00a8c8>chan</span> <span style=color:#00a8c8>struct</span><span style=color:#111>{}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// If Done is not yet closed, Err returns nil.</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// If Done is closed, Err returns a non-nil error explaining why:</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Canceled if the context was canceled</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// or DeadlineExceeded if the context&#39;s deadline passed.</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// After Err returns a non-nil error, successive calls to Err return the same error.</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>Err</span><span style=color:#111>()</span> <span style=color:#00a8c8>error</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Value returns the value associated with this context for key, or nil</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// if no value is associated with key. Successive calls to Value with</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// the same key returns the same result.</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e>	// Use context values only for request-scoped data that transits</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// processes and API boundaries, not for passing optional parameters to</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// functions.</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e>	// A key identifies a specific value in a Context. Functions that wish</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// to store values in Context typically allocate a key in a global</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// variable then use that key as the argument to context.WithValue and</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Context.Value. A key can be any type that supports equality;</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// packages should define keys as an unexported type to avoid</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// collisions.</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e>	// Packages that define a Context key should provide type-safe accessors</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// for the values stored using that key:</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e>	// 	// Package user defines a User type that&#39;s stored in Contexts.</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 	package user</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e>	// 	import &#34;context&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e>	// 	// User is the type of value stored in the Contexts.</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 	type User struct {...}</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e>	// 	// key is an unexported type for keys defined in this package.</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 	// This prevents collisions with keys defined in other packages.</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 	type key int</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e>	// 	// userKey is the key for user.User values in Contexts. It is</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 	// unexported; clients use user.NewContext and user.FromContext</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 	// instead of using this key directly.</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 	var userKey key</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e>	// 	// NewContext returns a new Context that carries value u.</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 	func NewContext(ctx context.Context, u *User) context.Context {</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 		return context.WithValue(ctx, userKey, u)</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 	}</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e>	// 	// FromContext returns the User value stored in ctx, if any.</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 	func FromContext(ctx context.Context) (*User, bool) {</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 		u, ok := ctx.Value(userKey).(*User)</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 		return u, ok</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 	}</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>Value</span><span style=color:#111>(</span><span style=color:#75af00>key</span> <span style=color:#00a8c8>interface</span><span style=color:#111>{})</span> <span style=color:#00a8c8>interface</span><span style=color:#111>{}</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#00a8c8>func</span> <span style=color:#75af00>IsAdminUser</span><span style=color:#111>(</span><span style=color:#75af00>ctx</span> <span style=color:#75af00>context</span><span style=color:#111>.</span><span style=color:#75af00>Context</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>         <span style=color:#75af00>x</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>token</span><span style=color:#111>.</span><span style=color:#75af00>GetToken</span><span style=color:#111>(</span><span style=color:#75af00>ctx</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>         <span style=color:#75af00>userObject</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>auth</span><span style=color:#111>.</span><span style=color:#75af00>AuthenticateToken</span><span style=color:#111>(</span><span style=color:#75af00>x</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>         <span style=color:#00a8c8>return</span> <span style=color:#75af00>userObject</span><span style=color:#111>.</span><span style=color:#75af00>IsAdmin</span> <span style=color:#f92672>||</span> <span style=color:#75af00>userObject</span><span style=color:#111>.</span><span style=color:#75af00>IsRoot</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span> <span style=color:#111>}</span>
</span></span></code></pre></div><p>如何将 context 集成到 API 中？
在将 context 集成到 API 中时，要记住的最重要的一点是，它的作用域是请求级别 的。例如，沿单个数据库查询存在是有意义的，但沿数据库对象存在则没有意义。
目前有两种方法可以将 context 对象集成到 API 中：</p><ul><li><p>The first parameter of a function call</p><p>​ 首参数传递 context 对象，比如，参考 net 包 Dialer.DialContext。此函数执行正常的 Dial 操作，但可以通过 context 对象取消函数调用。</p><p><code>func (d *Dialer) DialContext(ctx context.Context,network,address string) (Conn,error)</code></p></li><li><p>Optional config on a request structure
在第一个 request 对象中携带一个可选的 context 对象。例如 net/http 库的 Request.WithContext，通过携带给定的 context 对象，返回一个新的 Request 对象。</p><p><code>func (r *Request) WithContext(ctx context.Context) *Request</code></p></li></ul><p><img src=/images/84cdba12-ce31-4bee-a624-8a579f3b6d57.png alt></p><h3 id=不要在stuct类型中存储上下文>不要在stuct类型中存储上下文</h3><p>不要在结构题类型中存储上下文；相反，应该显式地将上下文传递给每个需要它的函数。上下文应该是第一个参数，通常命名为ctx:</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>  <span style=color:#00a8c8>func</span> <span style=color:#75af00>DoSomething</span><span style=color:#111>(</span><span style=color:#75af00>ctx</span> <span style=color:#75af00>context</span><span style=color:#111>.</span><span style=color:#75af00>Context</span><span style=color:#111>,</span><span style=color:#75af00>arg</span> <span style=color:#75af00>Arg</span><span style=color:#111>)</span> <span style=color:#00a8c8>error</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>          <span style=color:#75715e>// .. use ctx</span>
</span></span><span style=display:flex><span>  <span style=color:#111>}</span>
</span></span></code></pre></div><p>对服务器的传入请求应创建上下文。
使用 context 的一个很好的心智模型是它应该在程序中流动，应该贯穿你的代码。这通常意味着您不希望将其存储在结构体之中。它从一个函数传递到另一个函数，并根据需要进行扩展。理想情况下，每个请求都会创建一个 context 对象，并在请求结束时过期。
不存储上下文的一个例外是，当您需要将它放入一个结构中时，该结构纯粹用作通过通道传递的消息。如下例所示。</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>type</span> <span style=color:#75af00>message</span> <span style=color:#00a8c8>struct</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>responseChan</span> <span style=color:#00a8c8>chan</span><span style=color:#f92672>&lt;-</span> <span style=color:#00a8c8>int</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>parameter</span> <span style=color:#00a8c8>string</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>ctx</span> <span style=color:#75af00>context</span><span style=color:#111>.</span><span style=color:#75af00>Context</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><h2 id=contextwithvalue>context.WithValue</h2><p>比如我们新建了一个基于 context.Background() 的 ctx1，携带了一个 map 的数据，map 中包含了 “k1”: “v1” 的一个键值对，ctx1 被两个 goroutine 同时使用作为函数签名传入，如果我们修改了 这个map，会导致另外进行读 context.Value 的 goroutine 和修改 map 的 goroutine，在 map 对象上产生 data race。因此我们要使用 copy-on-write 的思路，解决跨多个 goroutine 使用数据、修改数据的场景。</p><p><img src=/images/ba882718-fb1a-49f6-ac33-08f2bd536252.png alt></p><p>context.WithValue 内部基于 valueCtx 实现:</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>type</span> <span style=color:#75af00>valueCtx</span> <span style=color:#00a8c8>struct</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>Context</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>key</span><span style=color:#111>,</span><span style=color:#75af00>val</span> <span style=color:#00a8c8>interface</span><span style=color:#111>{}</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><p>为了实现不断的 WithValue，构建新的 context，内部在查找 key 时候，使用递归方式不断从当前，从父节点寻找匹配的 key，直到 root context(Backgrond 和 TODO Value 函数会返回 nil)。</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#111>(</span><span style=color:#75af00>c</span> <span style=color:#f92672>*</span><span style=color:#75af00>valueCtx</span><span style=color:#111>)</span> <span style=color:#75af00>Value</span><span style=color:#111>(</span><span style=color:#75af00>key</span> <span style=color:#00a8c8>interface</span><span style=color:#111>{}(</span> <span style=color:#00a8c8>interface</span><span style=color:#111>{}</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>if</span> <span style=color:#75af00>c</span><span style=color:#111>.</span><span style=color:#75af00>key</span> <span style=color:#f92672>==</span> <span style=color:#75af00>key</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>                <span style=color:#00a8c8>return</span> <span style=color:#75af00>c</span><span style=color:#111>.</span><span style=color:#75af00>val</span>
</span></span><span style=display:flex><span>        <span style=color:#111>}</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#75af00>c</span><span style=color:#111>.</span><span style=color:#75af00>Context</span><span style=color:#111>.</span><span style=color:#75af00>Value</span><span style=color:#111>(</span><span style=color:#75af00>key</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><p><img src=/images/4428bf8f-7a2d-4648-bac1-6b57ae3b11c8.png alt></p><h2 id=调试或跟踪数据在上下文中传递是安全的>调试或跟踪数据在上下文中传递是安全的</h2><p>context.WithValue 方法允许上下文携带请求范围的数据。这些数据必须是安全的，以便多个 goroutine 同时使用。这里的数据，更多是面向请求的元数据，不应该作为函数的可选参数来使用(比如 context 里面挂了一个sql.Tx 对象，传递到 Dao 层使用)，因为元数据相对函数参数更加是隐含的，面向请求的。而参数是更加显示的。</p><ul><li>同一个 context 对象可以传递给在不同 goroutine 中运行的函数；上下文对于多个 goroutine 同时使用是安全的。对于值类型最容易犯错的地方，在于 context value 应该是 immutable 的，每次重新赋值应该是新的 context，即: context.WithValue(ctx, oldvalue)</li></ul><p><a href=https://pkg.go.dev/google.golang.org/grpc/metadata>https://pkg.go.dev/google.golang.org/grpc/metadata</a>
Context.Value should inform, not control</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>WithValue</span><span style=color:#111>(</span><span style=color:#75af00>parent</span> <span style=color:#75af00>Context</span><span style=color:#111>,</span><span style=color:#75af00>key</span> <span style=color:#75af00>val</span> <span style=color:#00a8c8>interface</span><span style=color:#111>{})</span> <span style=color:#75af00>Context</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>parent</span> <span style=color:#f92672>==</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#111>panic</span><span style=color:#111>(</span><span style=color:#d88200>&#34;connot creat context from nil parent&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#75af00>key</span> <span style=color:#f92672>==</span> <span style=color:#00a8c8>nil</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#111>panic</span><span style=color:#111>(</span><span style=color:#d88200>&#34;nil key&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>if</span> <span style=color:#111>!</span><span style=color:#75af00>reflectlite</span><span style=color:#111>.</span><span style=color:#75af00>Typeof</span><span style=color:#111>(</span><span style=color:#75af00>key</span><span style=color:#111>).</span><span style=color:#75af00>Comparable</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#111>panic</span><span style=color:#111>(</span><span style=color:#d88200>&#34;key is not comparable&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>return</span> <span style=color:#f92672>&amp;</span><span style=color:#75af00>valueCtx</span><span style=color:#111>{</span><span style=color:#75af00>parent</span><span style=color:#111>,</span><span style=color:#75af00>key</span><span style=color:#111>,</span><span style=color:#75af00>val</span><span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>type</span> <span style=color:#75af00>valueCtx</span> <span style=color:#00a8c8>struct</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>Context</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>key</span><span style=color:#111>,</span><span style=color:#75af00>val</span> <span style=color:#00a8c8>interface</span><span style=color:#111>{}</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><p>用于传递作用域的参数的可选api和用于传递作用域的参数的可选api。比如 染色，API 重要性，Trace</p><p>比如我们新建了一个基于 context.Background() 的 ctx1，携带了一个 map 的数据，map 中包含了 “k1”: “v1” 的一个键值对，ctx1 被两个 goroutine 同时使用作为函数签名传入，如果我们修改了 这个map，会导致另外进行读 context.Value 的 goroutine 和修改 map 的 goroutine，在 map 对象上产生 data race。因此我们要使用 copy-on-write 的思路，解决跨多个 goroutine 使用数据、修改数据的场景。</p><p><img src=/images/65975244-2584-457b-a766-9bcee97ed59d.png alt></p><p>COW: 从 ctx1 中获取 map1(可以理解为 v1 版本的 map 数据)。构建一个新的 map 对象 map2，复制所有 map1 数据，同时追加新的数据 “k2”: “v2” 键值对，使用 context.WithValue 创建新的 ctx2，ctx2 会传递到其他的 goroutine 中。这样各自读取的副本都是自己的数据，写行为追加的数据，在 ctx2 中也能完整读取到，同时也不会污染 ctx1 中的数据。</p><p><img src=/images/f173fee2-4037-43aa-91a7-fa0a70cd1210.png alt></p><p><strong>当上下文被取消时，从它派生的所有上下文也被取消</strong></p><p>当一个 context 被取消时，从它派生的所有 context 也将被取消。WithCancel(ctx) 参数 ctx 认为是 parent ctx，在内部会进行一个传播关系链的关联。Done() 返回 一个 chan，当我们取消某个parent context, 实际上上会递归层层 cancel 掉自己的 child context 的 done chan 从而让整个调用链中所有监听 cancel 的 goroutine退出。</p><p><img src=/images/23ab1c43-739f-42cf-bc72-5605ee9318a1.png alt></p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#75af00>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>(</span>
</span></span><span style=display:flex><span>	<span style=color:#d88200>&#34;context&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#d88200>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>main</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>gen</span> <span style=color:#f92672>:=</span> <span style=color:#00a8c8>func</span><span style=color:#111>(</span><span style=color:#75af00>ctx</span> <span style=color:#75af00>context</span><span style=color:#111>.</span><span style=color:#75af00>Context</span><span style=color:#111>)</span> <span style=color:#f92672>&lt;-</span><span style=color:#00a8c8>chan</span> <span style=color:#00a8c8>int</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>dst</span> <span style=color:#f92672>:=</span> <span style=color:#111>make</span><span style=color:#111>(</span><span style=color:#00a8c8>chan</span> <span style=color:#00a8c8>int</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>n</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>go</span> <span style=color:#00a8c8>func</span><span style=color:#111>(){</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>for</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>				<span style=color:#00a8c8>select</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>				<span style=color:#00a8c8>case</span> <span style=color:#f92672>&lt;-</span> <span style=color:#75af00>ctx</span><span style=color:#111>.</span><span style=color:#75af00>Done</span><span style=color:#111>():</span>
</span></span><span style=display:flex><span>					<span style=color:#00a8c8>return</span>
</span></span><span style=display:flex><span>				<span style=color:#00a8c8>case</span> <span style=color:#75af00>dst</span> <span style=color:#f92672>&lt;-</span> <span style=color:#75af00>n</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>					<span style=color:#75af00>n</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>				<span style=color:#111>}</span>
</span></span><span style=display:flex><span>			<span style=color:#111>}</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}()</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>return</span> <span style=color:#75af00>dst</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>ctx</span><span style=color:#111>,</span><span style=color:#75af00>cancel</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>context</span><span style=color:#111>.</span><span style=color:#75af00>WithCancel</span><span style=color:#111>(</span><span style=color:#75af00>context</span><span style=color:#111>.</span><span style=color:#75af00>Backgroup</span><span style=color:#111>())</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>for</span> <span style=color:#75af00>n</span> <span style=color:#f92672>:=</span> <span style=color:#00a8c8>range</span> <span style=color:#75af00>gen</span><span style=color:#111>(</span><span style=color:#75af00>ctx</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Println</span><span style=color:#111>(</span><span style=color:#75af00>n</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>		<span style=color:#00a8c8>if</span> <span style=color:#75af00>n</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>5</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>			<span style=color:#00a8c8>break</span>
</span></span><span style=display:flex><span>		<span style=color:#111>}</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span></code></pre></div><p><strong>所有阻塞/长操作都应可取消</strong></p><p>如果要实现一个超时控制，通过上面的context 的parent/child 机制，其实我们只需要启动一个定时器，然后在超时的时候，直接将当前的 context 给 cancel 掉，就可以实现监听在当前和下层的额context.Done() 的 goroutine 的退出。</p><p><img src=/images/9321cf21-0197-4903-ad91-f4cb823d3966.png alt></p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#75af00>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>(</span>
</span></span><span style=display:flex><span>	<span style=color:#d88200>&#34;context&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#d88200>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#d88200>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>const</span> <span style=color:#75af00>shortDuration</span> <span style=color:#111>=</span> <span style=color:#75af00>time</span><span style=color:#111>.</span><span style=color:#75af00>Millisecond</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>func</span> <span style=color:#75af00>main</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>d</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>time</span><span style=color:#111>.</span><span style=color:#75af00>Now</span><span style=color:#111>().</span><span style=color:#75af00>Add</span><span style=color:#111>(</span><span style=color:#75af00>shortDuration</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#75af00>ctx</span><span style=color:#111>,</span><span style=color:#75af00>cancel</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>context</span><span style=color:#111>.</span><span style=color:#75af00>WithDeadline</span><span style=color:#111>(</span><span style=color:#75af00>context</span><span style=color:#111>.</span><span style=color:#75af00>Backgroup</span><span style=color:#111>(),</span><span style=color:#75af00>d</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>defer</span> <span style=color:#75af00>canel</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>select</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#75af00>time</span><span style=color:#111>.</span><span style=color:#75af00>After</span><span style=color:#111>(</span><span style=color:#75af00>time</span><span style=color:#111>.</span><span style=color:#75af00>Second</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Println</span><span style=color:#111>(</span><span style=color:#d88200>&#34;overslept&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>	<span style=color:#00a8c8>case</span> <span style=color:#f92672>&lt;-</span> <span style=color:#75af00>ctx</span><span style=color:#111>.</span><span style=color:#75af00>Done</span><span style=color:#111>():</span>
</span></span><span style=display:flex><span>		<span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Println</span><span style=color:#111>(</span><span style=color:#75af00>ctx</span><span style=color:#111>.</span><span style=color:#75af00>Err</span><span style=color:#111>())</span>
</span></span><span style=display:flex><span>	<span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div></div><footer class=post-footer><div class=post-license><p><strong>Article Title:</strong> golang context包</p><p><strong>Author:</strong> daemon365</p><p><strong>Permalink:</strong> <a href=https://daemon365.dev/post/go/golang_context_package/>https://daemon365.dev/post/go/golang_context_package/</a></p><p><strong>License:</strong> This article is licensed under
<a href=https://creativecommons.org/licenses/by-nc-sa/4.0/ target=_blank rel=noopener>BY-NC-SA</a>. Please cite the source when reposting.</p></div><nav class=post-navigation><a href=/post/go/golang_channel/ class=nav-prev><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg><div><span class=nav-label>Previous</span>
<span class=nav-title>golang channel</span></div></a><a href=/post/go/golang_unit_testing/ class=nav-next><div><span class=nav-label>Next</span>
<span class=nav-title>golang 单元测试</span></div><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg></a></nav><div class=post-comments><script src=https://utteranc.es/client.js repo=daemon365/blog issue-term=pathname label=comments theme=preferred-color-scheme crossorigin=anonymous async></script></div></footer></article></div></div><div class=toc-float-button id=tocButton><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5.0 016.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5.0 014 19.5v-15A2.5 2.5.0 016.5 2z"/></svg></div><div class=toc-panel id=tocPanel><div class=toc-panel-header><h3 class=toc-panel-title>Table of Contents</h3><button class=toc-panel-close id=tocClose>
<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div><nav class=toc-panel-nav id=TableOfContents><nav id=TableOfContents><ul><li><a href=#go-context标准库>go context标准库</a></li><li><a href=#基本概念>基本概念</a></li><li><a href=#context接口>context接口</a></li><li><a href=#background和todo>Background()和TODO()</a></li><li><a href=#with函数>With函数</a></li><li><a href=#context使用原则>Context使用原则</a></li><li><a href=#请求作用域上下文>请求作用域上下文</a><ul><li><a href=#不要在stuct类型中存储上下文>不要在stuct类型中存储上下文</a></li></ul></li><li><a href=#contextwithvalue>context.WithValue</a></li><li><a href=#调试或跟踪数据在上下文中传递是安全的>调试或跟踪数据在上下文中传递是安全的</a></li></ul></nav></nav></div></main><footer class=site-footer><div class=container><div class=footer-content><div class=footer-info><p class=copyright>© 2026 daemon365</p><p class=powered-by>由 <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> 和 <a href=https://github.com/daemon365/hugo-theme-daemon target=_blank rel=noopener>Daemon</a> 驱动</p></div><div class=social-links><a href=https://github.com/daemon365 target=_blank rel=noopener aria-label=GitHub><svg class="icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0C5.374.0.0 5.373.0 12c0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931.0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176.0.0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221.0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576C20.566 21.797 24 17.3 24 12c0-6.627-5.373-12-12-12z"/></svg>
</a><a href=mailto:daemon365@foxmail.com aria-label=Email><svg class="icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></a></div></div></div></footer><div class=search-modal id=searchModal><div class=search-modal-backdrop></div><div class=search-modal-content><div class=search-modal-header><input type=text class=search-input id=searchInput placeholder=搜索文章... autofocus>
<button class=search-close aria-label="Close search">
<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div><div class=search-results id=searchResults><p class=search-hint>输入 2 个或更多字符开始搜索</p></div></div></div><script src=/js/components/search.js></script><script src=/js/components/toc.js></script><script src=/js/components/scroll-effects.js></script><script src=/js/components/code-copy.js></script><script src=/js/components/lazy-loading.js></script><script src=/js/components/image-preview.js></script><script src=/js/components/back-to-top.js></script><script src=/js/main-new.js></script><script>"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("/sw.js").then(e=>{console.log("Service Worker registered:",e.scope)}).catch(e=>{console.log("Service Worker registration failed:",e)})})</script></body></html>